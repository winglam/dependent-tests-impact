Only in xml-security-orig-v1/src: ant
diff -r xml-security-orig-v1/src/org/apache/xml/security/algorithms/Algorithm.java xml-security-1_2_0/src/org/apache/xml/security/algorithms/Algorithm.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,64d20
< import org.w3c.dom.*;
< import org.apache.xml.security.utils.*;
65a22,25
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.ElementProxy;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
74,76c34,36
<    /** Field cat */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(Algorithm.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(Algorithm.class.getName());
Only in xml-security-orig-v1/src/org/apache/xml/security/algorithms: encryption
diff -r xml-security-orig-v1/src/org/apache/xml/security/algorithms/implementations/IntegrityHmac.java xml-security-1_2_0/src/org/apache/xml/security/algorithms/implementations/IntegrityHmac.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,67c21,22
< import org.w3c.dom.*;
< import org.apache.xml.security.algorithms.*;
< import org.apache.xml.security.utils.*;
< import org.apache.xml.security.signature.*;
< import java.io.IOException;
---
> import java.security.InvalidAlgorithmParameterException;
> import java.security.InvalidKeyException;
69,70d23
< import java.security.PrivateKey;
< import java.security.PublicKey;
72,73d24
< import java.security.InvalidKeyException;
< import java.security.InvalidAlgorithmParameterException;
75c26
< import org.apache.xml.security.signature.XMLSignatureException;
---
> 
77,78c28,40
< import javax.xml.transform.TransformerException;
< import org.apache.xpath.XPathAPI;
---
> import javax.crypto.SecretKey;
> 
> import org.apache.xml.security.algorithms.JCEMapper;
> import org.apache.xml.security.algorithms.MessageDigestAlgorithm;
> import org.apache.xml.security.algorithms.SignatureAlgorithmSpi;
> import org.apache.xml.security.signature.XMLSignature;
> import org.apache.xml.security.signature.XMLSignatureException;
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.HexDump;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.Text;
83c45
<  * @author $Author: dohy $
---
>  * @author $Author: vishal $
86,89c48,51
< 
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(IntegrityHmacSHA1.class.getName());
---
>     
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(IntegrityHmacSHA1.class.getName());
94c56
<     * @return
---
>     *@inheritDoc
111,116c73,75
<       JCEMapper.ProviderIdClass algorithmID =
<          JCEMapper.translateURItoJCEID(this.engineGetURI());
< 
<       cat.debug("Created IntegrityHmacSHA1 using "
<                 + algorithmID.getAlgorithmID() + " "
<                 + algorithmID.getProviderId());
---
>       String algorithmID = JCEMapper.translateURItoJCEID(this.engineGetURI());
>       if (log.isDebugEnabled())
>       	log.debug("Created IntegrityHmacSHA1 using " + algorithmID);
119,120c78
<          this._macAlgorithm = Mac.getInstance(algorithmID.getAlgorithmID(),
<                                               algorithmID.getProviderId());
---
>          this._macAlgorithm = Mac.getInstance(algorithmID);
122c80
<          Object[] exArgs = { algorithmID.getAlgorithmID(),
---
>          Object[] exArgs = { algorithmID,
126,130d83
<       } catch (java.security.NoSuchProviderException ex) {
<          Object[] exArgs = { algorithmID.getProviderId(),
<                              ex.getLocalizedMessage() };
< 
<          throw new XMLSignatureException("algorithms.NoSuchProvider", exArgs);
135c88
<     * Proxy method for {@link java.security.Signature#setParameter}
---
>     * Proxy method for {@link java.security.Signature#setParameter(java.security.spec.AlgorithmParameterSpec)}
147c100
<     * Proxy method for {@link java.security.Signature#verify}
---
>     * Proxy method for {@link java.security.Signature#verify(byte[])}
151c104
<     * @return
---
>     * @return true if the signature is correct
160,161c113,114
<          if ((this._HMACOutputLength == 0) || (this._HMACOutputLength >= 160)) {
<             cat.debug("completeResult = "
---
>          if (log.isDebugEnabled()) {
>          log.debug("completeResult = "
163c116
<             cat.debug("signature      = "
---
>          log.debug("signature      = "
165c118,119
< 
---
>          }
>          if ((this._HMACOutputLength == 0) || (this._HMACOutputLength >= 160)) {
167,171c121,122
<          } else {
<             cat.debug("completeResult = "
<                       + HexDump.byteArrayToHexString(completeResult));
< 
<             byte[] stripped = IntegrityHmac.reduceBitLength(completeResult,
---
>          }
>          byte[] stripped = IntegrityHmac.reduceBitLength(completeResult,
173,174c124,125
< 
<             cat.debug("stripped       = "
---
>          if (log.isDebugEnabled()) {
>          log.debug("stripped       = "
176,179d126
<             cat.debug("signature      = "
<                       + HexDump.byteArrayToHexString(signature));
< 
<             return MessageDigestAlgorithm.isEqual(stripped, signature);
180a128
>          return MessageDigestAlgorithm.isEqual(stripped, signature);         
187c135
<     * Proxy method for {@link java.security.Signature#initVerify}
---
>     * Proxy method for {@link java.security.Signature#initVerify(java.security.PublicKey)}
190c138
<     * @param publickey
---
>     * @param secretKey
193c141,150
<    protected void engineInitVerify(Key publickey) throws XMLSignatureException {
---
>    protected void engineInitVerify(Key secretKey) throws XMLSignatureException {
> 
>       if (!(secretKey instanceof SecretKey)) {
>          String supplied = secretKey.getClass().getName();
>          String needed = SecretKey.class.getName();
>          Object exArgs[] = { supplied, needed };
> 
>          throw new XMLSignatureException("algorithms.WrongKeyForThisOperation",
>                                          exArgs);
>       }
196c153
<          this._macAlgorithm.init(publickey);
---
>          this._macAlgorithm.init(secretKey);
203c160
<     * Proxy method for {@link java.security.Signature#sign}
---
>     * Proxy method for {@link java.security.Signature#sign()}
206c163
<     * @return the result of the {@link java.security.Signature#sign} method
---
>     * @return the result of the {@link java.security.Signature#sign()} method
216,217c173,174
<          } else {
<             return IntegrityHmac.reduceBitLength(completeResult,
---
>          } 
>           return IntegrityHmac.reduceBitLength(completeResult,
219c176
<          }
---
>          
228a186
>     * @return the reduced bits.
230c188
<     * @return
---
>     *
259a218,226
>       if (!(secretKey instanceof SecretKey)) {
>          String supplied = secretKey.getClass().getName();
>          String needed = SecretKey.class.getName();
>          Object exArgs[] = { supplied, needed };
> 
>          throw new XMLSignatureException("algorithms.WrongKeyForThisOperation",
>                                          exArgs);
>       }
> 
277a245,253
>       if (!(secretKey instanceof SecretKey)) {
>          String supplied = secretKey.getClass().getName();
>          String needed = SecretKey.class.getName();
>          Object exArgs[] = { supplied, needed };
> 
>          throw new XMLSignatureException("algorithms.WrongKeyForThisOperation",
>                                          exArgs);
>       }
> 
288c264,276
<     * Proxy method for {@link java.security.Signature#update}
---
>     * Method engineInitSign
>     *
>     * @param secretKey
>     * @param secureRandom
>     * @throws XMLSignatureException
>     */
>    protected void engineInitSign(Key secretKey, SecureRandom secureRandom)
>            throws XMLSignatureException {
>       throw new XMLSignatureException("algorithms.CannotUseSecureRandomOnMAC");
>    }
> 
>    /**
>     * Proxy method for {@link java.security.Signature#update(byte[])}
304c292
<     * Proxy method for {@link java.security.Signature#update}
---
>     * Proxy method for {@link java.security.Signature#update(byte)}
320c308
<     * Proxy method for {@link java.security.Signature#update}
---
>     * Proxy method for {@link java.security.Signature#update(byte[], int, int)}
339a328
>     * @inheritDoc
341d329
<     * @return
345c333
<       cat.debug("engineGetJCEAlgorithmString()");
---
>       log.debug("engineGetJCEAlgorithmString()");
353c341
<     * @return
---
>     * @inheritDoc
372d359
<     * @throws XMLSignatureException
374,375c361
<    protected void engineGetContextFromElement(Element element)
<            throws XMLSignatureException {
---
>    protected void engineGetContextFromElement(Element element) {
380c366
<          throw new XMLSignatureException("empty");
---
>          throw new IllegalArgumentException("element null");
383,391c369,370
<       if ((element.getChildNodes() != null)
<               && (element.getChildNodes().getLength() > 0)) {
<          try {
<             Element nscontext = XMLUtils.createDSctx(element.getOwnerDocument(),
<                                                      "ds",
<                                                      Constants.SignatureSpecNS);
<             Text hmaclength = (Text) XPathAPI.selectSingleNode(element,
<                                  "./ds:" + Constants._TAG_HMACOUTPUTLENGTH
<                                  + "/text()", nscontext);
---
>              Text hmaclength =XMLUtils.selectDsNodeText(element.getFirstChild(),
>                     Constants._TAG_HMACOUTPUTLENGTH,0);               
396,399c375
<          } catch (TransformerException ex) {
<             throw new XMLSignatureException("empty", ex);
<          }
<       }
---
>       
406d381
<     * @throws XMLSignatureException
409c384
<            throws XMLSignatureException {
---
>            {
412c387
<          throw new XMLSignatureException("empty");
---
>          throw new IllegalArgumentException("null element");
430,455c405
<     * Proxy method for {@link java.security.Signature#initSign}
<     * which is executed on the internal {@link java.security.Signature} object.
<     *
<     * @param privateKey
<     * @param secureRandom
<     * @throws XMLSignatureException
<     */
<    protected void engineInitSign(
<            PrivateKey privateKey, SecureRandom secureRandom)
<               throws XMLSignatureException {
<       throw new XMLSignatureException("algorithms.operationOnlyForSignature");
<    }
< 
<    /**
<     * Method engineInitSign
<     *
<     * @param privateKey
<     * @throws XMLSignatureException
<     */
<    protected void engineInitSign(PrivateKey privateKey)
<            throws XMLSignatureException {
<       throw new XMLSignatureException("algorithms.operationOnlyForSignature");
<    }
< 
<    /**
<     * Method engineInitVerify
---
>     * Class IntegrityHmacSHA1
457,458c407,408
<     * @param publicKey
<     * @throws XMLSignatureException
---
>     * @author $Author: vishal $
>     * @version $Revision: 1.12 $
460,464d409
<    protected void engineInitVerify(PublicKey publicKey)
<            throws XMLSignatureException {
<       throw new XMLSignatureException("algorithms.operationOnlyForSignature");
<    }
< 
465a411,416
> 
>       /**
>        * Constructor IntegrityHmacSHA1
>        *
>        * @throws XMLSignatureException
>        */
468a420,425
> 
>       /**
>        * Method engineGetURI
>        * @inheritDoc
>        *
>        */
472a430,436
> 
>    /**
>     * Class IntegrityHmacSHA256
>     *
>     * @author $Author: vishal $
>     * @version $Revision: 1.12 $
>     */
473a438,443
> 
>       /**
>        * Constructor IntegrityHmacSHA256
>        *
>        * @throws XMLSignatureException
>        */
476a447,452
> 
>       /**
>        * Method engineGetURI
>        *
>        * @inheritDoc
>        */
480a457,463
> 
>    /**
>     * Class IntegrityHmacSHA384
>     *
>     * @author $Author: vishal $
>     * @version $Revision: 1.12 $
>     */
481a465,470
> 
>       /**
>        * Constructor IntegrityHmacSHA384
>        *
>        * @throws XMLSignatureException
>        */
484a474,479
> 
>       /**
>        * Method engineGetURI
>        * @inheritDoc
>        *
>        */
488a484,490
> 
>    /**
>     * Class IntegrityHmacSHA512
>     *
>     * @author $Author: vishal $
>     * @version $Revision: 1.12 $
>     */
489a492,497
> 
>       /**
>        * Constructor IntegrityHmacSHA512
>        *
>        * @throws XMLSignatureException
>        */
492a501,506
> 
>       /**
>        * Method engineGetURI
>        * @inheritDoc
>        *
>        */
496a511,517
> 
>    /**
>     * Class IntegrityHmacRIPEMD160
>     *
>     * @author $Author: vishal $
>     * @version $Revision: 1.12 $
>     */
497a519,524
> 
>       /**
>        * Constructor IntegrityHmacRIPEMD160
>        *
>        * @throws XMLSignatureException
>        */
500a528,533
> 
>       /**
>        * Method engineGetURI
>        *
>        * @inheritDoc
>        */
504a538,544
> 
>    /**
>     * Class IntegrityHmacMD5
>     *
>     * @author $Author: vishal $
>     * @version $Revision: 1.12 $
>     */
505a546,551
> 
>       /**
>        * Constructor IntegrityHmacMD5
>        *
>        * @throws XMLSignatureException
>        */
508a555,560
> 
>       /**
>        * Method engineGetURI
>        *
>        * @inheritDoc
>        */
diff -r xml-security-orig-v1/src/org/apache/xml/security/algorithms/implementations/package.html xml-security-1_2_0/src/org/apache/xml/security/algorithms/implementations/package.html
2c2
< implementations of {@link org.apache.xml.security.algorithms.SignatureAlgorithmSpi}
---
> implementations of {@link org.apache.xml.security.algorithms.SignatureAlgorithmSpi}.
diff -r xml-security-orig-v1/src/org/apache/xml/security/algorithms/implementations/SignatureBaseRSA.java xml-security-1_2_0/src/org/apache/xml/security/algorithms/implementations/SignatureBaseRSA.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,64d20
< import java.io.IOException;
< import java.math.BigInteger;
68d23
< import java.security.Signature;
71a27
> import java.security.Signature;
74,78c30,34
< import java.security.spec.InvalidParameterSpecException;
< import org.apache.xml.security.algorithms.*;
< import org.apache.xml.security.signature.*;
< import org.apache.xml.security.utils.*;
< import org.w3c.dom.*;
---
> 
> import org.apache.xml.security.algorithms.JCEMapper;
> import org.apache.xml.security.algorithms.SignatureAlgorithmSpi;
> import org.apache.xml.security.signature.XMLSignature;
> import org.apache.xml.security.signature.XMLSignatureException;
83c39
<  * @author $Author: dohy $
---
>  * @author $Author: vishal $
87,89c43,45
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(SignatureBaseRSA.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(SignatureBaseRSA.class.getName());
91,95c47
<    /**
<     * Method engineGetURI
<     *
<     * @return
<     */
---
>     /** @inheritDoc */
108,109c60
<       JCEMapper.ProviderIdClass algorithmID =
<          JCEMapper.translateURItoJCEID(this.engineGetURI());
---
>       String algorithmID = JCEMapper.translateURItoJCEID(this.engineGetURI());
111,112c62,63
<       cat.debug("Created SignatureDSA using " + algorithmID.getAlgorithmID()
<                 + " " + algorithmID.getProviderId());
---
>       if (log.isDebugEnabled())
>       	log.debug("Created SignatureDSA using " + algorithmID);
115,117c66
<          this._signatureAlgorithm =
<             Signature.getInstance(algorithmID.getAlgorithmID(),
<                                   algorithmID.getProviderId());
---
>          this._signatureAlgorithm = Signature.getInstance(algorithmID);
119c68
<          Object[] exArgs = { algorithmID.getAlgorithmID(),
---
>          Object[] exArgs = { algorithmID,
123,127d71
<       } catch (java.security.NoSuchProviderException ex) {
<          Object[] exArgs = { algorithmID.getProviderId(),
<                              ex.getLocalizedMessage() };
< 
<          throw new XMLSignatureException("algorithms.NoSuchProvider", exArgs);
131,137c75
<    /**
<     * Proxy method for {@link java.security.Signature#setParameter}
<     * which is executed on the internal {@link java.security.Signature} object.
<     *
<     * @param params
<     * @throws XMLSignatureException
<     */
---
>    /** @inheritDoc */
148,155c86
<    /**
<     * Proxy method for {@link java.security.Signature#verify}
<     * which is executed on the internal {@link java.security.Signature} object.
<     *
<     * @param signature
<     * @return
<     * @throws XMLSignatureException
<     */
---
>    /** @inheritDoc */
166,174c97,107
<    /**
<     * Proxy method for {@link java.security.Signature#initVerify}
<     * which is executed on the internal {@link java.security.Signature} object.
<     *
<     * @param publickey
<     * @throws XMLSignatureException
<     */
<    protected void engineInitVerify(PublicKey publickey)
<            throws XMLSignatureException {
---
>    /** @inheritDoc */
>    protected void engineInitVerify(Key publicKey) throws XMLSignatureException {
> 
>       if (!(publicKey instanceof PublicKey)) {
>          String supplied = publicKey.getClass().getName();
>          String needed = PublicKey.class.getName();
>          Object exArgs[] = { supplied, needed };
> 
>          throw new XMLSignatureException("algorithms.WrongKeyForThisOperation",
>                                          exArgs);
>       }
177c110
<          this._signatureAlgorithm.initVerify((PublicKey) publickey);
---
>          this._signatureAlgorithm.initVerify((PublicKey) publicKey);
183,189c116
<    /**
<     * Proxy method for {@link java.security.Signature#sign}
<     * which is executed on the internal {@link java.security.Signature} object.
<     *
<     * @return the result of the {@link java.security.Signature#sign} method
<     * @throws XMLSignatureException
<     */
---
>    /** @inheritDoc */
199,209c126,137
<    /**
<     * Proxy method for {@link java.security.Signature#initSign}
<     * which is executed on the internal {@link java.security.Signature} object.
<     *
<     * @param privateKey
<     * @param secureRandom
<     * @throws XMLSignatureException
<     */
<    protected void engineInitSign(
<            PrivateKey privateKey, SecureRandom secureRandom)
<               throws XMLSignatureException {
---
>    /** @inheritDoc */
>    protected void engineInitSign(Key privateKey, SecureRandom secureRandom)
>            throws XMLSignatureException {
> 
>       if (!(privateKey instanceof PrivateKey)) {
>          String supplied = privateKey.getClass().getName();
>          String needed = PrivateKey.class.getName();
>          Object exArgs[] = { supplied, needed };
> 
>          throw new XMLSignatureException("algorithms.WrongKeyForThisOperation",
>                                          exArgs);
>       }
219,227c147,157
<    /**
<     * Proxy method for {@link java.security.Signature#initSign}
<     * which is executed on the internal {@link java.security.Signature} object.
<     *
<     * @param privateKey
<     * @throws XMLSignatureException
<     */
<    protected void engineInitSign(PrivateKey privateKey)
<            throws XMLSignatureException {
---
>    /** @inheritDoc */
>    protected void engineInitSign(Key privateKey) throws XMLSignatureException {
> 
>       if (!(privateKey instanceof PrivateKey)) {
>          String supplied = privateKey.getClass().getName();
>          String needed = PrivateKey.class.getName();
>          Object exArgs[] = { supplied, needed };
> 
>          throw new XMLSignatureException("algorithms.WrongKeyForThisOperation",
>                                          exArgs);
>       }
236,242c166
<    /**
<     * Proxy method for {@link java.security.Signature#update}
<     * which is executed on the internal {@link java.security.Signature} object.
<     *
<     * @param input
<     * @throws XMLSignatureException
<     */
---
>    /** @inheritDoc */
252,258c176
<    /**
<     * Proxy method for {@link java.security.Signature#update}
<     * which is executed on the internal {@link java.security.Signature} object.
<     *
<     * @param input
<     * @throws XMLSignatureException
<     */
---
>    /** @inheritDoc */
268,276c186
<    /**
<     * Proxy method for {@link java.security.Signature#update}
<     * which is executed on the internal {@link java.security.Signature} object.
<     *
<     * @param buf
<     * @param offset
<     * @param len
<     * @throws XMLSignatureException
<     */
---
>    /** @inheritDoc */
287,291c197
<    /**
<     * Method engineGetJCEAlgorithmString
<     *
<     * @return
<     */
---
>    /** @inheritDoc */
296,300c202
<    /**
<     * Method engineGetJCEProviderName
<     *
<     * @return
<     */
---
>    /** @inheritDoc */
305,310c207
<    /**
<     * Method engineSetHMACOutputLength
<     *
<     * @param HMACOutputLength
<     * @throws XMLSignatureException
<     */
---
>    /** @inheritDoc */
316,332c213
<    /**
<     * Method engineInitVerify
<     *
<     * @param secretkey
<     * @throws XMLSignatureException
<     */
<    protected void engineInitVerify(Key secretkey) throws XMLSignatureException {
<       throw new XMLSignatureException("algorithms.operationOnlyForMAC");
<    }
< 
<    /**
<     * Method engineInitSign
<     *
<     * @param secretKey
<     * @param algorithmParameterSpec
<     * @throws XMLSignatureException
<     */
---
>    /** @inheritDoc */
334c215
<            Key secretKey, AlgorithmParameterSpec algorithmParameterSpec)
---
>            Key signingKey, AlgorithmParameterSpec algorithmParameterSpec)
336c217,218
<       throw new XMLSignatureException("algorithms.operationOnlyForMAC");
---
>       throw new XMLSignatureException(
>          "algorithms.CannotUseAlgorithmParameterSpecOnRSA");
340c222
<     * Method engineInitSign
---
>     * Class SignatureRSASHA1
342,343c224,225
<     * @param secretKey
<     * @throws XMLSignatureException
---
>     * @author $Author: vishal $
>     * @version $Revision: 1.11 $
345,348d226
<    protected void engineInitSign(Key secretKey) throws XMLSignatureException {
<       throw new XMLSignatureException("algorithms.operationOnlyForMAC");
<    }
< 
349a228,233
> 
>       /**
>        * Constructor SignatureRSASHA1
>        *
>        * @throws XMLSignatureException
>        */
352a237,238
> 
>       /** @inheritDoc */
356a243,249
> 
>    /**
>     * Class SignatureRSASHA256
>     *
>     * @author $Author: vishal $
>     * @version $Revision: 1.11 $
>     */
357a251,256
> 
>       /**
>        * Constructor SignatureRSASHA256
>        *
>        * @throws XMLSignatureException
>        */
360a260,261
> 
>       /** @inheritDoc */
364a266,272
> 
>    /**
>     * Class SignatureRSASHA384
>     *
>     * @author $Author: vishal $
>     * @version $Revision: 1.11 $
>     */
365a274,279
> 
>       /**
>        * Constructor SignatureRSASHA384
>        *
>        * @throws XMLSignatureException
>        */
368a283,284
> 
>       /** @inheritDoc */
372a289,295
> 
>    /**
>     * Class SignatureRSASHA512
>     *
>     * @author $Author: vishal $
>     * @version $Revision: 1.11 $
>     */
373a297,302
> 
>       /**
>        * Constructor SignatureRSASHA512
>        *
>        * @throws XMLSignatureException
>        */
376a306,307
> 
>       /** @inheritDoc */
380a312,318
> 
>    /**
>     * Class SignatureRSARIPEMD160
>     *
>     * @author $Author: vishal $
>     * @version $Revision: 1.11 $
>     */
381a320,325
> 
>       /**
>        * Constructor SignatureRSARIPEMD160
>        *
>        * @throws XMLSignatureException
>        */
384a329,330
> 
>       /** @inheritDoc */
388a335,341
> 
>    /**
>     * Class SignatureRSAMD5
>     *
>     * @author $Author: vishal $
>     * @version $Revision: 1.11 $
>     */
389a343,348
> 
>       /**
>        * Constructor SignatureRSAMD5
>        *
>        * @throws XMLSignatureException
>        */
392a352,353
> 
>       /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/algorithms/implementations/SignatureDSA.java xml-security-1_2_0/src/org/apache/xml/security/algorithms/implementations/SignatureDSA.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,64d20
< import java.io.ByteArrayInputStream;
< import java.io.ByteArrayOutputStream;
66d21
< import java.math.BigInteger;
76,86c31,36
< import java.security.spec.InvalidParameterSpecException;
< import org.apache.xml.security.algorithms.*;
< import org.apache.xml.security.signature.*;
< import org.apache.xml.security.utils.*;
< import org.w3c.dom.*;
< /*
< import org.bouncycastle.asn1.DERConstructedSequence;
< import org.bouncycastle.asn1.DERInputStream;
< import org.bouncycastle.asn1.DERInteger;
< import org.bouncycastle.asn1.DEROutputStream;
< */
---
> 
> import org.apache.xml.security.algorithms.JCEMapper;
> import org.apache.xml.security.algorithms.SignatureAlgorithmSpi;
> import org.apache.xml.security.signature.XMLSignatureException;
> import org.apache.xml.security.utils.Base64;
> import org.apache.xml.security.utils.Constants;
91c41
<  * @author $Author: dohy $
---
>  * @author $Author: vishal $
95,97c45,47
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(SignatureDSA.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(SignatureDSA.class.getName());
108c58
<     * @return
---
>     * @inheritDoc
111c61
<       return this._URI;
---
>       return SignatureDSA._URI;
121,125c71,73
<       JCEMapper.ProviderIdClass algorithmID =
<          JCEMapper.translateURItoJCEID(this._URI);
< 
<       cat.debug("Created SignatureDSA using " + algorithmID.getAlgorithmID()
<                 + " " + algorithmID.getProviderId());
---
>       String algorithmID = JCEMapper.translateURItoJCEID(SignatureDSA._URI);
>       if (log.isDebugEnabled())
>       	log.debug("Created SignatureDSA using " + algorithmID);
128,130c76
<          this._signatureAlgorithm =
<             Signature.getInstance(algorithmID.getAlgorithmID(),
<                                   algorithmID.getProviderId());
---
>          this._signatureAlgorithm = Signature.getInstance(algorithmID);
132c78
<          Object[] exArgs = { algorithmID.getAlgorithmID(),
---
>          Object[] exArgs = { algorithmID,
136,140d81
<       } catch (java.security.NoSuchProviderException ex) {
<          Object[] exArgs = { algorithmID.getProviderId(),
<                              ex.getLocalizedMessage() };
< 
<          throw new XMLSignatureException("algorithms.NoSuchProvider", exArgs);
145,149c86
<     * Proxy method for {@link java.security.Signature#setParameter}
<     * which is executed on the internal {@link java.security.Signature} object.
<     *
<     * @param params
<     * @throws XMLSignatureException
---
>     * @inheritDoc
162,167c99
<     * Proxy method for {@link java.security.Signature#verify}
<     * which is executed on the internal {@link java.security.Signature} object.
<     *
<     * @param signature
<     * @return
<     * @throws XMLSignatureException
---
>     * @inheritDoc
173c105,106
<          cat.debug("Called DSA.verify() on " + Base64.encode(signature));
---
>          if (log.isDebugEnabled())
>          	log.debug("Called DSA.verify() on " + Base64.encode(signature));
186,190c119
<     * Proxy method for {@link java.security.Signature#initVerify}
<     * which is executed on the internal {@link java.security.Signature} object.
<     *
<     * @param publickey
<     * @throws XMLSignatureException
---
>     * @inheritDoc
192,193c121,130
<    protected void engineInitVerify(PublicKey publickey)
<            throws XMLSignatureException {
---
>    protected void engineInitVerify(Key publicKey) throws XMLSignatureException {
> 
>       if (!(publicKey instanceof PublicKey)) {
>          String supplied = publicKey.getClass().getName();
>          String needed = PublicKey.class.getName();
>          Object exArgs[] = { supplied, needed };
> 
>          throw new XMLSignatureException("algorithms.WrongKeyForThisOperation",
>                                          exArgs);
>       }
196c133
<          this._signatureAlgorithm.initVerify((PublicKey) publickey);
---
>          this._signatureAlgorithm.initVerify((PublicKey) publicKey);
203,207c140
<     * Proxy method for {@link java.security.Signature#sign}
<     * which is executed on the internal {@link java.security.Signature} object.
<     *
<     * @return the result of the {@link java.security.Signature#sign} method
<     * @throws XMLSignatureException
---
>     * @inheritDoc
223,228c156
<     * Proxy method for {@link java.security.Signature#initSign}
<     * which is executed on the internal {@link java.security.Signature} object.
<     *
<     * @param privateKey
<     * @param secureRandom
<     * @throws XMLSignatureException
---
>     * @inheritDoc
230,232c158,168
<    protected void engineInitSign(
<            PrivateKey privateKey, SecureRandom secureRandom)
<               throws XMLSignatureException {
---
>    protected void engineInitSign(Key privateKey, SecureRandom secureRandom)
>            throws XMLSignatureException {
> 
>       if (!(privateKey instanceof PrivateKey)) {
>          String supplied = privateKey.getClass().getName();
>          String needed = PrivateKey.class.getName();
>          Object exArgs[] = { supplied, needed };
> 
>          throw new XMLSignatureException("algorithms.WrongKeyForThisOperation",
>                                          exArgs);
>       }
243,247c179
<     * Proxy method for {@link java.security.Signature#initSign}
<     * which is executed on the internal {@link java.security.Signature} object.
<     *
<     * @param privateKey
<     * @throws XMLSignatureException
---
>     * @inheritDoc
249,250c181,190
<    protected void engineInitSign(PrivateKey privateKey)
<            throws XMLSignatureException {
---
>    protected void engineInitSign(Key privateKey) throws XMLSignatureException {
> 
>       if (!(privateKey instanceof PrivateKey)) {
>          String supplied = privateKey.getClass().getName();
>          String needed = PrivateKey.class.getName();
>          Object exArgs[] = { supplied, needed };
> 
>          throw new XMLSignatureException("algorithms.WrongKeyForThisOperation",
>                                          exArgs);
>       }
260,264c200
<     * Proxy method for {@link java.security.Signature#update}
<     * which is executed on the internal {@link java.security.Signature} object.
<     *
<     * @param input
<     * @throws XMLSignatureException
---
>     * @inheritDoc
276,280c212
<     * Proxy method for {@link java.security.Signature#update}
<     * which is executed on the internal {@link java.security.Signature} object.
<     *
<     * @param input
<     * @throws XMLSignatureException
---
>     * @inheritDoc
292,298c224
<     * Proxy method for {@link java.security.Signature#update}
<     * which is executed on the internal {@link java.security.Signature} object.
<     *
<     * @param buf
<     * @param offset
<     * @param len
<     * @throws XMLSignatureException
---
>     * @inheritDoc
313c239
<     * @return
---
>     * @inheritDoc
322c248
<     * @return
---
>     * @inheritDoc
328,439d253
<    /*
<     * Converts a XML Signature DSA Value to an ASN.1 DSA value.
<     *
<     * The JAVA JCE DSA Signature algorithm creates ASN.1 encoded (r,s) value
<     * pairs; the XML Signature requires the core BigInteger values.
<     *
<     * @param xmldsigbytes
<     * @return
<     * @throws IOException
<     * @see org.bouncycastle.jce.provider.JDKDSASigner#derEncode
<     * @see <A HREF="http://www.w3.org/TR/xmldsig-core/#dsa-sha1">6.4.1 DSA</A>
<    private static byte[] convertXMLDSIGtoASN1_BOUNCY(byte[] xmldsigbytes)
<            throws IOException {
< 
<       byte rbytes[] = new byte[21];
<       byte sbytes[] = new byte[21];
< 
<       rbytes[0] = (byte) 0x00;
<       sbytes[0] = (byte) 0x00;
< 
<       System.arraycopy(xmldsigbytes, 0, rbytes, 1, 20);
<       System.arraycopy(xmldsigbytes, 20, sbytes, 1, 20);
< 
<       BigInteger r = new BigInteger(rbytes);
<       BigInteger s = new BigInteger(sbytes);
< 
<       cat.debug("Verify DSA r=" + r.toString());
<       cat.debug("Verify DSA s=" + s.toString());
< 
<       ByteArrayOutputStream bOut = new ByteArrayOutputStream();
<       DEROutputStream dOut = new DEROutputStream(bOut);
<       DERConstructedSequence seq = new DERConstructedSequence();
< 
<       seq.addObject(new DERInteger(r));
<       seq.addObject(new DERInteger(s));
<       dOut.writeObject(seq);
< 
<       return bOut.toByteArray();
<    }
<     */
< 
<    /*
<     * Converts an ASN.1 DSA value to a XML Signature DSA Value.
<     *
<     * The JAVA JCE DSA Signature algorithm creates ASN.1 encoded (r,s) value
<     * pairs; the XML Signature requires the core BigInteger values.
<     *
<     * @param derbytes
<     * @return
<     * @throws IOException
<     * @see org.bouncycastle.jce.provider.JDKDSASigner#derDecode
<     * @see <A HREF="http://www.w3.org/TR/xmldsig-core/#dsa-sha1">6.4.1 DSA</A>
<    private static byte[] convertASN1toXMLDSIG_BOUNCY(byte derbytes[])
<            throws IOException {
< 
<       cat.debug("Input convertASN1toXMLDSIG("
<                 + HexDump.byteArrayToHexString(derbytes) + ")");
< 
<       ByteArrayInputStream bIn = new ByteArrayInputStream(derbytes);
<       DERInputStream dIn = new DERInputStream(bIn);
<       DERConstructedSequence seq = (DERConstructedSequence) dIn.readObject();
<       BigInteger r = ((DERInteger) seq.getObjectAt(0)).getValue();
<       BigInteger s = ((DERInteger) seq.getObjectAt(1)).getValue();
< 
<       cat.debug("Created DSA r=" + r.toString());
<       cat.debug("Created DSA s=" + s.toString());
< 
<       byte rbytes[] = r.toByteArray();
<       byte sbytes[] = s.toByteArray();
< 
<       cat.debug("r1=" + HexDump.byteArrayToHexString(rbytes));
<       cat.debug("s1=" + HexDump.byteArrayToHexString(sbytes));
< 
<       rbytes = SignatureDSA.normalizeBigIntegerArray(rbytes);
<       sbytes = SignatureDSA.normalizeBigIntegerArray(sbytes);
< 
<       cat.debug("r2=" + HexDump.byteArrayToHexString(rbytes));
<       cat.debug("s2=" + HexDump.byteArrayToHexString(sbytes));
< 
<       byte result[] = new byte[40];
< 
<       System.arraycopy(rbytes, 0, result, 0, 20);
<       System.arraycopy(sbytes, 0, result, 20, 20);
< 
<       return result;
<    }
<     */
< 
<    /*
<     *
<     * @see org.bouncycastle.jce.provider.JDKDSASigner#derEncode
<     * @param bigIntegerArray
<     * @return
<     * @see <A HREF="http://www.w3.org/TR/xmldsig-core/#dsa-sha1">6.4.1 DSA</A>
<    private static byte[] normalizeBigIntegerArray(byte bigIntegerArray[]) {
< 
<       byte resultBytes[] = new byte[20];
< 
<       for (int i = 0; i < 20; i++) {
<          resultBytes[i] = (byte) 0x00;
<       }
< 
<       if (bigIntegerArray.length == 21) {
<          System.arraycopy(bigIntegerArray, 1, resultBytes, 0, 20);
<       } else {
<          System.arraycopy(bigIntegerArray, 0, resultBytes,
<                           20 - bigIntegerArray.length, bigIntegerArray.length);
<       }
< 
<       return resultBytes;
<    }
<     */
446a261,264
>     * @param asn1Bytes
>     * @return the decode bytes
>     *
>     * @throws IOException
449c267,268
<    private static byte[] convertASN1toXMLDSIG(byte asn1Bytes[]) throws IOException {
---
>    private static byte[] convertASN1toXMLDSIG(byte asn1Bytes[])
>            throws IOException {
459c278,279
<       for (j = sLength; (j > 0) && (asn1Bytes[(6 + rLength + sLength) - j] == 0); j--);
---
>       for (j = sLength;
>               (j > 0) && (asn1Bytes[(6 + rLength + sLength) - j] == 0); j--);
462,463c282,283
<               || (asn1Bytes[2] != 2) || (i > 20) || (asn1Bytes[4 + rLength] != 2)
<               || (j > 20)) {
---
>               || (asn1Bytes[2] != 2) || (i > 20)
>               || (asn1Bytes[4 + rLength] != 2) || (j > 20)) {
465,466c285,286
<       } else {
<          byte xmldsigBytes[] = new byte[40];
---
>       } 
>       byte xmldsigBytes[] = new byte[40];
468,469c288,291
<          System.arraycopy(asn1Bytes, (4 + rLength) - i, xmldsigBytes, 20 - i, i);
<          System.arraycopy(asn1Bytes, (6 + rLength + sLength) - j, xmldsigBytes, 40 - j, j);
---
>       System.arraycopy(asn1Bytes, (4 + rLength) - i, xmldsigBytes, 20 - i,
>                           i);
>       System.arraycopy(asn1Bytes, (6 + rLength + sLength) - j, xmldsigBytes,
>                           40 - j, j);
471,472c293
<          return xmldsigBytes;
<       }
---
>        return xmldsigBytes;      
480a302,305
>     * @param xmldsigBytes
>     * @return the encoded ASN.1 bytes
>     *
>     * @throws IOException
483c308,309
<    private static byte[] convertXMLDSIGtoASN1(byte xmldsigBytes[]) throws IOException {
---
>    private static byte[] convertXMLDSIGtoASN1(byte xmldsigBytes[])
>            throws IOException {
489a316
> 
492a320
> 
497a326
> 
500a330
> 
534,543d363
<     * Method engineInitVerify
<     *
<     * @param secretkey
<     * @throws XMLSignatureException
<     */
<    protected void engineInitVerify(Key secretkey) throws XMLSignatureException {
<       throw new XMLSignatureException("algorithms.operationOnlyForMAC");
<    }
< 
<    /**
546c366
<     * @param secretKey
---
>     * @param signingKey
551c371
<            Key secretKey, AlgorithmParameterSpec algorithmParameterSpec)
---
>            Key signingKey, AlgorithmParameterSpec algorithmParameterSpec)
553,563c373,374
<       throw new XMLSignatureException("algorithms.operationOnlyForMAC");
<    }
< 
<    /**
<     * Method engineInitSign
<     *
<     * @param secretKey
<     * @throws XMLSignatureException
<     */
<    protected void engineInitSign(Key secretKey) throws XMLSignatureException {
<       throw new XMLSignatureException("algorithms.operationOnlyForMAC");
---
>       throw new XMLSignatureException(
>          "algorithms.CannotUseAlgorithmParameterSpecOnDSA");
diff -r xml-security-orig-v1/src/org/apache/xml/security/algorithms/JCEMapper.java xml-security-1_2_0/src/org/apache/xml/security/algorithms/JCEMapper.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,68c21,27
< import java.util.*;
< import java.security.*;
< import org.w3c.dom.*;
< import org.apache.xpath.XPathAPI;
< import javax.xml.transform.TransformerException;
< import org.apache.xml.security.utils.*;
---
> import java.util.HashMap;
> import java.util.Map;
> 
> import org.apache.xml.security.Init;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Element;
> 
74c33
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
78,216c37,152
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(JCEMapper.class.getName());
< 
<    /** Field _providerList */
<    private static Element _providerList = null;
< 
<    /** Field _nscontext */
<    private static Element _nscontext = null;
< 
<    /**
<     * Method init
<     *
<     * @param mappingElement
<     * @throws Exception
<     */
<    public static void init(Element mappingElement) throws Exception {
< 
<       JCEMapper._providerList = mappingElement;
< 
<       Document doc = mappingElement.getOwnerDocument();
< 
<       JCEMapper._nscontext =
<          XMLUtils.createDSctx(doc, "x",
<                               "http://www.xmlsecurity.org/NS/#configuration");
<    }
< 
<    /**
<     * This method takes a Provider ID and tries to register this provider in the JCE.
<     *
<     * @param Id
<     * @return
<     */
<    public static boolean addProvider(String Id) {
< 
<       try {
<          if (Security.getProvider(Id) == null) {
<             Element providerElem = (Element) XPathAPI.selectSingleNode(
<                JCEMapper._providerList,
<                "./x:Providers/x:Provider[@Id='" + Id + "']",
<                JCEMapper._nscontext);
<             String providerClass = providerElem.getAttributeNS(null, "Class");
<             java.security.Provider prov =
<                (java.security.Provider) Class.forName(providerClass)
<                   .newInstance();
< 
<             if (java.security.Security.getProvider(Id) == null) {
<                cat.debug("The provider " + Id
<                          + " had to be added to the java.security.Security");
<                java.security.Security.addProvider(prov);
< 
<                Provider registeredProvider =
<                   java.security.Security.getProvider(Id);
< 
<                if (registeredProvider != null) {
<                   return true;
<                }
<             }
<          }
<       } catch (TransformerException ex) {}
<       catch (ClassNotFoundException ex) {}
<       catch (IllegalAccessException ex) {}
<       catch (InstantiationException ex) {}
< 
<       return false;
<    }
< 
<    /**
<     * Method getProviderIsAvailable
<     *
<     * @param providerId
<     * @return
<     */
<    public static boolean getProviderIsInClassPath(String providerId) {
< 
<       boolean available = false;
< 
<       try {
<          Element pro =
<             (Element) XPathAPI.selectSingleNode(JCEMapper._providerList,
<                                                 "./x:Providers/x:Provider[@Id='"
<                                                 + providerId + "']",
<                                                 JCEMapper._nscontext);
<          String providerClass = pro.getAttributeNS(null, "Class");
<          java.security.Provider prov =
<             (java.security.Provider) Class.forName(providerClass).newInstance();
< 
<          if (prov != null) {
<             available = true;
<          }
<       } catch (TransformerException ex) {
<          ;
<       } catch (ClassNotFoundException ex) {
<          ;
<       } catch (IllegalAccessException ex) {
<          ;
<       } catch (InstantiationException ex) {
<          ;
<       }
< 
<       return available;
<    }
< 
<    /**
<     * Return <CODE>true</CODE> if the Provider with the given
<     * <CODE>providerId</CODE> is available in {@link java.security.Security}.
<     *
<     * @param providerId
<     * @return <CODE>true</CODE> if the Provider with the given <CODE>providerId</CODE> is available in {@link java.security.Security}
<     */
<    public static boolean getProviderIsRegisteredAtSecurity(String providerId) {
< 
<       java.security.Provider prov =
<          java.security.Security.getProvider(providerId);
< 
<       if (prov != null) {
<          return true;
<       }
< 
<       return false;
<    }
< 
<    /**
<     * Method translateURItoJCEID
<     *
<     * @param AlgorithmURI
<     * @return
<     */
<    public static ProviderIdClass translateURItoJCEID(String AlgorithmURI) {
< 
<       cat.debug("Request for URI " + AlgorithmURI);
< 
<       try {
< 
<          /*
<          Attr jceName = (Attr) XPathAPI.selectSingleNode(
<             JCEMapper._providerList,
<             "./x:Algorithms/x:Algorithm[@URI='" + AlgorithmURI
<             + "']/x:Provider[1]/@JCEName", JCEMapper._nscontext);
---
> 
> 
>     public class ProviderIdClass {
>         // TODO
>     }
> 
>     /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log =
>             org.apache.commons.logging.LogFactory.getLog(JCEMapper.class.getName());
> 
> 
> 
>     private static Map uriToJCEName = new HashMap();
> 
>     private static Map algorithmsMap = new HashMap();
> 
>     /**
>      * Method init
>      *
>      * @param mappingElement
>      * @throws Exception
>      */
>     public static void init(Element mappingElement) throws Exception {
> 
>         loadAlgorithms((Element)mappingElement.getElementsByTagName("Algorithms").item(0));
>     }
> 
>     static void loadAlgorithms( Element algorithmsEl) {
>         Element[] algorithms = XMLUtils.selectNodes(algorithmsEl.getFirstChild(),Init.CONF_NS,"Algorithm");
>         for (int i = 0 ;i < algorithms.length ;i ++) {
>             Element el = algorithms[i];
>             String id = el.getAttribute("URI");
>             String jceName = el.getAttribute("JCEName");
>             uriToJCEName.put(id, jceName);
>             algorithmsMap.put(id, new Algorithm(el));
>         }
>     }
> 
>     static Algorithm getAlgorithmMapping(String algoURI) {
>         return ((Algorithm)algorithmsMap.get(algoURI));
>     }
> 
>     /**
>      * Method translateURItoJCEID
>      *
>      * @param AlgorithmURI
>      * @return the JCE standard name corresponding to the given URI
>      *
>      */
>     public static String translateURItoJCEID(String AlgorithmURI) {
>         if (log.isDebugEnabled()) {
>             log.debug("Request for URI " + AlgorithmURI);
>         }
> 
>         String jceName = (String) uriToJCEName.get(AlgorithmURI);
>         return jceName;
>     }
> 
>     public static org.apache.xml.security.algorithms.JCEMapper.ProviderIdClass translateURItoJCEIDBlah(String AlgorithmURI) {
>         if (log.isDebugEnabled()) {
>             log.debug("Request for URI " + AlgorithmURI);
>         }
> 
>         String jceName = (String) uriToJCEName.get(AlgorithmURI);
>         return null;
>     }
> 
>     /**
>      * Method getAlgorithmClassFromURI
>      * NOTE(Raul Benito) It seems a buggy function the loop doesn't do
>      * anything??
>      * @param AlgorithmURI
>      * @return the class name that implements this algorithm
>      *
>      */
>     public static String getAlgorithmClassFromURI(String AlgorithmURI) {
>         if (log.isDebugEnabled()) {
>             log.debug("Request for URI " + AlgorithmURI);
>         }
> 
>         return ((Algorithm) algorithmsMap.get(AlgorithmURI)).algorithmClass;
>     }
> 
>     /**
>      * Returns the keylength in bit for a particular algorithm.
>      *
>      * @param AlgorithmURI
>      * @return The length of the key used in the alogrithm
>      */
>     public static int getKeyLengthFromURI(String AlgorithmURI) {
>         return Integer.parseInt(((Algorithm) algorithmsMap.get(AlgorithmURI)).keyLength);
>     }
> 
>     /**
>      * Method getJCEKeyAlgorithmFromURI
>      *
>      * @param AlgorithmURI
>      * @return The KeyAlgorithm for the given URI.
>      *
>      */
>     public static String getJCEKeyAlgorithmFromURI(String AlgorithmURI) {
> 
>         return  ((Algorithm) algorithmsMap.get(AlgorithmURI)).requiredKey;
> 
>     }
> 
>     /**
>      * Represents the Algorithm xml element
>      */
>     public static class Algorithm {
>         String algorithmClass;
>         String keyLength;
>         String requiredKey;
>         /**
>          * Gets data from element
>          * @param el
218,529c154,195
<          NodeList providers = XPathAPI.selectNodeList(JCEMapper._providerList,
<                                  "./x:Algorithms/x:Algorithm[@URI='"
<                                  + AlgorithmURI + "']/x:ProviderAlgo",
<                                  JCEMapper._nscontext);
< 
<          for (int i = 0; i < providers.getLength(); i++) {
<             Element pro = (Element) providers.item(i);
<             String jceName = pro.getAttributeNS(null, "JCEName");
<             String providerId = pro.getAttributeNS(null, "ProviderId");
< 
<             if (JCEMapper.getProviderIsInClassPath(providerId)) {
<                JCEMapper.addProvider(providerId);
< 
<                ProviderIdClass result = new ProviderIdClass(jceName,
<                                            providerId);
< 
<                cat.debug("Found " + result.getAlgorithmID() + " from provider "
<                          + result.getProviderId());
< 
<                return result;
<             }
<          }
<       } catch (TransformerException ex) {
<          cat.debug("Found nothing: " + ex.getMessage());
<       }
< 
<       return null;
<    }
< 
<    /**
<     * Method translateURItoJCEID
<     *
<     * @param AlgorithmURI
<     * @param requestedProviderId
<     * @return
<     */
<    public static ProviderIdClass translateURItoJCEID(String AlgorithmURI,
<            String requestedProviderId) {
< 
<       cat.debug("Request for URI " + AlgorithmURI + " from provider "
<                 + requestedProviderId);
< 
<       if (!JCEMapper.getProviderIsInClassPath(requestedProviderId)) {
<          return null;
<       }
< 
<       try {
<          Element pro = (Element) XPathAPI.selectSingleNode(
<             JCEMapper._providerList,
<             "./x:Algorithms/x:Algorithm[@URI='" + AlgorithmURI
<             + "']/x:ProviderAlgo[@ProviderId='" + requestedProviderId + "']",
<             JCEMapper._nscontext);
<          String jceName = pro.getAttributeNS(null, "JCEName");
< 
<          JCEMapper.addProvider(requestedProviderId);
< 
<          ProviderIdClass result = new ProviderIdClass(jceName,
<                                      requestedProviderId);
< 
<          cat.debug("Found " + result.getAlgorithmID() + " from provider "
<                    + result.getProviderId());
< 
<          return result;
<       } catch (TransformerException ex) {
<          cat.debug("Found nothing: " + ex.getMessage());
<       }
< 
<       return null;
<    }
< 
<    /**
<     * Method getAlgorithmClassFromURI
<     *
<     * @param AlgorithmURI
<     * @return
<     */
<    public static String getAlgorithmClassFromURI(String AlgorithmURI) {
< 
<       cat.debug("Request for URI " + AlgorithmURI);
< 
<       try {
<          NodeList providers = XPathAPI.selectNodeList(JCEMapper._providerList,
<                                  "./x:Algorithms/x:Algorithm[@URI='"
<                                  + AlgorithmURI + "']/x:ProviderAlgo",
<                                  JCEMapper._nscontext);
< 
<          for (int i = 0; i < providers.getLength(); i++) {
<             Element pro = (Element) providers.item(i);
<             Attr jceName = pro.getAttributeNode("JCEName");
< 
<             cat.debug("Found " + jceName.getNodeValue());
<          }
< 
<          return ((Element) providers.item(0)).getAttributeNS(null, "JCEName");
<       } catch (TransformerException ex) {
<          cat.debug("Found nothing: " + ex.getMessage());
< 
<          return "";
<       }
<    }
< 
<    /**
<     * Method getKeyTypeFromURI
<     *
<     * @param AlgorithmURI
<     * @return
<     */
<    public static int getKeyTypeFromURI(String AlgorithmURI) {
< 
<       try {
<          Attr algoclassAttr =
<             (Attr) XPathAPI.selectSingleNode(JCEMapper._providerList,
<                                              "./x:Algorithms/x:Algorithm[@URI='"
<                                              + AlgorithmURI
<                                              + "']/@AlgorithmClass", JCEMapper
<                                                 ._nscontext);
< 
<          if (algoclassAttr == null) {
<             return -1;
<          } else {
<             String algoclass = algoclassAttr.getNodeValue();
< 
<             if (algoclass.equals(JCEMapper.KEYTYPE_BLOCK_ENCRYPTION)) {
<                return javax.crypto.Cipher.SECRET_KEY;
<             } else if (algoclass.equals("Mac")) {
<                return javax.crypto.Cipher.SECRET_KEY;
<             } else if (algoclass.equals(JCEMapper.KEYTYPE_SYMMETRIC_KEY_WRAP)) {
<                return javax.crypto.Cipher.SECRET_KEY;
<             }
<          }
<       } catch (TransformerException ex) {
<          cat.debug("Found nothing: " + ex.getMessage());
<       }
< 
<       return -1;
<    }
< 
<    /**
<     * Returns the keylength in bit for a particular algorithm.
<     *
<     * @param AlgorithmURI
<     * @return
<     */
<    public static int getKeyLengthFromURI(String AlgorithmURI) {
< 
<       try {
<          Attr algoclassAttr =
<             (Attr) XPathAPI.selectSingleNode(JCEMapper._providerList,
<                                              "./x:Algorithms/x:Algorithm[@URI='"
<                                              + AlgorithmURI + "']/@KeyLength",
<                                              JCEMapper._nscontext);
< 
<          if (algoclassAttr != null) {
<             return Integer.parseInt(algoclassAttr.getNodeValue());
<          }
<       } catch (TransformerException ex) {
<          cat.debug("Found nothing: " + ex.getMessage());
<       }
< 
<       return 0;
<    }
< 
<    /**
<     * Method getJCEKeyAlgorithmFromURI
<     *
<     * @param AlgorithmURI
<     * @param ProviderId
<     * @return
<     */
<    public static String getJCEKeyAlgorithmFromURI(String AlgorithmURI,
<            String ProviderId) {
< 
<       try {
<          Attr algoclassAttr =
<             (Attr) XPathAPI.selectSingleNode(JCEMapper._providerList,
<                                              "./x:Algorithms/x:Algorithm[@URI='"
<                                              + AlgorithmURI
<                                              + "']/x:ProviderAlgo[@ProviderId='"
<                                              + ProviderId + "']/@RequiredKey",
<                                              JCEMapper._nscontext);
< 
<          if (algoclassAttr != null) {
<             return algoclassAttr.getNodeValue();
<          }
<       } catch (TransformerException ex) {
<          cat.debug("Found nothing: " + ex.getMessage());
<       }
< 
<       return null;
<    }
< 
< 
<    public static String getJCEIVAlgorithmFromURI(String AlgorithmURI,
<            String ProviderId) {
< 
<       try {
<          Attr algoclassAttr =
<             (Attr) XPathAPI.selectSingleNode(JCEMapper._providerList,
<                                              "./x:Algorithms/x:Algorithm[@URI='"
<                                              + AlgorithmURI
<                                              + "']/x:ProviderAlgo[@ProviderId='"
<                                              + ProviderId + "']/@IVJCEName",
<                                              JCEMapper._nscontext);
< 
<          if (algoclassAttr != null) {
<             return algoclassAttr.getNodeValue();
<          }
<       } catch (TransformerException ex) {
<          cat.debug("Found nothing: " + ex.getMessage());
<       }
< 
<       return null;
<    }
< 
<    /** Field KEYTYPE_SYMMETRIC_KEY_WRAP           */
<    public static final String KEYTYPE_SYMMETRIC_KEY_WRAP = "SymmetricKeyWrap";
< 
<    /** Field KEYTYPE_BLOCK_ENCRYPTION           */
<    public static final String KEYTYPE_BLOCK_ENCRYPTION = "BlockEncryption";
< 
<    /** Field KEYTYPE_KEY_TRANSPORT           */
<    public static final String KEYTYPE_KEY_TRANSPORT = "KeyTransport";
< 
<    /**
<     * This takes a {@link Key} and one of the <CODE>JCEMapper.KEYTYPE_XXX</CODE>
<     * Strings and returns the algorithm for which this key is.
<     * <BR />
<     * Example: If you enter an AES Key of length 128 bit and the
<     * <CODE>JCEMapper.KEYTYPE_SYMMETRIC_KEY_WRAP</CODE>, the result is
<     * <CODE>EncryptionConstants.ALGO_ID_BLOCKCIPHER_AES128</CODE>.
<     *
<     *
<     * @param key
<     * @param type
<     * @return
<     */
<    public static String getURIfromKey(Key key, String type) {
< 
<       String JCEalgo = key.getAlgorithm();
<       String keyLength = new Integer(key.getEncoded().length * 8).toString();
< 
<       try {
<          Attr URI = (Attr) XPathAPI.selectSingleNode(
<             JCEMapper._providerList,
<             "./x:Algorithms/x:Algorithm[@KeyLength='" + keyLength
<             + "' and @AlgorithmClass='" + type
<             + "']/x:ProviderAlgo[@RequiredKey='" + JCEalgo + "']/../@URI",
<             JCEMapper._nscontext);
< 
<          if (URI != null) {
<             return URI.getNodeValue();
<          }
<       } catch (TransformerException ex) {
<          cat.debug("Found nothing: " + ex.getMessage());
<       }
< 
<       return null;
<    }
< 
<    /*
<    public static String getWrapURIfromKey(Key key) {
<       return JCEMapper.getURIfromKey(key, JCEMapper.KEYTYPE_SYMMETRIC_KEY_WRAP);
<    }
< 
<    public static String getCipherURIfromKey(Key key) {
<       return JCEMapper.getURIfromKey(key, JCEMapper.KEYTYPE_BLOCK_ENCRYPTION);
<    }
<    */
< 
<    /**
<     * Class ProviderIdClass
<     *
<     * @author $Author: dohy $
<     * @version $Revision: 1.1.1.1 $
<     */
<    public static class ProviderIdClass {
< 
<       /** Field _jceid */
<       private String _algorithmId;
< 
<       /** Field _providerClass */
<       private String _providerId;
< 
<       /**
<        * Constructor ProviderIdClass
<        *
<        * @param AlgorithmID
<        * @param ProviderId
<        */
<       protected ProviderIdClass(String AlgorithmID, String ProviderId) {
<          this._algorithmId = AlgorithmID;
<          this._providerId = ProviderId;
<       }
< 
<       /**
<        * Method getJceId
<        *
<        * @return
<        */
<       public String getAlgorithmID() {
<          return this._algorithmId;
<       }
< 
<       /**
<        * Method getProvider
<        *
<        * @return
<        */
<       public String getProviderId() {
<          return this._providerId;
<       }
<    }
---
>         public Algorithm(Element el) {
>             algorithmClass=el.getAttribute("AlgorithmClass");
>             keyLength=el.getAttribute("KeyLength");
>             requiredKey=el.getAttribute("RequiredKey");
>         }
>     }
> 
>     public static String getJCEIVAlgorithmFromURI(String string, String string2) {
>         // TODO Auto-generated method stub
>         return null;
>     }
> 
>     public static boolean addProvider(String string) {
>         // TODO Auto-generated method stub
>         return false;
>     }
> 
>     public static boolean getProviderIsRegisteredAtSecurity(String string) {
>         // TODO Auto-generated method stub
>         return false;
>     }
> 
>     public static int getKeyTypeFromURI(String string) {
>         // TODO Auto-generated method stub
>         return 0;
>     }
> 
>     public static boolean getProviderIsInClassPath(String string) {
>         // TODO Auto-generated method stub
>         return false;
>     }
> 
>     public static ProviderIdClass translateURItoJCEIDBlah(String string,
>             String string2) {
>         // TODO Auto-generated method stub
>         return null;
>     }
> 
>     public static String getJCEKeyAlgorithmFromURI(String string, String string2) {
>         // TODO Auto-generated method stub
>         return null;
>     }
diff -r xml-security-orig-v1/src/org/apache/xml/security/algorithms/MessageDigestAlgorithm.java xml-security-1_2_0/src/org/apache/xml/security/algorithms/MessageDigestAlgorithm.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63d20
< import java.util.Collection;
65,67c22
< import java.security.NoSuchAlgorithmException;
< import org.w3c.dom.*;
< import org.apache.xml.security.signature.XMLSignatureInput;
---
> 
69,72c24,26
< import org.apache.xml.security.utils.*;
< import org.apache.xml.security.c14n.CanonicalizationException;
< import org.apache.xml.security.c14n.InvalidCanonicalizerException;
< import java.io.IOException;
---
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.EncryptionConstants;
> import org.w3c.dom.Document;
85,88c39,42
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category
<          .getInstance(MessageDigestAlgorithm.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(
>                     MessageDigestAlgorithm.class.getName());
90c44
<    // Message Digest - NOT RECOMMENDED MD5
---
>     /** Message Digest - NOT RECOMMENDED MD5*/
92c46
<    // Digest - Required SHA1
---
>    /** Digest - Required SHA1*/
94c48
<    // Message Digest - RECOMMENDED SHA256
---
>    /** Message Digest - RECOMMENDED SHA256*/
96c50
<    // Message Digest - OPTIONAL SHA384
---
>    /** Message Digest - OPTIONAL SHA384*/
98c52
<    // Message Digest - OPTIONAL SHA512
---
>    /** Message Digest - OPTIONAL SHA512*/
100c54
<    // Message Digest - OPTIONAL RIPEMD-160
---
>    /** Message Digest - OPTIONAL RIPEMD-160*/
131,132c85,91
<       JCEMapper.ProviderIdClass algorithmID =
<          JCEMapper.translateURItoJCEID(algorithmURI);
---
>       String algorithmID = JCEMapper.translateURItoJCEID(algorithmURI);
> 
> 	  if (algorithmID == null) {
> 		  Object[] exArgs = { algorithmURI };
> 		  throw new XMLSignatureException("algorithms.NoSuchMap", exArgs);
> 	  }
> 
136,137c95
<          md = MessageDigest.getInstance(algorithmID.getAlgorithmID(),
<                                         algorithmID.getProviderId());
---
>          md = MessageDigest.getInstance(algorithmID);
139,144c97
<          Object[] exArgs = { algorithmID.getAlgorithmID(),
<                              ex.getLocalizedMessage() };
< 
<          throw new XMLSignatureException("algorithms.NoSuchAlgorithm", exArgs);
<       } catch (java.security.NoSuchProviderException ex) {
<          Object[] exArgs = { algorithmID.getProviderId(),
---
>          Object[] exArgs = { algorithmID,
169c122
<     * @see org.apache.xml.security.util.JavaUtils#binaryCompare
---
>     * @see org.apache.xml.security.utils.JavaUtils#binaryCompare
176c129
<     * Proxy method for {@link java.security.MessageDigest#digest}
---
>     * Proxy method for {@link java.security.MessageDigest#digest()}
179c132
<     * @return the result of the {@link java.security.MessageDigest#digest} method
---
>     * @return the result of the {@link java.security.MessageDigest#digest()} method
186c139
<     * Proxy method for {@link java.security.MessageDigest#digest}
---
>     * Proxy method for {@link java.security.MessageDigest#digest(byte[])}
190c143
<     * @return the result of the {@link java.security.MessageDigest#digest} method
---
>     * @return the result of the {@link java.security.MessageDigest#digest(byte[])} method
197c150
<     * Proxy method for {@link java.security.MessageDigest#digest}
---
>     * Proxy method for {@link java.security.MessageDigest#digest(byte[], int, int)}
203c156
<     * @return the result of the {@link java.security.MessageDigest#digest} method
---
>     * @return the result of the {@link java.security.MessageDigest#digest(byte[], int, int)} method
251c204
<     * Proxy method for {@link java.security.MessageDigest#update}
---
>     * Proxy method for {@link java.security.MessageDigest#update(byte[])}
261c214
<     * Proxy method for {@link java.security.MessageDigest#update}
---
>     * Proxy method for {@link java.security.MessageDigest#update(byte)}
271c224
<     * Proxy method for {@link java.security.MessageDigest#update}
---
>     * Proxy method for {@link java.security.MessageDigest#update(byte[], int, int)}
282,286c235
<    /**
<     * Method getBaseNamespace
<     *
<     * @return
<     */
---
>    /** @inheritDoc */
290a240
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/algorithms/package.html xml-security-1_2_0/src/org/apache/xml/security/algorithms/package.html
2c2
< algorithm factories  
---
> algorithm factories.
diff -r xml-security-orig-v1/src/org/apache/xml/security/algorithms/SignatureAlgorithm.java xml-security-1_2_0/src/org/apache/xml/security/algorithms/SignatureAlgorithm.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
62,65d19
< 
< import java.security.cert.Certificate;
< import java.security.InvalidAlgorithmParameterException;
< import java.security.InvalidKeyException;
67,69d20
< import java.security.PrivateKey;
< import java.security.PublicKey;
< import java.security.MessageDigest;
71,72d21
< import java.security.Signature;
< import java.security.SignatureException;
74,81d22
< import java.util.Collection;
< import javax.crypto.Mac;
< import javax.crypto.ShortBufferException;
< import org.apache.xml.security.signature.XMLSignatureException;
< import org.apache.xml.security.utils.*;
< import org.apache.xml.security.utils.Constants;
< import org.apache.xml.security.utils.XMLUtils;
< import org.w3c.dom.*;
82a24
> 
85c27,30
< import org.apache.xml.security.algorithms.implementations.*;
---
> import org.apache.xml.security.signature.XMLSignatureException;
> import org.apache.xml.security.utils.Constants;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
91,96d35
<  * <p>The exists no constructor but the {@link #getInstance} methods to obtain instances of this class.
<  *
<  * <pre>
<  * SignatureAlgorithm.getInstance()
<  * </pre>
<  *
101,103c40,42
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(SignatureAlgorithm.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(SignatureAlgorithm.class.getName());
129,130c68,69
< 
<          cat.debug("Create URI \"" + algorithmURI + "\" class \""
---
>          if (log.isDebugEnabled())
>          	log.debug("Create URI \"" + algorithmURI + "\" class \""
138c77,79
<          throw new XMLSignatureException("algorithms.NoSuchAlgorithm", exArgs, ex);
---
> 
>          throw new XMLSignatureException("algorithms.NoSuchAlgorithm", exArgs,
>                                          ex);
141c82,84
<          throw new XMLSignatureException("algorithms.NoSuchAlgorithm", exArgs, ex);
---
> 
>          throw new XMLSignatureException("algorithms.NoSuchAlgorithm", exArgs,
>                                          ex);
144c87,89
<          throw new XMLSignatureException("algorithms.NoSuchAlgorithm", exArgs, ex);
---
> 
>          throw new XMLSignatureException("algorithms.NoSuchAlgorithm", exArgs,
>                                          ex);
147c92,94
<          throw new XMLSignatureException("algorithms.NoSuchAlgorithm", exArgs, ex);
---
> 
>          throw new XMLSignatureException("algorithms.NoSuchAlgorithm", exArgs,
>                                          ex);
187,188c134,135
< 
<          cat.debug("Create URI \"" + algorithmURI + "\" class \""
---
>          if (log.isDebugEnabled())
>          	log.debug("Create URI \"" + algorithmURI + "\" class \""
199c146,148
<          throw new XMLSignatureException("algorithms.NoSuchAlgorithm", exArgs, ex);
---
> 
>          throw new XMLSignatureException("algorithms.NoSuchAlgorithm", exArgs,
>                                          ex);
202c151,153
<          throw new XMLSignatureException("algorithms.NoSuchAlgorithm", exArgs, ex);
---
> 
>          throw new XMLSignatureException("algorithms.NoSuchAlgorithm", exArgs,
>                                          ex);
205c156,158
<          throw new XMLSignatureException("algorithms.NoSuchAlgorithm", exArgs, ex);
---
> 
>          throw new XMLSignatureException("algorithms.NoSuchAlgorithm", exArgs,
>                                          ex);
208c161,163
<          throw new XMLSignatureException("algorithms.NoSuchAlgorithm", exArgs, ex);
---
> 
>          throw new XMLSignatureException("algorithms.NoSuchAlgorithm", exArgs,
>                                          ex);
213c168
<     * Proxy method for {@link java.security.Signature#sign}
---
>     * Proxy method for {@link java.security.Signature#sign()}
216c171
<     * @return the result of the {@link java.security.Signature#sign} method
---
>     * @return the result of the {@link java.security.Signature#sign()} method
243c198
<     * Proxy method for {@link java.security.Signature#update}
---
>     * Proxy method for {@link java.security.Signature#update(byte[])}
254c209
<     * Proxy method for {@link java.security.Signature#update}
---
>     * Proxy method for {@link java.security.Signature#update(byte)}
265c220
<     * Proxy method for {@link java.security.Signature#update}
---
>     * Proxy method for {@link java.security.Signature#update(byte[], int, int)}
279c234
<     * Proxy method for {@link java.security.Signature#initSign}
---
>     * Proxy method for {@link java.security.Signature#initSign(java.security.PrivateKey)}
282,283c237
<     * @param privateKey
<     * @param secureRandom
---
>     * @param signingKey
286,288c240,241
<    public void initSign(PrivateKey privateKey, SecureRandom secureRandom)
<            throws XMLSignatureException {
<       this._signatureAlgorithm.engineInitSign(privateKey, secureRandom);
---
>    public void initSign(Key signingKey) throws XMLSignatureException {
>       this._signatureAlgorithm.engineInitSign(signingKey);
292c245
<     * Proxy method for {@link java.security.Signature#initSign}
---
>     * Proxy method for {@link java.security.Signature#initSign(java.security.PrivateKey, java.security.SecureRandom)}
295,305c248,249
<     * @param privateKey
<     * @throws XMLSignatureException
<     */
<    public void initSign(PrivateKey privateKey) throws XMLSignatureException {
<       this._signatureAlgorithm.engineInitSign(privateKey);
<    }
< 
<    /**
<     * Method initSign
<     *
<     * @param secretKey
---
>     * @param signingKey
>     * @param secureRandom
308,309c252,254
<    public void initSign(Key secretKey) throws XMLSignatureException {
<       this._signatureAlgorithm.engineInitSign(secretKey);
---
>    public void initSign(Key signingKey, SecureRandom secureRandom)
>            throws XMLSignatureException {
>       this._signatureAlgorithm.engineInitSign(signingKey, secureRandom);
313c258,259
<     * Method initSign
---
>     * Proxy method for {@link java.security.Signature#initSign(java.security.PrivateKey)}
>     * which is executed on the internal {@link java.security.Signature} object.
315c261
<     * @param secretKey
---
>     * @param signingKey
320c266
<            Key secretKey, AlgorithmParameterSpec algorithmParameterSpec)
---
>            Key signingKey, AlgorithmParameterSpec algorithmParameterSpec)
322c268
<       this._signatureAlgorithm.engineInitSign(secretKey,
---
>       this._signatureAlgorithm.engineInitSign(signingKey,
327c273
<     * Proxy method for {@link java.security.Signature#setParameter}
---
>     * Proxy method for {@link java.security.Signature#setParameter(java.security.spec.AlgorithmParameterSpec)}
339c285
<     * Proxy method for {@link java.security.Signature#initVerify}
---
>     * Proxy method for {@link java.security.Signature#initVerify(java.security.PublicKey)}
342c288
<     * @param publickey
---
>     * @param verificationKey
345,346c291,292
<    public void initVerify(PublicKey publickey) throws XMLSignatureException {
<       this._signatureAlgorithm.engineInitVerify(publickey);
---
>    public void initVerify(Key verificationKey) throws XMLSignatureException {
>       this._signatureAlgorithm.engineInitVerify(verificationKey);
350,365c296
<     * Method initVerify
<     *
<     * @param secretkey
<     * @throws XMLSignatureException
<     */
<    public void initVerify(Key secretkey) throws XMLSignatureException {
< 
<       if (secretkey instanceof java.security.PublicKey) {
<          this.initVerify((PublicKey) secretkey);
<       } else {
<          this._signatureAlgorithm.engineInitVerify(secretkey);
<       }
<    }
< 
<    /**
<     * Proxy method for {@link java.security.Signature#verify}
---
>     * Proxy method for {@link java.security.Signature#verify(byte[])}
369a301
>     * 
382c314,315
<       return this._constructionElement.getAttributeNS(null, Constants._ATT_ALGORITHM);
---
>       return this._constructionElement.getAttributeNS(null,
>               Constants._ATT_ALGORITHM);
386c319
<     * Initalizes for this {@link Transform}
---
>     * Initalizes for this {@link org.apache.xml.security.transforms.Transform}
391,394c324,327
<       if (SignatureAlgorithm.cat == null) {
<          SignatureAlgorithm.cat =
<             org.apache.log4j.Category
<                .getInstance(SignatureAlgorithm.class.getName());
---
>       if (SignatureAlgorithm.log == null) {
>          SignatureAlgorithm.log =
>             org.apache.commons.logging.LogFactory
>                .getLog(SignatureAlgorithm.class.getName());
397c330
<       cat.debug("Init() called");
---
>       log.debug("Init() called");
406c339
<     * Registers implementing class of the transfrom algorithm with algorithmURI
---
>     * Registers implementing class of the Transform algorithm with algorithmURI
408,409c341,342
<     * @param algorithmURI algorithmURI URI representation of <code>transfrom algorithm</code> will be specified as parameter of {@link #getInstance}, when generate. </br>
<     * @param implementingClass <code>implementingClass</code> the implementing class of {@link TransformSpi}
---
>     * @param algorithmURI algorithmURI URI representation of <code>Transform algorithm</code>.
>     * @param implementingClass <code>implementingClass</code> the implementing class of {@link SignatureAlgorithmSpi}
416c349,350
<          cat.debug("Try to register " + algorithmURI + " " + implementingClass);
---
>          if (log.isDebugEnabled())
>          	log.debug("Try to register " + algorithmURI + " " + implementingClass);
456a391,395
>    /**
>     * Method getBaseLocalName
>     *
>     * @return
>     */
diff -r xml-security-orig-v1/src/org/apache/xml/security/algorithms/SignatureAlgorithmSpi.java xml-security-1_2_0/src/org/apache/xml/security/algorithms/SignatureAlgorithmSpi.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64,66d21
< import java.security.PrivateKey;
< import java.security.PublicKey;
< import javax.crypto.SecretKey;
68a24
> 
70c26,27
< import org.w3c.dom.*;
---
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
75c32
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
79,85c36,38
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category
<          .getInstance(SignatureAlgorithmSpi.class.getName());
< 
<    /** Field _signatureAlgorithmObject */
<    private SignatureAlgorithm _signatureAlgorithmObject = null;
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(SignatureAlgorithmSpi.class.getName());
105c58
<     * @return
---
>     * @return the JCE ProviderName
110c63
<     * Proxy method for {@link java.security.Signature#update}
---
>     * Proxy method for {@link java.security.Signature#update(byte[])}
120c73
<     * Proxy method for {@link java.security.Signature#update}
---
>     * Proxy method for {@link java.security.Signature#update(byte[])}
130c83
<     * Proxy method for {@link java.security.Signature#update}
---
>     * Proxy method for {@link java.security.Signature#update(byte[], int, int)}
142c95
<     * Proxy method for {@link java.security.Signature#initSign}
---
>     * Proxy method for {@link java.security.Signature#initSign(java.security.PrivateKey)}
145,146c98
<     * @param privateKey
<     * @param secureRandom
---
>     * @param signingKey
149,151c101,102
<    protected abstract void engineInitSign(
<       PrivateKey privateKey, SecureRandom secureRandom)
<          throws XMLSignatureException;
---
>    protected abstract void engineInitSign(Key signingKey)
>       throws XMLSignatureException;
154c105
<     * Proxy method for {@link java.security.Signature#initSign}
---
>     * Proxy method for {@link java.security.Signature#initSign(java.security.PrivateKey, java.security.SecureRandom)}
157c108,109
<     * @param privateKey
---
>     * @param signingKey
>     * @param secureRandom
160,171c112,113
<    protected abstract void engineInitSign(PrivateKey privateKey)
<       throws XMLSignatureException;
< 
<    /**
<     * Proxy method for {@link javax.crypto.Mac}
<     * which is executed on the internal {@link javax.crypto.Mac#init(Key)} object.
<     *
<     * @param secretKey
<     * @throws XMLSignatureException if this method is called on a Signature
<     */
<    protected abstract void engineInitSign(Key secretKey)
<       throws XMLSignatureException;
---
>    protected abstract void engineInitSign(
>       Key signingKey, SecureRandom secureRandom) throws XMLSignatureException;
177c119
<     * @param secretKey
---
>     * @param signingKey
182c124
<       Key secretKey, AlgorithmParameterSpec algorithmParameterSpec)
---
>       Key signingKey, AlgorithmParameterSpec algorithmParameterSpec)
186c128
<     * Proxy method for {@link java.security.Signature#sign}
---
>     * Proxy method for {@link java.security.Signature#sign()}
189c131
<     * @return the result of the {@link java.security.Signature#sign} method
---
>     * @return the result of the {@link java.security.Signature#sign()} method
195,204d136
<     * Proxy method for {@link java.security.Signature#initVerify}
<     * which is executed on the internal {@link java.security.Signature} object.
<     *
<     * @param publickey
<     * @throws XMLSignatureException
<     */
<    protected abstract void engineInitVerify(PublicKey publickey)
<       throws XMLSignatureException;
< 
<    /**
207c139
<     * @param secretkey
---
>     * @param verificationKey
210c142
<    protected abstract void engineInitVerify(Key secretkey)
---
>    protected abstract void engineInitVerify(Key verificationKey)
214c146
<     * Proxy method for {@link java.security.Signature#verify}
---
>     * Proxy method for {@link java.security.Signature#verify(byte[])}
225c157
<     * Proxy method for {@link java.security.Signature#setParameter}
---
>     * Proxy method for {@link java.security.Signature#setParameter(java.security.spec.AlgorithmParameterSpec)}
253d184
<     * @throws XMLSignatureException
255,256c186
<    protected void engineGetContextFromElement(Element element)
<            throws XMLSignatureException {
---
>    protected void engineGetContextFromElement(Element element) {
264d193
<     * @throws XMLSignatureException
267c196,197
<            throws XMLSignatureException {}
---
>    {    	       
>    }
diff -r xml-security-orig-v1/src/org/apache/xml/security/c14n/CanonicalizationException.java xml-security-1_2_0/src/org/apache/xml/security/c14n/CanonicalizationException.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights 
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer. 
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:  
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written 
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European 
<  * Commission in the <WebSig> project in the ISIS Programme. 
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
85c43
<     * @param msgID
---
>     * @param _msgID
87,88c45,46
<    public CanonicalizationException(String msgID) {
<       super(msgID);
---
>    public CanonicalizationException(String _msgID) {
>       super(_msgID);
94c52
<     * @param msgID
---
>     * @param _msgID
97,98c55,56
<    public CanonicalizationException(String msgID, Object exArgs[]) {
<       super(msgID, exArgs);
---
>    public CanonicalizationException(String _msgID, Object exArgs[]) {
>       super(_msgID, exArgs);
104,105c62,63
<     * @param msgID
<     * @param originalException
---
>     * @param _msgID
>     * @param _originalException
107,108c65,66
<    public CanonicalizationException(String msgID, Exception originalException) {
<       super(msgID, originalException);
---
>    public CanonicalizationException(String _msgID, Exception _originalException) {
>       super(_msgID, _originalException);
114c72
<     * @param msgID
---
>     * @param _msgID
116c74
<     * @param originalException
---
>     * @param _originalException
118,120c76,78
<    public CanonicalizationException(String msgID, Object exArgs[],
<                                     Exception originalException) {
<       super(msgID, exArgs, originalException);
---
>    public CanonicalizationException(String _msgID, Object exArgs[],
>                                     Exception _originalException) {
>       super(_msgID, exArgs, _originalException);
diff -r xml-security-orig-v1/src/org/apache/xml/security/c14n/Canonicalizer.java xml-security-1_2_0/src/org/apache/xml/security/c14n/Canonicalizer.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64,67d21
< import org.xml.sax.InputSource;
< import org.xml.sax.SAXException;
< import javax.xml.parsers.*;
< import java.io.IOException;
69d22
< import java.util.Map;
71a25
> import java.util.Map;
73,77c27,35
< import org.w3c.dom.*;
< import org.apache.xml.security.exceptions.*;
< import org.apache.xml.security.signature.XMLSignatureInput;
< import org.apache.xml.security.utils.Constants;
< import org.apache.xml.security.utils.JavaUtils;
---
> 
> import javax.xml.parsers.DocumentBuilder;
> import javax.xml.parsers.DocumentBuilderFactory;
> 
> import org.apache.xml.security.exceptions.AlgorithmAlreadyRegisteredException;
> import org.w3c.dom.Document;
> import org.w3c.dom.Node;
> import org.w3c.dom.NodeList;
> import org.xml.sax.InputSource;
91,95c49,54
<    private static final String XPATH_NO_COMMENTS = "[not(self::comment())]";
<    public static final String XPATH_C14N_WITH_COMMENTS = "(//. | //@* | //namespace::*)";
<    public static final String XPATH_C14N_OMIT_COMMENTS = XPATH_C14N_WITH_COMMENTS + XPATH_NO_COMMENTS;
<    public static final String XPATH_C14N_WITH_COMMENTS_SINGLE_NODE = "(.//. | .//@* | .//namespace::*)";
<    public static final String XPATH_C14N_OMIT_COMMENTS_SINGLE_NODE = XPATH_C14N_WITH_COMMENTS_SINGLE_NODE + XPATH_NO_COMMENTS;
---
>    
>    /**
>      * XPath Expresion for selecting every node and continuos comments joined in only one node 
>      */
>     public static final String XPATH_C14N_WITH_COMMENTS_SINGLE_NODE = "(.//. | .//@* | .//namespace::*)";
>    
96a56,58
>    /**
>      * The URL defined in XML-SEC Rec for inclusive c14n <b>without</b> comments.
>      */
97a60,62
>    /**
>     * The URL defined in XML-SEC Rec for inclusive c14n <b>with</b> comments.
>     */
98a64,66
>    /**
>     * The URL defined in XML-SEC Rec for exclusive c14n <b>without</b> comments.
>     */
99a68,70
>    /**
>     * The URL defined in XML-SEC Rec for exclusive c14n <b>with</b> comments.
>     */
146c117
<     * @return
---
>     * @return a Conicicalizer instance ready for the job
183c154
<     * @return
---
>     * @return the URI defined for this c14n instance.
192c163
<     * @return
---
>     * @return true if the c14n respect the comments.
204c175
<     * @return
---
>     * @return the result of the conicalization.
260,261c231,233
<     * @param node
<     * @return
---
>     * @param node The node to canicalize
>     * @return the result of the c14n.
>     *
274c246
<     * @return
---
>     * @return the result of the c14n.
288c260
<     * @return
---
>     * @return the result of the c14n.
302c274
<     * @return
---
>     * @return the result of the c14n.
316c288
<     * @return
---
>     * @return the result of the c14n.
329c301
<     * @return
---
>     * @return the result of the c14n.
337a310,318
>    
>    /**
>     * Sets the writter where the cannocalization ends. ByteArrayOutputStream if 
>     * none is setted.
>     * @param os
>     */
>    public void setWriter(OutputStream os) {
>    	    this.canonicalizerSpi.setWriter(os);
>    }
350c331
<     *
---
>     * 
352c333
<     * @return
---
>     * @return the name of the class that implements the give URI
diff -r xml-security-orig-v1/src/org/apache/xml/security/c14n/CanonicalizerSpi.java xml-security-1_2_0/src/org/apache/xml/security/c14n/CanonicalizerSpi.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,65d20
< import java.io.IOException;
< import java.io.OutputStream;
< import java.io.FileOutputStream;
66a22
> import java.io.OutputStream;
68,72c24
< import java.util.Map;
< import java.util.HashMap;
< import org.w3c.dom.*;
< import org.xml.sax.InputSource;
< import javax.xml.parsers.DocumentBuilderFactory;
---
> 
74,75c26,27
< import org.apache.xml.security.exceptions.*;
< import org.apache.xml.security.utils.Constants;
---
> import javax.xml.parsers.DocumentBuilderFactory;
> 
77c29,32
< import org.apache.xml.security.utils.I18n;
---
> import org.w3c.dom.Document;
> import org.w3c.dom.Node;
> import org.w3c.dom.NodeList;
> import org.xml.sax.InputSource;
83c38
<  * @todo cange JavaDoc
---
>  * $todo$ cange JavaDoc
92a48
>     * @return the c14n bytes. 
94d49
<     * @return
151c106
<     * @return
---
>     * @return the c14n bytes
161c116,124
< 
---
>    
>    /**
>     * Method engineCanonicalizeXPathNodeSet
>     *
>     * @param xpathNodeSet
>     * @param inclusiveNamespaces
>     * @return the c14n bytes
>     * @throws CanonicalizationException
>     */
170a134,136
>    /** Returns the URI of this engine.
>     * @return the URI
>     */
172c138,141
< 
---
>    
>    /** Returns the URI if include comments
>     * @return true if include.
>     */
174c143,150
< 
---
>    
>    /**
>     * C14n a nodeset
>     *
>     * @param xpathNodeSet
>     * @return the c14n bytes
>     * @throws CanonicalizationException
>     */
177a154,161
>    /**
>     * C14n a nodeset
>     *
>     * @param xpathNodeSet
>     * @param inclusiveNamespaces
>     * @return the c14n bytes
>     * @throws CanonicalizationException
>     */
180a165,171
>    /**
>     * C14n a node tree.
>     *
>     * @param rootNode
>     * @return the c14n bytes
>     * @throws CanonicalizationException
>     */
183a175,182
>    /**
>     * C14n a node tree.
>     *
>     * @param rootNode
>     * @param inclusiveNamespaces
>     * @return the c14n bytes
>     * @throws CanonicalizationException
>     */
185a185,191
>    
>    /**
>     * Sets the writter where the cannocalization ends. ByteArrayOutputStream if 
>     * none is setted.
>     * @param os
>     */
>    public abstract void setWriter(OutputStream os);
Only in xml-security-orig-v1/src/org/apache/xml/security/c14n/helper: AlwaysAcceptNodeFilter.java
diff -r xml-security-orig-v1/src/org/apache/xml/security/c14n/helper/AttrCompare.java xml-security-1_2_0/src/org/apache/xml/security/c14n/helper/AttrCompare.java
0a1
> 
2,3c3
<  * The Apache Software License, Version 1.1
<  *
---
>  * Copyright  1999-2004 The Apache Software Foundation.
5,6c5,15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
---
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
8,57d16
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,65d21
< import org.w3c.dom.*;
< import org.apache.log4j.*;
< import org.apache.xml.security.c14n.CanonicalizationException;
66a23
> import org.w3c.dom.Attr;
82c39
<  * @todo Should we implement java.util.Comparator and import java.util.Arrays to use Arrays.sort(intarray);
---
>  * $todo$ Should we implement java.util.Comparator and import java.util.Arrays to use Arrays.sort(intarray);
86a44,47
>    private final int ATTR0_BEFORE_ATTR1 = -1;
>    private final int ATTR1_BEFORE_ATTR0 = 1;
> 
>    private final static String XMLNS=Constants.NamespaceSpecNS;
107,109d67
<       throw new RuntimeException("Not yet fully written");
< 
<       /*
112,113c70
< 
<       String namespaceURI0 = attr0.getNamespaceURI();
---
>       String namespaceURI0 = attr0.getNamespaceURI();      
114a72,91
>       
>       boolean isNamespaceAttr0 =
>       	XMLNS.equals(namespaceURI0);
>       boolean isNamespaceAttr1 =
>       	XMLNS.equals(namespaceURI1);
> 
>       if (isNamespaceAttr0) {
>          if (isNamespaceAttr1) {
> 
>             // both are namespaces
>             String localname0 = attr0.getLocalName();
>             String localname1 = attr1.getLocalName();
> 
>             if (localname0.equals("xmlns")) {
>                localname0 = "";
>             }
> 
>             if (localname1.equals("xmlns")) {
>                localname1 = "";
>             }
116,125c93
<       if ((namespaceURI0 == null) && (namespaceURI1 == null)) {
<          String localName0 = attr0.getLocalName();
<          String localName1 = attr1.getLocalName();
< 
<          return localName0.compareTo(localName1);
<       } else if ((namespaceURI0 == null) && (namespaceURI1 != null)) {
<          if (namespaceURI1.equals(Constants.NamespaceSpecNS)) {
<             return 1;
<          } else {
<             return -1;
---
>             return localname0.compareTo(localname1);
127,143c95,128
<       } else if ((namespaceURI0 != null) && (namespaceURI1 == null)) {
<          if (namespaceURI0.equals(Constants.NamespaceSpecNS)) {
<             return -1;
<          } else {
<             return 1;
<          }
<       } else {
<          int a = namespaceURI0.compareTo(namespaceURI1);
< 
<          if (a != 0) {
<             return a;
<          }
< 
<          String localName0 = attr0.getLocalName();
<          String localName1 = attr1.getLocalName();
< 
<          return localName0.compareTo(localName1);
---
>          // attr0 is a namespace, attr1 is not
>          return ATTR0_BEFORE_ATTR1;
>          
>       } 
>       if (isNamespaceAttr1) {
> 
>             // attr1 is a namespace, attr0 is not
>             return ATTR1_BEFORE_ATTR0;
>       } 
> 
>       // none is a namespae
>       
>       if (namespaceURI0 == null) {
>       	if (namespaceURI1 == null) {
>       		/*
>       		 String localName0 = attr0.getLocalName();
>       		 String localName1 = attr1.getLocalName();
>       		 return localName0.compareTo(localName1);
>       		 */
>       		
>       		String name0 = attr0.getName();
>       		String name1 = attr1.getName();
>       		return name0.compareTo(name1);
>       	}
>       	return ATTR0_BEFORE_ATTR1;
>       	
>       } 
>       if (namespaceURI1 == null) {
>       		return ATTR1_BEFORE_ATTR0;
>       } 
>       int a = namespaceURI0.compareTo(namespaceURI1);
>       		
>       if (a != 0) {
>       	return a;
145c130,135
<       */
---
>       
>       String localName0 = attr0.getLocalName();
>       String localName1 = attr1.getLocalName();
>       
>       return localName0.compareTo(localName1);
>          
146a137
>          
diff -r xml-security-orig-v1/src/org/apache/xml/security/c14n/helper/C14nHelper.java xml-security-1_2_0/src/org/apache/xml/security/c14n/helper/C14nHelper.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,67d20
< import org.w3c.dom.*;
< import java.util.Comparator;
< import java.util.Arrays;
< import org.apache.xml.utils.URI;
< import java.net.MalformedURLException;
68a22,25
> import org.w3c.dom.Attr;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.NamedNodeMap;
78,363c35,111
<    /**
<     * Constructor C14nHelper
<     *
<     */
<    private C14nHelper() {
< 
<       // don't allow instantiation
<    }
< 
<    /**
<     * Method sortAttributes
<     *
<     * @param namednodemap
<     * @return
<    public static final Attr[] sortAttributes(NamedNodeMap namednodemap) {
< 
<       if (namednodemap == null) {
<          return new Attr[0];
<       }
< 
<       Attr aattr[] = new Attr[namednodemap.getLength()];
< 
<       for (int j = 0; j < namednodemap.getLength(); j++) {
<          aattr[j] = (Attr) namednodemap.item(j);
<       }
< 
<       java.util.Arrays.sort(aattr, new AttrCompare());
< 
<       // java.util.Sort.quicksort(aattr, new AttrCompare());
<       return aattr;
<    }
<     */
< 
<    /**
<     * Method sortAttributes
<     *
<     * @param namednodemap
<     * @return
<    public static final Attr[] sortAttributes(Attr[] namednodemap) {
< 
<       if (namednodemap == null) {
<          return new Attr[0];
<       }
< 
<       java.util.Arrays.sort(namednodemap, new AttrCompare());
< 
<       // java.util.Sort.quicksort(namednodemap, new AttrCompare());
<       return namednodemap;
<    }
<     */
< 
<    /**
<     * Method sortAttributes
<     *
<     * @param namednodemap
<     * @return
<    public static final Object[] sortAttributes(Object[] namednodemap) {
< 
<       for (
< 
<       java.util.Arrays.sort(namednodemap, new AttrCompare());
< 
<       // java.util.Sort.quicksort(namednodemap, new AttrCompare());
<       return namednodemap;
<    }
<     */
< 
<    /**
<     * Normalizes an {@link Attr}ibute value
<     *
<     * The string value of the node is modified by replacing
<     * <UL>
<     * <LI>all ampersands (&) with <CODE>&amp;amp;</CODE></LI>
<     * <LI>all open angle brackets (<) with <CODE>&amp;lt;</CODE></LI>
<     * <LI>all quotation mark characters with <CODE>&amp;quot;</CODE></LI>
<     * <LI>and the whitespace characters <CODE>#x9</CODE>, #xA, and #xD, with character
<     * references. The character references are written in uppercase
<     * hexadecimal with no leading zeroes (for example, <CODE>#xD</CODE> is represented
<     * by the character reference <CODE>&amp;#xD;</CODE>)</LI>
<     * </UL>
<     *
<     * @param s
<     * @return the normalized {@link org.w3c.dom.Attr}ibute value ((({@link String})
<     */
<    public static final String normalizeAttr(String s) {
< 
<       StringBuffer stringbuffer = new StringBuffer();
<       int i = (s == null)
<               ? 0
<               : s.length();
< 
<       for (int j = 0; j < i; j++) {
<          char c = s.charAt(j);
< 
<          switch (c) {
< 
<          case '&' :
<             stringbuffer.append("&amp;");
<             break;
< 
<          case '<' :
<             stringbuffer.append("&lt;");
<             break;
< 
<          case '"' :
<             stringbuffer.append("&quot;");
<             break;
< 
<          case 0x09 :    // '\t'
<             stringbuffer.append("&#x9;");
<             break;
< 
<          case 0x0A :    // '\n'
<             stringbuffer.append("&#xA;");
<             break;
< 
<          case 0x0D :    // '\r'
<             stringbuffer.append("&#xD;");
<             break;
< 
<          default :
<             stringbuffer.append(c);
<             break;
<          }
<       }
< 
<       return stringbuffer.toString();
<    }
< 
<    /**
<     * Normalizes a {@link org.w3c.dom.Comment} value
<     *
<     * @param s
<     * @return the normalized {@link org.w3c.dom.Comment} value ((({@link String})
<     */
<    public static final String normalizeComment(String s) {
<       return normalizeProcessingInstruction(s);
<    }
< 
<    /**
<     * Normalizes a {@link org.w3c.dom.ProcessingInstruction} value
<     *
<     * @param s
<     * @return the normalized {@link org.w3c.dom.ProcessingInstruction} value ((({@link String})
<     */
<    public static final String normalizeProcessingInstruction(String s) {
< 
<       StringBuffer stringbuffer = new StringBuffer();
<       int i = (s == null)
<               ? 0
<               : s.length();
< 
<       for (int j = 0; j < i; j++) {
<          char c = s.charAt(j);
< 
<          switch (c) {
< 
<          case 0x0D :
<             stringbuffer.append("&#xD;");
<             break;
< 
<          default :
<             stringbuffer.append(c);
<             break;
<          }
<       }
< 
<       return stringbuffer.toString();
<    }
< 
<    /**
<     * Normalizes a {@link Text} value
<     *
<     * <p>Text Nodes - the string value, except all ampersands (&amp; are replaced by
<     * &amp;amp;, all open angle brackets (<) are replaced by &amp;lt;, all closing
<     * angle brackets (>) are replaced by &amp;gt;, and all #xD characters
<     * are replaced by &amp;#xD;. (See <A
<     * HREF="http://www.w3.org/TR/2001/REC-xml-c14n-20010315#ProcessingModel">
<     * processing model section in the specification</A>)</p>
<     *
<     * @param s
<     * @return the normalized {@link Text} value ((({@link String})
<     */
<    public static final String normalizeText(String s) {
< 
<       StringBuffer stringbuffer = new StringBuffer();
<       int i = (s == null)
<               ? 0
<               : s.length();
< 
<       for (int j = 0; j < i; j++) {
<          char c = s.charAt(j);
< 
<          switch (c) {
< 
<          case '&' :
<             stringbuffer.append("&amp;");
<             break;
< 
<          case '<' :
<             stringbuffer.append("&lt;");
<             break;
< 
<          case '>' :
<             stringbuffer.append("&gt;");
<             break;
< 
<          case 0xD :
<             stringbuffer.append("&#xD;");
<             break;
< 
<          default :
<             stringbuffer.append(c);
<             break;
<          }
<       }
< 
<       return stringbuffer.toString();
<    }
< 
<    /**
<     * Method namespaceIsRelative
<     *
<     * @param namespace
<     * @return
<     */
<    public static boolean namespaceIsRelative(Attr namespace) {
<       return !namespaceIsAbsolute(namespace);
<    }
< 
<    /**
<     * Method namespaceIsRelative
<     *
<     * @param namespaceValue
<     * @return
<     */
<    public static boolean namespaceIsRelative(String namespaceValue) {
<       return !namespaceIsAbsolute(namespaceValue);
<    }
< 
<    /**
<     * Method namespaceIsAbsolute
<     *
<     * @param namespace
<     * @return
<     */
<    public static boolean namespaceIsAbsolute(Attr namespace) {
<       return namespaceIsAbsolute(namespace.getValue());
<    }
< 
<    /**
<     * Method namespaceIsAbsolute
<     *
<     * @param namespaceValue
<     * @return
<     */
<    public static boolean namespaceIsAbsolute(String namespaceValue) {
< 
<       // assume empty namespaces are absolute
<       if (namespaceValue.length() == 0) {
<          return true;
<       }
< 
<       boolean foundColon = false;
<       int length = namespaceValue.length();
< 
<       for (int i = 0; i < length; i++) {
<          char c = namespaceValue.charAt(i);
< 
<          if (c == ':') {
<             foundColon = true;
<          } else if (!foundColon && (c == '/')) {
<             return false;
<          }
<       }
< 
<       return foundColon;
< 
<       /*
<       try {
<          URI uri = new URI(namespaceValue);
<          String Scheme = uri.getScheme();
<          boolean protocolOK = false;
< 
<          if (Scheme != null) {
<             protocolOK = uri.getScheme().length() > 0;
---
>     /**
>      * Constructor C14nHelper
>      *
>      */
>     private C14nHelper() {
> 
>         // don't allow instantiation
>     }
> 
>     /**
>      * Method namespaceIsRelative
>      *
>      * @param namespace
>      * @return true if the given namespace is relative.
>      */
>     public static boolean namespaceIsRelative(Attr namespace) {
>         return !namespaceIsAbsolute(namespace);
>     }
> 
>     /**
>      * Method namespaceIsRelative
>      *
>      * @param namespaceValue
>      * @return true if the given namespace is relative.
>      */
>     public static boolean namespaceIsRelative(String namespaceValue) {
>         return !namespaceIsAbsolute(namespaceValue);
>     }
> 
>     /**
>      * Method namespaceIsAbsolute
>      *
>      * @param namespace
>      * @return true if the given namespace is absolute.
>      */
>     public static boolean namespaceIsAbsolute(Attr namespace) {
>         return namespaceIsAbsolute(namespace.getValue());
>     }
> 
>     /**
>      * Method namespaceIsAbsolute
>      *
>      * @param namespaceValue
>      * @return true if the given namespace is absolute.
>      */
>     public static boolean namespaceIsAbsolute(String namespaceValue) {
> 
>         // assume empty namespaces are absolute
>         if (namespaceValue.length() == 0) {
>             return true;
>         }
>         return namespaceValue.indexOf(':')>0;
>     }
> 
>     /**
>      * This method throws an exception if the Attribute value contains
>      * a relative URI.
>      *
>      * @param attr
>      * @throws CanonicalizationException
>      */
>     public static void assertNotRelativeNS(Attr attr)
>             throws CanonicalizationException {
> 
>         if (attr == null) {
>             return;
>         }
> 
>         String nodeAttrName = attr.getNodeName();
>         boolean definesDefaultNS = nodeAttrName.equals("xmlns");
>         boolean definesNonDefaultNS = nodeAttrName.startsWith("xmlns:");
> 
>         if (definesDefaultNS || definesNonDefaultNS) {
>             if (namespaceIsRelative(attr)) {
>                 String parentName = attr.getOwnerElement().getTagName();
>                 String attrValue = attr.getValue();
>                 Object exArgs[] = { parentName, nodeAttrName, attrValue };
365,366c113,114
<             if (Scheme.equals("urn")) {
<                return true;
---
>                 throw new CanonicalizationException(
>                         "c14n.Canonicalizer.RelativeNamespace", exArgs);
368c116,117
<          }
---
>         }
>     }
370,371c119,131
<          boolean hostOK = false;
<          String Host = uri.getHost();
---
>     /**
>      * This method throws a CanonicalizationException if the supplied Document
>      * is not able to be traversed using a TreeWalker.
>      *
>      * @param document
>      * @throws CanonicalizationException
>      */
>     public static void checkTraversability(Document document)
>             throws CanonicalizationException {
> 
>         if (!document.isSupported("Traversal", "2.0")) {
>             Object exArgs[] = {
>                     document.getImplementation().getClass().getName() };
373,406c133,150
<          if (Host != null) {
<             hostOK = uri.getHost().length() > 0;
<          }
< 
<          return (protocolOK && hostOK);
<       } catch (URI.MalformedURIException ex) {
<          return false;
<       }
<       */
<    }
< 
<    /**
<     * This method throws an exception if the Attribute value contains
<     * a relative URI.
<     *
<     * @param attr
<     * @throws CanonicalizationException
<     */
<    public static void assertNotRelativeNS(Attr attr)
<            throws CanonicalizationException {
< 
<       if (attr == null) {
<          return;
<       }
< 
<       String nodeAttrName = attr.getNodeName();
<       boolean definesDefaultNS = nodeAttrName.equals("xmlns");
<       boolean definesNonDefaultNS = nodeAttrName.startsWith("xmlns:");
< 
<       if (definesDefaultNS || definesNonDefaultNS) {
<          if (namespaceIsRelative(attr)) {
<             String parentName = attr.getOwnerElement().getTagName();
<             String attrValue = attr.getValue();
<             Object exArgs[] = { parentName, nodeAttrName, attrValue };
---
>             throw new CanonicalizationException(
>                     "c14n.Canonicalizer.TraversalNotSupported", exArgs);
>         }
>     }
> 
>     /**
>      * This method throws a CanonicalizationException if the supplied Element
>      * contains any relative namespaces.
>      *
>      * @param ctxNode
>      * @throws CanonicalizationException
>      * @see C14nHelper#assertNotRelativeNS(Attr)
>      */
>     public static void checkForRelativeNamespace(Element ctxNode)
>             throws CanonicalizationException {
> 
>         if (ctxNode != null) {
>             NamedNodeMap attributes = ctxNode.getAttributes();
407a152,155
>             for (int i = 0; i < attributes.getLength(); i++) {
>                 C14nHelper.assertNotRelativeNS((Attr) attributes.item(i));
>             }
>         } else {
409,454c157,179
<                "c14n.Canonicalizer.RelativeNamespace", exArgs);
<          }
<       }
<    }
< 
<    /**
<     * This method throws a CanonicalizationException if the supplied Document
<     * is not able to be traversed using a TreeWalker.
<     *
<     * @param document
<     * @throws CanonicalizationException
<     */
<    public static void checkTraversability(Document document)
<            throws CanonicalizationException {
< 
<       if (!document.isSupported("Traversal", "2.0")) {
<          Object exArgs[] = {
<             document.getImplementation().getClass().getName() };
< 
<          throw new CanonicalizationException(
<             "c14n.Canonicalizer.TraversalNotSupported", exArgs);
<       }
<    }
< 
<    /**
<     * This method throws a CanonicalizationException if the supplied Element
<     * contains any relative namespaces.
<     *
<     * @param ctxNode
<     * @throws CanonicalizationException
<     * @see C14nHelper#assertNotRelativeNS(Attr)
<     */
<    public static void checkForRelativeNamespace(Element ctxNode)
<            throws CanonicalizationException {
< 
<       if (ctxNode != null) {
<          NamedNodeMap attributes = ctxNode.getAttributes();
< 
<          for (int i = 0; i < attributes.getLength(); i++) {
<             C14nHelper.assertNotRelativeNS((Attr) attributes.item(i));
<          }
<       } else {
<          throw new CanonicalizationException(
<             "Called checkForRelativeNamespace() on null");
<       }
<    }
---
>                     "Called checkForRelativeNamespace() on null");
>         }
>     }
> 
>     public static String normalizeAttr(String string) {
>         // TODO Auto-generated method stub
>         return null;
>     }
> 
>     public static String normalizeProcessingInstruction(String string) {
>         // TODO Auto-generated method stub
>         return null;
>     }
> 
>     public static String normalizeText(String string) {
>         // TODO Auto-generated method stub
>         return null;
>     }
> 
>     public static String normalizeComment(String string) {
>         // TODO Auto-generated method stub
>         return null;
>     }
Only in xml-security-orig-v1/src/org/apache/xml/security/c14n/helper: C14nNodeFilter.java
Only in xml-security-orig-v1/src/org/apache/xml/security/c14n/helper: NonNSAttrCompare.java
Only in xml-security-orig-v1/src/org/apache/xml/security/c14n/helper: NSAttrCompare.java
diff -r xml-security-orig-v1/src/org/apache/xml/security/c14n/helper/package.html xml-security-1_2_0/src/org/apache/xml/security/c14n/helper/package.html
2c2
< helper classes for canonicalization
---
> helper classes for canonicalization.
diff -r xml-security-orig-v1/src/org/apache/xml/security/c14n/implementations/Canonicalizer20010315Excl.java xml-security-1_2_0/src/org/apache/xml/security/c14n/implementations/Canonicalizer20010315Excl.java
0a1
> 
2,57c3,16
<  * The Apache Software License, Version 1.1
<  *
<  *
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
---
>  * Copyright 1999-2004 The Apache Software Foundation.
>  * 
>  * Licensed under the Apache License, Version 2.0 (the "License"); you may not
>  * use this file except in compliance with the License. You may obtain a copy of
>  * the License at
>  * 
>  * http://www.apache.org/licenses/LICENSE-2.0
>  * 
>  * Unless required by applicable law or agreed to in writing, software
>  * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
>  * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
>  * License for the specific language governing permissions and limitations under
>  * the License.
>  *  
60a20,23
> import java.util.Iterator;
> import java.util.Set;
> import java.util.SortedSet;
> import java.util.TreeSet;
62,75c25,26
< 
< import java.io.*;
< import java.util.*;
< import javax.xml.parsers.*;
< import javax.xml.transform.TransformerException;
< import org.apache.xml.utils.PrefixResolverDefault;
< import org.apache.xpath.NodeSet;
< import org.apache.xpath.XPath;
< import org.apache.xpath.CachedXPathAPI;
< import org.w3c.dom.*;
< import org.xml.sax.*;
< import org.apache.xml.security.c14n.*;
< import org.apache.xml.security.c14n.helper.*;
< import org.apache.xml.security.utils.*;
---
> import org.apache.xml.security.c14n.CanonicalizationException;
> import org.apache.xml.security.c14n.helper.C14nHelper;
77,78c28,32
< 
< 
---
> import org.apache.xml.security.utils.Constants;
> import org.w3c.dom.Attr;
> import org.w3c.dom.Element;
> import org.w3c.dom.NamedNodeMap;
> import org.w3c.dom.Node;
80,81c34,40
<  * Implements <A HREF="http://www.w3.org/Signature/Drafts/xml-exc-c14n">"Exclusive
<  * XML Canonicalization, Version 1.0"</A>, Rev 1.58.
---
>  * Implements &quot; <A
>  * HREF="http://www.w3.org/TR/2002/REC-xml-exc-c14n-20020718/">Exclusive XML
>  * Canonicalization, Version 1.0 </A>&quot; <BR />
>  * Credits: During restructuring of the Canonicalizer framework, Ren??
>  * Kollmorgen from Software AG submitted an implementation of ExclC14n which
>  * fitted into the old architecture and which based heavily on my old (and slow)
>  * implementation of "Canonical XML". A big "thank you" to Ren?? for this.
83,92c42,47
<  * Credits: During restructuring of the Canonicalizer framework, Ren Kollmorgen from
<  * Software AG submitted an implementation of ExclC14n which fitted into the old
<  * architecture and which based heavily on my old (and slow) implementation of
<  * "Canonical XML". A big "thank you" to Ren for this.
<  * <BR />
<  * THIS implementation is a complete rewrite of the algorithm.
<  *
<  * @author $Author: dohy $
<  * @version $Revision: 1.1.1.1 $
<  * @see <A HREF="http://www.w3.org/Signature/Drafts/xml-exc-c14n">"Exclusive XML Canonicalization, Version 1.0"</A>, Rev 1.58.
---
>  * <i>THIS </i> implementation is a complete rewrite of the algorithm.
>  * 
>  * @author Christian Geuer-Pollmann <geuerp@apache.org>
>  * @version $Revision: 1.18 $ 
>  * @see <a href="http://www.w3.org/TR/2002/REC-xml-exc-c14n-20020718/ Exclusive#">
>  *          XML Canonicalization, Version 1.0</a>
94,1124c49,306
< public abstract class Canonicalizer20010315Excl extends CanonicalizerSpi {
<    //J-
<    boolean _includeComments = false;
< 
<    Set _xpathNodeSet = null;
<    Set _inclusiveNSSet = null;
< 
<    Document _doc = null;
<    Element _documentElement = null;
<    Node _rootNodeOfC14n = null;
< 
<    Writer _writer = null;
<    //J+
< 
<    /**
<     * Constructor Canonicalizer20010315Excl
<     *
<     * @param includeComments
<     */
<    public Canonicalizer20010315Excl(boolean includeComments) {
<       this._includeComments = includeComments;
<    }
< 
<    /**
<     * Method engineCanonicalizeSubTree
<     *
<     * @param rootNode
<     * @return
<     * @throws CanonicalizationException
<     */
<    public byte[] engineCanonicalizeSubTree(Node rootNode)
<            throws CanonicalizationException {
<       return this.engineCanonicalizeSubTree(rootNode, "");
<    }
< 
<    /**
<     * Method engineCanonicalizeSubTree
<     *
<     * @param rootNode
<     * @param inclusiveNamespaces
<     * @return
<     * @throws CanonicalizationException
<     */
<    public byte[] engineCanonicalizeSubTree(
<            Node rootNode, String inclusiveNamespaces)
<               throws CanonicalizationException {
< 
<       this._rootNodeOfC14n = rootNode;
<       this._doc = XMLUtils.getOwnerDocument(this._rootNodeOfC14n);
<       this._documentElement = this._doc.getDocumentElement();
< 
<       try {
<          ByteArrayOutputStream baos = new ByteArrayOutputStream();
< 
<          this._writer = new OutputStreamWriter(baos, Canonicalizer.ENCODING);
<          this._inclusiveNSSet =
<             InclusiveNamespaces.prefixStr2Set(inclusiveNamespaces);
< 
<          Map inscopeNamespaces = this.getInscopeNamespaces(rootNode);
<          Map alreadyVisible = new HashMap();
< 
<          canonicalizeSubTree(rootNode, inscopeNamespaces, alreadyVisible);
<          this._writer.flush();
<          this._writer.close();
< 
<          return baos.toByteArray();
<       } catch (UnsupportedEncodingException ex) {
<          throw new CanonicalizationException("empty", ex);
<       } catch (IOException ex) {
<          throw new CanonicalizationException("empty", ex);
<       } finally {
<          this._xpathNodeSet = null;
<          this._inclusiveNSSet = null;
<          this._rootNodeOfC14n = null;
<          this._doc = null;
<          this._documentElement = null;
<          this._writer = null;
<       }
<    }
< 
<    /**
<     * Method canonicalizeSubTree
<     *
<     * @param currentNode
<     * @param inscopeNamespaces
<     * @param alreadyVisible
<     * @throws CanonicalizationException
<     * @throws IOException
<     */
<    void canonicalizeSubTree(
<            Node currentNode, Map inscopeNamespaces, Map alreadyVisible)
<               throws CanonicalizationException, IOException {
< 
<       int currentNodeType = currentNode.getNodeType();
< 
<       switch (currentNodeType) {
< 
<       case Node.DOCUMENT_TYPE_NODE :
<       default :
<          break;
< 
<       case Node.ENTITY_NODE :
<       case Node.NOTATION_NODE :
<       case Node.DOCUMENT_FRAGMENT_NODE :
<       case Node.ATTRIBUTE_NODE :
<          throw new CanonicalizationException("empty");
<       case Node.DOCUMENT_NODE :
<          for (Node currentChild = currentNode.getFirstChild();
<                  currentChild != null;
<                  currentChild = currentChild.getNextSibling()) {
<             canonicalizeSubTree(currentChild, inscopeNamespaces,
<                                 alreadyVisible);
<          }
<          break;
< 
<       case Node.COMMENT_NODE :
<          if (this._includeComments) {
<             int position = getPositionRelativeToDocumentElement(currentNode);
< 
<             if (position == NODE_AFTER_DOCUMENT_ELEMENT) {
<                this._writer.write("\n");
<             }
< 
<             outputCommentToWriter((Comment) currentNode);
< 
<             if (position == NODE_BEFORE_DOCUMENT_ELEMENT) {
<                this._writer.write("\n");
<             }
<          }
<          break;
< 
<       case Node.PROCESSING_INSTRUCTION_NODE :
<          int position = getPositionRelativeToDocumentElement(currentNode);
< 
<          if (position == NODE_AFTER_DOCUMENT_ELEMENT) {
<             this._writer.write("\n");
<          }
< 
<          outputPItoWriter((ProcessingInstruction) currentNode);
< 
<          if (position == NODE_BEFORE_DOCUMENT_ELEMENT) {
<             this._writer.write("\n");
<          }
<          break;
< 
<       case Node.TEXT_NODE :
<       case Node.CDATA_SECTION_NODE :
<          outputTextToWriter(currentNode.getNodeValue());
<          break;
< 
<       case Node.ELEMENT_NODE :
<          Element currentElement = (Element) currentNode;
< 
<          this._writer.write("<");
<          this._writer.write(currentElement.getTagName());
< 
<          List attrs =
<             updateInscopeNamespacesAndReturnVisibleAttrs(currentElement,
<                inscopeNamespaces, alreadyVisible);
< 
< 
<          // we output all Attrs which are available
<          for (int i = 0; i < attrs.size(); i++) {
<             outputAttrToWriter(((Attr) attrs.get(i)).getNodeName(),
<                                ((Attr) attrs.get(i)).getNodeValue());
<          }
< 
<          this._writer.write(">");
< 
<          // traversal
<          for (Node currentChild = currentNode.getFirstChild();
<                  currentChild != null;
<                  currentChild = currentChild.getNextSibling()) {
<             if (currentChild.getNodeType() == Node.ELEMENT_NODE) {
< 
<                /*
<                 * We must 'clone' the inscopeNamespaces to allow the child elements
<                 * to mess around in their own map
<                 */
<                canonicalizeSubTree(currentChild,
<                                    new HashMap(inscopeNamespaces),
<                                    new HashMap(alreadyVisible));
<             } else {
<                canonicalizeSubTree(currentChild, inscopeNamespaces,
<                                    alreadyVisible);
<             }
<          }
< 
<          this._writer.write("</");
<          this._writer.write(currentElement.getTagName());
<          this._writer.write(">");
<          break;
<       }
<    }
< 
<    /**
<     * This method updates the inscopeNamespaces based on the currentElement and
<     * returns the Attr[]s to be outputted.
<     *
<     * @param inscopeNamespaces is changed by this method !!!
<     * @param currentElement
<     * @param alreadyVisible
<     * @return the Attr[]s to be outputted
<     * @throws CanonicalizationException
<     */
<    List updateInscopeNamespacesAndReturnVisibleAttrs(
<            Element currentElement, Map inscopeNamespaces, Map alreadyVisible)
<               throws CanonicalizationException {
< 
<       Vector ns = new Vector();
<       Vector at = new Vector();
< 
<       NamedNodeMap attributes = currentElement.getAttributes();
<       int attributesLength = attributes.getLength();
< 
<       for (int i = 0; i < attributesLength; i++) {
<          Attr currentAttr = (Attr) attributes.item(i);
<          String name = currentAttr.getNodeName();
<          String value = currentAttr.getValue();
< 
<          if (name.equals("xmlns") && value.equals("")
< 
<          /* && inscopeNamespaces.containsKey(name) */
<          ) {
< 
<             // undeclare default namespace
<             inscopeNamespaces.remove("xmlns");
<          } else if (name.startsWith("xmlns") &&!value.equals("")) {
< 
<             // update inscope namespaces
<             inscopeNamespaces.put(name, value);
<          } else if (name.startsWith("xml:")) {
< 
<             // output xml:blah features
<             inscopeNamespaces.put(name, value);
<          } else {
< 
<             // output regular attributes
<             at.add(currentAttr);
<          }
<       }
< 
<       {
< 
<          // check whether default namespace must be deleted
<          if (alreadyVisible.containsKey("xmlns")
<                  &&!inscopeNamespaces.containsKey("xmlns")) {
< 
<             // undeclare default namespace
<             alreadyVisible.remove("xmlns");
< 
<             Attr a = this._doc.createAttributeNS(Constants.NamespaceSpecNS,
<                                                  "xmlns");
< 
<             a.setValue("");
<             ns.add(a);
<          }
<       }
< 
<       Iterator it = inscopeNamespaces.keySet().iterator();
< 
<       while (it.hasNext()) {
<          String name = (String) it.next();
<          String inscopeValue = (String) inscopeNamespaces.get(name);
< 
<          if (name.startsWith("xml:")
<                  &&!(alreadyVisible.containsKey(name)
<                      && alreadyVisible.get(name).equals(inscopeValue))) {
<             alreadyVisible.put(name, inscopeValue);
< 
<             Attr a =
<                this._doc.createAttributeNS(Constants.XML_LANG_SPACE_SpecNS,
<                                            name);
< 
<             a.setValue(inscopeValue);
<             at.add(a);
<          } else if (this.utilizedOrIncluded(currentElement, name)
<                     && (!alreadyVisible.containsKey(name)
<                         || (alreadyVisible.containsKey(name)
<                             &&!alreadyVisible.get(name)
<                                .equals(inscopeValue)))) {
<             if (C14nHelper.namespaceIsRelative(inscopeValue)) {
<                Object exArgs[] = { currentElement.getTagName(), name,
<                                    inscopeValue };
< 
<                throw new CanonicalizationException(
<                   "c14n.Canonicalizer.RelativeNamespace", exArgs);
<             }
< 
<             alreadyVisible.put(name, inscopeValue);
< 
<             Attr a = this._doc.createAttributeNS(Constants.NamespaceSpecNS,
<                                                  name);
< 
<             a.setValue(inscopeValue);
<             ns.add(a);
<          }
<       }
< 
<       Collections.sort(ns, new org.apache.xml.security.c14n.helper.NSAttrCompare());
<       Collections.sort(at, new org.apache.xml.security.c14n.helper.NonNSAttrCompare());
< 
<       ns.addAll(at);
< 
<       return ns;
<    }
< 
<    /**
<     * Collects all relevant xml:* and attributes from all ancestor
<     * Elements from rootNode and creates a Map containg the attribute
<     * names/values.
<     *
<     * @param apexNode
<     * @return
<     * @throws CanonicalizationException
<     */
<    Map getInscopeNamespaces(Node apexNode) throws CanonicalizationException {
< 
<       Map result = new HashMap();
< 
<       if (apexNode.getNodeType() != Node.ELEMENT_NODE) {
<          return result;
<       }
< 
<       Element apexElement = (Element) apexNode;
< 
<       for (Node parent = apexElement.getParentNode();
<               ((parent != null) && (parent.getNodeType() == Node.ELEMENT_NODE));
<               parent = parent.getParentNode()) {
<          NamedNodeMap attributes = parent.getAttributes();
<          int nrOfAttrs = attributes.getLength();
< 
<          for (int i = 0; i < nrOfAttrs; i++) {
<             Attr currentAttr = (Attr) attributes.item(i);
<             String name = currentAttr.getNodeName();
<             String value = currentAttr.getValue();
< 
<             if (name.equals("xmlns") && value.equals("")) {
<                result.remove(name);
<             } else if (name.startsWith("xmlns") &&!value.equals("")) {
<                if (!result.containsKey(name)) {
<                   result.put(name, value);
<                }
<             }
<          }
<       }
< 
<       return result;
<    }
< 
<    //J-
<    private static final int NODE_BEFORE_DOCUMENT_ELEMENT = -1;
<    private static final int NODE_NOT_BEFORE_OR_AFTER_DOCUMENT_ELEMENT = 0;
<    private static final int NODE_AFTER_DOCUMENT_ELEMENT = 1;
<    //J+
< 
<    /**
<     * Checks whether a Comment or ProcessingInstruction is before or after the
<     * document element. This is needed for prepending or appending "\n"s.
<     *
<     * @param currentNode comment or pi to check
<     * @return NODE_BEFORE_DOCUMENT_ELEMENT, NODE_NOT_BEFORE_OR_AFTER_DOCUMENT_ELEMENT or NODE_AFTER_DOCUMENT_ELEMENT
<     * @see NODE_BEFORE_DOCUMENT_ELEMENT
<     * @see NODE_NOT_BEFORE_OR_AFTER_DOCUMENT_ELEMENT
<     * @see NODE_AFTER_DOCUMENT_ELEMENT
<     */
<    static int getPositionRelativeToDocumentElement(Node currentNode) {
< 
<       if (currentNode == null) {
<          return NODE_NOT_BEFORE_OR_AFTER_DOCUMENT_ELEMENT;
<       }
< 
<       Document doc = currentNode.getOwnerDocument();
< 
<       if (currentNode.getParentNode() != doc) {
<          return NODE_NOT_BEFORE_OR_AFTER_DOCUMENT_ELEMENT;
<       }
< 
<       Element documentElement = doc.getDocumentElement();
< 
<       if (documentElement == null) {
<          return NODE_NOT_BEFORE_OR_AFTER_DOCUMENT_ELEMENT;
<       }
< 
<       if (documentElement == currentNode) {
<          return NODE_NOT_BEFORE_OR_AFTER_DOCUMENT_ELEMENT;
<       }
< 
<       for (Node x = currentNode; x != null; x = x.getNextSibling()) {
<          if (x == documentElement) {
<             return NODE_BEFORE_DOCUMENT_ELEMENT;
<          }
<       }
< 
<       return NODE_AFTER_DOCUMENT_ELEMENT;
<    }
< 
<    /**
<     * Method engineCanonicalizeXPathNodeSet
<     *
<     * @param xpathNodeSet
<     * @return
<     * @throws CanonicalizationException
<     */
<    public byte[] engineCanonicalizeXPathNodeSet(Set xpathNodeSet)
<            throws CanonicalizationException {
<       return this.engineCanonicalizeXPathNodeSet(xpathNodeSet, "");
<    }
< 
<    /**
<     * Method engineCanonicalizeXPathNodeSet
<     *
<     * @param xpathNodeSet
<     * @param inclusiveNamespaces
<     * @return
<     * @throws CanonicalizationException
<     */
<    public byte[] engineCanonicalizeXPathNodeSet(
<            Set xpathNodeSet, String inclusiveNamespaces)
<               throws CanonicalizationException {
< 
<       this._xpathNodeSet = xpathNodeSet;
< 
<       if (this._xpathNodeSet.size() == 0) {
<          return new byte[0];
<       }
< 
<       {
< 
<          // get only a single node as anchor to fetch the owner document
<          Node n = (Node) this._xpathNodeSet.iterator().next();
< 
<          this._doc = XMLUtils.getOwnerDocument(n);
<          this._documentElement = this._doc.getDocumentElement();
<       }
< 
<       try {
<          ByteArrayOutputStream baos = new ByteArrayOutputStream();
< 
<          this._writer = new OutputStreamWriter(baos, Canonicalizer.ENCODING);
<          this._inclusiveNSSet =
<             InclusiveNamespaces.prefixStr2Set(inclusiveNamespaces);
< 
<          this.canonicalizeXPathNodeSet(this._doc, true, new EC14nCtx());
< 
<          this._writer.close();
< 
<          return baos.toByteArray();
<       } catch (UnsupportedEncodingException ex) {
<          throw new CanonicalizationException("empty", ex);
<       } catch (IOException ex) {
<          throw new CanonicalizationException("empty", ex);
<       } finally {
<          this._xpathNodeSet = null;
<          this._inclusiveNSSet = null;
<          this._rootNodeOfC14n = null;
<          this._doc = null;
<          this._documentElement = null;
<          this._writer = null;
<       }
<    }
< 
<    /**
<     * Method canonicalizeXPathNodeSet
<     *
<     * @param currentNode
<     * @param parentIsVisible
<     * @param ctx
<     * @throws CanonicalizationException
<     * @throws IOException
<     */
<    void canonicalizeXPathNodeSet(
<            Node currentNode, boolean parentIsVisible, EC14nCtx ctx)
<               throws CanonicalizationException, IOException {
< 
<       int currentNodeType = currentNode.getNodeType();
<       boolean currentNodeIsVisible = this._xpathNodeSet.contains(currentNode);
< 
<       switch (currentNodeType) {
< 
<       case Node.DOCUMENT_TYPE_NODE :
<       default :
<          break;
< 
<       case Node.ENTITY_NODE :
<       case Node.NOTATION_NODE :
<       case Node.DOCUMENT_FRAGMENT_NODE :
<       case Node.ATTRIBUTE_NODE :
<          throw new CanonicalizationException("empty");
<       case Node.DOCUMENT_NODE :
<          for (Node currentChild = currentNode.getFirstChild();
<                  currentChild != null;
<                  currentChild = currentChild.getNextSibling()) {
<             canonicalizeXPathNodeSet(currentChild, true, ctx);
<          }
<          break;
< 
<       case Node.COMMENT_NODE :
<          if (this._includeComments
<                  && this._xpathNodeSet.contains(currentNode)) {
<             int position = getPositionRelativeToDocumentElement(currentNode);
< 
<             if (position == NODE_AFTER_DOCUMENT_ELEMENT) {
<                this._writer.write("\n");
<             }
< 
<             outputCommentToWriter((Comment) currentNode);
< 
<             if (position == NODE_BEFORE_DOCUMENT_ELEMENT) {
<                this._writer.write("\n");
<             }
<          }
<          break;
< 
<       case Node.PROCESSING_INSTRUCTION_NODE :
<          if (this._xpathNodeSet.contains(currentNode)) {
<             int position = getPositionRelativeToDocumentElement(currentNode);
< 
<             if (position == NODE_AFTER_DOCUMENT_ELEMENT) {
<                this._writer.write("\n");
<             }
< 
<             outputPItoWriter((ProcessingInstruction) currentNode);
< 
<             if (position == NODE_BEFORE_DOCUMENT_ELEMENT) {
<                this._writer.write("\n");
<             }
<          }
<          break;
< 
<       case Node.TEXT_NODE :
<       case Node.CDATA_SECTION_NODE :
<          if (this._xpathNodeSet.contains(currentNode)) {
<             outputTextToWriter(currentNode.getNodeValue());
< 
<             for (Node nextSibling =
<                     currentNode
<                        .getNextSibling(); (nextSibling != null) && ((nextSibling
<                           .getNodeType() == Node.TEXT_NODE) || (nextSibling
<                              .getNodeType() == Node
<                                 .CDATA_SECTION_NODE)); nextSibling =
<                                    nextSibling.getNextSibling()) {
< 
<                /* The XPath data model allows to select only the first of a
<                 * sequence of mixed text and CDATA nodes. But we must output
<                 * them all, so we must search:
<                 *
<                 * @see http://nagoya.apache.org/bugzilla/show_bug.cgi?id=6329
<                 */
<                outputTextToWriter(nextSibling.getNodeValue());
<             }
<          }
<          break;
< 
<       case Node.ELEMENT_NODE :
<          Element currentElement = (Element) currentNode;
< 
<          if (currentNodeIsVisible) {
<             this._writer.write("<");
<             this._writer.write(currentElement.getTagName());
<          }
< 
<          // we output all Attrs which are available
<          List attrs = this.getAttrs(currentElement, parentIsVisible, ctx);
<          int attrsLength = attrs.size();
< 
<          for (int i = 0; i < attrsLength; i++) {
<             Attr a = (Attr) attrs.get(i);
< 
<             outputAttrToWriter(a.getNodeName(), a.getNodeValue());
<          }
< 
<          if (currentNodeIsVisible) {
<             this._writer.write(">");
<          }
< 
<          // traversal
<          for (Node currentChild = currentNode.getFirstChild();
<                  currentChild != null;
<                  currentChild = currentChild.getNextSibling()) {
<             if (currentChild.getNodeType() == Node.ELEMENT_NODE) {
< 
<                /*
<                 * We must 'clone' the inscopeXMLAttrs to allow the descendants
<                 * to mess around in their own map
<                 */
<                canonicalizeXPathNodeSet(currentChild, currentNodeIsVisible,
<                                         ctx.copy());
<             } else {
<                canonicalizeXPathNodeSet(currentChild, currentNodeIsVisible,
<                                         ctx);
<             }
<          }
< 
<          if (currentNodeIsVisible) {
<             this._writer.write("</");
<             this._writer.write(currentElement.getTagName());
<             this._writer.write(">");
<          }
<          break;
<       }
<    }
< 
<    /**
<     * Method getAttrs
<     *
<     * @param currentElement
<     * @param parentIsVisible
<     * @param ctx
<     * @return
<     * @throws CanonicalizationException
<     */
<    List getAttrs(Element currentElement, boolean parentIsVisible, EC14nCtx ctx)
<            throws CanonicalizationException {
< 
<       Set visiblyUtilized = new HashSet();
< 
<       boolean currentElementIsInNodeset = this._xpathNodeSet.contains(currentElement);
<       if (currentElementIsInNodeset) {
<          if (currentElement.getNamespaceURI() != null) {
<             String prefix = currentElement.getPrefix();
< 
<             if (prefix == null) {
<                visiblyUtilized.add("xmlns");
<             } else {
<                visiblyUtilized.add("xmlns:" + prefix);
<             }
<          }
<       }
< 
<       Vector namespacesInSubset = new Vector();
<       Vector attributesInSubset = new Vector();
<       NamedNodeMap attributes = currentElement.getAttributes();
<       int attributesLength = attributes.getLength();
<       for (int i = 0; i < attributesLength; i++) {
<          Attr currentAttr = (Attr) attributes.item(i);
<          if (this._xpathNodeSet.contains(currentAttr)) {
<             String URI = currentAttr.getNamespaceURI();
<             if (URI != null && Constants.NamespaceSpecNS.equals(URI)) {
<                String value = currentAttr.getValue();
<                if (C14nHelper.namespaceIsRelative(value)) {
<                   Object exArgs[] = { currentElement.getTagName(), currentAttr.getNodeName(), value };
< 
<                   throw new CanonicalizationException("c14n.Canonicalizer.RelativeNamespace", exArgs);
<                }
<                namespacesInSubset.add(currentAttr);
<             } else {
<                attributesInSubset.add(currentAttr);
< 
<                String prefix = currentAttr.getPrefix();
<                if (prefix != null) {
<                   visiblyUtilized.add("xmlns:" + prefix);
<                }
<             }
<          }
<       }
<       Collections.sort(namespacesInSubset,
<                        new org.apache.xml.security.c14n.helper.NSAttrCompare());
<       Collections.sort(attributesInSubset,
<                        new org.apache.xml.security.c14n.helper.NonNSAttrCompare());
< 
<       Vector nsResult = new Vector();
<       for (int i = 0; i < namespacesInSubset.size(); i++) {
<          Attr currentAttr = (Attr) namespacesInSubset.get(i);
<          String name = currentAttr.getNodeName();
<          String value = currentAttr.getValue();
< 
<          if (name.equals("xmlns") && value.equals("")) {
<             // undeclare default namespace
<             boolean nameAlreadyVisible = ctx.n.containsKey(name);
< 
<             if (nameAlreadyVisible) {
<                ctx.n.remove(name);
<                nsResult.add(currentAttr);
<             }
<          } else {
<             //J-
<             // boolean utilizedOrIncluded = this.utilizedOrIncluded(currentElement, name);
<             boolean utilizedOrIncluded = visiblyUtilized.contains(name) || this._inclusiveNSSet.contains(name);
<             boolean nameAlreadyVisible = ctx.n.containsKey(name);
<             boolean visibleButNotEqual = nameAlreadyVisible && !ctx.n.get(name).equals(value);
<             //J+
<             if (currentElementIsInNodeset && utilizedOrIncluded && (!nameAlreadyVisible || visibleButNotEqual)) {
<                // ns_rendered_new.put(name, value);
<                ctx.n.put(name, value);
<                nsResult.add(currentAttr);
<             }
<          }
<       }
<       nsResult.addAll(attributesInSubset);
< 
<       return nsResult;
<    }
< 
<    /**
<     * Normalizes an {@link Attr}ibute value
<     *
<     * The string value of the node is modified by replacing
<     * <UL>
<     * <LI>all ampersands (&) with <CODE>&amp;amp;</CODE></LI>
<     * <LI>all open angle brackets (<) with <CODE>&amp;lt;</CODE></LI>
<     * <LI>all quotation mark characters with <CODE>&amp;quot;</CODE></LI>
<     * <LI>and the whitespace characters <CODE>#x9</CODE>, #xA, and #xD, with character
<     * references. The character references are written in uppercase
<     * hexadecimal with no leading zeroes (for example, <CODE>#xD</CODE> is represented
<     * by the character reference <CODE>&amp;#xD;</CODE>)</LI>
<     * </UL>
<     *
<     * @param name
<     * @param value
<     * @throws IOException
<     */
<    void outputAttrToWriter(String name, String value) throws IOException {
< 
<       this._writer.write(" ");
<       this._writer.write(name);
<       this._writer.write("=\"");
< 
<       int length = value.length();
< 
<       for (int i = 0; i < length; i++) {
<          char c = value.charAt(i);
< 
<          switch (c) {
< 
<          case '&' :
<             this._writer.write("&amp;");
<             break;
< 
<          case '<' :
<             this._writer.write("&lt;");
<             break;
< 
<          case '"' :
<             this._writer.write("&quot;");
<             break;
< 
<          case 0x09 :    // '\t'
<             this._writer.write("&#x9;");
<             break;
< 
<          case 0x0A :    // '\n'
<             this._writer.write("&#xA;");
<             break;
< 
<          case 0x0D :    // '\r'
<             this._writer.write("&#xD;");
<             break;
< 
<          default :
<             this._writer.write(c);
<             break;
<          }
<       }
< 
<       this._writer.write("\"");
<    }
< 
<    /**
<     * Normalizes a {@link org.w3c.dom.Comment} value
<     *
<     * @param currentPI
<     * @throws IOException
<     */
<    void outputPItoWriter(ProcessingInstruction currentPI) throws IOException {
<       if (currentPI == null) {
<         return;
<       }
< 
<       this._writer.write("<?");
< 
<       String target = currentPI.getTarget();
<       int length = target.length();
< 
<       for (int i = 0; i < length; i++) {
<          char c = target.charAt(i);
< 
<          switch (c) {
< 
<          case 0x0D :
<             this._writer.write("&#xD;");
<             break;
< 
<          default :
<             this._writer.write(c);
<             break;
<          }
<       }
< 
<       String data = currentPI.getData();
< 
<       length = data.length();
< 
<       if ((data != null) && (length > 0)) {
<          this._writer.write(" ");
< 
<          for (int i = 0; i < length; i++) {
<             char c = data.charAt(i);
< 
<             switch (c) {
< 
<             case 0x0D :
<                this._writer.write("&#xD;");
<                break;
< 
<             default :
<                this._writer.write(c);
<                break;
<             }
<          }
<       }
< 
<       this._writer.write("?>");
<    }
< 
<    /**
<     * Method outputCommentToWriter
<     *
<     * @param currentComment
<     * @throws IOException
<     */
<    void outputCommentToWriter(Comment currentComment) throws IOException {
<       if (currentComment == null) {
<         return;
<       }
< 
<       this._writer.write("<!--");
< 
<       String data = currentComment.getData();
<       int length = data.length();
< 
<       for (int i = 0; i < length; i++) {
<          char c = data.charAt(i);
< 
<          switch (c) {
< 
<          case 0x0D :
<             this._writer.write("&#xD;");
<             break;
< 
<          default :
<             this._writer.write(c);
<             break;
<          }
<       }
< 
<       this._writer.write("-->");
<    }
< 
<    /**
<     * Method outputTextToWriter
<     *
<     * @param text
<     * @throws IOException
<     */
<    void outputTextToWriter(String text) throws IOException {
<       if (text == null) {
<         return;
<       }
< 
<       int length = text.length();
< 
<       for (int i = 0; i < length; i++) {
<          char c = text.charAt(i);
< 
<          switch (c) {
< 
<          case '&' :
<             this._writer.write("&amp;");
<             break;
< 
<          case '<' :
<             this._writer.write("&lt;");
<             break;
< 
<          case '>' :
<             this._writer.write("&gt;");
<             break;
< 
<          case 0xD :
<             this._writer.write("&#xD;");
<             break;
< 
<          default :
<             this._writer.write(c);
<             break;
<          }
<       }
<    }
< 
<    /**
<     * Returns <code>true</code> is the namespace is either utilized by the
<     * given element or included by the includedNamespaces parameter.
<     *
<     * @param element
<     * @param namespace
<     * @return
<     */
<    public boolean utilizedOrIncluded(Element element, String namespace) {
< 
<       if (this._inclusiveNSSet.contains(namespace)) {
< 
<          // included;
<          return true;
<       }
< 
<       boolean utilized = this.visiblyUtilized(element).contains(namespace);
< 
<       return utilized;
<    }
< 
<    /**
<     * Method visiblyUtilized
<     *
<     * @param element
<     * @return
<     */
<    public Set visiblyUtilized(Element element) {
< 
<       Set result = new HashSet();
< 
<       if (this._xpathNodeSet == null) {
< 
<          // we are in the canonicalizeSubtree part
<          if (element.getNamespaceURI() != null) {
<             String elementPrefix = element.getPrefix();
< 
<             if (elementPrefix == null) {
<                result.add("xmlns");
<             } else {
<                result.add("xmlns:" + elementPrefix);
<             }
<          }
< 
<          NamedNodeMap attributes = element.getAttributes();
<          int attributesLength = attributes.getLength();
< 
<          // if the attribute is not xmlns:... and not xml:... but
<          // a:..., add xmlns:a to the list
<          for (int i = 0; i < attributesLength; i++) {
<             Attr currentAttr = (Attr) attributes.item(i);
< 
<             if (currentAttr.getNamespaceURI() != null) {
<                String attrPrefix = currentAttr.getPrefix();
< 
<                if ((attrPrefix != null) &&!attrPrefix.equals("xml")
<                        &&!attrPrefix.equals("xmlns")) {
<                   result.add("xmlns:" + attrPrefix);
<                }
<             }
<          }
<       } else if ((this._xpathNodeSet != null)
<                  && this._xpathNodeSet.contains(element)) {
< 
<          // we are in the canonicalizeXPathNodeSet part
<          if (element.getNamespaceURI() != null) {
<             String elementPrefix = element.getPrefix();
< 
<             if ((elementPrefix == null) || (elementPrefix.length() == 0)) {
<                result.add("xmlns");
<             } else {
<                result.add("xmlns:" + elementPrefix);
<             }
<          }
< 
<          NamedNodeMap attributes = element.getAttributes();
<          int attributesLength = attributes.getLength();
< 
<          // if the attribute is not xmlns:... and not xml:... but
<          // a:..., add xmlns:a to the list
<          for (int i = 0; i < attributesLength; i++) {
<             Attr currentAttr = (Attr) attributes.item(i);
< 
<             if (this._xpathNodeSet.contains(currentAttr)
<                     && (currentAttr.getNamespaceURI() != null)) {
<                String attrPrefix = currentAttr.getPrefix();
< 
<                if ((attrPrefix != null) &&!attrPrefix.equals("xml")
<                        &&!attrPrefix.equals("xmlns")) {
<                   result.add("xmlns:" + attrPrefix);
<                }
<             }
<          }
<       }
< 
<       return result;
<    }
< 
<    /**
<     * Class EC14nCtx
<     *
<     * @author $Author: dohy $
<     * @version $Revision: 1.1.1.1 $
<     */
<    class EC14nCtx {
< 
<       /** Field n */
<       Map n;
< 
<       /**
<        * Constructor EC14nCtx
<        *
<        */
<       public EC14nCtx() {
<          this.n = new HashMap();
<       }
< 
<       /**
<        * Constructor EC14nCtx
<        *
<        * @param n
<        */
<       public EC14nCtx(Map n) {
<          this.n = n;
<       }
< 
<       /**
<        * Method copy
<        *
<        * @return
<        */
<       public EC14nCtx copy() {
< 
<          EC14nCtx c = new EC14nCtx();
< 
<          c.n = new HashMap(this.n);
< 
<          return c;
<       }
<    }
< }
---
> public abstract class Canonicalizer20010315Excl extends CanonicalizerBase {
>     /**
>       * This Set contains the names (Strings like "xmlns" or "xmlns:foo") of
>       * the inclusive namespaces.
>       */
>     TreeSet _inclusiveNSSet = null;
>     static final String XMLNS_URI=Constants.NamespaceSpecNS;
> 	/**
> 	 * Constructor Canonicalizer20010315Excl
> 	 * 
> 	 * @param includeComments
> 	 */
> 	public Canonicalizer20010315Excl(boolean includeComments) {
> 		super(includeComments);
> 	}
> 
> 	/**
> 	 * Method engineCanonicalizeSubTree
> 	 * @inheritDoc
> 	 * @param rootNode
> 	 * 
> 	 * @throws CanonicalizationException
> 	 */
> 	public byte[] engineCanonicalizeSubTree(Node rootNode)
> 			throws CanonicalizationException {
> 		return this.engineCanonicalizeSubTree(rootNode, "",null);
> 	}
> 	/**
> 	 * Method engineCanonicalizeSubTree
> 	 *  @inheritDoc
> 	 * @param rootNode
> 	 * @param inclusiveNamespaces
> 	 * 
> 	 * @throws CanonicalizationException
> 	 */
> 	public byte[] engineCanonicalizeSubTree(Node rootNode,
> 			String inclusiveNamespaces) throws CanonicalizationException {
> 		return this.engineCanonicalizeSubTree(rootNode, inclusiveNamespaces,null);
> 	}
> 	/**
> 	 * Method engineCanonicalizeSubTree  
> 	 * @param rootNode
>      * @param inclusiveNamespaces   
>      * @param excl A element to exclude from the c14n process. 
> 	 * @return the rootNode c14n.
> 	 * @throws CanonicalizationException
> 	 */
> 	public byte[] engineCanonicalizeSubTree(Node rootNode,
> 			String inclusiveNamespaces,Node excl) throws CanonicalizationException {
> 
> 			this._inclusiveNSSet = (TreeSet)InclusiveNamespaces
> 					.prefixStr2Set(inclusiveNamespaces);			
> 			return super.engineCanonicalizeSubTree(rootNode,excl);
> 	}
>  
> 	/**
> 	 * Method handleAttributesSubtree
> 	 * @inheritDoc
> 	 * @param E
> 	 * @throws CanonicalizationException
> 	 */
> 	Iterator handleAttributesSubtree(Element E,NameSpaceSymbTable ns)
> 			throws CanonicalizationException {
> 		// System.out.println("During the traversal, I encountered " +
> 		// XMLUtils.getXPath(E));
> 		// result will contain the attrs which have to be outputted
> 		SortedSet result = new TreeSet(COMPARE);
> 		NamedNodeMap attrs=null;
>         
> 		int attrsLength = 0;
>         if (E.hasAttributes()) {
>             attrs = E.getAttributes();
>         	attrsLength = attrs.getLength();
>         }
> 		//The prefix visibly utilized(in the attribute or in the name) in the element
> 		SortedSet visiblyUtilized =(SortedSet) _inclusiveNSSet.clone();
> 					
> 		for (int i = 0; i < attrsLength; i++) {
> 			Attr N = (Attr) attrs.item(i);
> 			String NName=N.getLocalName();
> 			String NNodeValue=N.getNodeValue();
> 						
> 			if (!XMLNS_URI.equals(N.getNamespaceURI())) {
> 				//Not a namespace definition.
> 				//The Element is output element, add his prefix(if used) to visibyUtilized
> 				String prefix = N.getPrefix();
> 				if ( (prefix != null) && (!prefix.equals(XML) && !prefix.equals(XMLNS)) ) {
> 						visiblyUtilized.add(prefix);
> 				}					
> 				//Add to the result.
> 				 result.add(N);				
> 				continue;
> 			}
> 	
> 			if (ns.addMapping(NName, NNodeValue,N)) {
> 				//New definition check if it is relative.
>                 if (C14nHelper.namespaceIsRelative(NNodeValue)) {
>                     Object exArgs[] = {E.getTagName(), NName,
>                             N.getNodeValue()};
>                     throw new CanonicalizationException(
>                             "c14n.Canonicalizer.RelativeNamespace", exArgs);
>                 }
>             }
> 		}		
> 							
> 		if (E.getNamespaceURI() != null) {
> 			String prefix = E.getPrefix();
> 			if ((prefix == null) || (prefix.length() == 0)) {
> 				visiblyUtilized.add(XMLNS);
> 			} else {
> 				visiblyUtilized.add(prefix);
> 			}
> 		} else {
> 			visiblyUtilized.add(XMLNS);
> 		}
> 									
> 		//This can be optimezed by I don't have time
> 		Iterator it=visiblyUtilized.iterator();
> 		while (it.hasNext()) {
> 			String s=(String)it.next();									
> 			Attr key=ns.getMapping(s);
> 			if (key==null) {
> 				continue;
> 			}
> 			result.add(key);
> 		}
> 		
> 		return result.iterator(); 		
> 	}
> 
> 	/**
> 	 * Method engineCanonicalizeXPathNodeSet
> 	 * @inheritDoc
> 	 * @param xpathNodeSet
> 	 * @param inclusiveNamespaces
> 	 * @throws CanonicalizationException
> 	 */
> 	public byte[] engineCanonicalizeXPathNodeSet(Set xpathNodeSet,
> 			String inclusiveNamespaces) throws CanonicalizationException {
> 		
> 		try {
> 			this._inclusiveNSSet = (TreeSet)InclusiveNamespaces
> 					.prefixStr2Set(inclusiveNamespaces);
> 			return super.engineCanonicalizeXPathNodeSet(xpathNodeSet);
> 		} finally {
> 			this._inclusiveNSSet = null;
> 		}
> 	}
> 	
>     /** @inheritDoc */
>     public byte[] engineCanonicalizeXPathNodeSet(Set xpathNodeSet
>             ) throws CanonicalizationException {
>         return engineCanonicalizeXPathNodeSet(xpathNodeSet,"");
>     }
>           	
> 	/**
>      * @inheritDoc
> 	 * @param E
> 	 * @throws CanonicalizationException
> 	 */
> 	final Iterator handleAttributes(Element E, NameSpaceSymbTable ns)
> 			throws CanonicalizationException {
> 		// result will contain the attrs which have to be outputted
> 		SortedSet result = new TreeSet(COMPARE);
> 		NamedNodeMap attrs = null;
> 		int attrsLength = 0;
>         if (E.hasAttributes()) {
>             attrs = E.getAttributes();           
>         	attrsLength = attrs.getLength();
>         }
> 		//The prefix visibly utilized(in the attribute or in the name) in the element
> 		Set visiblyUtilized =null;
> 		//It's the output selected.
> 		boolean isOutputElement = this._xpathNodeSet.contains(E);			
> 		if (isOutputElement) {
> 			visiblyUtilized =  (Set) this._inclusiveNSSet.clone();
> 		}
> 		
> 		for (int i = 0; i < attrsLength; i++) {
> 			Attr N = (Attr) attrs.item(i);
> 			String NName=N.getLocalName();
> 			String NNodeValue=N.getNodeValue();
> 			if ( !this._xpathNodeSet.contains(N) )  {
> 				//The node is not in the nodeset(if there is a nodeset)
> 				continue;
> 			}			
> 						
> 			if (!XMLNS_URI.equals(N.getNamespaceURI())) {
> 				//Not a namespace definition.
> 				if (isOutputElement) {
> 					//The Element is output element, add his prefix(if used) to visibyUtilized
> 					String prefix = N.getPrefix();
> 					if ((prefix != null) && (!prefix.equals(XML) && !prefix.equals(XMLNS)) ){ 
> 							visiblyUtilized.add(prefix);
> 					}					
> 					//Add to the result.
> 				    result.add(N);
> 				}
> 				continue;
> 			}
> 						
> 			
> 			if (ns.addMapping(NName, NNodeValue,N)) {
>                 //New definiton check if it is relative
>                 if (C14nHelper.namespaceIsRelative(NNodeValue)) {
>                     Object exArgs[] = {E.getTagName(), NName,
>                             N.getNodeValue()};
>                     throw new CanonicalizationException(
>                             "c14n.Canonicalizer.RelativeNamespace", exArgs);
>                 }    
>             }
> 		}
> 
> 		if (isOutputElement) {	               
>            //The element is visible, handle the xmlns definition    
>            Attr xmlns = E.getAttributeNodeNS(XMLNS_URI, XMLNS);
>            if ((xmlns!=null) &&  (!this._xpathNodeSet.contains(xmlns))) {
>               //There is a definition but the xmlns is not selected by the xpath.
>               //then xmlns=""
>               ns.addMapping(XMLNS,"",nullNode);                               
>             }
> 
> 			if (E.getNamespaceURI() != null) {
> 				String prefix = E.getPrefix();
> 				if ((prefix == null) || (prefix.length() == 0)) {
> 					visiblyUtilized.add(XMLNS);
> 				} else {
> 					visiblyUtilized.add( prefix);
> 				}
> 			} else {
> 				visiblyUtilized.add(XMLNS);
> 			}									
> 			//This can be optimezed by I don't have time
> 			//visiblyUtilized.addAll(this._inclusiveNSSet);
> 			Iterator it=visiblyUtilized.iterator();
> 			while (it.hasNext()) {
> 				String s=(String)it.next();										
> 				Attr key=ns.getMapping(s);
> 				if (key==null) {
> 					continue;
> 				}
> 				result.add(key);
> 			}
> 		} else /*if (_circunvented)*/ {			
> 			Iterator it=this._inclusiveNSSet.iterator();
> 			while (it.hasNext()) {
> 				String s=(String)it.next();				
> 				Attr key=ns.getMappingWithoutRendered(s);
> 				if (key==null) {
> 					continue;
> 				}
> 				result.add(key);								
> 			}
> 		}
> 
> 		return result.iterator(); 
> 	}
> }
\ No newline at end of file
diff -r xml-security-orig-v1/src/org/apache/xml/security/c14n/implementations/Canonicalizer20010315ExclOmitComments.java xml-security-1_2_0/src/org/apache/xml/security/c14n/implementations/Canonicalizer20010315ExclOmitComments.java
0a1,17
> /*
>  * Copyright 1999-2004 The Apache Software Foundation.
>  *
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
>  *
>  */
> 
5c22,25
< 
---
> /**
>  *  
>  *
>  */
9,12d28
<    public Canonicalizer20010315ExclOmitComments() {
<       super(false);
<    }
< 
14,16c30
<     * Method engineGetURI
<     *
<     * @return
---
>     * 
17a32,36
> 	public Canonicalizer20010315ExclOmitComments() {
>       super(false);
>    }
>  
>    /** @inheritDoc */
22,26c41
<    /**
<     * Method engineGetIncludeComments
<     *
<     * @return
<     */
---
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/c14n/implementations/Canonicalizer20010315ExclWithComments.java xml-security-1_2_0/src/org/apache/xml/security/c14n/implementations/Canonicalizer20010315ExclWithComments.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
69,70c27
<  * @author $Author: dohy $
<  * @version $Revision: 1.1.1.1 $
---
>  * @version $Revision: 1.5 $
83,87c40
<    /**
<     * Method engineGetURI
<     *
<     * @return
<     */
---
>    /** @inheritDoc */
92,96c45
<    /**
<     * Method engineGetIncludeComments
<     *
<     * @return
<     */
---
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/c14n/implementations/Canonicalizer20010315.java xml-security-1_2_0/src/org/apache/xml/security/c14n/implementations/Canonicalizer20010315.java
0a1
> 
2,13c3
<  * The Apache Software License, Version 1.1
<  *
<  *
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
---
>  * Copyright  1999-2004 The Apache Software Foundation.
15,18c5,15
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
---
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
20,57d16
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,72c22,35
< import java.io.*;
< import java.util.*;
< import javax.xml.parsers.*;
< import javax.xml.transform.TransformerException;
< import org.apache.xpath.CachedXPathAPI;
< import org.w3c.dom.*;
< import org.xml.sax.*;
< import org.apache.xml.security.c14n.*;
< import org.apache.xml.security.c14n.helper.*;
< import org.apache.xml.security.utils.*;
---
> import java.util.HashMap;
> import java.util.Iterator;
> import java.util.Map;
> import java.util.Set;
> import java.util.SortedSet;
> import java.util.TreeSet;
> 
> import org.apache.xml.security.c14n.CanonicalizationException;
> import org.apache.xml.security.c14n.helper.C14nHelper;
> import org.apache.xml.security.utils.Constants;
> import org.w3c.dom.Attr;
> import org.w3c.dom.Element;
> import org.w3c.dom.NamedNodeMap;
> import org.w3c.dom.Node;
76c39,40
<  * Class Canonicalizer20010315
---
>  * Implements <A HREF="http://www.w3.org/TR/2001/REC-xml-c14n-20010315">Canonical
>  * XML Version 1.0</A>, a W3C Recommendation from 15 March 2001.
78,79c42,43
<  * @author $Author: dohy $
<  * @version $Revision: 1.1.1.1 $
---
>  * @author Christian Geuer-Pollmann <geuerp@apache.org>
>  * @version $Revision: 1.35 $
81,93c45,48
< public abstract class Canonicalizer20010315 extends CanonicalizerSpi {
<    //J-
<    boolean _includeComments = false;
< 
<    Set _xpathNodeSet = null;
< 
<    Document _doc = null;
<    Element _documentElement = null;
<    Node _rootNodeOfC14n = null;
< 
<    Writer _writer = null;
<    //J+
< 
---
> public abstract class Canonicalizer20010315 extends CanonicalizerBase {
> 	boolean firstCall=true;
>     static final String XMLNS_URI=Constants.NamespaceSpecNS;
>     static final String XML_LANG_URI=Constants.XML_LANG_SPACE_SpecNS;
100,263c55
<       this._includeComments = includeComments;
<    }
< 
<    /**
<     * Method engineCanonicalizeSubTree
<     *
<     * @param rootNode
<     * @return
<     * @throws CanonicalizationException
<     */
<    public byte[] engineCanonicalizeSubTree(Node rootNode)
<            throws CanonicalizationException {
< 
<       this._rootNodeOfC14n = rootNode;
<       this._doc = XMLUtils.getOwnerDocument(this._rootNodeOfC14n);
<       this._documentElement = this._doc.getDocumentElement();
< 
<       try {
<          ByteArrayOutputStream baos = new ByteArrayOutputStream();
< 
<          this._writer = new OutputStreamWriter(baos, Canonicalizer.ENCODING);
< 
<          Map inscopeNamespaces;
< 
<          if (rootNode.getNodeType() == Node.ELEMENT_NODE) {
<             inscopeNamespaces = this.getinscopeNamespaces((Element) rootNode);
<          } else {
<             inscopeNamespaces = new HashMap();
<          }
< 
<          Map alreadyVisible = new HashMap();
< 
<          this.canonicalizeSubTree(rootNode, inscopeNamespaces, alreadyVisible);
<          this._writer.close();
< 
<          return baos.toByteArray();
<       } catch (UnsupportedEncodingException ex) {
<          throw new CanonicalizationException("empty", ex);
<       } catch (IOException ex) {
<          throw new CanonicalizationException("empty", ex);
<       } finally {
< 
<          // mark contents for garbage collector
<          this._rootNodeOfC14n = null;
<          this._doc = null;
<          this._documentElement = null;
<          this._writer = null;
<       }
<    }
< 
<    /**
<     * Method canonicalizeSubTree
<     *
<     * @param currentNode
<     * @param inscopeNamespaces
<     * @param alreadyVisible
<     * @throws CanonicalizationException
<     * @throws IOException
<     */
<    void canonicalizeSubTree(
<            Node currentNode, Map inscopeNamespaces, Map alreadyVisible)
<               throws CanonicalizationException, IOException {
< 
<       int currentNodeType = currentNode.getNodeType();
< 
<       switch (currentNodeType) {
< 
<       case Node.DOCUMENT_TYPE_NODE :
<       default :
<          break;
< 
<       case Node.ENTITY_NODE :
<       case Node.NOTATION_NODE :
<       case Node.DOCUMENT_FRAGMENT_NODE :
<       case Node.ATTRIBUTE_NODE :
< 
<          // illegal node type during traversal
<          throw new CanonicalizationException("empty");
<       case Node.DOCUMENT_NODE :
<          for (Node currentChild = currentNode.getFirstChild();
<                  currentChild != null;
<                  currentChild = currentChild.getNextSibling()) {
<             canonicalizeSubTree(currentChild, inscopeNamespaces,
<                                 alreadyVisible);
<          }
<          break;
< 
<       case Node.COMMENT_NODE :
<          if (this._includeComments) {
<             int position = getPositionRelativeToDocumentElement(currentNode);
< 
<             if (position == NODE_AFTER_DOCUMENT_ELEMENT) {
<                this._writer.write("\n");
<             }
< 
<             outputCommentToWriter((Comment) currentNode);
< 
<             if (position == NODE_BEFORE_DOCUMENT_ELEMENT) {
<                this._writer.write("\n");
<             }
<          }
<          break;
< 
<       case Node.PROCESSING_INSTRUCTION_NODE :
<          int position = getPositionRelativeToDocumentElement(currentNode);
< 
<          if (position == NODE_AFTER_DOCUMENT_ELEMENT) {
<             this._writer.write("\n");
<          }
< 
<          outputPItoWriter((ProcessingInstruction) currentNode);
< 
<          if (position == NODE_BEFORE_DOCUMENT_ELEMENT) {
<             this._writer.write("\n");
<          }
<          break;
< 
<       case Node.TEXT_NODE :
<       case Node.CDATA_SECTION_NODE :
<          outputTextToWriter(currentNode.getNodeValue());
<          break;
< 
<       case Node.ELEMENT_NODE :
<          Element currentElement = (Element) currentNode;
< 
<          this._writer.write("<");
<          this._writer.write(currentElement.getTagName());
< 
<          List attrs =
<             updateinscopeNamespacesAndReturnVisibleAttrs(currentElement,
<                inscopeNamespaces, alreadyVisible);
< 
<          // we output all Attrs which are available
<          for (int i = 0; i < attrs.size(); i++) {
<             outputAttrToWriter(((Attr) attrs.get(i)).getNodeName(),
<                                ((Attr) attrs.get(i)).getNodeValue());
<          }
< 
<          this._writer.write(">");
< 
<          // traversal
<          for (Node currentChild = currentNode.getFirstChild();
<                  currentChild != null;
<                  currentChild = currentChild.getNextSibling()) {
<             if (currentChild.getNodeType() == Node.ELEMENT_NODE) {
< 
<                /*
<                 * We must 'clone' the inscopeXMLAttrs to allow the descendants
<                 * to mess around in their own map
<                 */
<                canonicalizeSubTree(currentChild,
<                                    new HashMap(inscopeNamespaces),
<                                    new HashMap(alreadyVisible));
<             } else {
<                canonicalizeSubTree(currentChild, inscopeNamespaces,
<                                    alreadyVisible);
<             }
<          }
< 
<          this._writer.write("</");
<          this._writer.write(currentElement.getTagName());
<          this._writer.write(">");
<          break;
<       }
---
>       super(includeComments);
267,268c59,65
<     * This method updates the inscopeXMLAttrs based on the currentElement and
<     * returns the Attr[]s to be outputted.
---
>     * Returns the Attr[]s to be outputted for the given element.
>     * <br>
>     * The code of this method is a copy of {@link #handleAttributes(Element,
>     * NameSpaceSymbTable)},
>     * whereas it takes into account that subtree-c14n is -- well -- subtree-based.
>     * So if the element in question isRoot of c14n, it's parent is not in the
>     * node set, as well as all other ancestors.
270,272c67,68
<     * @param inscopeXMLAttrs is changed by this method !!!
<     * @param currentElement
<     * @param alreadyVisible
---
>     * @param E
>     * @param ns
276,469c72
<    List updateinscopeNamespacesAndReturnVisibleAttrs(
<            Element currentElement, Map inscopeXMLAttrs, Map alreadyVisible)
<               throws CanonicalizationException {
< 
<       Vector ns = new Vector();
<       Vector at = new Vector();
<       NamedNodeMap attributes = currentElement.getAttributes();
<       int attributesLength = attributes.getLength();
< 
<       for (int i = 0; i < attributesLength; i++) {
<          Attr currentAttr = (Attr) attributes.item(i);
<          String name = currentAttr.getNodeName();
<          String value = currentAttr.getValue();
< 
<          if (name.equals("xmlns") && value.equals("")) {
< 
<             // undeclare default namespace
<             inscopeXMLAttrs.remove("xmlns");
<          } else if (name.startsWith("xmlns")) {
< 
<             // update inscope namespaces
<             if (!value.equals("")) {
<                inscopeXMLAttrs.put(name, value);
<             }
<          } else if (name.startsWith("xml:")) {
< 
<             // output xml:blah features
<             inscopeXMLAttrs.put(name, value);
<          } else {
< 
<             // output regular attributes
<             at.add(currentAttr);
<          }
<       }
< 
<       {
< 
<          // check whether default namespace must be deleted
<          if (alreadyVisible.containsKey("xmlns")
<                  &&!inscopeXMLAttrs.containsKey("xmlns")) {
< 
<             // undeclare default namespace
<             alreadyVisible.remove("xmlns");
< 
<             Attr a = this._doc.createAttributeNS(Constants.NamespaceSpecNS,
<                                                  "xmlns");
< 
<             a.setValue("");
<             ns.add(a);
<          }
<       }
< 
<       boolean isOrphanNode = currentElement == this._rootNodeOfC14n;
<       Iterator it = inscopeXMLAttrs.keySet().iterator();
< 
<       while (it.hasNext()) {
<          String name = (String) it.next();
<          String inscopeValue = (String) inscopeXMLAttrs.get(name);
< 
<          if (name.startsWith("xml:")
<                  && (isOrphanNode
<                      ||!(alreadyVisible.containsKey(name)
<                          && alreadyVisible.get(name).equals(inscopeValue)))) {
<             alreadyVisible.put(name, inscopeValue);
< 
<             Attr a =
<                this._doc.createAttributeNS(Constants.XML_LANG_SPACE_SpecNS,
<                                            name);
< 
<             a.setValue(inscopeValue);
<             at.add(a);
<          } else if (!alreadyVisible.containsKey(name)
<                     || (alreadyVisible.containsKey(name)
<                         &&!alreadyVisible.get(name).equals(inscopeValue))) {
<             if (C14nHelper.namespaceIsRelative(inscopeValue)) {
<                Object exArgs[] = { currentElement.getTagName(), name,
<                                    inscopeValue };
< 
<                throw new CanonicalizationException(
<                   "c14n.Canonicalizer.RelativeNamespace", exArgs);
<             }
< 
<             alreadyVisible.put(name, inscopeValue);
< 
<             Attr a = this._doc.createAttributeNS(Constants.NamespaceSpecNS,
<                                                  name);
< 
<             a.setValue(inscopeValue);
<             ns.add(a);
<          }
<       }
< 
<       Collections.sort(ns,
<                        new org.apache.xml.security.c14n.helper.NSAttrCompare());
<       Collections.sort(at,
<                        new org.apache.xml.security.c14n.helper
<                           .NonNSAttrCompare());
<       ns.addAll(at);
< 
<       return ns;
<    }
< 
<    /**
<     * Collects all relevant xml:* and xmlns:* attributes from all ancestor
<     * Elements from rootNode and creates a Map containg the attribute
<     * names/values.
<     *
<     * @param apexElement
<     * @return
<     */
<    public static Map getinscopeNamespaces(Element apexElement) {
< 
<       Map result = new HashMap();
< 
<       for (Node parent = apexElement.getParentNode();
<               ((parent != null) && (parent.getNodeType() == Node.ELEMENT_NODE));
<               parent = parent.getParentNode()) {
<          NamedNodeMap attributes = parent.getAttributes();
<          int nrOfAttrs = attributes.getLength();
< 
<          for (int i = 0; i < nrOfAttrs; i++) {
<             Attr currentAttr = (Attr) attributes.item(i);
<             String name = currentAttr.getNodeName();
<             String value = currentAttr.getValue();
< 
<             if (name.equals("xmlns") && value.equals("")) {
<                ;    // result.remove(name);
<             } else if (name.startsWith("xml:")
<                        || (name.startsWith("xmlns") &&!value.equals(""))) {
<                if (!result.containsKey(name)) {
<                   result.put(name, value);
<                }
<             }
<          }
<       }
< 
<       return result;
<    }
< 
<    //J-
<    private static final int NODE_BEFORE_DOCUMENT_ELEMENT = -1;
<    private static final int NODE_NOT_BEFORE_OR_AFTER_DOCUMENT_ELEMENT = 0;
<    private static final int NODE_AFTER_DOCUMENT_ELEMENT = 1;
<    //J+
< 
<    /**
<     * Checks whether a Comment or ProcessingInstruction is before or after the
<     * document element. This is needed for prepending or appending "\n"s.
<     *
<     * @param currentNode comment or pi to check
<     * @return NODE_BEFORE_DOCUMENT_ELEMENT, NODE_NOT_BEFORE_OR_AFTER_DOCUMENT_ELEMENT or NODE_AFTER_DOCUMENT_ELEMENT
<     * @see NODE_BEFORE_DOCUMENT_ELEMENT
<     * @see NODE_NOT_BEFORE_OR_AFTER_DOCUMENT_ELEMENT
<     * @see NODE_AFTER_DOCUMENT_ELEMENT
<     */
<    static int getPositionRelativeToDocumentElement(Node currentNode) {
< 
<       if (currentNode == null) {
<          return NODE_NOT_BEFORE_OR_AFTER_DOCUMENT_ELEMENT;
<       }
< 
<       Document doc = currentNode.getOwnerDocument();
< 
<       if (currentNode.getParentNode() != doc) {
<          return NODE_NOT_BEFORE_OR_AFTER_DOCUMENT_ELEMENT;
<       }
< 
<       Element documentElement = doc.getDocumentElement();
< 
<       if (documentElement == null) {
<          return NODE_NOT_BEFORE_OR_AFTER_DOCUMENT_ELEMENT;
<       }
< 
<       if (documentElement == currentNode) {
<          return NODE_NOT_BEFORE_OR_AFTER_DOCUMENT_ELEMENT;
<       }
< 
<       for (Node x = currentNode; x != null; x = x.getNextSibling()) {
<          if (x == documentElement) {
<             return NODE_BEFORE_DOCUMENT_ELEMENT;
<          }
<       }
< 
<       return NODE_AFTER_DOCUMENT_ELEMENT;
<    }
< 
<    /**
<     * Method engineCanonicalizeXPathNodeSet
<     *
<     * @param xpathNodeSet
<     * @return
<     * @throws CanonicalizationException
<     */
<    public byte[] engineCanonicalizeXPathNodeSet(Set xpathNodeSet)
---
>    Iterator handleAttributesSubtree(Element E,  NameSpaceSymbTable ns )
471,482c74,75
< 
<       this._xpathNodeSet = xpathNodeSet;
< 
<       if (this._xpathNodeSet.size() == 0) {
<          return new byte[0];
<       }
< 
<       if (this._doc == null) {
<          Node n = (Node) this._xpathNodeSet.iterator().next();
< 
<          this._doc = XMLUtils.getOwnerDocument(n);
<          this._documentElement = this._doc.getDocumentElement();
---
>    	  if (!E.hasAttributes() && !firstCall) {
>          return null; 
483a77,147
>       // result will contain the attrs which have to be outputted
>       SortedSet result = new TreeSet(COMPARE);      
>       NamedNodeMap attrs = E.getAttributes();
>       int attrsLength = attrs.getLength();      
>             
>       for (int i = 0; i < attrsLength; i++) {
>          Attr N = (Attr) attrs.item(i);
>          String NName=N.getLocalName();
>          String NValue=N.getValue();
>          String NUri =N.getNamespaceURI();
> 
>          if (!XMLNS_URI.equals(NUri)) {
>          	//It's not a namespace attr node. Add to the result and continue.
>             result.add(N);
>             continue;
>          }
>          
>          if (XML.equals(NName)
>                  && XML_LANG_URI.equals(NValue)) {
>          	//The default mapping for xml must not be output.
>          	continue;
>          }
>          
>          Node n=ns.addMappingAndRender(NName,NValue,N);          		 
> 		 	 
>       	  if (n!=null) {
>       	  	 //Render the ns definition
>              result.add(n);
>              if (C14nHelper.namespaceIsRelative(N)) {
>                 Object exArgs[] = { E.getTagName(), NName, N.getNodeValue() };
>                 throw new CanonicalizationException(
>                    "c14n.Canonicalizer.RelativeNamespace", exArgs);
>              }
>           }        
>       }
>             	   
>       if (firstCall) {
>       	//It is the first node of the subtree
>       	//Obtain all the namespaces defined in the parents, and added to the output.
>       	ns.getUnrenderedNodes(result);          	      		            
>       	//output the attributes in the xml namespace.
> 		addXmlAttributesSubtree(E, result);
>         firstCall=false;
>       } 
>       
>       return result.iterator();
>    }
> 
>    /**
>     * Float the xml:* attributes of the parent nodes to the root node of c14n
>     * @param E the root node.
>     * @param result the xml:* attributes  to output.
>     */
>    private void addXmlAttributesSubtree(Element E, SortedSet result) {
>          // E is in the node-set
>          Node parent = E.getParentNode();
>          Map loa = new HashMap();
> 
>          if ((parent != null) && (parent.getNodeType() == Node.ELEMENT_NODE)) {
> 
>             // parent element is not in node set
>             for (Node ancestor = parent;
>                     (ancestor != null)
>                     && (ancestor.getNodeType() == Node.ELEMENT_NODE);
>                     ancestor = ancestor.getParentNode()) {
>                Element el=((Element) ancestor);
>                if (!el.hasAttributes()) {
>                     continue;
>                }
>                // for all ancestor elements
>                NamedNodeMap ancestorAttrs = el.getAttributes();
485,635c149,168
<       try {
<          ByteArrayOutputStream baos = new ByteArrayOutputStream();
< 
<          this._writer = new OutputStreamWriter(baos, Canonicalizer.ENCODING);
< 
<          this.canonicalizeXPathNodeSet(this._doc, true,
<                                        new C14nCtx());
<          this._writer.close();
< 
<          return baos.toByteArray();
<       } catch (UnsupportedEncodingException ex) {
<          throw new CanonicalizationException("empty", ex);
<       } catch (IOException ex) {
<          throw new CanonicalizationException("empty", ex);
<       } finally {
<          this._xpathNodeSet = null;
<          this._rootNodeOfC14n = null;
<          this._doc = null;
<          this._documentElement = null;
<          this._writer = null;
<       }
<    }
< 
<    /**
<     * Method canonicalizeXPathNodeSet
<     *
<     * @param currentNode
<     * @param parentIsVisible
<     * @param ctx
<     * @throws CanonicalizationException
<     * @throws IOException
<     */
<    void canonicalizeXPathNodeSet(
<            Node currentNode, boolean parentIsVisible, C14nCtx ctx)
<               throws CanonicalizationException, IOException {
< 
<       int currentNodeType = currentNode.getNodeType();
<       boolean currentNodeIsVisible = this._xpathNodeSet.contains(currentNode);
< 
<       switch (currentNodeType) {
< 
<       case Node.DOCUMENT_TYPE_NODE :
<       default :
<          break;
< 
<       case Node.ENTITY_NODE :
<       case Node.NOTATION_NODE :
<       case Node.DOCUMENT_FRAGMENT_NODE :
<       case Node.ATTRIBUTE_NODE :
<          throw new CanonicalizationException("empty");
<       case Node.DOCUMENT_NODE :
<          for (Node currentChild = currentNode.getFirstChild();
<                  currentChild != null;
<                  currentChild = currentChild.getNextSibling()) {
<             canonicalizeXPathNodeSet(currentChild, currentNodeIsVisible, ctx);
<          }
<          break;
< 
<       case Node.COMMENT_NODE :
<          if (this._includeComments && currentNodeIsVisible) {
<             int position = getPositionRelativeToDocumentElement(currentNode);
< 
<             if (position == NODE_AFTER_DOCUMENT_ELEMENT) {
<                this._writer.write("\n");
<             }
< 
<             outputCommentToWriter((Comment) currentNode);
< 
<             if (position == NODE_BEFORE_DOCUMENT_ELEMENT) {
<                this._writer.write("\n");
<             }
<          }
<          break;
< 
<       case Node.PROCESSING_INSTRUCTION_NODE :
<          if (currentNodeIsVisible) {
<             int position = getPositionRelativeToDocumentElement(currentNode);
< 
<             if (position == NODE_AFTER_DOCUMENT_ELEMENT) {
<                this._writer.write("\n");
<             }
< 
<             outputPItoWriter((ProcessingInstruction) currentNode);
< 
<             if (position == NODE_BEFORE_DOCUMENT_ELEMENT) {
<                this._writer.write("\n");
<             }
<          }
<          break;
< 
<       case Node.TEXT_NODE :
<       case Node.CDATA_SECTION_NODE :
<          if (currentNodeIsVisible) {
<             outputTextToWriter(currentNode.getNodeValue());
< 
<             for (Node nextSibling =
<                     currentNode
<                        .getNextSibling(); (nextSibling != null) && ((nextSibling
<                           .getNodeType() == Node.TEXT_NODE) || (nextSibling
<                              .getNodeType() == Node
<                                 .CDATA_SECTION_NODE)); nextSibling =
<                                    nextSibling.getNextSibling()) {
< 
<                /* The XPath data model allows to select only the first of a
<                 * sequence of mixed text and CDATA nodes. But we must output
<                 * them all, so we must search:
<                 *
<                 * @see http://nagoya.apache.org/bugzilla/show_bug.cgi?id=6329
<                 */
<                outputTextToWriter(nextSibling.getNodeValue());
<             }
<          }
<          break;
< 
<       case Node.ELEMENT_NODE :
<          Element currentElement = (Element) currentNode;
< 
<          if (currentNodeIsVisible) {
<             this._writer.write("<");
<             this._writer.write(currentElement.getTagName());
<          }
< 
<          // we output all Attrs which are available
<          List attrs = this.getAttrs(currentElement, parentIsVisible, ctx);
<          int attrsLength = attrs.size();
< 
<          for (int i = 0; i < attrsLength; i++) {
<             Attr a = (Attr) attrs.get(i);
< 
<             outputAttrToWriter(a.getNodeName(), a.getNodeValue());
<          }
< 
<          if (currentNodeIsVisible) {
<             this._writer.write(">");
<          }
< 
<          // traversal
<          for (Node currentChild = currentNode.getFirstChild();
<                  currentChild != null;
<                  currentChild = currentChild.getNextSibling()) {
<             if (currentChild.getNodeType() == Node.ELEMENT_NODE) {
< 
<                /*
<                 * We must 'clone' the inscopeXMLAttrs to allow the descendants
<                 * to mess around in their own map
<                 */
<                canonicalizeXPathNodeSet(currentChild, currentNodeIsVisible,
<                                         ctx.copy());
<             } else {
<                canonicalizeXPathNodeSet(currentChild, currentNodeIsVisible,
<                                         ctx);
---
>                for (int i = 0; i < ancestorAttrs.getLength(); i++) {
>                   // for all attributes in the ancestor element
>                   Attr currentAncestorAttr = (Attr) ancestorAttrs.item(i);
> 
>                   if (XML_LANG_URI.equals(
>                           currentAncestorAttr.getNamespaceURI())) {
> 
>                      // do we have an xml:* ?
>                      if (!E.hasAttributeNS(
>                              XML_LANG_URI,
>                              currentAncestorAttr.getLocalName())) {
> 
>                         // the xml:* attr is not in E
>                         if (!loa.containsKey(currentAncestorAttr.getName())) {
>                            loa.put(currentAncestorAttr.getName(),
>                                    currentAncestorAttr);
>                         }
>                      }
>                   }
>                }
639,644c172,173
<          if (currentNodeIsVisible) {
<             this._writer.write("</");
<             this._writer.write(currentElement.getTagName());
<             this._writer.write(">");
<          }
<          break;
---
>          result.addAll( loa.values());
>          
646d174
<    }
649,654c177,185
<     * Method getAttrs
<     *
<     * @param currentElement
<     * @param parentIsVisible
<     * @param ctx
<     * @return
---
>     * Returns the Attr[]s to be outputted for the given element.
>     * <br>
>     * IMPORTANT: This method expects to work on a modified DOM tree, i.e. a DOM which has
>     * been prepared using {@link org.apache.xml.security.utils.XMLUtils#circumventBug2650(
>     * org.w3c.dom.Document)}.
>     * 
>     * @param E
>     * @param ns
>     * @return the Attr[]s to be outputted
657,682c188,320
<    List getAttrs(Element currentElement, boolean parentIsVisible, C14nCtx ctx)
<            throws CanonicalizationException {
< 
<       boolean currentElementIsInNodeset =
<          this._xpathNodeSet.contains(currentElement);
<       Vector namespacesInSubset = new Vector();
<       Vector attributesInSubset = new Vector();
<       Vector xmlAttributesInSubset = new Vector();
<       NamedNodeMap attributes = currentElement.getAttributes();
<       int attributesLength = attributes.getLength();
< 
<       for (int i = 0; i < attributesLength; i++) {
<          Attr currentAttr = (Attr) attributes.item(i);
<          String URI = currentAttr.getNamespaceURI();
< 
<          if (this._xpathNodeSet.contains(currentAttr)) {
<             if (URI != null) {
<                if (Constants.NamespaceSpecNS.equals(URI)) {
<                   String value = currentAttr.getValue();
< 
<                   if (C14nHelper.namespaceIsRelative(value)) {
<                      Object exArgs[] = { currentElement.getTagName(),
<                                          currentAttr.getNodeName(), value };
< 
<                      throw new CanonicalizationException(
<                         "c14n.Canonicalizer.RelativeNamespace", exArgs);
---
>    Iterator handleAttributes(Element E,  NameSpaceSymbTable ns ) throws CanonicalizationException {    
>     // result will contain the attrs which have to be outputted
>     boolean isRealVisible=this._xpathNodeSet.contains(E);    
>     NamedNodeMap attrs = null;
>     int attrsLength = 0;
>     if (E.hasAttributes()) {
>         attrs=E.getAttributes();
>        attrsLength= attrs.getLength();
>     }
>     
>     
>     SortedSet result = new TreeSet(COMPARE);
>     
>             
>     for (int i = 0; i < attrsLength; i++) {
>        Attr N = (Attr) attrs.item(i);
>        String NName=N.getLocalName();
>        String NValue=N.getValue();
>        String NUri =N.getNamespaceURI();
>        
>        if (!XMLNS_URI.equals(NUri)) {
>        	  //A non namespace definition node.
>        	  if (isRealVisible){
>        		//The node is visible add the attribute to the list of output attributes.
>            	result.add(N);
>           }
>        	  //keep working
>           continue;
>        }
> 
>               
>        if ("xml".equals(NName)
>                && XML_LANG_URI.equals(NValue)) {
>           /* except omit namespace node with local name xml, which defines
>            * the xml prefix, if its string value is http://www.w3.org/XML/1998/namespace.
>            */
>           continue;
>        }
>        //add the prefix binding to the ns symb table.
>        //ns.addInclusiveMapping(NName,NValue,N,isRealVisible);          
> 	    if  (this._xpathNodeSet.contains(N))  {
> 			    //The xpath select this node output it if needed.
> 	    		Node n=ns.addMappingAndRenderXNodeSet(NName,NValue,N,isRealVisible); 	    		
> 		 	 	if (n!=null) {
> 		 	 		result.add(n);
>                     if (C14nHelper.namespaceIsRelative(N)) {
>                        Object exArgs[] = { E.getTagName(), NName, N.getNodeValue() };
>                        throw new CanonicalizationException(
>                           "c14n.Canonicalizer.RelativeNamespace", exArgs);
>                     }
> 		 	 	}
>     	}
>     }
>     if (isRealVisible) {    	           
>     	//The element is visible, handle the xmlns definition        
>         Attr xmlns = E.getAttributeNodeNS(XMLNS_URI, XMLNS);
>         Node n=null;
>         if (xmlns == null) {
>         	//No xmlns def just get the already defined.
>         	n=ns.getMapping(XMLNS);        		
>         } else if ( !this._xpathNodeSet.contains(xmlns)) {
>         	//There is a definition but the xmlns is not selected by the xpath.
>         	//then xmlns=""
>         	n=ns.addMappingAndRenderXNodeSet(XMLNS,"",nullNode,true);        	    		      	
>         }
>         //output the xmlns def if needed.
>         if (n!=null) {
>     			result.add(n);
>     	}
>         //Float all xml:* attributes of the unselected parent elements to this one. 
>     	addXmlAttributes(E,result);
>     }
>     
>     return result.iterator();
>    }
>    /**
>     *  Float the xml:* attributes of the unselected parent nodes to the ciurrent node.
>     * @param E
>     * @param result
>     */
>    private void addXmlAttributes(Element E, SortedSet result) {
> 	/* The processing of an element node E MUST be modified slightly when an
>        * XPath node-set is given as input and the element's parent is omitted
>        * from the node-set. The method for processing the attribute axis of an
>        * element E in the node-set is enhanced. All element nodes along E's
>        * ancestor axis are examined for nearest occurrences of attributes in
>        * the xml namespace, such as xml:lang and xml:space (whether or not they
>        * are in the node-set). From this list of attributes, remove any that are
>        * in E's attribute axis (whether or not they are in the node-set). Then,
>        * lexicographically merge this attribute list with the nodes of E's
>        * attribute axis that are in the node-set. The result of visiting the
>        * attribute axis is computed by processing the attribute nodes in this
>        * merged attribute list.
>        */
>       
>          // E is in the node-set
>          Node parent = E.getParentNode();
>          Map loa = new HashMap();
> 
>          if ((parent != null) && (parent.getNodeType() == Node.ELEMENT_NODE)
>                  &&!this._xpathNodeSet.contains(parent)) {
> 
>             // parent element is not in node set
>             for (Node ancestor = parent;
>                     (ancestor != null)
>                     && (ancestor.getNodeType() == Node.ELEMENT_NODE);
>                     ancestor = ancestor.getParentNode()) {
>             	Element el=((Element) ancestor);
>                 if (!el.hasAttributes()) {
>                 	continue;
>                 }
>                // for all ancestor elements
>                NamedNodeMap ancestorAttrs =el.getAttributes();
> 
>                for (int i = 0; i < ancestorAttrs.getLength(); i++) {
> 
>                   // for all attributes in the ancestor element
>                   Attr currentAncestorAttr = (Attr) ancestorAttrs.item(i);
> 
>                   if (XML_LANG_URI.equals(
>                           currentAncestorAttr.getNamespaceURI())) {
> 
>                      // do we have an xml:* ?
>                      if (!E.hasAttributeNS(
>                              XML_LANG_URI,
>                              currentAncestorAttr.getLocalName())) {
> 
>                         // the xml:* attr is not in E
>                         if (!loa.containsKey(currentAncestorAttr.getName())) {
>                            loa.put(currentAncestorAttr.getName(),
>                                    currentAncestorAttr);
>                         }
>                      }
684,690d321
< 
<                   namespacesInSubset.add(currentAttr);
<                } else if (Constants.XML_LANG_SPACE_SpecNS.equals(URI)) {
<                   xmlAttributesInSubset.add(currentAttr);
<                   ctx.a.put(currentAttr.getNodeName(), currentAttr);
<                } else {
<                   attributesInSubset.add(currentAttr);
692,900d322
<             } else {
<                attributesInSubset.add(currentAttr);
<             }
<          } else {
<             if (URI != null && Constants.XML_LANG_SPACE_SpecNS.equals(URI)) {
<                ctx.a.put(currentAttr.getNodeName(), currentAttr);
<             }
<          }
<       }
< 
<       Collections.sort(namespacesInSubset,
<                        new org.apache.xml.security.c14n.helper.NSAttrCompare());
< 
<       // update the ctx.a with the xml:* values
<       for (int i = 0; i < xmlAttributesInSubset.size(); i++) {
<          Attr currentAttr = (Attr) xmlAttributesInSubset.get(i);
<          String name = currentAttr.getNodeName();
< 
<          ctx.a.put(name, currentAttr);
<       }
< 
<       if (currentElementIsInNodeset &&!parentIsVisible) {
<          // it's an orphan node, so we must include all xml:* attrs all the
<          // ancestor axis along
<          Iterator it = ctx.a.keySet().iterator();
< 
<          while (it.hasNext()) {
<             String name = (String) it.next();
< 
<             attributesInSubset.add(ctx.a.get(name));
<          }
<       }
<       Collections.sort(attributesInSubset,
<                        new org.apache.xml.security.c14n.helper
<                           .NonNSAttrCompare());
< 
< 
<       Vector nsResult = new Vector();
<       Map outputNamespaces = new HashMap();
< 
<       if (namespacesInSubset.size() > 0) {
<          int firstNonDefaultNS = -1;
<          Attr firstNode = (Attr) namespacesInSubset.get(0);
< 
<          if (!firstNode.getNodeName().equals("xmlns")) {
< 
<             // there is no default namespace in L
<             firstNonDefaultNS = 0;
< 
<             // if the output ancestor defines a default namespace
<             if (currentElementIsInNodeset && ctx.n.containsKey("xmlns") &&!ctx.n.get("xmlns").equals("")) {
<                Attr xmlns = this._doc.createAttributeNS(Constants.NamespaceSpecNS, "xmlns");
<                xmlns.setValue("");
<                nsResult.add(xmlns);
<             }
<          } else if (firstNode.getNodeName().equals("xmlns")
<                     && firstNode.getValue().equals("")) {
< 
<             // there is an empty default namespace in L
<             // skip
<             firstNonDefaultNS = 1;
< 
<             // if the output ancestor defines a default namespace
<             if (currentElementIsInNodeset && ctx.n.containsKey("xmlns") &&!ctx.n.get("xmlns").equals("")) {
<                nsResult.add(firstNode);
<             }
<          } else {
<             firstNonDefaultNS = 0;
<          }
< 
<          // handle non-empty namespaces
<          for (int i = firstNonDefaultNS; i < namespacesInSubset.size(); i++) {
<             Attr currentAttr = (Attr) namespacesInSubset.get(i);
<             String name = currentAttr.getNodeName();
< 
<             outputNamespaces.put(name, currentAttr);
< 
<             if (!ctx.n.containsKey(name) || !((Attr) ctx.n.get(name)).getValue().equals(currentAttr.getValue())) {
<                nsResult.add(currentAttr);
<             }
<          }
<       }
< 
<       if (currentElementIsInNodeset) {
< 
<          // if the element E is in the node set, remember the namespaces for the next one
<          ctx.n = outputNamespaces;
<       }
< 
<       // and append them to the result
<       nsResult.addAll(attributesInSubset);
< 
<       return nsResult;
<    }
< 
<    /**
<     * Normalizes an {@link Attr}ibute value
<     *
<     * The string value of the node is modified by replacing
<     * <UL>
<     * <LI>all ampersands (&) with <CODE>&amp;amp;</CODE></LI>
<     * <LI>all open angle brackets (<) with <CODE>&amp;lt;</CODE></LI>
<     * <LI>all quotation mark characters with <CODE>&amp;quot;</CODE></LI>
<     * <LI>and the whitespace characters <CODE>#x9</CODE>, #xA, and #xD, with character
<     * references. The character references are written in uppercase
<     * hexadecimal with no leading zeroes (for example, <CODE>#xD</CODE> is represented
<     * by the character reference <CODE>&amp;#xD;</CODE>)</LI>
<     * </UL>
<     *
<     * @param name
<     * @param value
<     * @throws IOException
<     */
<    void outputAttrToWriter(String name, String value) throws IOException {
< 
<       this._writer.write(" ");
<       this._writer.write(name);
<       this._writer.write("=\"");
< 
<       int length = value.length();
< 
<       for (int i = 0; i < length; i++) {
<          char c = value.charAt(i);
< 
<          switch (c) {
< 
<          case '&' :
<             this._writer.write("&amp;");
<             break;
< 
<          case '<' :
<             this._writer.write("&lt;");
<             break;
< 
<          case '"' :
<             this._writer.write("&quot;");
<             break;
< 
<          case 0x09 :    // '\t'
<             this._writer.write("&#x9;");
<             break;
< 
<          case 0x0A :    // '\n'
<             this._writer.write("&#xA;");
<             break;
< 
<          case 0x0D :    // '\r'
<             this._writer.write("&#xD;");
<             break;
< 
<          default :
<             this._writer.write(c);
<             break;
<          }
<       }
< 
<       this._writer.write("\"");
<    }
< 
<    /**
<     * Normalizes a {@link org.w3c.dom.Comment} value
<     *
<     * @param currentPI
<     * @throws IOException
<     */
<    void outputPItoWriter(ProcessingInstruction currentPI) throws IOException {
<       if (currentPI == null) {
<         return;
<       }
< 
<       this._writer.write("<?");
< 
<       String target = currentPI.getTarget();
<       int length = target.length();
< 
<       for (int i = 0; i < length; i++) {
<          char c = target.charAt(i);
< 
<          switch (c) {
< 
<          case 0x0D :
<             this._writer.write("&#xD;");
<             break;
< 
<          default :
<             this._writer.write(c);
<             break;
<          }
<       }
< 
<       String data = currentPI.getData();
< 
<       length = data.length();
< 
<       if ((data != null) && (length > 0)) {
<          this._writer.write(" ");
< 
<          for (int i = 0; i < length; i++) {
<             char c = data.charAt(i);
< 
<             switch (c) {
< 
<             case 0x0D :
<                this._writer.write("&#xD;");
<                break;
< 
<             default :
<                this._writer.write(c);
<                break;
903,981c325,327
<       }
< 
<       this._writer.write("?>");
<    }
< 
<    /**
<     * Method outputCommentToWriter
<     *
<     * @param currentComment
<     * @throws IOException
<     */
<    void outputCommentToWriter(Comment currentComment) throws IOException {
<       if (currentComment == null) {
<         return;
<       }
< 
<       this._writer.write("<!--");
< 
<       String data = currentComment.getData();
<       int length = data.length();
< 
<       for (int i = 0; i < length; i++) {
<          char c = data.charAt(i);
< 
<          switch (c) {
< 
<          case 0x0D :
<             this._writer.write("&#xD;");
<             break;
< 
<          default :
<             this._writer.write(c);
<             break;
<          }
<       }
< 
<       this._writer.write("-->");
<    }
< 
<    /**
<     * Method outputTextToWriter
<     *
<     * @param text
<     * @throws IOException
<     */
<    void outputTextToWriter(String text) throws IOException {
<       if (text == null) {
<         return;
<       }
< 
<       int length = text.length();
< 
<       for (int i = 0; i < length; i++) {
<          char c = text.charAt(i);
< 
<          switch (c) {
< 
<          case '&' :
<             this._writer.write("&amp;");
<             break;
< 
<          case '<' :
<             this._writer.write("&lt;");
<             break;
< 
<          case '>' :
<             this._writer.write("&gt;");
<             break;
< 
<          case 0xD :
<             this._writer.write("&#xD;");
<             break;
< 
<          default :
<             this._writer.write(c);
<             break;
<          }
<       }
<    }
---
>          result.addAll(loa.values());
>                
> }
984c330
<     * Method engineCanonicalizeXPathNodeSet
---
>     * Always throws a CanonicalizationException because this is inclusive c14n.
988,989c334,335
<     * @return
<     * @throws CanonicalizationException
---
>     * @return none it always fails
>     * @throws CanonicalizationException always
991,993c337,338
<    public byte[] engineCanonicalizeXPathNodeSet(
<            Set xpathNodeSet, String inclusiveNamespaces)
<               throws CanonicalizationException {
---
>    public byte[] engineCanonicalizeXPathNodeSet(Set xpathNodeSet, String inclusiveNamespaces)
>            throws CanonicalizationException {
995c340
<       /** @todo well, should we throw UnsupportedOperationException ? */
---
>       /** $todo$ well, should we throw UnsupportedOperationException ? */
1001c346
<     * Method engineCanonicalizeSubTree
---
>     * Always throws a CanonicalizationException because this is inclusive c14n.
1005c350
<     * @return
---
>     * @return none it always fails
1008,1010c353,354
<    public byte[] engineCanonicalizeSubTree(
<            Node rootNode, String inclusiveNamespaces)
<               throws CanonicalizationException {
---
>    public byte[] engineCanonicalizeSubTree(Node rootNode, String inclusiveNamespaces)
>            throws CanonicalizationException {
1012c356
<       /** @todo well, should we throw UnsupportedOperationException ? */
---
>       /** $todo$ well, should we throw UnsupportedOperationException ? */
1015,1064d358
<    }
< 
<    /**
<     * Class C14nCtx
<     *
<     * @author $Author: dohy $
<     * @version $Revision: 1.1.1.1 $
<     */
<    class C14nCtx {
< 
<       /** Field a */
<       Map a;
< 
<       /** Field n */
<       Map n;
< 
<       /**
<        * Constructor C14nCtx
<        *
<        */
<       public C14nCtx() {
<          this.a = new HashMap();
<          this.n = new HashMap();
<       }
< 
<       /**
<        * Constructor C14nCtx
<        *
<        * @param a
<        * @param n
<        */
<       public C14nCtx(Map a, Map n) {
<          this.a = a;
<          this.n = n;
<       }
< 
<       /**
<        * Method copy
<        *
<        * @return
<        */
<       public C14nCtx copy() {
< 
<          C14nCtx c = new C14nCtx();
< 
<          c.a = new HashMap(this.a);
<          c.n = new HashMap(this.n);
< 
<          return c;
<       }
diff -r xml-security-orig-v1/src/org/apache/xml/security/c14n/implementations/Canonicalizer20010315OmitComments.java xml-security-1_2_0/src/org/apache/xml/security/c14n/implementations/Canonicalizer20010315OmitComments.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
80,84c38
<    /**
<     * Method engineGetURI
<     *
<     * @return
<     */
---
>    /** @inheritDoc */
89,93c43
<    /**
<     * Method engineGetIncludeComments
<     *
<     * @return
<     */
---
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/c14n/implementations/Canonicalizer20010315WithComments.java xml-security-1_2_0/src/org/apache/xml/security/c14n/implementations/Canonicalizer20010315WithComments.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
78,82c36
<    /**
<     * Method engineGetURI
<     *
<     * @return
<     */
---
>    /** @inheritDoc */
87,91c41
<    /**
<     * Method engineGetIncludeComments
<     *
<     * @return
<     */
---
>    /** @inheritDoc */
Only in xml-security-1_2_0/src/org/apache/xml/security/c14n/implementations: CanonicalizerBase.java
Only in xml-security-1_2_0/src/org/apache/xml/security/c14n/implementations: NameSpaceSymbTable.java
diff -r xml-security-orig-v1/src/org/apache/xml/security/c14n/implementations/package.html xml-security-1_2_0/src/org/apache/xml/security/c14n/implementations/package.html
2c2
< canonicalization implementations
---
> canonicalization implementations.
diff -r xml-security-orig-v1/src/org/apache/xml/security/c14n/InvalidCanonicalizerException.java xml-security-1_2_0/src/org/apache/xml/security/c14n/InvalidCanonicalizerException.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights 
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer. 
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:  
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written 
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European 
<  * Commission in the <WebSig> project in the ISIS Programme. 
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
84c42
<     * @param msgID
---
>     * @param _msgID
86,87c44,45
<    public InvalidCanonicalizerException(String msgID) {
<       super(msgID);
---
>    public InvalidCanonicalizerException(String _msgID) {
>       super(_msgID);
93c51
<     * @param msgID
---
>     * @param _msgID
96,97c54,55
<    public InvalidCanonicalizerException(String msgID, Object exArgs[]) {
<       super(msgID, exArgs);
---
>    public InvalidCanonicalizerException(String _msgID, Object exArgs[]) {
>       super(_msgID, exArgs);
103,104c61,62
<     * @param msgID
<     * @param originalException
---
>     * @param _msgID
>     * @param _originalException
106,108c64,66
<    public InvalidCanonicalizerException(String msgID,
<                                         Exception originalException) {
<       super(msgID, originalException);
---
>    public InvalidCanonicalizerException(String _msgID,
>                                         Exception _originalException) {
>       super(_msgID, _originalException);
114c72
<     * @param msgID
---
>     * @param _msgID
116c74
<     * @param originalException
---
>     * @param _originalException
118,120c76,78
<    public InvalidCanonicalizerException(String msgID, Object exArgs[],
<                                         Exception originalException) {
<       super(msgID, exArgs, originalException);
---
>    public InvalidCanonicalizerException(String _msgID, Object exArgs[],
>                                         Exception _originalException) {
>       super(_msgID, exArgs, _originalException);
diff -r xml-security-orig-v1/src/org/apache/xml/security/c14n/package.html xml-security-1_2_0/src/org/apache/xml/security/c14n/package.html
2c2
< Canonicalization related material and algorithms  
---
> Canonicalization related material and algorithms.
Only in xml-security-1_2_0/src/org/apache/xml/security/encryption: AgreementMethod.java
Only in xml-security-orig-v1/src/org/apache/xml/security/encryption: CarriedKeyName.java
diff -r xml-security-orig-v1/src/org/apache/xml/security/encryption/CipherData.java xml-security-1_2_0/src/org/apache/xml/security/encryption/CipherData.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  2003-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
62,69d19
< 
< import org.w3c.dom.*;
< import org.apache.xml.security.exceptions.XMLSecurityException;
< import org.apache.xml.security.utils.EncryptionElementProxy;
< import org.apache.xml.security.utils.EncryptionConstants;
< import org.apache.xml.security.utils.XMLUtils;
< 
< 
71c21,36
<  * This class maps to the <CODE>xenc:CipherData</CODE> element.
---
>  * <code>CipherData</code> provides encrypted data. It must either contain the
>  * encrypted octet sequence as base64 encoded text of the
>  * <code>CipherValue</code> element, or provide a reference to an external
>  * location containing the encrypted octet sequence via the
>  * <code>CipherReference</code> element.
>  * <p>
>  * The schema definition is as follows:
>  * <xmp>
>  * <element name='CipherData' type='xenc:CipherDataType'/>
>  * <complexType name='CipherDataType'>
>  *     <choice>
>  *         <element name='CipherValue' type='base64Binary'/>
>  *         <element ref='xenc:CipherReference'/>
>  *     </choice>
>  * </complexType>
>  * </xmp>
73c38
<  * @author $Author: dohy $
---
>  * @author Axl Mattheus
75,292c40,88
< public class CipherData extends EncryptionElementProxy {
< 
<    /*
<    public CipherData(Document doc, CipherValue cipherValue) {
<       this(doc, cipherValue, 0);
<    }
<    public CipherData(Document doc, byte ciphertext[], int Nonce) {
<       this(doc, new CipherValue(doc, ciphertext), Nonce);
<    }
<    public CipherData(Document doc, CipherValue cipherValue, int Nonce) {
<       super(doc, EncryptionConstants._TAG_CIPHERDATA);
<       this._constructionElement.appendChild(this._doc.createTextNode("\n"));
<       this._constructionElement.appendChild(cipherValue.getElement());
<       this._constructionElement.appendChild(this._doc.createTextNode("\n"));
<       this.setNonce(Nonce);
<    }
<    private void setNonce(int Nonce) {
<       if (Nonce > 0) {
<          this._constructionElement.setAttributeNS(null, EncryptionConstants._ATT_NONCE, (new Integer(Nonce)).toString());
<       }
<    }
< 
<    public int getNonce() {
< 
<       String nonceStr =
<          this._constructionElement.getAttributeNS(null, EncryptionConstants._ATT_NONCE);
< 
<       if ((nonceStr != null) && (nonceStr.length() > 0)) {
<          return (new Integer(nonceStr)).intValue();
<       } else {
<          return 0;
<       }
<    }
<    */
< 
<    /**
<     * Constructor CipherData
<     *
<     * @param doc
<     */
<    public CipherData(Document doc) {
< 
<       super(doc);
< 
<       XMLUtils.addReturnToElement(this._constructionElement);
<    }
< 
<    /**
<     * Constructor CipherData
<     *
<     * @param doc
<     * @param cipherValue
<     */
<    public CipherData(Document doc, CipherValue cipherValue) {
< 
<       super(doc);
< 
<       XMLUtils.addReturnToElement(this._constructionElement);
<       this._constructionElement.appendChild(cipherValue.getElement());
<       XMLUtils.addReturnToElement(this._constructionElement);
<    }
< 
<    /**
<     * Constructor CipherData
<     *
<     * @param doc
<     * @param cipherReference
<     */
<    public CipherData(Document doc, CipherReference cipherReference) {
< 
<       super(doc);
< 
<       XMLUtils.addReturnToElement(this._constructionElement);
<       this._constructionElement.appendChild(cipherReference.getElement());
<       XMLUtils.addReturnToElement(this._constructionElement);
<    }
< 
<    /**
<     * Constructor CipherData
<     *
<     * @param doc
<     * @param ciphertext
<     * @throws XMLSecurityException
<     */
<    public CipherData(Document doc, byte ciphertext[])
<            throws XMLSecurityException {
<       this(doc, new CipherValue(doc, ciphertext));
<    }
< 
<    /**
<     * Constructor CipherData
<     *
<     * @param element
<     * @param BaseURI
<     * @throws XMLSecurityException
<     */
<    public CipherData(Element element, String BaseURI)
<            throws XMLSecurityException {
<       super(element, BaseURI);
<    }
< 
<    /**
<     * Method getCipherValue
<     *
<     * @return
<     * @throws XMLSecurityException
<     */
<    public CipherValue getCipherValue() throws XMLSecurityException {
< 
<       Element cipherValue = XMLUtils.getDirectChild(this._constructionElement,
<                                EncryptionConstants._TAG_CIPHERVALUE,
<                                EncryptionConstants.EncryptionSpecNS);
< 
<       if (cipherValue == null) {
<          return null;
<       } else {
<          return new CipherValue(cipherValue, this._baseURI);
<       }
<    }
< 
<    /**
<     * Method getCipherReference
<     *
<     * @return
<     * @throws XMLSecurityException
<     */
<    public CipherReference getCipherReference() throws XMLSecurityException {
< 
<       Element cipherReference =
<          XMLUtils.getDirectChild(this._constructionElement,
<                                  EncryptionConstants._TAG_CIPHERREFERENCE,
<                                  EncryptionConstants.EncryptionSpecNS);
< 
<       if (cipherReference == null) {
<          return null;
<       } else {
<          return new CipherReference(cipherReference, this._baseURI);
<       }
<    }
< 
<    /**
<     * Method isCipherValue
<     *
<     * @return
<     */
<    public boolean isCipherValue() {
< 
<       Element cipherValue = XMLUtils.getDirectChild(this._constructionElement,
<                                EncryptionConstants._TAG_CIPHERVALUE,
<                                EncryptionConstants.EncryptionSpecNS);
< 
<       if (cipherValue == null) {
<          return false;
<       } else {
<          return true;
<       }
<    }
< 
<    /**
<     * Method isCipherReference
<     *
<     * @return
<     */
<    public boolean isCipherReference() {
< 
<       Element cipherValue = XMLUtils.getDirectChild(this._constructionElement,
<                                EncryptionConstants._TAG_CIPHERREFERENCE,
<                                EncryptionConstants.EncryptionSpecNS);
< 
<       if (cipherValue == null) {
<          return false;
<       } else {
<          return true;
<       }
<    }
< 
<    /**
<     * Method isNotYetFilled
<     *
<     * @return
<     */
<    public boolean isNotYetFilled() {
<       return (!this.isCipherReference() &&!this.isCipherValue());
<    }
< 
<    /**
<     * Method setCipherValue
<     *
<     * @param cipherValue
<     * @throws XMLSecurityException
<     */
<    public void setCipherValue(CipherValue cipherValue)
<            throws XMLSecurityException {
< 
<       if (this.isNotYetFilled()) {
<          this._constructionElement.appendChild(cipherValue.getElement());
<          XMLUtils.addReturnToElement(this._constructionElement);
<       }
<    }
< 
<    /**
<     * Method setCipherReference
<     *
<     * @param cipherReference
<     * @throws XMLSecurityException
<     */
<    public void setCipherReference(CipherReference cipherReference)
<            throws XMLSecurityException {
< 
<       if (this.isNotYetFilled()) {
<          this._constructionElement.appendChild(cipherReference.getElement());
<          XMLUtils.addReturnToElement(this._constructionElement);
<       }
<    }
< 
<    public String getBaseLocalName() {
<       return EncryptionConstants._TAG_CIPHERDATA;
<    }
---
> public interface CipherData {
>     /** VALUE_TYPE ASN */
>     public static final int VALUE_TYPE = 0x00000001;
>     /** REFERENCE_TYPE ASN */
>     public static final int REFERENCE_TYPE = 0x00000002;
> 
>     /**
>      * Returns the type of encrypted data contained in the
>      * <code>CipherData</code>.
>      *
>      * @return <code>VALUE_TYPE</code> if the encrypted data is contained as
>      *   <code>CipherValue</code> or <code>REFERENCE_TYPE</code> if the
>      *   encrypted data is contained as <code>CipherReference</code>.
>      */
>     int getDataType();
> 
>     /**
>      * Returns the cipher value as a base64 encoded <code>byte</code> array.
>      *
>      * @return the <code>CipherData</code>'s value.
>      */
>     CipherValue getCipherValue();
> 
>     /**
>      * Sets the <code>CipherData</code>'s value.
>      *
>      * @param value the value of the <code>CipherData</code>.
>      * @throws XMLEncryptionException
>      */
>     void setCipherValue(CipherValue value) throws XMLEncryptionException;
> 
>     /**
>      * Returns a reference to an external location containing the encrypted
>      * octet sequence (<code>byte</code> array).
>      *
>      * @return the reference to an external location containing the enctrypted
>      *   octet sequence.
>      */
>     CipherReference getCipherReference();
> 
>     /**
>      * Sets the <code>CipherData</code>'s reference.
>      *
>      * @param reference an external location containing the enctrypted octet
>      *   sequence.
>      * @throws XMLEncryptionException
>      */
>     void setCipherReference(CipherReference reference) throws
>         XMLEncryptionException;
293a90
> 
diff -r xml-security-orig-v1/src/org/apache/xml/security/encryption/CipherReference.java xml-security-1_2_0/src/org/apache/xml/security/encryption/CipherReference.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  2003-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
61,67c19
< 
< 
< import org.w3c.dom.*;
< import org.apache.xml.security.exceptions.XMLSecurityException;
< import org.apache.xml.security.utils.EncryptionElementProxy;
< import org.apache.xml.security.utils.EncryptionConstants;
< import org.apache.xml.security.utils.XMLUtils;
---
> import org.w3c.dom.Attr;
71c23,53
<  * This class maps to the <CODE>xenc:CipherReference</CODE> element.
---
>  * <code>CipherReference</code> identifies a source which, when processed,
>  * yields the encrypted octet sequence.
>  * <p>
>  * The actual value is obtained as follows. The <code>CipherReference URI</code>
>  * contains an identifier that is dereferenced. Should the
>  * <code>CipherReference</code> element contain an OPTIONAL sequence of
>  * Transforms, the data resulting from dereferencing the <code>URI</code> is
>  * transformed as specified so as to yield the intended cipher value. For
>  * example, if the value is base64 encoded within an XML document; the
>  * transforms could specify an XPath expression followed by a base64 decoding so
>  * as to extract the octets.
>  * <p>
>  * The syntax of the <code>URI</code> and Transforms is similar to that of
>  * [XML-DSIG]. However, there is a difference between signature and encryption
>  * processing. In [XML-DSIG] both generation and validation processing start
>  * with the same source data and perform that transform in the same order. In
>  * encryption, the decryptor has only the cipher data and the specified
>  * transforms are enumerated for the decryptor, in the order necessary to obtain
>  * the octets. Consequently, because it has different semantics Transforms is in
>  * the &xenc; namespace.
>  * <p>
>  * The schema definition is as follows:
>  * <xmp>
>  * <element name='CipherReference' type='xenc:CipherReferenceType'/>
>  * <complexType name='CipherReferenceType'>
>  *     <sequence>
>  *         <element name='Transforms' type='xenc:TransformsType' minOccurs='0'/>
>  *     </sequence>
>  *     <attribute name='URI' type='anyURI' use='required'/>
>  * </complexType>
>  * </xmp>
73c55
<  * @author $Author: dohy $
---
>  * @author Axl Mattheus
75,153c57,88
< public class CipherReference extends EncryptionElementProxy {
< 
<    /** Field _transforms           */
<    private Transforms _transforms = null;
< 
<    /**
<     * Constructor CipherReference
<     *
<     * @param doc
<     * @param URI
<     */
<    public CipherReference(Document doc, String URI) {
< 
<       super(doc);
< 
<       this._constructionElement.setAttributeNS(null, EncryptionConstants._ATT_URI, URI);
<    }
< 
<    /**
<     * Constructor CipherReference
<     *
<     * @param doc
<     * @param URI
<     * @param transforms
<     */
<    public CipherReference(Document doc, String URI, Transforms transforms) {
< 
<       super(doc);
< 
<       this._constructionElement.setAttributeNS(null, EncryptionConstants._ATT_URI, URI);
<       XMLUtils.addReturnToElement(this._constructionElement);
<       this._constructionElement.appendChild(transforms.getElement());
<       XMLUtils.addReturnToElement(this._constructionElement);
< 
<       this._transforms = transforms;
<    }
< 
<    /**
<     * Constructor CipherReference
<     *
<     * @param element
<     * @param BaseURI
<     * @throws XMLSecurityException
<     */
<    public CipherReference(Element element, String BaseURI)
<            throws XMLSecurityException {
<       super(element, BaseURI);
<    }
< 
<    /**
<     * Method getURI
<     *
<     * @return
<     */
<    public String getURI() {
<       return this._constructionElement
<          .getAttributeNS(null, EncryptionConstants._ATT_URI);
<    }
< 
<    /**
<     * Method getTransforms
<     *
<     * @return
<     */
<    public Transforms getTransforms() {
< 
<       if (this._state == EncryptionElementProxy.MODE_CREATE) {
<          return this._transforms;
<       } else {
< 
<          // search for xenc:Transforms and create
<          // return new Transforms(el, this._baseURI);
<          return null;
<       }
<    }
< 
<    public String getBaseLocalName() {
<       return EncryptionConstants._TAG_CIPHERREFERENCE;
<    }
---
> public interface CipherReference {
>     /**
>      * Returns an <code>URI</code> that contains an identifier that should be
>      * dereferenced.
>      * @return
>      */
>     String getURI();
> 
> 	/**
> 	 * Gets the URI as an Attribute node.  Used to meld the CipherREference
> 	 * with the XMLSignature ResourceResolvers
>      * @return
> 	 */
> 	public Attr getURIAsAttr();
> 
>     /**
>      * Returns the <code>Transforms</code> that specifies how to transform the
>      * <code>URI</code> to yield the appropiate cipher value.
>      *
>      * @return the transform that specifies how to transform the reference to
>      *   yield the intended cipher value.
>      */
>     Transforms getTransforms();
> 
>     /**
>      * Sets the <code>Transforms</code> that specifies how to transform the
>      * <code>URI</code> to yield the appropiate cipher value.
>      *
>      * @param transforms the set of <code>Transforms</code> that specifies how
>      *   to transform the reference to yield the intended cipher value.
>      */
>     void setTransforms(Transforms transforms);
154a90
> 
diff -r xml-security-orig-v1/src/org/apache/xml/security/encryption/CipherValue.java xml-security-1_2_0/src/org/apache/xml/security/encryption/CipherValue.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  2003-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
62,69d19
< 
< import org.w3c.dom.*;
< import org.apache.xml.security.exceptions.XMLSecurityException;
< import org.apache.xml.security.utils.EncryptionElementProxy;
< import org.apache.xml.security.utils.EncryptionConstants;
< import org.apache.xml.security.utils.Base64;
< 
< 
71c21
<  * This class maps to the <CODE>xenc:CipherValue</CODE> element.
---
>  * <code>CipherValue</code> is the wrapper for cipher text.
73c23
<  * @author $Author: dohy $
---
>  * @author Axl Mattheus
75,145c25,42
< public class CipherValue extends EncryptionElementProxy {
< 
<    /**
<     * Constructor CipherValue
<     *
<     * @param doc
<     * @param ciphertext
<     * @throws XMLSecurityException
<     */
<    public CipherValue(Document doc, byte ciphertext[])
<            throws XMLSecurityException {
< 
<       super(doc);
< 
<       this.setCipherText(ciphertext);
<    }
< 
<    /**
<     * Constructor CipherValue
<     *
<     * @param element
<     * @param BaseURI
<     * @throws XMLSecurityException
<     */
<    public CipherValue(Element element, String BaseURI)
<            throws XMLSecurityException {
<       super(element, BaseURI);
<    }
< 
<    /**
<     * Method getCipherText
<     *
<     * @return
<     * @throws XMLSecurityException
<     */
<    public byte[] getCipherText() throws XMLSecurityException {
< 
<       NodeList nl = this._constructionElement.getChildNodes();
< 
<       if ((nl.getLength() != 1)
<               || (nl.item(0).getNodeType() != Node.TEXT_NODE)) {
<          throw new XMLSecurityException(
<             "encryption.structure.CipherTextMustContainText");
<       }
< 
<       Text t = (Text) nl.item(0);
< 
<       return Base64.decode(t.getData());
<    }
< 
<    /**
<     * Method setCipherText
<     *
<     * @param ciphertext
<     * @throws XMLSecurityException
<     */
<    public void setCipherText(byte ciphertext[]) throws XMLSecurityException {
< 
<       while (this._constructionElement.hasChildNodes()) {
<          this._constructionElement
<             .removeChild(this._constructionElement.getLastChild());
<       }
< 
<       Text textNode = this._doc.createTextNode(Base64.encode(ciphertext));
< 
<       this._constructionElement.appendChild(textNode);
<    }
< 
<    public String getBaseLocalName() {
<       return EncryptionConstants._TAG_CIPHERVALUE;
<    }
---
> public interface CipherValue {
>     /**
>      * Resturns the Base 64 encoded, encrypted octets that is the
>      * <code>CihperValue</code>.
>      *
>      * @return cipher value.
>      */
> 	String getValue();
> 	// byte[] getValue();
>     
>     /**
>      * Sets the Base 64 encoded, encrypted octets that is the
>      * <code>CihperValue</code>.
>      *
>      * @param value the cipher value.
>      */
> 	void setValue(String value);
> 	// void setValue(byte[] value);
Only in xml-security-orig-v1/src/org/apache/xml/security/encryption: DataReference.java
diff -r xml-security-orig-v1/src/org/apache/xml/security/encryption/EncryptedData.java xml-security-1_2_0/src/org/apache/xml/security/encryption/EncryptedData.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  2003-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
62,75d19
< 
< import java.io.*;
< import java.security.Key;
< import org.apache.xml.security.algorithms.encryption.EncryptionMethod;
< import org.apache.xml.security.algorithms.encryption.params
<    .EncryptionMethodParams;
< import org.apache.xml.security.c14n.*;
< import org.apache.xml.security.encryption.type.EncryptedType;
< import org.apache.xml.security.exceptions.XMLSecurityException;
< import org.apache.xml.security.keys.KeyInfo;
< import org.apache.xml.security.utils.*;
< import org.w3c.dom.*;
< 
< 
77c21,35
<  * This class maps to the <CODE>xenc:EncryptedData</CODE> element.
---
>  * The <code>EncryptedData</code> element is the core element in the syntax. Not
>  * only does its <code>CipherData</code> child contain the encrypted data, but
>  * it's also the element that replaces the encrypted element, or serves as the
>  * new document root.
>  * <p>
>  * It's schema definition is as follows:
>  * <p>
>  * <xmp>
>  * <element name='EncryptedData' type='xenc:EncryptedDataType'/>
>  * <complexType name='EncryptedDataType'>
>  *     <complexContent>
>  *         <extension base='xenc:EncryptedType'/>
>  *     </complexContent>
>  * </complexType>
>  * </xmp>
79c37
<  * @author $Author: dohy $
---
>  * @author Axl Mattheus
81,495c39
< public class EncryptedData extends EncryptionElementProxy
<         implements EncryptedType {
< 
<    /**
<     * Constructor EncryptedData
<     *
<     * @param doc
<     * @param encryptionMethod
<     * @param keyInfo
<     * @param cipherData
<     * @param encryptionProperties
<     * @param Id
<     * @param Type
<     * @throws XMLSecurityException
<     */
<    public EncryptedData(
<            Document doc, EncryptionMethod encryptionMethod, KeyInfo keyInfo, CipherData cipherData, EncryptionProperties encryptionProperties, String Id, String Type)
<               throws XMLSecurityException {
< 
<       super(doc);
< 
<       XMLUtils.addReturnToElement(this._constructionElement);
< 
<       if (encryptionMethod != null) {
<          if (!encryptionMethod.getUsableInEncryptedData()) {
<             Object exArgs[] = { encryptionMethod.getAlgorithmURI() };
< 
<             throw new XMLSecurityException(
<                "encryption.algorithmCannotBeUsedForEncryptedData", exArgs);
<          }
< 
<          this._constructionElement.appendChild(encryptionMethod.getElement());
<          XMLUtils.addReturnToElement(this._constructionElement);
< 
<          this._cachedEncryptionMethod = encryptionMethod;
<       }
< 
<       if (keyInfo != null) {
<          this._constructionElement.appendChild(keyInfo.getElement());
<          XMLUtils.addReturnToElement(this._constructionElement);
<       }
< 
<       if (cipherData == null) {
< 
<          //
<          // the CipherData child will be filled by this object, so we only
<          // create a place holder
<          //
<          cipherData = new CipherData(doc);
<       }
< 
<       this._constructionElement.appendChild(cipherData.getElement());
<       XMLUtils.addReturnToElement(this._constructionElement);
< 
<       if (encryptionProperties != null) {
<          this._constructionElement
<             .appendChild(encryptionProperties.getElement());
<          XMLUtils.addReturnToElement(this._constructionElement);
<       }
< 
<       this.setId(Id);
<       this.setType(Type);
<    }
< 
<    /**
<     * Constructor EncryptedData
<     *
<     * @param doc
<     * @param encryptionMethod
<     * @param encryptionMethodParams
<     * @param keyInfo
<     * @param encryptionProperties
<     * @param Id
<     * @throws XMLSecurityException
<     */
<    public EncryptedData(
<            Document doc, String encryptionMethod, EncryptionMethodParams encryptionMethodParams, KeyInfo keyInfo, EncryptionProperties encryptionProperties, String Id)
<               throws XMLSecurityException {
< 
<       this(doc,
<            new EncryptionMethod(doc, encryptionMethod, encryptionMethodParams),
<            keyInfo, (CipherData) null, encryptionProperties, Id, (String) null);
<    }
< 
<    /**
<     * Constructor EncryptedData
<     *
<     * @param doc
<     * @param encryptionMethod
<     * @param encryptionMethodParams
<     * @param keyInfo
<     * @param cipherData
<     * @param encryptionProperties
<     * @param Id
<     * @param Type
<     * @throws XMLSecurityException
<     */
<    public EncryptedData(
<            Document doc, String encryptionMethod,
<            EncryptionMethodParams encryptionMethodParams, KeyInfo keyInfo, CipherData cipherData, EncryptionProperties encryptionProperties, String Id, String Type)
<               throws XMLSecurityException {
< 
<       this(doc,
<            new EncryptionMethod(doc, encryptionMethod, encryptionMethodParams),
<            keyInfo, cipherData, encryptionProperties, Id, Type);
<    }
< 
<    /**
<     * Constructor EncryptedData
<     *
<     * @param element
<     * @param BaseURI
<     * @throws XMLSecurityException
<     */
<    public EncryptedData(Element element, String BaseURI)
<            throws XMLSecurityException {
<       super(element, BaseURI);
<    }
< 
<    /**
<     * Method getEncryptionMethod
<     *
<     * @return
<     * @throws XMLSecurityException
<     */
<    public EncryptionMethod getEncryptionMethod() throws XMLSecurityException {
< 
<       if (this._cachedEncryptionMethod == null) {
<          Element e =
<             XMLUtils.getDirectChild(this._constructionElement,
<                                     EncryptionConstants._TAG_ENCRYPTIONMETHOD,
<                                     EncryptionConstants.EncryptionSpecNS);
< 
<          if (e != null) {
<             this._cachedEncryptionMethod = new EncryptionMethod(e,
<                     this._baseURI);
<          }
<       }
< 
<       return this._cachedEncryptionMethod;
<    }
< 
<    /**
<     * Method getKeyInfo
<     *
<     * @return
<     * @throws XMLSecurityException
<     */
<    public KeyInfo getKeyInfo() throws XMLSecurityException {
< 
<       Element e = XMLUtils.getDirectChild(this._constructionElement,
<                                           Constants._TAG_KEYINFO,
<                                           Constants.SignatureSpecNS);
< 
<       if (e != null) {
<          return new KeyInfo(e, this._baseURI);
<       } else {
<          return null;
<       }
<    }
< 
<    /**
<     * Method getCipherData
<     *
<     * @return
<     * @throws XMLSecurityException
<     */
<    public CipherData getCipherData() throws XMLSecurityException {
< 
<       Element e = XMLUtils.getDirectChild(this._constructionElement,
<                                           EncryptionConstants._TAG_CIPHERDATA,
<                                           EncryptionConstants.EncryptionSpecNS);
< 
<       if (e != null) {
<          return new CipherData(e, this._baseURI);
<       } else {
<          return null;
<       }
<    }
< 
<    /**
<     * Method getEncryptionProperties
<     *
<     * @return
<     * @throws XMLSecurityException
<     */
<    public EncryptionProperties getEncryptionProperties()
<            throws XMLSecurityException {
< 
<       Element e =
<          XMLUtils.getDirectChild(this._constructionElement,
<                                  EncryptionConstants._TAG_ENCRYPTIONPROPERTIES,
<                                  EncryptionConstants.EncryptionSpecNS);
< 
<       if (e != null) {
<          return new EncryptionProperties(e, this._baseURI);
<       } else {
<          return null;
<       }
<    }
< 
<    /**
<     * Sets the <code>Id</code> attribute
<     *
<     * @param Id ID
<     */
<    public void setId(String Id) {
< 
<       if ((this._state == MODE_CREATE) && (Id != null) && (Id.length() != 0)) {
<          this._constructionElement.setAttributeNS(null, EncryptionConstants._ATT_ID,
<                                                 Id);
<          IdResolver.registerElementById(this._constructionElement, Id);
<       }
<    }
< 
<    /**
<     * Returns the <code>Id</code> attribute
<     *
<     * @return the <code>Id</code> attribute
<     */
<    public String getId() {
<       return this._constructionElement
<          .getAttributeNS(null, EncryptionConstants._ATT_ID);
<    }
< 
<    /**
<     * Method setType
<     *
<     * @param Type
<     */
<    public void setType(String Type) {
< 
<       if ((this._state == MODE_CREATE) && (Type != null)) {
<          this._constructionElement.setAttributeNS(null, EncryptionConstants._ATT_TYPE,
<                                                 Type);
<       }
<    }
< 
<    /**
<     * Method getType
<     *
<     * @return
<     */
<    public String getType() {
<       return this._constructionElement
<          .getAttributeNS(null, EncryptionConstants._ATT_TYPE);
<    }
< 
<    /**
<     * Method getTypeIsElement
<     *
<     * @return
<     */
<    public boolean getTypeIsElement() {
< 
<       String type = this.getType();
< 
<       if ((type == null) || (type.length() == 0)) {
<          return false;
<       }
< 
<       return type.equals(EncryptionConstants.TYPE_ELEMENT);
<    }
< 
<    /**
<     * Method getTypeIsContent
<     *
<     * @return
<     */
<    public boolean getTypeIsContent() {
< 
<       String type = this.getType();
< 
<       if ((type == null) || (type.length() == 0)) {
<          return false;
<       }
< 
<       return type.equals(EncryptionConstants.TYPE_CONTENT);
<    }
< 
<    /**
<     * Method getTypeIsMediaType
<     *
<     * @return
<     */
<    public boolean getTypeIsMediaType() {
< 
<       String type = this.getType();
< 
<       if ((type == null) || (type.length() == 0)) {
<          return false;
<       }
< 
<       return type.startsWith(EncryptionConstants.TYPE_MEDIATYPE);
<    }
< 
<    /**
<     * Method getMediaTypeOfType
<     *
<     * @return
<     */
<    public String getMediaTypeOfType() {
< 
<       if (this.getTypeIsMediaType()) {
<          return this.getType()
<             .substring(EncryptionConstants.TYPE_MEDIATYPE.length());
<       }
< 
<       return null;
<    }
< 
<    /**
<     * Method replace
<     *
<     * @param oldElement
<     * @param newContent
<     * @return
<     */
<    public static Element replace(Element oldElement, NodeList newContent) {
< 
<       /*
<       if (oldElement == null) {
<         throw new IllegalArgumentException("oldElement is null");
<       }
<       if (newContent == null) {
<         throw new IllegalArgumentException("newContent is null");
<       }
<       */
<       Document oldDocument = oldElement.getOwnerDocument();
< 
<       {
<          HelperNodeList nl2 = new HelperNodeList();
< 
<          for (int i = 0; i < newContent.getLength(); i++) {
<             if (oldDocument != newContent.item(i).getOwnerDocument()) {
< 
<                // both elements are in different documents so we have to import.
<                nl2.appendChild(oldDocument.importNode(newContent.item(i),
<                                                       true));
<             } else {
<                nl2.appendChild(newContent.item(i));
<             }
<          }
< 
<          newContent = nl2;
<       }
< 
<       Node parent = oldElement.getParentNode();
< 
<       if (parent == oldDocument) {
< 
<          //
<          // we cannot use replaceChild because this throws DOMException
<          //
<          NodeList topLevelNodes = oldDocument.getChildNodes();
< 
<          if (topLevelNodes.getLength() == 1) {
<             Node returnValue = oldDocument.removeChild(oldElement);
< 
<             for (int i = 0; i < newContent.getLength(); i++) {
<                if (newContent.item(i).getNodeType() != Node.TEXT_NODE) {
<                   oldDocument.appendChild(newContent.item(i));
<                }
<             }
< 
<             return (Element) returnValue;
<          } else {
<             int i = 0;
< 
<             searchForRootElem: for (i = 0; i < topLevelNodes.getLength(); i++) {
<                if (topLevelNodes.item(i) == oldElement) {
<                   break searchForRootElem;
<                }
<             }
< 
<             if (i == topLevelNodes.getLength() - 1) {
<                Node returnValue = oldDocument.removeChild(oldElement);
< 
<                for (int j = 0; j < newContent.getLength(); j++) {
<                   oldDocument.appendChild(newContent.item(j));
<                }
< 
<                return (Element) returnValue;
<             } else {
<                Node returnValue = oldDocument.removeChild(oldElement);
<                Node insertBefore = topLevelNodes.item(i);
< 
<                for (int j = 0; j < newContent.getLength(); j++) {
<                   oldDocument.insertBefore(newContent.item(j), insertBefore);
<                }
< 
<                return (Element) returnValue;
<             }
<          }
<       } else {
<          for (int j = 0; j < newContent.getLength(); j++) {
<             parent.insertBefore(newContent.item(j), oldElement);
<          }
< 
<          return (Element) parent.removeChild(oldElement);
<       }
<    }
< 
<    /**
<     * Replaces an old Element by a new one
<     *
<     * @param oldElement the old Element which has to be removed from the Document
<     * @param newElement the new Element which has to be place in the position of <CODE>oldElement</CODE>
<     * @return the removed element
<     */
<    public static Element replace(Element oldElement, Element newElement) {
< 
<       HelperNodeList newContent = new HelperNodeList();
< 
<       newContent.appendChild(newElement);
---
> public interface EncryptedData extends EncryptedType {
497,498c41
<       return replace(oldElement, newContent);
<    }
---
>     int min(int i, int j);
500,956c43
<    /**
<     * Method replace
<     *
<     * @param oldElement
<     * @param plaintextBytes
<     * @return
<     * @throws XMLSecurityException
<     */
<    public static Element replace(Element oldElement, byte[] plaintextBytes)
<            throws XMLSecurityException {
< 
<       try {
<          javax.xml.parsers.DocumentBuilderFactory dbf =
<             javax.xml.parsers.DocumentBuilderFactory.newInstance();
< 
<          dbf.setNamespaceAware(true);
< 
<          javax.xml.parsers.DocumentBuilder db = dbf.newDocumentBuilder();
<          Document doc =
<             db.parse(new java.io.ByteArrayInputStream(plaintextBytes));
<          HelperNodeList newContent = new HelperNodeList();
< 
<          for (int i = 0; i < doc.getChildNodes().getLength(); i++) {
<             newContent.appendChild(doc.getChildNodes().item(i));
<          }
< 
<          return replace(oldElement, newContent);
<       } catch (javax.xml.parsers.ParserConfigurationException ex) {
<          throw new XMLSecurityException("empty", ex);
<       } catch (java.io.IOException ex) {
<          throw new XMLSecurityException("empty", ex);
<       } catch (org.xml.sax.SAXException ex) {
<          throw new XMLSecurityException("empty", ex);
<       }
<    }
< 
<    /** Field _cachedEncryptionMethod */
<    EncryptionMethod _cachedEncryptionMethod = null;
< 
<    /**
<     * Method createSecretKeyFromBytes
<     *
<     * @param encodedKey
<     * @return
<     * @throws XMLSecurityException
<     */
<    public Key createSecretKeyFromBytes(byte encodedKey[])
<            throws XMLSecurityException {
<       return this.getEncryptionMethod().createSecretKeyFromBytes(encodedKey);
<    }
< 
<    /**
<     * Method encryptAndReplace
<     *
<     * @param plaintextElement
<     * @param secretKey
<     * @throws XMLSecurityException
<     */
<    public void encryptElementAndReplace(Element plaintextElement, Key secretKey)
<            throws XMLSecurityException {
< 
<       EncryptionMethod em = this.getEncryptionMethod();
<       Canonicalizer c14n =
<          Canonicalizer.getInstance(Canonicalizer.ALGO_ID_C14N_WITH_COMMENTS);
<       byte plaintext[] = c14n.canonicalizeSubtree(plaintextElement);
<       byte ciphertext[] = em.encrypt(plaintext, secretKey);
< 
<       this.getCipherData().setCipherValue(new CipherValue(this._doc,
<               ciphertext));
<       this.setType(EncryptionConstants.TYPE_ELEMENT);
<       EncryptedData.replace(plaintextElement, this._constructionElement);
<    }
< 
<    /**
<     * This method is the old implementation of {@link #encryptContentAndReplace()}.
<     *
<     * @param parentOfPlaintext the parent of the Nodes which are to be encrypted. All child nodes will be encrypted but not the parent itself.
<     * @param contentEncryptionKey the {@link Key} which is used to encrypt the data
<     * @throws XMLSecurityException
<     */
<    private void encryptContentAndReplace_old(
<            Node parentOfPlaintext, Key contentEncryptionKey)
<               throws XMLSecurityException {
< 
<       EncryptionMethod em = this.getEncryptionMethod();
<       byte plaintext[] = null;
< 
<       try {
<          ByteArrayOutputStream baos = new ByteArrayOutputStream();
< 
<          for (int i = 0; i < parentOfPlaintext.getChildNodes().getLength();
<                  i++) {
<             Node plaintextItem = parentOfPlaintext.getChildNodes().item(i);
< 
<             // we cannot c14nize Comments, and PIs because the c14nizer appends CRs to the String
<             if (plaintextItem.getNodeType() == Node.COMMENT_NODE) {
<                baos.write(("<!--" + ((Comment) plaintextItem).getData()
<                            + "-->").getBytes());
<             } else if (plaintextItem.getNodeType()
<                        == Node.PROCESSING_INSTRUCTION_NODE) {
<                baos.write(("<?"
<                            + ((ProcessingInstruction) plaintextItem).getTarget()
<                            + " "
<                            + ((ProcessingInstruction) plaintextItem).getData()
<                            + "?>").getBytes());
<             } else if (plaintextItem.getNodeType() == Node.TEXT_NODE) {
<                baos.write((((Text) plaintextItem).getData()).getBytes());
<             } else {
< 
<                // we have to create a new Canonicalizer for each Node because it stores state ;-(
<                Canonicalizer c14n =
<                   Canonicalizer
<                      .getInstance(Canonicalizer.ALGO_ID_C14N_WITH_COMMENTS);
< 
<                baos.write(c14n.canonicalizeSubtree(plaintextItem));
<             }
<          }
< 
<          plaintext = baos.toByteArray();
<       } catch (Exception ex) {
<          throw new XMLSecurityException("empty", ex);
<       }
< 
<       byte ciphertext[] = em.encrypt(plaintext, contentEncryptionKey);
< 
<       this.getCipherData().setCipherValue(new CipherValue(this._doc,
<               ciphertext));
<       this.setType(EncryptionConstants.TYPE_CONTENT);
< 
<       while (parentOfPlaintext.hasChildNodes()) {
<          parentOfPlaintext.removeChild(parentOfPlaintext.getLastChild());
<       }
< 
<       parentOfPlaintext.appendChild(this._constructionElement);
<    }
< 
<    /**
<     * Encrypts all child {@link Node}s of a given {@link Element}.
<     *
<     * @param parentOfPlaintext the parent of the Nodes which are to be encrypted. All child nodes will be encrypted but not the parent itself.
<     * @param contentEncryptionKey the {@link Key} which is used to encrypt the data
<     * @throws XMLSecurityException
<     */
<    public void encryptContentAndReplace(
<            Node parentOfPlaintext, Key contentEncryptionKey)
<               throws XMLSecurityException {
< 
<       encryptContentAndReplace(parentOfPlaintext.getFirstChild(),
<                                parentOfPlaintext.getChildNodes().getLength(),
<                                contentEncryptionKey);
<    }
< 
<    /**
<     * Encrypts <B>some</B> child {@link Node}s of a given {@link Element}.
<     *
<     * @param firstPlaintextNode the first Node to be encrypted
<     * @param length the total number of Nodes to be encrypted (the firstPlaintextNode and (length-1) next siblings)
<     * @param contentEncryptionKey the {@link Key} which is used to encrypt the data
<     * @throws XMLSecurityException
<     */
<    public void encryptContentAndReplace(
<            Node firstPlaintextNode, int length, Key contentEncryptionKey)
<               throws XMLSecurityException {
< 
<       try {
<          EncryptionMethod em = this.getEncryptionMethod();
<          byte plaintext[] = null;
<          Node parent = firstPlaintextNode.getParentNode();
<          ByteArrayOutputStream baos = new ByteArrayOutputStream();
<          Node currentNode = firstPlaintextNode;
<          int i = 0;
< 
<          while (i < length) {
<             if (currentNode == null) {
<                throw new IndexOutOfBoundsException(
<                   "The index " + length + " is out of bounds: maximum is "
<                   + (i - 1));
<             }
< 
<             // we cannot c14nize Comments, and PIs because the c14nizer appends CRs to the String
<             if (currentNode.getNodeType() == Node.COMMENT_NODE) {
<                baos.write(("<!--" + ((Comment) currentNode).getData()
<                            + "-->").getBytes());
<             } else if (currentNode.getNodeType()
<                        == Node.PROCESSING_INSTRUCTION_NODE) {
<                baos.write(("<?"
<                            + ((ProcessingInstruction) currentNode).getTarget()
<                            + " "
<                            + ((ProcessingInstruction) currentNode).getData()
<                            + "?>").getBytes());
<             } else if (currentNode.getNodeType() == Node.TEXT_NODE) {
<                baos.write((((Text) currentNode).getData()).getBytes());
<             } else {
< 
<                // we have to create a new Canonicalizer for each Node because it stores state ;-(
<                Canonicalizer c14n =
<                   Canonicalizer
<                      .getInstance(Canonicalizer.ALGO_ID_C14N_WITH_COMMENTS);
< 
<                baos.write(c14n.canonicalizeSubtree(currentNode));
<             }
< 
<             currentNode = currentNode.getNextSibling();
<             i = i + 1;
<          }
< 
<          Node insertBeforeNode = currentNode;
< 
<          plaintext = baos.toByteArray();
< 
<          byte ciphertext[] = em.encrypt(plaintext, contentEncryptionKey);
< 
<          this.getCipherData().setCipherValue(new CipherValue(this._doc,
<                  ciphertext));
<          this.setType(EncryptionConstants.TYPE_CONTENT);
< 
<          int start = 0;
< 
<          for (currentNode = parent.getFirstChild();
<                  currentNode != firstPlaintextNode;
<                  currentNode = currentNode.getNextSibling()) {
<             start++;
<          }
< 
<          for (i = 0; i < length; i++) {
<             parent.removeChild(parent.getChildNodes().item(start));
<          }
< 
<          parent.insertBefore(this._constructionElement, insertBeforeNode);
<       } catch (XMLSecurityException ex) {
<          throw ex;
<       } catch (Exception ex) {
<          throw new XMLSecurityException("empty", ex);
<       }
<    }
< 
<    /**
<     * Method decryptAndReplace
<     *
<     * @param contentDecryptionKey
<     * @throws XMLSecurityException
<     */
<    public void decryptAndReplace(Key contentDecryptionKey)
<            throws XMLSecurityException {
< 
<       EncryptionMethod em = this.getEncryptionMethod();
<       byte ciphertext[] = this.getCipherData().getCipherValue().getCipherText();
<       byte plaintext[] = em.decrypt(ciphertext, contentDecryptionKey);
< 
<       try {
<          ByteArrayOutputStream baos = new ByteArrayOutputStream();
<          String container = "container";
< 
<          baos.write((new String("<" + container + ">")).getBytes());
<          baos.write(plaintext);
<          baos.write((new String("</" + container + ">")).getBytes());
< 
<          javax.xml.parsers.DocumentBuilderFactory dbf =
<             javax.xml.parsers.DocumentBuilderFactory.newInstance();
< 
<          dbf.setNamespaceAware(true);
< 
<          javax.xml.parsers.DocumentBuilder db = dbf.newDocumentBuilder();
<          Document doc2 =
<             db.parse(new java.io.ByteArrayInputStream(baos.toByteArray()));
<          Element doc2Elem = doc2.getDocumentElement();
<          HelperNodeList newContent = new HelperNodeList();
< 
<          for (int i = 0; i < doc2Elem.getChildNodes().getLength(); i++) {
<             newContent.appendChild(doc2Elem.getChildNodes().item(i));
<          }
< 
<          replace(this._constructionElement, newContent);
<       } catch (javax.xml.parsers.ParserConfigurationException ex) {
<          throw new XMLSecurityException("empty", ex);
<       } catch (java.io.IOException ex) {
<          throw new XMLSecurityException("empty", ex);
<       } catch (org.xml.sax.SAXException ex) {
<          throw new XMLSecurityException("empty", ex);
<       }
<    }
< 
<    /**
<     * Method main
<     *
<     * @param unused
<     * @throws Exception
<     */
<    public static void main(String unused[]) throws Exception {
< 
<       org.apache.xml.security.Init.init();
< 
<       javax.xml.parsers.DocumentBuilderFactory dbf =
<          javax.xml.parsers.DocumentBuilderFactory.newInstance();
< 
<       dbf.setNamespaceAware(true);
< 
<       javax.xml.parsers.DocumentBuilder db = dbf.newDocumentBuilder();
<       Document doc = db.newDocument();
<       Element root = doc.createElementNS(null, "root");
<       String realContent = "1 USD           ";
<       String desired = "999.999.999 EUR ";
<       String estimated = realContent;
< 
<       {
<          root.appendChild(doc.createTextNode(realContent));
< 
<          /*
<          root.appendChild(doc.createComment("afasd"));
<          root.appendChild(doc.createProcessingInstruction("sfd",
<                  "d sdf kjghkds "));
<          */
<          doc.appendChild(doc.createComment(" 0 "));
<          doc.appendChild(doc.createComment(" 1 "));
<          doc.appendChild(root);
<          doc.appendChild(doc.createComment(" 2 "));
<          doc.appendChild(doc.createComment(" 3 "));
<          System.out.println(
<             "------------------------------------------------------------");
<          XMLUtils.outputDOMc14nWithComments(doc, System.out);
<          System.out.println();
<       }
< 
<       Key cek;
< 
<       {
<          KeyInfo ki = new KeyInfo(doc);
< 
<          ki.add(new org.apache.xml.security.keys.content.KeyName(doc,
<                  "Christian Geuer-Pollmann"));
< 
<          EncryptedData ed =
<             new EncryptedData(doc,
<                               EncryptionConstants.ALGO_ID_BLOCKCIPHER_AES128,
<                               null, ki, null, "myFirstEncryptedElement");
< 
<          cek = ed.createSecretKeyFromBytes(
<             org.apache.xml.security.utils.HexDump.hexStringToByteArray(
<                "00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f"));
< 
<          ed.encryptContentAndReplace(root, cek);
< 
<          // ed.encryptElementAndReplace(root, cek);
<          // ed.encryptContentAndReplace(doc, cek);
<          // ed.encryptContentAndReplace(doc.getChildNodes().item(2), 10, cek);
<          System.out.println(
<             "------------------------------------------------------------");
<          XMLUtils.outputDOMc14nWithComments(doc, System.out);
<          System.out.println();
<       }
< 
< 
<       {
<          org.apache.xpath.CachedXPathAPI xpath =
<             new org.apache.xpath.CachedXPathAPI();
<          Element nsctx = doc.createElementNS(null, "nsctx");
< 
<          nsctx.setAttributeNS(Constants.NamespaceSpecNS, "xmlns:xenc", EncryptionConstants.EncryptionSpecNS);
< 
<          Element encryptedDataElem = (Element) xpath.selectSingleNode(doc,
<                                         "//xenc:EncryptedData", nsctx);
<          EncryptedData ed2 = new EncryptedData(encryptedDataElem, "memory://");
< /*
<          byte[] ciphertext =
<             ed2.getCipherData().getCipherValue().getCipherText();
< 
<          System.out.println(
<             "------------------------------------------------------------");
< 
<          {
<             for (int i = 0; i < ed2.getEncryptionMethod().getIvLength(); i++) {
<                System.out.print("XXX");
<             }
< 
<             System.out.println();
<          }
< 
<          System.out.println(HexDump.byteArrayToHexString(ciphertext));
< 
<          // byte[] newRandom = PRNG.createBytes(overWriteLength);
<          int blockSize = ed2.getEncryptionMethod().getBlockSize();
<          int ivSize = ed2.getEncryptionMethod().getIvLength();
<          int modifyableBytes = ed2.getEncryptionMethod().getBlockSize()
<                                - (ed2.getNonce()
<                                   % ed2.getEncryptionMethod().getBlockSize());
<          byte estimatedBytes[] = estimated.getBytes("UTF-8");
<          byte desiredBytes[] = desired.getBytes("UTF-8");
<          int differenceSize = min(modifyableBytes, estimatedBytes.length,
<                                   desiredBytes.length);
<          byte difference[] = new byte[differenceSize];
< 
<          for (int i = 0; i < difference.length; i++) {
<             difference[i] = (byte) (estimatedBytes[i] ^ desiredBytes[i]);
<          }
< 
<          {
<             for (int i = 0; i < ed2.getNonce(); i++) {
<                System.out.print("   ");
<             }
< 
<             System.out.println(HexDump.byteArrayToHexString(difference));
<          }
< 
<          for (int i = 0; i < difference.length; i++) {
<             ciphertext[ed2.getNonce() + i] ^= difference[i];
<          }
< 
<          System.out.println(HexDump.byteArrayToHexString(ciphertext));
<          ed2.getCipherData().getCipherValue().setCipherText(ciphertext);
<          XMLUtils.outputDOMc14nWithComments(doc, System.out);
<          System.out.println();
<          System.out.println(
<             "------------------------------------------------------------");
< */
< 
< 
<          ed2.decryptAndReplace(cek);
<          System.out.println(
<             "------------------------------------------------------------");
<          XMLUtils.outputDOMc14nWithComments(doc, System.out);
<          System.out.println();
<          System.out.println(
<             "------------------------------------------------------------");
<       }
<    }
< 
<    /**
<     * Method min
<     *
<     * @param a
<     * @param b
<     * @param c
<     * @return
<     */
<    public static int min(int a, int b, int c) {
<       return min(min(a, b), c);
<    }
< 
<    /**
<     * Method min
<     *
<     * @param a
<     * @param b
<     * @return
<     */
<    public static int min(int a, int b) {
< 
<       if (a < b) {
<          return a;
<       }
< 
<       return b;
<    }
< 
<    public String getBaseLocalName() {
<       return EncryptionConstants._TAG_ENCRYPTEDDATA;
<    }
---
>     int min(int i, int j, int k);
957a45
> 
diff -r xml-security-orig-v1/src/org/apache/xml/security/encryption/EncryptedKey.java xml-security-1_2_0/src/org/apache/xml/security/encryption/EncryptedKey.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  2003-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,73d20
< import java.security.Key;
< import org.w3c.dom.*;
< import org.apache.xml.security.algorithms.encryption.EncryptionMethod;
< import org.apache.xml.security.algorithms.encryption.params
<    .EncryptionMethodParams;
< import org.apache.xml.security.exceptions.XMLSecurityException;
< import org.apache.xml.security.utils.*;
< import org.apache.xml.security.keys.KeyInfo;
< import org.apache.xml.security.encryption.type.EncryptedType;
< 
< 
75c22,45
<  * This class maps to the <CODE>xenc:EncryptedKey</CODE> element.
---
>  * The <code>EncryptedKey</code> element is used to transport encryption keys
>  * from the originator to a known recipient(s). It may be used as a stand-alone
>  * XML document, be placed within an application document, or appear inside an
>  * <code>EncryptedData</code> element as a child of a <code>ds:KeyInfo</code>
>  * element. The key value is always encrypted to the recipient(s). When
>  * <code>EncryptedKey</code> is decrypted the resulting octets are made
>  * available to the <code>EncryptionMethod</code> algorithm without any
>  * additional processing.
>  * <p>
>  * Its schema definition is as follows:
>  * <xmp>
>  * <element name='EncryptedKey' type='xenc:EncryptedKeyType'/>
>  * <complexType name='EncryptedKeyType'>
>  *     <complexContent>
>  *         <extension base='xenc:EncryptedType'>
>  *             <sequence>
>  *                 <element ref='xenc:ReferenceList' minOccurs='0'/>
>  *                 <element name='CarriedKeyName' type='string' minOccurs='0'/>
>  *             </sequence>
>  *             <attribute name='Recipient' type='string' use='optional'/>
>  *         </extension>
>  *     </complexContent>
>  * </complexType>
>  * </xmp>
77c47
<  * @author $Author: dohy $
---
>  * @author Axl Mattheus
79,692c49,107
< public class EncryptedKey extends EncryptionElementProxy
<         implements EncryptedType {
< 
<    /**
<     * Constructor EncryptedKey
<     *
<     * @param doc
<     * @param encryptionMethod
<     * @param keyInfo
<     * @param cipherData
<     * @param encryptionProperties
<     * @param referenceList
<     * @param CarriedKeyName
<     * @param Id
<     * @param Type
<     * @param Recipient
<     * @throws XMLSecurityException
<     */
<    public EncryptedKey(
<            Document doc, EncryptionMethod encryptionMethod, KeyInfo keyInfo,
<            CipherData cipherData, EncryptionProperties encryptionProperties, ReferenceList referenceList, String CarriedKeyName, String Id, String Type, String Recipient)
<               throws XMLSecurityException {
< 
<       super(doc);
< 
<       XMLUtils.addReturnToElement(this._constructionElement);
< 
<       if (encryptionMethod != null) {
<          if (!encryptionMethod.getUsableInEncryptedKey()) {
<             Object exArgs[] = { encryptionMethod.getAlgorithmURI() };
< 
<             throw new XMLSecurityException(
<                "encryption.algorithmCannotBeUsedForEncryptedKey", exArgs);
<          }
< 
<          this._constructionElement.appendChild(encryptionMethod.getElement());
<          XMLUtils.addReturnToElement(this._constructionElement);
<       }
< 
<       if (keyInfo != null) {
<          this._constructionElement.appendChild(keyInfo.getElement());
<          XMLUtils.addReturnToElement(this._constructionElement);
<       }
<       {
<          this._constructionElement.appendChild(cipherData.getElement());
<          XMLUtils.addReturnToElement(this._constructionElement);
<       }
< 
<       if (encryptionProperties != null) {
<          this._constructionElement
<             .appendChild(encryptionProperties.getElement());
<          XMLUtils.addReturnToElement(this._constructionElement);
<       }
< 
<       if (referenceList != null) {
<          this._constructionElement.appendChild(referenceList.getElement());
<          XMLUtils.addReturnToElement(this._constructionElement);
<       }
< 
<       this.setCarriedKeyName(CarriedKeyName);
<       this.setId(Id);
<       this.setType(Type);
<       this.setRecipient(Recipient);
<    }
< 
<    /**
<     * Constructor EncryptedKey
<     *
<     * @param doc
<     * @param encryptionMethodURI
<     * @param encryptionMethodParams
<     * @param keyInfo
<     * @param contentKey
<     * @param wrapKey
<     * @param encryptionProperties
<     * @param referenceList
<     * @param CarriedKeyName
<     * @param Id
<     * @param Type
<     * @param Recipient
<     * @throws XMLSecurityException
<     */
<    public EncryptedKey(
<            Document doc, String encryptionMethodURI,
<            EncryptionMethodParams encryptionMethodParams, KeyInfo keyInfo,
<            Key contentKey, Key wrapKey, EncryptionProperties encryptionProperties, ReferenceList referenceList, String CarriedKeyName, String Id, String Type, String Recipient)
<               throws XMLSecurityException {
< 
<       super(doc);
< 
<       XMLUtils.addReturnToElement(this._constructionElement);
< 
<       EncryptionMethod encryptionMethod = new EncryptionMethod(doc,
<                                              encryptionMethodURI,
<                                              encryptionMethodParams);
< 
<       if (!encryptionMethod.getUsableInEncryptedKey()) {
<          Object exArgs[] = { encryptionMethod.getAlgorithmURI() };
< 
<          throw new XMLSecurityException(
<             "encryption.algorithmCannotBeUsedForEncryptedKey", exArgs);
<       }
< 
<       this._constructionElement.appendChild(encryptionMethod.getElement());
<       XMLUtils.addReturnToElement(this._constructionElement);
< 
<       if (keyInfo != null) {
<          this._constructionElement.appendChild(keyInfo.getElement());
<          XMLUtils.addReturnToElement(this._constructionElement);
<       }
<       {
<          byte wrappedKey[] = encryptionMethod.wrap(contentKey, wrapKey);
<          CipherData cipherData = new CipherData(doc, wrappedKey);
<          this._constructionElement.appendChild(cipherData.getElement());
<          XMLUtils.addReturnToElement(this._constructionElement);
<       }
< 
<       if (encryptionProperties != null) {
<          this._constructionElement
<             .appendChild(encryptionProperties.getElement());
<          XMLUtils.addReturnToElement(this._constructionElement);
<       }
< 
<       if (referenceList != null) {
<          this._constructionElement.appendChild(referenceList.getElement());
<          XMLUtils.addReturnToElement(this._constructionElement);
<       }
< 
<       this.setCarriedKeyName(CarriedKeyName);
<       this.setId(Id);
<       this.setType(Type);
<       this.setRecipient(Recipient);
<    }
< 
<    /**
<     * Constructor EncryptedKey
<     *
<     * @param element
<     * @param BaseURI
<     * @throws XMLSecurityException
<     */
<    public EncryptedKey(Element element, String BaseURI)
<            throws XMLSecurityException {
<       super(element, BaseURI);
<    }
< 
<    /**
<     * Method setReferenceList
<     *
<     * @param referenceList
<     */
<    private void setReferenceList(ReferenceList referenceList) {
< 
<       // If xenc:ReferenceList already exists do it
<       // otherwise appendChild;
<    }
< 
<    /**
<     * Method getReferenceList
<     *
<     * @return
<     * @throws XMLSecurityException
<     */
<    public ReferenceList getReferenceList() throws XMLSecurityException {
< 
<       int noOfReferences = this.length(EncryptionConstants.EncryptionSpecNS,
<                                        EncryptionConstants._TAG_REFERENCELIST);
< 
<       if (noOfReferences > 1) {
<          Object exArgs[] = { "More then one xenc:ReferenceList found" };
< 
<          throw new XMLSecurityException("empty", exArgs);
<       } else if (noOfReferences == 1) {
<          Element referenceListElem = this.getChildElementLocalName(0,
<                                         EncryptionConstants.EncryptionSpecNS,
<                                         EncryptionConstants._TAG_REFERENCELIST);
< 
<          return new ReferenceList(referenceListElem, this._baseURI);
<       } else {
<          return null;
<       }
<    }
< 
<    /**
<     * Method addDataReference
<     *
<     * @param dataReference
<     * @throws XMLSecurityException
<     */
<    public void addDataReference(DataReference dataReference)
<            throws XMLSecurityException {
< 
<       if (this.getReferenceList() == null) {
<          ReferenceList referenceList = new ReferenceList(this._doc);
< 
<          this.setReferenceList(referenceList);
<       }
< 
<       this.getReferenceList().add(dataReference);
<    }
< 
<    /**
<     * Method addKeyReference
<     *
<     * @param keyReference
<     * @throws XMLSecurityException
<     */
<    public void addKeyReference(KeyReference keyReference)
<            throws XMLSecurityException {
< 
<       if (this.getReferenceList() == null) {
<          ReferenceList referenceList = new ReferenceList(this._doc);
< 
<          this.setReferenceList(referenceList);
<       }
< 
<       this.getReferenceList().add(keyReference);
<    }
< 
<    /**
<     * Method getLengthDataReference
<     *
<     * @return
<     * @throws XMLSecurityException
<     */
<    public int getLengthDataReference() throws XMLSecurityException {
< 
<       ReferenceList referenceList = this.getReferenceList();
< 
<       if (referenceList == null) {
<          return 0;
<       } else {
<          return referenceList.getLengthDataReference();
<       }
<    }
< 
<    /**
<     * Method getLengthKeyReference
<     *
<     * @return
<     * @throws XMLSecurityException
<     */
<    public int getLengthKeyReference() throws XMLSecurityException {
< 
<       ReferenceList referenceList = this.getReferenceList();
< 
<       if (referenceList == null) {
<          return 0;
<       } else {
<          return referenceList.getLengthKeyReference();
<       }
<    }
< 
<    /**
<     * Method itemDataReference
<     *
<     * @param i
<     * @return
<     * @throws XMLSecurityException
<     */
<    public DataReference itemDataReference(int i) throws XMLSecurityException {
< 
<       ReferenceList referenceList = this.getReferenceList();
< 
<       return referenceList.itemDataReference(i);
<    }
< 
<    /**
<     * Method itemKeyReference
<     *
<     * @param i
<     * @return
<     * @throws XMLSecurityException
<     */
<    public KeyReference itemKeyReference(int i) throws XMLSecurityException {
< 
<       ReferenceList referenceList = this.getReferenceList();
< 
<       return referenceList.itemKeyReference(i);
<    }
< 
<    /**
<     * Method setCarriedKeyName
<     *
<     * @param carriedKeyName
<     * @throws XMLSecurityException
<     */
<    public void setCarriedKeyName(String carriedKeyName)
<            throws XMLSecurityException {
< 
<       if ((carriedKeyName != null) && (carriedKeyName.length() > 0)
<               && (this._state == MODE_CREATE)) {
<          CarriedKeyName cn = this.getCarriedKeyName();
< 
<          if (cn != null) {
<             cn.setCarriedKeyName(carriedKeyName);
<          } else {
<             cn = new CarriedKeyName(this._doc, carriedKeyName);
< 
<             this._constructionElement.appendChild(cn.getElement());
<             XMLUtils.addReturnToElement(this._constructionElement);
<          }
<       }
<    }
< 
<    /**
<     * Method getCarriedKeyName
<     *
<     * @return
<     * @throws XMLSecurityException
<     */
<    public CarriedKeyName getCarriedKeyName() throws XMLSecurityException {
< 
<       Element e =
<          XMLUtils.getDirectChild(this._constructionElement,
<                                  EncryptionConstants._TAG_CARRIEDKEYNAME,
<                                  EncryptionConstants.EncryptionSpecNS);
< 
<       if (e != null) {
<          return new CarriedKeyName(e, this._baseURI);
<       } else {
<          return null;
<       }
<    }
< 
<    /**
<     * Method getRecipient
<     *
<     * @return
<     */
<    public String getRecipient() {
<       return this._constructionElement
<          .getAttributeNS(null, EncryptionConstants._ATT_RECIPIENT);
<    }
< 
<    /**
<     * Method setRecipient
<     *
<     * @param recipient
<     */
<    public void setRecipient(String recipient) {
<       if (this._state == MODE_CREATE && recipient != null && recipient.length() > 0) {
<       this._constructionElement.setAttributeNS(null, EncryptionConstants._ATT_RECIPIENT,
<                                              recipient);
<       }
<    }
< 
<    /**
<     * Method getEncryptionMethod
<     *
<     * @return
<     * @throws XMLSecurityException
<     */
<    public EncryptionMethod getEncryptionMethod() throws XMLSecurityException {
< 
<       Element e =
<          XMLUtils.getDirectChild(this._constructionElement,
<                                  EncryptionConstants._TAG_ENCRYPTIONMETHOD,
<                                  EncryptionConstants.EncryptionSpecNS);
< 
<       if (e != null) {
<          return new EncryptionMethod(e, this._baseURI);
<       } else {
<          return null;
<       }
<    }
< 
<    /**
<     * Method getKeyInfo
<     *
<     * @return
<     * @throws XMLSecurityException
<     */
<    public KeyInfo getKeyInfo() throws XMLSecurityException {
< 
<       Element e = XMLUtils.getDirectChild(this._constructionElement,
<                                           Constants._TAG_KEYINFO,
<                                           Constants.SignatureSpecNS);
< 
<       if (e != null) {
<          return new KeyInfo(e, this._baseURI);
<       } else {
<          return null;
<       }
<    }
< 
<    /**
<     * Method getCipherData
<     *
<     * @return
<     * @throws XMLSecurityException
<     */
<    public CipherData getCipherData() throws XMLSecurityException {
< 
<       Element e = XMLUtils.getDirectChild(this._constructionElement,
<                                           EncryptionConstants._TAG_CIPHERDATA,
<                                           EncryptionConstants.EncryptionSpecNS);
< 
<       if (e != null) {
<          return new CipherData(e, this._baseURI);
<       } else {
<          return null;
<       }
<    }
< 
<    /**
<     * Method getEncryptionProperties
<     *
<     * @return
<     * @throws XMLSecurityException
<     */
<    public EncryptionProperties getEncryptionProperties()
<            throws XMLSecurityException {
< 
<       Element e =
<          XMLUtils.getDirectChild(this._constructionElement,
<                                  EncryptionConstants._TAG_ENCRYPTIONPROPERTIES,
<                                  EncryptionConstants.EncryptionSpecNS);
< 
<       if (e != null) {
<          return new EncryptionProperties(e, this._baseURI);
<       } else {
<          return null;
<       }
<    }
< 
<    /**
<     * Sets the <code>Id</code> attribute
<     *
<     * @param Id ID
<     */
<    public void setId(String Id) {
< 
<       if ((this._state == MODE_CREATE) && (Id != null) && (Id.length() != 0)) {
<          this._constructionElement.setAttributeNS(null, EncryptionConstants._ATT_ID,
<                                                 Id);
<          IdResolver.registerElementById(this._constructionElement, Id);
<       }
<    }
< 
<    /**
<     * Returns the <code>Id</code> attribute
<     *
<     * @return the <code>Id</code> attribute
<     */
<    public String getId() {
<       return this._constructionElement
<          .getAttributeNS(null, EncryptionConstants._ATT_ID);
<    }
< 
<    /**
<     * Sets the <code>Type</code> attribute
<     *
<     * @param Type
<     */
<    public void setType(String Type) {
< 
<       if ((this._state == MODE_CREATE) && (Type != null)) {
<          this._constructionElement.setAttributeNS(null, EncryptionConstants._ATT_TYPE,
<                                                 Type);
<       }
<    }
< 
<    /**
<     * Method getType
<     *
<     * @return
<     */
<    public String getType() {
<       return this._constructionElement
<          .getAttributeNS(null, EncryptionConstants._ATT_TYPE);
<    }
< 
<    /**
<     * Method getTypeIsElement
<     *
<     * @return
<     */
<    public boolean getTypeIsElement() {
< 
<       String type = this.getType();
< 
<       if ((type == null) || (type.length() == 0)) {
<          return false;
<       }
< 
<       return type.equals(EncryptionConstants.TYPE_ELEMENT);
<    }
< 
<    /**
<     * Method getTypeIsContent
<     *
<     * @return
<     */
<    public boolean getTypeIsContent() {
< 
<       String type = this.getType();
< 
<       if ((type == null) || (type.length() == 0)) {
<          return false;
<       }
< 
<       return type.equals(EncryptionConstants.TYPE_CONTENT);
<    }
< 
<    /**
<     * Method getTypeIsMediaType
<     *
<     * @return
<     */
<    public boolean getTypeIsMediaType() {
< 
<       String type = this.getType();
< 
<       if ((type == null) || (type.length() == 0)) {
<          return false;
<       }
< 
<       return type.startsWith(EncryptionConstants.TYPE_MEDIATYPE);
<    }
< 
<    /**
<     * Method getMediaTypeOfType
<     *
<     * @return
<     */
<    public String getMediaTypeOfType() {
< 
<       if (this.getTypeIsMediaType()) {
<          return this.getType()
<             .substring(EncryptionConstants.TYPE_MEDIATYPE.length());
<       }
< 
<       return null;
<    }
< 
<    /**
<     * Method getBaseLocalName
<     *
<     * @return
<     */
<    public String getBaseLocalName() {
<       return EncryptionConstants._TAG_ENCRYPTEDKEY;
<    }
< 
<    public Key unwrap(Key wrapKey, String wrappedKeyAlgoURI) throws XMLSecurityException {
<       byte[] wrappedKey = this.getCipherData().getCipherValue().getCipherText();
<       return this.getEncryptionMethod().unwrap(wrappedKey, wrapKey, wrappedKeyAlgoURI);
<    }
< 
<    /**
<     * Method main
<     *
<     * @param unused
<     * @throws Exception
<     */
<    public static void main(String unused[]) throws Exception {
< 
<       org.apache.xml.security.Init.init();
< 
<       javax.xml.parsers.DocumentBuilderFactory dbf =
<          javax.xml.parsers.DocumentBuilderFactory.newInstance();
< 
<       dbf.setNamespaceAware(true);
< 
<       javax.xml.parsers.DocumentBuilder db = dbf.newDocumentBuilder();
<       Document doc = db.newDocument();
<       EncryptionMethod em =
<          new EncryptionMethod(doc, EncryptionConstants.ALGO_ID_KEYWRAP_AES128);
<       Key wrapKey = em.createSecretKeyFromBytes(
<          org.apache.xml.security.utils.HexDump.hexStringToByteArray(
<             "00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f"));
<       Key contentKey = em.createSecretKeyFromBytes(
<          org.apache.xml.security.utils.HexDump.hexStringToByteArray(
<             "00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f"));
<       byte ciphertext[] = em.wrap(contentKey, wrapKey);
<       KeyInfo ki = new KeyInfo(doc);
< 
<       ki.add(new org.apache.xml.security.keys.content.KeyName(doc,
<               "Christian Geuer-Pollmann"));
< 
<       EncryptedKey ed = new EncryptedKey(doc, em, ki,
<                                          new CipherData(doc, ciphertext), null,
<                                          null, "Christian Geuer-Pollmann", "",
<                                          EncryptionConstants.TYPE_CONTENT,
<                                          "Ed Simon");
< 
<       doc.appendChild(ed.getElement());
<       org.apache.xml.security.utils.XMLUtils.outputDOMc14nWithComments(doc,
<               System.out);
< 
<       EncryptionMethod em2 = ed.getEncryptionMethod();
<       byte[] ciphertext2 = ed.getCipherData().getCipherValue().getCipherText();
<       Key decrypt = em2.createSecretKeyFromBytes(
<          org.apache.xml.security.utils.HexDump.hexStringToByteArray(
<             "00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f"));
<       Key unwrapped =
<          em2.unwrap(ciphertext2, wrapKey,
<                     EncryptionConstants.ALGO_ID_BLOCKCIPHER_AES128);
< 
<       System.out.println();
<       System.out.println();
<       System.out.println();
<       System.out.println("getTypeIsContent   " + ed.getTypeIsContent());
<       System.out.println("getTypeIsElement   " + ed.getTypeIsElement());
<       System.out.println("getMediaTypeOfType " + ed.getMediaTypeOfType());
<       System.out.println("Decrypted: '"
<                          + HexDump.byteArrayToHexString(unwrapped.getEncoded())
<                          + "'");
<       System.out
<          .println("Match: "
<                   + ed.getCarriedKeyName()
<                      .matchesAgainstKeyInfo(ed.getKeyInfo()));
<    }
---
> public interface EncryptedKey extends EncryptedType {
>     /**
>      * Returns a hint as to which recipient this encrypted key value is intended
>      * for.
>      *
>      * @return the recipient of the <code>EncryptedKey</code>.
>      */
>     String getRecipient();
> 
>     /**
>      * Sets the recipient for this <code>EncryptedKey</code>.
>      *
>      * @param recipient the recipient for this <code>EncryptedKey</code>.
>      */
>     void setRecipient(String recipient);
> 
>     /**
>      * Returns pointers to data and keys encrypted using this key. The reference
>      * list may contain multiple references to <code>EncryptedKey</code> and
>      * <code>EncryptedData</code> elements. This is done using
>      * <code>KeyReference</code> and <code>DataReference</code> elements
>      * respectively.
>      *
>      * @return an <code>Iterator</code> over all the <code>ReferenceList</code>s
>      *   contained in this <code>EncryptedKey</code>.
>      */
>     ReferenceList getReferenceList();
> 
>     /**
>      * Sets the <code>ReferenceList</code> to the <code>EncryptedKey</code>.
>      *
>      * @param list a list of pointers to data elements encrypted using this key.
>      */
>     void setReferenceList(ReferenceList list);
> 
>     /**
>      * Returns a user readable name with the key value. This may then be used to
>      * reference the key using the <code>ds:KeyName</code> element within
>      * <code>ds:KeyInfo</code>. The same <code>CarriedKeyName</code> label,
>      * unlike an ID type, may occur multiple times within a single document. The
>      * value of the key is to be the same in all <code>EncryptedKey</code>
>      * elements identified with the same <code>CarriedKeyName</code> label
>      * within a single XML document.
>      * <br>
>      * <b>Note</b> that because whitespace is significant in the value of
>      * the <code>ds:KeyName</code> element, whitespace is also significant in
>      * the value of the <code>CarriedKeyName</code> element.
>      *
>      * @return over all the carried names contained in
>      *   this <code>EncryptedKey</code>.
>      */
>     String getCarriedName();
> 
>     /**
>      * Sets the carried name.
>      *
>      * @param name the carried name.
>      */
>     void setCarriedName(String name);
693a109
> 
Only in xml-security-1_2_0/src/org/apache/xml/security/encryption: EncryptedType.java
Only in xml-security-1_2_0/src/org/apache/xml/security/encryption: EncryptionMethod.java
diff -r xml-security-orig-v1/src/org/apache/xml/security/encryption/EncryptionProperties.java xml-security-1_2_0/src/org/apache/xml/security/encryption/EncryptionProperties.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  2003-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
62,66c20
< 
< import org.w3c.dom.*;
< import org.apache.xml.security.exceptions.XMLSecurityException;
< import org.apache.xml.security.utils.EncryptionElementProxy;
< import org.apache.xml.security.utils.EncryptionConstants;
---
> import java.util.Iterator;
70c24,40
<  * This class maps to the <CODE>xenc:EncryptionProperties</CODE> element.
---
>  * <code>EncryptionProperties</code> can hold additional information concerning
>  * the generation of the <code>EncryptedData</code> or
>  * <code>EncryptedKey</code>. This information is wraped int an
>  * <code>EncryptionProperty</code> element. Examples of additional information
>  * is e.g., a date/time stamp or the serial number of cryptographic hardware
>  * used during encryption).
>  * <p>
>  * It is defined as follows:
>  * <xmp>
>  * <element name='EncryptionProperties' type='xenc:EncryptionPropertiesType'/>
>  * <complexType name='EncryptionPropertiesType'>
>  *     <sequence>
>  *         <element ref='xenc:EncryptionProperty' maxOccurs='unbounded'/>
>  *     </sequence>
>  *     <attribute name='Id' type='ID' use='optional'/>
>  * </complexType>
>  * </xmp>
72c42
<  * @author $Author: dohy $
---
>  * @author Axl Mattheus
74,142c44,80
< public class EncryptionProperties extends EncryptionElementProxy {
< 
<    /**
<     * Constructor EncryptionProperties
<     *
<     * @param doc
<     */
<    public EncryptionProperties(Document doc) {
<       super(doc);
<    }
< 
<    /**
<     * Constructor EncryptionProperties
<     *
<     * @param element
<     * @param BaseURI
<     * @throws XMLSecurityException
<     */
<    public EncryptionProperties(Element element, String BaseURI)
<            throws XMLSecurityException {
<       super(element, BaseURI);
<    }
< 
<    /**
<     * Method add
<     *
<     * @param encryptionProperty
<     */
<    public void add(EncryptionProperty encryptionProperty) {
<       ;
<    }
< 
<    /**
<     * Method getLength
<     *
<     * @return
<     */
<    public int getLength() {
< 
<       NodeList nl =
<          this._constructionElement
<             .getElementsByTagNameNS(EncryptionConstants.EncryptionSpecNS,
<                                     EncryptionConstants
<                                        ._TAG_ENCRYPTIONPROPERTIES);
< 
<       return nl.getLength();
<    }
< 
<    /**
<     * Method item
<     *
<     * @param i
<     * @return
<     * @throws XMLSecurityException
<     */
<    public EncryptionProperty item(int i) throws XMLSecurityException {
< 
<       NodeList nl =
<          this._constructionElement
<             .getElementsByTagNameNS(EncryptionConstants.EncryptionSpecNS,
<                                     EncryptionConstants
<                                        ._TAG_ENCRYPTIONPROPERTIES);
< 
<       return new EncryptionProperty((Element) nl.item(i), this._baseURI);
<    }
< 
<    public String getBaseLocalName() {
<       return EncryptionConstants._TAG_ENCRYPTIONPROPERTIES;
<    }
---
> public interface EncryptionProperties {
>     /**
>      * Returns the <code>EncryptionProperties</code>' id.
>      *
>      * @return the id.
>      */
>     String getId();
> 
>     /**
>      * Sets the id.
>      *
>      * @param id the id.
>      */
>     void setId(String id);
> 
>     /**
>      * Returns an <code>Iterator</code> over all the
>      * <code>EncryptionPropterty</code> elements contained in this
>      * <code>EncryptionProperties</code>.
>      *
>      * @return an <code>Iterator</code> over all the encryption properties.
>      */
>     Iterator getEncryptionProperties();
> 
>     /**
>      * Adds an <code>EncryptionProperty</code>.
>      *
>      * @param property.
>      */
>     void addEncryptionProperty(EncryptionProperty property);
> 
>     /**
>      * Removes the specified <code>EncryptionProperty</code>.
>      *
>      * @param property.
>      */
>     void removeEncryptionProperty(EncryptionProperty property);
143a82
> 
diff -r xml-security-orig-v1/src/org/apache/xml/security/encryption/EncryptionProperty.java xml-security-1_2_0/src/org/apache/xml/security/encryption/EncryptionProperty.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  2003-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
62,68c20,21
< 
< import org.w3c.dom.*;
< import org.apache.xml.security.exceptions.XMLSecurityException;
< import org.apache.xml.security.utils.EncryptionConstants;
< import org.apache.xml.security.utils.EncryptionElementProxy;
< import org.apache.xml.security.utils.IdResolver;
< 
---
> import java.util.Iterator;
> import org.w3c.dom.Element;
71c24,44
<  * This class maps to the <CODE>xenc:EncryptionProperty</CODE> element.
---
>  * Additional information items concerning the generation of the
>  * <code>EncryptedData</code> or <code>EncryptedKey</code> can be placed in an
>  * <code>EncryptionProperty</code> element (e.g., date/time stamp or the serial
>  * number of cryptographic hardware used during encryption). The Target
>  * attribute identifies the <code>EncryptedType</code> structure being
>  * described. anyAttribute permits the inclusion of attributes from the XML
>  * namespace to be included (i.e., <code>xml:space</code>,
>  * <code>xml:lang</code>, and <code>xml:base</code>).
>  * <p>
>  * It is defined as follows:
>  * <xmp>
>  * <element name='EncryptionProperty' type='xenc:EncryptionPropertyType'/>
>  * <complexType name='EncryptionPropertyType' mixed='true'>
>  *     <choice maxOccurs='unbounded'>
>  *         <any namespace='##other' processContents='lax'/>
>  *     </choice>
>  *     <attribute name='Target' type='anyURI' use='optional'/>
>  *     <attribute name='Id' type='ID' use='optional'/>
>  *     <anyAttribute namespace="http://www.w3.org/XML/1998/namespace"/>
>  * </complexType>
>  * </xmp>
73c46
<  * @author $Author: dohy $
---
>  * @author Axl Mattheus
75,147c48,114
< public class EncryptionProperty extends EncryptionElementProxy {
< 
<    /**
<     * Constructor EncryptionProperty
<     *
<     * @param doc
<     */
<    public EncryptionProperty(Document doc) {
<       super(doc);
<    }
< 
<    /**
<     * Constructor EncryptionProperty
<     *
<     * @param element
<     * @param BaseURI
<     * @throws XMLSecurityException
<     */
<    public EncryptionProperty(Element element, String BaseURI)
<            throws XMLSecurityException {
<       super(element, BaseURI);
<    }
< 
<    /**
<     * Sets the <code>Id</code> attribute
<     *
<     * @param Id ID
<     */
<    public void setId(String Id) {
< 
<       if ((this._state == MODE_CREATE) && (Id != null) && (Id.length() != 0)) {
<          this._constructionElement.setAttributeNS(null, EncryptionConstants._ATT_ID,
<                                                 Id);
<          IdResolver.registerElementById(this._constructionElement, Id);
<       }
<    }
< 
<    /**
<     * Returns the <code>Id</code> attribute
<     *
<     * @return the <code>Id</code> attribute
<     */
<    public String getId() {
<       return this._constructionElement
<          .getAttributeNS(null, EncryptionConstants._ATT_ID);
<    }
< 
<    /**
<     * Sets the <code>Target</code> attribute
<     *
<     * @param Target
<     */
<    public void setTarget(String Target) {
< 
<       if ((this._state == MODE_CREATE) && (Target != null)) {
<          this._constructionElement.setAttributeNS(null, EncryptionConstants._ATT_TARGET,
<                                                 Target);
<       }
<    }
< 
<    /**
<     * Returns the <code>Target</code> attribute
<     *
<     * @return the <code>Target</code> attribute
<     */
<    public String getTarget() {
<       return this._constructionElement
<          .getAttributeNS(null, EncryptionConstants._ATT_TARGET);
<    }
< 
<    public String getBaseLocalName() {
<       return EncryptionConstants._TAG_ENCRYPTIONPROPERTY;
<    }
---
> public interface EncryptionProperty {
>     /**
>      * Returns the <code>EncryptedType</code> being described.
>      *
>      * @return the <code>EncryptedType</code> being described by this
>      *   <code>EncryptionProperty</code>.
>      */
>     String getTarget();
> 
>     /**
>      * Sets the target.
>      *
>      * @param target.
>      */
>     void setTarget(String target);
> 
>     /**
>      * Returns the id of the <CODE>EncryptionProperty</CODE>.
>      *
>      * @return the id.
>      */
>     String getId();
> 
>     /**
>      * Sets the id.
>      *
>      * @param id.
>      */
>     void setId(String id);
> 
>     /**
>      * Returns the attribute's value in the <code>xml</code> namespace.
>      *
>      * @param attribute
>      * @return the attribute's value.
>      */
>     String getAttribute(String attribute);
> 
>     /**
>      * Set the attribute value.
>      *
>      * @param attribute the attribute's name.
>      * @param value the attribute's value.
>      */
>     void setAttribute(String attribute, String value);
> 
>     /**
>      * Returns the properties of the <CODE>EncryptionProperty</CODE>.
>      *
>      * @return an <code>Iterator</code> over all the addiitonal encryption
>      *   information contained in this class.
>      */
>     Iterator getEncryptionInformation();
> 
>     /**
>      * Adds encryption information.
>      *
>      * @param information the additional encryption information.
>      */
>     void addEncryptionInformation(Element information);
> 
>     /**
>      * Removes encryption information.
>      *
>      * @param information the information to remove.
>      */
>     void removeEncryptionInformation(Element information);
Only in xml-security-orig-v1/src/org/apache/xml/security/encryption: KeyReference.java
diff -r xml-security-orig-v1/src/org/apache/xml/security/encryption/package.html xml-security-1_2_0/src/org/apache/xml/security/encryption/package.html
1,3c1,25
< <HTML><HEAD></HEAD><BODY><P>
< classes which implement the <A HREF="http://www.w3.org/Encryption/2001/Drafts/xmlenc-core/">XML Encryption spec</A>.
< </P></BODY></HTML>
\ No newline at end of file
---
> <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
> <html>
> <head>
>   <title></title>
> </head>
> <body>
> Provides classes for implementing XML Encryption applications. There are two
> main families of classes in this package. The first group of classes is an
> XML Schema to Java mapping of &nbsp;the complex types and elements of the
> XML Encryption Schema as outllined at <a
>  href="http://www.w3.org/Encryption/2001/Drafts/xmlenc-core/">XML Encrtypyion
> Specification</a>. The second group of classes are used to perform encryption
> operations, and to manipulate the first group of classes. The most important
> classes in this second group is <code><a
>  href="file://./org/apache/xml/security/encryption/XMLCipher.html">XMLCipher</a></code>,
> <code><a
>  href="file://./org/apache/xml/security/encryption/XMLEncryptionFactory.html">XMLEncryptionFactory</a></code>
> and <code>XMLSerializer</code>. <code>XMLCipher</code> was designed to resemble
> <code>javax.crypto.Cipher</code>. The aforementioned classes were desinged
> with ease-of-use and configurability in mind. Becuase of this, the programmer
> may at times be exposed to lower level programming tasks. This library strives
> to be as simple as possible to use, but no simpler.<br>
> <br>
> </body>
> </html>
Only in xml-security-1_2_0/src/org/apache/xml/security/encryption: Reference.java
diff -r xml-security-orig-v1/src/org/apache/xml/security/encryption/ReferenceList.java xml-security-1_2_0/src/org/apache/xml/security/encryption/ReferenceList.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  2003-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
62,67c20
< 
< import org.w3c.dom.*;
< import org.apache.xml.security.exceptions.XMLSecurityException;
< import org.apache.xml.security.utils.EncryptionElementProxy;
< import org.apache.xml.security.utils.EncryptionConstants;
< import org.apache.xml.security.utils.XMLUtils;
---
> import java.util.Iterator;
71c24,38
<  * This class maps to the <CODE>xenc:ReferenceList</CODE> element.
---
>  * <code>ReferenceList</code> is an element that contains pointers from a key
>  * value of an <code>EncryptedKey</code> to items encrypted by that key value
>  * (<code>EncryptedData</code> or <code>EncryptedKey</code> elements).
>  * <p>
>  * It is defined as follows:
>  * <xmp>
>  * <element name='ReferenceList'>
>  *     <complexType>
>  *         <choice minOccurs='1' maxOccurs='unbounded'>
>  *             <element name='DataReference' type='xenc:ReferenceType'/>
>  *             <element name='KeyReference' type='xenc:ReferenceType'/>
>  *         </choice>
>  *     </complexType>
>  * </element>
>  * </xmp>
73c40,41
<  * @author $Author: dohy $
---
>  * @author Axl Mattheus
>  * @see Reference
75,164c43,102
< public class ReferenceList extends EncryptionElementProxy {
< 
<    /**
<     * Constructor ReferenceList
<     *
<     * @param doc
<     */
<    public ReferenceList(Document doc) {
< 
<       super(doc);
< 
<       XMLUtils.addReturnToElement(this._constructionElement);
<    }
< 
<    /**
<     * Constructor ReferenceList
<     *
<     * @param element
<     * @param BaseURI
<     * @throws XMLSecurityException
<     */
<    public ReferenceList(Element element, String BaseURI)
<            throws XMLSecurityException {
< 
<       super(element, BaseURI);
< 
<       XMLUtils.addReturnToElement(this._constructionElement);
<    }
< 
<    /**
<     * Method add
<     *
<     * @param dataReference
<     */
<    public void add(DataReference dataReference) {
<       this._constructionElement.appendChild(dataReference.getElement());
<       XMLUtils.addReturnToElement(this._constructionElement);
<    }
< 
<    /**
<     * Method add
<     *
<     * @param keyReference
<     */
<    public void add(KeyReference keyReference) {
<       this._constructionElement.appendChild(keyReference.getElement());
<       XMLUtils.addReturnToElement(this._constructionElement);
<    }
< 
<    /**
<     * Method getLengthDataReference
<     *
<     * @return
<     */
<    public int getLengthDataReference() {
<       return 0;
<    }
< 
<    /**
<     * Method getLengthKeyReference
<     *
<     * @return
<     */
<    public int getLengthKeyReference() {
<       return 0;
<    }
< 
<    /**
<     * Method itemDataReference
<     *
<     * @param i
<     * @return
<     */
<    public DataReference itemDataReference(int i) {
<       return null;
<    }
< 
<    /**
<     * Method itemKeyReference
<     *
<     * @param i
<     * @return
<     */
<    public KeyReference itemKeyReference(int i) {
<       return null;
<    }
< 
<    public String getBaseLocalName() {
<       return EncryptionConstants._TAG_REFERENCELIST;
<    }
---
> public interface ReferenceList {
> 	/** DATA TAG */
>     public static final int DATA_REFERENCE = 0x00000001;
>     /** KEY TAG */
>     public static final int KEY_REFERENCE  = 0x00000002;
> 
>     /**
>      * Adds a reference to this reference list.
>      *
>      * @param reference the reference to add.
>      * @throws IllegalAccessException if the <code>Reference</code> is not an
>      *   instance of <code>DataReference</code> or <code>KeyReference</code>.
>      */
>     public void add(Reference reference);
> 
>     /**
>      * Removes a reference from the <code>ReferenceList</code>.
>      *
>      * @param reference the reference to remove.
>      */
>     public void remove(Reference reference);
> 
>     /**
>      * Returns the size of the <code>ReferenceList</code>.
>      *
>      * @return the size of the <code>ReferenceList</code>.
>      */
>     public int size();
> 
>     /**
>      * Indicates if the <code>ReferenceList</code> is empty.
>      *
>      * @return <code><b>true</b></code> if the <code>ReferenceList</code> is
>      *     empty, else <code><b>false</b></code>.
>      */
>     public boolean isEmpty();
> 
>     /**
>      * Returns an <code>Iterator</code> over all the <code>Reference</code>s
>      * contatined in this <code>ReferenceList</code>.
>      *
>      * @return Iterator.
>      */
>     public Iterator getReferences();
> 
>     /**
>      * <code>DataReference</code> factory method. Returns a
>      * <code>DataReference</code>.
>      * @param uri
>      * @return
>      */
>     public Reference newDataReference(String uri);
> 
>     /**
>      * <code>KeyReference</code> factory method. Returns a
>      * <code>KeyReference</code>.
>      * @param uri
>      * @return
>      */
>     public Reference newKeyReference(String uri);
diff -r xml-security-orig-v1/src/org/apache/xml/security/encryption/Transforms.java xml-security-1_2_0/src/org/apache/xml/security/encryption/Transforms.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  2003-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,78d20
< import java.io.IOException;
< import javax.xml.transform.TransformerException;
< import org.w3c.dom.*;
< import org.apache.xml.security.c14n.CanonicalizationException;
< import org.apache.xml.security.c14n.InvalidCanonicalizerException;
< import org.apache.xml.security.exceptions.XMLSecurityException;
< import org.apache.xml.security.transforms.Transform;
< import org.apache.xml.security.transforms.InvalidTransformException;
< import org.apache.xml.security.transforms.TransformationException;
< import org.apache.xml.security.signature.XMLSignatureInput;
< import org.apache.xml.security.utils.EncryptionElementProxy;
< import org.apache.xml.security.utils.Constants;
< import org.apache.xml.security.utils.EncryptionConstants;
< import org.apache.xml.security.utils.XMLUtils;
< import org.apache.xpath.CachedXPathAPI;
< 
81,85c23,32
<  * This class maps to the <CODE><B>xenc</B>:ReferenceList</CODE> element. NOTE:
<  * this is physically the same as a {@link org.apache.xml.security.transforms.Transforms},
<  * but has different semantics. Using <CODE>ds:Transforms</CODE>, signer and
<  * verifier perform the same operations on the data. Using <CODE>xenc:Transforms</CODE>,
<  * encryptor and decryptor perform opposite operations.
---
>  * A container for <code>ds:Transform</code>s.
>  * <p>
>  * It is defined as follows:
>  * <xmp>
>  * <complexType name='TransformsType'>
>  *     <sequence>
>  *         <element ref='ds:Transform' maxOccurs='unbounded'/>
>  *     </sequence>
>  * </complexType>
>  * </xmp>
87c34,35
<  * @author $Author: dohy $
---
>  * @author Axl Mattheus
>  * @see org.apache.xml.security.encryption.CipherReference
89,247c37,67
< public class Transforms extends EncryptionElementProxy {
< 
<    /**
<     * Constructor Transforms
<     *
<     * @param doc
<     */
<    public Transforms(Document doc) {
< 
<       super(doc);
< 
<       XMLUtils.addReturnToElement(this._constructionElement);
<    }
< 
<    /**
<     * Consturcts {@link Transforms} from {@link Element} which is <code>Transforms</code> Element
<     *
<     * @param element  is <code>Transforms</code> element
<     * @param BaseURI the URI where the XML instance was stored
<     * @throws XMLSecurityException
<     */
<    public Transforms(Element element, String BaseURI)
<            throws XMLSecurityException {
< 
<       super(element, BaseURI);
< 
<       int numberOfTransformElems = this.getLength();
< 
<       if (numberOfTransformElems == 0) {
< 
<          // At least ont Transform element must be present. Bad.
<          Object exArgs[] = { "ds:" + Constants._TAG_TRANSFORM,
<                              "xenc:" + EncryptionConstants._TAG_TRANSFORMS };
< 
<          throw new XMLSecurityException("xml.WrongContent", exArgs);
<       }
<    }
< 
<    /**
<     * Adds the <code>Transform</code> with the specified <code>Transform algorithm URI</code>
<     *
<     * @param transformURI the URI form of transform that indicates which transformation is applied to data
<     * @throws TransformationException
<     */
<    public void addTransform(String transformURI)
<            throws TransformationException {
< 
<       try {
<          Transform transform = Transform.getInstance(this._doc, transformURI);
< 
<          this.addTransform(transform);
<       } catch (InvalidTransformException ex) {
<          throw new TransformationException("empty", ex);
<       }
<    }
< 
<    /**
<     * Adds the <code>Transform</code> with the specified <code>Transform algorithm URI</code>
<     *
<     * @param transformURI the URI form of transform that indicates which transformation is applied to data
<     * @param contextElement
<     * @throws TransformationException
<     * @see Transform#getInstance(Document doc, String algorithmURI, Element childElement)
<     */
<    public void addTransform(String transformURI, Element contextElement)
<            throws TransformationException {
< 
<       try {
<          Transform transform = Transform.getInstance(this._doc, transformURI,
<                                                      contextElement);
< 
<          this.addTransform(transform);
<       } catch (InvalidTransformException ex) {
<          throw new TransformationException("empty", ex);
<       }
<    }
< 
<    /**
<     * Adds the <code>Transform</code> with the specified <code>Transform algorithm URI</code>
<     *
<     * @param transformURI the URI form of transform that indicates which transformation is applied to data
<     * @param contextNodes
<     * @throws TransformationException
<     * @see Transform#getInstance(Document doc, String algorithmURI, NodeList contextNodes)
<     */
<    public void addTransform(String transformURI, NodeList contextNodes)
<            throws TransformationException {
< 
<       try {
<          Transform transform = Transform.getInstance(this._doc, transformURI,
<                                                      contextNodes);
< 
<          this.addTransform(transform);
<       } catch (InvalidTransformException ex) {
<          throw new TransformationException("empty", ex);
<       }
<    }
< 
<    /**
<     * Adds a user-provided Transform step.
<     *
<     * @param transform {@link Transform} object
<     */
<    private void addTransform(Transform transform) {
<       this._constructionElement.appendChild(transform.getElement());
<       XMLUtils.addReturnToElement(this._constructionElement);
<    }
< 
<    /**
<     * Applies all included <code>Transform</code>s to xmlSignatureInput and returns the result of these transformations.
<     *
<     * @param xmlSignatureInput the input for the <code>Transform</code>s
<     * @return the result of the <code>Transforms</code>
<     * @throws TransformationException
<     */
<    public XMLSignatureInput performDecryptionTransforms(
<            XMLSignatureInput xmlSignatureInput) throws TransformationException {
< 
<       try {
<          for (int i = 0; i < this.getLength(); i++) {
<             Transform t = this.item(i);
< 
<             xmlSignatureInput = t.performTransform(xmlSignatureInput);
<          }
< 
<          return xmlSignatureInput;
<       } catch (IOException ex) {
<          throw new TransformationException("empty", ex);
<       } catch (CanonicalizationException ex) {
<          throw new TransformationException("empty", ex);
<       } catch (InvalidCanonicalizerException ex) {
<          throw new TransformationException("empty", ex);
<       } catch (XMLSecurityException ex) {
<          throw new TransformationException("empty", ex);
<       }
<    }
< 
<    /**
<     * Return the nonnegative number of transformations.
<     *
<     * @return the number of transformations
<     */
<    public int getLength() {
<       return this.length(Constants.SignatureSpecNS, Constants._TAG_TRANSFORM);
<    }
< 
<    /**
<     * Return the <it>i</it><sup>th</sup> <code>{@link Transform}</code>.
<     * Valid <code>i</code> values are 0 to <code>{@link #getLength}-1</code>.
<     *
<     * @param i index of {@link Transform} to return
<     * @return the <it>i</it><sup>th</sup> transforms
<     * @throws XMLSecurityException
<     */
<    private Transform item(int i) throws XMLSecurityException {
< 
<       Element transformElem = this.getChildElementLocalName(i,
<                                  Constants.SignatureSpecNS,
<                                  Constants._TAG_TRANSFORM);
---
> public interface Transforms {
>     /**
>      * Returns an <code>Iterator</code> over all the transforms contained in
>      * this transform list.
>      *
>      * @return all transforms.
>      */
>     /* Iterator getTransforms(); */
> 
>     /**
>      * Adds a <code>ds:Transform</code> to the list of transforms.
>      *
>      * @param transform.
>      */
>     /* void addTransform(Transform transform); */
> 
>     /**
>      * Removes the specified transform.
>      *
>      * @param transform.
>      */
> 	/*    void removeTransform(Transform transform); */
> 
> 	/**
> 	 * Temporary method to turn the XMLEncryption Transforms class
> 	 * into a DS class.  The main logic is currently implemented in the
> 	 * DS class, so we need to get to get the base class.
> 	 * <p>
> 	 * <b>Note</b> This will be removed in future versions
>      * @return
> 	 */
249,254c69
<       if (transformElem == null) {
<          return null;
<       } else {
<          return new Transform(transformElem, this._baseURI);
<       }
<    }
---
> 	org.apache.xml.security.transforms.Transforms getDSTransforms();
256,258d70
<    public String getBaseLocalName() {
<       return EncryptionConstants._TAG_TRANSFORMS;
<    }
Only in xml-security-orig-v1/src/org/apache/xml/security/encryption: type
Only in xml-security-1_2_0/src/org/apache/xml/security/encryption: XMLCipherInput.java
Only in xml-security-1_2_0/src/org/apache/xml/security/encryption: XMLCipher.java
Only in xml-security-1_2_0/src/org/apache/xml/security/encryption: XMLCipherParameters.java
Only in xml-security-1_2_0/src/org/apache/xml/security/encryption: XMLEncryptionException.java
diff -r xml-security-orig-v1/src/org/apache/xml/security/exceptions/AlgorithmAlreadyRegisteredException.java xml-security-1_2_0/src/org/apache/xml/security/exceptions/AlgorithmAlreadyRegisteredException.java
1d0
< 
3,4c2
<  * The Apache Software License, Version 1.1
<  *
---
>  * Copyright  1999-2004 The Apache Software Foundation.
6,7c4,14
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights 
<  * reserved.
---
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
9,58d15
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer. 
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:  
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written 
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European 
<  * Commission in the <WebSig> project in the ISIS Programme. 
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
85c42
<     * @param msgID
---
>     * @param _msgID
87,88c44,45
<    public AlgorithmAlreadyRegisteredException(String msgID) {
<       super(msgID);
---
>    public AlgorithmAlreadyRegisteredException(String _msgID) {
>       super(_msgID);
94c51
<     * @param msgID
---
>     * @param _msgID
97,98c54,55
<    public AlgorithmAlreadyRegisteredException(String msgID, Object exArgs[]) {
<       super(msgID, exArgs);
---
>    public AlgorithmAlreadyRegisteredException(String _msgID, Object exArgs[]) {
>       super(_msgID, exArgs);
104,105c61,62
<     * @param msgID
<     * @param originalException
---
>     * @param _msgID
>     * @param _originalException
107,109c64,66
<    public AlgorithmAlreadyRegisteredException(String msgID,
<                                               Exception originalException) {
<       super(msgID, originalException);
---
>    public AlgorithmAlreadyRegisteredException(String _msgID,
>                                               Exception _originalException) {
>       super(_msgID, _originalException);
115c72
<     * @param msgID
---
>     * @param _msgID
117c74
<     * @param originalException
---
>     * @param _originalException
119,121c76,78
<    public AlgorithmAlreadyRegisteredException(String msgID, Object exArgs[],
<                                               Exception originalException) {
<       super(msgID, exArgs, originalException);
---
>    public AlgorithmAlreadyRegisteredException(String _msgID, Object exArgs[],
>                                               Exception _originalException) {
>       super(_msgID, exArgs, _originalException);
diff -r xml-security-orig-v1/src/org/apache/xml/security/exceptions/Base64DecodingException.java xml-security-1_2_0/src/org/apache/xml/security/exceptions/Base64DecodingException.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
81c39
<     * @param msgID
---
>     * @param _msgID
83,84c41,42
<    public Base64DecodingException(String msgID) {
<       super(msgID);
---
>    public Base64DecodingException(String _msgID) {
>       super(_msgID);
90c48
<     * @param msgID
---
>     * @param _msgID
93,94c51,52
<    public Base64DecodingException(String msgID, Object exArgs[]) {
<       super(msgID, exArgs);
---
>    public Base64DecodingException(String _msgID, Object exArgs[]) {
>       super(_msgID, exArgs);
100,101c58,59
<     * @param msgID
<     * @param originalException
---
>     * @param _msgID
>     * @param _originalException
103,105c61,63
<    public Base64DecodingException(String msgID,
<                                               Exception originalException) {
<       super(msgID, originalException);
---
>    public Base64DecodingException(String _msgID,
>                                               Exception _originalException) {
>       super(_msgID, _originalException);
111c69
<     * @param msgID
---
>     * @param _msgID
113c71
<     * @param originalException
---
>     * @param _originalException
115,117c73,75
<    public Base64DecodingException(String msgID, Object exArgs[],
<                                               Exception originalException) {
<       super(msgID, exArgs, originalException);
---
>    public Base64DecodingException(String _msgID, Object exArgs[],
>                                               Exception _originalException) {
>       super(_msgID, exArgs, _originalException);
diff -r xml-security-orig-v1/src/org/apache/xml/security/exceptions/package.html xml-security-1_2_0/src/org/apache/xml/security/exceptions/package.html
2c2
< general exceptions used by this library  
---
> general exceptions used by this library.
diff -r xml-security-orig-v1/src/org/apache/xml/security/exceptions/XMLSecurityException.java xml-security-1_2_0/src/org/apache/xml/security/exceptions/XMLSecurityException.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
65a24
> 
125c84
<     * @param msgID
---
>     * @param _msgID
127c86
<    public XMLSecurityException(String msgID) {
---
>    public XMLSecurityException(String _msgID) {
129c88
<       super(I18n.getExceptionMessage(msgID));
---
>       super(I18n.getExceptionMessage(_msgID));
131c90
<       this.msgID = msgID;
---
>       this.msgID = _msgID;
138c97
<     * @param msgID
---
>     * @param _msgID
141c100
<    public XMLSecurityException(String msgID, Object exArgs[]) {
---
>    public XMLSecurityException(String _msgID, Object exArgs[]) {
143c102
<       super(MessageFormat.format(I18n.getExceptionMessage(msgID), exArgs));
---
>       super(MessageFormat.format(I18n.getExceptionMessage(_msgID), exArgs));
145c104
<       this.msgID = msgID;
---
>       this.msgID = _msgID;
152c111
<     * @param originalException
---
>     * @param _originalException
154c113
<    public XMLSecurityException(Exception originalException) {
---
>    public XMLSecurityException(Exception _originalException) {
159,160c118,119
<             + originalException.getClass().getName() + " and message "
<             + originalException.getMessage());
---
>             + _originalException.getClass().getName() + " and message "
>             + _originalException.getMessage());
162c121
<       this.originalException = originalException;
---
>       this.originalException = _originalException;
168,169c127,128
<     * @param msgID
<     * @param originalException
---
>     * @param _msgID
>     * @param _originalException
171c130
<    public XMLSecurityException(String msgID, Exception originalException) {
---
>    public XMLSecurityException(String _msgID, Exception _originalException) {
173c132
<       super(I18n.getExceptionMessage(msgID, originalException));
---
>       super(I18n.getExceptionMessage(_msgID, _originalException));
175,176c134,135
<       this.msgID = msgID;
<       this.originalException = originalException;
---
>       this.msgID = _msgID;
>       this.originalException = _originalException;
182c141
<     * @param msgID
---
>     * @param _msgID
184c143
<     * @param originalException
---
>     * @param _originalException
186,187c145,146
<    public XMLSecurityException(String msgID, Object exArgs[],
<                                Exception originalException) {
---
>    public XMLSecurityException(String _msgID, Object exArgs[],
>                                Exception _originalException) {
189c148
<       super(MessageFormat.format(I18n.getExceptionMessage(msgID), exArgs));
---
>       super(MessageFormat.format(I18n.getExceptionMessage(_msgID), exArgs));
191,192c150,151
<       this.msgID = msgID;
<       this.originalException = originalException;
---
>       this.msgID = _msgID;
>       this.originalException = _originalException;
198c157
<     * @return
---
>     * @return the messageId
204,206c163,164
<       } else {
<          return msgID;
<       }
---
>       } 
>       return msgID;      
209,213c167
<    /**
<     * Method toString
<     *
<     * @return
<     */
---
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/Init.java xml-security-1_2_0/src/org/apache/xml/security/Init.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,74c21,25
< import java.io.*;
< import java.lang.reflect.Method;
< import java.util.*;
< import javax.xml.parsers.*;
< import org.apache.xpath.XPathAPI;
< import org.apache.xpath.compiler.FunctionTable;
< import org.apache.xpath.compiler.FuncLoader;
< import org.apache.xpath.functions.Function;
< import org.w3c.dom.*;
< import org.apache.xml.security.algorithms.encryption.EncryptionMethod;
< import org.apache.xml.security.algorithms.SignatureAlgorithm;
< import org.apache.xml.security.algorithms.encryption.EncryptionMethod;
---
> import java.io.InputStream;
> 
> import javax.xml.parsers.DocumentBuilder;
> import javax.xml.parsers.DocumentBuilderFactory;
> 
75a27
> import org.apache.xml.security.algorithms.SignatureAlgorithm;
77,78c29,30
< import org.apache.xml.security.transforms.params.XPathContainer;
< import org.apache.xml.security.exceptions.XMLSecurityException;
---
> import org.apache.xml.security.keys.KeyInfo;
> import org.apache.xml.security.keys.keyresolver.KeyResolver;
81c33,35
< import org.apache.xml.security.utils.*;
---
> import org.apache.xml.security.utils.I18n;
> import org.apache.xml.security.utils.PRNG;
> import org.apache.xml.security.utils.XMLUtils;
83,85c37,43
< import org.apache.xml.security.keys.KeyInfo;
< import org.apache.xml.security.keys.ContentHandlerAlreadyRegisteredException;
< import org.apache.xml.security.keys.keyresolver.KeyResolver;
---
> import org.apache.xpath.compiler.FuncLoader;
> import org.apache.xpath.compiler.FunctionTable;
> import org.apache.xpath.functions.Function;
> import org.w3c.dom.Attr;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.Node;
94c52
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
98,121c56,97
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(Init.class.getName());
< 
<    /** Field _initialized */
<    private static boolean _alreadyInitialized = false;
< 
<    /**
<     * Method isInitialized
<     *
<     * @return
<     */
<    public static final boolean isInitialized() {
<       return Init._alreadyInitialized;
<    }
< 
<    /**
<     * Method init
<     *
<     */
<    public synchronized static void init() {
< 
<       if (!_alreadyInitialized) {
<          _alreadyInitialized = true;
---
>     /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log =
>             org.apache.commons.logging.LogFactory.getLog(Init.class.getName());
> 
>     /** Field _initialized */
>     private static boolean _alreadyInitialized = false;
> 
>     /** The namespace for CONF file **/
>     public static final String CONF_NS="http://www.xmlsecurity.org/NS/#configuration";
> 
>     /**
>      * Method isInitialized
>      * @return true if the librairy is already initialized.
>      *
>      */
>     public static final boolean isInitialized() {
>         return Init._alreadyInitialized;
>     }
> 
>     /**
>      * Method init
>      *
>      */
>     public synchronized static void init() {
> 
>         if (_alreadyInitialized) {
>             return;
>         }
>         long XX_configure_i18n_end=0;
>         long XX_configure_reg_c14n_start=0;
>         long XX_configure_reg_c14n_end=0;
>         long XX_configure_reg_here_start=0;
>         long XX_configure_reg_jcemapper_end=0;
>         long XX_configure_reg_keyInfo_start=0;
>         long XX_configure_reg_keyResolver_end=0;
>         long XX_configure_reg_prefixes_start=0;
>         long XX_configure_reg_resourceresolver_start=0;
>         long XX_configure_reg_sigalgos_end=0;
>         long XX_configure_reg_transforms_end=0;
>         long XX_configure_reg_keyInfo_end=0;
>         long XX_configure_reg_keyResolver_start=0;
>         _alreadyInitialized = true;
123c99
<          try {
---
>         try {
138a115,116
>             // InputStream is = Class.forName("org.apache.xml.security.Init").getResourceAsStream("resource/config.xml");
>             String cfile = System.getProperty("org.apache.xml.security.resource.config");
140,141c118,120
<                Class.forName("org.apache.xml.security.Init")
<                   .getResourceAsStream("resource/config.xml");
---
>                     Class.forName("org.apache.xml.security.Init")
>                     .getResourceAsStream(cfile != null ? cfile : "resource/config.xml");
> 
144,238c123,124
<             Element context = doc.createElementNS(null, "nscontext");
< 
<             context.setAttributeNS(
<                Constants.NamespaceSpecNS, "xmlns:x",
<                "http://www.xmlsecurity.org/NS/#configuration");
<             context.setAttributeNS(Constants.NamespaceSpecNS, "xmlns:log4j",
<                                    "http://jakarta.apache.org/log4j/");
< 
<             long XX_configure_log4j_start = System.currentTimeMillis();
< 
<             {
< 
<                /* configure logging */
<                Element log4jElem = (Element) XPathAPI.selectSingleNode(doc,
<                                       "//log4j:configuration[1]", context);
< 
<                try {
<                   Attr logfile = (Attr) XPathAPI.selectSingleNode(
<                      log4jElem,
<                      "./x:appender[@name='STDOUT']/x:param[@name='File']/@value",
<                      context);
< 
<                   if (logfile != null) {
<                      String logFileName = logfile.getNodeValue();
<                      File f = new File(logFileName);
< 
<                      if (f.exists()) {
<                         f.delete();
<                      }
<                   }
<                } catch (Exception ex) {}
< 
<                org.apache.log4j.xml.DOMConfigurator.configure(log4jElem);
<                cat.info("Logging is working");
<                cat.info("Date: "
<                         + new Date(System.currentTimeMillis()).toString());
<                cat.info("Version: " + Version.getVersion());
<             }
< 
<             long XX_configure_log4j_end = System.currentTimeMillis();
<             long XX_configure_i18n_start = System.currentTimeMillis();
< 
<             {
< 
<                /* configure internationalization */
<                Attr langAttr = (Attr) XPathAPI.selectSingleNode(
<                   doc,
<                   "/x:Configuration/x:ResourceBundles/@defaultLanguageCode",
<                   context);
<                Attr countryAttr = (Attr) XPathAPI.selectSingleNode(
<                   doc,
<                   "/x:Configuration/x:ResourceBundles/@defaultCountryCode",
<                   context);
<                String languageCode = (langAttr == null)
<                                      ? null
<                                      : langAttr.getNodeValue();
<                String countryCode = (countryAttr == null)
<                                     ? null
<                                     : countryAttr.getNodeValue();
< 
<                I18n.init(languageCode, countryCode);
<             }
< 
<             long XX_configure_i18n_end = System.currentTimeMillis();
< 
<             /**
<              * Try to register our here() implementation as internal function.
<              */
<             long XX_configure_reg_here_start = System.currentTimeMillis();
< 
<             {
<                FunctionTable.installFunction("here", new FuncHere());
<                cat.debug(
<                   "Registered class " + FuncHere.class.getName()
<                   + " for XPath function 'here()' function in internal table");
< 
<                /* The following tweak by "Eric Olson" <ego@alum.mit.edu>
<                 * is to enable xml-security to play with JDK 1.4 which
<                 * unfortunately bundles an old version of Xalan
<                 */
<                FuncLoader funcHereLoader = new FuncHereLoader();
< 
<                for (int i = 0; i < FunctionTable.m_functions.length; i++) {
<                   FuncLoader loader = FunctionTable.m_functions[i];
< 
<                   if (loader != null) {
<                      cat.debug("Func " + i + " " + loader.getName());
< 
<                      if (loader.getName().equals(funcHereLoader.getName())) {
<                         FunctionTable.m_functions[i] = funcHereLoader;
<                      }
<                   }
<                }
<             }
< 
---
>             XX_configure_reg_here_start = System.currentTimeMillis();
>             registerHereFunction();
240c126,127
<             long XX_configure_reg_c14n_start = System.currentTimeMillis();
---
>             //CachedXPathAPI cx=new CachedXPathAPI();
>             long XX_configure_i18n_start = 0;
243c130,168
<                Canonicalizer.init();
---
>                 XX_configure_reg_keyInfo_start = System.currentTimeMillis();
>                 try {
>                     KeyInfo.init();
>                 } catch (Exception e) {
>                     e.printStackTrace();
> 
>                     throw e;
>                 }
>                 XX_configure_reg_keyInfo_end = System.currentTimeMillis();
>             }
> 
>             long XX_configure_reg_transforms_start=0;
>             long XX_configure_reg_jcemapper_start=0;
>             long XX_configure_reg_sigalgos_start=0;
>             long XX_configure_reg_resourceresolver_end=0;
>             long XX_configure_reg_prefixes_end=0;
>             Node config=doc.getFirstChild();
>             for (;config!=null;config=config.getNextSibling()) {
>                 if ("Configuration".equals(config.getLocalName())) {
>                     break;
>                 }
>             }
>             for (Node el=config.getFirstChild();el!=null;el=el.getNextSibling()) {
>                 if (!(el instanceof Element)) {
>                     continue;
>                 }
>                 String tag=el.getLocalName();
>                 if (tag.equals("ResourceBundles")){
>                     XX_configure_i18n_start = System.currentTimeMillis();
>                     Element resource=(Element)el;
>                     /* configure internationalization */
>                     Attr langAttr = resource.getAttributeNode("defaultLanguageCode");
>                     Attr countryAttr = resource.getAttributeNode("defaultCountryCode");
>                     String languageCode = (langAttr == null)
>                             ? null
>                                     : langAttr.getNodeValue();
>                     String countryCode = (countryAttr == null)
>                             ? null
>                                     : countryAttr.getNodeValue();
245,260c170,187
<                NodeList c14nElem = XPathAPI.selectNodeList(
<                   doc,
<                   "/x:Configuration/x:CanonicalizationMethods/x:CanonicalizationMethod",
<                   context);
< 
<                for (int i = 0; i < c14nElem.getLength(); i++) {
<                   String URI = ((Element) c14nElem.item(i)).getAttributeNS(null,
<                                   "URI");
<                   String JAVACLASS =
<                      ((Element) c14nElem.item(i)).getAttributeNS(null,
<                         "JAVACLASS");
<                   boolean registerClass = true;
< 
<                   try {
<                      Class c = Class.forName(JAVACLASS);
<                      Method methods[] = c.getMethods();
---
>                     I18n.init(languageCode, countryCode);
>                     XX_configure_i18n_end = System.currentTimeMillis();
>                 }
> 
>                 if (tag.equals("CanonicalizationMethods")){
>                     XX_configure_reg_c14n_start = System.currentTimeMillis();
>                     Canonicalizer.init();
>                     Element[] list=XMLUtils.selectNodes(el.getFirstChild(),CONF_NS,"CanonicalizationMethod");
> 
>                     for (int i = 0; i < list.length; i++) {
>                         String URI = list[i].getAttributeNS(null,
>                                 "URI");
>                         String JAVACLASS =
>                                 list[i].getAttributeNS(null,
>                                         "JAVACLASS");
>                         try {
>                             Class.forName(JAVACLASS);
>                             /*                     Method methods[] = c.getMethods();
267c194
<                            cat.debug(currMeth.getDeclaringClass());
---
>                            log.debug(currMeth.getDeclaringClass());
269,285c196,203
<                      }
<                   } catch (ClassNotFoundException e) {
<                      Object exArgs[] = { URI, JAVACLASS };
< 
<                      cat.fatal(I18n.translate("algorithm.classDoesNotExist",
<                                               exArgs));
< 
<                      registerClass = false;
<                   }
< 
<                   if (registerClass) {
<                      cat.debug("Canonicalizer.register(" + URI + ", "
<                                + JAVACLASS + ")");
<                      Canonicalizer.register(URI, JAVACLASS);
<                   }
<                }
<             }
---
>                      }*/
>                             if (log.isDebugEnabled()) {
>                                 log.debug("Canonicalizer.register(" + URI + ", "
>                                         + JAVACLASS + ")");
>                             }
>                             Canonicalizer.register(URI, JAVACLASS);
>                         } catch (ClassNotFoundException e) {
>                             Object exArgs[] = { URI, JAVACLASS };
287,288c205,232
<             long XX_configure_reg_c14n_end = System.currentTimeMillis();
<             long XX_configure_reg_transforms_start = System.currentTimeMillis();
---
>                             log.fatal(I18n.translate("algorithm.classDoesNotExist",
>                                     exArgs));
>                         }
>                     }
>                     XX_configure_reg_c14n_end = System.currentTimeMillis();
>                 }
> 
>                 if (tag.equals("TransformAlgorithms")){
>                     XX_configure_reg_transforms_start = System.currentTimeMillis();
>                     Transform.init();
> 
>                     Element[] tranElem = XMLUtils.selectNodes(el.getFirstChild(),CONF_NS,"TransformAlgorithm");
> 
>                     for (int i = 0; i < tranElem.length; i++) {
>                         String URI = tranElem[i].getAttributeNS(null,
>                                 "URI");
>                         String JAVACLASS =
>                                 tranElem[i].getAttributeNS(null,
>                                         "JAVACLASS");
>                         try {
>                             Class.forName(JAVACLASS);
>                             if (log.isDebugEnabled()) {
>                                 log.debug("Transform.register(" + URI + ", " + JAVACLASS
>                                         + ")");
>                             }
>                             Transform.register(URI, JAVACLASS);
>                         } catch (ClassNotFoundException e) {
>                             Object exArgs[] = { URI, JAVACLASS };
290,291c234,235
<             {
<                Transform.init();
---
>                             log.fatal(I18n.translate("algorithm.classDoesNotExist",
>                                     exArgs));
293,323c237,240
<                NodeList tranElem = XPathAPI.selectNodeList(
<                   doc,
<                   "/x:Configuration/x:TransformAlgorithms/x:TransformAlgorithm",
<                   context);
< 
<                for (int i = 0; i < tranElem.getLength(); i++) {
<                   String URI = ((Element) tranElem.item(i)).getAttributeNS(null,
<                                   "URI");
<                   String JAVACLASS =
<                      ((Element) tranElem.item(i)).getAttributeNS(null,
<                         "JAVACLASS");
<                   boolean registerClass = true;
< 
<                   try {
<                      Class c = Class.forName(JAVACLASS);
<                   } catch (ClassNotFoundException e) {
<                      Object exArgs[] = { URI, JAVACLASS };
< 
<                      cat.fatal(I18n.translate("algorithm.classDoesNotExist",
<                                               exArgs));
< 
<                      registerClass = false;
<                   }
< 
<                   if (registerClass) {
<                      cat.debug("Transform.register(" + URI + ", " + JAVACLASS
<                                + ")");
<                      Transform.register(URI, JAVACLASS);
<                   }
<                }
<             }
---
>                         }
>                     }
>                     XX_configure_reg_transforms_end = System.currentTimeMillis();
>                 }
325,326d241
<             long XX_configure_reg_transforms_end = System.currentTimeMillis();
<             long XX_configure_reg_jcemapper_start = System.currentTimeMillis();
328,330c243,247
<             {
<                Element jcemapperElem = (Element) XPathAPI.selectSingleNode(
<                   doc, "/x:Configuration/x:JCEAlgorithmMappings", context);
---
>                 if ("JCEAlgorithmMappings".equals(tag)){
>                     XX_configure_reg_jcemapper_start = System.currentTimeMillis();
>                     JCEMapper.init((Element)el);
>                     XX_configure_reg_jcemapper_end = System.currentTimeMillis();
>                 }
332,333d248
<                JCEMapper.init(jcemapperElem);
<             }
335,336d249
<             long XX_configure_reg_jcemapper_end = System.currentTimeMillis();
<             long XX_configure_reg_sigalgos_start = System.currentTimeMillis();
338,339c251,253
<             {
<                SignatureAlgorithm.providerInit();
---
>                 if (tag.equals("SignatureAlgorithms")){
>                     XX_configure_reg_sigalgos_start = System.currentTimeMillis();
>                     SignatureAlgorithm.providerInit();
341,358c255,256
<                NodeList sigElems = XPathAPI.selectNodeList(
<                   doc,
<                   "/x:Configuration/x:SignatureAlgorithms/x:SignatureAlgorithm",
<                   context);
< 
<                for (int i = 0; i < sigElems.getLength(); i++) {
<                   String URI = ((Element) sigElems.item(i)).getAttributeNS(null,
<                                   "URI");
<                   String JAVACLASS =
<                      ((Element) sigElems.item(i)).getAttributeNS(null,
<                         "JAVACLASS");
< 
<                   /** @todo handle registering */
<                   boolean registerClass = true;
< 
<                   try {
<                      Class c = Class.forName(JAVACLASS);
<                      Method methods[] = c.getMethods();
---
>                     Element[] sigElems = XMLUtils.selectNodes(el.getFirstChild(), CONF_NS,
>                             "SignatureAlgorithm");
360,361c258,263
<                      for (int j = 0; j < methods.length; j++) {
<                         Method currMeth = methods[j];
---
>                     for (int i = 0; i < sigElems.length; i++) {
>                         String URI = sigElems[i].getAttributeNS(null,
>                                 "URI");
>                         String JAVACLASS =
>                                 sigElems[i].getAttributeNS(null,
>                                         "JAVACLASS");
363,383c265
<                         if (currMeth.getDeclaringClass().getName()
<                                 .equals(JAVACLASS)) {
<                            cat.debug(currMeth.getDeclaringClass());
<                         }
<                      }
<                   } catch (ClassNotFoundException e) {
<                      Object exArgs[] = { URI, JAVACLASS };
< 
<                      cat.fatal(I18n.translate("algorithm.classDoesNotExist",
<                                               exArgs));
< 
<                      registerClass = false;
<                   }
< 
<                   if (registerClass) {
<                      cat.debug("SignatureAlgorithm.register(" + URI + ", "
<                                + JAVACLASS + ")");
<                      SignatureAlgorithm.register(URI, JAVACLASS);
<                   }
<                }
<             }
---
>                         /** $todo$ handle registering */
385,387c267,285
<             long XX_configure_reg_sigalgos_end = System.currentTimeMillis();
<             long XX_configure_reg_resourceresolver_start =
<                System.currentTimeMillis();
---
>                         try {
>                             Class.forName(JAVACLASS);
>                             //                    Method methods[] = c.getMethods();
> 
>                             //                     for (int j = 0; j < methods.length; j++) {
>                             //                        Method currMeth = methods[j];
>                             //
>                             //                        if (currMeth.getDeclaringClass().getName()
>                             //                                .equals(JAVACLASS)) {
>                             //                           log.debug(currMeth.getDeclaringClass());
>                             //                        }
>                             //                     }
>                             if (log.isDebugEnabled()) {
>                                 log.debug("SignatureAlgorithm.register(" + URI + ", "
>                                         + JAVACLASS + ")");
>                             }
>                             SignatureAlgorithm.register(URI, JAVACLASS);
>                         } catch (ClassNotFoundException e) {
>                             Object exArgs[] = { URI, JAVACLASS };
389,390c287,288
<             {
<                ResourceResolver.init();
---
>                             log.fatal(I18n.translate("algorithm.classDoesNotExist",
>                                     exArgs));
392,410c290,293
<                NodeList resolverElem = XPathAPI.selectNodeList(
<                   doc, "/x:Configuration/x:ResourceResolvers/x:Resolver",
<                   context);
< 
<                for (int i = 0; i < resolverElem.getLength(); i++) {
<                   String JAVACLASS =
<                      ((Element) resolverElem.item(i)).getAttributeNS(null,
<                         "JAVACLASS");
<                   String Description =
<                      ((Element) resolverElem.item(i)).getAttributeNS(null,
<                         "DESCRIPTION");
< 
<                   if ((Description != null) && (Description.length() > 0)) {
<                      cat.debug("Register Resolver: " + JAVACLASS + ": "
<                                + Description);
<                   } else {
<                      cat.debug("Register Resolver: " + JAVACLASS
<                                + ": For unknown purposes");
<                   }
---
>                         }
>                     }
>                     XX_configure_reg_sigalgos_end = System.currentTimeMillis();
>                 }
412,414d294
<                   ResourceResolver.register(JAVACLASS);
<                }
<             }
416,418d295
<             long XX_configure_reg_resourceresolver_end =
<                System.currentTimeMillis();
<             long XX_configure_reg_keyInfo_start = System.currentTimeMillis();
420,422c297,299
<             {
<                try {
<                   KeyInfo.init();
---
>                 if (tag.equals("ResourceResolvers")){
>                     XX_configure_reg_resourceresolver_start = System.currentTimeMillis();
>                     ResourceResolver.init();
424c301,302
<                   Init._contentHandlerHash = new HashMap(10);
---
>                     Element[]resolverElem = XMLUtils.selectNodes(el.getFirstChild(),CONF_NS,
>                             "Resolver");
426,437c304
<                   {
<                      NodeList keyElem = XPathAPI.selectNodeList(
<                         doc, "/x:Configuration/x:KeyInfo/x:ContentHandler",
<                         context);
< 
<                      for (int i = 0; i < keyElem.getLength(); i++) {
<                         String namespace =
<                            ((Element) keyElem.item(i)).getAttributeNS(null,
<                               "NAMESPACE");
<                         String localname =
<                            ((Element) keyElem.item(i)).getAttributeNS(null,
<                               "LOCALNAME");
---
>                     for (int i = 0; i < resolverElem.length; i++) {
439,440c306,322
<                            ((Element) keyElem.item(i)).getAttributeNS(null,
<                               "JAVACLASS");
---
>                                 resolverElem[i].getAttributeNS(null,
>                                         "JAVACLASS");
>                         String Description =
>                                 resolverElem[i].getAttributeNS(null,
>                                         "DESCRIPTION");
> 
>                         if ((Description != null) && (Description.length() > 0)) {
>                             if (log.isDebugEnabled()) {
>                                 log.debug("Register Resolver: " + JAVACLASS + ": "
>                                         + Description);
>                             }
>                         } else {
>                             if (log.isDebugEnabled()) {
>                                 log.debug("Register Resolver: " + JAVACLASS
>                                         + ": For unknown purposes");
>                             }
>                         }
442,450c324,327
<                         cat.debug("KeyInfoContent: " + namespace + " "
<                                   + localname + " " + JAVACLASS);
<                         Init.registerKeyInfoContentHandler(namespace,
<                                                            localname,
<                                                            JAVACLASS);
<                      }
<                   }
<                } catch (Exception e) {
<                   e.printStackTrace();
---
>                         ResourceResolver.register(JAVACLASS);
>                         XX_configure_reg_resourceresolver_end =
>                                 System.currentTimeMillis();
>                     }
452,454c329
<                   throw e;
<                }
<             }
---
>                 }
456,458d330
<             long XX_configure_reg_keyInfo_end = System.currentTimeMillis();
<             long XX_configure_reg_keyResolver_start =
<                System.currentTimeMillis();
460,461d331
<             {
<                KeyResolver.init();
463,464d332
<                NodeList resolverElem = XPathAPI.selectNodeList(
<                   doc, "/x:Configuration/x:KeyResolver/x:Resolver", context);
466,480d333
<                for (int i = 0; i < resolverElem.getLength(); i++) {
<                   String JAVACLASS =
<                      ((Element) resolverElem.item(i)).getAttributeNS(null,
<                         "JAVACLASS");
<                   String Description =
<                      ((Element) resolverElem.item(i)).getAttributeNS(null,
<                         "DESCRIPTION");
< 
<                   if ((Description != null) && (Description.length() > 0)) {
<                      cat.debug("Register Resolver: " + JAVACLASS + ": "
<                                + Description);
<                   } else {
<                      cat.debug("Register Resolver: " + JAVACLASS
<                                + ": For unknown purposes");
<                   }
482,484d334
<                   KeyResolver.register(JAVACLASS);
<                }
<             }
486,487c336,338
<             long XX_configure_reg_keyResolver_end = System.currentTimeMillis();
<             long XX_configure_reg_prefixes_start = System.currentTimeMillis();
---
>                 if (tag.equals("KeyResolver")){
>                     XX_configure_reg_keyResolver_start =System.currentTimeMillis();
>                     KeyResolver.init();
489,490c340,360
<             {
<                cat.debug("Now I try to bind prefixes:");
---
>                     Element[] resolverElem = XMLUtils.selectNodes(el.getFirstChild(), CONF_NS,"Resolver");
> 
>                     for (int i = 0; i < resolverElem.length; i++) {
>                         String JAVACLASS =
>                                 resolverElem[i].getAttributeNS(null,
>                                         "JAVACLASS");
>                         String Description =
>                                 resolverElem[i].getAttributeNS(null,
>                                         "DESCRIPTION");
> 
>                         if ((Description != null) && (Description.length() > 0)) {
>                             if (log.isDebugEnabled()) {
>                                 log.debug("Register Resolver: " + JAVACLASS + ": "
>                                         + Description);
>                             }
>                         } else {
>                             if (log.isDebugEnabled()) {
>                                 log.debug("Register Resolver: " + JAVACLASS
>                                         + ": For unknown purposes");
>                             }
>                         }
492,505c362,388
<                NodeList nl = XPathAPI.selectNodeList(
<                   doc, "/x:Configuration/x:PrefixMappings/x:PrefixMapping",
<                   context);
< 
<                for (int i = 0; i < nl.getLength(); i++) {
<                   String namespace = ((Element) nl.item(i)).getAttributeNS(null,
<                                         "namespace");
<                   String prefix = ((Element) nl.item(i)).getAttributeNS(null,
<                                      "prefix");
< 
<                   cat.debug("Now I try to bind " + prefix + " to " + namespace);
<                   org.apache.xml.security.utils.ElementProxy
<                      .setDefaultPrefix(namespace, prefix);
<                }
---
>                         KeyResolver.register(JAVACLASS);
>                     }
>                     XX_configure_reg_keyResolver_end = System.currentTimeMillis();
>                 }
> 
> 
>                 if (tag.equals("PrefixMappings")){
>                     XX_configure_reg_prefixes_start = System.currentTimeMillis();
>                     if (log.isDebugEnabled()) {
>                         log.debug("Now I try to bind prefixes:");
>                     }
> 
>                     Element[] nl = XMLUtils.selectNodes(el.getFirstChild(), CONF_NS,"PrefixMapping");
> 
>                     for (int i = 0; i < nl.length; i++) {
>                         String namespace = nl[i].getAttributeNS(null,
>                                 "namespace");
>                         String prefix = nl[i].getAttributeNS(null,
>                                 "prefix");
>                         if (log.isDebugEnabled()) {
>                             log.debug("Now I try to bind " + prefix + " to " + namespace);
>                         }
>                         org.apache.xml.security.utils.ElementProxy
>                         .setDefaultPrefix(namespace, prefix);
>                     }
>                     XX_configure_reg_prefixes_end = System.currentTimeMillis();
>                 }
508,523d390
<             long XX_configure_reg_prefixes_end = System.currentTimeMillis();
<             //J-
<             long XX_configure_reg_encryption_start = System.currentTimeMillis();
<             EncryptionMethod.providerInit();
<             EncryptionMethod.register(EncryptionConstants.ALGO_ID_KEYWRAP_TRIPLEDES,     "org.apache.xml.security.algorithms.encryption.implementations.BC.KeyWrapImpl_TRIPLEDES_BC");
<             EncryptionMethod.register(EncryptionConstants.ALGO_ID_KEYWRAP_AES128,        "org.apache.xml.security.algorithms.encryption.implementations.BC.KeyWrapImpl_AES128_BC");
<             EncryptionMethod.register(EncryptionConstants.ALGO_ID_KEYWRAP_AES192,        "org.apache.xml.security.algorithms.encryption.implementations.BC.KeyWrapImpl_AES192_BC");
<             EncryptionMethod.register(EncryptionConstants.ALGO_ID_KEYWRAP_AES256,        "org.apache.xml.security.algorithms.encryption.implementations.BC.KeyWrapImpl_AES256_BC");
<             EncryptionMethod.register(EncryptionConstants.ALGO_ID_BLOCKCIPHER_TRIPLEDES, "org.apache.xml.security.algorithms.encryption.implementations.BC.BlockEncryptionImpl_TRIPLEDES_BC");
<             EncryptionMethod.register(EncryptionConstants.ALGO_ID_BLOCKCIPHER_AES128,    "org.apache.xml.security.algorithms.encryption.implementations.BC.BlockEncryptionImpl_AES128_BC");
<             EncryptionMethod.register(EncryptionConstants.ALGO_ID_BLOCKCIPHER_AES192,    "org.apache.xml.security.algorithms.encryption.implementations.BC.BlockEncryptionImpl_AES192_BC");
<             EncryptionMethod.register(EncryptionConstants.ALGO_ID_BLOCKCIPHER_AES256,    "org.apache.xml.security.algorithms.encryption.implementations.BC.BlockEncryptionImpl_AES256_BC");
<             EncryptionMethod.register(EncryptionConstants.ALGO_ID_KEYTRANSPORT_RSAOAEP,  "org.apache.xml.security.algorithms.encryption.implementations.BC.KeyTransportImpl_RSAOAEP_BC");
<             EncryptionMethod.register(EncryptionConstants.ALGO_ID_KEYTRANSPORT_RSA15,    "org.apache.xml.security.algorithms.encryption.implementations.BC.KeyTransportImpl_RSAPKCS15_BC");
<             long XX_configure_reg_encryption_end = System.currentTimeMillis();
<             //J+
527,544c394,410
<             cat.debug("XX_init                             " + ((int)(XX_init_end - XX_init_start)) + " ms");
<             cat.debug("  XX_configure_reg_encryption       " + ((int)(XX_configure_reg_encryption_end- XX_configure_reg_encryption_start)) + " ms");
<             cat.debug("  XX_prng                           " + ((int)(XX_prng_end - XX_prng_start)) + " ms");
<             cat.debug("  XX_parsing                        " + ((int)(XX_parsing_end - XX_parsing_start)) + " ms");
<             cat.debug("  XX_configure_i18n                 " + ((int)(XX_configure_i18n_end- XX_configure_i18n_start)) + " ms");
<             cat.debug("  XX_configure_log4j                " + ((int)(XX_configure_log4j_end- XX_configure_log4j_start)) + " ms");
<             cat.debug("  XX_configure_reg_c14n             " + ((int)(XX_configure_reg_c14n_end- XX_configure_reg_c14n_start)) + " ms");
<             cat.debug("  XX_configure_reg_here             " + ((int)(XX_configure_reg_here_end- XX_configure_reg_here_start)) + " ms");
<             cat.debug("  XX_configure_reg_jcemapper        " + ((int)(XX_configure_reg_jcemapper_end- XX_configure_reg_jcemapper_start)) + " ms");
<             cat.debug("  XX_configure_reg_keyInfo          " + ((int)(XX_configure_reg_keyInfo_end- XX_configure_reg_keyInfo_start)) + " ms");
<             cat.debug("  XX_configure_reg_keyResolver      " + ((int)(XX_configure_reg_keyResolver_end- XX_configure_reg_keyResolver_start)) + " ms");
<             cat.debug("  XX_configure_reg_prefixes         " + ((int)(XX_configure_reg_prefixes_end- XX_configure_reg_prefixes_start)) + " ms");
<             cat.debug("  XX_configure_reg_resourceresolver " + ((int)(XX_configure_reg_resourceresolver_end- XX_configure_reg_resourceresolver_start)) + " ms");
<             cat.debug("  XX_configure_reg_sigalgos         " + ((int)(XX_configure_reg_sigalgos_end- XX_configure_reg_sigalgos_start)) + " ms");
<             cat.debug("  XX_configure_reg_transforms       " + ((int)(XX_configure_reg_transforms_end- XX_configure_reg_transforms_start)) + " ms");
<             //J+
<          } catch (Exception e) {
<             cat.fatal("Bad: ", e);
---
>             if (log.isDebugEnabled()) {
>                 log.error("XX_init                             " + ((int)(XX_init_end - XX_init_start)) + " ms");
>                 log.error("  XX_prng                           " + ((int)(XX_prng_end - XX_prng_start)) + " ms");
>                 log.error("  XX_parsing                        " + ((int)(XX_parsing_end - XX_parsing_start)) + " ms");
>                 log.error("  XX_configure_i18n                 " + ((int)(XX_configure_i18n_end- XX_configure_i18n_start)) + " ms");
>                 log.error("  XX_configure_reg_c14n             " + ((int)(XX_configure_reg_c14n_end- XX_configure_reg_c14n_start)) + " ms");
>                 log.error("  XX_configure_reg_here             " + ((int)(XX_configure_reg_here_end- XX_configure_reg_here_start)) + " ms");
>                 log.error("  XX_configure_reg_jcemapper        " + ((int)(XX_configure_reg_jcemapper_end- XX_configure_reg_jcemapper_start)) + " ms");
>                 log.error("  XX_configure_reg_keyInfo          " + ((int)(XX_configure_reg_keyInfo_end- XX_configure_reg_keyInfo_start)) + " ms");
>                 log.error("  XX_configure_reg_keyResolver      " + ((int)(XX_configure_reg_keyResolver_end- XX_configure_reg_keyResolver_start)) + " ms");
>                 log.error("  XX_configure_reg_prefixes         " + ((int)(XX_configure_reg_prefixes_end- XX_configure_reg_prefixes_start)) + " ms");
>                 log.error("  XX_configure_reg_resourceresolver " + ((int)(XX_configure_reg_resourceresolver_end- XX_configure_reg_resourceresolver_start)) + " ms");
>                 log.error("  XX_configure_reg_sigalgos         " + ((int)(XX_configure_reg_sigalgos_end- XX_configure_reg_sigalgos_start)) + " ms");
>                 log.error("  XX_configure_reg_transforms       " + ((int)(XX_configure_reg_transforms_end- XX_configure_reg_transforms_start)) + " ms");
>             }
>         } catch (Exception e) {
>             log.fatal("Bad: ", e);
546,635c412,415
<          }
<       }
<    }
< 
<    /**
<     * This method customizes the library with user supplied configuration.
<     * This includes access to keystores etc.
<     * By default, this method tries to find the configurationfile in
<     * the System.getProperty("user.home") directory.
<     *
<     * @throws XMLSecurityException
<     */
<    public static void readUserConfiguration() throws XMLSecurityException {
< 
<       try {
<          String filename = System.getProperty("user.home") + "/"
<                            + Constants.configurationFileNew;
<          InputStream is = new FileInputStream(filename);
< 
<          Init.readUserConfiguration(is);
<       } catch (IOException ex) {
<          throw new XMLSecurityException("generic.EmptyMessage", ex);
<       }
<    }
< 
<    /**
<     * This method customizes the library with user supplied configuration.
<     * This includes access to keystores etc.
<     *
<     * @param fileURI
<     * @throws XMLSecurityException
<     */
<    public static void readUserConfiguration(String fileURI)
<            throws XMLSecurityException {
< 
<       try {
<          InputStream is = null;
< 
<          // first try to interpret fileURI as filename in the local file system
<          File f = new File(fileURI);
< 
<          if (f.exists()) {
<             is = new FileInputStream(f);
<          } else {
< 
<             // then treat it as USI
<             is = new java.net.URL(fileURI).openStream();
<          }
< 
<          Init.readUserConfiguration(is);
<       } catch (IOException ex) {
<          throw new XMLSecurityException("generic.EmptyMessage", ex);
<       }
<    }
< 
<    /**
<     * Method readUserConfiguration
<     *
<     * @param is
<     * @throws XMLSecurityException
<     */
<    public static void readUserConfiguration(InputStream is)
<            throws XMLSecurityException {
< 
<       try {
< 
<          /* read library configuration file */
<          DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
< 
<          dbf.setNamespaceAware(true);
<          dbf.setValidating(false);
< 
<          DocumentBuilder db = dbf.newDocumentBuilder();
<          Document doc = db.parse(is);
<          Element context = XMLUtils.createDSctx(
<             doc, "x", "http://www.xmlsecurity.org/NS/#configuration");
< 
<          {
<             NodeList nl =
<                XPathAPI.selectNodeList(doc, "/x:AppConfiguration/x:KeyStore",
<                                        context);
< 
<             for (int i = 0; i < nl.getLength(); i++) {
<                Element e = (Element) nl.item(i);
<                String URI = e.getAttributeNS(null, "URI");
<                String keyStoreType = e.getAttributeNS(null, "Type");
<                String defaultKeyAlias = e.getAttributeNS(null,
<                                                          "DefaultKeyAlias");
<                String storePass = e.getAttributeNS(null, "StorePass");
<                String KeyPass = e.getAttributeNS(null, "KeyPass");
---
>         }
> 
>     }
> 
637c417,429
<                // org.apache.xml.security.keys.keyStorage.KeyStorage.registerStore(URI, JAVACLASS, LOCATION, DEFAULTKEYOBJECT, CONTEXT);
---
> 
>     /**
>      * 
>      */
>     private static void registerHereFunction() {
>         /**
>          * Try to register our here() implementation as internal function.
>          */
>         {
>             FunctionTable.installFunction("here", new FuncHere());
>             if (log.isDebugEnabled()) {
>                 log.debug("Registered class " + FuncHere.class.getName()
>                         + " for XPath function 'here()' function in internal table");
639,779c431,527
<          }
<       } catch (Exception ex) {
<          throw new XMLSecurityException("generic.EmptyMessage", ex);
<       }
<    }
< 
<    /** Field _contentHandlerHash */
<    public static HashMap _contentHandlerHash;
< 
<    /**
<     * Method registerKeyinfoContentHandler
<     *
<     * @param namespace
<     * @param localname
<     * @param implementingClass
<     * @throws ContentHandlerAlreadyRegisteredException
<     */
<    public static void registerKeyInfoContentHandler(
<            String namespace, String localname, String implementingClass)
<               throws ContentHandlerAlreadyRegisteredException {
< 
<       String namespacequali = Init.qualifyNamespace(namespace, localname);
< 
<       // are we already registered?
<       if (Init._contentHandlerHash.containsKey(namespacequali)) {
<          cat.error("Already registered");
< 
<          Object exArgs[] = { namespacequali,
<                              ((String) Init._contentHandlerHash
<                                 .get(namespacequali)) };
< 
<          throw new ContentHandlerAlreadyRegisteredException(
<             "algorithm.alreadyRegistered", exArgs);
<       }
< 
<       synchronized (Init._contentHandlerHash) {
<          Init._contentHandlerHash.put(namespacequali, implementingClass);
<          cat.debug("Init._contentHandlerHash.put(\"" + namespacequali
<                    + "\", \"" + implementingClass + "\")");
<          cat.debug("Init._contentHandlerHash.size()="
<                    + Init._contentHandlerHash.size());
<       }
<    }
< 
<    /**
<     * Method qualifyNamespace
<     *
<     * @param namespace
<     * @param localname
<     * @return
<     */
<    private static String qualifyNamespace(String namespace, String localname) {
<       return "{" + namespace + "}" + localname;
<    }
< 
<    /**
<     * Method getContentHandlerClass
<     *
<     * @param namespace
<     * @param localname
<     * @return
<     */
<    public static String getKeyInfoContentHandler(String namespace,
<            String localname) {
< 
<       /*
<       Iterator i = KeyInfo._contentHandlerHash.keySet().iterator();
<       while (i.hasNext()) {
<          String key = (String) i.next();
<          if (key.equals(URI)) {
<             return (String) KeyInfo._contentHandlerHash.get(key);
<          }
<       }
<       return null;
<       */
<       String namespacequali = Init.qualifyNamespace(namespace, localname);
< 
<       cat.debug("Asked for handler for " + namespacequali);
< 
<       if (Init._contentHandlerHash == null) {
<          cat.debug("But I can't help (hash==null) ");
< 
<          return null;
<       }
< 
<       if (Init._contentHandlerHash.size() == 0) {
<          cat.debug("But I can't help (size()==0)");
< 
<          return null;
<       }
< 
<       Set keyset = Init._contentHandlerHash.keySet();
<       Iterator i = keyset.iterator();
< 
<       while (i.hasNext()) {
<          String key = (String) i.next();
< 
<          if (key.equals(namespacequali)) {
<             return (String) Init._contentHandlerHash.get(key);
<          }
<       }
< 
<       return null;
<    }
< 
<    /**
<     * Class FuncHereLoader
<     *
<     * @author $Author: dohy $
<     * @version $Revision: 1.1.1.1 $
<     */
<    public static class FuncHereLoader extends FuncLoader {
< 
<       /**
<        * Constructor FuncHereLoader
<        *
<        */
<       public FuncHereLoader() {
<          super(FuncHere.class.getName(), 0);
<       }
< 
<       /**
<        * Method getFunction
<        *
<        * @return
<        * @throws javax.xml.transform.TransformerException
<        */
<       public Function getFunction()
<               throws javax.xml.transform.TransformerException {
<          return new FuncHere();
<       }
< 
<       /**
<        * Method getName
<        *
<        * @return
<        */
<       public String getName() {
<          return FuncHere.class.getName();
<       }
<    }
---
> 
>             /* The following tweak by "Eric Olson" <ego@alum.mit.edu>
>              * is to enable xml-security to play with JDK 1.4 which
>              * unfortunately bundles an old version of Xalan
>              */
>             FuncLoader funcHereLoader = new FuncHereLoader();
> 
>             try {
>                 java.lang.reflect.Field mFunctions = FunctionTable.class.getField("m_functions");
>                 FuncLoader[] m_functions = (FuncLoader[]) mFunctions.get(null);
> 
>                 for (int i = 0; i < m_functions.length; i++) {
>                     FuncLoader loader = m_functions[i];
> 
>                     if (loader != null) {
>                         if (log.isDebugEnabled()) {
>                             log.debug("Func " + i + " " + loader.getName());
>                         }
> 
>                         if (loader.getName().equals(funcHereLoader.getName())) {
>                             m_functions[i] = funcHereLoader;
>                         }
>                     }
>                 }
>             } catch (java.lang.NoSuchFieldException e) {
>                 log.info("Unable to patch xalan function table.", e);
>             } catch (Exception e) {
>                 log.info("Unable to patch xalan function table.", e);
>             }
>         }
>     }
> 
> 
> 
>     /**
>      * Class FuncHereLoader
>      *
>      * @author $Author: raul $
>      * @version $Revision: 1.29 $
>      */
>     public static class FuncHereLoader extends FuncLoader {
> 
>         /**
>          * Constructor FuncHereLoader
>          *
>          */
>         public FuncHereLoader() {
>             super(FuncHere.class.getName(), 0);
>         }
> 
>         /**
>          * Method getFunction
>          * @return  a New function
>          */
>         @Override
>         public Function getFunction() {
>             return new FuncHere();
>         }
> 
>         /**
>          * Method getName
>          * @return  the name of the class.
>          *
>          */
>         @Override
>         public String getName() {
>             return FuncHere.class.getName();
>         }
>     }
> 
> 
> 
>     public static void readUserConfiguration(String string) {
>         // TODO Auto-generated method stub
> 
>     }
> 
>     public static String getKeyInfoContentHandler(String string, String string2) {
>         // TODO Auto-generated method stub
>         return null;
>     }
> 
>     public static void registerKeyInfoContentHandler(String string,
>             String string2, String string3) {
>         // TODO Auto-generated method stub
> 
>     }
> 
>     public static void readUserConfiguration() {
>         // TODO Auto-generated method stub
> 
>     }
> 
>     public static void readUserConfiguration(InputStream var6) {
>         // TODO Auto-generated method stub
> 
>     }
780a529
> 
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/content/KeyInfoContent.java xml-security-1_2_0/src/org/apache/xml/security/keys/content/KeyInfoContent.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights 
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer. 
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:  
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written 
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European 
<  * Commission in the <WebSig> project in the ISIS Programme. 
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64d21
< import org.w3c.dom.*;
70c27
<  * @author $Author: dohy $
---
>  * @author $Author: blautenb $
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/content/KeyName.java xml-security-1_2_0/src/org/apache/xml/security/keys/content/KeyName.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,67d20
< import java.util.StringTokenizer;
< import org.w3c.dom.*;
< import org.apache.xpath.XPathAPI;
< import javax.xml.transform.TransformerException;
< import org.apache.xml.security.utils.*;
68a22,25
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
73c30
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
77,79c34,36
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(KeyName.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(KeyName.class.getName());
109d65
<     * @throws XMLSecurityException
111c67
<    public String getKeyName() throws XMLSecurityException {
---
>    public String getKeyName() {
114a71
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/content/KeyValue.java xml-security-1_2_0/src/org/apache/xml/security/keys/content/KeyValue.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,70c21,23
< import java.security.*;
< import java.security.spec.*;
< import java.util.*;
< import org.w3c.dom.*;
< import org.apache.xpath.XPathAPI;
< import javax.xml.transform.TransformerException;
< import org.apache.xml.security.keys.content.keyvalues.*;
< import org.apache.xml.security.utils.*;
---
> import java.security.PublicKey;
> 
> 
71a25,32
> import org.apache.xml.security.keys.content.keyvalues.DSAKeyValue;
> import org.apache.xml.security.keys.content.keyvalues.RSAKeyValue;
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.JavaUtils;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
81c42
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
85,87c46,48
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(KeyValue.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(KeyValue.class.getName());
147,148c108,109
<               (Object) pk, "java.security.interfaces.DSAPublicKey")) {
<          DSAKeyValue dsa = new DSAKeyValue(this._doc, (Key) pk);
---
>               pk, "java.security.interfaces.DSAPublicKey")) {
>          DSAKeyValue dsa = new DSAKeyValue(this._doc, pk);
153,154c114,115
<               (Object) pk, "java.security.interfaces.RSAPublicKey")) {
<          RSAKeyValue rsa = new RSAKeyValue(this._doc, (Key) pk);
---
>               pk, "java.security.interfaces.RSAPublicKey")) {
>          RSAKeyValue rsa = new RSAKeyValue(this._doc, pk);
181,190c142,147
<       try {
<          Element nscontext = XMLUtils.createDSctx(this._doc, "ds",
<                                                   Constants.SignatureSpecNS);
<          NodeList rsa =
<             XPathAPI.selectNodeList(this._constructionElement,
<                                     "./ds:" + Constants._TAG_RSAKEYVALUE,
<                                     nscontext);
< 
<          if (rsa.getLength() > 0) {
<             RSAKeyValue kv = new RSAKeyValue((Element) rsa.item(0),
---
>       
>          Element rsa = XMLUtils.selectDsNode(this._constructionElement,
>          				Constants._TAG_RSAKEYVALUE,0);
>          
>          if (rsa != null) {
>             RSAKeyValue kv = new RSAKeyValue(rsa,
196,199c153,155
<          NodeList dsa =
<             XPathAPI.selectNodeList(this._constructionElement,
<                                     "./ds:" + Constants._TAG_DSAKEYVALUE,
<                                     nscontext);
---
>          Element dsa = XMLUtils.selectDsNode(this._constructionElement,
>          		 Constants._TAG_DSAKEYVALUE,0);
>             
201,202c157,158
<          if (dsa.getLength() > 0) {
<             DSAKeyValue kv = new DSAKeyValue((Element) dsa.item(0),
---
>          if (dsa != null) {
>             DSAKeyValue kv = new DSAKeyValue(dsa,
207c163
<       } catch (TransformerException ex) {}
---
>       
211a168
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/content/keyvalues/DSAKeyValue.java xml-security-1_2_0/src/org/apache/xml/security/keys/content/keyvalues/DSAKeyValue.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63c21
< import java.security.interfaces.DSAPublicKey;
---
> import java.math.BigInteger;
68,69c26
< import java.security.spec.InvalidKeySpecException;
< import java.security.spec.KeySpec;
---
> import java.security.interfaces.DSAPublicKey;
71,74c28,29
< import java.math.BigInteger;
< import javax.xml.transform.TransformerException;
< import org.apache.xpath.XPathAPI;
< import org.w3c.dom.*;
---
> import java.security.spec.InvalidKeySpecException;
> 
76,77c31,37
< import org.apache.xml.security.signature.XMLSignatureException;
< import org.apache.xml.security.utils.*;
---
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.I18n;
> import org.apache.xml.security.utils.JavaUtils;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
82c42
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
87,89c47,49
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(DSAKeyValue.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(DSAKeyValue.class.getName());
138c98
<               (Object) key, "java.security.interfaces.DSAPublicKey")) {
---
>               key, "java.security.interfaces.DSAPublicKey")) {
156,161c116
<    /**
<     * Method getPublicKey
<     *
<     * @return
<     * @throws XMLSecurityException
<     */
---
>    /** @inheritDoc */
185a141
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/content/keyvalues/KeyValueContent.java xml-security-1_2_0/src/org/apache/xml/security/keys/content/keyvalues/KeyValueContent.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
65,66c23
< import java.security.NoSuchAlgorithmException;
< import java.security.spec.InvalidKeySpecException;
---
> 
74c31
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
83,84c40
<     * @throws InvalidKeySpecException
<     * @throws NoSuchAlgorithmException
---
>     * @throws XMLSecurityException
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/content/keyvalues/package.html xml-security-1_2_0/src/org/apache/xml/security/keys/content/keyvalues/package.html
2c2
< basic handlers for elements that can occur inside <CODE>ds:KeyValue</CODE>
---
> basic handlers for elements that can occur inside <CODE>ds:KeyValue</CODE>.
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/content/keyvalues/RSAKeyValue.java xml-security-1_2_0/src/org/apache/xml/security/keys/content/keyvalues/RSAKeyValue.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64d21
< import java.security.interfaces.RSAPublicKey;
68a26
> import java.security.interfaces.RSAPublicKey;
70d27
< import java.security.spec.KeySpec;
72,74c29
< import javax.xml.transform.TransformerException;
< import org.apache.xpath.XPathAPI;
< import org.w3c.dom.*;
---
> 
76,77c31,37
< import org.apache.xml.security.signature.XMLSignatureException;
< import org.apache.xml.security.utils.*;
---
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.I18n;
> import org.apache.xml.security.utils.JavaUtils;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
82c42
<  * @author $Author: dohy $
---
>  * @author $Author: vishal $
87,89c47,50
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(RSAKeyValue.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(
> 			RSAKeyValue.class.getName());
133c94
<               (Object) key, "java.security.interfaces.RSAPublicKey")) {
---
>               key, "java.security.interfaces.RSAPublicKey")) {
147,152c108
<    /**
<     * Method getPublicKey
<     *
<     * @return
<     * @throws XMLSecurityException
<     */
---
>    /** @inheritDoc */
158d113
<          // String JCE_RSA = org.apache.xml.security.algorithms.JCEMapper.translateURItoJCEID(Constants.ALGO_ID_SIGNATURE_RSA);
166c121
<          PublicKey pk = rsaFactory.generatePublic((KeySpec) rsaKeyspec);
---
>          PublicKey pk = rsaFactory.generatePublic(rsaKeyspec);
175a131
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/content/MgmtData.java xml-security-1_2_0/src/org/apache/xml/security/keys/content/MgmtData.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,66d20
< import org.w3c.dom.*;
< import org.apache.xpath.XPathAPI;
< import javax.xml.transform.TransformerException;
< import org.apache.xml.security.utils.*;
67a22,25
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
72c30
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
76,78c34,36
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(MgmtData.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(MgmtData.class.getName());
109d66
<     * @throws XMLSecurityException
111c68
<    public String getMgmtData() throws XMLSecurityException {
---
>    public String getMgmtData() {
114a72
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/content/package.html xml-security-1_2_0/src/org/apache/xml/security/keys/content/package.html
2c2
< basic handlers for elements that can occur inside <CODE>ds:KeyInfo</CODE>
---
> basic handlers for elements that can occur inside <CODE>ds:KeyInfo</CODE>.
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/content/PGPData.java xml-security-1_2_0/src/org/apache/xml/security/keys/content/PGPData.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,64d20
< import org.w3c.dom.*;
< import org.apache.xml.security.utils.*;
65a22,24
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.w3c.dom.Element;
70,71c29,30
<  * @author $Author: dohy $
<  * @todo Implement
---
>  * @author $Author: raul $
>  * $todo$ Implement
75,77c34,36
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(PGPData.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(PGPData.class.getName());
89a49
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/content/RetrievalMethod.java xml-security-1_2_0/src/org/apache/xml/security/keys/content/RetrievalMethod.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,65c21,22
< import javax.xml.transform.TransformerException;
< import org.apache.xpath.XPathAPI;
< import org.w3c.dom.*;
---
> 
> import org.apache.xml.security.exceptions.XMLSecurityException;
67,70c24,30
< import org.apache.xml.security.exceptions.*;
< import org.apache.xml.security.transforms.*;
< import org.apache.xml.security.utils.*;
< import org.apache.xml.security.utils.resolver.*;
---
> import org.apache.xml.security.transforms.Transforms;
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Attr;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
75c35
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
80,82c40,42
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(RetrievalMethod.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(RetrievalMethod.class.getName());
83a44
>     /** DSA retrieval */
84a46
>    /** RSA retrieval */
85a48
>    /** PGP retrieval */
86a50
>    /** SPKI retrieval */
87a52
>    /** MGMT retrieval */
88a54
>    /** X509 retrieval */
89a56
>    /** RAWX509 retrieval */
136c103
<       return this._constructionElement.getAttributeNode(Constants._ATT_URI);
---
>       return this._constructionElement.getAttributeNodeNS(null, Constants._ATT_URI);
141a109
>     * 
148,152c116
<    /**
<     * Method getType
<     *
<     * @return
<     */
---
>    /** @return */
160c124
<     * @return
---
>     *
161a126
>     * @return
166,172c131,134
<          Element nscontext = XMLUtils.createDSctx(this._doc, "ds",
<                                                   Constants.SignatureSpecNS);
<          Element transformsElem =
<             (Element) XPathAPI.selectSingleNode(this._constructionElement,
<                                                 "./ds:"
<                                                 + Constants
<                                                    ._TAG_TRANSFORMS, nscontext);
---
>        Element transformsElem =
>              XMLUtils.selectDsNode(this._constructionElement,                                                
>                                                 Constants
>                                                    ._TAG_TRANSFORMS, 0);
179,180d140
<       } catch (TransformerException ex) {
<          throw new XMLSecurityException("empty", ex);
185c145,146
< 
---
>    
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/content/SPKIData.java xml-security-1_2_0/src/org/apache/xml/security/keys/content/SPKIData.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,64d20
< import org.w3c.dom.*;
< import org.apache.xml.security.utils.*;
65a22,24
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.w3c.dom.Element;
70,71c29,30
<  * @author $Author: dohy $
<  * @todo implement
---
>  * @author $Author: raul $
>  * $todo$ implement
75,77c34,36
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(SPKIData.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(SPKIData.class.getName());
90a50
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/content/x509/package.html xml-security-1_2_0/src/org/apache/xml/security/keys/content/x509/package.html
2c2
< basic handlers for elements that can occur inside <CODE>ds:X509Data</CODE>
---
> basic handlers for elements that can occur inside <CODE>ds:X509Data</CODE>.
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/content/x509/XMLX509Certificate.java xml-security-1_2_0/src/org/apache/xml/security/keys/content/x509/XMLX509Certificate.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
65,67c23,26
< import java.security.cert.*;
< import org.w3c.dom.*;
< import org.apache.xml.security.utils.*;
---
> import java.security.cert.CertificateException;
> import java.security.cert.CertificateFactory;
> import java.security.cert.X509Certificate;
> 
68a28,32
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.JavaUtils;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
73c37
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
78,80c42,44
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(XMLX509Certificate.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(XMLX509Certificate.class.getName());
182,187c146
<    /**
<     * Method equals
<     *
<     * @param obj
<     * @return
<     */
---
>    /** @inheritDoc */
197c156
<          /** @todo or should be create X509Certificates and use the equals() from the Certs */
---
>          /** $todo$ or should be create X509Certificates and use the equals() from the Certs */
204a164
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/content/x509/XMLX509CRL.java xml-security-1_2_0/src/org/apache/xml/security/keys/content/x509/XMLX509CRL.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63d20
< import org.w3c.dom.*;
65c22,25
< import org.apache.xml.security.utils.*;
---
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
73c33
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
79,81c39,41
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(XMLX509CRL.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(XMLX509CRL.class.getName());
117a78
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/content/x509/XMLX509DataContent.java xml-security-1_2_0/src/org/apache/xml/security/keys/content/x509/XMLX509DataContent.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights 
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer. 
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:  
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written 
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European 
<  * Commission in the <WebSig> project in the ISIS Programme. 
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64d21
< import org.w3c.dom.*;
70c27
<  * @author $Author: dohy $
---
>  * @author $Author: blautenb $
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/content/x509/XMLX509IssuerSerial.java xml-security-1_2_0/src/org/apache/xml/security/keys/content/x509/XMLX509IssuerSerial.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63d20
< import java.security.cert.X509Certificate;
65,67c22,23
< import org.w3c.dom.*;
< import org.apache.xpath.XPathAPI;
< import javax.xml.transform.TransformerException;
---
> import java.security.cert.X509Certificate;
> 
69c25,30
< import org.apache.xml.security.utils.*;
---
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.RFC2253Parser;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
74c35
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
79,82c40,43
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category
<          .getInstance(XMLX509IssuerSerial.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(
>                     XMLX509IssuerSerial.class.getName());
154a116
>     *
156d117
<     * @throws XMLSecurityException
158c119
<    public BigInteger getSerialNumber() throws XMLSecurityException {
---
>    public BigInteger getSerialNumber() {
163,164c124,125
< 
<       cat.debug("In dem X509SerialNumber wurde gefunden: " + text);
---
>       if (log.isDebugEnabled())
>       	log.debug("In dem X509SerialNumber wurde gefunden: " + text);
171a133
>     *
173d134
<     * @throws XMLSecurityException
175c136
<    public int getSerialNumberInteger() throws XMLSecurityException {
---
>    public int getSerialNumberInteger() {
181a143
>     *
183d144
<     * @throws XMLSecurityException
185c146
<    public String getIssuerName() throws XMLSecurityException {
---
>    public String getIssuerName()  {
193,198c154
<    /**
<     * Method equals
<     *
<     * @param obj
<     * @return
<     */
---
>    /** @inheritDoc */
207,211d162
<       try {
<          if (other.getSerialNumber().equals(this.getSerialNumber())
<                  && other.getIssuerName().equals(this.getIssuerName())) {
<             return true;
<          }
213,215c164,166
<          return false;
<       } catch (XMLSecurityException ex) {
<          return false;
---
>       if (other.getSerialNumber().equals(this.getSerialNumber())
>                  && other.getIssuerName().equals(this.getIssuerName())) {
>            return true;
216a168,169
> 
>        return false;      
218a172
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/content/x509/XMLX509SKI.java xml-security-1_2_0/src/org/apache/xml/security/keys/content/x509/XMLX509SKI.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64c22,23
< import java.security.cert.Certificate;
---
> import java.io.ByteArrayInputStream;
> import java.io.InputStream;
66,68c25,27
< import java.security.cert.X509Extension;
< import org.w3c.dom.*;
< import org.apache.xml.security.utils.*;
---
> import java.lang.reflect.Constructor;
> import java.lang.reflect.Method;
> 
70c29,36
< import org.apache.xml.security.keys.keyresolver.KeyResolverException;
---
> import org.apache.xml.security.utils.Base64;
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.JavaUtils;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> 
77c43
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
83,85c49,51
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(XMLX509SKI.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(XMLX509SKI.class.getName());
152a119
>     *
175,185c142,185
<          DerValue dervalue = new DerValue(derEncodedValue);
< 
<          if (dervalue == null) {
<             throw new XMLSecurityException("certificate.noSki.null");
<          }
< 
<          if (dervalue.tag != DerValue.tag_OctetString) {
<             throw new XMLSecurityException("certificate.noSki.notOctetString");
<          }
< 
<          byte[] extensionValue = dervalue.getOctetString();
---
>           byte[] extensionValue = null;
>           
>           /**
>            * Use sun.security.util.DerValue if it is present.
>            */ 
>           try {
>               if (XMLUtils.classForName("sun.security.util.DerValue") != null) {
>                   DerValue dervalue = new DerValue(derEncodedValue);
>                   if (dervalue == null) {
>                       throw new XMLSecurityException("certificate.noSki.null");
>                   }
>                   if (dervalue.tag != DerValue.tag_OctetString) {
>                       throw new XMLSecurityException("certificate.noSki.notOctetString");
>                   }
>                   extensionValue = dervalue.getOctetString();
>               }
>           } catch (NoClassDefFoundError e) {
>           } catch (ClassNotFoundException e) {
>           }
>           
>           /**
>            * Fall back to org.bouncycastle.asn1.DERInputStream
>            */ 
>           if (extensionValue == null) {
>               try {
>                   Class clazz = XMLUtils.classForName("org.bouncycastle.asn1.DERInputStream");
>                   if (clazz != null) {
>                       Constructor constructor = clazz.getConstructor(new Class[]{InputStream.class});
>                       InputStream is = (InputStream) constructor.newInstance(new Object[]{new ByteArrayInputStream(derEncodedValue)});
>                       Method method = clazz.getMethod("readObject", new Class[]{});
>                       Object obj = method.invoke(is, new Object[]{});
>                       if (obj == null) {
>                           throw new XMLSecurityException("certificate.noSki.null");
>                       }
>                       Class clazz2 = XMLUtils.classForName("org.bouncycastle.asn1.ASN1OctetString");
>                       if (!clazz2.isInstance(obj)) {
>                           throw new XMLSecurityException("certificate.noSki.notOctetString");
>                       }
>                       Method method2 = clazz2.getMethod("getOctets", new Class[]{});
>                       extensionValue = (byte[]) method2.invoke(obj, new Object[]{});
>                   }
>               } catch (Throwable t) {
>               }
>           }
198c198,199
<          cat.debug("Base64 of SKI is " + Base64.encode(abyte0));
---
>          if (log.isDebugEnabled())
>          	log.debug("Base64 of SKI is " + Base64.encode(abyte0));
206,225c207
<    /**
<     * Method decode
<     *
<     * @param cert
<     * @throws XMLSecurityException
<     */
<    private void createSKIElementFromCert(X509Certificate cert)
<            throws XMLSecurityException {
< 
<       byte[] abyte0 = this.getSKIBytesFromCert(cert);
< 
<       Base64.encodeToElement(this._doc, Constants._TAG_X509SKI, abyte0);
<    }
< 
<    /**
<     * Method equals
<     *
<     * @param obj
<     * @return
<     */
---
>    /** @inheritDoc */
241a224
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/content/x509/XMLX509SubjectName.java xml-security-1_2_0/src/org/apache/xml/security/keys/content/x509/XMLX509SubjectName.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63c21
< import java.security.Principal;
---
> import java.io.IOException;
65,68c23
< import org.w3c.dom.*;
< import org.apache.xpath.XPathAPI;
< import javax.xml.transform.TransformerException;
< import org.apache.xml.security.utils.*;
---
> 
70c25,30
< import java.io.IOException;
---
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.RFC2253Parser;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> 
76,77c36
<  * @author $Author: dohy $
<  * @see java.security.Principal#getSubjectName().toString()
---
>  * @author $Author: raul $
82,84c41,43
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(XMLX509SubjectName.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(XMLX509SubjectName.class.getName());
124a84
>     *
126d85
<     * @throws XMLSecurityException
128c87
<    public String getSubjectName() throws XMLSecurityException {
---
>    public String getSubjectName() {
139a99
>     *
157a118
>     *
166,171c127
<    /**
<     * Method equals
<     *
<     * @param obj
<     * @return
<     */
---
>    /** @inheritDoc */
178,181c134,136
<       try {
<          XMLX509SubjectName other = (XMLX509SubjectName) obj;
<          String otherSubject = other.getSubjectName();
<          String thisSubject = this.getSubjectName();
---
>       XMLX509SubjectName other = (XMLX509SubjectName) obj;
>       String otherSubject = other.getSubjectName();
>       String thisSubject = this.getSubjectName();
183c138
<          if (otherSubject.equals(thisSubject)) {
---
>       if (otherSubject.equals(thisSubject)) {
185,189d139
<          }
< 
<          return false;
<       } catch (XMLSecurityException ex) {
<          return false;
191d140
<    }
192a142,146
>        return false;
>       
>    }
>    
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/content/X509Data.java xml-security-1_2_0/src/org/apache/xml/security/keys/content/X509Data.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63d20
< import java.util.Vector;
66,70c23
< import org.w3c.dom.*;
< import org.apache.xpath.XPathAPI;
< import javax.xml.transform.TransformerException;
< import org.apache.xml.security.utils.*;
< import org.apache.xml.security.keys.content.x509.*;
---
> 
71a25,35
> import org.apache.xml.security.keys.content.x509.XMLX509CRL;
> import org.apache.xml.security.keys.content.x509.XMLX509Certificate;
> import org.apache.xml.security.keys.content.x509.XMLX509IssuerSerial;
> import org.apache.xml.security.keys.content.x509.XMLX509SKI;
> import org.apache.xml.security.keys.content.x509.XMLX509SubjectName;
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.Node;
76c40
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
80,82c44,46
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(X509Data.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(X509Data.class.getName());
107,113c71,77
< 
<       NodeList children = this._constructionElement.getChildNodes();
<       HelperNodeList nodes = new HelperNodeList();
< 
<       for (int i = 0; i < children.getLength(); i++) {
<          if (children.item(i).getNodeType() == Node.ELEMENT_NODE) {
<             nodes.appendChild(children.item(i));
---
>       
>       boolean noElements=true;
>       Node sibling=this._constructionElement.getFirstChild();
>       while (sibling!=null) {
>       	 if (sibling.getNodeType()!=Node.ELEMENT_NODE) {
>       	 	sibling=sibling.getNextSibling();
>             continue;
115,124c79,81
<       }
< 
<       if (nodes.getLength() == 0) {
<          Object exArgs[] = { "Elements", Constants._TAG_X509DATA };
< 
<          throw new XMLSecurityException("xml.WrongContent", exArgs);
<       }
< 
<       for (int i = 0; i < nodes.getLength(); i++) {
<          Element currentElem = (Element) nodes.item(i);
---
>         noElements=false;
>          Element currentElem = (Element) sibling;
>          sibling=sibling.getNextSibling();
152c109
<                cat.warn("Found a " + currentElem.getTagName() + " element in "
---
>                log.warn("Found a " + currentElem.getTagName() + " element in "
157c114
<             cat.warn("Found a " + currentElem.getTagName() + " element in "
---
>             log.warn("Found a " + currentElem.getTagName() + " element in "
161a119,124
>       if (noElements) {
>         Object exArgs[] = { "Elements", Constants._TAG_X509DATA };
> 
>         throw new XMLSecurityException("xml.WrongContent", exArgs);
>      }
> 
347c310
<     * @return
---
>     * @return the number of IssuerSerial elements in this X509Data
357c320
<     * @return
---
>     * @return the number of SKI elements in this X509Data
366c329
<     * @return
---
>     * @return the number of SubjectName elements in this X509Data
376c339
<     * @return
---
>     * @return the number of Certificate elements in this X509Data
386c349
<     * @return
---
>     * @return the number of CRL elements in this X509Data
395c358
<     * @return
---
>     * @return the number of UnknownElement elements in this X509Data
398,399c361
< 
<       NodeList nl = this._constructionElement.getChildNodes();
---
>       
401,403c363,364
< 
<       for (int i = 0; i < nl.getLength(); i++) {
<          Node n = nl.item(i);
---
>       Node n=this._constructionElement.getFirstChild();
>       while (n!=null){         
408a370
>          n=n.getNextSibling();
410c372
< 
---
>       
418c380
<     * @return
---
>     * @return the X509IssuerSerial, null if not present
425,426c387,388
<          this.getChildElementLocalName(i, Constants.SignatureSpecNS,
<                                        Constants._TAG_X509ISSUERSERIAL);
---
>         XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>                                        Constants._TAG_X509ISSUERSERIAL,i);
430,432c392,393
<       } else {
<          return null;
<       }
---
>       } 
>       return null;
439c400
<     * @return
---
>     * @return the X509SKI, null if not present
444,445c405,406
<       Element e = this.getChildElementLocalName(i, Constants.SignatureSpecNS,
<                                                 Constants._TAG_X509SKI);
---
>       Element e = XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>                                                 Constants._TAG_X509SKI,i);
449,450d409
<       } else {
<          return null;
451a411
>       return null;
458c418
<     * @return
---
>     * @return the X509SubjectName, null if not present
464,465c424,425
<       Element e = this.getChildElementLocalName(i, Constants.SignatureSpecNS,
<                                                 Constants._TAG_X509SUBJECTNAME);
---
>       Element e = XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>                                                 Constants._TAG_X509SUBJECTNAME,i);
469,471c429,430
<       } else {
<          return null;
<       }
---
>       } 
>        return null;
478c437
<     * @return
---
>     * @return the X509Certifacte, null if not present
484,485c443,444
<       Element e = this.getChildElementLocalName(i, Constants.SignatureSpecNS,
<                                                 Constants._TAG_X509CERTIFICATE);
---
>       Element e = XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>                                                 Constants._TAG_X509CERTIFICATE,i);
489,491c448,449
<       } else {
<          return null;
<       }
---
>       } 
>        return null;
498c456
<     * @return
---
>     * @return the X509CRL, null if not present
503,504c461,462
<       Element e = this.getChildElementLocalName(i, Constants.SignatureSpecNS,
<                                                 Constants._TAG_X509CRL);
---
>       Element e = XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>                                                 Constants._TAG_X509CRL,i);
508,510c466,467
<       } else {
<          return null;
<       }
---
>       } 
>        return null;
517,520c474,477
<     * @return
<     * @todo implement
<     */
<    public Element itemUnknownElement(int i) {
---
>     * @return the Unknown Element at i
>     * $todo$ implement
>     **/
>    public Element itemUnknownElement(int i) {      
527c484
<     * @return
---
>     * @return true if this X509Data contains a IssuerSerial
536c493
<     * @return
---
>     * @return true if this X509Data contains a SKI
545c502
<     * @return
---
>     * @return true if this X509Data contains a SubjectName
554c511
<     * @return
---
>     * @return true if this X509Data contains a Certificate
563c520
<     * @return
---
>     * @return true if this X509Data contains a CRL
572c529
<     * @return
---
>     * @return true if this X509Data contains an UnknownElement
577a535
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/ContentHandlerAlreadyRegisteredException.java xml-security-1_2_0/src/org/apache/xml/security/keys/ContentHandlerAlreadyRegisteredException.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights 
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer. 
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:  
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written 
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European 
<  * Commission in the <WebSig> project in the ISIS Programme. 
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
69c27
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
85c43
<     * @param msgID
---
>     * @param _msgID
87,88c45,46
<    public ContentHandlerAlreadyRegisteredException(String msgID) {
<       super(msgID);
---
>    public ContentHandlerAlreadyRegisteredException(String _msgID) {
>       super(_msgID);
94c52
<     * @param msgID
---
>     * @param _msgID
97c55
<    public ContentHandlerAlreadyRegisteredException(String msgID,
---
>    public ContentHandlerAlreadyRegisteredException(String _msgID,
99c57
<       super(msgID, exArgs);
---
>       super(_msgID, exArgs);
105,106c63,64
<     * @param msgID
<     * @param originalException
---
>     * @param _msgID
>     * @param _originalException
108,110c66,68
<    public ContentHandlerAlreadyRegisteredException(String msgID,
<            Exception originalException) {
<       super(msgID, originalException);
---
>    public ContentHandlerAlreadyRegisteredException(String _msgID,
>            Exception _originalException) {
>       super(_msgID, _originalException);
116c74
<     * @param msgID
---
>     * @param _msgID
118c76
<     * @param originalException
---
>     * @param _originalException
120,122c78,80
<    public ContentHandlerAlreadyRegisteredException(String msgID,
<            Object exArgs[], Exception originalException) {
<       super(msgID, exArgs, originalException);
---
>    public ContentHandlerAlreadyRegisteredException(String _msgID,
>            Object exArgs[], Exception _originalException) {
>       super(_msgID, exArgs, _originalException);
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/KeyInfo.java xml-security-1_2_0/src/org/apache/xml/security/keys/KeyInfo.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,6
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
5,6c8
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
---
>  *      http://www.apache.org/licenses/LICENSE-2.0
8,10c10,14
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
---
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
12,57d15
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,67c21,25
< import java.lang.reflect.*;
< import java.security.*;
< import java.security.cert.*;
< import java.security.spec.*;
< import java.util.*;
---
> import java.security.PublicKey;
> import java.security.cert.X509Certificate;
> import java.util.ArrayList;
> import java.util.List;
> 
69,73c27,30
< import javax.xml.transform.TransformerException;
< import org.apache.xpath.XPathAPI;
< import org.w3c.dom.*;
< import org.apache.xml.security.c14n.*;
< import org.apache.xml.security.transforms.params.XPathContainer;
---
> 
> import org.apache.xml.security.encryption.EncryptedKey;
> import org.apache.xml.security.encryption.XMLCipher;
> import org.apache.xml.security.encryption.XMLEncryptionException;
75,81c32,54
< import org.apache.xml.security.keys.content.*;
< import org.apache.xml.security.keys.content.keyvalues.*;
< import org.apache.xml.security.keys.keyresolver.*;
< import org.apache.xml.security.keys.storage.*;
< import org.apache.xml.security.utils.*;
< import org.apache.xml.security.transforms.*;
< import org.apache.xml.security.Init;
---
> import org.apache.xml.security.keys.content.KeyName;
> import org.apache.xml.security.keys.content.KeyValue;
> import org.apache.xml.security.keys.content.MgmtData;
> import org.apache.xml.security.keys.content.PGPData;
> import org.apache.xml.security.keys.content.RetrievalMethod;
> import org.apache.xml.security.keys.content.SPKIData;
> import org.apache.xml.security.keys.content.X509Data;
> import org.apache.xml.security.keys.content.keyvalues.DSAKeyValue;
> import org.apache.xml.security.keys.content.keyvalues.RSAKeyValue;
> import org.apache.xml.security.keys.keyresolver.KeyResolver;
> import org.apache.xml.security.keys.keyresolver.KeyResolverException;
> import org.apache.xml.security.keys.keyresolver.KeyResolverSpi;
> import org.apache.xml.security.keys.storage.StorageResolver;
> import org.apache.xml.security.transforms.Transforms;
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.EncryptionConstants;
> import org.apache.xml.security.utils.IdResolver;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.Node;
> import org.w3c.dom.NodeList;
114c87
<  * @author $Author: dohy $
---
>  * @author $Author: blautenb $
118,438c91,423
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(KeyInfo.class.getName());
< 
<    /** Field _dsns */
<    Element _dsns = null;
< 
<    /**
<     * Constructor KeyInfo
<     * @param doc
<     */
<    public KeyInfo(Document doc) {
< 
<       super(doc);
< 
<       XMLUtils.addReturnToElement(this._constructionElement);
< 
<       this._dsns = XMLUtils.createDSctx(this._doc, "ds",
<                                         Constants.SignatureSpecNS);
<    }
< 
<    /**
<     * Constructor KeyInfo
<     *
<     * @param element
<     * @param BaseURI
<     * @throws XMLSecurityException
<     */
<    public KeyInfo(Element element, String BaseURI) throws XMLSecurityException {
< 
<       super(element, BaseURI);
< 
<       this._dsns = XMLUtils.createDSctx(this._doc, "ds",
<                                         Constants.SignatureSpecNS);
<    }
< 
<    /**
<     * Sets the <code>Id</code> attribute
<     *
<     * @param Id ID
<     */
<    public void setId(String Id) {
< 
<       if ((this._state == MODE_SIGN) && (Id != null)) {
<          this._constructionElement.setAttributeNS(null, Constants._ATT_ID, Id);
<          IdResolver.registerElementById(this._constructionElement, Id);
<       }
<    }
< 
<    /**
<     * Returns the <code>Id</code> attribute
<     *
<     * @return the <code>Id</code> attribute
<     */
<    public String getId() {
<       return this._constructionElement.getAttributeNS(null, Constants._ATT_ID);
<    }
< 
<    /**
<     * Method addKeyName
<     *
<     * @param keynameString
<     */
<    public void addKeyName(String keynameString) {
<       this.add(new KeyName(this._doc, keynameString));
<    }
< 
<    /**
<     * Method add
<     *
<     * @param keyname
<     */
<    public void add(KeyName keyname) {
< 
<       if (this._state == MODE_SIGN) {
<          this._constructionElement.appendChild(keyname.getElement());
<          XMLUtils.addReturnToElement(this._constructionElement);
<       }
<    }
< 
<    /**
<     * Method addKeyValue
<     *
<     * @param pk
<     */
<    public void addKeyValue(PublicKey pk) {
<       this.add(new KeyValue(this._doc, pk));
<    }
< 
<    /**
<     * Method addKeyValue
<     *
<     * @param unknownKeyValueElement
<     */
<    public void addKeyValue(Element unknownKeyValueElement) {
<       this.add(new KeyValue(this._doc, unknownKeyValueElement));
<    }
< 
<    /**
<     * Method add
<     *
<     * @param dsakeyvalue
<     */
<    public void add(DSAKeyValue dsakeyvalue) {
<       this.add(new KeyValue(this._doc, dsakeyvalue));
<    }
< 
<    /**
<     * Method add
<     *
<     * @param rsakeyvalue
<     */
<    public void add(RSAKeyValue rsakeyvalue) {
<       this.add(new KeyValue(this._doc, rsakeyvalue));
<    }
< 
<    /**
<     * Method add
<     *
<     * @param pk
<     */
<    public void add(PublicKey pk) {
<       this.add(new KeyValue(this._doc, pk));
<    }
< 
<    /**
<     * Method add
<     *
<     * @param keyvalue
<     */
<    public void add(KeyValue keyvalue) {
< 
<       if (this._state == MODE_SIGN) {
<          this._constructionElement.appendChild(keyvalue.getElement());
<          XMLUtils.addReturnToElement(this._constructionElement);
<       }
<    }
< 
<    /**
<     * Method addMgmtData
<     *
<     * @param mgmtdata
<     */
<    public void addMgmtData(String mgmtdata) {
<       this.add(new MgmtData(this._doc, mgmtdata));
<    }
< 
<    /**
<     * Method add
<     *
<     * @param mgmtdata
<     */
<    public void add(MgmtData mgmtdata) {
< 
<       if (this._state == MODE_SIGN) {
<          this._constructionElement.appendChild(mgmtdata.getElement());
<          XMLUtils.addReturnToElement(this._constructionElement);
<       }
<    }
< 
<    /**
<     * Method addPGPData
<     *
<     * @param pgpdata
<     */
<    public void add(PGPData pgpdata) {
< 
<       if (this._state == MODE_SIGN) {
<          this._constructionElement.appendChild(pgpdata.getElement());
<          XMLUtils.addReturnToElement(this._constructionElement);
<       }
<    }
< 
<    /**
<     * Method addRetrievalMethod
<     *
<     * @param URI
<     * @param transforms
<     * @param Type
<     */
<    public void addRetrievalMethod(String URI, Transforms transforms,
<                                   String Type) {
<       this.add(new RetrievalMethod(this._doc, URI, transforms, Type));
<    }
< 
<    /**
<     * Method add
<     *
<     * @param retrievalmethod
<     */
<    public void add(RetrievalMethod retrievalmethod) {
< 
<       if (this._state == MODE_SIGN) {
<          this._constructionElement.appendChild(retrievalmethod.getElement());
<          XMLUtils.addReturnToElement(this._constructionElement);
<       }
<    }
< 
<    /**
<     * Method add
<     *
<     * @param spkidata
<     */
<    public void add(SPKIData spkidata) {
< 
<       if (this._state == MODE_SIGN) {
<          this._constructionElement.appendChild(spkidata.getElement());
<          XMLUtils.addReturnToElement(this._constructionElement);
<       }
<    }
< 
<    /**
<     * Method addX509Data
<     *
<     * @param x509data
<     * @throws XMLSecurityException
<     */
<    public void add(X509Data x509data) throws XMLSecurityException {
< 
<       if (this._state == MODE_SIGN) {
<          this._constructionElement.appendChild(x509data.getElement());
<          XMLUtils.addReturnToElement(this._constructionElement);
<       }
<    }
< 
<    /**
<     * Method addUnknownElement
<     *
<     * @param element
<     */
<    public void addUnknownElement(Element element) {
< 
<       if (this._state == MODE_SIGN) {
<          this._constructionElement.appendChild(element);
<          XMLUtils.addReturnToElement(this._constructionElement);
<       }
<    }
< 
<    /**
<     * Method lengthKeyName
<     *
<     * @return
<     */
<    public int lengthKeyName() {
<       return this.length(Constants.SignatureSpecNS, Constants._TAG_KEYNAME);
<    }
< 
<    /**
<     * Method lengthKeyValue
<     *
<     * @return
<     */
<    public int lengthKeyValue() {
<       return this.length(Constants.SignatureSpecNS, Constants._TAG_KEYVALUE);
<    }
< 
<    /**
<     * Method lengthMgmtData
<     *
<     * @return
<     */
<    public int lengthMgmtData() {
<       return this.length(Constants.SignatureSpecNS, Constants._TAG_MGMTDATA);
<    }
< 
<    /**
<     * Method lengthPGPData
<     *
<     * @return
<     */
<    public int lengthPGPData() {
<       return this.length(Constants.SignatureSpecNS, Constants._TAG_PGPDATA);
<    }
< 
<    /**
<     * Method lengthRetrievalMethod
<     *
<     * @return
<     */
<    public int lengthRetrievalMethod() {
<       return this.length(Constants.SignatureSpecNS,
<                          Constants._TAG_RETRIEVALMETHOD);
<    }
< 
<    /**
<     * Method lengthSPKIData
<     *
<     * @return
<     */
<    public int lengthSPKIData() {
<       return this.length(Constants.SignatureSpecNS, Constants._TAG_SPKIDATA);
<    }
< 
<    /**
<     * Method lengthX509Data
<     *
<     * @return
<     */
<    public int lengthX509Data() {
<       return this.length(Constants.SignatureSpecNS, Constants._TAG_X509DATA);
<    }
< 
<    /**
<     * Method lengthUnknownElement
<     *
<     * @return
<     */
<    public int lengthUnknownElement() {
< 
<       int res = 0;
<       NodeList nl = this._constructionElement.getChildNodes();
< 
<       for (int i = 0; i < nl.getLength(); i++) {
<          Node current = nl.item(i);
< 
<          /**
<           * @todo using this method, we don't see unknown Elements
<           *  from Signature NS; revisit
<           */
<          if ((current.getNodeType() == Node.ELEMENT_NODE)
<                  && current.getNamespaceURI()
---
>     /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log =
>             org.apache.commons.logging.LogFactory.getLog(KeyInfo.class.getName());
> 
> 
> 
>     /**
>      * Constructor KeyInfo
>      * @param doc
>      */
>     public KeyInfo(Document doc) {
> 
>         super(doc);
> 
>         XMLUtils.addReturnToElement(this._constructionElement);
> 
> 
>     }
> 
>     /**
>      * Constructor KeyInfo
>      *
>      * @param element
>      * @param BaseURI
>      * @throws XMLSecurityException
>      */
>     public KeyInfo(Element element, String BaseURI) throws XMLSecurityException {
> 
>         super(element, BaseURI);
> 
>     }
> 
>     /**
>      * Sets the <code>Id</code> attribute
>      *
>      * @param Id ID
>      */
>     public void setId(String Id) {
> 
>         if ((this._state == MODE_SIGN) && (Id != null)) {
>             this._constructionElement.setAttributeNS(null, Constants._ATT_ID, Id);
>             IdResolver.registerElementById(this._constructionElement, Id);
>         }
>     }
> 
>     /**
>      * Returns the <code>Id</code> attribute
>      *
>      * @return the <code>Id</code> attribute
>      */
>     public String getId() {
>         return this._constructionElement.getAttributeNS(null, Constants._ATT_ID);
>     }
> 
>     /**
>      * Method addKeyName
>      *
>      * @param keynameString
>      */
>     public void addKeyName(String keynameString) {
>         this.add(new KeyName(this._doc, keynameString));
>     }
> 
>     /**
>      * Method add
>      *
>      * @param keyname
>      */
>     public void add(KeyName keyname) {
> 
>         if (this._state == MODE_SIGN) {
>             this._constructionElement.appendChild(keyname.getElement());
>             XMLUtils.addReturnToElement(this._constructionElement);
>         }
>     }
> 
>     /**
>      * Method addKeyValue
>      *
>      * @param pk
>      */
>     public void addKeyValue(PublicKey pk) {
>         this.add(new KeyValue(this._doc, pk));
>     }
> 
>     /**
>      * Method addKeyValue
>      *
>      * @param unknownKeyValueElement
>      */
>     public void addKeyValue(Element unknownKeyValueElement) {
>         this.add(new KeyValue(this._doc, unknownKeyValueElement));
>     }
> 
>     /**
>      * Method add
>      *
>      * @param dsakeyvalue
>      */
>     public void add(DSAKeyValue dsakeyvalue) {
>         this.add(new KeyValue(this._doc, dsakeyvalue));
>     }
> 
>     /**
>      * Method add
>      *
>      * @param rsakeyvalue
>      */
>     public void add(RSAKeyValue rsakeyvalue) {
>         this.add(new KeyValue(this._doc, rsakeyvalue));
>     }
> 
>     /**
>      * Method add
>      *
>      * @param pk
>      */
>     public void add(PublicKey pk) {
>         this.add(new KeyValue(this._doc, pk));
>     }
> 
>     /**
>      * Method add
>      *
>      * @param keyvalue
>      */
>     public void add(KeyValue keyvalue) {
> 
>         if (this._state == MODE_SIGN) {
>             this._constructionElement.appendChild(keyvalue.getElement());
>             XMLUtils.addReturnToElement(this._constructionElement);
>         }
>     }
> 
>     /**
>      * Method addMgmtData
>      *
>      * @param mgmtdata
>      */
>     public void addMgmtData(String mgmtdata) {
>         this.add(new MgmtData(this._doc, mgmtdata));
>     }
> 
>     /**
>      * Method add
>      *
>      * @param mgmtdata
>      */
>     public void add(MgmtData mgmtdata) {
> 
>         if (this._state == MODE_SIGN) {
>             this._constructionElement.appendChild(mgmtdata.getElement());
>             XMLUtils.addReturnToElement(this._constructionElement);
>         }
>     }
> 
>     /**
>      * Method addPGPData
>      *
>      * @param pgpdata
>      */
>     public void add(PGPData pgpdata) {
> 
>         if (this._state == MODE_SIGN) {
>             this._constructionElement.appendChild(pgpdata.getElement());
>             XMLUtils.addReturnToElement(this._constructionElement);
>         }
>     }
> 
>     /**
>      * Method addRetrievalMethod
>      *
>      * @param URI
>      * @param transforms
>      * @param Type
>      */
>     public void addRetrievalMethod(String URI, Transforms transforms,
>             String Type) {
>         this.add(new RetrievalMethod(this._doc, URI, transforms, Type));
>     }
> 
>     /**
>      * Method add
>      *
>      * @param retrievalmethod
>      */
>     public void add(RetrievalMethod retrievalmethod) {
> 
>         if (this._state == MODE_SIGN) {
>             this._constructionElement.appendChild(retrievalmethod.getElement());
>             XMLUtils.addReturnToElement(this._constructionElement);
>         }
>     }
> 
>     /**
>      * Method add
>      *
>      * @param spkidata
>      */
>     public void add(SPKIData spkidata) {
> 
>         if (this._state == MODE_SIGN) {
>             this._constructionElement.appendChild(spkidata.getElement());
>             XMLUtils.addReturnToElement(this._constructionElement);
>         }
>     }
> 
>     /**
>      * Method addX509Data
>      *
>      * @param x509data
>      */
>     public void add(X509Data x509data) {
> 
>         if (this._state == MODE_SIGN) {
>             this._constructionElement.appendChild(x509data.getElement());
>             XMLUtils.addReturnToElement(this._constructionElement);
>         }
>     }
> 
>     /**
>      * Method addEncryptedKey
>      *
>      * @param encryptedKey
>      * @throws XMLEncryptionException
>      */
> 
>     public void add(EncryptedKey encryptedKey)
>             throws XMLEncryptionException {
> 
>         if (this._state == MODE_SIGN) {
>             XMLCipher cipher = XMLCipher.getInstance();
>             this._constructionElement.appendChild(cipher.martial(encryptedKey));
>         }
> 
>     }
> 
>     /**
>      * Method addUnknownElement
>      *
>      * @param element
>      */
>     public void addUnknownElement(Element element) {
> 
>         if (this._state == MODE_SIGN) {
>             this._constructionElement.appendChild(element);
>             XMLUtils.addReturnToElement(this._constructionElement);
>         }
>     }
> 
>     /**
>      * Method lengthKeyName
>      *
>      * @return the number of the KeyName tags
>      */
>     public int lengthKeyName() {
>         return this.length(Constants.SignatureSpecNS, Constants._TAG_KEYNAME);
>     }
> 
>     /**
>      * Method lengthKeyValue
>      *
>      *@return the number of the KeyValue tags
>      */
>     public int lengthKeyValue() {
>         return this.length(Constants.SignatureSpecNS, Constants._TAG_KEYVALUE);
>     }
> 
>     /**
>      * Method lengthMgmtData
>      *
>      *@return the number of the MgmtData tags
>      */
>     public int lengthMgmtData() {
>         return this.length(Constants.SignatureSpecNS, Constants._TAG_MGMTDATA);
>     }
> 
>     /**
>      * Method lengthPGPData
>      *
>      *@return the number of the PGPDat. tags
>      */
>     public int lengthPGPData() {
>         return this.length(Constants.SignatureSpecNS, Constants._TAG_PGPDATA);
>     }
> 
>     /**
>      * Method lengthRetrievalMethod
>      *
>      *@return the number of the RetrievalMethod tags
>      */
>     public int lengthRetrievalMethod() {
>         return this.length(Constants.SignatureSpecNS,
>                 Constants._TAG_RETRIEVALMETHOD);
>     }
> 
>     /**
>      * Method lengthSPKIData
>      *
>      *@return the number of the SPKIData tags
>      */
>     public int lengthSPKIData() {
>         return this.length(Constants.SignatureSpecNS, Constants._TAG_SPKIDATA);
>     }
> 
>     /**
>      * Method lengthX509Data
>      *
>      *@return the number of the X509Data tags
>      */
>     public int lengthX509Data() {
>         return this.length(Constants.SignatureSpecNS, Constants._TAG_X509DATA);
>     }
> 
>     /**
>      * Method lengthUnknownElement
>      * NOTE posibly buggy.
>      *@return the number of the UnknownElement tags
>      */
>     public int lengthUnknownElement() {
> 
>         int res = 0;
>         NodeList nl = this._constructionElement.getChildNodes();
> 
>         for (int i = 0; i < nl.getLength(); i++) {
>             Node current = nl.item(i);
> 
>             /**
>              * $todo$ using this method, we don't see unknown Elements
>              *  from Signature NS; revisit
>              */
>             if ((current.getNodeType() == Node.ELEMENT_NODE)
>                     && current.getNamespaceURI()
440,600c425,600
<             res++;
<          }
<       }
< 
<       return res;
<    }
< 
<    /**
<     * Method itemKeyName
<     *
<     * @param i
<     * @return
<     * @throws XMLSecurityException
<     */
<    public KeyName itemKeyName(int i) throws XMLSecurityException {
< 
<       Element e = this.getChildElementLocalName(i, Constants.SignatureSpecNS,
<                                                 Constants._TAG_KEYNAME);
< 
<       if (e != null) {
<          return new KeyName(e, this._baseURI);
<       } else {
<          return null;
<       }
<    }
< 
<    /**
<     * Method itemKeyValue
<     *
<     * @param i
<     * @return
<     * @throws XMLSecurityException
<     */
<    public KeyValue itemKeyValue(int i) throws XMLSecurityException {
< 
<       Element e = this.getChildElementLocalName(i, Constants.SignatureSpecNS,
<                                                 Constants._TAG_KEYVALUE);
< 
<       if (e != null) {
<          return new KeyValue(e, this._baseURI);
<       } else {
<          return null;
<       }
<    }
< 
<    /**
<     * Method itemMgmtData
<     *
<     * @param i
<     * @return
<     * @throws XMLSecurityException
<     */
<    public MgmtData itemMgmtData(int i) throws XMLSecurityException {
< 
<       Element e = this.getChildElementLocalName(i, Constants.SignatureSpecNS,
<                                                 Constants._TAG_MGMTDATA);
< 
<       if (e != null) {
<          return new MgmtData(e, this._baseURI);
<       } else {
<          return null;
<       }
<    }
< 
<    /**
<     * Method itemPGPData
<     *
<     * @param i
<     * @return
<     * @throws XMLSecurityException
<     */
<    public PGPData itemPGPData(int i) throws XMLSecurityException {
< 
<       Element e = this.getChildElementLocalName(i, Constants.SignatureSpecNS,
<                                                 Constants._TAG_PGPDATA);
< 
<       if (e != null) {
<          return new PGPData(e, this._baseURI);
<       } else {
<          return null;
<       }
<    }
< 
<    /**
<     * Method itemRetrievalMethod
<     *
<     * @param i
<     * @return
<     * @throws XMLSecurityException
<     */
<    public RetrievalMethod itemRetrievalMethod(int i)
<            throws XMLSecurityException {
< 
<       Element e = this.getChildElementLocalName(i, Constants.SignatureSpecNS,
<                                                 Constants._TAG_RETRIEVALMETHOD);
< 
<       if (e != null) {
<          return new RetrievalMethod(e, this._baseURI);
<       } else {
<          return null;
<       }
<    }
< 
<    /**
<     * Method itemSPKIData
<     *
<     * @param i
<     * @return
<     * @throws XMLSecurityException
<     */
<    public SPKIData itemSPKIData(int i) throws XMLSecurityException {
< 
<       Element e = this.getChildElementLocalName(i, Constants.SignatureSpecNS,
<                                                 Constants._TAG_SPKIDATA);
< 
<       if (e != null) {
<          return new SPKIData(e, this._baseURI);
<       } else {
<          return null;
<       }
<    }
< 
<    /**
<     * Method itemX509Data
<     *
<     * @param i
<     * @return
<     * @throws XMLSecurityException
<     */
<    public X509Data itemX509Data(int i) throws XMLSecurityException {
< 
<       Element e = this.getChildElementLocalName(i, Constants.SignatureSpecNS,
<                                                 Constants._TAG_X509DATA);
< 
<       if (e != null) {
<          return new X509Data(e, this._baseURI);
<       } else {
<          return null;
<       }
<    }
< 
<    /**
<     * Method itemUnknownElement
<     *
<     * @param i
<     * @return
<     */
<    public Element itemUnknownElement(int i) {
< 
<       NodeList nl = this._constructionElement.getChildNodes();
<       int res = 0;
< 
<       for (int j = 0; j < nl.getLength(); j++) {
<          Node current = nl.item(j);
< 
<          /**
<           * @todo using this method, we don't see unknown Elements
<           *  from Signature NS; revisit
<           */
<          if ((current.getNodeType() == Node.ELEMENT_NODE)
<                  && current.getNamespaceURI()
---
>                 res++;
>             }
>         }
> 
>         return res;
>     }
> 
>     /**
>      * Method itemKeyName
>      *
>      * @param i
>      * @return the asked KeyName element, null if the index is too big
>      * @throws XMLSecurityException
>      */
>     public KeyName itemKeyName(int i) throws XMLSecurityException {
> 
>         Element e = XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>                 Constants._TAG_KEYNAME,i);
> 
>         if (e != null) {
>             return new KeyName(e, this._baseURI);
>         }
>         return null;
>     }
> 
>     /**
>      * Method itemKeyValue
>      *
>      * @param i
>      * @return the asked KeyValue element, null if the index is too big
>      * @throws XMLSecurityException
>      */
>     public KeyValue itemKeyValue(int i) throws XMLSecurityException {
> 
>         Element e = XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>                 Constants._TAG_KEYVALUE,i);
> 
>         if (e != null) {
>             return new KeyValue(e, this._baseURI);
>         }
>         return null;
>     }
> 
>     /**
>      * Method itemMgmtData
>      *
>      * @param i
>      *@return the asked MgmtData element, null if the index is too big
>      * @throws XMLSecurityException
>      */
>     public MgmtData itemMgmtData(int i) throws XMLSecurityException {
> 
>         Element e = XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>                 Constants._TAG_MGMTDATA,i);
> 
>         if (e != null) {
>             return new MgmtData(e, this._baseURI);
>         }
>         return null;
>     }
> 
>     /**
>      * Method itemPGPData
>      *
>      * @param i
>      *@return the asked PGPData element, null if the index is too big
>      * @throws XMLSecurityException
>      */
>     public PGPData itemPGPData(int i) throws XMLSecurityException {
> 
>         Element e = XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>                 Constants._TAG_PGPDATA,i);
> 
>         if (e != null) {
>             return new PGPData(e, this._baseURI);
>         }
>         return null;
>     }
> 
>     /**
>      * Method itemRetrievalMethod
>      *
>      * @param i
>      *@return the asked RetrievalMethod element, null if the index is too big
>      * @throws XMLSecurityException
>      */
>     public RetrievalMethod itemRetrievalMethod(int i)
>             throws XMLSecurityException {
> 
>         Element e = XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>                 Constants._TAG_RETRIEVALMETHOD,i);
> 
>         if (e != null) {
>             return new RetrievalMethod(e, this._baseURI);
>         }
>         return null;
>     }
> 
>     /**
>      * Method itemSPKIData
>      *
>      * @param i
>      *@return the asked SPKIData element, null if the index is too big
>      * @throws XMLSecurityException
>      */
>     public SPKIData itemSPKIData(int i) throws XMLSecurityException {
> 
>         Element e = XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>                 Constants._TAG_SPKIDATA,i);
> 
>         if (e != null) {
>             return new SPKIData(e, this._baseURI);
>         }
>         return null;
>     }
> 
>     /**
>      * Method itemX509Data
>      *@return the asked X509Data element, null if the index is too big
>      * @param i
>      *
>      * @throws XMLSecurityException
>      */
>     public X509Data itemX509Data(int i) throws XMLSecurityException {
> 
>         Element e = XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>                 Constants._TAG_X509DATA,i);
> 
>         if (e != null) {
>             return new X509Data(e, this._baseURI);
>         }
>         return null;
>     }
> 
>     /**
>      * Method itemEncryptedKey
>      *
>      * @param i
>      * @return the asked EncryptedKey element, null if the index is too big
>      * @throws XMLSecurityException
>      */
> 
>     public EncryptedKey itemEncryptedKey(int i) throws XMLSecurityException {
> 
>         Element e =
>                 XMLUtils.selectXencNode(this._constructionElement.getFirstChild(),
>                         EncryptionConstants._TAG_ENCRYPTEDKEY,i);
> 
>         if (e != null) {
>             XMLCipher cipher = XMLCipher.getInstance();
>             cipher.init(XMLCipher.UNWRAP_MODE, null);
>             return cipher.loadEncryptedKey(e);
>         }
>         return null;
>     }
> 
>     /**
>      * Method itemUnknownElement
>      *
>      * @param i
>      * @return
>      */
>     public Element itemUnknownElement(int i) {
> 
>         NodeList nl = this._constructionElement.getChildNodes();
>         int res = 0;
> 
>         for (int j = 0; j < nl.getLength(); j++) {
>             Node current = nl.item(j);
> 
>             /**
>              * $todo$ using this method, we don't see unknown Elements
>              *  from Signature NS; revisit
>              */
>             if ((current.getNodeType() == Node.ELEMENT_NODE)
>                     && current.getNamespaceURI()
602c602
<             res++;
---
>                 res++;
604,605c604,606
<             if (res == i) {
<                return (Element) current;
---
>                 if (res == i) {
>                     return (Element) current;
>                 }
607,608c608
<          }
<       }
---
>         }
610,611c610,611
<       return null;
<    }
---
>         return null;
>     }
613,777c613,790
<    /**
<     * Method isEmpty
<     *
<     * @return
<     */
<    public boolean isEmpty() {
<       return this._constructionElement.getChildNodes().getLength() == 0;
<    }
< 
<    /**
<     * Method containsKeyName
<     *
<     * @return
<     */
<    public boolean containsKeyName() {
<       return this.lengthKeyName() > 0;
<    }
< 
<    /**
<     * Method containsKeyValue
<     *
<     * @return
<     */
<    public boolean containsKeyValue() {
<       return this.lengthKeyValue() > 0;
<    }
< 
<    /**
<     * Method containsMgmtData
<     *
<     * @return
<     */
<    public boolean containsMgmtData() {
<       return this.lengthMgmtData() > 0;
<    }
< 
<    /**
<     * Method containsPGPData
<     *
<     * @return
<     */
<    public boolean containsPGPData() {
<       return this.lengthPGPData() > 0;
<    }
< 
<    /**
<     * Method containsRetrievalMethod
<     *
<     * @return
<     */
<    public boolean containsRetrievalMethod() {
<       return this.lengthRetrievalMethod() > 0;
<    }
< 
<    /**
<     * Method containsSPKIData
<     *
<     * @return
<     */
<    public boolean containsSPKIData() {
<       return this.lengthSPKIData() > 0;
<    }
< 
<    /**
<     * Method containsUnknownElement
<     *
<     * @return
<     */
<    public boolean containsUnknownElement() {
<       return this.lengthUnknownElement() > 0;
<    }
< 
<    /**
<     * Method containsX509Data
<     *
<     * @return
<     */
<    public boolean containsX509Data() {
<       return this.lengthX509Data() > 0;
<    }
< 
<    /**
<     * This method returns a secret (symmetric) key. This is for XML Encryption.
<     *
<     */
<    public SecretKey getSecretKey() throws KeyResolverException {
<       return null;
<    }
< 
<    /**
<     * This method returns the public key.
<     *
<     * @return
<     * @throws KeyResolverException
<     */
<    public PublicKey getPublicKey() throws KeyResolverException {
< 
<       PublicKey pk = this.getPublicKeyFromInternalResolvers();
< 
<       if (pk != null) {
<          cat.debug("I could find a key using the per-KeyInfo key resolvers");
< 
<          return pk;
<       } else {
<          cat.debug("I couldn't find a key using the per-KeyInfo key resolvers");
<       }
< 
<       pk = this.getPublicKeyFromStaticResolvers();
< 
<       if (pk != null) {
<          cat.debug("I could find a key using the system-wide key resolvers");
< 
<          return pk;
<       } else {
<          cat.debug("I couldn't find a key using the system-wide key resolvers");
<       }
< 
<       return null;
<    }
< 
<    /**
<     * Searches the library wide keyresolvers for public keys
<     *
<     * @return
<     * @throws KeyResolverException
<     */
<    PublicKey getPublicKeyFromStaticResolvers() throws KeyResolverException {
< 
<       for (int i = 0; i < KeyResolver.length(); i++) {
<          KeyResolver keyResolver = KeyResolver.item(i);
< 
<          for (int j = 0;
<                  j < this._constructionElement.getChildNodes().getLength();
<                  j++) {
<             Node currentChild =
<                this._constructionElement.getChildNodes().item(j);
< 
<             if (currentChild.getNodeType() == Node.ELEMENT_NODE) {
<                if (this._storageResolvers.size() == 0) {
< 
<                   // if we do not have storage resolvers, we verify with null
<                   StorageResolver storage = null;
< 
<                   if (keyResolver.canResolve((Element) currentChild,
<                                              this.getBaseURI(), storage)) {
<                      PublicKey pk =
<                         keyResolver.resolvePublicKey((Element) currentChild,
<                                                      this.getBaseURI(),
<                                                      storage);
< 
<                      if (pk != null) {
<                         return pk;
<                      }
<                   }
<                } else {
<                   for (int k = 0; k < this._storageResolvers.size(); k++) {
<                      StorageResolver storage =
<                         (StorageResolver) this._storageResolvers.elementAt(k);
< 
<                      if (keyResolver.canResolve((Element) currentChild,
<                                                 this.getBaseURI(), storage)) {
<                         PublicKey pk =
<                            keyResolver.resolvePublicKey((Element) currentChild,
<                                                         this.getBaseURI(),
<                                                         storage);
---
>     /**
>      * Method isEmpty
>      *
>      * @return true if the element has no descedants.
>      */
>     public boolean isEmpty() {
>         return this._constructionElement.getFirstChild()==null;
>     }
> 
>     /**
>      * Method containsKeyName
>      *
>      * @return If the KeyInfo contains a KeyName node
>      */
>     public boolean containsKeyName() {
>         return this.lengthKeyName() > 0;
>     }
> 
>     /**
>      * Method containsKeyValue
>      *
>      * @return If the KeyInfo contains a KeyValue node
>      */
>     public boolean containsKeyValue() {
>         return this.lengthKeyValue() > 0;
>     }
> 
>     /**
>      * Method containsMgmtData
>      *
>      * @return If the KeyInfo contains a MgmtData node
>      */
>     public boolean containsMgmtData() {
>         return this.lengthMgmtData() > 0;
>     }
> 
>     /**
>      * Method containsPGPData
>      *
>      * @return If the KeyInfo contains a PGPData node
>      */
>     public boolean containsPGPData() {
>         return this.lengthPGPData() > 0;
>     }
> 
>     /**
>      * Method containsRetrievalMethod
>      *
>      * @return If the KeyInfo contains a RetrievalMethod node
>      */
>     public boolean containsRetrievalMethod() {
>         return this.lengthRetrievalMethod() > 0;
>     }
> 
>     /**
>      * Method containsSPKIData
>      *
>      * @return If the KeyInfo contains a SPKIData node
>      */
>     public boolean containsSPKIData() {
>         return this.lengthSPKIData() > 0;
>     }
> 
>     /**
>      * Method containsUnknownElement
>      *
>      * @return If the KeyInfo contains a UnknownElement node
>      */
>     public boolean containsUnknownElement() {
>         return this.lengthUnknownElement() > 0;
>     }
> 
>     /**
>      * Method containsX509Data
>      *
>      * @return If the KeyInfo contains a X509Data node
>      */
>     public boolean containsX509Data() {
>         return this.lengthX509Data() > 0;
>     }
> 
>     /**
>      * This method returns the public key.
>      *
>      * @return If the KeyInfo contains a PublicKey node
>      * @throws KeyResolverException
>      */
> 
>     public PublicKey getPublicKey() throws KeyResolverException {
> 
>         PublicKey pk = this.getPublicKeyFromInternalResolvers();
> 
>         if (pk != null) {
>             log.debug("I could find a key using the per-KeyInfo key resolvers");
> 
>             return pk;
>         }
>         log.debug("I couldn't find a key using the per-KeyInfo key resolvers");
> 
>         pk = this.getPublicKeyFromStaticResolvers();
> 
>         if (pk != null) {
>             log.debug("I could find a key using the system-wide key resolvers");
> 
>             return pk;
>         }
>         log.debug("I couldn't find a key using the system-wide key resolvers");
> 
>         return null;
>     }
> 
>     /**
>      * Searches the library wide keyresolvers for public keys
>      *
>      * @return The publick contained in this Node.
>      * @throws KeyResolverException
>      */
>     PublicKey getPublicKeyFromStaticResolvers() throws KeyResolverException {
> 
>         for (int i = 0; i < KeyResolver.length(); i++) {
>             KeyResolver keyResolver = KeyResolver.item(i);
>             Node currentChild=this._constructionElement.getFirstChild();
>             while (currentChild!=null)      {
>                 if (currentChild.getNodeType() == Node.ELEMENT_NODE) {
>                     if (this._storageResolvers.size() == 0) {
> 
>                         // if we do not have storage resolvers, we verify with null
>                         StorageResolver storage = null;
> 
>                         if (keyResolver.canResolve((Element) currentChild,
>                                 this.getBaseURI(), storage)) {
>                             PublicKey pk =
>                                     keyResolver.resolvePublicKey((Element) currentChild,
>                                             this.getBaseURI(),
>                                             storage);
> 
>                             if (pk != null) {
>                                 return pk;
>                             }
>                         }
>                     } else {
>                         for (int k = 0; k < this._storageResolvers.size(); k++) {
>                             StorageResolver storage =
>                                     (StorageResolver) this._storageResolvers.get(k);
> 
>                             if (keyResolver.canResolve((Element) currentChild,
>                                     this.getBaseURI(), storage)) {
>                                 PublicKey pk =
>                                         keyResolver.resolvePublicKey((Element) currentChild,
>                                                 this.getBaseURI(),
>                                                 storage);
> 
>                                 if (pk != null) {
>                                     return pk;
>                                 }
>                             }
>                         }
>                     }
>                 }
>                 currentChild=currentChild.getNextSibling();
>             }
>         }
>         return null;
>     }
> 
>     /**
>      * Searches the per-KeyInfo keyresolvers for public keys
>      *
>      * @return The publick contained in this Node.
>      * @throws KeyResolverException
>      */
>     PublicKey getPublicKeyFromInternalResolvers() throws KeyResolverException {
> 
>         for (int i = 0; i < this.lengthInternalKeyResolver(); i++) {
>             KeyResolverSpi keyResolver = this.itemInternalKeyResolver(i);
>             if (log.isDebugEnabled()) {
>                 log.debug("Try " + keyResolver.getClass().getName());
>             }
779,780c792,827
<                         if (pk != null) {
<                            return pk;
---
>             Node currentChild=this._constructionElement.getFirstChild();
>             while (currentChild!=null)      {
>                 if (currentChild.getNodeType() == Node.ELEMENT_NODE) {
>                     if (this._storageResolvers.size() == 0) {
> 
>                         // if we do not have storage resolvers, we verify with null
>                         StorageResolver storage = null;
> 
>                         if (keyResolver.engineCanResolve((Element) currentChild,
>                                 this.getBaseURI(),
>                                 storage)) {
>                             PublicKey pk =
>                                     keyResolver
>                                     .engineResolvePublicKey((Element) currentChild, this
>                                             .getBaseURI(), storage);
> 
>                             if (pk != null) {
>                                 return pk;
>                             }
>                         }
>                     } else {
>                         for (int k = 0; k < this._storageResolvers.size(); k++) {
>                             StorageResolver storage =
>                                     (StorageResolver) this._storageResolvers.get(k);
> 
>                             if (keyResolver.engineCanResolve((Element) currentChild,
>                                     this.getBaseURI(),
>                                     storage)) {
>                                 PublicKey pk = keyResolver
>                                         .engineResolvePublicKey((Element) currentChild, this
>                                                 .getBaseURI(), storage);
> 
>                                 if (pk != null) {
>                                     return pk;
>                                 }
>                             }
782,784c829,831
<                      }
<                   }
<                }
---
>                     }
>                 }
>                 currentChild=currentChild.getNextSibling();
786,787c833
<          }
<       }
---
>         }
789,790c835,836
<       return null;
<    }
---
>         return null;
>     }
792,839c838,952
<    /**
<     * Searches the per-KeyInfo keyresolvers for public keys
<     *
<     * @return
<     * @throws KeyResolverException
<     */
<    PublicKey getPublicKeyFromInternalResolvers() throws KeyResolverException {
< 
<       for (int i = 0; i < this.lengthInternalKeyResolver(); i++) {
<          KeyResolverSpi keyResolver = this.itemInternalKeyResolver(i);
< 
<          cat.debug("Try " + keyResolver.getClass().getName());
< 
<          for (int j = 0;
<                  j < this._constructionElement.getChildNodes().getLength();
<                  j++) {
<             Node currentChild =
<                this._constructionElement.getChildNodes().item(j);
< 
<             if (currentChild.getNodeType() == Node.ELEMENT_NODE) {
<                if (this._storageResolvers.size() == 0) {
< 
<                   // if we do not have storage resolvers, we verify with null
<                   StorageResolver storage = null;
< 
<                   if (keyResolver.engineCanResolve((Element) currentChild,
<                                                    this.getBaseURI(),
<                                                    storage)) {
<                      PublicKey pk =
<                         keyResolver
<                            .engineResolvePublicKey((Element) currentChild, this
<                               .getBaseURI(), storage);
< 
<                      if (pk != null) {
<                         return pk;
<                      }
<                   }
<                } else {
<                   for (int k = 0; k < this._storageResolvers.size(); k++) {
<                      StorageResolver storage =
<                         (StorageResolver) this._storageResolvers.elementAt(k);
< 
<                      if (keyResolver.engineCanResolve((Element) currentChild,
<                                                       this.getBaseURI(),
<                                                       storage)) {
<                         PublicKey pk = keyResolver
<                            .engineResolvePublicKey((Element) currentChild, this
<                               .getBaseURI(), storage);
---
>     /**
>      * Method getX509Certificate
>      *
>      * @return The certificate contined in this KeyInfo
>      * @throws KeyResolverException
>      */
>     public X509Certificate getX509Certificate() throws KeyResolverException {
> 
>         // First search using the individual resolvers from the user
>         X509Certificate cert = this.getX509CertificateFromInternalResolvers();
> 
>         if (cert != null) {
>             log.debug(
>                     "I could find a X509Certificate using the per-KeyInfo key resolvers");
> 
>             return cert;
>         }
>         log.debug(
>                 "I couldn't find a X509Certificate using the per-KeyInfo key resolvers");
> 
> 
>         // Then use the system-wide Resolvers
>         cert = this.getX509CertificateFromStaticResolvers();
> 
>         if (cert != null) {
>             log.debug(
>                     "I could find a X509Certificate using the system-wide key resolvers");
> 
>             return cert;
>         }
>         log.debug(
>                 "I couldn't find a X509Certificate using the system-wide key resolvers");
> 
> 
>         return null;
>     }
> 
>     /**
>      * This method uses each System-wide {@link KeyResolver} to search the
>      * child elements. Each combination of {@link KeyResolver} and child element
>      * is checked against all {@link StorageResolver}s.
>      *
>      * @return The certificate contined in this KeyInfo
>      * @throws KeyResolverException
>      */
>     X509Certificate getX509CertificateFromStaticResolvers()
>             throws KeyResolverException {
>         if (log.isDebugEnabled()) {
>             log.debug("Start getX509CertificateFromStaticResolvers() with "
>                     + KeyResolver.length() + " resolvers");
>         }
> 
>         for (int i = 0; i < KeyResolver.length(); i++) {
>             KeyResolver keyResolver = KeyResolver.item(i);
>             Node currentChild=this._constructionElement.getFirstChild();
>             while (currentChild!=null)      {
>                 if (currentChild.getNodeType() == Node.ELEMENT_NODE) {
>                     if (this._storageResolvers.size() == 0) {
> 
>                         // if we do not have storage resolvers, we verify with null
>                         StorageResolver storage = null;
> 
>                         if (keyResolver.canResolve((Element) currentChild,
>                                 this.getBaseURI(), storage)) {
>                             X509Certificate cert =
>                                     keyResolver
>                                     .resolveX509Certificate((Element) currentChild, this
>                                             .getBaseURI(), storage);
> 
>                             if (cert != null) {
>                                 return cert;
>                             }
>                         }
>                     } else {
>                         for (int k = 0; k < this._storageResolvers.size(); k++) {
>                             StorageResolver storage =
>                                     (StorageResolver) this._storageResolvers.get(k);
> 
>                             if (keyResolver.canResolve((Element) currentChild,
>                                     this.getBaseURI(), storage)) {
>                                 X509Certificate cert = keyResolver
>                                         .resolveX509Certificate((Element) currentChild, this
>                                                 .getBaseURI(), storage);
> 
>                                 if (cert != null) {
>                                     return cert;
>                                 }
>                             }
>                         }
>                     }
>                 }
>                 currentChild=currentChild.getNextSibling();
>             }
>         }
>         return null;
>     }
> 
>     /**
>      * Method getX509CertificateFromInternalResolvers
>      *
>      * @return The certificate contined in this KeyInfo
>      * @throws KeyResolverException
>      */
>     X509Certificate getX509CertificateFromInternalResolvers()
>             throws KeyResolverException {
>         if (log.isDebugEnabled()) {
>             log.debug("Start getX509CertificateFromInternalResolvers() with "
>                     + this.lengthInternalKeyResolver() + " resolvers");
>         }
> 
>         for (int i = 0; i < this.lengthInternalKeyResolver(); i++) {
>             KeyResolverSpi keyResolver = this.itemInternalKeyResolver(i);
>             if (log.isDebugEnabled()) {
>                 log.debug("Try " + keyResolver.getClass().getName());
>             }
841,842c954,971
<                         if (pk != null) {
<                            return pk;
---
>             Node currentChild=this._constructionElement.getFirstChild();
>             while (currentChild!=null)      {
>                 if (currentChild.getNodeType() == Node.ELEMENT_NODE) {
>                     if (this._storageResolvers.size() == 0) {
> 
>                         // if we do not have storage resolvers, we verify with null
>                         StorageResolver storage = null;
> 
>                         if (keyResolver.engineCanResolve((Element) currentChild,
>                                 this.getBaseURI(),
>                                 storage)) {
>                             X509Certificate cert =
>                                     keyResolver.engineResolveX509Certificate(
>                                             (Element) currentChild, this.getBaseURI(), storage);
> 
>                             if (cert != null) {
>                                 return cert;
>                             }
844,846c973,993
<                      }
<                   }
<                }
---
>                     } else {
>                         for (int k = 0; k < this._storageResolvers.size(); k++) {
>                             StorageResolver storage =
>                                     (StorageResolver) this._storageResolvers.get(k);
> 
>                             if (keyResolver.engineCanResolve((Element) currentChild,
>                                     this.getBaseURI(),
>                                     storage)) {
>                                 X509Certificate cert =
>                                         keyResolver.engineResolveX509Certificate(
>                                                 (Element) currentChild, this.getBaseURI(),
>                                                 storage);
> 
>                                 if (cert != null) {
>                                     return cert;
>                                 }
>                             }
>                         }
>                     }
>                 }
>                 currentChild=currentChild.getNextSibling();
848,849c995
<          }
<       }
---
>         }
851,852c997,998
<       return null;
<    }
---
>         return null;
>     }
854,940c1000,1023
<    /**
<     * Method getX509Certificate
<     *
<     * @return
<     * @throws KeyResolverException
<     */
<    public X509Certificate getX509Certificate() throws KeyResolverException {
< 
<       // First search using the individual resolvers from the user
<       X509Certificate cert = this.getX509CertificateFromInternalResolvers();
< 
<       if (cert != null) {
<          cat.debug(
<             "I could find a X509Certificate using the per-KeyInfo key resolvers");
< 
<          return cert;
<       } else {
<          cat.debug(
<             "I couldn't find a X509Certificate using the per-KeyInfo key resolvers");
<       }
< 
<       // Then use the system-wide Resolvers
<       cert = this.getX509CertificateFromStaticResolvers();
< 
<       if (cert != null) {
<          cat.debug(
<             "I could find a X509Certificate using the system-wide key resolvers");
< 
<          return cert;
<       } else {
<          cat.debug(
<             "I couldn't find a X509Certificate using the system-wide key resolvers");
<       }
< 
<       return null;
<    }
< 
<    /**
<     * This method uses each System-wide {@link KeyResolver} to search the
<     * child elements. Each combination of {@link KeyResolver} and child element
<     * is checked against all {@link StorageResolver}s.
<     *
<     * @return
<     * @throws KeyResolverException
<     */
<    X509Certificate getX509CertificateFromStaticResolvers()
<            throws KeyResolverException {
< 
<       cat.debug("Start getX509CertificateFromStaticResolvers() with "
<                 + KeyResolver.length() + " resolvers");
< 
<       for (int i = 0; i < KeyResolver.length(); i++) {
<          KeyResolver keyResolver = KeyResolver.item(i);
< 
<          for (int j = 0;
<                  j < this._constructionElement.getChildNodes().getLength();
<                  j++) {
<             Node currentChild =
<                this._constructionElement.getChildNodes().item(j);
< 
<             if (currentChild.getNodeType() == Node.ELEMENT_NODE) {
<                if (this._storageResolvers.size() == 0) {
< 
<                   // if we do not have storage resolvers, we verify with null
<                   StorageResolver storage = null;
< 
<                   if (keyResolver.canResolve((Element) currentChild,
<                                              this.getBaseURI(), storage)) {
<                      X509Certificate cert =
<                         keyResolver
<                            .resolveX509Certificate((Element) currentChild, this
<                               .getBaseURI(), storage);
< 
<                      if (cert != null) {
<                         return cert;
<                      }
<                   }
<                } else {
<                   for (int k = 0; k < this._storageResolvers.size(); k++) {
<                      StorageResolver storage =
<                         (StorageResolver) this._storageResolvers.elementAt(k);
< 
<                      if (keyResolver.canResolve((Element) currentChild,
<                                                 this.getBaseURI(), storage)) {
<                         X509Certificate cert = keyResolver
<                            .resolveX509Certificate((Element) currentChild, this
<                               .getBaseURI(), storage);
---
>     /**
>      * This method returns a secret (symmetric) key. This is for XML Encryption.
>      * @return the secret key contained in this KeyInfo
>      * @throws KeyResolverException
>      */
>     public SecretKey getSecretKey() throws KeyResolverException {
>         SecretKey sk = this.getSecretKeyFromInternalResolvers();
> 
>         if (sk != null) {
>             log.debug("I could find a secret key using the per-KeyInfo key resolvers");
> 
>             return sk;
>         }
>         log.debug("I couldn't find a secret key using the per-KeyInfo key resolvers");
> 
> 
>         sk = this.getSecretKeyFromStaticResolvers();
> 
>         if (sk != null) {
>             log.debug("I could find a secret key using the system-wide key resolvers");
> 
>             return sk;
>         }
>         log.debug("I couldn't find a secret key using the system-wide key resolvers");
942,950d1024
<                         if (cert != null) {
<                            return cert;
<                         }
<                      }
<                   }
<                }
<             }
<          }
<       }
952,953c1026,1027
<       return null;
<    }
---
>         return null;
>     }
955,1006c1029,1034
<    /**
<     * Method getX509CertificateFromInternalResolvers
<     *
<     * @return
<     * @throws KeyResolverException
<     */
<    X509Certificate getX509CertificateFromInternalResolvers()
<            throws KeyResolverException {
< 
<       cat.debug("Start getX509CertificateFromInternalResolvers() with "
<                 + this.lengthInternalKeyResolver() + " resolvers");
< 
<       for (int i = 0; i < this.lengthInternalKeyResolver(); i++) {
<          KeyResolverSpi keyResolver = this.itemInternalKeyResolver(i);
< 
<          cat.debug("Try " + keyResolver.getClass().getName());
< 
<          for (int j = 0;
<                  j < this._constructionElement.getChildNodes().getLength();
<                  j++) {
<             Node currentChild =
<                this._constructionElement.getChildNodes().item(j);
< 
<             if (currentChild.getNodeType() == Node.ELEMENT_NODE) {
<                if (this._storageResolvers.size() == 0) {
< 
<                   // if we do not have storage resolvers, we verify with null
<                   StorageResolver storage = null;
< 
<                   if (keyResolver.engineCanResolve((Element) currentChild,
<                                                    this.getBaseURI(),
<                                                    storage)) {
<                      X509Certificate cert =
<                         keyResolver.engineResolveX509Certificate(
<                            (Element) currentChild, this.getBaseURI(), storage);
< 
<                      if (cert != null) {
<                         return cert;
<                      }
<                   }
<                } else {
<                   for (int k = 0; k < this._storageResolvers.size(); k++) {
<                      StorageResolver storage =
<                         (StorageResolver) this._storageResolvers.elementAt(k);
< 
<                      if (keyResolver.engineCanResolve((Element) currentChild,
<                                                       this.getBaseURI(),
<                                                       storage)) {
<                         X509Certificate cert =
<                            keyResolver.engineResolveX509Certificate(
<                               (Element) currentChild, this.getBaseURI(),
<                               storage);
---
>     /**
>      * Searches the library wide keyresolvers for Secret keys
>      *
>      * @return the secret key contained in this KeyInfo
>      * @throws KeyResolverException
>      */
1008,1009c1036,1075
<                         if (cert != null) {
<                            return cert;
---
>     SecretKey getSecretKeyFromStaticResolvers() throws KeyResolverException {
> 
>         for (int i = 0; i < KeyResolver.length(); i++) {
>             KeyResolver keyResolver = KeyResolver.item(i);
> 
>             Node currentChild=this._constructionElement.getFirstChild();
>             while (currentChild!=null)      {
>                 if (currentChild.getNodeType() == Node.ELEMENT_NODE) {
>                     if (this._storageResolvers.size() == 0) {
> 
>                         // if we do not have storage resolvers, we verify with null
>                         StorageResolver storage = null;
> 
>                         if (keyResolver.canResolve((Element) currentChild,
>                                 this.getBaseURI(), storage)) {
>                             SecretKey sk  =
>                                     keyResolver.resolveSecretKey((Element) currentChild,
>                                             this.getBaseURI(),
>                                             storage);
> 
>                             if (sk != null) {
>                                 return sk;
>                             }
>                         }
>                     } else {
>                         for (int k = 0; k < this._storageResolvers.size(); k++) {
>                             StorageResolver storage =
>                                     (StorageResolver) this._storageResolvers.get(k);
> 
>                             if (keyResolver.canResolve((Element) currentChild,
>                                     this.getBaseURI(), storage)) {
>                                 SecretKey sk =
>                                         keyResolver.resolveSecretKey((Element) currentChild,
>                                                 this.getBaseURI(),
>                                                 storage);
> 
>                                 if (sk != null) {
>                                     return sk;
>                                 }
>                             }
1011,1013c1077,1097
<                      }
<                   }
<                }
---
>                     }
>                 }
>                 currentChild=currentChild.getNextSibling();
>             }
>         }
>         return null;
>     }
> 
>     /**
>      * Searches the per-KeyInfo keyresolvers for secret keys
>      *
>      * @return the secret key contained in this KeyInfo
>      * @throws KeyResolverException
>      */
> 
>     SecretKey getSecretKeyFromInternalResolvers() throws KeyResolverException {
> 
>         for (int i = 0; i < this.lengthInternalKeyResolver(); i++) {
>             KeyResolverSpi keyResolver = this.itemInternalKeyResolver(i);
>             if (log.isDebugEnabled()) {
>                 log.debug("Try " + keyResolver.getClass().getName());
1015,1016d1098
<          }
<       }
1018,1019c1100,1141
<       return null;
<    }
---
>             Node currentChild=this._constructionElement.getFirstChild();
>             while (currentChild!=null)      {
>                 if (currentChild.getNodeType() == Node.ELEMENT_NODE) {
>                     if (this._storageResolvers.size() == 0) {
> 
>                         // if we do not have storage resolvers, we verify with null
>                         StorageResolver storage = null;
> 
>                         if (keyResolver.engineCanResolve((Element) currentChild,
>                                 this.getBaseURI(),
>                                 storage)) {
>                             SecretKey sk =
>                                     keyResolver
>                                     .engineResolveSecretKey((Element) currentChild, this
>                                             .getBaseURI(), storage);
> 
>                             if (sk != null) {
>                                 return sk;
>                             }
>                         }
>                     } else {
>                         for (int k = 0; k < this._storageResolvers.size(); k++) {
>                             StorageResolver storage =
>                                     (StorageResolver) this._storageResolvers.get(k);
> 
>                             if (keyResolver.engineCanResolve((Element) currentChild,
>                                     this.getBaseURI(),
>                                     storage)) {
>                                 SecretKey sk = keyResolver
>                                         .engineResolveSecretKey((Element) currentChild, this
>                                                 .getBaseURI(), storage);
> 
>                                 if (sk != null) {
>                                     return sk;
>                                 }
>                             }
>                         }
>                     }
>                 }
>                 currentChild=currentChild.getNextSibling();
>             }
>         }
1021,1081c1143,1144
<    /**
<     * Stores the individual (per-KeyInfo) {@link KeyResolver}s
<     */
<    Vector _internalKeyResolvers = new Vector();
< 
<    /**
<     * This method is used to add a custom {@link KeyResolverSpi} to a KeyInfo
<     * object.
<     *
<     * @param realKeyResolver
<     */
<    public void registerInternalKeyResolver(KeyResolverSpi realKeyResolver) {
<       this._internalKeyResolvers.add(realKeyResolver);
<    }
< 
<    /**
<     * Method lengthInternalKeyResolver
<     *
<     * @return
<     */
<    int lengthInternalKeyResolver() {
<       return this._internalKeyResolvers.size();
<    }
< 
<    /**
<     * Method itemInternalKeyResolver
<     *
<     * @param i
<     * @return
<     */
<    KeyResolverSpi itemInternalKeyResolver(int i) {
<       return (KeyResolverSpi) this._internalKeyResolvers.elementAt(i);
<    }
< 
<    /** Field _storageResolvers */
<    Vector _storageResolvers = new Vector();
< 
<    /**
<     * Method addStorageResolver
<     *
<     * @param storageResolver
<     */
<    public void addStorageResolver(StorageResolver storageResolver) {
< 
<       if (storageResolver != null) {
<          this._storageResolvers.add(storageResolver);
<       }
<    }
< 
<    /**
<     * Method getStorageResolvers
<     *
<     * @return
<     */
<    Vector getStorageResolvers() {
<       return this._storageResolvers;
<    }
< 
<    //J-
<    static boolean _alreadyInitialized = false;
<    public static void init() {
---
>         return null;
>     }
1083,1084c1146,1216
<       if (!KeyInfo._alreadyInitialized) {
<          if (KeyInfo.cat == null) {
---
>     /**
>      * Stores the individual (per-KeyInfo) {@link KeyResolver}s
>      */
>     List _internalKeyResolvers = new ArrayList();
> 
>     /**
>      * This method is used to add a custom {@link KeyResolverSpi} to a KeyInfo
>      * object.
>      *
>      * @param realKeyResolver
>      */
>     public void registerInternalKeyResolver(KeyResolverSpi realKeyResolver) {
>         this._internalKeyResolvers.add(realKeyResolver);
>     }
> 
>     /**
>      * Method lengthInternalKeyResolver
>      * @return
>      */
>     int lengthInternalKeyResolver() {
>         return this._internalKeyResolvers.size();
>     }
> 
>     /**
>      * Method itemInternalKeyResolver
>      *
>      * @param i
>      * @return
>      */
>     KeyResolverSpi itemInternalKeyResolver(int i) {
>         return (KeyResolverSpi) this._internalKeyResolvers.get(i);
>     }
> 
>     /** Field _storageResolvers */
>     List _storageResolvers = new ArrayList();
> 
>     /**
>      * Method addStorageResolver
>      *
>      * @param storageResolver
>      */
>     public void addStorageResolver(StorageResolver storageResolver) {
> 
>         if (storageResolver != null) {
>             this._storageResolvers.add(storageResolver);
>         }
>     }
> 
>     /**
>      * Method getStorageResolvers
>      *
>      * @return
>      */
>     List getStorageResolvers() {
>         return this._storageResolvers;
>     }
> 
>     //J-
>     static boolean _alreadyInitialized = false;
>     /** init the keyinfo (Still needed?)*/
>     public static void init() {
> 
>         if (!KeyInfo._alreadyInitialized) {
>             if (KeyInfo.log == null) {
> 
>                 /**
>                  * $todo$ why the hell does the static initialization from the
>                  *  start not work ?
>                  */
>                 KeyInfo.log =
>                         org.apache.commons.logging.LogFactory.getLog(KeyInfo.class.getName());
1086,1091c1218,1219
<             /**
<              * @todo why the hell does the static initialization from the
<              *  start not work ?
<              */
<             KeyInfo.cat =
<                org.apache.log4j.Category.getInstance(KeyInfo.class.getName());
---
>                 log.error("Had to assign log in the init() function");
>             }
1093,1094c1221,1234
<             cat.error("Had to assign cat in the init() function");
<          }
---
>             // KeyInfo._contentHandlerHash = new HashMap(10);
>             KeyInfo._alreadyInitialized = true;
>         }
>     }
> 
>     /** @inheritDoc */
>     @Override
>     public String getBaseLocalName() {
>         return Constants._TAG_KEYINFO;
>     }
> 
>     public static void registerKeyInfoContentHandler(String string, String string2,
>             String string3) {
>         // TODO Auto-generated method stub
1096,1110c1236
<          // KeyInfo._contentHandlerHash = new HashMap(10);
<          KeyInfo._alreadyInitialized = true;
<       }
<    }
< 
<    public static void registerKeyInfoContentHandler(
<            String namespace, String localname, String implementingClass)
<               throws ContentHandlerAlreadyRegisteredException {
<       Init.registerKeyInfoContentHandler(namespace, localname,
<                                          implementingClass);
<    }
< 
<    public String getBaseLocalName() {
<       return Constants._TAG_KEYINFO;
<    }
---
>     }
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/keyresolver/implementations/DSAKeyValueResolver.java xml-security-1_2_0/src/org/apache/xml/security/keys/keyresolver/implementations/DSAKeyValueResolver.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,66c21,24
< import java.security.*;
< import java.security.cert.*;
< import java.security.spec.*;
< import javax.xml.transform.TransformerException;
---
> import java.security.PublicKey;
> import java.security.cert.X509Certificate;
> 
> 
69,74c27,31
< import org.apache.xml.security.keys.keyresolver.*;
< import org.apache.xml.security.keys.storage.*;
< import org.apache.xml.security.signature.XMLSignatureException;
< import org.apache.xml.security.utils.*;
< import org.apache.xpath.XPathAPI;
< import org.w3c.dom.*;
---
> import org.apache.xml.security.keys.keyresolver.KeyResolverSpi;
> import org.apache.xml.security.keys.storage.StorageResolver;
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Element;
79c36
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
86,93c43
<    /**
<     * Method engineCanResolve
<     *
<     * @param element
<     * @param BaseURI
<     * @param storage
<     * @return
<     */
---
>    /** @inheritDoc */
106,113c56,59
<       if (isKeyValue) {
<          try {
<             Element nscontext = XMLUtils.createDSctx(element.getOwnerDocument(),
<                                                      "ds",
<                                                      Constants.SignatureSpecNS);
< 
<             this._dsaKeyElement = (Element) XPathAPI.selectSingleNode(element,
<                     "./ds:" + Constants._TAG_DSAKEYVALUE, nscontext);
---
>       if (isKeyValue) {         
>      
>             this._dsaKeyElement =
>             	XMLUtils.selectDsNode(element.getFirstChild(),Constants._TAG_DSAKEYVALUE,0);                    
117,118c63
<             }
<          } catch (TransformerException ex) {}
---
>             }         
138d82
<     * @throws KeyResolverException
141,142c85
<            Element element, String BaseURI, StorageResolver storage)
<               throws KeyResolverException {
---
>            Element element, String BaseURI, StorageResolver storage) {
160c103
<          ;
---
> 		//do nothing
166,174c109,110
<    /**
<     * Method engineResolveX509Certificate
<     *
<     * @param element
<     * @param BaseURI
<     * @param storage
<     * @return
<     * @throws KeyResolverException
<     */
---
>    
>    /** @inheritDoc */
176,177c112
<            Element element, String BaseURI, StorageResolver storage)
<               throws KeyResolverException {
---
>            Element element, String BaseURI, StorageResolver storage) {
181,189c116
<    /**
<     * Method engineResolveSecretKey
<     *
<     * @param element
<     * @param BaseURI
<     * @param storage
<     * @return
<     * @throws KeyResolverException
<     */
---
>    /** @inheritDoc */
191,192c118
<            Element element, String BaseURI, StorageResolver storage)
<               throws KeyResolverException {
---
>            Element element, String BaseURI, StorageResolver storage){
Only in xml-security-1_2_0/src/org/apache/xml/security/keys/keyresolver/implementations: EncryptedKeyResolver.java
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/keyresolver/implementations/package.html xml-security-1_2_0/src/org/apache/xml/security/keys/keyresolver/implementations/package.html
2c2
< implementations for retrieval of certificates and public keys from elements
---
> implementations for retrieval of certificates and public keys from elements.
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/keyresolver/implementations/RetrievalMethodResolver.java xml-security-1_2_0/src/org/apache/xml/security/keys/keyresolver/implementations/RetrievalMethodResolver.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
65,66d22
< import java.security.*;
< import java.security.spec.*;
68,71c24,27
< import java.security.cert.*;
< import javax.xml.transform.TransformerException;
< import org.apache.xpath.XPathAPI;
< import org.w3c.dom.*;
---
> import java.security.cert.CertificateException;
> import java.security.cert.CertificateFactory;
> import java.security.cert.X509Certificate;
> 
73,81c29,42
< import org.apache.xml.security.keys.content.*;
< import org.apache.xml.security.keys.content.keyvalues.*;
< import org.apache.xml.security.keys.content.x509.*;
< import org.apache.xml.security.keys.keyresolver.*;
< import org.apache.xml.security.keys.storage.*;
< import org.apache.xml.security.signature.*;
< import org.apache.xml.security.transforms.*;
< import org.apache.xml.security.utils.*;
< import org.apache.xml.security.utils.resolver.*;
---
> import org.apache.xml.security.keys.content.RetrievalMethod;
> import org.apache.xml.security.keys.content.x509.XMLX509Certificate;
> import org.apache.xml.security.keys.keyresolver.KeyResolver;
> import org.apache.xml.security.keys.keyresolver.KeyResolverException;
> import org.apache.xml.security.keys.keyresolver.KeyResolverSpi;
> import org.apache.xml.security.keys.storage.StorageResolver;
> import org.apache.xml.security.signature.XMLSignatureInput;
> import org.apache.xml.security.transforms.Transforms;
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.XMLUtils;
> import org.apache.xml.security.utils.resolver.ResourceResolver;
> import org.w3c.dom.Attr;
> import org.w3c.dom.Element;
> import org.w3c.dom.Node;
93c54
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
97,100c58,61
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category
<          .getInstance(RetrievalMethodResolver.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(
>                         RetrievalMethodResolver.class.getName());
104c65
<     *
---
>     * @inheritDoc
108c69
<     * @return
---
>     *
113,116c74,76
<       try {
<          XMLUtils.guaranteeThatElementInSignatureSpace(element,
<                  Constants._TAG_RETRIEVALMETHOD);
<       } catch (XMLSignatureException ex) {
---
>       if 
>          (!XMLUtils.elementIsInSignatureSpace(element,
>                  Constants._TAG_RETRIEVALMETHOD)) {      
125c85
<     *
---
>     * @inheritDoc
129,130c89
<     * @return
<     * @throws KeyResolverException
---
>     *
134c93
<               throws KeyResolverException {
---
>               {
147,148c106,107
< 
<             cat.debug("Before applying Transforms, resource has "
---
>             if (log.isDebugEnabled())
>             	log.debug("Before applying Transforms, resource has "
152c111
<                cat.debug("We have Transforms");
---
>                log.debug("We have Transforms");
156,157c115,116
< 
<             cat.debug("After applying Transforms, resource has "
---
>             if (log.isDebugEnabled()) {
>             	log.debug("After applying Transforms, resource has "
159c118,119
<             cat.debug("Resolved to resource " + resource.getSourceURI());
---
>             	log.debug("Resolved to resource " + resource.getSourceURI());
>             }
179c139,140
<                cat.debug("we have to parse " + inputBytes.length + " bytes");
---
>                 if (log.isDebugEnabled())
>                 	log.debug("we have to parse " + inputBytes.length + " bytes");
182,183c143,144
< 
<                cat.debug("Now we have a {" + e.getNamespaceURI() + "}"
---
>                if (log.isDebugEnabled())
>                	    log.debug("Now we have a {" + e.getNamespaceURI() + "}"
187c148
<                   KeyResolver newKeyResolver = KeyResolver.getInstance(e,
---
>                   KeyResolver newKeyResolver = KeyResolver.getInstance(getFirstElementChild(e),
191c152
<                      return newKeyResolver.resolvePublicKey(e, BaseURI,
---
>                      return newKeyResolver.resolvePublicKey(getFirstElementChild(e), BaseURI,
198c159
<          cat.debug("XMLSecurityException", ex);
---
>          log.debug("XMLSecurityException", ex);
200c161
<          cat.debug("CertificateException", ex);
---
>          log.debug("CertificateException", ex);
202c163
<          cat.debug("IOException", ex);
---
>          log.debug("IOException", ex);
210c171
<     *
---
>     * @inheritDoc
214,215c175
<     * @return
<     * @throws KeyResolverException
---
>     *
219c179
<               throws KeyResolverException {
---
>               {
224d183
<          String type = rm.getType();
226,227c185,186
< 
<          cat.debug("Asked to resolve URI " + uri);
---
>          if (log.isDebugEnabled())
>          	log.debug("Asked to resolve URI " + uri);
233,234c192,193
< 
<             cat.debug("Before applying Transforms, resource has "
---
>             if (log.isDebugEnabled())
>             	log.debug("Before applying Transforms, resource has "
238c197
<                cat.debug("We have Transforms");
---
>                log.debug("We have Transforms");
242,243c201,203
< 
<             cat.debug("After applying Transforms, resource has "
---
>             
>             if (log.isDebugEnabled()) {
>             	log.debug("After applying Transforms, resource has "
245c205,206
<             cat.debug("Resolved to resource " + resource.getSourceURI());
---
>             	log.debug("Resolved to resource " + resource.getSourceURI());
>             }
266c227,228
<                cat.debug("we have to parse " + inputBytes.length + " bytes");
---
>                 if (log.isDebugEnabled())
>                 	log.debug("we have to parse " + inputBytes.length + " bytes");
270c232,233
<                cat.debug("Now we have a {" + e.getNamespaceURI() + "}"
---
>                if (log.isDebugEnabled())
>                	    log.debug("Now we have a {" + e.getNamespaceURI() + "}"
274c237
<                   KeyResolver newKeyResolver = KeyResolver.getInstance(e,
---
>                   KeyResolver newKeyResolver = KeyResolver.getInstance(getFirstElementChild(e),
278c241
<                      return newKeyResolver.resolveX509Certificate(e, BaseURI,
---
>                      return newKeyResolver.resolveX509Certificate(getFirstElementChild(e), BaseURI,
285c248
<          cat.debug("XMLSecurityException", ex);
---
>          log.debug("XMLSecurityException", ex);
287c250
<          cat.debug("CertificateException", ex);
---
>          log.debug("CertificateException", ex);
289c252
<          cat.debug("IOException", ex);
---
>          log.debug("IOException", ex);
299c262
<     * @return
---
>     * @return the Document Element after parsing bytes 
326c289
<     *
---
>     * @inheritDoc
330,331c293
<     * @return
<     * @throws KeyResolverException
---
>     *
335c297
<               throws KeyResolverException {
---
>    {
336a299,305
>    }
>    static Element getFirstElementChild(Element e){
>    	    Node n=e.getFirstChild();
>    	    while (n!=null && n.getNodeType()!=Node.ELEMENT_NODE) {
>    	    	n=n.getNextSibling();
>    	    }
>    		return (Element)n;
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/keyresolver/implementations/RSAKeyValueResolver.java xml-security-1_2_0/src/org/apache/xml/security/keys/keyresolver/implementations/RSAKeyValueResolver.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64,65c22
< import java.security.*;
< import java.security.spec.*;
---
> import java.security.PublicKey;
67,71c24,25
< import org.w3c.dom.*;
< import org.apache.xml.security.keys.content.keyvalues.RSAKeyValue;
< import org.apache.xml.security.keys.keyresolver.*;
< import org.apache.xml.security.utils.*;
< import org.apache.xml.security.signature.XMLSignatureException;
---
> 
> 
73,75c27,32
< import javax.xml.transform.TransformerException;
< import org.apache.xpath.XPathAPI;
< import org.apache.xml.security.keys.storage.*;
---
> import org.apache.xml.security.keys.content.keyvalues.RSAKeyValue;
> import org.apache.xml.security.keys.keyresolver.KeyResolverSpi;
> import org.apache.xml.security.keys.storage.StorageResolver;
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Element;
80c37
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
84,87c41,44
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category
<          .getInstance(RSAKeyValueResolver.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(
>                         RSAKeyValueResolver.class.getName());
92,99c49
<    /**
<     * Method engineCanResolve
<     *
<     * @param element
<     * @param BaseURI
<     * @param storage
<     * @return
<     */
---
>    /** @inheritDoc */
102,103c52,53
< 
<       cat.debug("Can I resolve " + element.getTagName());
---
>    	  if (log.isDebugEnabled())
>    	  	log.debug("Can I resolve " + element.getTagName());
114,119c64,66
<       if (isKeyValue) {
<          try {
<          Element nscontext = XMLUtils.createDSctx(element.getOwnerDocument(), "ds", Constants.SignatureSpecNS);
< 
<             this._rsaKeyElement = (Element) XPathAPI.selectSingleNode(element,
<                     "./ds:" + Constants._TAG_RSAKEYVALUE, nscontext);
---
>       if (isKeyValue) {                  
>             this._rsaKeyElement = XMLUtils.selectDsNode(element.getFirstChild(),
>                     Constants._TAG_RSAKEYVALUE, 0);
123,124c70
<             }
<          } catch (TransformerException ex) {}
---
>             }         
137,145c83
<    /**
<     * Method engineResolvePublicKey
<     *
<     * @param element
<     * @param BaseURI
<     * @param storage
<     * @return null if no {@link PublicKey} could be obtained
<     * @throws KeyResolverException
<     */
---
>    /** @inheritDoc */
147,148c85
<            Element element, String BaseURI, StorageResolver storage)
<               throws KeyResolverException {
---
>            Element element, String BaseURI, StorageResolver storage) {
165c102
<          cat.debug("XMLSecurityException", ex);
---
>          log.debug("XMLSecurityException", ex);
171,179c108
<    /**
<     * Method engineResolveX509Certificate
<     *
<     * @param element
<     * @param BaseURI
<     * @param storage
<     * @return
<     * @throws KeyResolverException
<     */
---
>    /** @inheritDoc */
181,182c110
<            Element element, String BaseURI, StorageResolver storage)
<               throws KeyResolverException {
---
>            Element element, String BaseURI, StorageResolver storage) {
186,194c114
<    /**
<     * Method engineResolveSecretKey
<     *
<     * @param element
<     * @param BaseURI
<     * @param storage
<     * @return
<     * @throws KeyResolverException
<     */
---
>    /** @inheritDoc */
196,197c116
<            Element element, String BaseURI, StorageResolver storage)
<               throws KeyResolverException {
---
>            Element element, String BaseURI, StorageResolver storage) {
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/keyresolver/implementations/X509CertificateResolver.java xml-security-1_2_0/src/org/apache/xml/security/keys/keyresolver/implementations/X509CertificateResolver.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64,72c22,25
< import java.io.ByteArrayInputStream;
< import java.security.*;
< import java.security.spec.*;
< import java.security.cert.*;
< import org.w3c.dom.*;
< import org.apache.xml.security.keys.content.x509.XMLX509Certificate;
< import org.apache.xml.security.keys.keyresolver.*;
< import org.apache.xml.security.utils.*;
< import org.apache.xml.security.signature.XMLSignatureException;
---
> import java.security.PublicKey;
> import java.security.cert.X509Certificate;
> 
> 
74,76c27,33
< import javax.xml.transform.TransformerException;
< import org.apache.xpath.XPathAPI;
< import org.apache.xml.security.keys.storage.*;
---
> import org.apache.xml.security.keys.content.x509.XMLX509Certificate;
> import org.apache.xml.security.keys.keyresolver.KeyResolverException;
> import org.apache.xml.security.keys.keyresolver.KeyResolverSpi;
> import org.apache.xml.security.keys.storage.StorageResolver;
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Element;
83c40
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
87,90c44,46
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category
<          .getInstance(X509CertificateResolver.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(X509CertificateResolver.class.getName());
93c49
<    NodeList _x509CertKeyElements = null;
---
>    Element[] _x509CertKeyElements = null;
97c53
<     *
---
>     * @inheritDoc
101c57
<     * @return
---
>     *
104a61,62
>    	  if (log.isDebugEnabled())
>    	  	log.debug("Can I resolve " + element.getTagName() + "?");
106,112c64,66
<       cat.debug("Can I resolve " + element.getTagName() + "?");
< 
<       try {
<          XMLUtils.guaranteeThatElementInSignatureSpace(element,
<                  Constants._TAG_X509DATA);
<       } catch (XMLSignatureException ex) {
<          cat.debug("I can't");
---
>       if (!XMLUtils.elementIsInSignatureSpace(element,
>                  Constants._TAG_X509DATA)) {
>          log.debug("I can't");
115a70
>          
117,121c72,73
<       try {
<          Element nscontext = XMLUtils.createDSctx(element.getOwnerDocument(), "ds", Constants.SignatureSpecNS);
< 
<          this._x509CertKeyElements = XPathAPI.selectNodeList(element,
<                  "./ds:" + Constants._TAG_X509CERTIFICATE, nscontext);
---
>          this._x509CertKeyElements = XMLUtils.selectDsNodes(element.getFirstChild(),
>                  Constants._TAG_X509CERTIFICATE);
124,125c76,77
<                  && (this._x509CertKeyElements.getLength() > 0)) {
<             cat.debug("Yes Sir, I can");
---
>                  && (this._x509CertKeyElements.length > 0)) {
>             log.debug("Yes Sir, I can");
129d80
<       } catch (TransformerException ex) {}
131c82
<       cat.debug("I can't");
---
>       log.debug("I can't");
141c92
<     *
---
>     * @inheritDoc
145c96
<     * @return
---
>     *
164c115
<     *
---
>     * @inheritDoc
168c119
<     * @return
---
>     *
177c128
<                  || (this._x509CertKeyElements.getLength() == 0)) {
---
>                  || (this._x509CertKeyElements.length == 0)) {
182c133
<                     || (this._x509CertKeyElements.getLength() == 0)) {
---
>                     || (this._x509CertKeyElements.length == 0)) {
188c139
<             new XMLX509Certificate[this._x509CertKeyElements.getLength()];
---
>             new XMLX509Certificate[this._x509CertKeyElements.length];
191c142
<          for (int i = 0; i < this._x509CertKeyElements.getLength(); i++) {
---
>          for (int i = 0; i < this._x509CertKeyElements.length; i++) {
193,194c144,145
<                new XMLX509Certificate((Element) this._x509CertKeyElements
<                   .item(i), BaseURI);
---
>                new XMLX509Certificate(this._x509CertKeyElements[i]
>                   , BaseURI);
207c158
<          cat.debug("XMLSecurityException", ex);
---
>          log.debug("XMLSecurityException", ex);
215c166
<     *
---
>     * @inheritDoc
219,220c170
<     * @return
<     * @throws KeyResolverException
---
>     *
224c174
<               throws KeyResolverException {
---
>    {
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/keyresolver/implementations/X509IssuerSerialResolver.java xml-security-1_2_0/src/org/apache/xml/security/keys/keyresolver/implementations/X509IssuerSerialResolver.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64,72c22,24
< import java.io.IOException;
< import java.io.ByteArrayInputStream;
< import java.math.BigInteger;
< import java.security.*;
< import java.security.cert.*;
< import java.security.spec.*;
< import javax.xml.transform.TransformerException;
< import org.apache.xpath.XPathAPI;
< import org.w3c.dom.*;
---
> import java.security.PublicKey;
> import java.security.cert.X509Certificate;
> 
74d25
< import org.apache.xml.security.keys.content.x509.XMLX509IssuerSerial;
76,77c27,30
< import org.apache.xml.security.keys.keyresolver.*;
< import org.apache.xml.security.keys.storage.*;
---
> import org.apache.xml.security.keys.content.x509.XMLX509IssuerSerial;
> import org.apache.xml.security.keys.keyresolver.KeyResolverException;
> import org.apache.xml.security.keys.keyresolver.KeyResolverSpi;
> import org.apache.xml.security.keys.storage.StorageResolver;
79c32,33
< import org.apache.xml.security.utils.*;
---
> import org.apache.xml.security.utils.Constants;
> import org.w3c.dom.Element;
84c38
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
88,100c42,47
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category
<          .getInstance(X509IssuerSerialResolver.class.getName());
< 
<    /**
<     * Method engineCanResolve
<     *
<     * @param element
<     * @param BaseURI
<     * @param storage
<     * @return
<     */
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(
>                     X509IssuerSerialResolver.class.getName());
> 
>     /** @inheritDoc */
103,104c50,51
< 
<       cat.debug("Can I resolve " + element.getTagName() + "?");
---
>       if (log.isDebugEnabled())
>       	log.debug("Can I resolve " + element.getTagName() + "?");
110c57
<          cat.debug("I can't");
---
>          log.debug("I can't");
114c61
<          cat.debug("I can't");
---
>          log.debug("I can't");
120c67
<          cat.debug("I can't");
---
>          log.debug("I can't");
128c75
<       cat.debug("I can't");
---
>       log.debug("I can't");
132,140c79
<    /**
<     * Method engineResolvePublicKey
<     *
<     * @param element
<     * @param BaseURI
<     * @param storage
<     * @return
<     * @throws KeyResolverException
<     */
---
>    /** @inheritDoc */
155,163c94
<    /**
<     * Method engineResolveX509Certificate
<     *
<     * @param element
<     * @param BaseURI
<     * @param storage
<     * @return
<     * @throws KeyResolverException
<     */
---
>    /** @inheritDoc */
175c106
<             cat.info("", ex);
---
>             log.info("", ex);
186c117,118
<             cat.debug("Found Certificate Issuer: "
---
>             if (log.isDebugEnabled()) {
>             	log.debug("Found Certificate Issuer: "
188c120
<             cat.debug("Found Certificate Serial: "
---
>             	log.debug("Found Certificate Serial: "
189a122
>             }
194c127,128
<                cat.debug("Found Element Issuer:     "
---
>                if (log.isDebugEnabled()) {
>                	    log.debug("Found Element Issuer:     "
196c130
<                cat.debug("Found Element Serial:     "
---
>                	    log.debug("Found Element Serial:     "
198c132
< 
---
>                }
201c135
<                   cat.debug("match !!! ");
---
>                   log.debug("match !!! ");
204,206c138,139
<                } else {
<                   cat.debug("no match...");
<                }
---
>                } 
>                 log.debug("no match...");               
212c145
<          cat.debug("XMLSecurityException", ex);
---
>          log.debug("XMLSecurityException", ex);
218,226c151
<    /**
<     * Method engineResolveSecretKey
<     *
<     * @param element
<     * @param BaseURI
<     * @param storage
<     * @return
<     * @throws KeyResolverException
<     */
---
>    /** @inheritDoc */
228,229c153
<            Element element, String BaseURI, StorageResolver storage)
<               throws KeyResolverException {
---
>            Element element, String BaseURI, StorageResolver storage) {
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/keyresolver/implementations/X509SKIResolver.java xml-security-1_2_0/src/org/apache/xml/security/keys/keyresolver/implementations/X509SKIResolver.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64,72c22,25
< import java.io.ByteArrayInputStream;
< import java.security.*;
< import java.security.spec.*;
< import java.security.cert.*;
< import org.w3c.dom.*;
< import org.apache.xml.security.keys.content.x509.XMLX509SKI;
< import org.apache.xml.security.keys.keyresolver.*;
< import org.apache.xml.security.utils.*;
< import org.apache.xml.security.signature.XMLSignatureException;
---
> import java.security.PublicKey;
> import java.security.cert.X509Certificate;
> 
> 
74,76c27,33
< import javax.xml.transform.TransformerException;
< import org.apache.xpath.XPathAPI;
< import org.apache.xml.security.keys.storage.*;
---
> import org.apache.xml.security.keys.content.x509.XMLX509SKI;
> import org.apache.xml.security.keys.keyresolver.KeyResolverException;
> import org.apache.xml.security.keys.keyresolver.KeyResolverSpi;
> import org.apache.xml.security.keys.storage.StorageResolver;
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Element;
82c39
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
86,88c43,45
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(X509SKIResolver.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(X509SKIResolver.class.getName());
91c48
<    private NodeList _x509childNodes = null;
---
>    private Element _x509childNodes[] = null;
96,98d52
<    /** Field _currentNode */
<    private int _currentNode = 0;
< 
101c55
<     *
---
>     * @inheritDoc
105c59
<     * @return
---
>     *
109,116c63,69
< 
<       cat.debug("Can I resolve " + element.getTagName() + "?");
< 
<       try {
<          XMLUtils.guaranteeThatElementInSignatureSpace(element,
<                  Constants._TAG_X509DATA);
<       } catch (XMLSignatureException ex) {
<          cat.debug("I can't");
---
>       if (log.isDebugEnabled()) {
>       	log.debug("Can I resolve " + element.getTagName() + "?");
>       }
>       
>          if (!XMLUtils.elementIsInSignatureSpace(element,
>                  Constants._TAG_X509DATA)) {
>          log.debug("I can't");
121,122c74,75
<       try {
<          Element nscontext = XMLUtils.createDSctx(element.getOwnerDocument(), "ds", Constants.SignatureSpecNS);
---
>       
>  
124,125c77,78
<          this._x509childNodes = XPathAPI.selectNodeList(element,
<                  "./ds:" + Constants._TAG_X509SKI, nscontext);
---
>          this._x509childNodes = XMLUtils.selectDsNodes(element,
>                   Constants._TAG_X509SKI);
128,129c81,82
<                  && (this._x509childNodes.getLength() > 0)) {
<             cat.debug("Yes Sir, I can");
---
>                  && (this._x509childNodes.length > 0)) {
>             log.debug("Yes Sir, I can");
133,135c86,87
<       } catch (TransformerException ex) {}
< 
<       cat.debug("I can't");
---
>       
>       log.debug("I can't");
165c117
<     *
---
>     * @inheritDoc
169c121
<     * @return
---
>     *
192c144
<             cat.info("", ex);
---
>             log.info("", ex);
198c150
<             new XMLX509SKI[this._x509childNodes.getLength()];
---
>             new XMLX509SKI[this._x509childNodes.length];
200c152
<          for (int i = 0; i < this._x509childNodes.getLength(); i++) {
---
>          for (int i = 0; i < this._x509childNodes.length; i++) {
202c154
<                new XMLX509SKI((Element) this._x509childNodes.item(i), BaseURI);
---
>                new XMLX509SKI(this._x509childNodes[i], BaseURI);
211c163
<                   cat.debug("Return PublicKey from "
---
>                   log.debug("Return PublicKey from "
227c179
<     *
---
>     * @inheritDoc
231,232c183
<     * @return
<     * @throws KeyResolverException
---
>     *
236c187
<               throws KeyResolverException {
---
>     {
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/keyresolver/implementations/X509SubjectNameResolver.java xml-security-1_2_0/src/org/apache/xml/security/keys/keyresolver/implementations/X509SubjectNameResolver.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,70c21,24
< import java.io.IOException;
< import java.io.ByteArrayInputStream;
< import java.security.*;
< import java.security.cert.*;
< import java.security.spec.*;
< import javax.xml.transform.TransformerException;
< import org.apache.xpath.XPathAPI;
< import org.w3c.dom.*;
---
> import java.security.PublicKey;
> import java.security.cert.X509Certificate;
> 
> 
73,76c27,32
< import org.apache.xml.security.keys.keyresolver.*;
< import org.apache.xml.security.keys.storage.*;
< import org.apache.xml.security.signature.XMLSignatureException;
< import org.apache.xml.security.utils.*;
---
> import org.apache.xml.security.keys.keyresolver.KeyResolverException;
> import org.apache.xml.security.keys.keyresolver.KeyResolverSpi;
> import org.apache.xml.security.keys.storage.StorageResolver;
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Element;
81c37
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
85,88c41,44
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category
<          .getInstance(X509SubjectNameResolver.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(
>                     X509SubjectNameResolver.class.getName());
91c47
<    private NodeList _x509childNodes = null;
---
>    private Element[] _x509childNodes = null;
96,98d51
<    /** Field _currentNode */
<    private int _currentNode = 0;
< 
101c54
<     *
---
>     * @inheritDoc
105c58
<     * @return
---
>     *
108a62,63
>       if (log.isDebugEnabled())
>       	log.debug("Can I resolve " + element.getTagName() + "?");
110,116c65,68
<       cat.debug("Can I resolve " + element.getTagName() + "?");
< 
<       try {
<          XMLUtils.guaranteeThatElementInSignatureSpace(element,
<                  Constants._TAG_X509DATA);
<       } catch (XMLSignatureException ex) {
<          cat.debug("I can't");
---
>       
>        if (!XMLUtils.elementIsInSignatureSpace(element,
>                  Constants._TAG_X509DATA) ) {      
>          log.debug("I can't");
121,124d72
<       try {
<          Element nscontext = XMLUtils.createDSctx(element.getOwnerDocument(),
<                                                   "ds",
<                                                   Constants.SignatureSpecNS);
126,127c74,76
<          this._x509childNodes = XPathAPI.selectNodeList(element,
<                  "./ds:" + Constants._TAG_X509SUBJECTNAME, nscontext);
---
>          
>          this._x509childNodes = XMLUtils.selectDsNodes(element,
>                  Constants._TAG_X509SUBJECTNAME);
130,131c79,80
<                  && (this._x509childNodes.getLength() > 0)) {
<             cat.debug("Yes Sir, I can");
---
>                  && (this._x509childNodes.length > 0)) {
>             log.debug("Yes Sir, I can");
135c84
<       } catch (TransformerException ex) {}
---
>      
137c86
<       cat.debug("I can't");
---
>       log.debug("I can't");
167c116
<     *
---
>     * @inheritDoc
171c120
<     * @return
---
>     *
194c143
<             cat.info("", ex);
---
>             log.info("", ex);
200c149
<             new XMLX509SubjectName[this._x509childNodes.getLength()];
---
>             new XMLX509SubjectName[this._x509childNodes.length];
202c151
<          for (int i = 0; i < this._x509childNodes.getLength(); i++) {
---
>          for (int i = 0; i < this._x509childNodes.length; i++) {
204c153
<                new XMLX509SubjectName((Element) this._x509childNodes.item(i),
---
>                new XMLX509SubjectName(this._x509childNodes[i],
213c162
<             cat.debug("Found Certificate SN: " + certSN.getSubjectName());
---
>             log.debug("Found Certificate SN: " + certSN.getSubjectName());
216c165
<                cat.debug("Found Element SN:     "
---
>                log.debug("Found Element SN:     "
220c169
<                   cat.debug("match !!! ");
---
>                   log.debug("match !!! ");
223,225c172,173
<                } else {
<                   cat.debug("no match...");
<                }
---
>                } 
>                log.debug("no match...");               
231c179
<          cat.debug("XMLSecurityException", ex);
---
>          log.debug("XMLSecurityException", ex);
239c187
<     *
---
>     * @inheritDoc
243,244c191
<     * @return
<     * @throws KeyResolverException
---
>     *
248c195
<               throws KeyResolverException {
---
>    {
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/keyresolver/InvalidKeyResolverException.java xml-security-1_2_0/src/org/apache/xml/security/keys/keyresolver/InvalidKeyResolverException.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights 
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer. 
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:  
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written 
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European 
<  * Commission in the <WebSig> project in the ISIS Programme. 
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
70c28
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
85c43
<     * @param msgID
---
>     * @param _msgID
87,88c45,46
<    public InvalidKeyResolverException(String msgID) {
<       super(msgID);
---
>    public InvalidKeyResolverException(String _msgID) {
>       super(_msgID);
94c52
<     * @param msgID
---
>     * @param _msgID
97,98c55,56
<    public InvalidKeyResolverException(String msgID, Object exArgs[]) {
<       super(msgID, exArgs);
---
>    public InvalidKeyResolverException(String _msgID, Object exArgs[]) {
>       super(_msgID, exArgs);
104,105c62,63
<     * @param msgID
<     * @param originalException
---
>     * @param _msgID
>     * @param _originalException
107,109c65,67
<    public InvalidKeyResolverException(String msgID,
<                                       Exception originalException) {
<       super(msgID, originalException);
---
>    public InvalidKeyResolverException(String _msgID,
>                                       Exception _originalException) {
>       super(_msgID, _originalException);
115c73
<     * @param msgID
---
>     * @param _msgID
117c75
<     * @param originalException
---
>     * @param _originalException
119,121c77,79
<    public InvalidKeyResolverException(String msgID, Object exArgs[],
<                                       Exception originalException) {
<       super(msgID, exArgs, originalException);
---
>    public InvalidKeyResolverException(String _msgID, Object exArgs[],
>                                       Exception _originalException) {
>       super(_msgID, exArgs, _originalException);
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/keyresolver/KeyResolverException.java xml-security-1_2_0/src/org/apache/xml/security/keys/keyresolver/KeyResolverException.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights 
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer. 
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:  
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written 
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European 
<  * Commission in the <WebSig> project in the ISIS Programme. 
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
72c30
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
88c46
<     * @param msgID
---
>     * @param _msgID
90,91c48,49
<    public KeyResolverException(String msgID) {
<       super(msgID);
---
>    public KeyResolverException(String _msgID) {
>       super(_msgID);
97c55
<     * @param msgID
---
>     * @param _msgID
100,101c58,59
<    public KeyResolverException(String msgID, Object exArgs[]) {
<       super(msgID, exArgs);
---
>    public KeyResolverException(String _msgID, Object exArgs[]) {
>       super(_msgID, exArgs);
107,108c65,66
<     * @param msgID
<     * @param originalException
---
>     * @param _msgID
>     * @param _originalException
110,111c68,69
<    public KeyResolverException(String msgID, Exception originalException) {
<       super(msgID, originalException);
---
>    public KeyResolverException(String _msgID, Exception _originalException) {
>       super(_msgID, _originalException);
117c75
<     * @param msgID
---
>     * @param _msgID
119c77
<     * @param originalException
---
>     * @param _originalException
121,123c79,81
<    public KeyResolverException(String msgID, Object exArgs[],
<                                Exception originalException) {
<       super(msgID, exArgs, originalException);
---
>    public KeyResolverException(String _msgID, Object exArgs[],
>                                Exception _originalException) {
>       super(_msgID, exArgs, _originalException);
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/keyresolver/KeyResolver.java xml-security-1_2_0/src/org/apache/xml/security/keys/keyresolver/KeyResolver.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64d21
< import java.security.cert.*;
65a23,25
> import java.security.cert.X509Certificate;
> import java.util.Vector;
> 
67,70c27,30
< import java.util.*;
< import org.w3c.dom.*;
< import org.apache.xml.security.exceptions.*;
< import org.apache.xml.security.keys.storage.*;
---
> 
> import org.apache.xml.security.keys.storage.StorageResolver;
> import org.w3c.dom.Element;
> import org.w3c.dom.Node;
74c34
<  * KeyResovler is factory class for subclass of KeyResolverSpi that
---
>  * KeyResolver is factory class for subclass of KeyResolverSpi that
77c37
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
82,84c42,44
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(KeyResolver.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(KeyResolver.class.getName());
149a110
>     * 
172,173c133,134
< 
<          cat.debug("check resolvability by class " + currentClass);
---
>          if (log.isDebugEnabled())
>          	log.debug("check resolvability by class " + currentClass);
202c163
<     * available to <I>all</I> {@link KeyInfo} objects. This means that
---
>     * available to <I>all</I> {@link org.apache.xml.security.keys.KeyInfo} objects. This means that
204c165,166
<     * to the {@link KeyInfo} using {@link KeyInfo#register}.
---
>     * to the {@link org.apache.xml.security.keys.KeyInfo} using 
>     * {@link org.apache.xml.security.keys.KeyInfo#registerInternalKeyResolver}.
214c176
<     * available to <I>all</I> {@link KeyInfo} objects. This means that
---
>     * available to <I>all</I> {@link org.apache.xml.security.keys.KeyInfo} objects. This means that
216c178
<     * to the {@link KeyInfo} using {@link KeyInfo#register}.
---
>     * to the {@link org.apache.xml.security.keys.KeyInfo} using {@link org.apache.xml.security.keys.KeyInfo#registerInternalKeyResolver}.
228c190
<     * @return
---
>     *
238a201
>     * 
257a221
>     * 
272a237
>     * 
281a247,253
>    /**
>     * @param element
>     * @param BaseURI
>     * @param storage
>     * @return
>     * @throws KeyResolverException
>     */
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/keyresolver/KeyResolverSpi.java xml-security-1_2_0/src/org/apache/xml/security/keys/keyresolver/KeyResolverSpi.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,64c21,23
< import java.security.*;
< import java.security.cert.*;
---
> import java.security.PublicKey;
> import java.security.cert.X509Certificate;
> 
66,68c25,27
< import org.w3c.dom.*;
< import java.util.ArrayList;
< import org.apache.xml.security.keys.storage.*;
---
> 
> import org.apache.xml.security.keys.storage.StorageResolver;
> import org.w3c.dom.Element;
81,82c40,41
<  * @author $Author: dohy $
<  * @version $Revision: 1.1.1.1 $
---
>  * @author $Author: raul $
>  * @version $Revision: 1.10 $
86,88c45,47
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(KeyResolverSpi.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(KeyResolverSpi.class.getName());
91,92c50,51
<     * This method helps the {@link ResourceResolver} to decide whether a
<     * {@link ResourceResolverSpi} is able to perform the requested action.
---
>     * This method helps the {@link org.apache.xml.security.utils.resolver.ResourceResolver} to decide whether a
>     * {@link org.apache.xml.security.utils.resolver.ResourceResolverSpi} is able to perform the requested action.
108a68
>     * 
121a82
>     *
134a96
>     *
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/keyresolver/package.html xml-security-1_2_0/src/org/apache/xml/security/keys/keyresolver/package.html
2c2
< the resolver framework for retrieval of certificates and public keys from elements
---
> the resolver framework for retrieval of certificates and public keys from elements.
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/KeyUtils.java xml-security-1_2_0/src/org/apache/xml/security/keys/KeyUtils.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64,66c22,24
< import java.io.*;
< import java.security.*;
< import java.security.spec.*;
---
> import java.io.PrintStream;
> import java.security.PublicKey;
> 
68,69c26,29
< import org.apache.xml.security.keys.content.*;
< import org.apache.xml.security.keys.content.x509.*;
---
> import org.apache.xml.security.keys.content.KeyName;
> import org.apache.xml.security.keys.content.KeyValue;
> import org.apache.xml.security.keys.content.MgmtData;
> import org.apache.xml.security.keys.content.X509Data;
73c33
<  * Utlity class for for <CODE>org.apache.xml.security.keys.*</CODE>
---
>  * Utility class for for <CODE>org.apache.xml.security.keys</CODE> package.
75c35
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
88,89d47
<     * @throws InvalidKeySpecException
<     * @throws NoSuchAlgorithmException
93,94c51
<            throws NoSuchAlgorithmException, InvalidKeySpecException,
<                   XMLSecurityException {
---
>            throws XMLSecurityException {
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/package.html xml-security-1_2_0/src/org/apache/xml/security/keys/package.html
2c2
< general key related material  
---
> general key related material.
Only in xml-security-orig-v1/src/org/apache/xml/security/keys: provider
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/storage/implementations/CertsInFilesystemDirectoryResolver.java xml-security-1_2_0/src/org/apache/xml/security/keys/storage/implementations/CertsInFilesystemDirectoryResolver.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64,68c22,37
< import java.io.*;
< import java.util.*;
< import java.security.cert.*;
< import org.apache.xml.security.keys.storage.*;
< import org.apache.xml.security.utils.*;
---
> import java.io.File;
> import java.io.FileInputStream;
> import java.io.FileNotFoundException;
> import java.io.IOException;
> import java.security.cert.CertificateException;
> import java.security.cert.CertificateExpiredException;
> import java.security.cert.CertificateFactory;
> import java.security.cert.CertificateNotYetValidException;
> import java.security.cert.X509Certificate;
> import java.util.ArrayList;
> import java.util.Iterator;
> import java.util.Vector;
> 
> import org.apache.xml.security.keys.storage.StorageResolverException;
> import org.apache.xml.security.keys.storage.StorageResolverSpi;
> import org.apache.xml.security.utils.Base64;
73c42
<  * which reside as files in a single directory available to the {@link StorageResolver}.
---
>  * which reside as files in a single directory available to the {@link org.apache.xml.security.keys.storage.StorageResolver}.
75c44
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
79,82c48,51
<    /** Field cat */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category
<          .getInstance(CertsInFilesystemDirectoryResolver.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(
>                     CertsInFilesystemDirectoryResolver.class.getName());
161c130
<             cat.debug("Could not add certificate from file " + filename, ex);
---
>             log.debug("Could not add certificate from file " + filename, ex);
163c132
<             cat.debug("Could not add certificate from file " + filename, ex);
---
>             log.debug("Could not add certificate from file " + filename, ex);
165c134
<             cat.debug("Could not add certificate from file " + filename, ex);
---
>             log.debug("Could not add certificate from file " + filename, ex);
167c136
<             cat.debug("Could not add certificate from file " + filename, ex);
---
>             log.debug("Could not add certificate from file " + filename, ex);
169c138
<             cat.debug("Could not add certificate from file " + filename, ex);
---
>             log.debug("Could not add certificate from file " + filename, ex);
173c142,143
<             cat.debug("Added certificate: " + dn);
---
>             if (log.isDebugEnabled())
>             	log.debug("Added certificate: " + dn);
178,182c148
<    /**
<     * Method getIterator
<     *
<     * @return
<     */
---
>    /** @inheritDoc */
190,191c156,157
<     * @author $Author: dohy $
<     * @version $Revision: 1.1.1.1 $
---
>     * @author $Author: raul $
>     * @version $Revision: 1.8 $
205d170
<        * @throws StorageResolverException
207c172
<       public FilesystemIterator(Vector certs) throws StorageResolverException {
---
>       public FilesystemIterator(Vector certs) {
212,216c177
<       /**
<        * Method hasNext
<        *
<        * @return
<        */
---
>       /** @inheritDoc */
221,225c182
<       /**
<        * Method next
<        *
<        * @return
<        */
---
>       /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/storage/implementations/KeyStoreResolver.java xml-security-1_2_0/src/org/apache/xml/security/keys/storage/implementations/KeyStoreResolver.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
67d24
< import java.util.Iterator;
69c26,29
< import org.apache.xml.security.keys.storage.*;
---
> import java.util.Iterator;
> 
> import org.apache.xml.security.keys.storage.StorageResolverException;
> import org.apache.xml.security.keys.storage.StorageResolverSpi;
74c34
<  * {@link StorageResolver}.
---
>  * {@link org.apache.xml.security.keys.storage.StorageResolver}.
76c36
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
97,101c57
<    /**
<     * Method getIterator
<     *
<     * @return
<     */
---
>    /** @inheritDoc */
109,110c65,66
<     * @author $Author: dohy $
<     * @version $Revision: 1.1.1.1 $
---
>     * @author $Author: raul $
>     * @version $Revision: 1.6 $
138,142c94
<       /**
<        * Method hasNext
<        *
<        * @return
<        */
---
>       /** @inheritDoc */
147,151c99
<       /**
<        * Method next
<        *
<        * @return
<        */
---
>       /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/storage/implementations/package.html xml-security-1_2_0/src/org/apache/xml/security/keys/storage/implementations/package.html
2c2
< implementations of resolvers for retrieval for certificates and public keys from user-specified locations
---
> implementations of resolvers for retrieval for certificates and public keys from user-specified locations.
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/storage/implementations/SingleCertificateResolver.java xml-security-1_2_0/src/org/apache/xml/security/keys/storage/implementations/SingleCertificateResolver.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights 
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer. 
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:  
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written 
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European 
<  * Commission in the <WebSig> project in the ISIS Programme. 
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
66c24,25
< import org.apache.xml.security.keys.storage.*;
---
> 
> import org.apache.xml.security.keys.storage.StorageResolverSpi;
71c30
<  * available to the {@link StorageResolver}.
---
>  * available to the {@link org.apache.xml.security.keys.storage.StorageResolver}.
73c32
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
93,97c52
<    /**
<     * Method getIterator
<     *
<     * @return
<     */
---
>    /** @inheritDoc */
105,106c60,61
<     * @author $Author: dohy $
<     * @version $Revision: 1.1.1.1 $
---
>     * @author $Author: raul $
>     * @version $Revision: 1.6 $
125,129c80
<       /**
<        * Method hasNext
<        *
<        * @return
<        */
---
>       /** @inheritDoc */
134,138c85
<       /**
<        * Method next
<        *
<        * @return
<        */
---
>       /** @inheritDoc */
143c90
<          return (Object) this._certificate;
---
>          return this._certificate;
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/storage/package.html xml-security-1_2_0/src/org/apache/xml/security/keys/storage/package.html
2c2
< a resolver framework for certificates and public keys from user-specified locations
---
> a resolver framework for certificates and public keys from user-specified locations.
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/storage/StorageResolverException.java xml-security-1_2_0/src/org/apache/xml/security/keys/storage/StorageResolverException.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights 
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer. 
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:  
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written 
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European 
<  * Commission in the <WebSig> project in the ISIS Programme. 
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
69c27
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
84c42
<     * @param msgID
---
>     * @param _msgID
86,87c44,45
<    public StorageResolverException(String msgID) {
<       super(msgID);
---
>    public StorageResolverException(String _msgID) {
>       super(_msgID);
93c51
<     * @param msgID
---
>     * @param _msgID
96,97c54,55
<    public StorageResolverException(String msgID, Object exArgs[]) {
<       super(msgID, exArgs);
---
>    public StorageResolverException(String _msgID, Object exArgs[]) {
>       super(_msgID, exArgs);
103,104c61,62
<     * @param msgID
<     * @param originalException
---
>     * @param _msgID
>     * @param _originalException
106,107c64,65
<    public StorageResolverException(String msgID, Exception originalException) {
<       super(msgID, originalException);
---
>    public StorageResolverException(String _msgID, Exception _originalException) {
>       super(_msgID, _originalException);
113c71
<     * @param msgID
---
>     * @param _msgID
115c73
<     * @param originalException
---
>     * @param _originalException
117,119c75,77
<    public StorageResolverException(String msgID, Object exArgs[],
<                                    Exception originalException) {
<       super(msgID, exArgs, originalException);
---
>    public StorageResolverException(String _msgID, Object exArgs[],
>                                    Exception _originalException) {
>       super(_msgID, exArgs, _originalException);
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/storage/StorageResolver.java xml-security-1_2_0/src/org/apache/xml/security/keys/storage/StorageResolver.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64,65d21
< import java.util.Vector;
< import java.util.Iterator;
68,69c24,28
< import org.apache.xml.security.keys.storage.implementations.*;
< import org.apache.xml.security.utils.*;
---
> import java.util.Iterator;
> import java.util.Vector;
> 
> import org.apache.xml.security.keys.storage.implementations.KeyStoreResolver;
> import org.apache.xml.security.keys.storage.implementations.SingleCertificateResolver;
75c34
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
79,81c38,40
<    /** Field cat */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(StorageResolver.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(StorageResolver.class.getName());
135c94
<          cat.error("Could not add KeyStore because of: ", ex);
---
>          log.error("Could not add KeyStore because of: ", ex);
159d117
<     *
160a119
>     *
197,198c156,157
<     * @author $Author: dohy $
<     * @version $Revision: 1.1.1.1 $
---
>     * @author $Author: raul $
>     * @version $Revision: 1.8 $
218,222c177
<       /**
<        * Method hasNext
<        *
<        * @return
<        */
---
>       /** @inheritDoc */
240,242c195,196
<             } else {
<                this._currentResolver++;
<             }
---
>             } 
>             this._currentResolver++;            
248,252c202
<       /**
<        * Method next
<        *
<        * @return
<        */
---
>       /** @inheritDoc */
270,271d219
<             } else {
<                this._currentResolver++;
272a221
>             this._currentResolver++;           
diff -r xml-security-orig-v1/src/org/apache/xml/security/keys/storage/StorageResolverSpi.java xml-security-1_2_0/src/org/apache/xml/security/keys/storage/StorageResolverSpi.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights 
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer. 
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:  
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written 
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European 
<  * Commission in the <WebSig> project in the ISIS Programme. 
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
69c27
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
diff -r xml-security-orig-v1/src/org/apache/xml/security/resource/config.xml xml-security-1_2_0/src/org/apache/xml/security/resource/config.xml
1,574c1,383
< <?xml version="1.0"?>
< <!--
< <!DOCTYPE Configuration SYSTEM "config.dtd">
< -->
< <!-- This configuration file is used for configuration of the org.apache.xml.security package -->
< <Configuration target="org.apache.xml.security" xmlns="http://www.xmlsecurity.org/NS/#configuration">
<    <CanonicalizationMethods>
<       <CanonicalizationMethod URI="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"
<                               JAVACLASS="org.apache.xml.security.c14n.implementations.Canonicalizer20010315OmitComments" />
<       <CanonicalizationMethod URI="http://www.w3.org/TR/2001/REC-xml-c14n-20010315#WithComments"
<                               JAVACLASS="org.apache.xml.security.c14n.implementations.Canonicalizer20010315WithComments" />
< 
<       <CanonicalizationMethod URI="http://www.w3.org/2001/10/xml-exc-c14n#"
<                               JAVACLASS="org.apache.xml.security.c14n.implementations.Canonicalizer20010315ExclOmitComments"/>
<       <CanonicalizationMethod URI="http://www.w3.org/2001/10/xml-exc-c14n#WithComments"
<                               JAVACLASS="org.apache.xml.security.c14n.implementations.Canonicalizer20010315ExclWithComments"/>
<    </CanonicalizationMethods>
<    <TransformAlgorithms>
<       <!-- Base64 -->
<       <TransformAlgorithm URI="http://www.w3.org/2000/09/xmldsig#base64"
<                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformBase64Decode" />
<       <!-- c14n omitting comments -->
<       <TransformAlgorithm URI="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"
<                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformC14N" />
<       <!-- c14n with comments -->
<       <TransformAlgorithm URI="http://www.w3.org/TR/2001/REC-xml-c14n-20010315#WithComments"
<                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformC14NWithComments" />
<       <!-- exclusive c14n omitting comments -->
<       <TransformAlgorithm URI="http://www.w3.org/2001/10/xml-exc-c14n#"
<                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformC14NExclusive" />
<       <!-- exclusive c14n with comments -->
<       <TransformAlgorithm URI="http://www.w3.org/2001/10/xml-exc-c14n#WithComments"
<                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformC14NExclusiveWithComments" />
< 
<       <!-- XPath transform -->
<       <TransformAlgorithm URI="http://www.w3.org/TR/1999/REC-xpath-19991116"
<                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformXPath" />
<       <!-- enveloped signature -->
<       <TransformAlgorithm URI="http://www.w3.org/2000/09/xmldsig#enveloped-signature"
<                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformEnvelopedSignature" />
<       <!-- XSLT -->
<       <TransformAlgorithm URI="http://www.w3.org/TR/1999/REC-xslt-19991116"
<                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformXSLT" />
<       <!-- XPath version 2 -->
<       <TransformAlgorithm URI="http://www.w3.org/2002/04/xmldsig-filter2"
<                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformXPath2Filter04" />
<       <!-- XPath version 2b -->
<       <TransformAlgorithm URI="http://www.w3.org/2002/06/xmldsig-filter2"
<                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformXPath2Filter" />
<       <!-- Christian Geuer-Pollmanns approach for XPath 2; experimantal -->
<       <TransformAlgorithm URI="http://www.nue.et-inf.uni-siegen.de/~geuer-pollmann/#xpathFilter"
<                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformXPathFilterCHGP" />
<    </TransformAlgorithms>
<    <SignatureAlgorithms>
<       <SignatureAlgorithm URI="http://www.w3.org/2000/09/xmldsig#dsa-sha1"
<                           JAVACLASS="org.apache.xml.security.algorithms.implementations.SignatureDSA" />
<       <SignatureAlgorithm URI="http://www.w3.org/2000/09/xmldsig#rsa-sha1"
<                           JAVACLASS="org.apache.xml.security.algorithms.implementations.SignatureBaseRSA$SignatureRSASHA1" />
<       <SignatureAlgorithm URI="http://www.w3.org/2000/09/xmldsig#hmac-sha1"
<                           JAVACLASS="org.apache.xml.security.algorithms.implementations.IntegrityHmac$IntegrityHmacSHA1" />
< 
<       <SignatureAlgorithm URI="http://www.w3.org/2001/04/xmldsig-more#rsa-md5"
<                           JAVACLASS="org.apache.xml.security.algorithms.implementations.SignatureBaseRSA$SignatureRSAMD5" />
<       <SignatureAlgorithm URI="http://www.w3.org/2001/04/xmldsig-more#rsa-ripemd160"
<                           JAVACLASS="org.apache.xml.security.algorithms.implementations.SignatureBaseRSA$SignatureRSARIPEMD160" />
<       <SignatureAlgorithm URI="http://www.w3.org/2001/04/xmldsig-more#rsa-sha256"
<                           JAVACLASS="org.apache.xml.security.algorithms.implementations.SignatureBaseRSA$SignatureRSASHA256" />
<       <SignatureAlgorithm URI="http://www.w3.org/2001/04/xmldsig-more#rsa-sha384"
<                           JAVACLASS="org.apache.xml.security.algorithms.implementations.SignatureBaseRSA$SignatureRSASHA384" />
<       <SignatureAlgorithm URI="http://www.w3.org/2001/04/xmldsig-more#rsa-sha512"
<                           JAVACLASS="org.apache.xml.security.algorithms.implementations.SignatureBaseRSA$SignatureRSASHA512" />
< 
<       <SignatureAlgorithm URI="http://www.w3.org/2001/04/xmldsig-more#hmac-md5"
<                           JAVACLASS="org.apache.xml.security.algorithms.implementations.IntegrityHmac$IntegrityHmacMD5" />
<       <SignatureAlgorithm URI="http://www.w3.org/2001/04/xmldsig-more#hmac-ripemd160"
<                           JAVACLASS="org.apache.xml.security.algorithms.implementations.IntegrityHmac$IntegrityHmacRIPEMD160" />
<       <SignatureAlgorithm URI="http://www.w3.org/2001/04/xmldsig-more#hmac-sha256"
<                           JAVACLASS="org.apache.xml.security.algorithms.implementations.IntegrityHmac$IntegrityHmacSHA256" />
<       <SignatureAlgorithm URI="http://www.w3.org/2001/04/xmldsig-more#hmac-sha384"
<                           JAVACLASS="org.apache.xml.security.algorithms.implementations.IntegrityHmac$IntegrityHmacSHA384" />
<       <SignatureAlgorithm URI="http://www.w3.org/2001/04/xmldsig-more#hmac-sha512"
<                           JAVACLASS="org.apache.xml.security.algorithms.implementations.IntegrityHmac$IntegrityHmacSHA512" />
<    </SignatureAlgorithms>
<    <JCEAlgorithmMappings>
<       <!-- Here, individual providers can be registered; each provider
<            is identified by Id which is referenced by ProviderId of the
<            Provider Element in the Algorithm Element -->
<       <Providers>
<          <Provider Id="BC"
<                    Class="org.bouncycastle.jce.provider.BouncyCastleProvider"
<                    Info="BouncyCastle Security Provider v1.09"
<                    ProviderURL="http://www.bouncycastle.org/" />
<          <Provider Id="SUN"
<                    Class="sun.security.provider.Sun"
<                    Info="SUN (DSA key/parameter generation; DSA signing; SHA-1, MD5 digests; SecureRandom; X.509 certificates; JKS keystore)"
<                    ProviderURL="http://java.sun.com/" />
<          <Provider Id="SunRsaSign"
<                    Class="com.sun.rsajca.Provider"
<                    Info="SUN's provider for RSA signatures"
<                    ProviderURL="http://java.sun.com/" />
<          <Provider Id="SunJCE"
<                    Class="com.sun.crypto.provider.SunJCE"
<                    Info="SunJCE Provider (implements DES, Triple DES, Blowfish, PBE, Diffie-Hellman, HMAC-MD5, HMAC-SHA1)"
<                    ProviderURL="http://java.sun.com/" />
<          <Provider Id="IAIK"
<                    Class="iaik.security.provider.IAIK"
<                    Info="IAIK Security Provider v2.6"
<                    ProviderURL="http://www.iaik.at/" />
<          <Provider Id="Cryptix"
<                    Class="cryptix.provider.Cryptix"
<                    Info="Cryptix JCE provider v3.001002"
<                    ProviderURL="http://www.cryptix.org//" />
<       </Providers>
<       <Algorithms>
<          <!-- MessageDigest Algorithms -->
<          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#md5"
<                     Description="MD5 message digest from RFC 1321"
<                     AlgorithmClass="MessageDigest"
<                     RequirementLevel="NOT RECOMMENDED"
<                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt">
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="MD5" />
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#ripemd160"
<                     Description="RIPEMD-160 message digest"
<                     AlgorithmClass="MessageDigest"
<                     RequirementLevel="OPTIONAL">
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="RIPEMD160" />
<             <ProviderAlgo ProviderId="Cryptix"
<                           JCEName="RIPEMD160" />
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2000/09/xmldsig#sha1"
<                     Description="SHA-1 message digest"
<                     AlgorithmClass="MessageDigest"
<                     RequirementLevel="REQUIRED">
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="SHA-1" />
<             <ProviderAlgo ProviderId="SUN"
<                           JCEName="SHA-1" />
<             <ProviderAlgo ProviderId="IAIK"
<                           JCEName="SHA-1" />
<             <ProviderAlgo ProviderId="Cryptix"
<                           JCEName="SHA-1" />
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#sha256"
<                     Description="SHA-1 message digest with 256 bit"
<                     AlgorithmClass="MessageDigest"
<                     RequirementLevel="RECOMMENDED">
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="SHA-256" />
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#sha384"
<                     Description="SHA message digest with 384 bit"
<                     AlgorithmClass="MessageDigest"
<                     RequirementLevel="OPTIONAL"
<                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt">
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="SHA-384" />
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#sha512"
<                     Description="SHA-1 message digest with 512 bit"
<                     AlgorithmClass="MessageDigest"
<                     RequirementLevel="OPTIONAL">
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="SHA-512" />
<          </Algorithm>
< 
<          <!-- Signature Algorithms -->
<          <Algorithm URI="http://www.w3.org/2000/09/xmldsig#dsa-sha1"
<                     Description="Digital Signature Algorithm with SHA-1 message digest"
<                     AlgorithmClass="Signature"
<                     RequirementLevel="REQUIRED">
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="DSA" />
<             <ProviderAlgo ProviderId="SUN"
<                           JCEName="DSAWithSHA1" />
<             <ProviderAlgo ProviderId="IAIK"
<                           JCEName="DSA" />
<          </Algorithm>
< 
<          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#rsa-md5"
<                     Description="RSA Signature with MD5 message digest"
<                     AlgorithmClass="Signature"
<                     RequirementLevel="NOT RECOMMENDED"
<                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt">
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="MD5WithRSAEncryption" />
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#rsa-ripemd160"
<                     Description="RSA Signature with RIPEMD-160 message digest"
<                     AlgorithmClass="Signature"
<                     RequirementLevel="OPTIONAL"
<                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt">
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="RIPEMD160WithRSAEncryption" />
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2000/09/xmldsig#rsa-sha1"
<                     Description="RSA Signature with SHA-1 message digest"
<                     AlgorithmClass="Signature"
<                     RequirementLevel="RECOMMENDED">
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="SHA1WithRSAEncryption" />
<             <ProviderAlgo ProviderId="SunRsaSign"
<                           JCEName="SHA1withRSA" />
<             <ProviderAlgo ProviderId="IAIK"
<                           JCEName="SHA-1/RSA" />
<             <ProviderAlgo ProviderId="Cryptix"
<                           JCEName="SHA-1/RSA" />
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#rsa-sha256"
<                     Description="RSA Signature with SHA-256 message digest"
<                     AlgorithmClass="Signature"
<                     RequirementLevel="OPTIONAL"
<                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt">
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="SHA256withRSAEncryption" />
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#rsa-sha384"
<                     Description="RSA Signature with SHA-384 message digest"
<                     AlgorithmClass="Signature"
<                     RequirementLevel="OPTIONAL"
<                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt">
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="SHA384withRSAEncryption" />
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#rsa-sha512"
<                     Description="RSA Signature with SHA-512 message digest"
<                     AlgorithmClass="Signature"
<                     RequirementLevel="OPTIONAL"
<                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt">
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="SHA512withRSAEncryption" />
<          </Algorithm>
< 
<          <!-- MAC Algorithms -->
<          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#hmac-md5"
<                     Description="Message Authentication code using MD5"
<                     AlgorithmClass="Mac"
<                     RequirementLevel="NOT RECOMMENDED"
<                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt">
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="HMACMD5" />
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#hmac-ripemd160"
<                     Description="Message Authentication code using RIPEMD-160"
<                     AlgorithmClass="Mac"
<                     RequirementLevel="OPTIONAL"
<                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt">
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="HMACRIPEMD160" />
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2000/09/xmldsig#hmac-sha1"
<                     Description="Message Authentication code using SHA1"
<                     AlgorithmClass="Mac"
<                     RequirementLevel="REQUIRED">
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="HMACSHA1" />
<             <ProviderAlgo ProviderId="SunJCE"
<                           JCEName="HmacSHA1" />
<             <ProviderAlgo ProviderId="IAIK"
<                           JCEName="HMAC/SHA" />
<             <ProviderAlgo ProviderId="Cryptix"
<                           JCEName="HMAC-SHA-1" />
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#hmac-sha256"
<                     Description="Message Authentication code using SHA-256"
<                     AlgorithmClass="Mac"
<                     RequirementLevel="OPTIONAL"
<                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt">
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="HMACSHA256" />
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#hmac-sha384"
<                     Description="Message Authentication code using SHA-384"
<                     AlgorithmClass="Mac"
<                     RequirementLevel="OPTIONAL"
<                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt">
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="HMACSHA384" />
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#hmac-sha512"
<                     Description="Message Authentication code using SHA-512"
<                     AlgorithmClass="Mac"
<                     RequirementLevel="OPTIONAL"
<                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt">
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="HMACSHA512" />
<          </Algorithm>
< 
<          <!-- Block encryption Algorithms -->
<          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#tripledes-cbc"
<                     Description="Block encryption using Triple-DES"
<                     AlgorithmClass="BlockEncryption"
<                     RequirementLevel="REQUIRED"
<                     KeyLength="192">
<             <ProviderAlgo ProviderId="BC"
<                           RequiredKey="DESEDE"
<                           JCEName="DESEDE/CBC/ISO10126PADDING"
<                           IVJCEName="DESEDE/ECB/NOPADDING" />
<             <ProviderAlgo ProviderId="Cryptix"
<                           JCEName="DES-EDE3/CBC" />
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#aes128-cbc"
<                     Description="Block encryption using AES with a key length of 128 bit"
<                     AlgorithmClass="BlockEncryption"
<                     RequirementLevel="REQUIRED"
<                     KeyLength="128">
<             <ProviderAlgo ProviderId="BC"
<                           RequiredKey="AES"
<                           JCEName="AES/CBC/ISO10126PADDING"
<                           IVJCEName="AES/ECB/NOPADDING" />
<             <ProviderAlgo ProviderId="Cryptix"
<                           JCEName="Rijndael" />
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#aes192-cbc"
<                     Description="Block encryption using AES with a key length of 192 bit"
<                     AlgorithmClass="BlockEncryption"
<                     RequirementLevel="OPTIONAL"
<                     KeyLength="192">
<             <ProviderAlgo ProviderId="BC"
<                           RequiredKey="AES"
<                           JCEName="AES/CBC/ISO10126PADDING"
<                           IVJCEName="AES/ECB/NOPADDING" />
<             <ProviderAlgo ProviderId="Cryptix"
<                           JCEName="Rijndael" />
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#aes256-cbc"
<                     Description="Block encryption using AES with a key length of 256 bit"
<                     AlgorithmClass="BlockEncryption"
<                     RequirementLevel="REQUIRED"
<                     KeyLength="256">
<             <ProviderAlgo ProviderId="BC"
<                           RequiredKey="AES"
<                           JCEName="AES/CBC/ISO10126PADDING"
<                           IVJCEName="AES/ECB/NOPADDING" />
<             <ProviderAlgo ProviderId="Cryptix"
<                           JCEName="Rijndael" />
<          </Algorithm>
< 
<          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#rsa-1_5"
<                     Description="Key Transport RSA-v1.5"
<                     AlgorithmClass="KeyTransport"
<                     RequirementLevel="REQUIRED">
<             <!-- You have to provide a core RSA mechanism here, even for
<                  the bouncy castle -->
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="RSA"
<                           RequiredKey="RSA" />
<             <ProviderAlgo ProviderId="Cryptix"
<                           JCEName="RSA"
<                           RequiredKey="RSA" />
<             <!-- <ProviderAlgo ProviderId="BC"
<                           JCEName="RSA/PKCS1"
<                           RequiredKey="RSA" />
<             <ProviderAlgo ProviderId="Cryptix"
<                           JCEName="RSA/ECB/PKCS#1" /> -->
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#rsa-oaep-mgf1p"
<                     Description="Key Transport RSA-OAEP"
<                     AlgorithmClass="KeyTransport"
<                     RequirementLevel="REQUIRED">
<             <!-- You have to provide a core RSA mechanism here, even for
<                  the bouncy castle -->
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="RSA"
<                           RequiredKey="RSA" />
<             <!-- <ProviderAlgo ProviderId="BC" JCEName="RSA/OAEP" RequiredKey="RSA" /> -->
<          </Algorithm>
< 
<          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#dh"
<                     Description="Key Agreement Diffie-Hellman"
<                     AlgorithmClass="KeyAgreement"
<                     RequirementLevel="OPTIONAL">
<          </Algorithm>
< 
<          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#kw-tripledes"
<                     Description="Symmetric Key Wrap using Triple DES"
<                     AlgorithmClass="SymmetricKeyWrap"
<                     RequirementLevel="REQUIRED"
<                     KeyLength="192">
<             <!-- We need a Triple DES in CipherBlockChaining (CBC) mode here without padding -->
<             <ProviderAlgo ProviderId="BC"
<                           RequiredKey="DESEDE"
<                           JCEName="DESEDE/CBC/NOPADDING" />
<             <!-- <ProviderAlgo ProviderId="BC" JCEName="DESEDEWrap" RequiredKey="DESEDE" /> -->
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#kw-aes128"
<                     Description="Symmetric Key Wrap using AES with a key length of 128 bit"
<                     AlgorithmClass="SymmetricKeyWrap"
<                     RequirementLevel="REQUIRED"
<                     KeyLength="128">
<             <!-- We need an AES in ElectronicCodeBook (ECB) mode here without padding -->
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="AES/ECB/NOPADDING"
<                           RequiredKey="AES" />
<             <!-- <ProviderAlgo ProviderId="BC" JCEName="AESWrap" RequiredKey="AES" /> -->
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#kw-aes192"
<                     Description="Symmetric Key Wrap using AES with a key length of 192 bit"
<                     AlgorithmClass="SymmetricKeyWrap"
<                     RequirementLevel="OPTIONAL"
<                     KeyLength="192">
<             <!-- We need an AES in ElectronicCodeBook (ECB) mode here without padding -->
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="AES/ECB/NOPADDING"
<                           RequiredKey="AES" />
<             <!-- <ProviderAlgo ProviderId="BC" JCEName="AESWrap" RequiredKey="AES" /> -->
<          </Algorithm>
<          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#kw-aes256"
<                     Description="Symmetric Key Wrap using AES with a key length of 256 bit"
<                     AlgorithmClass="SymmetricKeyWrap"
<                     RequirementLevel="REQUIRED"
<                     KeyLength="256">
<             <!-- We need an AES in ElectronicCodeBook (ECB) mode here without padding -->
<             <ProviderAlgo ProviderId="BC"
<                           JCEName="AES/ECB/NOPADDING"
<                           RequiredKey="AES" />
<             <!-- <ProviderAlgo ProviderId="BC" JCEName="AESWrap" RequiredKey="AES" /> -->
<          </Algorithm>
<       </Algorithms>
<    </JCEAlgorithmMappings>
<    <ResourceBundles defaultLanguageCode="en" defaultCountryCode="US">
<       <ResourceBundle LanguageCode="en"
<                       CountryCode="US"
<                       LOCATION="org.apache.xml.security/resource/xmlsecurity_en.properties" />
<       <ResourceBundle LanguageCode="de"
<                       CountryCode="DE"
<                       LOCATION="org.apache.xml.security/resource/xmlsecurity_de.properties" />
<    </ResourceBundles>
<    <ResourceResolvers>
<       <Resolver JAVACLASS="org.apache.xml.security.utils.resolver.implementations.ResolverDirectHTTP"
<                 DESCRIPTION="A simple resolver for requests to HTTP space" />
<       <Resolver JAVACLASS="org.apache.xml.security.utils.resolver.implementations.ResolverLocalFilesystem"
<                 DESCRIPTION="A simple resolver for requests to the local file system" />
<       <Resolver JAVACLASS="org.apache.xml.security.utils.resolver.implementations.ResolverFragment"
<                 DESCRIPTION="A simple resolver for requests of same-document URIs" />
<       <Resolver JAVACLASS="org.apache.xml.security.utils.resolver.implementations.ResolverXPointer"
<                 DESCRIPTION="A simple resolver for requests of XPointer fragents" />
<    </ResourceResolvers>
<    <!-- <defaultLocale languageCode="en" countryCode="US" /> -->
<    <KeyInfo>
<       <ContentHandler LOCALNAME="KeyName"
<                       NAMESPACE="http://www.w3.org/2000/09/xmldsig#"
<                       JAVACLASS="org.apache.xml.security.keys.content.KeyName" />
<       <ContentHandler LOCALNAME="KeyValue"
<                       NAMESPACE="http://www.w3.org/2000/09/xmldsig#"
<                       JAVACLASS="org.apache.xml.security.keys.content.KeyValue" />
<       <ContentHandler LOCALNAME="RetrievalMethod"
<                       NAMESPACE="http://www.w3.org/2000/09/xmldsig#"
<                       JAVACLASS="org.apache.xml.security.keys.content.RetrievalMethod" />
<       <ContentHandler LOCALNAME="X509Data"
<                       NAMESPACE="http://www.w3.org/2000/09/xmldsig#"
<                       JAVACLASS="org.apache.xml.security.keys.content.X509Data" />
<       <ContentHandler LOCALNAME="PGPData"
<                       NAMESPACE="http://www.w3.org/2000/09/xmldsig#"
<                       JAVACLASS="org.apache.xml.security.keys.content.PGPData" />
<       <ContentHandler LOCALNAME="SPKIData"
<                       NAMESPACE="http://www.w3.org/2000/09/xmldsig#"
<                       JAVACLASS="org.apache.xml.security.keys.content.SPKIData" />
<       <ContentHandler LOCALNAME="MgmtData"
<                       NAMESPACE="http://www.w3.org/2000/09/xmldsig#"
<                       JAVACLASS="org.apache.xml.security.keys.content.MgmtData" />
<    </KeyInfo>
<    <KeyResolver>
<       <!-- This section contains a list of KeyResolvers that are available in
<            every KeyInfo object -->
<       <Resolver JAVACLASS="org.apache.xml.security.keys.keyresolver.implementations.RSAKeyValueResolver"
<                 DESCRIPTION="Can extract RSA public keys" />
<       <Resolver JAVACLASS="org.apache.xml.security.keys.keyresolver.implementations.DSAKeyValueResolver"
<                 DESCRIPTION="Can extract DSA public keys" />
<       <Resolver JAVACLASS="org.apache.xml.security.keys.keyresolver.implementations.X509CertificateResolver"
<                 DESCRIPTION="Can extract public keys from X509 certificates" />
<       <Resolver JAVACLASS="org.apache.xml.security.keys.keyresolver.implementations.X509SKIResolver"
<                 DESCRIPTION="Uses an X509v3 SubjectKeyIdentifier extension to retrieve a certificate from the storages" />
<       <Resolver JAVACLASS="org.apache.xml.security.keys.keyresolver.implementations.RetrievalMethodResolver"
<                 DESCRIPTION="Resolves keys and certificates using ResourceResolvers" />
<       <Resolver JAVACLASS="org.apache.xml.security.keys.keyresolver.implementations.X509SubjectNameResolver"
<                 DESCRIPTION="Uses an X509 SubjectName to retrieve a certificate from the storages" />
<       <Resolver JAVACLASS="org.apache.xml.security.keys.keyresolver.implementations.X509IssuerSerialResolver"
<                 DESCRIPTION="Uses an X509 IssuerName and IssuerSerial to retrieve a certificate from the storages" />
<    </KeyResolver>
<    <log4j:configuration xmlns:log4j="http://jakarta.apache.org/log4j/">
<         <!-- http://jakarta.apache.org/log4j/docs/api/org/apache/log4j/xml/DOMConfigurator.html -->
<         <appender name="LOGTXT" class="org.apache.log4j.FileAppender">
<                 <param name="File" value="log.txt" />
<                 <!--
<                 <param name="File" value="System.out" />
<                 -->
< 
<                 <layout class="org.apache.log4j.PatternLayout">
< 
<                 <param name="ConversionPattern" value="%-5p %C{1}:%L - %m\n"/>
<                 <!--
<                 <param name="ConversionPattern" value="%d %-5p %C{10}:%-4L - %m\n"/>
<                 -->
<                 </layout>
<         </appender>
< 
<         <appender name="NULL" class="org.apache.xml.security.utils.NullAppender" />
< 
<         <!--
<         <appender name="chainsaw" class="org.apache.log4j.net.SocketAppender">
<                 <param name="RemoteHost" value="localhost" />
<                 <param name="Port" value="4445" />
<                 <layout class="org.apache.log4j.PatternLayout">
<                     <param name="ConversionPattern" value="%-5p %C{1}:%L - %m\n"/>
<                 </layout>
<         </appender>
<         -->
< 
<         <!-- if you use the LOGTXT appender-ref, a log.txt file is created in
<              your working directory.
<              If you use the NULL appender-ref, all logging is disabled.
<           -->
<         <root>
<                 <priority value ="fatal" />
<                 <!-- <appender-ref ref="LOGTXT" /> -->
<                 <appender-ref ref="NULL" />
<                 <!-- <appender-ref ref="chainsaw" /> -->
<         </root>
< 
<         <category name="org.apache.log4j.xml">
<                 <priority value="info" />
<         </category>
< 
<         <category name="org.apache.xml.security">
<                 <priority value="fatal" />
<         </category>
< 
<         <category name="org.apache.xml.security.test.AllTests">
<                 <priority value="debug" />
<         </category>
< 
<         <!--
<         <category name="org.apache.xml.security.test.AllTests">
<                 <priority value="debug" />
<         </category>
<         <category name="org.apache.xml.security.utils">
<                 <priority value="fatal" />
<         </category>
<         <category name="org.apache.xml.security.test">
<                 <priority value="debug" />
<         </category>
<         <category name="org.apache.xml.security.util.IgnoreAllErrorHandler">
<                 <priority value="fatal" />
<         </category>
<         <category name="org.apache.xml.security.Init">
<                 <priority value="error" />
<         </category>
<         -->
<    </log4j:configuration>
<    <PrefixMappings>
<       <!-- Many classes create Elements which are in a specific namespace;
<            here, the prefixes for these namespaces are defined. But this
<            can also be overwritten using the ElementProxy#setDefaultPrefix()
<            method. You can even set all prefixes to "" so that the corresponding
<            elements are created using the default namespace -->
<       <PrefixMapping namespace="http://www.w3.org/2000/09/xmldsig#"
<                      prefix="ds" />
<       <PrefixMapping namespace="http://www.w3.org/2001/04/xmlenc#"
<                      prefix="xenc" />
<       <PrefixMapping namespace="http://www.xmlsecurity.org/experimental#"
<                      prefix="experimental" />
<       <PrefixMapping namespace="http://www.w3.org/2002/04/xmldsig-filter2"
<                      prefix="dsig-xpath" />
<       <PrefixMapping namespace="http://www.w3.org/2002/06/xmldsig-filter2"
<                      prefix="xfilter2b" />
<       <PrefixMapping namespace="http://www.w3.org/2001/10/xml-exc-c14n#"
<                      prefix="ec" />
<       <PrefixMapping namespace="http://www.nue.et-inf.uni-siegen.de/~geuer-pollmann/#xpathFilter"
<                      prefix="xx" />
<    </PrefixMappings>
< </Configuration>
---
> <?xml version="1.0"?>
> <!--
> <!DOCTYPE Configuration SYSTEM "config.dtd">
> -->
> <!-- This configuration file is used for configuration of the org.apache.xml.security package -->
> <Configuration target="org.apache.xml.security" xmlns="http://www.xmlsecurity.org/NS/#configuration">
>    <CanonicalizationMethods>
>       <CanonicalizationMethod URI="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"
>                               JAVACLASS="org.apache.xml.security.c14n.implementations.Canonicalizer20010315OmitComments" />
>       <CanonicalizationMethod URI="http://www.w3.org/TR/2001/REC-xml-c14n-20010315#WithComments"
>                               JAVACLASS="org.apache.xml.security.c14n.implementations.Canonicalizer20010315WithComments" />
> 
>       <CanonicalizationMethod URI="http://www.w3.org/2001/10/xml-exc-c14n#"
>                               JAVACLASS="org.apache.xml.security.c14n.implementations.Canonicalizer20010315ExclOmitComments"/>
>       <CanonicalizationMethod URI="http://www.w3.org/2001/10/xml-exc-c14n#WithComments"
>                               JAVACLASS="org.apache.xml.security.c14n.implementations.Canonicalizer20010315ExclWithComments"/>
>    </CanonicalizationMethods>
>    <TransformAlgorithms>
>       <!-- Base64 -->
>       <TransformAlgorithm URI="http://www.w3.org/2000/09/xmldsig#base64"
>                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformBase64Decode" />
>       <!-- c14n omitting comments -->
>       <TransformAlgorithm URI="http://www.w3.org/TR/2001/REC-xml-c14n-20010315"
>                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformC14N" />
>       <!-- c14n with comments -->
>       <TransformAlgorithm URI="http://www.w3.org/TR/2001/REC-xml-c14n-20010315#WithComments"
>                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformC14NWithComments" />
>       <!-- exclusive c14n omitting comments -->
>       <TransformAlgorithm URI="http://www.w3.org/2001/10/xml-exc-c14n#"
>                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformC14NExclusive" />
>       <!-- exclusive c14n with comments -->
>       <TransformAlgorithm URI="http://www.w3.org/2001/10/xml-exc-c14n#WithComments"
>                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformC14NExclusiveWithComments" />
> 
>       <!-- XPath transform -->
>       <TransformAlgorithm URI="http://www.w3.org/TR/1999/REC-xpath-19991116"
>                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformXPath" />
>       <!-- enveloped signature -->
>       <TransformAlgorithm URI="http://www.w3.org/2000/09/xmldsig#enveloped-signature"
>                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformEnvelopedSignature" />
>       <!-- XSLT -->
>       <TransformAlgorithm URI="http://www.w3.org/TR/1999/REC-xslt-19991116"
>                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformXSLT" />
>       <!-- XPath version 2 -->
>       <TransformAlgorithm URI="http://www.w3.org/2002/04/xmldsig-filter2"
>                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformXPath2Filter04" />
>       <!-- XPath version 2b -->
>       <TransformAlgorithm URI="http://www.w3.org/2002/06/xmldsig-filter2"
>                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformXPath2Filter" />
>       <!-- Christian Geuer-Pollmanns approach for XPath 2; experimantal -->
>       <TransformAlgorithm URI="http://www.nue.et-inf.uni-siegen.de/~geuer-pollmann/#xpathFilter"
>                           JAVACLASS="org.apache.xml.security.transforms.implementations.TransformXPathFilterCHGP" />
>    </TransformAlgorithms>
>    <SignatureAlgorithms>
>       <SignatureAlgorithm URI="http://www.w3.org/2000/09/xmldsig#dsa-sha1"
>                           JAVACLASS="org.apache.xml.security.algorithms.implementations.SignatureDSA" />
>       <SignatureAlgorithm URI="http://www.w3.org/2000/09/xmldsig#rsa-sha1"
>                           JAVACLASS="org.apache.xml.security.algorithms.implementations.SignatureBaseRSA$SignatureRSASHA1" />
>       <SignatureAlgorithm URI="http://www.w3.org/2000/09/xmldsig#hmac-sha1"
>                           JAVACLASS="org.apache.xml.security.algorithms.implementations.IntegrityHmac$IntegrityHmacSHA1" />
> 
>       <SignatureAlgorithm URI="http://www.w3.org/2001/04/xmldsig-more#rsa-md5"
>                           JAVACLASS="org.apache.xml.security.algorithms.implementations.SignatureBaseRSA$SignatureRSAMD5" />
>       <SignatureAlgorithm URI="http://www.w3.org/2001/04/xmldsig-more#rsa-ripemd160"
>                           JAVACLASS="org.apache.xml.security.algorithms.implementations.SignatureBaseRSA$SignatureRSARIPEMD160" />
>       <SignatureAlgorithm URI="http://www.w3.org/2001/04/xmldsig-more#rsa-sha256"
>                           JAVACLASS="org.apache.xml.security.algorithms.implementations.SignatureBaseRSA$SignatureRSASHA256" />
>       <SignatureAlgorithm URI="http://www.w3.org/2001/04/xmldsig-more#rsa-sha384"
>                           JAVACLASS="org.apache.xml.security.algorithms.implementations.SignatureBaseRSA$SignatureRSASHA384" />
>       <SignatureAlgorithm URI="http://www.w3.org/2001/04/xmldsig-more#rsa-sha512"
>                           JAVACLASS="org.apache.xml.security.algorithms.implementations.SignatureBaseRSA$SignatureRSASHA512" />
> 
>       <SignatureAlgorithm URI="http://www.w3.org/2001/04/xmldsig-more#hmac-md5"
>                           JAVACLASS="org.apache.xml.security.algorithms.implementations.IntegrityHmac$IntegrityHmacMD5" />
>       <SignatureAlgorithm URI="http://www.w3.org/2001/04/xmldsig-more#hmac-ripemd160"
>                           JAVACLASS="org.apache.xml.security.algorithms.implementations.IntegrityHmac$IntegrityHmacRIPEMD160" />
>       <SignatureAlgorithm URI="http://www.w3.org/2001/04/xmldsig-more#hmac-sha256"
>                           JAVACLASS="org.apache.xml.security.algorithms.implementations.IntegrityHmac$IntegrityHmacSHA256" />
>       <SignatureAlgorithm URI="http://www.w3.org/2001/04/xmldsig-more#hmac-sha384"
>                           JAVACLASS="org.apache.xml.security.algorithms.implementations.IntegrityHmac$IntegrityHmacSHA384" />
>       <SignatureAlgorithm URI="http://www.w3.org/2001/04/xmldsig-more#hmac-sha512"
>                           JAVACLASS="org.apache.xml.security.algorithms.implementations.IntegrityHmac$IntegrityHmacSHA512" />
>    </SignatureAlgorithms>
>    <JCEAlgorithmMappings>
>       <Algorithms>
>          <!-- MessageDigest Algorithms -->
>          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#md5"
>                     Description="MD5 message digest from RFC 1321"
>                     AlgorithmClass="MessageDigest"
>                     RequirementLevel="NOT RECOMMENDED"
>                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt"
>                     JCEName="MD5"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#ripemd160"
>                     Description="RIPEMD-160 message digest"
>                     AlgorithmClass="MessageDigest"
>                     RequirementLevel="OPTIONAL"
>                     JCEName="RIPEMD160"/>
> 
>          <Algorithm URI="http://www.w3.org/2000/09/xmldsig#sha1"
>                     Description="SHA-1 message digest"
>                     AlgorithmClass="MessageDigest"
>                     RequirementLevel="REQUIRED"
>                     JCEName="SHA-1"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#sha256"
>                     Description="SHA-1 message digest with 256 bit"
>                     AlgorithmClass="MessageDigest"
>                     RequirementLevel="RECOMMENDED"
>                     JCEName="SHA-256"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#sha384"
>                     Description="SHA message digest with 384 bit"
>                     AlgorithmClass="MessageDigest"
>                     RequirementLevel="OPTIONAL"
>                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt"
>                     JCEName="SHA-384"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#sha512"
>                     Description="SHA-1 message digest with 512 bit"
>                     AlgorithmClass="MessageDigest"
>                     RequirementLevel="OPTIONAL"
>                     JCEName="SHA-512"/>
> 
>          <!-- Signature Algorithms -->
>          <Algorithm URI="http://www.w3.org/2000/09/xmldsig#dsa-sha1"
>                     Description="Digital Signature Algorithm with SHA-1 message digest"
>                     AlgorithmClass="Signature"
>                     RequirementLevel="REQUIRED"
>                     JCEName="SHA1withDSA"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#rsa-md5"
>                     Description="RSA Signature with MD5 message digest"
>                     AlgorithmClass="Signature"
>                     RequirementLevel="NOT RECOMMENDED"
>                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt"
>                     JCEName="MD5withRSA"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#rsa-ripemd160"
>                     Description="RSA Signature with RIPEMD-160 message digest"
>                     AlgorithmClass="Signature"
>                     RequirementLevel="OPTIONAL"
>                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt"
>                     JCEName="RIPEMD160withRSA"/>
> 
>          <Algorithm URI="http://www.w3.org/2000/09/xmldsig#rsa-sha1"
>                     Description="RSA Signature with SHA-1 message digest"
>                     AlgorithmClass="Signature"
>                     RequirementLevel="RECOMMENDED"
>                     JCEName="SHA1withRSA"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#rsa-sha256"
>                     Description="RSA Signature with SHA-256 message digest"
>                     AlgorithmClass="Signature"
>                     RequirementLevel="OPTIONAL"
>                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt"
>                     JCEName="SHA256withRSA"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#rsa-sha384"
>                     Description="RSA Signature with SHA-384 message digest"
>                     AlgorithmClass="Signature"
>                     RequirementLevel="OPTIONAL"
>                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt"
>                     JCEName="SHA384withRSA"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#rsa-sha512"
>                     Description="RSA Signature with SHA-512 message digest"
>                     AlgorithmClass="Signature"
>                     RequirementLevel="OPTIONAL"
>                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt"
>                     JCEName="SHA512withRSA"/>
> 
>          <!-- MAC Algorithms -->
>          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#hmac-md5"
>                     Description="Message Authentication code using MD5"
>                     AlgorithmClass="Mac"
>                     RequirementLevel="NOT RECOMMENDED"
>                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt"
>                     JCEName="HmacMD5"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#hmac-ripemd160"
>                     Description="Message Authentication code using RIPEMD-160"
>                     AlgorithmClass="Mac"
>                     RequirementLevel="OPTIONAL"
>                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt"
>                     JCEName="HMACRIPEMD160"/>
> 
>          <Algorithm URI="http://www.w3.org/2000/09/xmldsig#hmac-sha1"
>                     Description="Message Authentication code using SHA1"
>                     AlgorithmClass="Mac"
>                     RequirementLevel="REQUIRED"
>                     JCEName="HmacSHA1"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#hmac-sha256"
>                     Description="Message Authentication code using SHA-256"
>                     AlgorithmClass="Mac"
>                     RequirementLevel="OPTIONAL"
>                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt"
>                     JCEName="HmacSHA256"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#hmac-sha384"
>                     Description="Message Authentication code using SHA-384"
>                     AlgorithmClass="Mac"
>                     RequirementLevel="OPTIONAL"
>                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt"
>                     JCEName="HmacSHA384"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmldsig-more#hmac-sha512"
>                     Description="Message Authentication code using SHA-512"
>                     AlgorithmClass="Mac"
>                     RequirementLevel="OPTIONAL"
>                     SpecificationURL="http://www.ietf.org/internet-drafts/draft-eastlake-xmldsig-uri-02.txt"
>                     JCEName="HmacSHA512"/>
> 
>          <!-- Block encryption Algorithms -->
>          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#tripledes-cbc"
>                     Description="Block encryption using Triple-DES"
>                     AlgorithmClass="BlockEncryption"
>                     RequirementLevel="REQUIRED"
>                     KeyLength="192"
>                     RequiredKey="DESede"
>                     JCEName="DESede/CBC/ISO10126Padding"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#aes128-cbc"
>                     Description="Block encryption using AES with a key length of 128 bit"
>                     AlgorithmClass="BlockEncryption"
>                     RequirementLevel="REQUIRED"
>                     KeyLength="128"
>                     RequiredKey="AES"
>                     JCEName="AES/CBC/ISO10126Padding"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#aes192-cbc"
>                     Description="Block encryption using AES with a key length of 192 bit"
>                     AlgorithmClass="BlockEncryption"
>                     RequirementLevel="OPTIONAL"
>                     KeyLength="192"
>                     RequiredKey="AES"
>                     JCEName="AES/CBC/ISO10126Padding"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#aes256-cbc"
>                     Description="Block encryption using AES with a key length of 256 bit"
>                     AlgorithmClass="BlockEncryption"
>                     RequirementLevel="REQUIRED"
>                     KeyLength="256"
>                     RequiredKey="AES"
>                     JCEName="AES/CBC/ISO10126Padding"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#rsa-1_5"
>                     Description="Key Transport RSA-v1.5"
>                     AlgorithmClass="KeyTransport"
>                     RequirementLevel="REQUIRED"
>                     RequiredKey="RSA"
>                     JCEName="RSA/ECB/PKCS1Padding"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#rsa-oaep-mgf1p"
>                     Description="Key Transport RSA-OAEP"
>                     AlgorithmClass="KeyTransport"
>                     RequirementLevel="REQUIRED"
>                     RequiredKey="RSA"
>                     JCEName="RSA/ECB/OAEPWithSHA1AndMGF1Padding"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#dh"
>                     Description="Key Agreement Diffie-Hellman"
>                     AlgorithmClass="KeyAgreement"
>                     RequirementLevel="OPTIONAL"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#kw-tripledes"
>                     Description="Symmetric Key Wrap using Triple DES"
>                     AlgorithmClass="SymmetricKeyWrap"
>                     RequirementLevel="REQUIRED"
>                     KeyLength="192"
>                     RequiredKey="DESede"
>                     JCEName="DESedeWrap"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#kw-aes128"
>                     Description="Symmetric Key Wrap using AES with a key length of 128 bit"
>                     AlgorithmClass="SymmetricKeyWrap"
>                     RequirementLevel="REQUIRED"
>                     KeyLength="128"
>                     RequiredKey="AES"
>                     JCEName="AESWrap"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#kw-aes192"
>                     Description="Symmetric Key Wrap using AES with a key length of 192 bit"
>                     AlgorithmClass="SymmetricKeyWrap"
>                     RequirementLevel="OPTIONAL"
>                     KeyLength="192"
>                     RequiredKey="AES"
>                     JCEName="AESWrap"/>
> 
>          <Algorithm URI="http://www.w3.org/2001/04/xmlenc#kw-aes256"
>                     Description="Symmetric Key Wrap using AES with a key length of 256 bit"
>                     AlgorithmClass="SymmetricKeyWrap"
>                     RequirementLevel="REQUIRED"
>                     KeyLength="256"
>                     RequiredKey="AES"
>                     JCEName="AESWrap"/>
> 
>       </Algorithms>
>    </JCEAlgorithmMappings>
>    <ResourceBundles defaultLanguageCode="en" defaultCountryCode="US">
>       <ResourceBundle LanguageCode="en"
>                       CountryCode="US"
>                       LOCATION="org.apache.xml.security/resource/xmlsecurity_en.properties" />
>       <ResourceBundle LanguageCode="de"
>                       CountryCode="DE"
>                       LOCATION="org.apache.xml.security/resource/xmlsecurity_de.properties" />
>    </ResourceBundles>
>    <ResourceResolvers>
>       <Resolver JAVACLASS="org.apache.xml.security.utils.resolver.implementations.ResolverDirectHTTP"
>                 DESCRIPTION="A simple resolver for requests to HTTP space" />
>       <Resolver JAVACLASS="org.apache.xml.security.utils.resolver.implementations.ResolverLocalFilesystem"
>                 DESCRIPTION="A simple resolver for requests to the local file system" />
>       <Resolver JAVACLASS="org.apache.xml.security.utils.resolver.implementations.ResolverFragment"
>                 DESCRIPTION="A simple resolver for requests of same-document URIs" />
>       <Resolver JAVACLASS="org.apache.xml.security.utils.resolver.implementations.ResolverXPointer"
>                 DESCRIPTION="A simple resolver for requests of XPointer fragents" />
>    </ResourceResolvers>
>    <!-- <defaultLocale languageCode="en" countryCode="US" /> -->
>    <KeyInfo>
>       <ContentHandler LOCALNAME="KeyName"
>                       NAMESPACE="http://www.w3.org/2000/09/xmldsig#"
>                       JAVACLASS="org.apache.xml.security.keys.content.KeyName" />
>       <ContentHandler LOCALNAME="KeyValue"
>                       NAMESPACE="http://www.w3.org/2000/09/xmldsig#"
>                       JAVACLASS="org.apache.xml.security.keys.content.KeyValue" />
>       <ContentHandler LOCALNAME="RetrievalMethod"
>                       NAMESPACE="http://www.w3.org/2000/09/xmldsig#"
>                       JAVACLASS="org.apache.xml.security.keys.content.RetrievalMethod" />
>       <ContentHandler LOCALNAME="X509Data"
>                       NAMESPACE="http://www.w3.org/2000/09/xmldsig#"
>                       JAVACLASS="org.apache.xml.security.keys.content.X509Data" />
>       <ContentHandler LOCALNAME="PGPData"
>                       NAMESPACE="http://www.w3.org/2000/09/xmldsig#"
>                       JAVACLASS="org.apache.xml.security.keys.content.PGPData" />
>       <ContentHandler LOCALNAME="SPKIData"
>                       NAMESPACE="http://www.w3.org/2000/09/xmldsig#"
>                       JAVACLASS="org.apache.xml.security.keys.content.SPKIData" />
>       <ContentHandler LOCALNAME="MgmtData"
>                       NAMESPACE="http://www.w3.org/2000/09/xmldsig#"
>                       JAVACLASS="org.apache.xml.security.keys.content.MgmtData" />
>    </KeyInfo>
>    <KeyResolver>
>       <!-- This section contains a list of KeyResolvers that are available in
>            every KeyInfo object -->
>       <Resolver JAVACLASS="org.apache.xml.security.keys.keyresolver.implementations.RSAKeyValueResolver"
>                 DESCRIPTION="Can extract RSA public keys" />
>       <Resolver JAVACLASS="org.apache.xml.security.keys.keyresolver.implementations.DSAKeyValueResolver"
>                 DESCRIPTION="Can extract DSA public keys" />
>       <Resolver JAVACLASS="org.apache.xml.security.keys.keyresolver.implementations.X509CertificateResolver"
>                 DESCRIPTION="Can extract public keys from X509 certificates" />
>       <Resolver JAVACLASS="org.apache.xml.security.keys.keyresolver.implementations.X509SKIResolver"
>                 DESCRIPTION="Uses an X509v3 SubjectKeyIdentifier extension to retrieve a certificate from the storages" />
>       <Resolver JAVACLASS="org.apache.xml.security.keys.keyresolver.implementations.RetrievalMethodResolver"
>                 DESCRIPTION="Resolves keys and certificates using ResourceResolvers" />
>       <Resolver JAVACLASS="org.apache.xml.security.keys.keyresolver.implementations.X509SubjectNameResolver"
>                 DESCRIPTION="Uses an X509 SubjectName to retrieve a certificate from the storages" />
>       <Resolver JAVACLASS="org.apache.xml.security.keys.keyresolver.implementations.X509IssuerSerialResolver"
>                 DESCRIPTION="Uses an X509 IssuerName and IssuerSerial to retrieve a certificate from the storages" />
>    </KeyResolver>
>  
>    <PrefixMappings>
>       <!-- Many classes create Elements which are in a specific namespace;
>            here, the prefixes for these namespaces are defined. But this
>            can also be overwritten using the ElementProxy#setDefaultPrefix()
>            method. You can even set all prefixes to "" so that the corresponding
>            elements are created using the default namespace -->
>       <PrefixMapping namespace="http://www.w3.org/2000/09/xmldsig#"
>                      prefix="ds" />
>       <PrefixMapping namespace="http://www.w3.org/2001/04/xmlenc#"
>                      prefix="xenc" />
>       <PrefixMapping namespace="http://www.xmlsecurity.org/experimental#"
>                      prefix="experimental" />
>       <PrefixMapping namespace="http://www.w3.org/2002/04/xmldsig-filter2"
>                      prefix="dsig-xpath-old" />
>       <PrefixMapping namespace="http://www.w3.org/2002/06/xmldsig-filter2"
>                      prefix="dsig-xpath" />
>       <PrefixMapping namespace="http://www.w3.org/2001/10/xml-exc-c14n#"
>                      prefix="ec" />
>       <PrefixMapping namespace="http://www.nue.et-inf.uni-siegen.de/~geuer-pollmann/#xpathFilter"
>                      prefix="xx" />
>    </PrefixMappings>
> </Configuration>
Only in xml-security-orig-v1/src/org/apache/xml/security/resource: CR-xmldsig-core-20010419-schema.dtd
Only in xml-security-orig-v1/src/org/apache/xml/security/resource: CR-xmldsig-core-20010419-schema.xsd
Only in xml-security-1_2_0/src/org/apache/xml/security/resource: log4j.properties
diff -r xml-security-orig-v1/src/org/apache/xml/security/resource/package.html xml-security-1_2_0/src/org/apache/xml/security/resource/package.html
2c2
< software configuration and internationalization ({@link org.apache.xml.security.utils.I18n})
---
> software configuration and internationalization ({@link org.apache.xml.security.utils.I18n}).
Only in xml-security-1_2_0/src/org/apache/xml/security/resource: schema
diff -r xml-security-orig-v1/src/org/apache/xml/security/resource/xmlsecurity_de.properties xml-security-1_2_0/src/org/apache/xml/security/resource/xmlsecurity_de.properties
1,111c1,118
< algorithm.alreadyRegistered = URI {0} wurde bereits an die Klasse {1} gebunden
< algorithm.classDoesNotExist = Kann URI {0} nicht fr Klasse {1} registrieren weil sie nicht existiert
< algorithm.ClassDoesNotExist = Klasse {0} existiert nicht
< algorithm.extendsWrongClass = Kann URI {0} nicht fr Klasse {1} registrieren weil sie nicht {2} extended
< algorithms.NoSuchAlgorithm = Der Algorithmus {0} ist nicht verfgbar. Original Nachricht war: {1}
< algorithms.NoSuchProvider = The specified Provider {0} does not exist. Original Message was: {1}
< algorithms.HMACOutputLengthOnlyForHMAC = A HMACOutputLength can only be specified for HMAC integrity algorithms
< algorithms.operationOnlyForMAC = A SecretKey can only be specified for HMAC integrity algorithms
< algorithms.operationOnlyForSignature = A PublicKey or PrivateKey can only be specified for Signature algorithms
< c14n.Canonicalizer.Exception = Exception whrend Kanonisierung:  Original Nachricht war {0}
< c14n.Canonicalizer.IllegalNode = Unzulssiger NodeType {0}, NodeName lautete {1}
< c14n.Canonicalizer.NoSuchCanonicalizer = Kein Canonicalizer mit dem URI {0} gefunden
< c14n.Canonicalizer.ParserConfigurationException = ParserConfigurationException whrend Kanonisierung:  Original Nachricht war {0}
< c14n.Canonicalizer.RelativeNamespace = Das Element {0} hat einen relativen Namespace: {1}="{2}"
< c14n.Canonicalizer.SAXException = SAXException whrend Kanonisierung:  Original Nachricht war {0}
< c14n.Canonicalizer.TraversalNotSupported = Das DOM Dokument untersttzt keine Traversal {0}
< c14n.Canonicalizer.UnsupportedEncoding = Unbekannte Kodierung {0}
< c14n.Canonicalizer.UnsupportedOperation = This canonicalizer does not support this operation
< errorMessages.InvalidDigestValueException = Ungltige Signatur: Reference Validation fehlgeschlagen.
< errorMessages.InvalidSignatureValueException = Ungltige Signatur: Core Validation fehlgeschlagen.
< errorMessages.IOException = Datei oder Resource kann nicht gelesen werden.
< errorMessages.MissingKeyFailureException = Verifizieren fehlgeschlagen, weil der ffentliche Schlssel (public key) nicht verfgbar ist. Resourcen via addResource() hinzufgen und erneut verifizieren.
< errorMessages.MissingResourceFailureException = Verifizieren fehlgeschlagen, weil Resourcen nicht verfgbar sind. Resourcen via addResource() hinzufgen und erneut verifizieren.
< errorMessages.NoSuchAlgorithmException = Unbekannter Algorithmus {0}
< errorMessages.NotYetImplementedException = Funktionalitt noch nicht implementiert.
< errorMessages.XMLSignatureException = Verifizieren aus unbekanntem Grund fehlgeschlagen.
< FileKeyStorageImpl.addToDefaultFromRemoteNotImplemented = Method addToDefaultFromRemote() not yet implemented.
< FileKeyStorageImpl.NoCert.Context = Not found such a X509Certificate including context {0}
< FileKeyStorageImpl.NoCert.IssNameSerNo = Not found such a X509Certificate with IssuerName {0} and serial number {1}
< FileKeyStorageImpl.NoCert.SubjName = Not found such a X509Certificate including SubjectName {0}
< generic.EmptyMessage = {0}
< generic.NotYetImplemented = {0} Leider noch nicht implementiert ;-((
< java.security.InvalidKeyException = Ungltiger Schlssel
< java.security.NoSuchProviderException = Unbekannter oder nicht untersttzter Provider
< java.security.UnknownKeyType = Unbekannter oder nicht untersttzter Key type {0}
< KeyInfo.needKeyResolver = Es mssen mehrere KeyResolver registriert sein
< KeyInfo.nokey = Kann keinen Schlssel aus {0} gewinnen
< KeyInfo.noKey = Kann keinen ffentlichen Schlssel finden
< KeyInfo.wrongNumberOfObject = Bentige {0} keyObjects
< KeyInfo.wrongUse = Dieses Objekt wird verwendet, um {0} zu gewinnen
< keyResolver.alreadyRegistered = Die Klasse {1} wurde bereits registriert fr {0}
< KeyResoverSpiImpl.cannotGetCert = Can't get the Certificate that include or in {1} in implement class {0}
< KeyResoverSpiImpl.elementGeneration = Can't make {1} element in implement class {0}
< KeyResoverSpiImpl.getPoublicKey = Can't get the public key from implement class {0}
< KeyResoverSpiImpl.InvalidElement = Cannot set (2) Element in implement class {0}
< KeyResoverSpiImpl.keyStore = KeyStorage error in implement class {0}
< KeyResoverSpiImpl.need.Element = {1} type of Element is needed in implement class {0}
< KeyResoverSpiImpl.wrongCRLElement = Cannot make CRL from {1} in implement class {0}
< KeyResoverSpiImpl.wrongKeyObject =  Need {1} type of KeyObject for generation Element in implement class{0}
< KeyResoverSpiImpl.wrongNumberOfObject = Need {1} keyObject in implement class {0}
< KeyStore.alreadyRegistered = {0} Class has already been registered for {1}
< KeyStore.register = {1} type class register error  in class {0}
< KeyStore.registerStore.register = Registeration error for type {0}
< signature.Canonicalizer.UnknownCanonicalizer = Unbekannter Canonicalizer. Kein Handler installiert fr URI {0}
< signature.signaturePropertyHasNoTarget = Das Target Attribut der SignatureProperty muss gesetzt sein
< signature.Transform.ErrorDuringTransform = Whrend der Transformation {0} trat eine {1} auf.
< signature.Transform.NotYetImplemented = Transform {0} noch nicht implementiert
< signature.Transform.NullPointerTransform = Null pointer als URI bergeben. Programmierfehler?
< signature.Transform.UnknownTransform = Unbekannte Transformation. Kein Handler installiert fr URI {0}
< signature.Util.BignumNonPositive = bigInteger.signum() mu positiv sein
< signature.Util.NonTextNode = Kein Text Node
< signature.Util.TooManyChilds = Zu viele Child-Elemente vom Type {0} in {1}
< signature.Verification.certificateError = Zertifikatsfehler
< signature.Verification.IndexOutOfBounds = Index {0} illegal. We only have {1} References
< signature.Verification.internalError = Interner Fehler
< signature.Verification.InvalidDigestOrReference = Ungltiger Digest Wert oder Reference Element {0}
< signature.Verification.keyStore = ffnen des KeyStore fehlgeschlagen
< signature.Verification.MissingResources = Kann die externe Resource {0} nicht auflsen
< signature.Verification.MissingID = Can't resolve element with ID {0}
< signature.Verification.NoSignatureElement = Input Dokument enthlt kein {0} Element mit dem Namespace {1}
< signature.Verification.Reference.NoInput = Die Reference fr den URI {0} hat keinen XMLSignatureInput erhalten.
< signature.Verification.SignatureError = Signatur Fehler
< signature.XMLSignatureInput.MissingConstuctor = Kann aus der Klasse {0} keinen XMLSignatureInput erzeugen
< signature.XMLSignatureInput.SerializeDOM = Input mit einem DOM Dokument initialisiert. Mu mit C14N serialisiert werden
< transform.Init.IllegalContextArgument = Unzulssiges Kontext Argument der Klasse {0}. Muss String, org.w3c.dom.NodeList oder java.io.InputStream sein.
< transform.init.NotInitialized =
< transform.init.wrongURI = Initialisiert mit dem falschen URI. Das sollte nie passieren. Die Transformation implementiert {0} aber {1} wurde bei der Instantiierung verwendet.
< utils.Base64.IllegalBitlength = Ungltige Bytelnge; Muss ein vielfaches von 4 sein
< utils.resolver.noClass = Could not find a resolver for URI {0} and Base {1}
< xml.WrongContent = Kann {0} nicht finden in {1}
< xml.WrongElement = Kann kein {0} aus einem {1} Element erzeugen
< xpath.funcHere.documentsDiffer = Der XPath ist nicht im selben Dokument wie der Kontext Node
< xpath.funcHere.noXPathContext = Try to evaluate an XPath which uses the here() function but XPath is not inside an ds:XPath Element. XPath was : {0}
< KeyValue.IllegalArgument = Can't create a {0} from {1}
< ElementProxy.nullElement = Kann einen ElementProxy aus einem null Argument erzeugen
< certificate.noSki.null = Certificate does not contain a SubjectKeyIdentifier
< certificate.noSki.lowVersion = Certificate cannot contain a SubjectKeyIdentifier because it is only X509v{0}
< certificate.noSki.notOctetString = Certificates SubjectKeyIdentifier is not a OctetString
< KeyResolver.needStorageResolver = Need a StorageResolver to retrieve a Certificate from a {0}
< empty = {0}
< signature.Generation.signBeforeGetValue = You have to XMLSignature.sign(java.security.PrivateKey) first
< generic.dontHaveConstructionElement = I don't have a construction Element
< prefix.AlreadyAssigned = Sie binden den Prefix {0} an den Namespace {1} aber er ist bereits an {2} zugewiesen
< notYetInitialized = Das Modul {0} ist noch nicht initialisiert
< encryption.ExplicitKeySizeMismatch = The xenc:KeySize element requests a key size of {0} bit but the algorithm implements {1} bit
< signature.DSA.invalidFormat = Invalid ASN.1 encoding of the DSA signature
< encryption.RSAOAEP.dataTooShort = data too short
< encryption.RSAOAEP.dataHashWrong = data hash wrong
< encryption.RSAOAEP.dataStartWrong = data wrong start {0}
< encryption.RSAPKCS15.blockTruncated = block truncated
< encryption.RSAPKCS15.unknownBlockType = unknown block type
< encryption.RSAPKCS15.noDataInBlock = no data in block
< encryption.nonceLongerThanDecryptedPlaintext = The given nonce is longer than the available plaintext. I can't strip away this.
< encryption.algorithmCannotEatInitParams = encryption.algorithmCannotEatInitParams
< encryption.algorithmCannotWrapUnWrap = encryption.algorithmCannotWrapUnWrap
< encryption.algorithmCannotEncryptDecrypt = encryption.algorithmCannotEncryptDecrypt
< encryption.algorithmCannotBeUsedForEncryptedData = encryption.algorithmCannotBeUsedForEncryptedData {0}
< namespacePrefixAlreadyUsedByOtherURI = Namespace {0} already used by other URI {1}
< defaultNamespaceCannotBeSetHere = Default namespace cannot be set here
< attributeValueIllegal = The attribute {0} has value {1} but must be {2}
< endorsed.jdk1.4.0 = Since it seems that nobody reads our installation notes, we must do it in the exception messages. Hope you read them. You did NOT use the endorsed mechanism from JDK 1.4 properly; look at <http://xml.apache.org/security/install.html> how to solve this problem.
---
> algorithm.alreadyRegistered = URI {0} wurde bereits an die Klasse {1} gebunden
> algorithm.classDoesNotExist = Kann URI {0} nicht fr Klasse {1} registrieren weil sie nicht existiert
> algorithm.ClassDoesNotExist = Klasse {0} existiert nicht
> algorithm.extendsWrongClass = Kann URI {0} nicht fr Klasse {1} registrieren weil sie nicht {2} extended
> algorithms.CannotUseAlgorithmParameterSpecOnDSA = Sorry, but you cannot use a AlgorithmParameterSpec object for creating DSA signatures.
> algorithms.CannotUseAlgorithmParameterSpecOnRSA = Sorry, but you cannot use a AlgorithmParameterSpec object for creating RSA signatures.
> algorithms.CannotUseSecureRandomOnMAC = Sorry, but you cannot use a SecureRandom object for creating MACs.
> algorithms.HMACOutputLengthOnlyForHMAC = A HMACOutputLength can only be specified for HMAC integrity algorithms
> algorithms.NoSuchAlgorithm = Der Algorithmus {0} ist nicht verfgbar. Original Nachricht war: {1}
> algorithms.NoSuchMap = The algorithm URI "{0}" could not be mapped to a JCE algorithm
> algorithms.NoSuchProvider = The specified Provider {0} does not exist. Original Message was: {1}
> algorithms.operationOnlyVerification = A public key can only used for verification of a signature.
> algorithms.WrongKeyForThisOperation = Sorry, you supplied the wrong key type for this operation! You supplied a {0} but a {1} is needed.
> attributeValueIllegal = The attribute {0} has value {1} but must be {2}
> c14n.Canonicalizer.Exception = Exception whrend Kanonisierung:  Original Nachricht war {0}
> c14n.Canonicalizer.IllegalNode = Unzulssiger NodeType {0}, NodeName lautete {1}
> c14n.Canonicalizer.NoSuchCanonicalizer = Kein Canonicalizer mit dem URI {0} gefunden
> c14n.Canonicalizer.ParserConfigurationException = ParserConfigurationException whrend Kanonisierung:  Original Nachricht war {0}
> c14n.Canonicalizer.RelativeNamespace = Das Element {0} hat einen relativen Namespace: {1}="{2}"
> c14n.Canonicalizer.SAXException = SAXException whrend Kanonisierung:  Original Nachricht war {0}
> c14n.Canonicalizer.TraversalNotSupported = Das DOM Dokument untersttzt keine Traversal {0}
> c14n.Canonicalizer.UnsupportedEncoding = Unbekannte Kodierung {0}
> c14n.Canonicalizer.UnsupportedOperation = This canonicalizer does not support this operation
> c14n.XMLUtils.circumventBug2650forgotten = The tree has not been prepared for canonicalization using XMLUtils#circumventBug2650(Document)
> certificate.noSki.lowVersion = Certificate cannot contain a SubjectKeyIdentifier because it is only X509v{0}
> certificate.noSki.notOctetString = Certificates SubjectKeyIdentifier is not a OctetString
> certificate.noSki.null = Certificate does not contain a SubjectKeyIdentifier
> defaultNamespaceCannotBeSetHere = Default namespace cannot be set here
> ElementProxy.nullElement = Kann einen ElementProxy aus einem null Argument erzeugen
> empty = {0}
> encryption.algorithmCannotBeUsedForEncryptedData = encryption.algorithmCannotBeUsedForEncryptedData {0}
> encryption.algorithmCannotEatInitParams = encryption.algorithmCannotEatInitParams
> encryption.algorithmCannotEncryptDecrypt = encryption.algorithmCannotEncryptDecrypt
> encryption.algorithmCannotWrapUnWrap = encryption.algorithmCannotWrapUnWrap
> encryption.ExplicitKeySizeMismatch = The xenc:KeySize element requests a key size of {0} bit but the algorithm implements {1} bit
> encryption.nonceLongerThanDecryptedPlaintext = The given nonce is longer than the available plaintext. I Cannot strip away this.
> encryption.RSAOAEP.dataHashWrong = data hash wrong
> encryption.RSAOAEP.dataStartWrong = data wrong start {0}
> encryption.RSAOAEP.dataTooShort = data too short
> encryption.RSAPKCS15.blockTruncated = block truncated
> encryption.RSAPKCS15.noDataInBlock = no data in block
> encryption.RSAPKCS15.unknownBlockType = unknown block type
> encryption.nokey = No Key Encryption Key loaded and cannot determine using key resolvers
> endorsed.jdk1.4.0 = Since it seems that nobody reads our installation notes, we must do it in the exception messages. Hope you read them. You did NOT use the endorsed mechanism from JDK 1.4 properly; look at <http://xml.apache.org/security/Java/installation.html> how to solve this problem.
> errorMessages.InvalidDigestValueException = Ungltige Signatur: Reference Validation fehlgeschlagen.
> errorMessages.InvalidSignatureValueException = Ungltige Signatur: Core Validation fehlgeschlagen.
> errorMessages.IOException = Datei oder Resource kann nicht gelesen werden.
> errorMessages.MissingKeyFailureException = Verifizieren fehlgeschlagen, weil der ffentliche Schlssel (public key) nicht verfgbar ist. Resourcen via addResource() hinzufgen und erneut verifizieren.
> errorMessages.MissingResourceFailureException = Verifizieren fehlgeschlagen, weil Resourcen nicht verfgbar sind. Resourcen via addResource() hinzufgen und erneut verifizieren.
> errorMessages.NoSuchAlgorithmException = Unbekannter Algorithmus {0}
> errorMessages.NotYetImplementedException = Funktionalitt noch nicht implementiert.
> errorMessages.XMLSignatureException = Verifizieren aus unbekanntem Grund fehlgeschlagen.
> decoding.general = Error while decoding
> FileKeyStorageImpl.addToDefaultFromRemoteNotImplemented = Method addToDefaultFromRemote() not yet implemented.
> FileKeyStorageImpl.NoCert.Context = Not found such a X509Certificate including context {0}
> FileKeyStorageImpl.NoCert.IssNameSerNo = Not found such a X509Certificate with IssuerName {0} and serial number {1}
> FileKeyStorageImpl.NoCert.SubjName = Not found such a X509Certificate including SubjectName {0}
> generic.dontHaveConstructionElement = I do not have a construction Element
> generic.EmptyMessage = {0}
> generic.NotYetImplemented = {0} Leider noch nicht implementiert ;-((
> java.security.InvalidKeyException = Ungltiger Schlssel
> java.security.NoSuchProviderException = Unbekannter oder nicht untersttzter Provider
> java.security.UnknownKeyType = Unbekannter oder nicht untersttzter Key type {0}
> KeyInfo.needKeyResolver = Es mssen mehrere KeyResolver registriert sein
> KeyInfo.nokey = Kann keinen Schlssel aus {0} gewinnen
> KeyInfo.noKey = Kann keinen ffentlichen Schlssel finden
> KeyInfo.wrongNumberOfObject = Bentige {0} keyObjects
> KeyInfo.wrongUse = Dieses Objekt wird verwendet, um {0} zu gewinnen
> keyResolver.alreadyRegistered = Die Klasse {1} wurde bereits registriert fr {0}
> KeyResolver.needStorageResolver = Need a StorageResolver to retrieve a Certificate from a {0}
> KeyResoverSpiImpl.cannotGetCert = Cannot get the Certificate that include or in {1} in implement class {0}
> KeyResoverSpiImpl.elementGeneration = Cannot make {1} element in implement class {0}
> KeyResoverSpiImpl.getPoublicKey = Cannot get the public key from implement class {0}
> KeyResoverSpiImpl.InvalidElement = Cannot set (2) Element in implement class {0}
> KeyResoverSpiImpl.keyStore = KeyStorage error in implement class {0}
> KeyResoverSpiImpl.need.Element = {1} type of Element is needed in implement class {0}
> KeyResoverSpiImpl.wrongCRLElement = Cannot make CRL from {1} in implement class {0}
> KeyResoverSpiImpl.wrongKeyObject =  Need {1} type of KeyObject for generation Element in implement class{0}
> KeyResoverSpiImpl.wrongNumberOfObject = Need {1} keyObject in implement class {0}
> KeyStore.alreadyRegistered = {0} Class has already been registered for {1}
> KeyStore.register = {1} type class register error  in class {0}
> KeyStore.registerStore.register = Registeration error for type {0}
> KeyValue.IllegalArgument = Cannot create a {0} from {1}
> namespacePrefixAlreadyUsedByOtherURI = Namespace {0} already used by other URI {1}
> notYetInitialized = Das Modul {0} ist noch nicht initialisiert
> prefix.AlreadyAssigned = Sie binden den Prefix {0} an den Namespace {1} aber er ist bereits an {2} zugewiesen
> signature.Canonicalizer.UnknownCanonicalizer = Unbekannter Canonicalizer. Kein Handler installiert fr URI {0}
> signature.DSA.invalidFormat = Invalid ASN.1 encoding of the DSA signature
> signature.Generation.signBeforeGetValue = You have to XMLSignature.sign(java.security.PrivateKey) first
> signature.signaturePropertyHasNoTarget = Das Target Attribut der SignatureProperty muss gesetzt sein
> signature.Transform.ErrorDuringTransform = Whrend der Transformation {0} trat eine {1} auf.
> signature.Transform.NotYetImplemented = Transform {0} noch nicht implementiert
> signature.Transform.NullPointerTransform = Null pointer als URI bergeben. Programmierfehler?
> signature.Transform.UnknownTransform = Unbekannte Transformation. Kein Handler installiert fr URI {0}
> signature.Util.BignumNonPositive = bigInteger.signum() mu positiv sein
> signature.Util.NonTextNode = Kein Text Node
> signature.Util.TooManyChilds = Zu viele Child-Elemente vom Type {0} in {1}
> signature.Verification.certificateError = Zertifikatsfehler
> signature.Verification.IndexOutOfBounds = Index {0} illegal. We only have {1} References
> signature.Verification.internalError = Interner Fehler
> signature.Verification.InvalidDigestOrReference = Ungltiger Digest Wert oder Reference Element {0}
> signature.Verification.keyStore = ffnen des KeyStore fehlgeschlagen
> signature.Verification.MissingID = Cannot resolve element with ID {0}
> signature.Verification.MissingResources = Kann die externe Resource {0} nicht auflsen
> signature.Verification.NoSignatureElement = Input Dokument enthlt kein {0} Element mit dem Namespace {1}
> signature.Verification.Reference.NoInput = Die Reference fr den URI {0} hat keinen XMLSignatureInput erhalten.
> signature.Verification.SignatureError = Signatur Fehler
> signature.XMLSignatureInput.MissingConstuctor = Kann aus der Klasse {0} keinen XMLSignatureInput erzeugen
> signature.XMLSignatureInput.SerializeDOM = Input mit einem DOM Dokument initialisiert. Mu mit C14N serialisiert werden
> transform.Init.IllegalContextArgument = Unzulssiges Kontext Argument der Klasse {0}. Muss String, org.w3c.dom.NodeList oder java.io.InputStream sein.
> transform.init.NotInitialized =
> transform.init.wrongURI = Initialisiert mit dem falschen URI. Das sollte nie passieren. Die Transformation implementiert {0} aber {1} wurde bei der Instantiierung verwendet.
> utils.Base64.IllegalBitlength = Ungltige Bytelnge; Muss ein vielfaches von 4 sein
> utils.resolver.noClass = Could not find a resolver for URI {0} and Base {1}
> xml.WrongContent = Kann {0} nicht finden in {1}
> xml.WrongElement = Kann kein {0} aus einem {1} Element erzeugen
> xpath.funcHere.documentsDiffer = Der XPath ist nicht im selben Dokument wie der Kontext Node
> xpath.funcHere.noXPathContext = Try to evaluate an XPath which uses the here() function but XPath is not inside an ds:XPath Element. XPath was : {0}
diff -r xml-security-orig-v1/src/org/apache/xml/security/resource/xmlsecurity_en.properties xml-security-1_2_0/src/org/apache/xml/security/resource/xmlsecurity_en.properties
1,111c1,118
< algorithm.alreadyRegistered = URI {0} already assigned to class {1}
< algorithm.classDoesNotExist = Cannot register URI {0} to class {1} because this class does not exist in CLASSPATH
< algorithm.ClassDoesNotExist = Class {0} does not exist
< algorithm.extendsWrongClass = Cannot register URI {0} to class {1} because it does not extend {2}
< algorithms.NoSuchAlgorithm = The requested algorithm {0} does not exist. Original Message was: {1}
< algorithms.NoSuchProvider = The specified Provider {0} does not exist. Original Message was: {1}
< algorithms.HMACOutputLengthOnlyForHMAC = A HMACOutputLength can only be specified for HMAC integrity algorithms
< algorithms.operationOnlyForMAC = A SecretKey can only be specified for HMAC integrity algorithms
< algorithms.operationOnlyForSignature = A PublicKey or PrivateKey can only be specified for Signature algorithms
< c14n.Canonicalizer.Exception = Exception during Canonicalization:  Original Message was {0}
< c14n.Canonicalizer.IllegalNode = Illegal node type {0}, node name was {1}
< c14n.Canonicalizer.NoSuchCanonicalizer = No canonicalizer found with URI {0}
< c14n.Canonicalizer.ParserConfigurationException = ParserConfigurationException during Canonicalization:  Original Message was {0}
< c14n.Canonicalizer.RelativeNamespace = Element {0} has a relative namespace: {1}="{2}"
< c14n.Canonicalizer.SAXException = SAXException during Canonicalization:  Original Message was {0}
< c14n.Canonicalizer.TraversalNotSupported = This DOM document does not support Traversal {0}
< c14n.Canonicalizer.UnsupportedEncoding = Unsupported encoding {0}
< c14n.Canonicalizer.UnsupportedOperation = This canonicalizer does not support this operation
< errorMessages.InvalidDigestValueException = INVALID signature -- check reference resolution.
< errorMessages.InvalidSignatureValueException = INVALID signature -- core validation failed.
< errorMessages.IOException = Other file I/O and similar exceptions.
< errorMessages.MissingKeyFailureException = Can't verify because of missing public key. Provide it via addResource and try again.
< errorMessages.MissingResourceFailureException = Can't verify because of unresolved references. Provide it via addResource and try again.
< errorMessages.NoSuchAlgorithmException = Unknown Algorithm {0}
< errorMessages.NotYetImplementedException = Functionality not yet there.
< errorMessages.XMLSignatureException = Verification failed for some other reason.
< FileKeyStorageImpl.addToDefaultFromRemoteNotImplemented = Method addToDefaultFromRemote() not yet implemented.
< FileKeyStorageImpl.NoCert.Context = Not found such a X509Certificate including context {0}
< FileKeyStorageImpl.NoCert.IssNameSerNo = Not found such a X509Certificate with IssuerName {0} and serial number {1}
< FileKeyStorageImpl.NoCert.SubjName = Not found such a X509Certificate including SubjectName {0}
< generic.EmptyMessage = {0}
< generic.NotYetImplemented = {0} Not YET implemented ;-((
< java.security.InvalidKeyException = Invalid key
< java.security.NoSuchProviderException = Unknown or unsupported provider
< java.security.UnknownKeyType = Unknown or unsupported key type {0}
< KeyInfo.needKeyResolver = More than one keyResovler have to be registered
< KeyInfo.nokey = Can't get key from {0}
< KeyInfo.noKey = Can't get the public key
< KeyInfo.wrongNumberOfObject = Need {0} keyObjects
< KeyInfo.wrongUse = This object was made for getting {0}
< keyResolver.alreadyRegistered = {1} class has already been registered for {0}
< KeyResoverSpiImpl.cannotGetCert = Can't get the Certificate that include or in {1} in implement class {0}
< KeyResoverSpiImpl.elementGeneration = Can't make {1} element in implement class {0}
< KeyResoverSpiImpl.getPoublicKey = Can't get the public key from implement class {0}
< KeyResoverSpiImpl.InvalidElement = Cannot set (2) Element in implement class {0}
< KeyResoverSpiImpl.keyStore = KeyStorage error in implement class {0}
< KeyResoverSpiImpl.need.Element = {1} type of Element is needed in implement class {0}
< KeyResoverSpiImpl.wrongCRLElement = Cannot make CRL from {1} in implement class {0}
< KeyResoverSpiImpl.wrongKeyObject =  Need {1} type of KeyObject for generation Element in implement class{0}
< KeyResoverSpiImpl.wrongNumberOfObject = Need {1} keyObject in implement class {0}
< KeyStore.alreadyRegistered = {0} Class has already been registered for {1}
< KeyStore.register = {1} type class register error  in class {0}
< KeyStore.registerStore.register = Registeration error for type {0}
< signature.Canonicalizer.UnknownCanonicalizer = Unknown canonicalizer. No handler installed for URI {0}
< signature.signaturePropertyHasNoTarget = The Target attribute of the SignatureProperty must be set
< signature.Transform.ErrorDuringTransform = A {1} was thrown during the {0} transform
< signature.Transform.NotYetImplemented = Transform {0} not yet implemented
< signature.Transform.NullPointerTransform = Null pointer as URI. Programming bug?
< signature.Transform.UnknownTransform = Unknown transformation. No handler installed for URI {0}
< signature.Util.BignumNonPositive = bigInteger.signum() must be positive
< signature.Util.NonTextNode = Not a text node
< signature.Util.TooManyChilds = Too many childs of Type {0} in {1}
< signature.Verification.certificateError = Certificate error
< signature.Verification.IndexOutOfBounds = Index {0} illegal. We only have {1} References
< signature.Verification.internalError = Internal error
< signature.Verification.InvalidDigestOrReference = Invalid digest of reference {0}
< signature.Verification.keyStore = KeyStore error
< signature.Verification.MissingResources = Can't resolve external resource {0}
< signature.Verification.MissingID = Can't resolve element with ID {0}
< signature.Verification.NoSignatureElement = Input document contains no {0} Element in namespace {1}
< signature.Verification.Reference.NoInput = The Reference for URI {0} has no XMLSignatureInput
< signature.Verification.SignatureError = Signature error
< signature.XMLSignatureInput.MissingConstuctor = Can't construct a XMLSignatureInput from class {0}
< signature.XMLSignatureInput.SerializeDOM = Input initialized with DOM Element. Use Canonicalization to serialize it
< transform.Init.IllegalContextArgument = Invalid context argument of class {0}. Must be String, org.w3c.dom.NodeList or java.io.InputStream.
< transform.init.NotInitialized =
< transform.init.wrongURI = Initialized with wrong URI. How could this happen? We implement {0} but {1} was used during initialization
< utils.Base64.IllegalBitlength = Illegal byte length; Data to be decoded must be a multiple of 4
< utils.resolver.noClass = Could not find a resolver for URI {0} and Base {1}
< xml.WrongContent = Can't find {0} in {1}
< xml.WrongElement = Can't create a {0} from a {1} element
< xpath.funcHere.documentsDiffer = The XPath is not in the same document as the context node
< xpath.funcHere.noXPathContext = Try to evaluate an XPath which uses the here() function but XPath is not inside an ds:XPath Element. XPath was : {0}
< KeyValue.IllegalArgument = Can't create a {0} from {1}
< ElementProxy.nullElement = Can't create an ElementProxy from a null argument
< certificate.noSki.null = Certificate does not contain a SubjectKeyIdentifier
< certificate.noSki.lowVersion = Certificate cannot contain a SubjectKeyIdentifier because it is only X509v{0}
< certificate.noSki.notOctetString = Certificates SubjectKeyIdentifier is not a OctetString
< KeyResolver.needStorageResolver = Need a StorageResolver to retrieve a Certificate from a {0}
< empty = {0}
< signature.Generation.signBeforeGetValue = You have to XMLSignature.sign(java.security.PrivateKey) first
< generic.dontHaveConstructionElement = I don't have a construction Element
< prefix.AlreadyAssigned = You want to assign {0} as prefix for namespace {1} but it is already assigned for {2}
< notYetInitialized = The module {0} is not yet initialized
< encryption.ExplicitKeySizeMismatch = The xenc:KeySize element requests a key size of {0} bit but the algorithm implements {1} bit
< signature.DSA.invalidFormat = Invalid ASN.1 encoding of the DSA signature
< encryption.RSAOAEP.dataTooShort = data too short
< encryption.RSAOAEP.dataHashWrong = data hash wrong
< encryption.RSAOAEP.dataStartWrong = data wrong start {0}
< encryption.RSAPKCS15.blockTruncated = block truncated
< encryption.RSAPKCS15.unknownBlockType = unknown block type
< encryption.RSAPKCS15.noDataInBlock = no data in block
< encryption.nonceLongerThanDecryptedPlaintext = The given nonce is longer than the available plaintext. I can't strip away this.
< encryption.algorithmCannotEatInitParams = encryption.algorithmCannotEatInitParams
< encryption.algorithmCannotWrapUnWrap = encryption.algorithmCannotWrapUnWrap
< encryption.algorithmCannotEncryptDecrypt = encryption.algorithmCannotEncryptDecrypt
< encryption.algorithmCannotBeUsedForEncryptedData = encryption.algorithmCannotBeUsedForEncryptedData {0}
< namespacePrefixAlreadyUsedByOtherURI = Namespace prefix {0} already used by other URI {1}
< defaultNamespaceCannotBeSetHere = Default namespace cannot be set here
< attributeValueIllegal = The attribute {0} has value {1} but must be {2}
< endorsed.jdk1.4.0 = Since it seems that nobody reads our installation notes, we must do it in the exception messages. Hope you read them. You did NOT use the endorsed mechanism from JDK 1.4 properly; look at <http://xml.apache.org/security/install.html> how to solve this problem.
---
> algorithm.alreadyRegistered = URI {0} already assigned to class {1}
> algorithm.classDoesNotExist = Cannot register URI {0} to class {1} because this class does not exist in CLASSPATH
> algorithm.ClassDoesNotExist = Class {0} does not exist
> algorithm.extendsWrongClass = Cannot register URI {0} to class {1} because it does not extend {2}
> algorithms.CannotUseAlgorithmParameterSpecOnDSA = Sorry, but you cannot use a AlgorithmParameterSpec object for creating DSA signatures.
> algorithms.CannotUseAlgorithmParameterSpecOnRSA = Sorry, but you cannot use a AlgorithmParameterSpec object for creating RSA signatures.
> algorithms.CannotUseSecureRandomOnMAC = Sorry, but you cannot use a SecureRandom object for creating MACs.
> algorithms.HMACOutputLengthOnlyForHMAC = A HMACOutputLength can only be specified for HMAC integrity algorithms
> algorithms.NoSuchAlgorithm = The requested algorithm {0} does not exist. Original Message was: {1}
> algorithms.NoSuchMap = The algorithm URI "{0}" could not be mapped to a JCE algorithm
> algorithms.NoSuchProvider = The specified Provider {0} does not exist. Original Message was: {1}
> algorithms.operationOnlyVerification = A public key can only used for verification of a signature.
> algorithms.WrongKeyForThisOperation = Sorry, you supplied the wrong key type for this operation! You supplied a {0} but a {1} is needed.
> attributeValueIllegal = The attribute {0} has value {1} but must be {2}
> c14n.Canonicalizer.Exception = Exception during Canonicalization:  Original Message was {0}
> c14n.Canonicalizer.IllegalNode = Illegal node type {0}, node name was {1}
> c14n.Canonicalizer.NoSuchCanonicalizer = No canonicalizer found with URI {0}
> c14n.Canonicalizer.ParserConfigurationException = ParserConfigurationException during Canonicalization:  Original Message was {0}
> c14n.Canonicalizer.RelativeNamespace = Element {0} has a relative namespace: {1}="{2}"
> c14n.Canonicalizer.SAXException = SAXException during Canonicalization:  Original Message was {0}
> c14n.Canonicalizer.TraversalNotSupported = This DOM document does not support Traversal {0}
> c14n.Canonicalizer.UnsupportedEncoding = Unsupported encoding {0}
> c14n.Canonicalizer.UnsupportedOperation = This canonicalizer does not support this operation
> c14n.XMLUtils.circumventBug2650forgotten = The tree has not been prepared for canonicalization using XMLUtils#circumventBug2650(Document)
> certificate.noSki.lowVersion = Certificate cannot contain a SubjectKeyIdentifier because it is only X509v{0}
> certificate.noSki.notOctetString = Certificates SubjectKeyIdentifier is not a OctetString
> certificate.noSki.null = Certificate does not contain a SubjectKeyIdentifier
> defaultNamespaceCannotBeSetHere = Default namespace cannot be set here
> ElementProxy.nullElement = Cannot create an ElementProxy from a null argument
> empty = {0}
> encryption.algorithmCannotBeUsedForEncryptedData = encryption.algorithmCannotBeUsedForEncryptedData {0}
> encryption.algorithmCannotEatInitParams = encryption.algorithmCannotEatInitParams
> encryption.algorithmCannotEncryptDecrypt = encryption.algorithmCannotEncryptDecrypt
> encryption.algorithmCannotWrapUnWrap = encryption.algorithmCannotWrapUnWrap
> encryption.ExplicitKeySizeMismatch = The xenc:KeySize element requests a key size of {0} bit but the algorithm implements {1} bit
> encryption.nonceLongerThanDecryptedPlaintext = The given nonce is longer than the available plaintext. I Cannot strip away this.
> encryption.RSAOAEP.dataHashWrong = data hash wrong
> encryption.RSAOAEP.dataStartWrong = data wrong start {0}
> encryption.RSAOAEP.dataTooShort = data too short
> encryption.RSAPKCS15.blockTruncated = block truncated
> encryption.RSAPKCS15.noDataInBlock = no data in block
> encryption.RSAPKCS15.unknownBlockType = unknown block type
> encryption.nokey = No Key Encryption Key loaded and cannot determine using key resolvers
> endorsed.jdk1.4.0 = Since it seems that nobody reads our installation notes, we must do it in the exception messages. Hope you read them. You did NOT use the endorsed mechanism from JDK 1.4 properly; look at <http://xml.apache.org/security/Java/installation.html> how to solve this problem.
> errorMessages.InvalidDigestValueException = INVALID signature -- check reference resolution.
> errorMessages.InvalidSignatureValueException = INVALID signature -- core validation failed.
> errorMessages.IOException = Other file I/O and similar exceptions.
> errorMessages.MissingKeyFailureException = Cannot verify because of missing public key. Provide it via addResource and try again.
> errorMessages.MissingResourceFailureException = Cannot verify because of unresolved references. Provide it via addResource and try again.
> errorMessages.NoSuchAlgorithmException = Unknown Algorithm {0}
> errorMessages.NotYetImplementedException = Functionality not yet there.
> errorMessages.XMLSignatureException = Verification failed for some other reason.
> decoding.general = Error while decoding
> FileKeyStorageImpl.addToDefaultFromRemoteNotImplemented = Method addToDefaultFromRemote() not yet implemented.
> FileKeyStorageImpl.NoCert.Context = Not found such a X509Certificate including context {0}
> FileKeyStorageImpl.NoCert.IssNameSerNo = Not found such a X509Certificate with IssuerName {0} and serial number {1}
> FileKeyStorageImpl.NoCert.SubjName = Not found such a X509Certificate including SubjectName {0}
> generic.dontHaveConstructionElement = I do not have a construction Element
> generic.EmptyMessage = {0}
> generic.NotYetImplemented = {0} Not YET implemented ;-((
> java.security.InvalidKeyException = Invalid key
> java.security.NoSuchProviderException = Unknown or unsupported provider
> java.security.UnknownKeyType = Unknown or unsupported key type {0}
> KeyInfo.needKeyResolver = More than one keyResovler have to be registered
> KeyInfo.nokey = Cannot get key from {0}
> KeyInfo.noKey = Cannot get the public key
> KeyInfo.wrongNumberOfObject = Need {0} keyObjects
> KeyInfo.wrongUse = This object was made for getting {0}
> keyResolver.alreadyRegistered = {1} class has already been registered for {0}
> KeyResolver.needStorageResolver = Need a StorageResolver to retrieve a Certificate from a {0}
> KeyResoverSpiImpl.cannotGetCert = Cannot get the Certificate that include or in {1} in implement class {0}
> KeyResoverSpiImpl.elementGeneration = Cannot make {1} element in implement class {0}
> KeyResoverSpiImpl.getPoublicKey = Cannot get the public key from implement class {0}
> KeyResoverSpiImpl.InvalidElement = Cannot set (2) Element in implement class {0}
> KeyResoverSpiImpl.keyStore = KeyStorage error in implement class {0}
> KeyResoverSpiImpl.need.Element = {1} type of Element is needed in implement class {0}
> KeyResoverSpiImpl.wrongCRLElement = Cannot make CRL from {1} in implement class {0}
> KeyResoverSpiImpl.wrongKeyObject =  Need {1} type of KeyObject for generation Element in implement class{0}
> KeyResoverSpiImpl.wrongNumberOfObject = Need {1} keyObject in implement class {0}
> KeyStore.alreadyRegistered = {0} Class has already been registered for {1}
> KeyStore.register = {1} type class register error  in class {0}
> KeyStore.registerStore.register = Registeration error for type {0}
> KeyValue.IllegalArgument = Cannot create a {0} from {1}
> namespacePrefixAlreadyUsedByOtherURI = Namespace prefix {0} already used by other URI {1}
> notYetInitialized = The module {0} is not yet initialized
> prefix.AlreadyAssigned = You want to assign {0} as prefix for namespace {1} but it is already assigned for {2}
> signature.Canonicalizer.UnknownCanonicalizer = Unknown canonicalizer. No handler installed for URI {0}
> signature.DSA.invalidFormat = Invalid ASN.1 encoding of the DSA signature
> signature.Generation.signBeforeGetValue = You have to XMLSignature.sign(java.security.PrivateKey) first
> signature.signaturePropertyHasNoTarget = The Target attribute of the SignatureProperty must be set
> signature.Transform.ErrorDuringTransform = A {1} was thrown during the {0} transform
> signature.Transform.NotYetImplemented = Transform {0} not yet implemented
> signature.Transform.NullPointerTransform = Null pointer as URI. Programming bug?
> signature.Transform.UnknownTransform = Unknown transformation. No handler installed for URI {0}
> signature.Util.BignumNonPositive = bigInteger.signum() must be positive
> signature.Util.NonTextNode = Not a text node
> signature.Util.TooManyChilds = Too many childs of Type {0} in {1}
> signature.Verification.certificateError = Certificate error
> signature.Verification.IndexOutOfBounds = Index {0} illegal. We only have {1} References
> signature.Verification.internalError = Internal error
> signature.Verification.InvalidDigestOrReference = Invalid digest of reference {0}
> signature.Verification.keyStore = KeyStore error
> signature.Verification.MissingID = Cannot resolve element with ID {0}
> signature.Verification.MissingResources = Cannot resolve external resource {0}
> signature.Verification.NoSignatureElement = Input document contains no {0} Element in namespace {1}
> signature.Verification.Reference.NoInput = The Reference for URI {0} has no XMLSignatureInput
> signature.Verification.SignatureError = Signature error
> signature.XMLSignatureInput.MissingConstuctor = Cannot construct a XMLSignatureInput from class {0}
> signature.XMLSignatureInput.SerializeDOM = Input initialized with DOM Element. Use Canonicalization to serialize it
> transform.Init.IllegalContextArgument = Invalid context argument of class {0}. Must be String, org.w3c.dom.NodeList or java.io.InputStream.
> transform.init.NotInitialized =
> transform.init.wrongURI = Initialized with wrong URI. How could this happen? We implement {0} but {1} was used during initialization
> utils.Base64.IllegalBitlength = Illegal byte length; Data to be decoded must be a multiple of 4
> utils.resolver.noClass = Could not find a resolver for URI {0} and Base {1}
> xml.WrongContent = Cannot find {0} in {1}
> xml.WrongElement = Cannot create a {0} from a {1} element
> xpath.funcHere.documentsDiffer = The XPath is not in the same document as the context node
> xpath.funcHere.noXPathContext = Try to evaluate an XPath which uses the here() function but XPath is not inside an ds:XPath Element. XPath was : {0}
diff -r xml-security-orig-v1/src/org/apache/xml/security/signature/InvalidDigestValueException.java xml-security-1_2_0/src/org/apache/xml/security/signature/InvalidDigestValueException.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights 
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer. 
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:  
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written 
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European 
<  * Commission in the <WebSig> project in the ISIS Programme. 
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
82c40
<     * @param msgID
---
>     * @param _msgID
84,85c42,43
<    public InvalidDigestValueException(String msgID) {
<       super(msgID);
---
>    public InvalidDigestValueException(String _msgID) {
>       super(_msgID);
91c49
<     * @param msgID
---
>     * @param _msgID
94,95c52,53
<    public InvalidDigestValueException(String msgID, Object exArgs[]) {
<       super(msgID, exArgs);
---
>    public InvalidDigestValueException(String _msgID, Object exArgs[]) {
>       super(_msgID, exArgs);
101,102c59,60
<     * @param msgID
<     * @param originalException
---
>     * @param _msgID
>     * @param _originalException
104,106c62,64
<    public InvalidDigestValueException(String msgID,
<                                       Exception originalException) {
<       super(msgID, originalException);
---
>    public InvalidDigestValueException(String _msgID,
>                                       Exception _originalException) {
>       super(_msgID, _originalException);
112c70
<     * @param msgID
---
>     * @param _msgID
114c72
<     * @param originalException
---
>     * @param _originalException
116,118c74,76
<    public InvalidDigestValueException(String msgID, Object exArgs[],
<                                       Exception originalException) {
<       super(msgID, exArgs, originalException);
---
>    public InvalidDigestValueException(String _msgID, Object exArgs[],
>                                       Exception _originalException) {
>       super(_msgID, exArgs, _originalException);
diff -r xml-security-orig-v1/src/org/apache/xml/security/signature/InvalidSignatureValueException.java xml-security-1_2_0/src/org/apache/xml/security/signature/InvalidSignatureValueException.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights 
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer. 
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:  
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written 
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European 
<  * Commission in the <WebSig> project in the ISIS Programme. 
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
83c41
<     * @param msgID
---
>     * @param _msgID
85,86c43,44
<    public InvalidSignatureValueException(String msgID) {
<       super(msgID);
---
>    public InvalidSignatureValueException(String _msgID) {
>       super(_msgID);
92c50
<     * @param msgID
---
>     * @param _msgID
95,96c53,54
<    public InvalidSignatureValueException(String msgID, Object exArgs[]) {
<       super(msgID, exArgs);
---
>    public InvalidSignatureValueException(String _msgID, Object exArgs[]) {
>       super(_msgID, exArgs);
102,103c60,61
<     * @param msgID
<     * @param originalException
---
>     * @param _msgID
>     * @param _originalException
105,107c63,65
<    public InvalidSignatureValueException(String msgID,
<                                          Exception originalException) {
<       super(msgID, originalException);
---
>    public InvalidSignatureValueException(String _msgID,
>                                          Exception _originalException) {
>       super(_msgID, _originalException);
113c71
<     * @param msgID
---
>     * @param _msgID
115c73
<     * @param originalException
---
>     * @param _originalException
117,119c75,77
<    public InvalidSignatureValueException(String msgID, Object exArgs[],
<                                          Exception originalException) {
<       super(msgID, exArgs, originalException);
---
>    public InvalidSignatureValueException(String _msgID, Object exArgs[],
>                                          Exception _originalException) {
>       super(_msgID, exArgs, _originalException);
diff -r xml-security-orig-v1/src/org/apache/xml/security/signature/Manifest.java xml-security-1_2_0/src/org/apache/xml/security/signature/Manifest.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,6
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
5,6c8
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
---
>  *      http://www.apache.org/licenses/LICENSE-2.0
8,10c10,14
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
---
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
12,57d15
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63d20
< import java.io.ByteArrayInputStream;
65c22,26
< import java.util.*;
---
> import java.util.HashMap;
> import java.util.Iterator;
> import java.util.Set;
> import java.util.Vector;
> 
67,69c28,30
< import javax.xml.transform.TransformerException;
< import org.apache.xml.security.algorithms.MessageDigestAlgorithm;
< import org.apache.xml.security.c14n.*;
---
> 
> import org.apache.xml.security.c14n.CanonicalizationException;
> import org.apache.xml.security.c14n.InvalidCanonicalizerException;
71d31
< import org.apache.xml.security.transforms.TransformationException;
73,76c33,44
< import org.apache.xml.security.utils.*;
< import org.apache.xml.security.utils.resolver.*;
< import org.apache.xpath.XPathAPI;
< import org.w3c.dom.*;
---
> import org.apache.xml.security.utils.CachedXPathAPIHolder;
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.I18n;
> import org.apache.xml.security.utils.IdResolver;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.apache.xml.security.utils.XMLUtils;
> import org.apache.xml.security.utils.resolver.ResourceResolver;
> import org.apache.xml.security.utils.resolver.ResourceResolverSpi;
> import org.w3c.dom.DOMException;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.Node;
79a48
> 
81c50
<  * Handles <code>&lt;ds:Manifest&gt;</code> elements
---
>  * Handles <code>&lt;ds:Manifest&gt;</code> elements.
87,89c56,58
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(Manifest.class.getName());
---
>   /** {@link org.apache.commons.logging} logging facility */
>   static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(Manifest.class.getName());
92a62
>    Element[] _referencesEl;
105a76
>    CachedXPathAPIHolder cx=new CachedXPathAPIHolder();
133c104,106
<       int le = this.length(Constants.SignatureSpecNS, Constants._TAG_REFERENCE);
---
>       this._referencesEl = XMLUtils.selectDsNodes(this._constructionElement.getFirstChild(),
>          Constants._TAG_REFERENCE);
>       int le = this._referencesEl.length;
175c148
<                                        transforms, digestURI);
---
>                                        transforms, digestURI,cx);
239c212
<       } else {
---
>       } 
242,246c215,216
<             // not yet constructed, so _we_ have to
<             Element refElem = super.getChildElementLocalName(i,
<                                  Constants.SignatureSpecNS,
<                                  Constants._TAG_REFERENCE);
<             Reference ref = new Reference(refElem, this._baseURI, this);
---
>             // not yet constructed, so _we_ have to            
>             Reference ref = new Reference(_referencesEl[i], this._baseURI, this,cx);
252c222
<       }
---
>       
290c260
<     * @see org.apache.xml.security.signature.SignedInfo#verify
---
>     * @see org.apache.xml.security.signature.SignedInfo#verify()
313c283
<     * @see org.apache.xml.security.signature.SignedInfo#verify
---
>     * @see org.apache.xml.security.signature.SignedInfo#verify(boolean)
319,324c289,296
< 
<       cat.debug(
<          "verify "
<          + this.length(Constants.SignatureSpecNS, Constants._TAG_REFERENCE)
<          + " References");
<       cat.debug("I am " + (followManifests
---
>       if (_referencesEl==null) {
>         this._referencesEl =  
>             XMLUtils.selectDsNodes(this._constructionElement.getFirstChild(),
>                          Constants._TAG_REFERENCE);
>       }
>    	  if (log.isDebugEnabled()) {
>    	  	log.debug("verify " +_referencesEl.length + " References");
>         log.debug("I am " + (followManifests
327c299
< 
---
>       }
330,331c302
<       if (this.length(Constants.SignatureSpecNS, Constants._TAG_REFERENCE)
<               == 0) {
---
>       if (_referencesEl.length==0) {
336c307
<          new boolean[this.length(Constants.SignatureSpecNS, Constants._TAG_REFERENCE)];
---
>          new boolean[_referencesEl.length];
339,341c310
<               0; i < this
<                  .length(Constants.SignatureSpecNS, Constants
<                     ._TAG_REFERENCE); i++) {
---
>               0; i < this._referencesEl.length; i++) {
343,345c312
<             new Reference(this
<                .getChildElementLocalName(i, Constants.SignatureSpecNS, Constants
<                ._TAG_REFERENCE), this._baseURI, this);
---
>             new Reference(_referencesEl[i], this._baseURI, this,cx);
358,359c325,326
< 
<             cat.debug("The Reference has Type " + currentRef.getType());
---
>             if (log.isDebugEnabled())
>             	log.debug("The Reference has Type " + currentRef.getType());
364,367c331
<                cat.debug("We have to follow a nested Manifest");
< 
<                try {
<                   currentRef.dereferenceURIandPerformTransforms();
---
>                log.debug("We have to follow a nested Manifest");
368a333
>                 try {
370c335
<                      currentRef.getTransformsOutput();
---
>                     currentRef.dereferenceURIandPerformTransforms(null);
414c379
<                      cat.warn("The nested Manifest was invalid (bad)");
---
>                      log.warn("The nested Manifest was invalid (bad)");
416c381
<                      cat.debug("The nested Manifest was valid (good)");
---
>                      log.debug("The nested Manifest was valid (good)");
443d407
<     * @throws XMLSecurityException
446c410
<            throws XMLSecurityException {
---
>    {
457c421
<     * {@link Manifest#verifyReferences} or {@link SignedInfo#verify} methods,
---
>     * {@link Manifest#verifyReferences()} or {@link SignedInfo#verify()} methods,
478c442
<             boolean discard = this.verifyReferences();
---
>             this.verifyReferences();
512c476
<     * Used to pass parameters like proxy servers etc. to the ResourceResolver
---
>     * Used to pass parameters like proxy servers etc to the ResourceResolver
519,531d482
< 
<       java.util.Iterator i = this._resolverProperties.keySet().iterator();
< 
<       while (i.hasNext()) {
<          String c = (String) i.next();
< 
<          if (c.equals(key)) {
<             key = c;
< 
<             break;
<          }
<       }
< 
542,554d492
< 
<       java.util.Iterator i = this._resolverProperties.keySet().iterator();
< 
<       while (i.hasNext()) {
<          String c = (String) i.next();
< 
<          if (c.equals(key)) {
<             key = c;
< 
<             break;
<          }
<       }
< 
562c500,501
<     * @return
---
>     * @return The signed content of the i reference.
>     *
584c523
<     * @return
---
>     * @return The contents before transformation of the reference i.
589c528
<       return this.item(i).getTransformsInput();
---
>       return this.item(i).getContentsBeforeTransformation();
596c535
<     * @return
---
>     * @return The contents after transformation of the reference i.
601c540
<       return this.item(i).getTransformsOutput();
---
>       return this.item(i).getContentsAfterTransformation();
607c546
<     * @return
---
>     * @return The nu,ber of references contained in this reference.
616c555
<     * @return
---
>     * @inheritDoc
diff -r xml-security-orig-v1/src/org/apache/xml/security/signature/MissingResourceFailureException.java xml-security-1_2_0/src/org/apache/xml/security/signature/MissingResourceFailureException.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights 
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer. 
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:  
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written 
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European 
<  * Commission in the <WebSig> project in the ISIS Programme. 
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64,67d21
< import java.util.Collection;
< import org.apache.xml.security.signature.Reference;
< import org.apache.xml.security.exceptions.XMLSecurityException;
< import org.apache.xml.security.signature.XMLSignatureException;
71c25
<  * Thrown by {@link org.apache.xml.security.signature.SignedInfo#verify} when
---
>  * Thrown by {@link org.apache.xml.security.signature.SignedInfo#verify()} when
85c39
<     * @param msgID
---
>     * @param _msgID
89c43
<    public MissingResourceFailureException(String msgID, Reference reference) {
---
>    public MissingResourceFailureException(String _msgID, Reference reference) {
91c45
<       super(msgID);
---
>       super(_msgID);
99c53
<     * @param msgID
---
>     * @param _msgID
104c58
<    public MissingResourceFailureException(String msgID, Object exArgs[],
---
>    public MissingResourceFailureException(String _msgID, Object exArgs[],
107c61
<       super(msgID, exArgs);
---
>       super(_msgID, exArgs);
115,116c69,70
<     * @param msgID
<     * @param originalException
---
>     * @param _msgID
>     * @param _originalException
120,121c74,75
<    public MissingResourceFailureException(String msgID,
<                                           Exception originalException,
---
>    public MissingResourceFailureException(String _msgID,
>                                           Exception _originalException,
124c78
<       super(msgID, originalException);
---
>       super(_msgID, _originalException);
132c86
<     * @param msgID
---
>     * @param _msgID
134c88
<     * @param originalException
---
>     * @param _originalException
138,139c92,93
<    public MissingResourceFailureException(String msgID, Object exArgs[],
<                                           Exception originalException,
---
>    public MissingResourceFailureException(String _msgID, Object exArgs[],
>                                           Exception _originalException,
142c96
<       super(msgID, exArgs, originalException);
---
>       super(_msgID, exArgs, _originalException);
diff -r xml-security-orig-v1/src/org/apache/xml/security/signature/ObjectContainer.java xml-security-1_2_0/src/org/apache/xml/security/signature/ObjectContainer.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,74c21,27
< import java.io.IOException;
< import org.w3c.dom.*;
< import org.apache.xml.security.algorithms.SignatureAlgorithm;
< import org.apache.xml.security.c14n.Canonicalizer;
< import org.apache.xml.security.c14n.CanonicalizationException;
< import org.apache.xml.security.signature.MissingResourceFailureException;
< import org.apache.xml.security.exceptions.*;
< import org.apache.xml.security.signature.XMLSignatureException;
< import org.apache.xml.security.signature.Reference;
< import org.apache.xml.security.signature.XMLSignatureInput;
< import org.apache.xml.security.transforms.Transforms;
< import org.apache.xml.security.utils.*;
---
> import org.apache.xml.security.exceptions.XMLSecurityException;
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.IdResolver;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.Node;
83c36
<  * @todo if we remove childen, the boolean values are not updated
---
>  * $todo$ if we remove childen, the boolean values are not updated
87,89c40,42
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(ObjectContainer.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>    static org.apache.commons.logging.Log log = 
>        org.apache.commons.logging.LogFactory.getLog(ObjectContainer.class.getName());
196a150
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/signature/package.html xml-security-1_2_0/src/org/apache/xml/security/signature/package.html
2c2
< XML Signature specific classes  
---
> XML Signature specific classes.
diff -r xml-security-orig-v1/src/org/apache/xml/security/signature/Reference.java xml-security-1_2_0/src/org/apache/xml/security/signature/Reference.java
0a1
> 
2,18c3
<  * The Apache Software License, Version 1.1
<  *
<  *
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
---
>  * Copyright  1999-2004 The Apache Software Foundation.
20,25c5,15
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
---
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
27,57d16
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,83c22,27
< import java.io.*;
< import java.math.BigInteger;
< import java.util.*;
< import javax.xml.parsers.DocumentBuilder;
< import javax.xml.parsers.DocumentBuilderFactory;
< import javax.xml.parsers.ParserConfigurationException;
< import javax.xml.transform.TransformerException;
< //import org.apache.xml.serialize.OutputFormat;
< //import org.apache.xml.serialize.Serializer;
< //import org.apache.xml.serialize.SerializerFactory;
< //import org.apache.xml.serialize.XMLSerializer;
< import org.apache.xml.utils.PrefixResolverDefault;
< import org.apache.xpath.NodeSet;
< import org.apache.xpath.objects.XObject;
< import org.apache.xpath.XPath;
< import org.apache.xpath.XPathAPI;
< import org.apache.xpath.XPathContext;
< import org.w3c.dom.*;
< import org.w3c.dom.traversal.NodeIterator;
< import org.xml.sax.InputSource;
< import org.xml.sax.SAXException;
---
> import java.io.BufferedOutputStream;
> import java.io.IOException;
> import java.io.OutputStream;
> import java.util.HashSet;
> import java.util.Set;
> 
85,92c29,51
< import org.apache.xml.security.c14n.*;
< import org.apache.xml.security.transforms.params.XPathContainer;
< import org.apache.xml.security.exceptions.*;
< import org.apache.xml.security.signature.*;
< import org.apache.xml.security.transforms.*;
< import org.apache.xml.security.utils.*;
< import org.apache.xml.security.utils.resolver.*;
< import javax.xml.transform.TransformerException;
---
> import org.apache.xml.security.c14n.CanonicalizationException;
> import org.apache.xml.security.c14n.InvalidCanonicalizerException;
> import org.apache.xml.security.exceptions.Base64DecodingException;
> import org.apache.xml.security.exceptions.XMLSecurityException;
> import org.apache.xml.security.transforms.InvalidTransformException;
> import org.apache.xml.security.transforms.Transform;
> import org.apache.xml.security.transforms.TransformationException;
> import org.apache.xml.security.transforms.Transforms;
> import org.apache.xml.security.transforms.params.InclusiveNamespaces;
> import org.apache.xml.security.utils.Base64;
> import org.apache.xml.security.utils.CachedXPathAPIHolder;
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.DigesterOutputStream;
> import org.apache.xml.security.utils.IdResolver;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.apache.xml.security.utils.XMLUtils;
> import org.apache.xml.security.utils.resolver.ResourceResolver;
> import org.apache.xml.security.utils.resolver.ResourceResolverException;
> import org.w3c.dom.Attr;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.Node;
> import org.w3c.dom.Text;
143,145c102,107
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(Reference.class.getName());
---
>    /** Field CacheSignedNodes */
>    public static boolean CacheSignedNodes = false;
> 
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(Reference.class.getName());
156d117
<    XMLSignatureInput _transformsInput;
157a119
>    CachedXPathAPIHolder cx;
167,169c129,132
<     * @param transforms {@link transforms} applied to data
<     * @param messageDigestAlgorithm {@link algorithms.MessageDigestAlgorithm Digest algorithm} which is applied to the data
<     * @todo should we throw XMLSignatureException if MessageDigestAlgoURI is wrong?
---
>     * @param transforms {@link Transforms} applied to data
>     * @param messageDigestAlgorithm {@link MessageDigestAlgorithm Digest algorithm} which is applied to the data
>     * $todo$ should we throw XMLSignatureException if MessageDigestAlgoURI is wrong?
>     * @param cx for speed-up the xpath selections.
172,174c135,136
<    protected Reference(
<            Document doc, String BaseURI, String ReferenceURI, Manifest manifest, Transforms transforms, String messageDigestAlgorithm)
<               throws XMLSignatureException {
---
>    protected Reference(Document doc, String BaseURI, String ReferenceURI, Manifest manifest, Transforms transforms, String messageDigestAlgorithm,CachedXPathAPIHolder cx)
>            throws XMLSignatureException {
181a144
>       this.cx=cx;
189d151
<       Element nscontext = XMLUtils.createDSctx(this._doc, "ds");
213,261d174
<    /**
<     * Constructor Reference
<     *
<     * @param doc this {@link Document} in which <code>XMLsignature</code> is placed
<     * @param BaseURI the URI of the resource where the XML instance will be stored
<     * @param ReferenceURI This referenceURI indicate where the data will for signature validation
<     * @param manifest
<     * @param messageDigestAlgorithm  {@link algorithms.MessageDigestAlgorithm Digest algorithm} which is applied to the data
<     * @throws XMLSignatureException
<     */
<    protected Reference(
<            Document doc, String BaseURI, String ReferenceURI, Manifest manifest, String messageDigestAlgorithm)
<               throws XMLSignatureException {
<       this(doc, BaseURI, ReferenceURI, manifest, (Transforms) null,
<            messageDigestAlgorithm);
<    }
< 
<    /**
<     * Constructor Reference
<     *
<     * @param doc this {@link Document} in which <code>XMLsignature</code> is placed
<     * @param BaseURI the URI of the resource where the XML instance will be stored
<     * @param ReferenceURI This referenceURI indicate where the data is for signature validation
<     * @param manifest
<     * @param transforms {@link transforms} applied to data
<     * @throws XMLSignatureException
<     */
<    protected Reference(
<            Document doc, String BaseURI, String ReferenceURI, Manifest manifest, Transforms transforms)
<               throws XMLSignatureException {
<       this(doc, BaseURI, ReferenceURI, manifest, transforms,
<            Constants.ALGO_ID_DIGEST_SHA1);
<    }
< 
<    /**
<     * Constructor Reference
<     *
<     * @param doc this {@link Document} in which <code>XMLsignature</code> is placed
<     * @param BaseURI the URI of the resource where the XML instance will be stored
<     * @param ReferenceURI This referenceURI indicate where the data is for signature validation
<     * @param manifest
<     * @throws XMLSignatureException
<     */
<    protected Reference(
<            Document doc, String BaseURI, String ReferenceURI, Manifest manifest)
<               throws XMLSignatureException {
<       this(doc, BaseURI, ReferenceURI, manifest, (Transforms) null,
<            Constants.ALGO_ID_DIGEST_SHA1);
<    }
268a182
>     * @param cx The CachedXPathAPIHolder to use in this reference.
271c185
<    protected Reference(Element element, String BaseURI, Manifest manifest)
---
>    protected Reference(Element element, String BaseURI, Manifest manifest,CachedXPathAPIHolder cx)
274a189
>       this.cx=cx;
290,292c205,206
<       Element digestMethodElem = this.getChildElementLocalName(0,
<                                     Constants.SignatureSpecNS,
<                                     Constants._TAG_DIGESTMETHOD);
---
>       Element digestMethodElem = XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>             Constants._TAG_DIGESTMETHOD,0);
298c212,217
<       String uri = digestMethodElem.getAttributeNS(null, Constants._ATT_ALGORITHM);
---
>       String uri = digestMethodElem.getAttributeNS(null,
>          Constants._ATT_ALGORITHM);
> 
> 	  if (uri == null) {
> 		  return null;
> 	  }
311c230,231
<          this._constructionElement.setAttributeNS(null, Constants._ATT_URI, URI);
---
>          this._constructionElement.setAttributeNS(null, Constants._ATT_URI,
>                                                   URI);
354c274,275
<          this._constructionElement.setAttributeNS(null, Constants._ATT_TYPE, Type);
---
>          this._constructionElement.setAttributeNS(null, Constants._ATT_TYPE,
>                                                   Type);
364c285,286
<       return this._constructionElement.getAttributeNS(null, Constants._ATT_TYPE);
---
>       return this._constructionElement.getAttributeNS(null,
>               Constants._ATT_TYPE);
407d328
<     * @throws XMLSignatureException
410c331
<            throws XMLSignatureException {
---
>    {
413,419c334,339
<          Element digestValueElement = this.getChildElementLocalName(0,
<                                          Constants.SignatureSpecNS,
<                                          Constants._TAG_DIGESTVALUE);
<          NodeList children = digestValueElement.getChildNodes();
< 
<          for (int i = 0; i < children.getLength(); i++) {
<             digestValueElement.removeChild(children.item(i));
---
>          Element digestValueElement =XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>                  Constants._TAG_DIGESTVALUE,0);
>          Node n=digestValueElement.getFirstChild();
>          while (n!=null) {
>                digestValueElement.removeChild(n);
>                n = n.getNextSibling();
439d358
<          byte calculatedBytes[] = this.calculateDigest();
441c360
<          this.setDigestValueElement(calculatedBytes);
---
>          this.setDigestValueElement(this.calculateDigest());
446,451c365,368
<     * This method returns the {@link XMLSignatureInput} which is referenced by the
<     * <CODE>URI</CODE> Attribute.
<     *
<     * @throws ReferenceNotInitializedException
<     * @throws XMLSignatureException
<     * @ see Manifest#verifyReferences
---
>     * Returns the XMLSignatureInput which is created by de-referencing the URI attribute.
>     * @return the XMLSignatureInput of the source of this reference
>     * @throws ReferenceNotInitializedException If the resolver found any
>     *  problem resolving the reference
453,454c370,371
<    protected void dereferenceURIandPerformTransforms()
<            throws ReferenceNotInitializedException, XMLSignatureException {
---
>    public XMLSignatureInput getContentsBeforeTransformation()
>            throws ReferenceNotInitializedException {
457,458c374,375
<          Attr URIAttr =
<             this._constructionElement.getAttributeNode(Constants._ATT_URI);
---
>          Attr URIAttr = this._constructionElement.getAttributeNodeNS(null,
>             Constants._ATT_URI);
468,469c385
<                                         this._baseURI,
<                                         this._manifest._perManifestResolvers);
---
>             this._baseURI, this._manifest._perManifestResolvers);
480c396,405
<          this._transformsInput = resolver.resolve(URIAttr, this._baseURI);
---
>          XMLSignatureInput input = resolver.resolve(URIAttr, this._baseURI);
>                   
> 
>          return input;
>       }  catch (ResourceResolverException ex) {
>          throw new ReferenceNotInitializedException("empty", ex);
>       } catch (XMLSecurityException ex) {
>          throw new ReferenceNotInitializedException("empty", ex);
>       }
>    }
481a407,434
>    /**
>     * Returns the data which is referenced by the URI attribute. This method
>     * only works works after a call to verify.
>     * @return a XMLSignature with a byte array.
>     * @throws ReferenceNotInitializedException
>     *
>     * @deprecated use
>     */
>    public XMLSignatureInput getTransformsInput() throws ReferenceNotInitializedException   
> 	{  
>    		XMLSignatureInput input=getContentsBeforeTransformation();
>    		XMLSignatureInput result;
> 		try {
> 			result = new XMLSignatureInput(input.getBytes());
> 		} catch (CanonicalizationException ex) {
> 			 throw new ReferenceNotInitializedException("empty", ex);
> 		} catch (IOException ex) {
> 			 throw new ReferenceNotInitializedException("empty", ex);
> 		}
> 		result.setSourceURI(input.getSourceURI());   
> 		return result;
> 	
>    }
> 
>    private XMLSignatureInput getContentsAfterTransformation(XMLSignatureInput input, OutputStream os)
>            throws XMLSignatureException {
> 
>       try {
482a436
>          XMLSignatureInput output = null;
485,486c439,442
<             this._transformsOutput =
<                transforms.performTransforms(this._transformsInput);
---
>             output = transforms.performTransforms(input,os);
>             this._transformsOutput = output;//new XMLSignatureInput(output.getBytes());
> 
>             //this._transformsOutput.setSourceURI(output.getSourceURI());
488c444
<             this._transformsOutput = this._transformsInput;
---
>             output = input;
489a446,447
> 
>          return output;
491c449
<          throw new ReferenceNotInitializedException("empty", ex);
---
>          throw new XMLSignatureException("empty", ex);
493c451
<          throw new ReferenceNotInitializedException("empty", ex);
---
>          throw new XMLSignatureException("empty", ex);
495c453
<          throw new ReferenceNotInitializedException("empty", ex);
---
>          throw new XMLSignatureException("empty", ex);
497c455,622
<          throw new ReferenceNotInitializedException("empty", ex);
---
>          throw new XMLSignatureException("empty", ex);
>       } catch (XMLSecurityException ex) {
>          throw new XMLSignatureException("empty", ex);
>       }
>    }
> 
>    /**
>     * Returns the XMLSignatureInput which is the result of the Transforms.
>     * @return a XMLSignatureInput with all transformations applied.
>     * @throws XMLSignatureException
>     */
>    public XMLSignatureInput getContentsAfterTransformation()
>            throws XMLSignatureException {
> 
>       XMLSignatureInput input = this.getContentsBeforeTransformation();
> 
>       return this.getContentsAfterTransformation(input, null);
>    }
> 
>    /**
>     * This method returns the XMLSignatureInput which represents the node set before
>     * some kind of canonicalization is applied for the first time.
>     * @return Gets a the node doing everything till the first c14n is needed
>     *
>     * @throws XMLSignatureException
>     */
>    public XMLSignatureInput getNodesetBeforeFirstCanonicalization()
>            throws XMLSignatureException {
> 
>       try {
>          XMLSignatureInput input = this.getContentsBeforeTransformation();
>          XMLSignatureInput output = input;
>          Transforms transforms = this.getTransforms();
> 
>          if (transforms != null) {
>             doTransforms: for (int i = 0; i < transforms.getLength(); i++) {
>                Transform t = transforms.item(i);
>                String URI = t.getURI();
> 
>                if (URI.equals(Transforms
>                        .TRANSFORM_C14N_EXCL_OMIT_COMMENTS) || URI
>                           .equals(Transforms
>                              .TRANSFORM_C14N_EXCL_WITH_COMMENTS) || URI
>                                 .equals(Transforms
>                                    .TRANSFORM_C14N_OMIT_COMMENTS) || URI
>                                       .equals(Transforms
>                                          .TRANSFORM_C14N_WITH_COMMENTS)) {
> 
>                   break doTransforms;
>                }
> 
>                output = t.performTransform(output, null);
>             }
> 
>             output.setSourceURI(input.getSourceURI());
>          }
>          return output;
>       } catch (IOException ex) {
>          throw new XMLSignatureException("empty", ex);
>       } catch (ResourceResolverException ex) {
>          throw new XMLSignatureException("empty", ex);
>       } catch (CanonicalizationException ex) {
>          throw new XMLSignatureException("empty", ex);
>       } catch (InvalidCanonicalizerException ex) {
>          throw new XMLSignatureException("empty", ex);
>       } catch (TransformationException ex) {
>          throw new XMLSignatureException("empty", ex);
>       } catch (XMLSecurityException ex) {
>          throw new XMLSignatureException("empty", ex);
>       }
>    }
> 
>    /**
>     * Method getHTMLRepresentation
>     * @return The HTML of the transformation
>     * @throws XMLSignatureException
>     */
>    public String getHTMLRepresentation() throws XMLSignatureException {
> 
>       try {
>          XMLSignatureInput nodes = this.getNodesetBeforeFirstCanonicalization();
>          Set inclusiveNamespaces = new HashSet();
> 
>          {
>             Transforms transforms = this.getTransforms();
>             Transform c14nTransform = null;
> 
>             if (transforms != null) {
>                doTransforms: for (int i = 0; i < transforms.getLength(); i++) {
>                   Transform t = transforms.item(i);
>                   String URI = t.getURI();
> 
>                   if (URI.equals(Transforms.TRANSFORM_C14N_EXCL_OMIT_COMMENTS)
>                           || URI.equals(
>                              Transforms.TRANSFORM_C14N_EXCL_WITH_COMMENTS)) {
>                      c14nTransform = t;
> 
>                      break doTransforms;
>                   }
>                }
>             }
> 
>             if (c14nTransform != null) {
> 
>                if (c14nTransform
>                        .length(InclusiveNamespaces
>                           .ExclusiveCanonicalizationNamespace, InclusiveNamespaces
>                           ._TAG_EC_INCLUSIVENAMESPACES) == 1) {
> 
>                   // there is one InclusiveNamespaces element
>                   InclusiveNamespaces in = new InclusiveNamespaces(
>                         XMLUtils.selectNode(
>                         c14nTransform.getElement().getFirstChild(),
> 						InclusiveNamespaces.ExclusiveCanonicalizationNamespace, 
>                         InclusiveNamespaces._TAG_EC_INCLUSIVENAMESPACES,0), this.getBaseURI());
> 
>                   inclusiveNamespaces = InclusiveNamespaces.prefixStr2Set(
>                      in.getInclusiveNamespaces());
>                }
>             }
>          }
> 
>          return nodes.getHTMLRepresentation(inclusiveNamespaces);
>       } catch (TransformationException ex) {
>          throw new XMLSignatureException("empty", ex);
>       } catch (InvalidTransformException ex) {
>          throw new XMLSignatureException("empty", ex);
>       } catch (XMLSecurityException ex) {
>          throw new XMLSignatureException("empty", ex);
>       }
>    }
> 
>    /**
>     * This method only works works after a call to verify.
>     * @return 
>     */
>    public XMLSignatureInput getTransformsOutput() {
>       return this._transformsOutput;
>    }
> 
>    /**
>     * This method returns the {@link XMLSignatureInput} which is referenced by the
>     * <CODE>URI</CODE> Attribute.
>     * @param os TODO
>     * @return
>     *
>     * @throws XMLSignatureException
>     * @see Manifest#verifyReferences()
>     */
>    protected XMLSignatureInput dereferenceURIandPerformTransforms(OutputStream os)
>            throws XMLSignatureException {
> 
>       try {
>          XMLSignatureInput input = this.getContentsBeforeTransformation();
>          XMLSignatureInput output = this.getContentsAfterTransformation(input, os);
> 
>          /* at this stage, this._transformsInput and this._transformsOutput
>           * contain a huge amount of nodes. When we do not cache these nodes
>           * but only preserve the octets, the memory footprint is dramatically
>           * reduced.
>           */
>          if (!Reference.CacheSignedNodes) {
> 
>             this._transformsOutput = output;//new XMLSignatureInput(output.getBytes());
> 
>             //this._transformsOutput.setSourceURI(output.getSourceURI());
>          }
>          return output;
506c631
<     * @return
---
>     * @return The transforms that applied this reference.
516,518c641,642
<       Element transformsElement = this.getChildElementLocalName(0,
<                                      Constants.SignatureSpecNS,
<                                      Constants._TAG_TRANSFORMS);
---
>       Element transformsElement = XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>             Constants._TAG_TRANSFORMS,0);
525,527c649,650
<       } else {
<          return null;
<       }
---
>       } 
>        return null;      
532,533c655,656
<     *
<     * @return
---
>     * 
>     * @return the bytes that will be used to generated digest.
538a662,663
>     try {
>         XMLSignatureInput output=this.dereferenceURIandPerformTransforms(null);
540,541c665
<       try {
<          this.dereferenceURIandPerformTransforms();
---
>         byte[] signedBytes = output.getBytes();
543c667,672
<          byte[] signedBytes = this.getTransformsOutput().getBytes();
---
>         return signedBytes;
>      } catch (IOException ex) {
>         throw new ReferenceNotInitializedException("empty", ex);
>      } catch (CanonicalizationException ex) {
>         throw new ReferenceNotInitializedException("empty", ex);
>      } 
545,552d673
<          return signedBytes;
<       } catch (IOException ex) {
<          throw new ReferenceNotInitializedException("empty", ex);
<       } catch (CanonicalizationException ex) {
<          throw new ReferenceNotInitializedException("empty", ex);
<       } catch (InvalidCanonicalizerException ex) {
<          throw new ReferenceNotInitializedException("empty", ex);
<       }
554a676
> 
558c680
<     * @return
---
>     * @return reference Calculate the digest of this reference.
566c688
<          byte[] data = this.getReferencedBytes();
---
>          
570,572c692,698
<          mda.update(data);
< 
<          byte calculatedDigestValue[] = mda.digest();
---
>          DigesterOutputStream diOs=new DigesterOutputStream(mda);
>          OutputStream os=new BufferedOutputStream(diOs);
>          XMLSignatureInput output=this.dereferenceURIandPerformTransforms(os);         
>          output.updateOutputStream(os);
>          os.flush();
>          //this.getReferencedBytes(diOs);
>          //mda.update(data);
574,581c700
<          //J-
<          if (data.length < 20) {
<             cat.debug(new String(data));
<          } else {
<             cat.debug(new String(data).substring(0, 20) + " ...");
<          }
<          //J+
<          return calculatedDigestValue;
---
>          return diOs.getDigestValue();
584c703,705
<       }
---
>       } catch (IOException ex) {
>       	 throw new ReferenceNotInitializedException("empty", ex);
> 	}
587a709,731
>     * Returns the digest value.
>     *
>     * @return the digest value.
>     * @throws Base64DecodingException if Reference contains no proper base64 encoded data.
> 	* @throws XMLSecurityException if the Reference does not contain a DigestValue element
>     */
>    public byte[] getDigestValue() throws Base64DecodingException, XMLSecurityException {
>       Element digestValueElem = XMLUtils.selectDsNode(this._constructionElement.getFirstChild()
>             ,Constants._TAG_DIGESTVALUE,0);
> 	  if (digestValueElem == null) {
> 		  // The required element is not in the XML!
> 		  Object[] exArgs ={ Constants._TAG_DIGESTVALUE, 
> 							 Constants.SignatureSpecNS };
> 		  throw new XMLSecurityException(
> 					"signature.Verification.NoSignatureElement", 
> 					exArgs);
> 	  }
>       byte[] elemDig = Base64.decode(digestValueElem);
>       return elemDig;
>    }
> 
> 
>    /**
597,600c741
<       Element digestValueElem = this.getChildElementLocalName(0,
<                                    Constants.SignatureSpecNS,
<                                    Constants._TAG_DIGESTVALUE);
<       byte[] elemDig = Base64.decode(digestValueElem);
---
>       byte[] elemDig = this.getDigestValue();
605,620c746
<          cat.warn("Verification failed for URI \"" + this.getURI() + "\"");
< 
<          if (cat.isDebugEnabled()) {
<             cat.debug("unverifiedDigestValue= " + Base64.encode(elemDig));
<             cat.debug("calculatedDigestValue= " + Base64.encode(calcDig));
< 
<             /*
<             try {
<                String tmp = new Long(System.currentTimeMillis()).toString()
<                             + ".txt";
< 
<                cat.warn("Wrote \"" + this.getURI() + "\" to file " + tmp);
<                JavaUtils.writeBytesToFilename(tmp, this.getReferencedBytes());
<             } catch (Exception ex) {}
<             */
<          }
---
>          log.warn("Verification failed for URI \"" + this.getURI() + "\"");
622c748
<          cat.info("Verification successful for URI \"" + this.getURI() + "\"");
---
>          log.info("Verification successful for URI \"" + this.getURI() + "\"");
629,646d754
<     * Method getTransformsInput
<     *
<     * @return
<     */
<    public XMLSignatureInput getTransformsInput() {
<       return this._transformsInput;
<    }
< 
<    /**
<     * Method getTransformsOutput
<     *
<     * @return
<     */
<    public XMLSignatureInput getTransformsOutput() {
<       return this._transformsOutput;
<    }
< 
<    /**
647a756
>     * @inheritDoc
649d757
<     * @return
diff -r xml-security-orig-v1/src/org/apache/xml/security/signature/ReferenceNotInitializedException.java xml-security-1_2_0/src/org/apache/xml/security/signature/ReferenceNotInitializedException.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights 
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer. 
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:  
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written 
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European 
<  * Commission in the <WebSig> project in the ISIS Programme. 
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64d21
< import org.apache.xml.security.signature.XMLSignatureException;
86c43
<     * @param msgID
---
>     * @param _msgID
88,89c45,46
<    public ReferenceNotInitializedException(String msgID) {
<       super(msgID);
---
>    public ReferenceNotInitializedException(String _msgID) {
>       super(_msgID);
95c52
<     * @param msgID
---
>     * @param _msgID
98,99c55,56
<    public ReferenceNotInitializedException(String msgID, Object exArgs[]) {
<       super(msgID, exArgs);
---
>    public ReferenceNotInitializedException(String _msgID, Object exArgs[]) {
>       super(_msgID, exArgs);
105,106c62,63
<     * @param msgID
<     * @param originalException
---
>     * @param _msgID
>     * @param _originalException
108,110c65,67
<    public ReferenceNotInitializedException(String msgID,
<                                            Exception originalException) {
<       super(msgID, originalException);
---
>    public ReferenceNotInitializedException(String _msgID,
>                                            Exception _originalException) {
>       super(_msgID, _originalException);
116c73
<     * @param msgID
---
>     * @param _msgID
118c75
<     * @param originalException
---
>     * @param _originalException
120,122c77,79
<    public ReferenceNotInitializedException(String msgID, Object exArgs[],
<                                            Exception originalException) {
<       super(msgID, exArgs, originalException);
---
>    public ReferenceNotInitializedException(String _msgID, Object exArgs[],
>                                            Exception _originalException) {
>       super(_msgID, exArgs, _originalException);
diff -r xml-security-orig-v1/src/org/apache/xml/security/signature/SignatureProperties.java xml-security-1_2_0/src/org/apache/xml/security/signature/SignatureProperties.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,77c21,27
< import java.util.Vector;
< import java.io.IOException;
< import org.w3c.dom.*;
< import org.apache.xml.security.algorithms.SignatureAlgorithm;
< import org.apache.xml.security.c14n.Canonicalizer;
< import org.apache.xml.security.c14n.CanonicalizationException;
< import org.apache.xml.security.signature.MissingResourceFailureException;
< import org.apache.xml.security.exceptions.*;
< import org.apache.xml.security.signature.XMLSignatureException;
< import org.apache.xml.security.signature.Reference;
< import org.apache.xml.security.signature.XMLSignatureInput;
< import org.apache.xml.security.transforms.Transforms;
< import org.apache.xml.security.utils.*;
< import javax.xml.transform.TransformerException;
< import org.apache.xpath.XPathAPI;
---
> import org.apache.xml.security.exceptions.XMLSecurityException;
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.IdResolver;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
91,94c41,43
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category
<          .getInstance(SignatureProperties.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(SignatureProperties.class.getName());
123d71
<     * @throws XMLSignatureException
125c73,78
<    public int getLength() throws XMLSignatureException {
---
>    public int getLength() {
>       
>          Element[] propertyElems =
>             XMLUtils.selectDsNodes(this._constructionElement,
>                                      Constants._TAG_SIGNATUREPROPERTY
>                                     );
127,138c80
<       try {
<          Element nscontext = XMLUtils.createDSctx(this._doc, "ds",
<                                                   Constants.SignatureSpecNS);
<          NodeList propertyElems =
<             XPathAPI.selectNodeList(this._constructionElement,
<                                     "./ds:" + Constants._TAG_SIGNATUREPROPERTY,
<                                     nscontext);
< 
<          return propertyElems.getLength();
<       } catch (TransformerException ex) {
<          throw new XMLSignatureException("empty", ex);
<       }
---
>          return propertyElems.length;
150,153c92
< 
<       try {
<          Element nscontext = XMLUtils.createDSctx(this._doc, "ds",
<                                                   Constants.SignatureSpecNS);
---
>    	  try {
155,158c94,96
<             (Element) XPathAPI
<                .selectSingleNode(this._constructionElement, "./ds:"
<                                  + Constants._TAG_SIGNATUREPROPERTY + "["
<                                  + (i + 1) + "]", nscontext);
---
>             XMLUtils.selectDsNode(this._constructionElement, 
>                                  Constants._TAG_SIGNATUREPROPERTY, 
>                                  i );
162,166c100,101
<          } else {
<             return new SignatureProperty(propertyElem, this._baseURI);
<          }
<       } catch (TransformerException ex) {
<          throw new XMLSignatureException("empty", ex);
---
>          } 
>          return new SignatureProperty(propertyElem, this._baseURI);               
203a139
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/signature/SignatureProperty.java xml-security-1_2_0/src/org/apache/xml/security/signature/SignatureProperty.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
61,73c19
< 
< 
< import java.io.IOException;
< import org.w3c.dom.*;
< import org.apache.xml.security.algorithms.SignatureAlgorithm;
< import org.apache.xml.security.c14n.Canonicalizer;
< import org.apache.xml.security.c14n.CanonicalizationException;
< import org.apache.xml.security.signature.MissingResourceFailureException;
< import org.apache.xml.security.exceptions.*;
< import org.apache.xml.security.signature.XMLSignatureException;
< import org.apache.xml.security.signature.Reference;
< import org.apache.xml.security.signature.XMLSignatureInput;
< import org.apache.xml.security.transforms.Transforms;
---
> import org.apache.xml.security.exceptions.XMLSecurityException;
75,77c21,25
< import org.apache.xml.security.utils.XMLUtils;
< import org.apache.xml.security.utils.*;
< 
---
> import org.apache.xml.security.utils.IdResolver;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.Node;
88,90c36,39
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(SignatureProperty.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(
>                             SignatureProperty.class.getName());
97d45
<     * @throws XMLSignatureException
99,100c47
<    public SignatureProperty(Document doc, String Target)
<            throws XMLSignatureException {
---
>    public SignatureProperty(Document doc, String Target) {
109,110c56
<     * @param Id the <code>Id</code> will be specified by {@link Reference#ReferenceURI} in validation
<     * @throws XMLSignatureException
---
>     * @param Id the <code>Id</code> will be specified by {@link Reference#getURI} in validation
112,113c58
<    public SignatureProperty(Document doc, String Target, String Id)
<            throws XMLSignatureException {
---
>    public SignatureProperty(Document doc, String Target, String Id) {
184a130
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/signature/SignedInfo.java xml-security-1_2_0/src/org/apache/xml/security/signature/SignedInfo.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,6
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
5,6c8
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
---
>  *      http://www.apache.org/licenses/LICENSE-2.0
8,10c10,14
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
---
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
12,57d15
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
65,66c23,24
< import java.util.Collection;
< import java.util.Vector;
---
> import java.io.OutputStream;
> 
70,79c28,38
< import javax.xml.transform.TransformerException;
< import org.apache.xml.security.algorithms.*;
< import org.apache.xml.security.c14n.*;
< import org.apache.xml.security.transforms.params.XPathContainer;
< import org.apache.xml.security.exceptions.*;
< import org.apache.xml.security.transforms.*;
< import org.apache.xml.security.utils.*;
< import org.apache.xml.security.utils.resolver.*;
< import org.apache.xpath.XPathAPI;
< import org.w3c.dom.*;
---
> 
> import org.apache.xml.security.algorithms.SignatureAlgorithm;
> import org.apache.xml.security.c14n.CanonicalizationException;
> import org.apache.xml.security.c14n.Canonicalizer;
> import org.apache.xml.security.c14n.InvalidCanonicalizerException;
> import org.apache.xml.security.exceptions.XMLSecurityException;
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.Node;
98c57
<     * Overwrites {@link Manifest(org.w3c.dom.Document)} because it creates another Element.
---
>     * Overwrites {@link Manifest#addDocument} because it creates another Element.
104,105c63
<       this(doc, Canonicalizer.ALGO_ID_C14N_OMIT_COMMENTS,
<            XMLSignature.ALGO_ID_SIGNATURE_DSA);
---
>       this(doc, XMLSignature.ALGO_ID_SIGNATURE_DSA, Canonicalizer.ALGO_ID_C14N_OMIT_COMMENTS);
117c75
<            Document doc, String CanonicalizationMethodURI, String SignatureMethodURI)
---
>            Document doc, String SignatureMethodURI, String CanonicalizationMethodURI)
119c77
<       this(doc, CanonicalizationMethodURI, SignatureMethodURI, 0);
---
>       this(doc, SignatureMethodURI, 0, CanonicalizationMethodURI);
132c90
<            Document doc, String CanonicalizationMethodURI, String SignatureMethodURI, int HMACOutputLength)
---
>            Document doc, String SignatureMethodURI, int HMACOutputLength, String CanonicalizationMethodURI)
160a119,140
>    
>    /**
>     * @param doc
>     * @param SignatureMethodElem
>     * @param CanonicalizationMethodElem
>     * @throws XMLSecurityException
>     */
>    public SignedInfo(
>            Document doc, Element SignatureMethodElem, Element CanonicalizationMethodElem)
>               throws XMLSecurityException {
> 
>       super(doc);
> 
>       this._constructionElement.appendChild(CanonicalizationMethodElem);
>       XMLUtils.addReturnToElement(this._constructionElement);
> 
>       this._signatureAlgorithm = new SignatureAlgorithm(SignatureMethodElem, null);
> 
>       this._constructionElement
>          .appendChild(this._signatureAlgorithm.getElement());
>       XMLUtils.addReturnToElement(this._constructionElement);
>    }
180a161,166
>       String c14nMethodURI=this.getCanonicalizationMethodURI();
>      if (!(c14nMethodURI.equals("http://www.w3.org/TR/2001/REC-xml-c14n-20010315") ||
>       		c14nMethodURI.equals("http://www.w3.org/TR/2001/REC-xml-c14n-20010315#WithComments") ||
> 			c14nMethodURI.equals("http://www.w3.org/2001/10/xml-exc-c14n#") ||
> 			c14nMethodURI.equals("http://www.w3.org/2001/10/xml-exc-c14n#WithComments"))) {
>       	//The c14n is not a secure one and can rewrite the URIs or like that reparse the SignedInfo to be sure    
187d172
< 
193c178
<          javax.xml.parsers.DocumentBuilder db = dbf.newDocumentBuilder();
---
>          javax.xml.parsers.DocumentBuilder db = dbf.newDocumentBuilder();        
210c195
< 
---
>       }
246d230
<     * @throws IOException
252c236
<                   IOException, XMLSecurityException {
---
>                  XMLSecurityException {
255c239
<               && (this._state == ElementProxy.MODE_SIGN)) {
---
>               /*&& (this._state == ElementProxy.MODE_SIGN)*/) {
269a254,278
>    
>    /**
>     *  Output the C14n stream to the give outputstream.
>     * @param os
>     * @throws CanonicalizationException
>     * @throws InvalidCanonicalizerException
>     * @throws XMLSecurityException
>     */
>    public void signInOctectStream(OutputStream os)            
>        throws CanonicalizationException, InvalidCanonicalizerException,
> 	   XMLSecurityException {
> 
>    	if ((this._c14nizedBytes == null)) {
>        Canonicalizer c14nizer =
>           Canonicalizer.getInstance(this.getCanonicalizationMethodURI());
>        c14nizer.setWriter(os);       
>        c14nizer.canonicalizeSubtree(this._constructionElement);
>     } else {
>         try {
> 			os.write(this._c14nizedBytes);
> 		} catch (IOException e) {
> 			throw new RuntimeException(""+e);
> 		}  
>     }    
>    }
278,299c287,292
<       NodeList children = this._constructionElement.getChildNodes();
< 
<       for (int i = 0; i < children.getLength(); i++) {
<          Node n = children.item(i);
< 
<          if (n.getNodeType() == Node.ELEMENT_NODE) {
<             boolean found = true;
< 
<             try {
<                XMLUtils.guaranteeThatElementInSignatureSpace((Element) n,
<                        Constants._TAG_CANONICALIZATIONMETHOD);
<             } catch (XMLSecurityException ex) {
<                found = false;
<             }
< 
<             if (found) {
<                return ((Element) n).getAttributeNS(null, Constants._ATT_ALGORITHM);
<             }
<          }
<       }
< 
<       return null;
---
>     Element el= XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>      Constants._TAG_CANONICALIZATIONMETHOD,0);
>      if (el==null) {
>      	return null;
>      }
>      return el.getAttributeNS(null, Constants._ATT_ALGORITHM);    
319a313
>     * @return gets The SignatureMethod Node.   
321d314
<     * @return
324,348c317,318
< 
<       NodeList children = this._constructionElement.getChildNodes();
< 
<       for (int i = 0; i < children.getLength(); i++) {
<          Node n = children.item(i);
< 
<          cat.debug("Looking for SignatureMethodURI in " + n);
< 
<          if (n.getNodeType() == Node.ELEMENT_NODE) {
<             boolean found = true;
< 
<             try {
<                XMLUtils.guaranteeThatElementInSignatureSpace((Element) n,
<                        Constants._TAG_SIGNATUREMETHOD);
<             } catch (XMLSecurityException ex) {
<                found = false;
<             }
< 
<             if (found) {
<                return (Element) n;
<             }
<          }
<       }
< 
<       return null;
---
>       return XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>         Constants._TAG_SIGNATUREMETHOD,0);
356,357c326
<     * @return
<     * @throws XMLSecurityException
---
>     * @return the secret key for the SignedInfo element.
360c329
<            throws XMLSecurityException {
---
>    {
368a338
>     * @inheritDoc
370d339
<     * @return
diff -r xml-security-orig-v1/src/org/apache/xml/security/signature/XMLSignatureException.java xml-security-1_2_0/src/org/apache/xml/security/signature/XMLSignatureException.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights 
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer. 
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:  
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written 
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European 
<  * Commission in the <WebSig> project in the ISIS Programme. 
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
71c29
<  * @author: Christian Geuer-Pollmann
---
>  * @author Christian Geuer-Pollmann
86c44
<     * @param msgID
---
>     * @param _msgID
88,89c46,47
<    public XMLSignatureException(String msgID) {
<       super(msgID);
---
>    public XMLSignatureException(String _msgID) {
>       super(_msgID);
95c53
<     * @param msgID
---
>     * @param _msgID
98,99c56,57
<    public XMLSignatureException(String msgID, Object exArgs[]) {
<       super(msgID, exArgs);
---
>    public XMLSignatureException(String _msgID, Object exArgs[]) {
>       super(_msgID, exArgs);
105,106c63,64
<     * @param msgID
<     * @param originalException
---
>     * @param _msgID
>     * @param _originalException
108,109c66,67
<    public XMLSignatureException(String msgID, Exception originalException) {
<       super(msgID, originalException);
---
>    public XMLSignatureException(String _msgID, Exception _originalException) {
>       super(_msgID, _originalException);
115c73
<     * @param msgID
---
>     * @param _msgID
117c75
<     * @param originalException
---
>     * @param _originalException
119,121c77,79
<    public XMLSignatureException(String msgID, Object exArgs[],
<                                 Exception originalException) {
<       super(msgID, exArgs, originalException);
---
>    public XMLSignatureException(String _msgID, Object exArgs[],
>                                 Exception _originalException) {
>       super(_msgID, exArgs, _originalException);
diff -r xml-security-orig-v1/src/org/apache/xml/security/signature/XMLSignatureInput.java xml-security-1_2_0/src/org/apache/xml/security/signature/XMLSignatureInput.java
0a1
> 
2,10c3
<  * The Apache Software License, Version 1.1
<  *
<  *
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
---
>  * Copyright  1999-2004 The Apache Software Foundation.
12,13c5,7
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
---
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
15,18c9
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
---
>  *      http://www.apache.org/licenses/LICENSE-2.0
20,25c11,15
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
---
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
27,57d16
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,70d21
< import java.io.File;
< import java.io.InputStream;
< import java.io.FileInputStream;
< import java.io.Reader;
< import java.io.StringReader;
< import java.io.FileNotFoundException;
< import java.io.IOException;
< import java.io.ByteArrayOutputStream;
71a23,27
> import java.io.ByteArrayOutputStream;
> import java.io.IOException;
> import java.io.InputStream;
> import java.io.OutputStream;
> import java.io.StringWriter;
73,83c29,35
< import java.util.*;
< import org.w3c.dom.*;
< import org.xml.sax.InputSource;
< import javax.xml.parsers.*;
< import org.apache.xml.security.utils.Constants;
< import org.apache.xml.security.exceptions.XMLSecurityException;
< import org.apache.xml.security.c14n.*;
< import org.apache.xml.security.c14n.implementations.*;
< import org.apache.xml.security.utils.XMLUtils;
< import org.apache.xml.security.utils.JavaUtils;
< import org.apache.xml.security.utils.HelperNodeList;
---
> import java.io.Writer;
> import java.util.Arrays;
> import java.util.HashSet;
> import java.util.Set;
> 
> import javax.xml.parsers.DocumentBuilder;
> import javax.xml.parsers.DocumentBuilderFactory;
86c38,52
< import java.io.IOException;
---
> 
> import org.apache.xml.security.c14n.CanonicalizationException;
> import org.apache.xml.security.c14n.helper.AttrCompare;
> import org.apache.xml.security.c14n.implementations.Canonicalizer20010315OmitComments;
> import org.apache.xml.security.utils.CachedXPathAPIHolder;
> import org.apache.xml.security.utils.JavaUtils;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Attr;
> import org.w3c.dom.Comment;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.NamedNodeMap;
> import org.w3c.dom.Node;
> import org.w3c.dom.NodeList;
> import org.w3c.dom.ProcessingInstruction;
88,89d53
< import org.apache.xpath.CachedXPathAPI;
< import org.apache.xpath.XPathContext;
96c60
<  * @todo check whether an XMLSignatureInput can be _both_, octet stream _and_ node set?
---
>  * $todo$ check whether an XMLSignatureInput can be _both_, octet stream _and_ node set?
98a63,272
>     /*
>      * The XMLSignature Input can be either:
>      *   A byteArray like with/or without InputStream.
>      *   Or a  nodeSet like defined either:
>      *                     * as a collection of nodes
>      *                     * or as subnode excluding or not commets and excluding or
>      *                            not other nodes.
>      */
>     /**
>      * Some InputStreams do not support the {@link java.io.InputStream#reset}
>      * method, so we read it in completely and work on our Proxy.
>      */
>     InputStream _inputOctetStreamProxy = null;
>     /**
>      * The original NodeSet for this XMLSignatureInput
>      */
>     Set _inputNodeSet = null;
>     /**
>      * The original Element
>      */
>     Node _subNode=null;
>     /**
>      * Exclude Node *for enveloped transformations*
>      */
>     Node excludeNode=null;
>     /**
>      * 
>      */
>     boolean excludeComments=false;
>     /**
>      * A cached bytes
>      */
>     byte []bytes=null;
> 
>     /**
>      * Some Transforms may require explicit MIME type, charset (IANA registered "character set"), or other such information concerning the data they are receiving from an earlier Transform or the source data, although no Transform algorithm specified in this document needs such explicit information. Such data characteristics are provided as parameters to the Transform algorithm and should be described in the specification for the algorithm.
>      */
>     private String _MIMEType = null;
> 
>     /**
>      * Field _SourceURI
>      */
>     private String _SourceURI = null;
> 
>     /** Field _cxpathAPI */
>     CachedXPathAPIHolder _cxpathAPI=null;
> 
>     OutputStream outputStream=null;
> 
>     /**
>      * Construct a XMLSignatureInput from an octet array.
>      * <p>
>      * This is a comfort method, which internally converts the byte[] array into an InputStream
>      * <p>NOTE: no defensive copy</p>
>      * @param inputOctets an octet array which including XML document or node
>      */
>     public XMLSignatureInput(byte[] inputOctets) {
> 
>         // NO  defensive copy
> 
>         //this._inputOctetStreamProxy = new ByteArrayInputStream(inputOctets);
>         this.bytes=inputOctets;
>     }
> 
> 
>     /**
>      * Constructs a <code>XMLSignatureInput</code> from an octet stream. The
>      * stream is directly read.
>      *
>      * @param inputOctetStream
>      */
>     public XMLSignatureInput(InputStream inputOctetStream)  {
>         this._inputOctetStreamProxy=inputOctetStream;
>         //this(JavaUtils.getBytesFromStream(inputOctetStream));
> 
>     }
> 
>     /**
>      * Construct a XMLSignatureInput from a String.
>      * <p>
>      * This is a comfort method, which internally converts the String into a byte[] array using the {@link java.lang.String#getBytes()} method.
>      * @deprecated
>      * @param inputStr the input String which including XML document or node
>      */
>     @Deprecated
>     public XMLSignatureInput(String inputStr) {
>         this(inputStr.getBytes());
>     }
> 
>     /**
>      * Construct a XMLSignatureInput from a String with a given encoding.
>      * <p>
>      * This is a comfort method, which internally converts the String into a byte[] array using the {@link java.lang.String#getBytes()} method.
>      *
>      * @deprecated
>      * @param inputStr the input String with encoding <code>encoding</code>
>      * @param encoding the encoding of <code>inputStr</code>
>      * @throws UnsupportedEncodingException
>      */
>     @Deprecated
>     public XMLSignatureInput(String inputStr, String encoding)
>             throws UnsupportedEncodingException {
>         this(inputStr.getBytes(encoding));
>     }
> 
>     /**
>      * Construct a XMLSignatureInput from a subtree rooted by rootNode. This
>      * method included the node and <I>all</I> his descendants in the output.
>      *
>      * @param rootNode
>      * @param usedXPathAPI
>      */
>     public XMLSignatureInput(Node rootNode, CachedXPathAPIHolder usedXPathAPI)
>     {
>         this._cxpathAPI = usedXPathAPI;
>         this._subNode = rootNode;
>     }
> 
>     /**
>      * Construct a XMLSignatureInput from a subtree rooted by rootNode. This method included the node
>      * and <I>all</I> his descendants in the output.
>      *
>      * @param rootNode
>      */
>     public XMLSignatureInput(Node rootNode)  {
>         this(rootNode, null);
>     }
> 
>     /**
>      * Constructor XMLSignatureInput
>      *
>      * @param inputNodeSet
>      * @param usedXPathAPI
>      */
>     public XMLSignatureInput(Set inputNodeSet, CachedXPathAPIHolder usedXPathAPI) {
>         this._inputNodeSet = inputNodeSet;
>         this._cxpathAPI = usedXPathAPI;
>     }
> 
>     /**
>      * Constructor XMLSignatureInput
>      *
>      * @param inputNodeSet
>      */
>     public XMLSignatureInput(Set inputNodeSet) {
>         this(inputNodeSet, null);
>     }
> 
>     /**
>      * Constructor XMLSignatureInput
>      *
>      * @param inputNodeSet
>      * @deprecated Use {@link Set}s instead of {@link NodeList}s.
>      */
>     @Deprecated
>     public XMLSignatureInput(NodeList inputNodeSet) {
>         this(XMLUtils.convertNodelistToSet(inputNodeSet), null);
>     }
> 
>     /**
>      * Constructor XMLSignatureInput
>      *
>      * @param inputNodeSet
>      * @param usedXPathAPI
>      * @deprecated Use {@link Set}s instead of {@link NodeList}s.
>      */
>     @Deprecated
>     public XMLSignatureInput(NodeList inputNodeSet,
>             CachedXPathAPIHolder usedXPathAPI) {
>         this(XMLUtils.convertNodelistToSet(inputNodeSet), usedXPathAPI);
>     }
> 
> 
>     /**
>      * Returns the node set from input which was specified as the parameter of {@link XMLSignatureInput} constructor
>      *
>      * @return the node set
>      * @throws SAXException
>      * @throws IOException
>      * @throws ParserConfigurationException
>      * @throws CanonicalizationException
>      * @throws CanonicalizationException
>      * @throws IOException
>      * @throws ParserConfigurationException
>      * @throws SAXException
>      */
>     public Set getNodeSet() throws CanonicalizationException, ParserConfigurationException, IOException, SAXException {
>         return getNodeSet(false);
>     }
>     /**
>      * Returns the node set from input which was specified as the parameter of {@link XMLSignatureInput} constructor
>      * @param circunvent
>      *
>      * @return the node set
>      * @throws SAXException
>      * @throws IOException
>      * @throws ParserConfigurationException
>      * @throws CanonicalizationException
>      * @throws CanonicalizationException
>      * @throws IOException
>      * @throws ParserConfigurationException
>      * @throws SAXException
>      */
>     public Set getNodeSet(boolean circunvent)
>             throws ParserConfigurationException, IOException, SAXException,
>             CanonicalizationException {
>         if (this._inputNodeSet!=null) {
>             return this._inputNodeSet;
>         }
>         if (this.isElement()) {
100,251c274,278
<    /**
<     * Some InputStreams do not support the {@link java.io.InputStream#reset}
<     * method, so we read it in completely and work on our Proxy.
<     */
<    InputStream _inputOctetStreamProxy = null;
< 
<    /**
<     * The original NodeSet for this XMLSignatureInput
<     */
<    Set _inputNodeSet = null;
< 
<    /** Field _cxpathAPI */
<    CachedXPathAPI _cxpathAPI;
< 
<    /**
<     * Construct a XMLSignatureInput from an octet array.
<     * <p>
<     * This is a comfort method, which internally converts the byte[] array into an InputStream
<     *
<     * @param inputOctets an octet array which including XML document or node
<     */
<    public XMLSignatureInput(byte[] inputOctets) {
< 
<       // defensive copy
<       byte[] copy = new byte[inputOctets.length];
< 
<       System.arraycopy(inputOctets, 0, copy, 0, inputOctets.length);
< 
<       this._inputOctetStreamProxy = new ByteArrayInputStream(copy);
<       this._cxpathAPI = new CachedXPathAPI();
<    }
< 
<    /**
<     * Constructs a <code>XMLSignatureInput</code> from an octet stream. The
<     * stream is directly read.
<     *
<     * @param inputOctetStream
<     * @throws IOException
<     */
<    public XMLSignatureInput(InputStream inputOctetStream) throws IOException {
< 
<       this(JavaUtils.getBytesFromStream(inputOctetStream));
< 
<       inputOctetStream = null;    // free object reference
<    }
< 
<    /**
<     * Construct a XMLSignatureInput from a String.
<     * <p>
<     * This is a comfort method, which internally converts the String into a byte[] array using the {@link java.lang.String#getBytes} method.
<     *
<     * @param inputStr the input String which including XML document or node
<     */
<    public XMLSignatureInput(String inputStr) {
<       this(inputStr.getBytes());
<    }
< 
<    /**
<     * Construct a XMLSignatureInput from a String with a given encoding.
<     * <p>
<     * This is a comfort method, which internally converts the String into a byte[] array using the {@link java.lang.String#getBytes} method.
<     *
<     * @param inputStr the input String with encoding <code>encoding</code>
<     * @param encoding the encoding of <code>inputStr</code>
<     * @throws UnsupportedEncodingException
<     */
<    public XMLSignatureInput(String inputStr, String encoding)
<            throws UnsupportedEncodingException {
<       this(inputStr.getBytes(encoding));
<    }
< 
<    /**
<     * Construct a XMLSignatureInput from a subtree rooted by rootNode. This
<     * method included the node and <I>all</I> his descendants in the output.
<     *
<     * @param rootNode
<     * @param usedXPathAPI
<     * @throws TransformerException
<     */
<    public XMLSignatureInput(Node rootNode, CachedXPathAPI usedXPathAPI)
<            throws TransformerException {
< 
<       this._cxpathAPI = usedXPathAPI;
< 
<       // get the Document and make all namespace nodes visible in DOM space
<       Document doc = XMLUtils.getOwnerDocument(rootNode);
<       XMLUtils.circumventBug2650(doc);
< 
<       NodeList result = this._cxpathAPI.selectNodeList(rootNode,
<                            Canonicalizer.XPATH_C14N_WITH_COMMENTS_SINGLE_NODE);
< 
<       this._inputNodeSet = XMLUtils.convertNodelistToSet(result);
<    }
< 
<    /**
<     * Construct a XMLSignatureInput from a subtree rooted by rootNode. This method included the node
<     * and <I>all</I> his descendants in the output.
<     *
<     * @param rootNode
<     * @throws TransformerException
<     */
<    public XMLSignatureInput(Node rootNode) throws TransformerException {
<       this(rootNode, new CachedXPathAPI());
<    }
< 
<    /**
<     * Constructor XMLSignatureInput
<     *
<     * @param inputNodeSet
<     * @param usedXPathAPI
<     */
<    public XMLSignatureInput(Set inputNodeSet, CachedXPathAPI usedXPathAPI) {
<       this._inputNodeSet = inputNodeSet;
<       this._cxpathAPI = usedXPathAPI;
<    }
< 
<    /**
<     * Constructor XMLSignatureInput
<     *
<     * @param inputNodeSet
<     */
<    public XMLSignatureInput(Set inputNodeSet) {
<       this(inputNodeSet, new CachedXPathAPI());
<    }
< 
<    /**
<     * Returns the node set from input which was specified as the parameter of {@link XMLSignatureInput} constructor
<     *
<     * @return the node set
<     * @throws CanonicalizationException
<     * @throws IOException
<     * @throws InvalidCanonicalizerException
<     * @throws ParserConfigurationException
<     * @throws SAXException
<     */
<    public Set getNodeSet()
<            throws ParserConfigurationException, IOException, SAXException,
<                   CanonicalizationException, InvalidCanonicalizerException {
< 
<       if (this.isNodeSet()) {
<          return this._inputNodeSet;
<       } else if (this.isOctetStream()) {
<          DocumentBuilderFactory dfactory = DocumentBuilderFactory.newInstance();
< 
<          dfactory.setValidating(false);
<          dfactory.setNamespaceAware(true);
< 
<          DocumentBuilder db = dfactory.newDocumentBuilder();
< 
<          try {
<             db.setErrorHandler(new org.apache.xml.security.utils
<                .IgnoreAllErrorHandler());
---
>             if (circunvent) {
>                 XMLUtils.circumventBug2650(XMLUtils.getOwnerDocument(_subNode));
>             }
>             this._inputNodeSet = new HashSet();
>             XMLUtils.getSet(_subNode,this._inputNodeSet, excludeNode, this.excludeComments);
253c280,290
<             Document doc = db.parse(this.getOctetStream());
---
>             return this._inputNodeSet;
>         }
>         else if (this.isOctetStream()) {
>             DocumentBuilderFactory dfactory = DocumentBuilderFactory.newInstance();
>             dfactory.setValidating(false);
>             dfactory.setNamespaceAware(true);
>             DocumentBuilder db = dfactory.newDocumentBuilder();
>             // select all nodes, also the comments.
>             try {
>                 db.setErrorHandler(new org.apache.xml.security.utils
>                         .IgnoreAllErrorHandler());
255c292
<             XMLUtils.circumventBug2650(doc);
---
>                 Document doc = db.parse(this.getOctetStream());
257,278c294,323
<             // select all nodes, also the comments.
<             NodeList nodeList =
<                this._cxpathAPI
<                   .selectNodeList(doc,
<                                   Canonicalizer
<                                      .XPATH_C14N_WITH_COMMENTS_SINGLE_NODE);
< 
<             return XMLUtils.convertNodelistToSet(nodeList);
<          } catch (TransformerException ex) {
<             throw new CanonicalizationException("generic.EmptyMessage", ex);
<          } catch (SAXException ex) {
< 
<             // if a not-wellformed nodeset exists, put a container around it...
<             ByteArrayOutputStream baos = new ByteArrayOutputStream();
< 
<             baos.write("<container>".getBytes());
<             baos.write(this.getBytes());
<             baos.write("</container>".getBytes());
< 
<             byte result[] = baos.toByteArray();
<             Document document = db.parse(new ByteArrayInputStream(result));
<             XMLUtils.circumventBug2650(document);
---
>                 XMLUtils.circumventBug2650(doc);
>                 HashSet result=new HashSet();
>                 XMLUtils.getSet(doc.getDocumentElement(), result,null,false);
>                 //this._inputNodeSet=result;
>                 return result;
>             } catch (SAXException ex) {
> 
>                 // if a not-wellformed nodeset exists, put a container around it...
>                 ByteArrayOutputStream baos = new ByteArrayOutputStream();
> 
>                 baos.write("<container>".getBytes());
>                 baos.write(this.getBytes());
>                 baos.write("</container>".getBytes());
> 
>                 byte result[] = baos.toByteArray();
>                 Document document = db.parse(new ByteArrayInputStream(result));
> 
>                 //XMLUtils.circumventBug2650(document);
> 
>                 try {
>                     NodeList nodeList = this._cxpathAPI.getCachedXPathAPI().selectNodeList(
>                             document,
>                             "(//. | //@* | //namespace::*)[not(self::node()=/) and not(self::node=/container)]");
> 
>                     return XMLUtils.convertNodelistToSet(nodeList);
>                 } catch (TransformerException ex2) {
>                     throw new CanonicalizationException("generic.EmptyMessage", ex2);
>                 }
>             }
>         }
280,476c325,378
<             try {
<                NodeList nodeList = this._cxpathAPI.selectNodeList(
<                   document,
<                   "(//. | //@* | //namespace::*)[not(self::node()=/) and not(self::node=/container)]");
< 
<                return XMLUtils.convertNodelistToSet(nodeList);
<             } catch (TransformerException ex2) {
<                throw new CanonicalizationException("generic.EmptyMessage", ex2);
<             }
<          }
<       }
< 
<       throw new RuntimeException(
<          "getNodeSet() called but no input data present");
<    }
< 
<    /**
<     * Returns the Octect stream(byte Stream) from input which was specified as the parameter of {@link XMLSignatureInput} constructor
<     *
<     * @return the Octect stream(byte Stream) from input which was specified as the parameter of {@link XMLSignatureInput} constructor
<     * @throws CanonicalizationException
<     * @throws IOException
<     * @throws InvalidCanonicalizerException
<     */
<    public InputStream getOctetStream()
<            throws IOException, CanonicalizationException,
<                   InvalidCanonicalizerException {
< 
<       if (this.isOctetStream()) {
<          this._inputOctetStreamProxy.reset();
< 
<          return this._inputOctetStreamProxy;
<       } else if (this.isNodeSet()) {
< 
<          /* If we have a node set but an octet stream is needed, we MUST c14nize
<           * without any comments.
<           *
<           * We don't use the factory because direct instantiation should be a
<           * little bit faster...
<           */
<          Canonicalizer20010315OmitComments c14nizer =
<             new Canonicalizer20010315OmitComments();
<          ByteArrayOutputStream baos = new ByteArrayOutputStream();
< 
<          if (this._inputNodeSet.size() == 0) {
< 
<             // empty nodeset
<             return new ByteArrayInputStream(baos.toByteArray());
<          }
< 
<          try {
<             Set nodes = this.getNodeSet();
<             byte bytes[] = c14nizer.engineCanonicalizeXPathNodeSet(nodes);
< 
<             baos.write(bytes);
< 
<             /** @todo Clarify behavior. If isNodeSet() and we getOctetStream, do we have to this._inputOctetStream=xxx ? */
< 
<             /*
<             this._inputOctetStream = new ByteArrayInputStream(baos.toByteArray());
<             this._inputNodeSet = null;
<             return this._inputOctetStream;
<             */
<             return new ByteArrayInputStream(baos.toByteArray());
<          } catch (SAXException ex) {
<             throw new CanonicalizationException("empty", ex);
<          } catch (ParserConfigurationException ex) {
<             throw new CanonicalizationException("empty", ex);
<          }
<       }
< 
<       throw new RuntimeException(
<          "getOctetStream() called but no input data present");
<    }
< 
<    /**
<     * Returns the byte array from input which was specified as the parameter of {@link XMLSignatureInput} constructor
<     *
<     * @return the byte[] from input which was specified as the parameter of {@link XMLSignatureInput} constructor
<     *
<     * @throws CanonicalizationException
<     * @throws IOException
<     * @throws InvalidCanonicalizerException
<     */
<    public byte[] getBytes()
<            throws IOException, CanonicalizationException,
<                   InvalidCanonicalizerException {
< 
<       InputStream is = this.getOctetStream();
<       int available = is.available();
<       byte[] data = new byte[available];
< 
<       is.read(data);
< 
<       if (available != data.length) {
<          throw new IOException("Not enough bytes read");
<       }
< 
<       return data;
<    }
< 
<    /**
<     * Determines if the object has been set up with a Node set
<     *
<     * @return true is the object has been set up with a Node set
<     */
<    public boolean isNodeSet() {
<       return ((this._inputOctetStreamProxy == null)
<               && (this._inputNodeSet != null));
<    }
< 
<    /**
<     * Determines if the object has been set up with an octet stream
<     *
<     * @return true is the object has been set up with an octet stream
<     */
<    public boolean isOctetStream() {
<       return ((this._inputOctetStreamProxy != null)
<               && (this._inputNodeSet == null));
<    }
< 
<    /**
<     * Is the object correctly set up?
<     *
<     * @return true if the object has been set up correctly
<     */
<    public boolean isInitialized() {
<       return (this.isOctetStream() || this.isNodeSet());
<    }
< 
<    /**
<     * Some Transforms may require explicit MIME type, charset (IANA registered
<     * "character set"), or other such information concerning the data they
<     * are receiving from an earlier Transform or the source data, although no
<     * Transform algorithm specified in this document needs such explicit
<     * information. Such data characteristics are provided as parameters to the
<     * Transform algorithm and should be described in the specification for the
<     * algorithm.
<     */
<    private String _MIMEType = null;
< 
<    /**
<     * Returns MIMEType
<     *
<     * @return MIMEType
<     */
<    public String getMIMEType() {
<       return this._MIMEType;
<    }
< 
<    /**
<     * Sets MIMEType
<     *
<     * @param MIMEType
<     */
<    public void setMIMEType(String MIMEType) {
<       this._MIMEType = MIMEType;
<    }
< 
<    /** Field _SourceURI */
<    private String _SourceURI = null;
< 
<    /**
<     * Return SourceURI
<     *
<     * @return SourceURI
<     */
<    public String getSourceURI() {
<       return this._SourceURI;
<    }
< 
<    /**
<     * Sets SourceURI
<     *
<     * @param SourceURI
<     */
<    public void setSourceURI(String SourceURI) {
<       this._SourceURI = SourceURI;
<    }
< 
<    /**
<     * This method gives access to an {@link org.apache.xpath.CachedXPathAPI}
<     * object which was used for creating the internal node set and which MUST be
<     * used for subsequent operations on this node set.
<     *
<     * @return an existing {@link org.apache.xpath.CachedXPathAPI}
<     */
<    public CachedXPathAPI getCachedXPathAPI() {
<       return this._cxpathAPI;
<    }
< 
<    /**
<     * Method toString
<     *
<     * @return
<     */
<    public String toString() {
---
>         throw new RuntimeException(
>                 "getNodeSet() called but no input data present");
>     }
> 
>     /**
>      * Returns the Octect stream(byte Stream) from input which was specified as the parameter of {@link XMLSignatureInput} constructor
>      *
>      * @return the Octect stream(byte Stream) from input which was specified as the parameter of {@link XMLSignatureInput} constructor
>      * @throws CanonicalizationException
>      * @throws IOException
>      */
>     public InputStream getOctetStream()
>             throws IOException, CanonicalizationException {
> 
>         InputStream is = this._inputOctetStreamProxy;
>         if (is!=null) {
>             if (is.markSupported()) {
>                 is.reset();
>                 return is;
>             }
>             bytes=JavaUtils.getBytesFromStream(is);
>         }
>         return _inputOctetStreamProxy=new ByteArrayInputStream(getBytes());
> 
>     }
>     /**
>      * @return
>      */
>     public InputStream getOctetStreamReal () {
>         return this._inputOctetStreamProxy;
>     }
>     /**
>      * Returns the byte array from input which was specified as the parameter of {@link XMLSignatureInput} constructor
>      *
>      * @return the byte[] from input which was specified as the parameter of {@link XMLSignatureInput} constructor
>      *
>      * @throws CanonicalizationException
>      * @throws IOException
>      */
>     public byte[] getBytes()
>             throws IOException, CanonicalizationException {
>         if (bytes!=null) {
>             return bytes;
>         }
>         InputStream is = this._inputOctetStreamProxy;
>         if (is!=null) {
>             //is.reset();
>             if (is.markSupported()) {
>                 is.reset();
>                 bytes=JavaUtils.getBytesFromStream(is);
>             } else {
>                 bytes=JavaUtils.getBytesFromStream(is);
>                 _inputOctetStreamProxy=new ByteArrayInputStream(bytes);
>             }
478,479c380,513
<       if (this.isNodeSet()) {
<          try {
---
>             return bytes;
>         } else if (this.isElement()) {
>             Canonicalizer20010315OmitComments c14nizer =
>                     new Canonicalizer20010315OmitComments();
>             bytes=c14nizer.engineCanonicalizeSubTree(this._subNode,this.excludeNode);
>             return bytes;
>         } else if (this.isNodeSet()) {
>             /* If we have a node set but an octet stream is needed, we MUST c14nize
>              * without any comments.
>              *
>              * We don't use the factory because direct instantiation should be a
>              * little bit faster...
>              */
>             Canonicalizer20010315OmitComments c14nizer =
>                     new Canonicalizer20010315OmitComments();
> 
>             if (this._inputNodeSet.size() == 0) {
>                 // empty nodeset
>                 return null;
>             }
>             bytes = c14nizer.engineCanonicalizeXPathNodeSet(_inputNodeSet);
>             return bytes;
>         }
> 
>         throw new RuntimeException(
>                 "getBytes() called but no input data present");
>     }
> 
> 
>     /**
>      * Determines if the object has been set up with a Node set
>      *
>      * @return true is the object has been set up with a Node set
>      */
>     public boolean isNodeSet() {
>         return ( (this._inputOctetStreamProxy == null)
>                 && (this._inputNodeSet != null) );
>     }
>     /**
>      * Determines if the object has been set up with an Element
>      *
>      * @return true is the object has been set up with a Node set
>      */
>     public boolean isElement() {
>         return ((this._inputOctetStreamProxy==null)&& (this._subNode!=null)
>                 && (this._inputNodeSet==null)
>                 );
>     }
> 
>     /**
>      * Determines if the object has been set up with an octet stream
>      *
>      * @return true is the object has been set up with an octet stream
>      */
>     public boolean isOctetStream() {
>         return ( ((this._inputOctetStreamProxy != null) || bytes!=null)
>                 && ((this._inputNodeSet == null) && _subNode ==null));
>     }
> 
>     /**
>      * Is the object correctly set up?
>      *
>      * @return true if the object has been set up correctly
>      */
>     public boolean isInitialized() {
>         return (this.isOctetStream() || this.isNodeSet());
>     }
> 
>     /**
>      * Returns MIMEType
>      *
>      * @return MIMEType
>      */
>     public String getMIMEType() {
>         return this._MIMEType;
>     }
> 
>     /**
>      * Sets MIMEType
>      *
>      * @param MIMEType
>      */
>     public void setMIMEType(String MIMEType) {
>         this._MIMEType = MIMEType;
>     }
> 
>     /**
>      * Return SourceURI
>      *
>      * @return SourceURI
>      */
>     public String getSourceURI() {
>         return this._SourceURI;
>     }
> 
>     /**
>      * Sets SourceURI
>      *
>      * @param SourceURI
>      */
>     public void setSourceURI(String SourceURI) {
>         this._SourceURI = SourceURI;
>     }
> 
>     /**
>      * This method gives access to an {@link org.apache.xpath.CachedXPathAPI}
>      * object which was used for creating the internal node set and which MUST be
>      * used for subsequent operations on this node set.
>      *
>      * @return an existing {@link org.apache.xpath.CachedXPathAPI}
>      */
>     public CachedXPathAPIHolder getCachedXPathAPI() {
>         if (this._cxpathAPI==null) {
>             this._cxpathAPI=new CachedXPathAPIHolder();
>         }
>         return this._cxpathAPI;
>     }
> 
>     public org.apache.xpath.CachedXPathAPI getCachedXPathAPIBlah() {
>         if (this._cxpathAPI==null) {
>             this._cxpathAPI=new CachedXPathAPIHolder();
>         }
>         return null;
>     }
> 
>     /**
>      * Method toString
>      * @inheritDoc
>      *
>      */
>     @Override
>     public String toString() {
> 
>         if (this.isNodeSet()) {
481,486c515,523
<                    + " nodes/" + this.getSourceURI();
<          } catch (Exception ex) {
<             return "XMLSignatureInput/NodeSet//" + this.getSourceURI();
<          }
<       } else {
<          try {
---
>                     + " nodes/" + this.getSourceURI();
>         }
>         if (this.isElement()) {
>             return "XMLSignatureInput/Element/" + this._subNode
>                     + " exclude "+ this.excludeNode + " comments:" +
>                     this.excludeComments
>                     +"/" + this.getSourceURI();
>         }
>         try {
488,489c525,526
<                    + " octets/" + this.getSourceURI();
<          } catch (Exception ex) {
---
>                     + " octets/" + this.getSourceURI();
>         } catch (Exception ex) {
491,493c528,1314
<          }
<       }
<    }
---
>         }
> 
>     }
> 
>     /**
>      * Method getHTMLRepresentation
>      *
>      * @throws XMLSignatureException
>      * @return The HTML representation for this XMLSignature
>      */
>     public String getHTMLRepresentation() throws XMLSignatureException {
> 
>         XMLSignatureInputDebugger db = new XMLSignatureInputDebugger(this);
> 
>         return db.getHTMLRepresentation();
>     }
> 
>     /**
>      * Method getHTMLRepresentation
>      *
>      * @param inclusiveNamespaces
>      * @throws XMLSignatureException
>      * @return The HTML representation for this XMLSignature
>      */
>     public String getHTMLRepresentation(Set inclusiveNamespaces)
>             throws XMLSignatureException {
> 
>         XMLSignatureInputDebugger db = new XMLSignatureInputDebugger(this,
>                 inclusiveNamespaces);
> 
>         return db.getHTMLRepresentation();
>     }
> 
>     /**
>      * Gets the exclude node of this XMLSignatureInput
>      * @return Returns the excludeNode.
>      */
>     public Node getExcludeNode() {
>         return excludeNode;
>     }
> 
>     /**
>      * Sets the exclude node of this XMLSignatureInput
>      * @param excludeNode The excludeNode to set.
>      */
>     public void setExcludeNode(Node excludeNode) {
>         this.excludeNode = excludeNode;
>     }
> 
>     /**
>      * Gets the node of this XMLSignatureInput
>      * @return The excludeNode set.
>      */
>     public Node getSubNode() {
>         return _subNode;
>     }
>     /**
>      * @return Returns the excludeComments.
>      */
>     public boolean isExcludeComments() {
>         return excludeComments;
>     }
>     /**
>      * @param excludeComments The excludeComments to set.
>      */
>     public void setExcludeComments(boolean excludeComments) {
>         this.excludeComments = excludeComments;
>     }
> 
>     /**
>      * Class XMLSignatureInputDebugger
>      *
>      * @author $Author: raul $
>      * @version $Revision: 1.31 $
>      */
>     public class XMLSignatureInputDebugger {
> 
>         /** Field _xmlSignatureInput */
>         private Set _xpathNodeSet;
>         private Set _inclusiveNamespaces;
> 
>         /** Field _doc */
>         private Document _doc = null;
> 
>         /** Field _writer */
>         private Writer _writer = null;
>         //J-
>         // public static final String HTMLPrefix = "<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\"><html><head><style type=\"text/css\"><!-- .INCLUDED { color: #000000; background-color: #FFFFFF; font-weight: bold; } .EXCLUDED { color: #666666; background-color: #999999; } .INCLUDEDINCLUSIVENAMESPACE {	color: #0000FF; background-color: #FFFFFF; font-weight: bold; font-style: italic; } .EXCLUDEDINCLUSIVENAMESPACE { color: #0000FF; background-color: #999999; font-style: italic; } --> </style> </head><body bgcolor=\"#999999\"><pre>";
>         /**The HTML Prefix**/
>         static final String HTMLPrefix = "<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\">\n"
>                 + "<html>\n"
>                 + "<head>\n"
>                 + "<title>Caninical XML node set</title>\n"
>                 + "<style type=\"text/css\">\n"
>                 + "<!-- \n"
>                 + ".INCLUDED { \n"
>                 + "   color: #000000; \n"
>                 + "   background-color: \n"
>                 + "   #FFFFFF; \n"
>                 + "   font-weight: bold; } \n"
>                 + ".EXCLUDED { \n"
>                 + "   color: #666666; \n"
>                 + "   background-color: \n"
>                 + "   #999999; } \n"
>                 + ".INCLUDEDINCLUSIVENAMESPACE { \n"
>                 + "   color: #0000FF; \n"
>                 + "   background-color: #FFFFFF; \n"
>                 + "   font-weight: bold; \n"
>                 + "   font-style: italic; } \n"
>                 + ".EXCLUDEDINCLUSIVENAMESPACE { \n"
>                 + "   color: #0000FF; \n"
>                 + "   background-color: #999999; \n"
>                 + "   font-style: italic; } \n"
>                 + "--> \n"
>                 + "</style> \n"
>                 + "</head>\n"
>                 + "<body bgcolor=\"#999999\">\n"
>                 + "<h1>Explanation of the output</h1>\n"
>                 + "<p>The following text contains the nodeset of the given Reference before it is canonicalized. There exist four different styles to indicate how a given node is treated.</p>\n"
>                 + "<ul>\n"
>                 + "<li class=\"INCLUDED\">A node which is in the node set is labeled using the INCLUDED style.</li>\n"
>                 + "<li class=\"EXCLUDED\">A node which is <em>NOT</em> in the node set is labeled EXCLUDED style.</li>\n"
>                 + "<li class=\"INCLUDEDINCLUSIVENAMESPACE\">A namespace which is in the node set AND in the InclusiveNamespaces PrefixList is labeled using the INCLUDEDINCLUSIVENAMESPACE style.</li>\n"
>                 + "<li class=\"EXCLUDEDINCLUSIVENAMESPACE\">A namespace which is in NOT the node set AND in the InclusiveNamespaces PrefixList is labeled using the INCLUDEDINCLUSIVENAMESPACE style.</li>\n"
>                 + "</ul>\n"
>                 + "<h1>Output</h1>\n"
>                 + "<pre>\n" ;
> 
>         /** HTML Suffix **/
>         static final String HTMLSuffix = "</pre></body></html>";
> 
>         static final String HTMLExcludePrefix = "<span class=\"EXCLUDED\">";
>         static final String HTMLExcludeSuffix = "</span>";
> 
>         static final String HTMLIncludePrefix = "<span class=\"INCLUDED\">";
>         static final String HTMLIncludeSuffix = "</span>";
> 
>         static final String HTMLIncludedInclusiveNamespacePrefix = "<span class=\"INCLUDEDINCLUSIVENAMESPACE\">";
>         static final String HTMLIncludedInclusiveNamespaceSuffix = "</span>";
> 
>         static final String HTMLExcludedInclusiveNamespacePrefix = "<span class=\"EXCLUDEDINCLUSIVENAMESPACE\">";
>         static final String HTMLExcludedInclusiveNamespaceSuffix = "</span>";
> 
>         private static final int NODE_BEFORE_DOCUMENT_ELEMENT = -1;
>         private static final int NODE_NOT_BEFORE_OR_AFTER_DOCUMENT_ELEMENT = 0;
>         private static final int NODE_AFTER_DOCUMENT_ELEMENT = 1;
>         //J+
>         private XMLSignatureInputDebugger() {
>             // do nothing
>         }
> 
>         /**
>          * Constructor XMLSignatureInputDebugger
>          *
>          * @param xmlSignatureInput
>          */
>         public XMLSignatureInputDebugger(XMLSignatureInput xmlSignatureInput)
>         {
> 
>             if (!xmlSignatureInput.isNodeSet()) {
>                 this._xpathNodeSet = null;
>             } else {
>                 this._xpathNodeSet = xmlSignatureInput._inputNodeSet;
>             }
>         }
> 
>         /**
>          * Constructor XMLSignatureInputDebugger
>          *
>          * @param xmlSignatureInput
>          * @param inclusiveNamespace
>          */
>         public XMLSignatureInputDebugger(
>                 XMLSignatureInput xmlSignatureInput, Set inclusiveNamespace)
>         {
> 
>             this(xmlSignatureInput);
> 
>             this._inclusiveNamespaces = inclusiveNamespace;
>         }
> 
>         /**
>          * Method getHTMLRepresentation
>          * @return The HTML Representation.
>          * @throws XMLSignatureException
>          */
>         public String getHTMLRepresentation() throws XMLSignatureException {
> 
>             if ((this._xpathNodeSet == null) || (this._xpathNodeSet.size() == 0)) {
>                 return HTMLPrefix + "<blink>no node set, sorry</blink>"
>                         + HTMLSuffix;
>             }
> 
>             {
> 
>                 // get only a single node as anchor to fetch the owner document
>                 Node n = (Node) this._xpathNodeSet.iterator().next();
> 
>                 this._doc = XMLUtils.getOwnerDocument(n);
>             }
> 
>             try {
>                 this._writer = new StringWriter();
> 
>                 this.canonicalizeXPathNodeSet(this._doc);
>                 this._writer.close();
> 
>                 return this._writer.toString();
>             } catch (IOException ex) {
>                 throw new XMLSignatureException("empty", ex);
>             } finally {
>                 this._xpathNodeSet = null;
>                 this._doc = null;
>                 this._writer = null;
>             }
>         }
> 
>         /**
>          * Method canonicalizeXPathNodeSet
>          *
>          * @param currentNode
>          * @throws XMLSignatureException
>          * @throws IOException
>          */
>         private void canonicalizeXPathNodeSet(Node currentNode)
>                 throws XMLSignatureException, IOException {
> 
>             int currentNodeType = currentNode.getNodeType();
>             switch (currentNodeType) {
> 
>             case Node.DOCUMENT_TYPE_NODE :
>             default :
>                 break;
> 
>             case Node.ENTITY_NODE :
>             case Node.NOTATION_NODE :
>             case Node.DOCUMENT_FRAGMENT_NODE :
>             case Node.ATTRIBUTE_NODE :
>                 throw new XMLSignatureException("empty");
>             case Node.DOCUMENT_NODE :
>                 this._writer.write(HTMLPrefix);
> 
>                 for (Node currentChild = currentNode.getFirstChild();
>                         currentChild != null;
>                         currentChild = currentChild.getNextSibling()) {
>                     this.canonicalizeXPathNodeSet(currentChild);
>                 }
> 
>                 this._writer.write(HTMLSuffix);
>                 break;
> 
>             case Node.COMMENT_NODE :
>                 if (this._xpathNodeSet.contains(currentNode)) {
>                     this._writer.write(HTMLIncludePrefix);
>                 } else {
>                     this._writer.write(HTMLExcludePrefix);
>                 }
> 
>                 int position = getPositionRelativeToDocumentElement(currentNode);
> 
>                 if (position == NODE_AFTER_DOCUMENT_ELEMENT) {
>                     this._writer.write("\n");
>                 }
> 
>                 this.outputCommentToWriter((Comment) currentNode);
> 
>                 if (position == NODE_BEFORE_DOCUMENT_ELEMENT) {
>                     this._writer.write("\n");
>                 }
> 
>                 if (this._xpathNodeSet.contains(currentNode)) {
>                     this._writer.write(HTMLIncludeSuffix);
>                 } else {
>                     this._writer.write(HTMLExcludeSuffix);
>                 }
>                 break;
> 
>             case Node.PROCESSING_INSTRUCTION_NODE :
>                 if (this._xpathNodeSet.contains(currentNode)) {
>                     this._writer.write(HTMLIncludePrefix);
>                 } else {
>                     this._writer.write(HTMLExcludePrefix);
>                 }
> 
>                 position = getPositionRelativeToDocumentElement(currentNode);
> 
>                 if (position == NODE_AFTER_DOCUMENT_ELEMENT) {
>                     this._writer.write("\n");
>                 }
> 
>                 this.outputPItoWriter((ProcessingInstruction) currentNode);
> 
>                 if (position == NODE_BEFORE_DOCUMENT_ELEMENT) {
>                     this._writer.write("\n");
>                 }
> 
>                 if (this._xpathNodeSet.contains(currentNode)) {
>                     this._writer.write(HTMLIncludeSuffix);
>                 } else {
>                     this._writer.write(HTMLExcludeSuffix);
>                 }
>                 break;
> 
>             case Node.TEXT_NODE :
>             case Node.CDATA_SECTION_NODE :
>                 if (this._xpathNodeSet.contains(currentNode)) {
>                     this._writer.write(HTMLIncludePrefix);
>                 } else {
>                     this._writer.write(HTMLExcludePrefix);
>                 }
> 
>                 outputTextToWriter(currentNode.getNodeValue());
> 
>                 for (Node nextSibling =
>                         currentNode
>                         .getNextSibling(); (nextSibling != null) && ((nextSibling
>                                 .getNodeType() == Node.TEXT_NODE) || (nextSibling
>                                         .getNodeType() == Node
>                                         .CDATA_SECTION_NODE)); nextSibling =
>                                         nextSibling.getNextSibling()) {
> 
>                     /* The XPath data model allows to select only the first of a
>                      * sequence of mixed text and CDATA nodes. But we must output
>                      * them all, so we must search:
>                      *
>                      * @see http://nagoya.apache.org/bugzilla/show_bug.cgi?id=6329
>                      */
>                     this.outputTextToWriter(nextSibling.getNodeValue());
>                 }
> 
>                 if (this._xpathNodeSet.contains(currentNode)) {
>                     this._writer.write(HTMLIncludeSuffix);
>                 } else {
>                     this._writer.write(HTMLExcludeSuffix);
>                 }
>                 break;
> 
>             case Node.ELEMENT_NODE :
>                 Element currentElement = (Element) currentNode;
> 
>                 if (this._xpathNodeSet.contains(currentNode)) {
>                     this._writer.write(HTMLIncludePrefix);
>                 } else {
>                     this._writer.write(HTMLExcludePrefix);
>                 }
> 
>                 this._writer.write("&lt;");
>                 this._writer.write(currentElement.getTagName());
> 
>                 if (this._xpathNodeSet.contains(currentNode)) {
>                     this._writer.write(HTMLIncludeSuffix);
>                 } else {
>                     this._writer.write(HTMLExcludeSuffix);
>                 }
> 
>                 // we output all Attrs which are available
>                 NamedNodeMap attrs = currentElement.getAttributes();
>                 int attrsLength = attrs.getLength();
>                 Object attrs2[] = new Object[attrsLength];
> 
>                 for (int i = 0; i < attrsLength; i++) {
>                     attrs2[i] = attrs.item(i);
>                 }
> 
>                 Arrays.sort(attrs2,new AttrCompare());
>                 Object attrs3[] = attrs2;
> 
>                 for (int i = 0; i < attrsLength; i++) {
>                     Attr a = (Attr) attrs3[i];
>                     boolean included = this._xpathNodeSet.contains(a);
>                     boolean inclusive =
>                             this._inclusiveNamespaces.contains(a.getName());
> 
>                     if (included) {
>                         if (inclusive) {
> 
>                             // included and inclusive
>                             this._writer.write(HTMLIncludedInclusiveNamespacePrefix);
>                         } else {
> 
>                             // included and not inclusive
>                             this._writer.write(HTMLIncludePrefix);
>                         }
>                     } else {
>                         if (inclusive) {
> 
>                             // excluded and inclusive
>                             this._writer.write(HTMLExcludedInclusiveNamespacePrefix);
>                         } else {
> 
>                             // excluded and not inclusive
>                             this._writer.write(HTMLExcludePrefix);
>                         }
>                     }
> 
>                     this.outputAttrToWriter(a.getNodeName(), a.getNodeValue());
> 
>                     if (included) {
>                         if (inclusive) {
> 
>                             // included and inclusive
>                             this._writer.write(HTMLIncludedInclusiveNamespaceSuffix);
>                         } else {
> 
>                             // included and not inclusive
>                             this._writer.write(HTMLIncludeSuffix);
>                         }
>                     } else {
>                         if (inclusive) {
> 
>                             // excluded and inclusive
>                             this._writer.write(HTMLExcludedInclusiveNamespaceSuffix);
>                         } else {
> 
>                             // excluded and not inclusive
>                             this._writer.write(HTMLExcludeSuffix);
>                         }
>                     }
>                 }
> 
>                 if (this._xpathNodeSet.contains(currentNode)) {
>                     this._writer.write(HTMLIncludePrefix);
>                 } else {
>                     this._writer.write(HTMLExcludePrefix);
>                 }
> 
>                 this._writer.write("&gt;");
> 
>                 if (this._xpathNodeSet.contains(currentNode)) {
>                     this._writer.write(HTMLIncludeSuffix);
>                 } else {
>                     this._writer.write(HTMLExcludeSuffix);
>                 }
> 
>                 // traversal
>                 for (Node currentChild = currentNode.getFirstChild();
>                         currentChild != null;
>                         currentChild = currentChild.getNextSibling()) {
>                     this.canonicalizeXPathNodeSet(currentChild);
>                 }
> 
>                 if (this._xpathNodeSet.contains(currentNode)) {
>                     this._writer.write(HTMLIncludePrefix);
>                 } else {
>                     this._writer.write(HTMLExcludePrefix);
>                 }
> 
>                 this._writer.write("&lt;/");
>                 this._writer.write(currentElement.getTagName());
>                 this._writer.write("&gt;");
> 
>                 if (this._xpathNodeSet.contains(currentNode)) {
>                     this._writer.write(HTMLIncludeSuffix);
>                 } else {
>                     this._writer.write(HTMLExcludeSuffix);
>                 }
>                 break;
>             }
>         }
> 
> 
> 
>         /**
>          * Checks whether a Comment or ProcessingInstruction is before or after the
>          * document element. This is needed for prepending or appending "\n"s.
>          *
>          * @param currentNode comment or pi to check
>          * @return NODE_BEFORE_DOCUMENT_ELEMENT, NODE_NOT_BEFORE_OR_AFTER_DOCUMENT_ELEMENT or NODE_AFTER_DOCUMENT_ELEMENT
>          * @see #NODE_BEFORE_DOCUMENT_ELEMENT
>          * @see #NODE_NOT_BEFORE_OR_AFTER_DOCUMENT_ELEMENT
>          * @see #NODE_AFTER_DOCUMENT_ELEMENT
>          */
>         private int getPositionRelativeToDocumentElement(Node currentNode) {
> 
>             if (currentNode == null) {
>                 return NODE_NOT_BEFORE_OR_AFTER_DOCUMENT_ELEMENT;
>             }
> 
>             Document doc = currentNode.getOwnerDocument();
> 
>             if (currentNode.getParentNode() != doc) {
>                 return NODE_NOT_BEFORE_OR_AFTER_DOCUMENT_ELEMENT;
>             }
> 
>             Element documentElement = doc.getDocumentElement();
> 
>             if (documentElement == null) {
>                 return NODE_NOT_BEFORE_OR_AFTER_DOCUMENT_ELEMENT;
>             }
> 
>             if (documentElement == currentNode) {
>                 return NODE_NOT_BEFORE_OR_AFTER_DOCUMENT_ELEMENT;
>             }
> 
>             for (Node x = currentNode; x != null; x = x.getNextSibling()) {
>                 if (x == documentElement) {
>                     return NODE_BEFORE_DOCUMENT_ELEMENT;
>                 }
>             }
> 
>             return NODE_AFTER_DOCUMENT_ELEMENT;
>         }
> 
>         /**
>          * Normalizes an {@link Attr}ibute value
>          *
>          * The string value of the node is modified by replacing
>          * <UL>
>          * <LI>all ampersands (&) with <CODE>&amp;amp;</CODE></LI>
>          * <LI>all open angle brackets (<) with <CODE>&amp;lt;</CODE></LI>
>          * <LI>all quotation mark characters with <CODE>&amp;quot;</CODE></LI>
>          * <LI>and the whitespace characters <CODE>#x9</CODE>, #xA, and #xD, with character
>          * references. The character references are written in uppercase
>          * hexadecimal with no leading zeroes (for example, <CODE>#xD</CODE> is represented
>          * by the character reference <CODE>&amp;#xD;</CODE>)</LI>
>          * </UL>
>          *
>          * @param name
>          * @param value
>          * @throws IOException
>          */
>         private void outputAttrToWriter(String name, String value)
>                 throws IOException {
> 
>             this._writer.write(" ");
>             this._writer.write(name);
>             this._writer.write("=\"");
> 
>             int length = value.length();
> 
>             for (int i = 0; i < length; i++) {
>                 char c = value.charAt(i);
> 
>                 switch (c) {
> 
>                 case '&' :
>                     this._writer.write("&amp;amp;");
>                     break;
> 
>                 case '<' :
>                     this._writer.write("&amp;lt;");
>                     break;
> 
>                 case '"' :
>                     this._writer.write("&amp;quot;");
>                     break;
> 
>                 case 0x09 :    // '\t'
>                     this._writer.write("&amp;#x9;");
>                     break;
> 
>                 case 0x0A :    // '\n'
>                     this._writer.write("&amp;#xA;");
>                     break;
> 
>                 case 0x0D :    // '\r'
>                     this._writer.write("&amp;#xD;");
>                     break;
> 
>                 default :
>                     this._writer.write(c);
>                     break;
>                 }
>             }
> 
>             this._writer.write("\"");
>         }
> 
>         /**
>          * Normalizes a {@link org.w3c.dom.Comment} value
>          *
>          * @param currentPI
>          * @throws IOException
>          */
>         private void outputPItoWriter(ProcessingInstruction currentPI)
>                 throws IOException {
> 
>             if (currentPI == null) {
>                 return;
>             }
> 
>             this._writer.write("&lt;?");
> 
>             String target = currentPI.getTarget();
>             int length = target.length();
> 
>             for (int i = 0; i < length; i++) {
>                 char c = target.charAt(i);
> 
>                 switch (c) {
> 
>                 case 0x0D :
>                     this._writer.write("&amp;#xD;");
>                     break;
> 
>                 case ' ' :
>                     this._writer.write("&middot;");
>                     break;
> 
>                 case '\n' :
>                     this._writer.write("&para;\n");
>                     break;
> 
>                 default :
>                     this._writer.write(c);
>                     break;
>                 }
>             }
> 
>             String data = currentPI.getData();
> 
>             length = data.length();
> 
>             if ((data != null) && (length > 0)) {
>                 this._writer.write(" ");
> 
>                 for (int i = 0; i < length; i++) {
>                     char c = data.charAt(i);
> 
>                     switch (c) {
> 
>                     case 0x0D :
>                         this._writer.write("&amp;#xD;");
>                         break;
> 
>                     default :
>                         this._writer.write(c);
>                         break;
>                     }
>                 }
>             }
> 
>             this._writer.write("?&gt;");
>         }
> 
>         /**
>          * Method outputCommentToWriter
>          *
>          * @param currentComment
>          * @throws IOException
>          */
>         private void outputCommentToWriter(Comment currentComment)
>                 throws IOException {
> 
>             if (currentComment == null) {
>                 return;
>             }
> 
>             this._writer.write("&lt;!--");
> 
>             String data = currentComment.getData();
>             int length = data.length();
> 
>             for (int i = 0; i < length; i++) {
>                 char c = data.charAt(i);
> 
>                 switch (c) {
> 
>                 case 0x0D :
>                     this._writer.write("&amp;#xD;");
>                     break;
> 
>                 case ' ' :
>                     this._writer.write("&middot;");
>                     break;
> 
>                 case '\n' :
>                     this._writer.write("&para;\n");
>                     break;
> 
>                 default :
>                     this._writer.write(c);
>                     break;
>                 }
>             }
> 
>             this._writer.write("--&gt;");
>         }
> 
>         /**
>          * Method outputTextToWriter
>          *
>          * @param text
>          * @throws IOException
>          */
>         private void outputTextToWriter(String text) throws IOException {
> 
>             if (text == null) {
>                 return;
>             }
> 
>             int length = text.length();
> 
>             for (int i = 0; i < length; i++) {
>                 char c = text.charAt(i);
> 
>                 switch (c) {
> 
>                 case '&' :
>                     this._writer.write("&amp;amp;");
>                     break;
> 
>                 case '<' :
>                     this._writer.write("&amp;lt;");
>                     break;
> 
>                 case '>' :
>                     this._writer.write("&amp;gt;");
>                     break;
> 
>                 case 0xD :
>                     this._writer.write("&amp;#xD;");
>                     break;
> 
>                 case ' ' :
>                     this._writer.write("&middot;");
>                     break;
> 
>                 case '\n' :
>                     this._writer.write("&para;\n");
>                     break;
> 
>                 default :
>                     this._writer.write(c);
>                     break;
>                 }
>             }
>         }
>     }
> 
>     /**
>      * @param diOs
>      * @throws IOException
>      * @throws CanonicalizationException
>      */
>     public void updateOutputStream(OutputStream diOs) throws CanonicalizationException, IOException {
>         if (diOs==outputStream) {
>             return;
>         }
>         if (bytes!=null) {
>             diOs.write(bytes);
>             return;
>         }else if (this.isElement()) {
>             Canonicalizer20010315OmitComments c14nizer =
>                     new Canonicalizer20010315OmitComments();
>             c14nizer.setWriter(diOs);
>             c14nizer.engineCanonicalizeSubTree(this._subNode,this.excludeNode);
>             return;
>         } else if (this.isNodeSet()) {
>             /* If we have a node set but an octet stream is needed, we MUST c14nize
>              * without any comments.
>              *
>              * We don't use the factory because direct instantiation should be a
>              * little bit faster...
>              */
>             Canonicalizer20010315OmitComments c14nizer =
>                     new Canonicalizer20010315OmitComments();
>             c14nizer.setWriter(diOs);
>             if (this._inputNodeSet.size() == 0) {
>                 // empty nodeset
>                 return;
>             }
>             c14nizer.engineCanonicalizeXPathNodeSet(this._inputNodeSet);
>             return;
>         } else {
>             InputStream is = this._inputOctetStreamProxy;
>             if (is.markSupported()) {
>                 is.reset();
>             }
>             int num;
>             bytes = new byte[1024];
>             while ((num=is.read(bytes))>0) {
>                 diOs.write(bytes,0,num);
>             }
> 
>         }
> 
>     }
> 
> 
>     /**
>      * @param os
>      */
>     public void setOutputStream(OutputStream os) {
>         outputStream=os;
> 
>     }
diff -r xml-security-orig-v1/src/org/apache/xml/security/signature/XMLSignature.java xml-security-1_2_0/src/org/apache/xml/security/signature/XMLSignature.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
62a21
> import java.io.BufferedOutputStream;
63a23
> import java.io.OutputStream;
65d24
< import java.security.PrivateKey;
68,89c27
< import java.util.Vector;
< import javax.xml.parsers.DocumentBuilder;
< import javax.xml.parsers.DocumentBuilderFactory;
< import javax.xml.parsers.ParserConfigurationException;
< import javax.xml.transform.TransformerException;
< import org.apache.xml.security.algorithms.*;
< import org.apache.xml.security.algorithms.implementations.*;
< import org.apache.xml.security.c14n.*;
< import org.apache.xml.security.transforms.params.XPathContainer;
< import org.apache.xml.security.exceptions.*;
< import org.apache.xml.security.keys.*;
< import org.apache.xml.security.keys.content.*;
< import org.apache.xml.security.keys.content.keyvalues.*;
< import org.apache.xml.security.keys.content.x509.*;
< import org.apache.xml.security.keys.keyresolver.*;
< import org.apache.xml.security.keys.storage.*;
< import org.apache.xml.security.transforms.Transform;
< import org.apache.xml.security.transforms.Transforms;
< import org.apache.xml.security.utils.*;
< import org.apache.xml.security.utils.resolver.*;
< import org.apache.xpath.XPathAPI;
< import org.w3c.dom.*;
---
> 
91c29,52
< import javax.crypto.spec.SecretKeySpec;
---
> 
> import org.apache.xml.security.algorithms.SignatureAlgorithm;
> import org.apache.xml.security.c14n.CanonicalizationException;
> import org.apache.xml.security.c14n.Canonicalizer;
> import org.apache.xml.security.c14n.InvalidCanonicalizerException;
> import org.apache.xml.security.exceptions.Base64DecodingException;
> import org.apache.xml.security.exceptions.XMLSecurityException;
> import org.apache.xml.security.keys.KeyInfo;
> import org.apache.xml.security.keys.content.X509Data;
> import org.apache.xml.security.transforms.Transforms;
> import org.apache.xml.security.utils.Base64;
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.HexDump;
> import org.apache.xml.security.utils.I18n;
> import org.apache.xml.security.utils.IdResolver;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.apache.xml.security.utils.SignerOutputStream;
> import org.apache.xml.security.utils.XMLUtils;
> import org.apache.xml.security.utils.resolver.ResourceResolver;
> import org.apache.xml.security.utils.resolver.ResourceResolverSpi;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.Node;
> import org.w3c.dom.Text;
95c56,73
<  * Handles <code>&lt;ds:Signature&gt;</code> elements
---
>  * Handles <code>&lt;ds:Signature&gt;</code> elements.
>  * This is the main class that deals with creating and verifying signatures.
>  *
>  * <p>There are 2 types of constructors for this class. The ones that take a
>  * document, baseURI and 1 or more Java Objects. This is mostly used for
>  * signing purposes.
>  * The other constructor is the one that takes a DOM Element and a BaseURI.
>  * This is used mostly with for verifying, when you have a SignatureElement.
>  *
>  * There are a few different types of methods:
>  * <ul><li>The addDocument* methods are used to add References with optional
>  * transforms during signing. </li>
>  * <li>addKeyInfo* methods are to add Certificates and Keys to the
>  * KeyInfo tags during signing. </li>
>  * <li>appendObject allows a user to add any XML Structure as an
>  * ObjectContainer during signing.</li>
>  * <li>sign and checkSignatureValue methods are used to sign and validate the
>  * signature. </li></ul>
97c75
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
99c77
< public class XMLSignature extends SignatureElementProxy {
---
> public final class XMLSignature extends SignatureElementProxy {
101,103c79,82
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(XMLSignature.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>    static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(XMLSignature.class.getName());
>    
112a92
>    /** Signature - Recommended RSAwithSHA1 */
114c94
< 
---
>    /** Signature - NOT Recommended RSAwithMD5 */
115a96
>    /** Signature - Optional RSAwithRIPEMD160 */
116a98
>    /** Signature - Optional RSAwithSHA256 */
117a100
>    /** Signature - Optional RSAwithSHA384 */
118a102
>    /** Signature - Optional RSAwithSHA512 */
120a105
>    /** HMAC - NOT Recommended HMAC-MD5 */
121a107
>    /** HMAC - Optional HMAC-RIPEMD160 */
122a109
>    /** HMAC - Optional HMAC-SHA256 */
123a111
>    /** HMAC - Optional HMAC-SHA284 */
124a113
>    /** HMAC - Optional HMAC-SHA512 */
129c118
<    SignedInfo _signedInfo = null;
---
>    private SignedInfo _signedInfo = null;
132,135c121
<    KeyInfo _keyInfo = null;
< 
<    /** Field _followManifestsDuringValidation */
<    boolean _followManifestsDuringValidation = false;
---
>    private KeyInfo _keyInfo = null;
137a124,130
>     * Checking the digests in References in a Signature are mandatory, but for
>     * References inside a Manifest it is application specific. This boolean is
>     * to indicate that the References inside Manifests should be validated.
>     */
>    private boolean _followManifestsDuringValidation = false;
> 
>   /**
139c132,149
<     * <CODE>ds:SignedInfo</CODE> to it.
---
>     * <CODE>ds:SignedInfo</CODE>.
>     * The <code>ds:SignedInfo</code> is initialized with the specified Signature
>     * algorithm and Canonicalizer.ALGO_ID_C14N_OMIT_COMMENTS which is REQUIRED
>     * by the spec. This method's main use is for creating a new signature.
>     *
>     * @param doc Document in which the signature will be appended after creation.
>     * @param BaseURI URI to be used as context for all relative URIs.
>     * @param SignatureMethodURI signature algorithm to use.
>     * @throws XMLSecurityException
>     */
>    public XMLSignature(Document doc, String BaseURI, String SignatureMethodURI)
>            throws XMLSecurityException {
>       this(doc, BaseURI, SignatureMethodURI, 0,
>            Canonicalizer.ALGO_ID_C14N_OMIT_COMMENTS);
>    }
> 
>    /**
>     * Constructor XMLSignature
143c153,154
<     * @param signatureAlgorithmURI
---
>     * @param SignatureMethodURI the Signature method to be used.
>     * @param HMACOutputLength
147c158,190
<            Document doc, String BaseURI, String signatureAlgorithmURI)
---
>            Document doc, String BaseURI, String SignatureMethodURI, int HMACOutputLength)
>               throws XMLSecurityException {
>       this(doc, BaseURI, SignatureMethodURI, HMACOutputLength,
>            Canonicalizer.ALGO_ID_C14N_OMIT_COMMENTS);
>    }
> 
>    /**
>     * Constructor XMLSignature
>     *
>     * @param doc
>     * @param BaseURI
>     * @param SignatureMethodURI the Signature method to be used.
>     * @param CanonicalizationMethodURI the canonicalization algorithm to be used to c14nize the SignedInfo element.
>     * @throws XMLSecurityException
>     */
>    public XMLSignature(
>            Document doc, String BaseURI, String SignatureMethodURI, String CanonicalizationMethodURI)
>               throws XMLSecurityException {
>       this(doc, BaseURI, SignatureMethodURI, 0, CanonicalizationMethodURI);
>    }
> 
>    /**
>     * Constructor XMLSignature
>     *
>     * @param doc
>     * @param BaseURI
>     * @param SignatureMethodURI
>     * @param HMACOutputLength
>     * @param CanonicalizationMethodURI
>     * @throws XMLSecurityException
>     */
>    public XMLSignature(
>            Document doc, String BaseURI, String SignatureMethodURI, int HMACOutputLength, String CanonicalizationMethodURI)
155,157c198,230
<       this._signedInfo =
<          new SignedInfo(this._doc, Canonicalizer.ALGO_ID_C14N_OMIT_COMMENTS,
<                         signatureAlgorithmURI);
---
>       this._signedInfo = new SignedInfo(this._doc, SignatureMethodURI,
>                                         HMACOutputLength,
>                                         CanonicalizationMethodURI);
> 
>       this._constructionElement.appendChild(this._signedInfo.getElement());
>       XMLUtils.addReturnToElement(this._constructionElement);
> 
>       // create an empty SignatureValue; this is filled by setSignatureValueElement
>       Element signatureValueElement =
>          XMLUtils.createElementInSignatureSpace(this._doc,
>                                                 Constants._TAG_SIGNATUREVALUE);
> 
>       this._constructionElement.appendChild(signatureValueElement);
>       XMLUtils.addReturnToElement(this._constructionElement);
>    }
>    /**
>     *  Creates a XMLSignature in a Document
>     * @param doc
>     * @param BaseURI
>     * @param SignatureMethodElem
>     * @param CanonicalizationMethodElem
>     * @throws XMLSecurityException
>     */
>    public XMLSignature(
>            Document doc, String BaseURI, Element SignatureMethodElem, Element CanonicalizationMethodElem)
>               throws XMLSecurityException {
> 
>       super(doc);
> 
>       XMLUtils.addReturnToElement(this._constructionElement);
> 
>       this._baseURI = BaseURI;
>       this._signedInfo = new SignedInfo(this._doc, SignatureMethodElem, CanonicalizationMethodElem);
172c245,246
<     * Constructor XMLSignature
---
>     * This will parse the element and construct the Java Objects.
>     * That will allow a user to validate the signature.
174,176c248,249
<     * @param element
<     * @param BaseURI
<     * @throws IOException
---
>     * @param element ds:Signature element that contains the whole signature
>     * @param BaseURI URI to be prepended to all relative URIs
178c251
<     * @throws XMLSignatureException
---
>     * @throws XMLSignatureException if the signature is badly formatted
181c254
<            throws XMLSignatureException, XMLSecurityException, IOException {
---
>            throws XMLSignatureException, XMLSecurityException {
186,188c259,260
<       Element signedInfoElem = this.getChildElementLocalName(0,
<                                   Constants.SignatureSpecNS,
<                                   Constants._TAG_SIGNEDINFO);
---
>       Element signedInfoElem = XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>                                   Constants._TAG_SIGNEDINFO,0);
189a262
>       // check to see if it is there
196a270
>       // create a SignedInfo object from that element
200,202c274,275
<       Element signatureValueElement = this.getChildElementLocalName(0,
<                                          Constants.SignatureSpecNS,
<                                          Constants._TAG_SIGNATUREVALUE);
---
>       Element signatureValueElement = XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>                                          Constants._TAG_SIGNATUREVALUE,0);
203a277
>       // check to see if it exists
212,214c286,287
<       Element keyInfoElem = this.getChildElementLocalName(0,
<                                Constants.SignatureSpecNS,
<                                Constants._TAG_KEYINFO);
---
>       Element keyInfoElem =XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>                                Constants._TAG_KEYINFO,0);
215a289
>       // If it exists use it, but it's not mandatory
224c298
<     * @param Id ID
---
>     * @param Id Id value to be used by the id attribute on the Signature Element
244c318
<     * Method getSignedInfo
---
>     * Returns the completely parsed <code>SignedInfo</code> object.
246c320
<     * @return
---
>     * @return the completely parsed <code>SignedInfo</code> object.
253c327,328
<     * Method getSignatureValue
---
>     * Returns the octet value of the SignatureValue element.
>     * Throws an XMLSignatureException if it has no or wrong content.
255,256c330,331
<     * @return
<     * @throws XMLSignatureException
---
>     * @return the value of the SignatureValue element.
>     * @throws XMLSignatureException If there is no content
261,263c336,337
<          Element signatureValueElem = this.getChildElementLocalName(0,
<                                          Constants.SignatureSpecNS,
<                                          Constants._TAG_SIGNATUREVALUE);
---
>          Element signatureValueElem = XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>                                          Constants._TAG_SIGNATUREVALUE,0);
273c347,348
<     * Method setSignatureValueElement
---
>     * Base64 encodes and sets the bytes as the content of the SignatureValue
>     * Node.
275,276c350
<     * @param bytes
<     * @throws XMLSignatureException
---
>     * @param bytes bytes to be used by SignatureValue before Base64 encoding
279c353
<            throws XMLSignatureException {
---
>    {
282,286c356,357
<          Element signatureValueElem = this.getChildElementLocalName(0,
<                                          Constants.SignatureSpecNS,
<                                          Constants._TAG_SIGNATUREVALUE);
<          NodeList children = signatureValueElem.getChildNodes();
< 
---
>          Element signatureValueElem = XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>                                          Constants._TAG_SIGNATUREVALUE,0);
305c376,378
<     * does not exist yet, we create it and add it to the Signature.
---
>     * does not exist yet, it is created on demand and added to the Signature.
>     * <br>
>     * This allows to add arbitrary content to the KeyInfo during signing.
310a384
>       // check to see if we are signing and if we have to create a keyinfo
311a386,387
> 
>          // create the KeyInfo
313a390
>          // get the Element from KeyInfo
315,324c392,395
< 
<          try {
<             Element nscontext = XMLUtils.createDSctx(this._doc, "ds",
<                                                      Constants.SignatureSpecNS);
<             Element firstObject =
<                (Element) XPathAPI.selectSingleNode(this._constructionElement,
<                                                    "./ds:"
<                                                    + Constants._TAG_OBJECT
<                                                    + "[1]", nscontext);
< 
---
>          Element firstObject=null;
>          Node sibling= this._constructionElement.getFirstChild();
>          firstObject = XMLUtils.selectDsNode(sibling,Constants._TAG_OBJECT,0);
> 	   	     
325a397,398
> 
>                // add it before the object
330a404,405
> 
>                // add it as the last element to the signature
333,336c408
<             }
<          } catch (TransformerException ex) {
<             ex.printStackTrace();
<          }
---
>             }         
343c415,417
<     * Method setKeyInfo
---
>     * Appends an Object (not a <code>java.lang.Object</code> but an Object
>     * element) to the Signature. Please note that this is only possible
>     * when signing.
345,355c419,420
<     * @param keyInfo
<     */
<    private void setKeyInfo(KeyInfo keyInfo) {
<       this._keyInfo = keyInfo;
<    }
< 
<    /**
<     * Method appendObject
<     *
<     * @param object
<     * @throws XMLSignatureException
---
>     * @param object ds:Object to be appended.
>     * @throws XMLSignatureException When this object is used to verify.
374c439,440
<     * Method objectItem
---
>     * Returns the <code>i<code>th <code>ds:Object</code> child of the signature
>     * or null if no such <code>ds:Object</code> element exists.
377c443
<     * @return
---
>     * @return the <code>i<code>th <code>ds:Object</code> child of the signature or null if no such <code>ds:Object</code> element exists.
381,382c447,448
<       Element objElem = this.getChildElementLocalName(i,
<                            Constants.SignatureSpecNS, Constants._TAG_OBJECT);
---
>       Element objElem = XMLUtils.selectDsNode(this._constructionElement.getFirstChild(),
>             Constants._TAG_OBJECT,i);
392c458
<     * Method getObjectLength
---
>     * Returns the number of all <code>ds:Object</code> elements.
394c460
<     * @return
---
>     * @return the number of all <code>ds:Object</code> elements.
401c467,468
<     * Method sign
---
>     * Digests all References in the SignedInfo, calculates the signature value and
>     * sets it in the SignatureValue Element.
403c470
<     * @param privateKey
---
>     * @param signingKey the {@link java.security.PrivateKey} or {@link javax.crypto.SecretKey} that is used to sign.
406,418c473
<    public void sign(PrivateKey privateKey) throws XMLSignatureException {
< 
<       try {
<          if (this._state == MODE_SIGN) {
< 
<             // XMLUtils.indentSignature(this._constructionElement, "   ", 0);
<             Element signatureMethodElement =
<                this._signedInfo.getSignatureMethodElement();
<             SignatureAlgorithm sa =
<                new SignatureAlgorithm(signatureMethodElement,
<                                       this.getBaseURI());
< 
<             sa.initSign(privateKey);
---
>    public void sign(Key signingKey) throws XMLSignatureException {
420,439c475,477
<             SignedInfo si = this.getSignedInfo();
< 
<             si.generateDigestValues();
< 
<             byte signedInfoOctets[] = si.getCanonicalizedOctetStream();
< 
<             sa.update(signedInfoOctets);
< 
<             byte jcebytes[] = sa.sign();
< 
<             this.setSignatureValueElement(jcebytes);
<          }
<       } catch (IOException ex) {
<          throw new XMLSignatureException("empty", ex);
<       } catch (CanonicalizationException ex) {
<          throw new XMLSignatureException("empty", ex);
<       } catch (InvalidCanonicalizerException ex) {
<          throw new XMLSignatureException("empty", ex);
<       } catch (XMLSecurityException ex) {
<          throw new XMLSignatureException("empty", ex);
---
>       if (signingKey instanceof PublicKey) {
>          throw new IllegalArgumentException(I18n
>             .translate("algorithms.operationOnlyVerification"));
441,449d478
<    }
< 
<    /**
<     * Method sign
<     *
<     * @param secretKey
<     * @throws XMLSignatureException
<     */
<    public void sign(SecretKey secretKey) throws XMLSignatureException {
454a484
>             // get the SignatureMethodElement
456a487,488
> 
>             //Create a SignatureAlgorithm object
461c493,494
<             sa.initSign(secretKey);
---
>             // initialize SignatureAlgorithm for signing
>             sa.initSign(signingKey);
464a498
>             // generate digest values for all References in this SignedInfo
466,469c500,507
< 
<             byte signedInfoOctets[] = si.getCanonicalizedOctetStream();
< 
<             sa.update(signedInfoOctets);
---
>             OutputStream so=new BufferedOutputStream(new SignerOutputStream(sa));
>             try {
>                 so.close();
>             } catch (IOException e) {
>                 //Imposible
>             }
>             // get the canonicalized bytes from SignedInfo
>             si.signInOctectStream(so);
472a511
>             // set them on the SignateValue element
475,476d513
<       } catch (IOException ex) {
<          throw new XMLSignatureException("empty", ex);
487,514c524
<     * Method sign
<     *
<     * @return
<     * @throws XMLSignatureException
<     */
<    public boolean verify() throws XMLSignatureException {
< 
<       if (this._state == MODE_VERIFY) {
<          try {
<             Element signatureMethodElement =
<                this._signedInfo.getSignatureMethodElement();
<             SignatureAlgorithm sa =
<                new SignatureAlgorithm(signatureMethodElement,
<                                       this.getBaseURI());
< 
<             /** @todo do real work here */
<             return false;
<          } catch (XMLSecurityException ex) {
<             throw new XMLSignatureException("empty", ex);
<          }
<       }
< 
<       /** @todo fill in error message */
<       throw new XMLSignatureException("empty");
<    }
< 
<    /**
<     * Method addResourceResolver
---
>     * Adds a {@link ResourceResolver} to enable the retrieval of resources.
523c533
<     * Method addResourceResolver
---
>     * Adds a {@link ResourceResolverSpi} to enable the retrieval of resources.
532c542,545
<     * Method checkSignatureValue
---
>     * Extracts the public key from the certificate and verifies if the signature
>     * is valid by re-digesting all References, comparing those against the
>     * stored DigestValues and then checking to see if the Signatures match on
>     * the SignedInfo.
534,535c547,548
<     * @param cert
<     * @return
---
>     * @param cert Certificate that contains the public key part of the keypair that was used to sign.
>     * @return true if the signature is valid, false otherwise
540a554
>       // see if cert is null
542,544d555
<          return this.checkSignatureValue(cert.getPublicKey());
<       } else {
<          Object exArgs[] = { "Didn't get a certificate" };
546,547c557,563
<          throw new XMLSignatureException("empty", exArgs);
<       }
---
>          //check the values with the public key from the cert
>          return this.checkSignatureValue(cert.getPublicKey());
>       } 
>       
>       Object exArgs[] = { "Didn't get a certificate" };
>       throw new XMLSignatureException("empty", exArgs);
>       
551c567,569
<     * Method checkSignatureValue
---
>     * Verifies if the signature is valid by redigesting all References,
>     * comparing those against the stored DigestValues and then checking to see
>     * if the Signatures match on the SignedInfo.
553,554c571,572
<     * @param pk
<     * @return
---
>     * @param pk {@link java.security.PublicKey} part of the keypair or {@link javax.crypto.SecretKey} that was used to sign
>     * @return true if the signature is valid, false otherwise
558a577,578
>       //COMMENT: pk suggests it can only be a public key?
>       //check to see if the key is not null
564a585,589
>       // all references inside the signedinfo need to be dereferenced and
>       // digested again to see if the outcome matches the stored value in the
>       // SignedInfo.
>       // If _followManifestsDuringValidation is true it will do the same for
>       // References inside a Manifest.
570a596,597
>          //create a SignatureAlgorithms from the SignatureMethod inside
>          //SignedInfo. This is used to validate the signature.
574,578c601,606
< 
<          cat.debug("SignatureMethodURI = " + sa.getAlgorithmURI());
<          cat.debug("jceSigAlgorithm    = " + sa.getJCEAlgorithmString());
<          cat.debug("jceSigProvider     = " + sa.getJCEProviderName());
<          cat.debug("PublicKey = " + pk);
---
>          if (log.isDebugEnabled()) {
>          	log.debug("SignatureMethodURI = " + sa.getAlgorithmURI());
>          	log.debug("jceSigAlgorithm    = " + sa.getJCEAlgorithmString());
>          	log.debug("jceSigProvider     = " + sa.getJCEProviderName());
>          	log.debug("PublicKey = " + pk);
>          }
581,584c609,619
<          byte inputBytes[] = this._signedInfo.getCanonicalizedOctetStream();
< 
<          sa.update(inputBytes);
< 
---
>          // Get the canonicalized (normalized) SignedInfo
>          SignerOutputStream so=new SignerOutputStream(sa);
>          BufferedOutputStream bos=new BufferedOutputStream(so);
>          this._signedInfo.signInOctectStream(bos);
>          try {
> 			bos.close();
> 		} catch (IOException e) {
> 			//Imposible
> 		}
>          
>          //retrieve the byte[] from the stored signature
587c622,623
<          cat.debug("SignatureValue = "
---
>          if (log.isDebugEnabled()) {
>          	log.debug("SignatureValue = "
588a625
>          };
589a627,628
>          //Have SignatureAlgorithm sign the input bytes and compare them to the
>          //bytes that were stored in the signature.
595,597c634
<       } catch (IOException ex) {
<          throw new XMLSignatureException("empty", ex);
<       }
---
>       } 
601c638
<     * Method addDocument
---
>     * Add a Reference with full parameters to this Signature
603,607c640,647
<     * @param referenceURI
<     * @param trans
<     * @param digestURI
<     * @param ReferenceId
<     * @param ReferenceType
---
>     * @param referenceURI URI of the resource to be signed. Can be null in which
>     * case the dereferencing is application specific. Can be "" in which it's
>     * the parent node (or parent document?). There can only be one "" in each
>     * signature.
>     * @param trans Optional list of transformations to be done before digesting
>     * @param digestURI Mandatory URI of the digesting algorithm to use.
>     * @param ReferenceId Optional id attribute for this Reference
>     * @param ReferenceType Optional mimetype for the URI
618c658
<     * This method is a proxy method for the {@link Manifest#addDocument} method
---
>     * This method is a proxy method for the {@link Manifest#addDocument} method.
620,623c660,663
<     * @param referenceURI
<     * @param trans
<     * @param digestURI
<     * @see Manifest#addDocument(org.apache.xml.security.signature.XMLSignatureInput, java.lang.String, org.apache.xml.security.transforms.Transforms, java.lang.String)
---
>     * @param referenceURI URI according to the XML Signature specification.
>     * @param trans List of transformations to be applied.
>     * @param digestURI URI of the digest algorithm to be used.
>     * @see Manifest#addDocument
634c674,675
<     * Method addDocument
---
>     * Adds a Reference with just the URI and the transforms. This used the
>     * SHA1 algorithm as a default digest algorithm.
636,637c677,678
<     * @param referenceURI
<     * @param trans
---
>     * @param referenceURI URI according to the XML Signature specification.
>     * @param trans List of transformations to be applied.
647c688,689
<     * Method addDocument
---
>     * Add a Reference with just this URI. It uses SHA1 by default as the digest
>     * algorithm
649c691
<     * @param referenceURI
---
>     * @param referenceURI URI according to the XML Signature specification.
653d694
< 
659c700,701
<     * Method addToKeyInfoCompleteCertificate
---
>     * Add an X509 Certificate to the KeyInfo. This will include the whole cert
>     * inside X509Data/X509Certificate tags.
661c703
<     * @param cert
---
>     * @param cert Certificate to be included. This should be the certificate of the key that was used to sign.
673c715,716
<     * Method addToKeyInfo
---
>     * Add this public key to the KeyInfo. This will include the complete key in
>     * the KeyInfo structure.
682c725,727
<     * Proxy method for {@link SignedInfo#createSecretKey(byte[])}
---
>     * Proxy method for {@link SignedInfo#createSecretKey(byte[])}. If you want to
>     * create a MAC, this method helps you to obtain the {@link javax.crypto.SecretKey}
>     * from octets.
685,686c730
<     * @return
<     * @throws XMLSecurityException
---
>     * @return the secret key created.
690c734
<            throws XMLSecurityException {
---
>    {
695c739,742
<     * Method setFollowNestedManifests
---
>     * Signal wether Manifest should be automatically validated.
>     * Checking the digests in References in a Signature are mandatory, but for
>     * References inside a Manifest it is application specific. This boolean is
>     * to indicate that the References inside Manifests should be validated.
697a745
>     * @see <a href="http://www.w3.org/TR/xmldsig-core/#sec-CoreValidation">Core validation section in the XML Signature Rec.</a>
704c752
<     * Method getBaseLocalName
---
>     * Get the local name of this element
706c754
<     * @return
---
>     * @return Constant._TAG_SIGNATURE
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/implementations/FuncHereContext.java xml-security-1_2_0/src/org/apache/xml/security/transforms/implementations/FuncHereContext.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,66d20
< import org.w3c.dom.*;
< import org.apache.xpath.XPathContext;
< import org.apache.xpath.CachedXPathAPI;
< import org.apache.xml.security.utils.CachedXPathFuncHereAPI;
68a23,25
> import org.apache.xpath.CachedXPathAPI;
> import org.apache.xpath.XPathContext;
> import org.w3c.dom.Node;
75c32
<  * in {@link Text}, {@link Attr}ibutes and {@ProcessingInstrinction} nodes. The
---
>  * in {@link org.w3c.dom.Text}, {@link org.w3c.dom.Attr}ibutes and {@ProcessingInstrinction} nodes. The
104c61
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
123c80
<       super((Object) owner);
---
>       super(owner);
134c91
<       super((Object) owner);
---
>       super(owner);
137c94
<          this.m_dtmManager = xpathContext.getDTMManager();
---
>          super.m_dtmManager = xpathContext.getDTMManager();
153c110
<       super((Object) owner);
---
>       super(owner);
156c113
<          this.m_dtmManager = previouslyUsed.getXPathContext().getDTMManager();
---
>          super.m_dtmManager = previouslyUsed.getXPathContext().getDTMManager();
172c129
<       super((Object) owner);
---
>       super(owner);
175c132
<          this.m_dtmManager = dtmManager;
---
>          super.m_dtmManager = dtmManager;
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/implementations/FuncHere.java xml-security-1_2_0/src/org/apache/xml/security/transforms/implementations/FuncHere.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63a22
> 
65c24,25
< import org.apache.xpath.XPathContext;
---
> import org.apache.xml.security.utils.I18n;
> import org.apache.xml.security.utils.XMLUtils;
67,68c27
< import org.apache.xpath.objects.XObject;
< import org.apache.xpath.objects.XNodeSet;
---
> import org.apache.xpath.XPathContext;
69a29,30
> import org.apache.xpath.objects.XNodeSet;
> import org.apache.xpath.objects.XObject;
71,74c32,33
< import org.w3c.dom.*;
< import org.w3c.dom.traversal.NodeIterator;
< import org.apache.xml.security.utils.XMLUtils;
< import org.apache.xml.security.utils.I18n;
---
> import org.w3c.dom.Document;
> import org.w3c.dom.Node;
90c49
<  * by constructing a {@link FuncHereContext) which has this Node as 'owner'.
---
>  * by constructing a {@link FuncHere} which has this Node as 'owner'.
92c51
<  * @see http://www.w3.org/Signature/Drafts/xmldsig-core/Overview.html#function-here
---
>  * @see "http://www.w3.org/Signature/Drafts/xmldsig-core/Overview.html#function-here"
178c137
<       /** @todo Do I have to do this detach() call? */
---
>       /** $todo$ Do I have to do this detach() call? */
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/implementations/package.html xml-security-1_2_0/src/org/apache/xml/security/transforms/implementations/package.html
2c2
< implementations of XML Signature transforms
---
> implementations of XML Signature transforms.
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/implementations/TransformBase64Decode.java xml-security-1_2_0/src/org/apache/xml/security/transforms/implementations/TransformBase64Decode.java
0a1
> 
2,3c3
<  * The Apache Software License, Version 1.1
<  *
---
>  * Copyright  1999-2004 The Apache Software Foundation.
5,6c5,15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
---
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
8,57d16
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,65c22
< import java.io.InputStream;
< import java.io.BufferedReader;
< import java.io.ByteArrayInputStream;
---
> import java.io.BufferedInputStream;
67,73c24,29
< import org.w3c.dom.*;
< import org.w3c.dom.traversal.*;
< import org.apache.xpath.XPathAPI;
< import org.apache.xpath.objects.XObject;
< import javax.xml.parsers.*;
< import javax.xml.transform.TransformerException;
< import org.xml.sax.SAXException;
---
> import java.io.OutputStream;
> 
> import javax.xml.parsers.DocumentBuilderFactory;
> import javax.xml.parsers.ParserConfigurationException;
> 
> import org.apache.xml.security.c14n.CanonicalizationException;
76,78c32,34
< import org.apache.xml.security.c14n.Canonicalizer;
< import org.apache.xml.security.c14n.CanonicalizationException;
< import org.apache.xml.security.c14n.InvalidCanonicalizerException;
---
> import org.apache.xml.security.transforms.TransformSpi;
> import org.apache.xml.security.transforms.TransformationException;
> import org.apache.xml.security.transforms.Transforms;
80,84c36,40
< import org.apache.xml.security.utils.Constants;
< import org.apache.xml.security.utils.XMLUtils;
< import org.apache.xml.security.transforms.*;
< import org.apache.xml.dtm.DTMManager;
< import org.apache.xpath.CachedXPathAPI;
---
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.Node;
> import org.w3c.dom.Text;
> import org.xml.sax.SAXException;
122c78
<     * @return
---
>     * @inheritDoc
125c81
<       return this.implementedTransformURI;
---
>       return TransformBase64Decode.implementedTransformURI;
128a85
>    /** @inheritDoc */
129a87
>    /** @inheritDoc */
130a89
>    /** @inheritDoc */
131a91
>    /** @inheritDoc */
139a100
>     * @inheritDoc
142d102
<     * @throws InvalidCanonicalizerException
147,157c107,118
<                   TransformationException, InvalidCanonicalizerException {
< 
<       if (input.isOctetStream()) {
<          try {
<             byte[] base64Bytes = input.getBytes();
<             byte[] decodedBytes = Base64.decode(base64Bytes);
< 
<             return new XMLSignatureInput(
<                new ByteArrayInputStream(decodedBytes));
<          } catch (Base64DecodingException ex) {
<             throw new TransformationException("empty", ex);
---
>                   TransformationException {
>    	return enginePerformTransform(input,null);
>    }
>     protected XMLSignatureInput enginePerformTransform(XMLSignatureInput input,
>             OutputStream os)
>     throws IOException, CanonicalizationException,
>            TransformationException {
> 	 try {
>       if (input.isElement()) {
>          Node el=input.getSubNode();
>          if (input.getSubNode().getNodeType()==Node.TEXT_NODE) {         	
>             el=el.getParentNode();
159,160c120,151
<       } else {
<          try {
---
>          StringBuffer sb=new StringBuffer();
>          traverseElement((Element)el,sb);
>          if (os==null) {
>          	byte[] decodedBytes = Base64.decode(sb.toString());            
>          	return new XMLSignatureInput(decodedBytes);
>          } 
>          	Base64.decode(sb.toString().getBytes(),os);
>             XMLSignatureInput output=new XMLSignatureInput((byte[])null);
>             output.setOutputStream(os);
>             return output;
>          
>       }
>       if (input.isOctetStream() || input.isNodeSet()) {
>                     
>         
>         if (os==null) {
>             byte[] base64Bytes = input.getBytes();
>             byte[] decodedBytes = Base64.decode(base64Bytes);            
>             return new XMLSignatureInput(decodedBytes);
>          } 
>             Base64.decode(new BufferedInputStream(input.getOctetStreamReal())
>                     ,os);
>             XMLSignatureInput output=new XMLSignatureInput((byte[])null);
>             output.setOutputStream(os);
>             return output;
>          
>         
>       } 
>        
> 	 try {
>             //Exceptional case there is current not text case testing this(Before it was a
> 	 	    //a common case).
162,172c153,156
<                DocumentBuilderFactory.newInstance().newDocumentBuilder()
<                   .parse(input.getOctetStream());
<             DocumentTraversal dt = ((DocumentTraversal) doc);
<             Node rootNode = (Node) doc;
< 
<             // we accept all nodes
<             NodeFilter nodefilter =
<                new org.apache.xml.security.c14n.helper.AlwaysAcceptNodeFilter();
<             TreeWalker treewalker = dt.createTreeWalker(rootNode,
<                                                         NodeFilter.SHOW_ALL,
<                                                         nodefilter, true);
---
>                DocumentBuilderFactory.newInstance().newDocumentBuilder().parse(
>                   input.getOctetStream());
>                   
>             Element rootNode = doc.getDocumentElement();
174,176c158
< 
<             process(treewalker, sb);
< 
---
>             traverseElement(rootNode,sb);
178,190c160,169
< 
<             return new XMLSignatureInput(
<                new ByteArrayInputStream(decodedBytes));
<          } catch (ParserConfigurationException e) {
<             throw new TransformationException("c14n.Canonicalizer.Exception",
<                                               e);
<          } catch (SAXException e) {
<             throw new TransformationException("c14n.Canonicalizer.Exception",
<                                               e);
<          } catch (Base64DecodingException ex) {
<             throw new TransformationException("empty", ex);
<          }
<       }
---
> 			
>             return new XMLSignatureInput(decodedBytes);
> 		  } catch (ParserConfigurationException e) {
> 			  throw new TransformationException("c14n.Canonicalizer.Exception",e);
> 		  } catch (SAXException e) {
> 			  throw new TransformationException("SAX exception", e);
> 		  }      
> 	} catch (Base64DecodingException e) {
>         throw new TransformationException("Base64Decoding", e);
> 	}
193,213c172,184
<    /**
<     * Method process
<     *
<     * @param treewalker
<     * @param sb
<     */
<    private void process(TreeWalker treewalker, StringBuffer sb) {
< 
<       Node currentNode = treewalker.getCurrentNode();
< 
<       if (currentNode.getNodeType() == Node.TEXT_NODE) {
<          sb.append(((Text) currentNode).getData());
<       }
< 
<       for (Node node1 = treewalker.firstChild(); node1 != null;
<               node1 = treewalker.nextSibling()) {
<          process(treewalker, sb);
<       }
< 
<       treewalker.setCurrentNode(currentNode);
<    }
---
>    void traverseElement(org.w3c.dom.Element node,StringBuffer sb) {
>    	    Node sibling=node.getFirstChild();
>         while (sibling!=null) {
>         	switch (sibling.getNodeType()) {
>         		case Node.ELEMENT_NODE:
>                     traverseElement((Element)sibling,sb);
>                     break;
>                case Node.TEXT_NODE:
>                	    sb.append(((Text)sibling).getData());
>             }
>             sibling=sibling.getNextSibling();
>         }
>    }  
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/implementations/TransformC14NExclusive.java xml-security-1_2_0/src/org/apache/xml/security/transforms/implementations/TransformC14NExclusive.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64,65c22,27
< import java.io.ByteArrayInputStream;
< import org.apache.xml.security.signature.XMLSignatureInput;
---
> import java.io.OutputStream;
> 
> import javax.xml.parsers.ParserConfigurationException;
> 
> import org.apache.xml.security.c14n.CanonicalizationException;
> import org.apache.xml.security.c14n.implementations.Canonicalizer20010315ExclOmitComments;
67,70c29,31
< import org.apache.xml.security.utils.Constants;
< import org.apache.xml.security.c14n.*;
< import org.apache.xml.security.c14n.implementations.*;
< import org.apache.xml.security.transforms.*;
---
> import org.apache.xml.security.signature.XMLSignatureInput;
> import org.apache.xml.security.transforms.TransformSpi;
> import org.apache.xml.security.transforms.Transforms;
72c33,34
< import javax.xml.parsers.ParserConfigurationException;
---
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Element;
74d35
< import org.w3c.dom.*;
80,81c41,42
<  * @author $Author: dohy $
<  * @version $Revision: 1.1.1.1 $
---
>  * @author $Author: raul $
>  * @version $Revision: 1.9 $
89a51
>    /** @inheritDoc */
90a53
>    /** @inheritDoc */
91a55
>    /** @inheritDoc */
92a57
>    /** @inheritDoc */
99c64
<     * @return
---
>     * @inheritDoc 
102c67
<       return this.implementedTransformURI;
---
>       return implementedTransformURI;
109c74
<     * @return
---
>     * @return the transformed of the input
111d75
<     * @throws InvalidCanonicalizerException
114,115c78,82
<            throws CanonicalizationException, InvalidCanonicalizerException {
< 
---
>            throws CanonicalizationException {
>    	    return enginePerformTransform(input,null);
>    }
>     protected XMLSignatureInput enginePerformTransform(XMLSignatureInput input,OutputStream os)
>     throws CanonicalizationException {
117c84
<          InclusiveNamespaces inclusiveNamespaces = null;
---
>          String inclusiveNamespaces = null;
124c91,92
<                this._transformObject.getChildElementLocalName(0,
---
>                 XMLUtils.selectNode(
>                this._transformObject.getElement().getFirstChild(),
126c94
<                   InclusiveNamespaces._TAG_EC_INCLUSIVENAMESPACES);
---
>                   InclusiveNamespaces._TAG_EC_INCLUSIVENAMESPACES,0);
129c97
<                     this._transformObject.getBaseURI());
---
>                     this._transformObject.getBaseURI()).getInclusiveNamespaces();
134c102,105
< 
---
>          if (os!=null) {
>             c14n.setWriter(os);
>          }
>          byte []result;
136,143c107,115
<             return new XMLSignatureInput(c14n
<                .engineCanonicalize(input.getBytes()));
<          } else {
<             if (inclusiveNamespaces == null) {
<                return new XMLSignatureInput(c14n
<                   .engineCanonicalizeXPathNodeSet(input.getNodeSet()));
<             } else {
<                return new XMLSignatureInput(c14n
---
>             result=c14n.engineCanonicalize(input.getBytes());
>          } else if (input.isElement()) {
>             		org.w3c.dom.Node excl=input.getExcludeNode();
>             		result =c14n
>                             .engineCanonicalizeSubTree(input
>                                .getSubNode(), inclusiveNamespaces
>                                ,excl);
>            }    else {
>                result = c14n
146,147c118,122
<                      .getInclusiveNamespaces()));
<             }
---
>                      );      
>            }
>          XMLSignatureInput output=new XMLSignatureInput(result);
>          if (os!=null) {
>             output.setOutputStream(os);
148a124
>          return output;
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/implementations/TransformC14NExclusiveWithComments.java xml-security-1_2_0/src/org/apache/xml/security/transforms/implementations/TransformC14NExclusiveWithComments.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64,65c22,27
< import java.io.ByteArrayInputStream;
< import org.apache.xml.security.signature.XMLSignatureInput;
---
> import java.io.OutputStream;
> 
> import javax.xml.parsers.ParserConfigurationException;
> 
> import org.apache.xml.security.c14n.CanonicalizationException;
> import org.apache.xml.security.c14n.implementations.Canonicalizer20010315ExclWithComments;
67,70c29,31
< import org.apache.xml.security.utils.Constants;
< import org.apache.xml.security.c14n.*;
< import org.apache.xml.security.c14n.implementations.*;
< import org.apache.xml.security.transforms.*;
---
> import org.apache.xml.security.signature.XMLSignatureInput;
> import org.apache.xml.security.transforms.TransformSpi;
> import org.apache.xml.security.transforms.Transforms;
72c33,34
< import javax.xml.parsers.ParserConfigurationException;
---
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Element;
74d35
< import org.w3c.dom.*;
89a51
>    /** @inheritDoc */
90a53
>    /** @inheritDoc */
91a55
>    /** @inheritDoc */
92a57
>    /** @inheritDoc */
97a63
>     *@inheritDoc 
99d64
<     * @return
102c67
<       return this.implementedTransformURI;
---
>       return implementedTransformURI;
106,111c71
<     * Method enginePerformTransform
<     *
<     * @param input
<     * @return
<     * @throws CanonicalizationException
<     * @throws InvalidCanonicalizerException
---
>     * @inheritDoc 
114,126c74,94
<            throws CanonicalizationException, InvalidCanonicalizerException {
< 
<       try {
<          Element inclusiveElement =
<             this._transformObject.getChildElementLocalName(0,
<                InclusiveNamespaces.ExclusiveCanonicalizationNamespace,
<                InclusiveNamespaces._TAG_EC_INCLUSIVENAMESPACES);
<          InclusiveNamespaces inclusiveNamespaces = null;
< 
<          if (inclusiveElement != null) {
<             inclusiveNamespaces = new InclusiveNamespaces(inclusiveElement,
<                     this._transformObject.getBaseURI());
<          }
---
>            throws CanonicalizationException {
>    	    return enginePerformTransform(input,null);
>    }
>     protected XMLSignatureInput enginePerformTransform(XMLSignatureInput input,OutputStream os)
>     throws CanonicalizationException {
>      try {
>         String inclusiveNamespaces = null;
> 
>         if (this._transformObject
>                 .length(InclusiveNamespaces
>                    .ExclusiveCanonicalizationNamespace, InclusiveNamespaces
>                    ._TAG_EC_INCLUSIVENAMESPACES) == 1) {
>            Element inclusiveElement =
>                XMLUtils.selectNode(
>               this._transformObject.getElement().getFirstChild(),
>                  InclusiveNamespaces.ExclusiveCanonicalizationNamespace,
>                  InclusiveNamespaces._TAG_EC_INCLUSIVENAMESPACES,0);
> 
>            inclusiveNamespaces = new InclusiveNamespaces(inclusiveElement,
>                    this._transformObject.getBaseURI()).getInclusiveNamespaces();
>         }
128c96
<          Canonicalizer20010315ExclWithComments c14n =
---
>         Canonicalizer20010315ExclWithComments c14n =
130,153c98,130
< 
<          if (input.isOctetStream()) {
<             return new XMLSignatureInput(c14n
<                .engineCanonicalize(input.getBytes()));
<          } else {
<             if (inclusiveNamespaces == null) {
<                return new XMLSignatureInput(c14n
<                   .engineCanonicalizeXPathNodeSet(input.getNodeSet()));
<             } else {
<                return new XMLSignatureInput(c14n
<                   .engineCanonicalizeXPathNodeSet(input
<                      .getNodeSet(), inclusiveNamespaces
<                      .getInclusiveNamespaces()));
<             }
<          }
<       } catch (IOException ex) {
<          throw new CanonicalizationException("empty", ex);
<       } catch (ParserConfigurationException ex) {
<          throw new CanonicalizationException("empty", ex);
<       } catch (XMLSecurityException ex) {
<          throw new CanonicalizationException("empty", ex);
<       } catch (SAXException ex) {
<          throw new CanonicalizationException("empty", ex);
<       }
---
>          c14n.set_includeComments(!input.isExcludeComments());
>         if (os!=null) {
>            c14n.setWriter( os);
>         }
>         byte []result;
>         if (input.isOctetStream()) {
>            result=c14n.engineCanonicalize(input.getBytes());
>         } else if (input.isElement()) {
>                 org.w3c.dom.Node excl=input.getExcludeNode();
>                 result =c14n
>                            .engineCanonicalizeSubTree(input
>                               .getSubNode(), inclusiveNamespaces
>                               ,excl);
>           }    else {
>               result = c14n
>                  .engineCanonicalizeXPathNodeSet(input
>                     .getNodeSet(), inclusiveNamespaces
>                     );      
>           }
>         XMLSignatureInput output=new XMLSignatureInput(result);
>         if (os!=null) {
>            output.setOutputStream(os);
>         }
>         return output;
>      } catch (IOException ex) {
>         throw new CanonicalizationException("empty", ex);
>      } catch (ParserConfigurationException ex) {
>         throw new CanonicalizationException("empty", ex);
>      } catch (XMLSecurityException ex) {
>         throw new CanonicalizationException("empty", ex);
>      } catch (SAXException ex) {
>         throw new CanonicalizationException("empty", ex);
>      }
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/implementations/TransformC14N.java xml-security-1_2_0/src/org/apache/xml/security/transforms/implementations/TransformC14N.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64,69c22,24
< import java.io.ByteArrayInputStream;
< import org.apache.xml.security.signature.XMLSignatureInput;
< import org.apache.xml.security.utils.Constants;
< import org.apache.xml.security.c14n.*;
< import org.apache.xml.security.c14n.implementations.*;
< import org.apache.xml.security.transforms.*;
---
> import java.io.OutputStream;
> import java.util.Set;
> 
70a26,32
> 
> import org.apache.xml.security.c14n.CanonicalizationException;
> import org.apache.xml.security.c14n.implementations.Canonicalizer20010315OmitComments;
> import org.apache.xml.security.signature.XMLSignatureInput;
> import org.apache.xml.security.transforms.TransformSpi;
> import org.apache.xml.security.transforms.Transforms;
> import org.w3c.dom.Node;
86a49
>    /** @inheritDoc */
87a51
>    /** @inheritDoc */
88a53
>    /** @inheritDoc */
89a55
>    /** @inheritDoc */
94,96c60
<     * Method engineGetURI
<     *
<     * @return
---
>     * @inheritDoc 
99c63
<       return this.implementedTransformURI;
---
>       return TransformC14N.implementedTransformURI;
103,111c67
<     * Method enginePerformTransform
<     *
<     * @param input
<     * @return
<     * @throws CanonicalizationException
<     * @throws IOException
<     * @throws InvalidCanonicalizerException
<     * @throws ParserConfigurationException
<     * @throws SAXException
---
>     *  @inheritDoc 
114,117c70,74
<            throws IOException, CanonicalizationException,
<                   InvalidCanonicalizerException, ParserConfigurationException,
<                   SAXException {
< 
---
>            throws IOException, CanonicalizationException {
>    	    return enginePerformTransform(input,null);
>    }
>     protected XMLSignatureInput enginePerformTransform(XMLSignatureInput input,OutputStream os)
>     throws IOException, CanonicalizationException {
119a77,79
>          if (os!=null) {
>          	c14n.setWriter(os);
>          }
124c84,94
<             result = c14n.engineCanonicalizeXPathNodeSet(input.getNodeSet());
---
>          	if (input.isElement()) {
>          		Node excl=input.getExcludeNode();
>          		result=c14n.engineCanonicalizeSubTree(input.getSubNode(),excl);         		
>          	} else {
>                 Set set=input.getNodeSet(true);                
>          		result = c14n.engineCanonicalizeXPathNodeSet(set);
>             }
>          }
>          XMLSignatureInput output=new XMLSignatureInput(result);
>          if (os!=null) {
>             output.setOutputStream(os);
126c96
<          return new XMLSignatureInput(result);
---
>          return output;
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/implementations/TransformC14NWithComments.java xml-security-1_2_0/src/org/apache/xml/security/transforms/implementations/TransformC14NWithComments.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64,69c22,24
< import java.io.ByteArrayInputStream;
< import org.apache.xml.security.signature.XMLSignatureInput;
< import org.apache.xml.security.utils.Constants;
< import org.apache.xml.security.c14n.*;
< import org.apache.xml.security.c14n.implementations.*;
< import org.apache.xml.security.transforms.*;
---
> import java.io.OutputStream;
> import java.util.Set;
> 
70a26,32
> 
> import org.apache.xml.security.c14n.CanonicalizationException;
> import org.apache.xml.security.c14n.implementations.Canonicalizer20010315WithComments;
> import org.apache.xml.security.signature.XMLSignatureInput;
> import org.apache.xml.security.transforms.TransformSpi;
> import org.apache.xml.security.transforms.Transforms;
> import org.w3c.dom.Node;
86a49
>    /** @inheritDoc */
87a51
>    /** @inheritDoc */
88a53
>    /** @inheritDoc */
89a55
>    /** @inheritDoc */
93,97c59
<    /**
<     * Method engineGetURI
<     *
<     * @return
<     */
---
>    /** @inheritDoc */
99c61
<       return this.implementedTransformURI;
---
>       return implementedTransformURI;
101,112c63
< 
<    /**
<     * Method enginePerformTransform
<     *
<     * @param input
<     * @return
<     * @throws CanonicalizationException
<     * @throws IOException
<     * @throws InvalidCanonicalizerException
<     * @throws ParserConfigurationException
<     * @throws SAXException
<     */
---
>    /** @inheritDoc */
114,116c65,70
<            throws IOException, CanonicalizationException,
<                   InvalidCanonicalizerException, ParserConfigurationException,
<                   SAXException {
---
>    throws IOException, CanonicalizationException {
>    	    return enginePerformTransform(input,null);
>    }
>    /** @inheritDoc */
>    protected XMLSignatureInput enginePerformTransform(XMLSignatureInput input,OutputStream os)
>            throws IOException, CanonicalizationException {
119a74,77
>         if (os!=null) {
>         	c14n.setWriter( os);
>         }
>         c14n.set_includeComments(!input.isExcludeComments());
124c82,92
<             result = c14n.engineCanonicalizeXPathNodeSet(input.getNodeSet());
---
>          	if (input.isElement()) {
>          		Node excl=input.getExcludeNode();         		
>          		result=c14n.engineCanonicalizeSubTree(input.getSubNode(),excl);         		
>          	} else {
>                 Set set=input.getNodeSet(true);                
>          		result = c14n.engineCanonicalizeXPathNodeSet(set);
>          	}
>          }
>          XMLSignatureInput output=new XMLSignatureInput(result);
>          if (os!=null) {
>          	output.setOutputStream(os);
126c94
<          return new XMLSignatureInput(result);
---
>          return output;
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/implementations/TransformEnvelopedSignature.java xml-security-1_2_0/src/org/apache/xml/security/transforms/implementations/TransformEnvelopedSignature.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64c22,23
< import java.util.*;
---
> import java.util.Set;
> 
66,69c25,26
< import javax.xml.transform.TransformerException;
< import org.apache.xml.security.c14n.*;
< import org.apache.xml.security.transforms.params.XPathContainer;
< import org.apache.xml.security.exceptions.*;
---
> 
> import org.apache.xml.security.c14n.CanonicalizationException;
71,79c28,34
< import org.apache.xml.security.transforms.*;
< import org.apache.xml.security.utils.*;
< import org.apache.xml.utils.PrefixResolver;
< import org.apache.xml.utils.PrefixResolverDefault;
< import org.apache.xpath.CachedXPathAPI;
< import org.apache.xpath.XPathContext;
< import org.apache.xpath.XPath;
< import org.apache.xpath.objects.XObject;
< import org.w3c.dom.*;
---
> import org.apache.xml.security.transforms.TransformSpi;
> import org.apache.xml.security.transforms.TransformationException;
> import org.apache.xml.security.transforms.Transforms;
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Element;
> import org.w3c.dom.Node;
81d35
< import org.apache.xml.dtm.DTMManager;
96a51
>    /** @inheritDoc */
97a53
>    /** @inheritDoc */
98a55
>    /** @inheritDoc */
99a57
>    /** @inheritDoc */
106c64
<     * @return
---
>     * @inheritDoc
109c67
<       return this.implementedTransformURI;
---
>       return implementedTransformURI;
113,117c71
<     * This transform performs the Enveloped-Signature-Transform by
<     *
<     * @param input
<     * @return
<     * @throws TransformationException
---
>     * @inheritDoc
141,148c95
<          Set inputSet = input.getNodeSet();
< 
<          if (inputSet.isEmpty()) {
<             Object exArgs[] = { "input node set contains no nodes" };
< 
<             throw new TransformationException("generic.EmptyMessage", exArgs);
<          }
< 
---
>          
151,163c98
<          boolean found = false;
< 
<          searchSignatureElemLoop: while (true) {
<             if ((signatureElement == null)
<                     || (signatureElement.getNodeType() == Node.DOCUMENT_NODE)) {
<                break searchSignatureElemLoop;
<             }
< 
<             if (((Element) signatureElement).getNamespaceURI()
<                     .equals(Constants
<                     .SignatureSpecNS) && ((Element) signatureElement)
<                        .getLocalName().equals(Constants._TAG_SIGNATURE)) {
<                found = true;
---
>          
165,180c100,105
<                break searchSignatureElemLoop;
<             }
< 
<             signatureElement = signatureElement.getParentNode();
<          }
< 
<          if (!found) {
<             throw new TransformationException(
<                "envelopedSignatureTransformNotInSignatureElement");
<          }
< 
<          Document transformDoc = transformElement.getOwnerDocument();
<          Document inputDoc = XMLUtils.getOwnerDocument((Node) inputSet.iterator().next());
< 
<          if (transformDoc != inputDoc) {
<             throw new TransformationException("xpath.funcHere.documentsDiffer");
---
>          signatureElement = searchSignatureElement(signatureElement);
>          if (input.isElement()) {
>          	XMLSignatureInput result = new XMLSignatureInput(input.getSubNode(),input.getCachedXPathAPI());
>          	result.setExcludeNode(signatureElement);
>          	result.setExcludeComments(input.isExcludeComments());
>          	return result;
181a107,108
>          //
>          Set inputSet = input.getNodeSet();
183,187c110,111
<          Set resultSet = new HashSet();
<          Iterator iterator = inputSet.iterator();
< 
<          while (iterator.hasNext()) {
<             Node inputNode = (Node) iterator.next();
---
>          if (inputSet.isEmpty()) {
>             Object exArgs[] = { "input node set contains no nodes" };
189,192c113
<             if (!TransformEnvelopedSignature
<                     .isDescendantOrSelf(signatureElement, inputNode)) {
<                resultSet.add(inputNode);
<             }
---
>             throw new TransformationException("generic.EmptyMessage", exArgs);
193a115,116
>          
>          Set resultSet=XMLUtils.excludeNodeFromSet(signatureElement, inputSet);
196c119
<                                        input.getCachedXPathAPI());
---
>                                        null/*input.getCachedXPathAPI()*/);
207,209c130
<       } catch (InvalidCanonicalizerException ex) {
<          throw new TransformationException("empty", ex);
<       }
---
>       } 
213,217c134
<     * Returns true if the descendantOrSelf is on the descendant-or-self axis
<     * of the context node.
<     *
<     * @param ctx
<     * @param descendantOrSelf
---
>     * @param signatureElement    
218a136
>     * @throws TransformationException
220,243c138,162
<    static boolean isDescendantOrSelf(Node ctx, Node descendantOrSelf) {
< 
<       if (ctx == descendantOrSelf) {
<          return true;
<       }
< 
<       Node parent = descendantOrSelf;
< 
<       while (true) {
<          if (parent == null) {
<             return false;
<          }
< 
<          if (parent == ctx) {
<             return true;
<          }
< 
<          if (parent.getNodeType() == Node.ATTRIBUTE_NODE) {
<             parent = ((Attr) parent).getOwnerElement();
<          } else {
<             parent = parent.getParentNode();
<          }
<       }
<    }
---
>     private static Node searchSignatureElement(Node signatureElement) throws TransformationException {
> 	    boolean found=false;
>         
> 	    while (true) {
> 	    	if ((signatureElement == null)
> 	            || (signatureElement.getNodeType() == Node.DOCUMENT_NODE)) {
> 	    		break;
> 	    	}
> 	    	Element el=(Element)signatureElement;
> 	    	if (el.getNamespaceURI().equals(Constants.SignatureSpecNS)
>                     && 
> 	               el.getLocalName().equals(Constants._TAG_SIGNATURE)) {
> 	    		found = true;
> 	    		break;
> 	    	}
> 
> 	    	signatureElement = signatureElement.getParentNode();
> 	    }
> 
> 	    if (!found) {
> 	      throw new TransformationException(
> 	       "envelopedSignatureTransformNotInSignatureElement");
> 	    }
> 	    return signatureElement;
>     }
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/implementations/TransformXPath2Filter04.java xml-security-1_2_0/src/org/apache/xml/security/transforms/implementations/TransformXPath2Filter04.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63d20
< import java.util.*;
64a22,25
> import java.util.HashSet;
> import java.util.Iterator;
> import java.util.Set;
> 
67,68c28,32
< import org.xml.sax.SAXException;
< import org.w3c.dom.*;
---
> 
> import org.apache.xml.security.c14n.CanonicalizationException;
> import org.apache.xml.security.c14n.Canonicalizer;
> import org.apache.xml.security.c14n.InvalidCanonicalizerException;
> import org.apache.xml.security.exceptions.XMLSecurityException;
70c34,36
< import org.apache.xml.security.c14n.*;
---
> import org.apache.xml.security.transforms.TransformSpi;
> import org.apache.xml.security.transforms.TransformationException;
> import org.apache.xml.security.transforms.Transforms;
72,74c38,39
< import org.apache.xml.security.transforms.*;
< import org.apache.xml.security.exceptions.*;
< import org.apache.xml.security.utils.*;
---
> import org.apache.xml.security.utils.CachedXPathFuncHereAPI;
> import org.apache.xml.security.utils.XMLUtils;
76,79c41,46
< import org.apache.xpath.objects.XObject;
< import org.apache.xml.utils.PrefixResolverDefault;
< import org.apache.xml.utils.PrefixResolver;
< import org.apache.xml.dtm.DTMManager;
---
> import org.w3c.dom.DOMException;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.Node;
> import org.w3c.dom.NodeList;
> import org.xml.sax.SAXException;
85c52
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
87c54
<  * @see <A HREF=http://www.w3.org/Signature/Drafts/xmldsig-xfilter2/">XPath Filter v2.0 (editors copy)</A>
---
>  * @see <A HREF="http://www.w3.org/Signature/Drafts/xmldsig-xfilter2/">XPath Filter v2.0 (editors copy)</A>
91,94c58,61
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category
<          .getInstance(TransformXPath2Filter04.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(
>                         TransformXPath2Filter04.class.getName());
100a68
>    /** @inheritDoc */
101a70
>    /** @inheritDoc */
102a72
>    /** @inheritDoc */
103a74
>    /** @inheritDoc */
110c81
<     * @return
---
>     * @inheritDoc
113c84
<       return this.implementedTransformURI;
---
>       return implementedTransformURI;
116,122c87
<    /**
<     * Method enginePerformTransform
<     *
<     * @param input
<     * @return
<     * @throws TransformationException
<     */
---
>    /** @inheritDoc */
128,129c93,94
< 
<          cat.debug("perform xfilter2 on " + inputSet.size() + " nodes");
---
>          if (log.isDebugEnabled())
>          	log.debug("perform xfilter2 on " + inputSet.size() + " nodes");
132c97
<             new CachedXPathFuncHereAPI(input.getCachedXPathAPI());
---
>             new CachedXPathFuncHereAPI(input.getCachedXPathAPI().getCachedXPathAPI());
134c99
<             new CachedXPathAPI(input.getCachedXPathAPI());
---
>             new CachedXPathAPI(input.getCachedXPathAPI().getCachedXPathAPI());
142,143c107,108
<          Element xpathElement =
<             this._transformObject.getChildElementLocalName(0,
---
>          Element xpathElement =XMLUtils.selectNode(
>             this._transformObject.getElement().getFirstChild(),
145c110
<                XPath2FilterContainer04._TAG_XPATH2);
---
>                XPath2FilterContainer04._TAG_XPATH2,0);
153,162d117
<          Document inputDoc = null;
< 
<          {
<             Iterator it = inputSet.iterator();
< 
<             if (it.hasNext()) {
<                inputDoc = XMLUtils.getOwnerDocument((Node) it.next());
<             }
<          }
< 
168a124
>                                     CachedXPathFuncHereAPI.getStrFromNode(xpathContainer.getXPathFilterTextNode()),
170,171c126,127
< 
<          cat.debug("subtreeRoots contains " + subtreeRoots.getLength()
---
>          if (log.isDebugEnabled())
>          	log.debug("subtreeRoots contains " + subtreeRoots.getLength()
204,205c160,161
< 
<          cat.debug("selection process identified " + selectedNodes.size()
---
>          if (log.isDebugEnabled())
>          	log.debug("selection process identified " + selectedNodes.size()
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/implementations/TransformXPath2Filter.java xml-security-1_2_0/src/org/apache/xml/security/transforms/implementations/TransformXPath2Filter.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63d20
< import java.util.*;
64a22,27
> import java.util.ArrayList;
> import java.util.HashSet;
> import java.util.Iterator;
> import java.util.List;
> import java.util.Set;
> 
67,68c30,33
< import org.xml.sax.SAXException;
< import org.w3c.dom.*;
---
> 
> import org.apache.xml.security.c14n.CanonicalizationException;
> import org.apache.xml.security.c14n.InvalidCanonicalizerException;
> import org.apache.xml.security.exceptions.XMLSecurityException;
70c35,37
< import org.apache.xml.security.c14n.*;
---
> import org.apache.xml.security.transforms.TransformSpi;
> import org.apache.xml.security.transforms.TransformationException;
> import org.apache.xml.security.transforms.Transforms;
72,79c39,48
< import org.apache.xml.security.transforms.*;
< import org.apache.xml.security.exceptions.*;
< import org.apache.xml.security.utils.*;
< import org.apache.xpath.CachedXPathAPI;
< import org.apache.xpath.objects.XObject;
< import org.apache.xml.utils.PrefixResolverDefault;
< import org.apache.xml.utils.PrefixResolver;
< import org.apache.xml.dtm.DTMManager;
---
> import org.apache.xml.security.utils.CachedXPathFuncHereAPI;
> import org.apache.xml.security.utils.HelperNodeList;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.DOMException;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.NamedNodeMap;
> import org.w3c.dom.Node;
> import org.w3c.dom.NodeList;
> import org.xml.sax.SAXException;
85c54
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
87c56
<  * @see <A HREF=http://www.w3.org/Signature/Drafts/xmldsig-xfilter2/">XPath Filter v2.0 (editors copy)</A>
---
>  * @see <a HREF="http://www.w3.org/Signature/Drafts/xmldsig-xfilter2/">XPath Filter v2.0 (editors copy)</a>
91,92c60,63
<    /** {@link org.apache.log4j} logging facility */
<    // static org.apache.log4j.Category cat = org.apache.log4j.Category.getInstance(TransformXPath2Filter.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
> //    static org.apache.commons.logging.Log log = 
> //        org.apache.commons.logging.LogFactory.getLog(
> //                            TransformXPath2Filter.class.getName());
99c70
<    Vector _filterTypes = new Vector();
---
>    List _filterTypes = new ArrayList();
102c73
<    Vector _filterNodes = new Vector();
---
>    List _filterNodes = new ArrayList();
105c76
<    Vector _ancestors = null;
---
>    List _ancestors = null;
110a82
>    /** @inheritDoc */
111a84
>    /** @inheritDoc */
112a86
>    /** @inheritDoc */
113a88
>    /** @inheritDoc */
121c96
<     * @return
---
>     * @inheritDoc
124c99
<       return this.implementedTransformURI;
---
>       return implementedTransformURI;
131c106
<     *
---
>     * @inheritDoc
133c108
<     * @return
---
>     *
140d114
<          long start = System.currentTimeMillis();
151,154c125,132
<             new CachedXPathFuncHereAPI(input.getCachedXPathAPI());
<          CachedXPathAPI myXPathAPI =
<             new CachedXPathAPI(input.getCachedXPathAPI());
<          Document inputDoc = null;
---
>             new CachedXPathFuncHereAPI(input.getCachedXPathAPI().getCachedXPathAPI());
>          Document inputDoc = XMLUtils.getOwnerDocument(_inputSet);
>          
>          Element []xpathElements =XMLUtils.selectNodes(
>                 this._transformObject.getElement().getFirstChild(),
>                    XPath2FilterContainer.XPathFilter2NS,
>                    XPath2FilterContainer._TAG_XPATH2);
>          int noOfSteps = xpathElements.length;
156,164d133
<          {
<             Iterator it = this._inputSet.iterator();
< 
<             inputDoc = XMLUtils.getOwnerDocument((Node) it.next());
<          }
< 
<          int noOfSteps =
<             this._transformObject.length(Transforms.TRANSFORM_XPATH2FILTER,
<                                          "XPath");
173,176d141
<             XPath2FilterContainer unionDocFilter =
<                XPath2FilterContainer
<                   .newInstanceUnion(this._transformObject.getDocument(), "/");
< 
187,188c152,153
<             Element xpathElement =
<                this._transformObject.getChildElementLocalName(i,
---
>             Element xpathElement =XMLUtils.selectNode(
>                this._transformObject.getElement().getFirstChild(),
190c155
<                   XPath2FilterContainer._TAG_XPATH2);
---
>                   XPath2FilterContainer._TAG_XPATH2,i);
206a172
>                                        CachedXPathFuncHereAPI.getStrFromNode(xpathContainer.getXPathFilterTextNode()),
214c180
<          this._ancestors = new Vector();
---
>          this._ancestors = new ArrayList();
221c187
<             Node n = (Node) it.next();
---
>             Object n = it.next();
233,234d198
<          long end = System.currentTimeMillis();
< 
259d222
<     * @param Z
271,272c234,235
<          NodeList rootNodes = (NodeList) this._filterNodes.elementAt(i);
<          String type = (String) this._filterTypes.elementAt(i);
---
>          NodeList rootNodes = (NodeList) this._filterNodes.get(i);
>          String type = (String) this._filterTypes.get(i);
275c238
<                  && rooted(currentNode, this._ancestors, rootNodes)) {
---
>                  && rooted(/*currentNode,*/ this._ancestors, rootNodes)) {
279c242
<                cat.debug(i + " " + ((Element) currentNode).getTagName()
---
>                log.debug(i + " " + ((Element) currentNode).getTagName()
297,299c260,262
<          NodeList rootNodes = (NodeList) this._filterNodes.elementAt(I);
<          String type = (String) this._filterTypes.elementAt(I);
<          boolean rooted = rooted(currentNode, this._ancestors, rootNodes);
---
>          NodeList rootNodes = (NodeList) this._filterNodes.get(I);
>          String type = (String) this._filterTypes.get(I);
>          boolean rooted = rooted(/*currentNode,*/ this._ancestors, rootNodes);
305c268
<                cat.debug("The intersect operation from step " + I
---
>                log.debug("The intersect operation from step " + I
316c279
<                cat.debug("The subtract operation from step " + I
---
>                log.debug("The subtract operation from step " + I
324c287
<             ;
---
> 			//do nothing
360d322
<     * @param currentNode
365c327
<    boolean rooted(Node currentNode, Vector ancestors, NodeList rootNodes) {
---
>    boolean rooted(/*Node currentNode,*/ List ancestors, NodeList rootNodes) {
374,407d335
<          }
<       }
< 
<       return false;
<    }
< 
<    /**
<     * Method __isRootedBy
<     *
<     * @param ctx
<     * @param rootInQuestion
<     * @return
<     */
<    private static boolean __isRootedBy(Node ctx, Node rootInQuestion) {
< 
<       if ((ctx == null) || (rootInQuestion == null)) {
<          return false;
<       }
< 
<       if (rootInQuestion.getNodeType() == Node.DOCUMENT_NODE) {
<          return true;
<       }
< 
<       Node n = ctx;
< 
<       while (n != null) {
<          if (n == rootInQuestion) {
<             return true;
<          }
< 
<          if (n.getNodeType() == Node.ATTRIBUTE_NODE) {
<             n = ((Attr) n).getOwnerElement();
<          } else {
<             n = n.getParentNode();
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/implementations/TransformXPathFilterCHGP.java xml-security-1_2_0/src/org/apache/xml/security/transforms/implementations/TransformXPathFilterCHGP.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,6
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
5,6c8
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
---
>  *      http://www.apache.org/licenses/LICENSE-2.0
8,10c10,14
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
---
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
12,57d15
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63d20
< import java.util.*;
64a22,26
> import java.util.HashSet;
> import java.util.Iterator;
> import java.util.Set;
> import java.util.Stack;
> 
67,69c29,32
< import org.xml.sax.SAXException;
< import org.w3c.dom.*;
< import org.w3c.dom.traversal.*;
---
> 
> import org.apache.xml.security.c14n.CanonicalizationException;
> import org.apache.xml.security.c14n.InvalidCanonicalizerException;
> import org.apache.xml.security.exceptions.XMLSecurityException;
71c34,36
< import org.apache.xml.security.c14n.*;
---
> import org.apache.xml.security.transforms.TransformSpi;
> import org.apache.xml.security.transforms.TransformationException;
> import org.apache.xml.security.transforms.Transforms;
73,80c38,49
< import org.apache.xml.security.transforms.*;
< import org.apache.xml.security.exceptions.*;
< import org.apache.xml.security.utils.*;
< import org.apache.xpath.CachedXPathAPI;
< import org.apache.xpath.objects.XObject;
< import org.apache.xml.utils.PrefixResolverDefault;
< import org.apache.xml.utils.PrefixResolver;
< import org.apache.xml.dtm.DTMManager;
---
> import org.apache.xml.security.utils.CachedXPathFuncHereAPI;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.DOMException;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.NamedNodeMap;
> import org.w3c.dom.Node;
> import org.w3c.dom.NodeList;
> import org.w3c.dom.traversal.DocumentTraversal;
> import org.w3c.dom.traversal.NodeFilter;
> import org.w3c.dom.traversal.TreeWalker;
> import org.xml.sax.SAXException;
84c53
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
92a62
>    /** @inheritDoc */
93a64
>    /** @inheritDoc */
94a66
>    /** @inheritDoc */
95a68
>    /** @inheritDoc */
128a102
>     * @inheritDoc
130d103
<     * @return
133c106
<       return this.implementedTransformURI;
---
>       return implementedTransformURI;
138c111
<     *
---
>     * @inheritDoc
140c113
<     * @return
---
>     *
150,152c123
<             new CachedXPathFuncHereAPI(input.getCachedXPathAPI());
<          CachedXPathAPI myXPathAPI =
<             new CachedXPathAPI(input.getCachedXPathAPI());
---
>             new CachedXPathFuncHereAPI(input.getCachedXPathAPI().getCachedXPathAPI());         
164,172c135,138
<          Element nscontext =
<             XMLUtils.createDSctx(doc, "dsig-xpathalt",
<                                  Transforms.TRANSFORM_XPATHFILTERCHGP);
<          Element xpathElement =
<             (Element) myXPathAPI
<                .selectSingleNode(transformElement, "./dsig-xpathalt:"
<                                  + XPathFilterCHGPContainer
<                                     ._TAG_XPATHCHGP, nscontext);
< 
---
>          Element xpathElement = XMLUtils.selectNode(transformElement.getFirstChild(),
>                 Transforms.TRANSFORM_XPATHFILTERCHGP,
>                 XPathFilterCHGPContainer._TAG_XPATHCHGP,0);
>             
174c140
<             Object exArgs[] = { "{" + this.implementedTransformURI + "}XPath",
---
>             Object exArgs[] = { "{" + TransformXPathFilterCHGP.implementedTransformURI + "}XPath",
204c170,171
<                        includeButSearchCtxNode, xpathContainer.getElement());
---
>                        includeButSearchCtxNode,CachedXPathFuncHereAPI.getStrFromNode(includeButSearchCtxNode),
>                        xpathContainer.getElement());
219c186,187
<                        excludeButSearchCtxNode, xpathContainer.getElement());
---
>                        excludeButSearchCtxNode,
>                        CachedXPathFuncHereAPI.getStrFromNode(excludeButSearchCtxNode),xpathContainer.getElement());
233c201,203
<                        excludeCtxNode, xpathContainer.getElement());
---
>                        excludeCtxNode, 
>                        CachedXPathFuncHereAPI.getStrFromNode(excludeCtxNode),
>                        xpathContainer.getElement());
251c221
<             Node rootNode = (Node) inputDoc;
---
>             Node rootNode =  inputDoc;
254,255c224
<             NodeFilter nodefilter =
<                new org.apache.xml.security.c14n.helper.AlwaysAcceptNodeFilter();
---
>             NodeFilter nodefilter = new AlwaysAcceptNodeFilter();
366c335
<     * @return
---
>     * @return 
371,373c340,343
<       int iMax = ((nl == null)
<                   ? 0
<                   : nl.getLength());
---
>       if (nl==null) {
>           return set; 
>       }
>       int iMax = nl.getLength();
379a350,362
>    }
> 
>    /**
>     * This {@link NodeFilter} always returns <code>true</code>
>     *
>     * @author Christian Geuer-Pollmann
>     */
>    public class AlwaysAcceptNodeFilter implements NodeFilter {
> 
>    	  /** @inheritDoc */
>       public short acceptNode(Node n) {
>          return NodeFilter.FILTER_ACCEPT;
>       }
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/implementations/TransformXPath.java xml-security-1_2_0/src/org/apache/xml/security/transforms/implementations/TransformXPath.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64c22,25
< import java.util.*;
---
> import java.util.HashSet;
> import java.util.Iterator;
> import java.util.Set;
> 
67,68c28,30
< import org.xml.sax.SAXException;
< import org.w3c.dom.*;
---
> 
> import org.apache.xml.security.c14n.CanonicalizationException;
> import org.apache.xml.security.exceptions.XMLSecurityException;
70,76c32,37
< import org.apache.xml.security.c14n.*;
< import org.apache.xml.security.transforms.params.XPathContainer;
< import org.apache.xml.security.transforms.*;
< import org.apache.xml.security.exceptions.*;
< import org.apache.xml.security.utils.*;
< import org.apache.xpath.CachedXPathAPI;
< import org.apache.xpath.objects.XObject;
---
> import org.apache.xml.security.transforms.TransformSpi;
> import org.apache.xml.security.transforms.TransformationException;
> import org.apache.xml.security.transforms.Transforms;
> import org.apache.xml.security.utils.CachedXPathFuncHereAPI;
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.XMLUtils;
78,79c39,43
< import org.apache.xml.utils.PrefixResolver;
< import org.apache.xml.dtm.DTMManager;
---
> import org.apache.xpath.objects.XObject;
> import org.w3c.dom.DOMException;
> import org.w3c.dom.Element;
> import org.w3c.dom.Node;
> import org.xml.sax.SAXException;
89c53
<  * @see http://www.w3.org/TR/1999/REC-xpath-19991116
---
>  * @see <a href="http://www.w3.org/TR/1999/REC-xpath-19991116">XPath</a>
94,95c58,60
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat = org.apache.log4j.Category.getInstance(TransformXPath.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(TransformXPath.class.getName());
101a67
>    /** @inheritDoc */
102a69
>    /** @inheritDoc */
103a71
>    /** @inheritDoc */
104a73
>    /** @inheritDoc */
111c80
<     * @return
---
>     * @inheritDoc
114c83
<       return this.implementedTransformURI;
---
>       return implementedTransformURI;
119c88
<     *
---
>     * @inheritDoc
121c90
<     * @return
---
>     *
140,144d108
<          Set inputSet = input.getNodeSet();
<          CachedXPathFuncHereAPI xPathFuncHereAPI =
<             new CachedXPathFuncHereAPI(input.getCachedXPathAPI());
<          CachedXPathAPI myXPathAPI =
<             new CachedXPathAPI(input.getCachedXPathAPI());
146,150c110,113
<          if (inputSet.size() == 0) {
<             Object exArgs[] = { "input node set contains no nodes" };
< 
<             throw new TransformationException("empty", exArgs);
<          }
---
>          
>          CachedXPathFuncHereAPI xPathFuncHereAPI =
>             new CachedXPathFuncHereAPI(input.getCachedXPathAPI().getCachedXPathAPI());
>          
152,154c115,117
<          Element xpathElement =
<             this._transformObject.getChildElementLocalName(0,
<                Constants.SignatureSpecNS, Constants._TAG_XPATH);
---
>          Element xpathElement =XMLUtils.selectDsNode(
>             this._transformObject.getElement().getFirstChild(),
>                Constants._TAG_XPATH,0);
160a124,129
>          Node xpathnode = xpathElement.getChildNodes().item(0);
>          String str=CachedXPathFuncHereAPI.getStrFromNode(xpathnode);
>          boolean circumvent=needsCircunvent(str);
>          Set inputSet = input.getNodeSet(circumvent);
>          if (inputSet.size() == 0) {
>             Object exArgs[] = { "input node set contains no nodes" };
161a131,133
>             throw new TransformationException("empty", exArgs);
>          }
>          
177,178c149,150
<          Node xpathnode = xpathElement.getChildNodes().item(0);
< 
---
>          
>          
185c157
< 
---
>          
194c166
<             */
---
>             */            
196,197c168,169
<                                          xpathnode, prefixResolver);
< 
---
>                                          xpathnode, str,prefixResolver);
>            
200c172
<                // cat.debug("    Added " + org.apache.xml.security.c14n.implementations.Canonicalizer20010315.getXPath(currentNode));
---
>                // log.debug("    Added " + org.apache.xml.security.c14n.implementations.Canonicalizer20010315.getXPath(currentNode));
202c174
<                // cat.debug("Not added " + org.apache.xml.security.c14n.implementations.Canonicalizer20010315.getXPath(currentNode));
---
>                // log.debug("Not added " + org.apache.xml.security.c14n.implementations.Canonicalizer20010315.getXPath(currentNode));
220,221d191
<       } catch (InvalidCanonicalizerException ex) {
<          throw new TransformationException("empty", ex);
229a200,207
>    /**
>     *  @param str
>     * @return
>     */
>     private boolean needsCircunvent(String str) {
>     	return true; //str.indexOf("namespace")>0;
>     	
>     }
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/implementations/TransformXPointer.java xml-security-1_2_0/src/org/apache/xml/security/transforms/implementations/TransformXPointer.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64,68c22
< import javax.xml.parsers.ParserConfigurationException;
< import org.xml.sax.SAXException;
< import org.w3c.dom.*;
< import org.apache.xml.security.c14n.CanonicalizationException;
< import java.io.IOException;
---
> 
70,71c24,27
< import org.apache.xml.security.utils.Constants;
< import org.apache.xml.security.transforms.*;
---
> import org.apache.xml.security.transforms.TransformSpi;
> import org.apache.xml.security.transforms.TransformationException;
> import org.apache.xml.security.transforms.Transforms;
> 
85a42
>    /** @inheritDoc */
86a44
>    /** @inheritDoc */
87a46
>    /** @inheritDoc */
88a48
>    /** @inheritDoc */
92,96c52
<    /**
<     * Method engineGetURI
<     *
<     * @return
<     */
---
>    /** @inheritDoc */
98c54
<       return this.implementedTransformURI;
---
>       return implementedTransformURI;
106,110c62,63
<     * @throws CanonicalizationException
<     * @throws IOException
<     * @throws NotYetImplementedException
<     * @throws ParserConfigurationException
<     * @throws SAXException
---
>     * @throws TransformationException
>     *
113,115c66
<            throws IOException, CanonicalizationException,
<                   ParserConfigurationException, SAXException,
<                   TransformationException {
---
>            throws  TransformationException {
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/implementations/TransformXSLT.java xml-security-1_2_0/src/org/apache/xml/security/transforms/implementations/TransformXSLT.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64c22,23
< import java.io.*;
---
> import java.io.ByteArrayInputStream;
> import java.io.ByteArrayOutputStream;
66,67c25,26
< import javax.xml.parsers.ParserConfigurationException;
< import javax.xml.transform.*;
---
> import java.io.OutputStream;
> 
68a28
> import javax.xml.transform.Transformer;
70a31
> import javax.xml.transform.TransformerFactory;
74,82c35,42
< import org.apache.xml.security.c14n.*;
< import org.apache.xml.security.c14n.CanonicalizationException;
< import org.apache.xml.security.exceptions.*;
< import org.apache.xml.security.signature.*;
< import org.apache.xml.security.transforms.*;
< import org.apache.xml.security.utils.*;
< import org.apache.xpath.XPathAPI;
< import org.w3c.dom.*;
< import org.xml.sax.SAXException;
---
> 
> import org.apache.xml.security.exceptions.XMLSecurityException;
> import org.apache.xml.security.signature.XMLSignatureInput;
> import org.apache.xml.security.transforms.TransformSpi;
> import org.apache.xml.security.transforms.TransformationException;
> import org.apache.xml.security.transforms.Transforms;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Element;
99,102c59,63
<    public static final String XSLTSpecNS              = "http://www.w3.org/1999/XSL/Transform";
<    public static final String defaultXSLTSpecNSprefix = "xslt";
<    public static final String XSLTSTYLESHEET          = "stylesheet";
< 
---
>    static final String XSLTSpecNS              = "http://www.w3.org/1999/XSL/Transform";
>    static final String defaultXSLTSpecNSprefix = "xslt";
>    static final String XSLTSTYLESHEET          = "stylesheet";
>    
>    /** @inheritDoc */
103a65
>    /** @inheritDoc */
104a67
>    /** @inheritDoc */
105a69
>    /** @inheritDoc */
112c76
<     * @return
---
>     * @inheritDoc
115c79
<       return this.implementedTransformURI;
---
>       return implementedTransformURI;
120c84
<     *
---
>     * 
123d86
<     * @throws CanonicalizationException
128c91
<            throws IOException, CanonicalizationException,
---
>            throws IOException,
130c93,97
< 
---
>    	return enginePerformTransform(input,null);
>    }
>     protected XMLSignatureInput enginePerformTransform(XMLSignatureInput input,OutputStream baos)
>     throws IOException,
>            TransformationException {
132,134c99
<          Element transformElement = this._transformObject.getElement();
<          Document doc = transformElement.getOwnerDocument();
<          Element nscontext = XMLUtils.createDSctx(doc, "xslt", XSLTSpecNS);
---
>          Element transformElement = this._transformObject.getElement();        
137,138c102,103
<             (Element) XPathAPI.selectSingleNode(transformElement,
<                                                 "./xslt:stylesheet", nscontext);
---
>             XMLUtils.selectNode(transformElement.getFirstChild(),
>                                                 XSLTSpecNS,"stylesheet", 0);
169c134
<             DOMSource source = new DOMSource((Node) _xsltElement);
---
>             DOMSource source = new DOMSource(_xsltElement);
179,182c144,148
<          ByteArrayOutputStream baos = new ByteArrayOutputStream();
<          StreamResult outputTarget = new StreamResult(baos);
< 
<          transformer.transform(xmlSource, outputTarget);
---
>          if (baos==null) {
>          	    ByteArrayOutputStream baos1 = new ByteArrayOutputStream();
>                StreamResult outputTarget = new StreamResult(baos1);
>                transformer.transform(xmlSource, outputTarget);
>                return new XMLSignatureInput(baos1.toByteArray());
184,186c150,151
<          return new XMLSignatureInput(baos.toByteArray());
<       } catch (InvalidCanonicalizerException ex) {
<          Object exArgs[] = { ex.getMessage() };
---
>          }
>          StreamResult outputTarget = new StreamResult(baos);
188c153,156
<          throw new TransformationException("generic.EmptyMessage", exArgs, ex);
---
>          transformer.transform(xmlSource, outputTarget);         
>          XMLSignatureInput output=new XMLSignatureInput((byte[])null);
>          output.setOutputStream(baos);
>          return output;
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/InvalidTransformException.java xml-security-1_2_0/src/org/apache/xml/security/transforms/InvalidTransformException.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights 
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer. 
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:  
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written 
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European 
<  * Commission in the <WebSig> project in the ISIS Programme. 
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
84c42
<     * @param msgID
---
>     * @param _msgId
86,87c44,45
<    public InvalidTransformException(String msgID) {
<       super(msgID);
---
>    public InvalidTransformException(String _msgId) {
>       super(_msgId);
93c51
<     * @param msgID
---
>     * @param _msgId
96,97c54,55
<    public InvalidTransformException(String msgID, Object exArgs[]) {
<       super(msgID, exArgs);
---
>    public InvalidTransformException(String _msgId, Object exArgs[]) {
>       super(_msgId, exArgs);
103,104c61,62
<     * @param msgID
<     * @param originalException
---
>     * @param _msgId
>     * @param _originalException
106,107c64,65
<    public InvalidTransformException(String msgID, Exception originalException) {
<       super(msgID, originalException);
---
>    public InvalidTransformException(String _msgId, Exception _originalException) {
>       super(_msgId, _originalException);
113c71
<     * @param msgID
---
>     * @param _msgId
115c73
<     * @param originalException
---
>     * @param _originalException
117,119c75,77
<    public InvalidTransformException(String msgID, Object exArgs[],
<                                     Exception originalException) {
<       super(msgID, exArgs, originalException);
---
>    public InvalidTransformException(String _msgId, Object exArgs[],
>                                     Exception _originalException) {
>       super(_msgId, exArgs, _originalException);
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/package.html xml-security-1_2_0/src/org/apache/xml/security/transforms/package.html
2c2
< the framework for XML Signature transforms
---
> the framework for XML Signature transforms.
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/params/InclusiveNamespaces.java xml-security-1_2_0/src/org/apache/xml/security/transforms/params/InclusiveNamespaces.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,66c21,26
< import java.io.*;
< import java.util.*;
< import org.w3c.dom.*;
< import org.apache.xml.security.utils.*;
---
> import java.util.Iterator;
> import java.util.Set;
> import java.util.SortedSet;
> import java.util.StringTokenizer;
> import java.util.TreeSet;
> 
69,72c29,31
< import org.apache.xml.security.transforms.TransformationException;
< import org.apache.xalan.extensions.ExpressionContext;
< import org.apache.xpath.NodeSet;
< import org.apache.xpath.XPathAPI;
---
> import org.apache.xml.security.utils.ElementProxy;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
119c78
<       List prefixList = new Vector(prefixes);
---
>       SortedSet prefixList = new TreeSet(prefixes);
121d79
<       Collections.sort(prefixList);
131,132c89
< 
<             sb.append(prefix.substring("xmlns:".length()) + " ");
---
>             sb.append(prefix + " ");
144c101
<     * @return
---
>     * @return The Inclusive Namespace string
173,174c130,131
<     * <LI><code>xmlns:xenc</code></LI>
<     * <LI><code>xmlns:ds</code></LI>
---
>     * <LI><code>xenc</code></LI>
>     * <LI><code>ds</code></LI>
178c135
<     * @return
---
>     * @return A set to string
180c137
<    public static Set prefixStr2Set(String inclusiveNamespaces) {
---
>    public static SortedSet prefixStr2Set(String inclusiveNamespaces) {
182c139
<       Set prefixes = new HashSet();
---
>       SortedSet prefixes = new TreeSet();
195c152
<             prefixes.add("xmlns" + "");
---
>             prefixes.add("xmlns" );
197c154
<             prefixes.add("xmlns:" + prefix);
---
>             prefixes.add( prefix);
207c164
<     * @return
---
>     * @inheritDoc
216c173
<     * @return
---
>     * @inheritDoc
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/params/XPath2FilterContainer04.java xml-security-1_2_0/src/org/apache/xml/security/transforms/params/XPath2FilterContainer04.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,65c21
< import org.w3c.dom.*;
< import org.apache.xml.security.utils.*;
< import org.apache.xml.security.exceptions.*;
---
> import org.apache.xml.security.exceptions.XMLSecurityException;
67,68c23,27
< import org.apache.xml.security.transforms.TransformationException;
< import org.apache.xml.security.transforms.Transforms;
---
> import org.apache.xml.security.utils.ElementProxy;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.Node;
> import org.w3c.dom.NodeList;
75c34
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
218a178
>     *
276c236
<     * @todo I dunno whether this crashes: <XPath> here()<!-- comment -->/ds:Signature[1]</XPath>
---
>     * $todo$ I dunno whether this crashes: <XPath> here()<!-- comment -->/ds:Signature[1]</XPath>
292,296c252
<    /**
<     * Method getBaseLocalName
<     *
<     * @return
<     */
---
>    /** @inheritDoc */
301,305c257
<    /**
<     * Method getBaseNamespace
<     *
<     * @return
<     */
---
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/params/XPath2FilterContainer.java xml-security-1_2_0/src/org/apache/xml/security/transforms/params/XPath2FilterContainer.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,65c21
< import org.w3c.dom.*;
< import org.apache.xml.security.utils.*;
< import org.apache.xml.security.exceptions.*;
---
> import org.apache.xml.security.exceptions.XMLSecurityException;
67,68c23,28
< import org.apache.xml.security.transforms.TransformationException;
< import org.apache.xml.security.transforms.Transforms;
---
> import org.apache.xml.security.utils.ElementProxy;
> import org.apache.xml.security.utils.HelperNodeList;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.Node;
> import org.w3c.dom.NodeList;
75c35
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
94c54
<    /** Field INTERSECT           */
---
>    /** Field INTERSECT */
98c58
<    /** Field SUBTRACT           */
---
>    /** Field SUBTRACT */
102c62
<    /** Field UNION           */
---
>    /** Field UNION */
136,144c96
< 
<       if ((xpath2filter.length() > 2)
<               && (!Character.isWhitespace(xpath2filter.charAt(0)))) {
<          this._constructionElement.appendChild(doc.createTextNode("\n"
<                  + xpath2filter + "\n"));
<       } else {
<          this._constructionElement
<             .appendChild(doc.createTextNode(xpath2filter));
<       }
---
>       this._constructionElement.appendChild(doc.createTextNode(xpath2filter));
265a218
>     *
323c276
<     * @todo I dunno whether this crashes: <XPath> here()<!-- comment -->/ds:Signature[1]</XPath>
---
>     * $todo$ I dunno whether this crashes: <XPath> here()<!-- comment -->/ds:Signature[1]</XPath>
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/params/XPathContainer.java xml-security-1_2_0/src/org/apache/xml/security/transforms/params/XPathContainer.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,64d20
< import org.w3c.dom.*;
< import org.apache.xml.security.utils.*;
66,69c22,26
< import org.apache.xml.security.transforms.TransformationException;
< import org.apache.xalan.extensions.ExpressionContext;
< import org.apache.xpath.NodeSet;
< import org.apache.xpath.XPathAPI;
---
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.w3c.dom.Document;
> import org.w3c.dom.NodeList;
> import org.w3c.dom.Text;
74c31
<  * the <CODE>ds:XPath</CODE> Element. It implements the {@link Element} interface
---
>  * the <CODE>ds:XPath</CODE> Element. It implements the {@link org.w3c.dom.Element} interface
117a75
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/params/XPathFilterCHGPContainer.java xml-security-1_2_0/src/org/apache/xml/security/transforms/params/XPathFilterCHGPContainer.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,65c21
< import org.w3c.dom.*;
< import org.apache.xml.security.utils.*;
< import org.apache.xml.security.exceptions.*;
---
> import org.apache.xml.security.exceptions.XMLSecurityException;
67d22
< import org.apache.xml.security.transforms.TransformationException;
68a24,28
> import org.apache.xml.security.utils.ElementProxy;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.Node;
75c35
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
136c96
<             this.createElementForFamily(doc, this.getBaseNamespace(),
---
>             ElementProxy.createElementForFamily(doc, this.getBaseNamespace(),
150c110
<             this.createElementForFamily(doc, this.getBaseNamespace(),
---
>          ElementProxy.createElementForFamily(doc, this.getBaseNamespace(),
162c122
<          Element excludeElem = this.createElementForFamily(doc,
---
>          Element excludeElem = ElementProxy.createElementForFamily(doc,
185,187c145,147
<       } else {
<          return xp;
<       }
---
>       } 
>       return xp;
>       
210c170
<     * @return
---
>     * @return the created object
226c186
<     * @return
---
>     *
227a188
>     * @return the created object.
238c199
<     * @return
---
>     * @return The Xstr
246,247c207,208
<       Element xElem = this.getChildElementLocalName(0, this.getBaseNamespace(),
<                          type);
---
>       Element xElem = XMLUtils.selectNode(this._constructionElement.getFirstChild(), this.getBaseNamespace(),
>                          type,0);
296c257
<     * @todo I dunno whether this crashes: <XPath> he<!-- comment -->re()/ds:Signature[1]</XPath>
---
>     * $todo$ I dunno whether this crashes: <XPath> he<!-- comment -->re()/ds:Signature[1]</XPath>
306,317c267,268
<       Element xElem = this.getChildElementLocalName(0, this.getBaseNamespace(),
<                          type);
<       NodeList children = xElem.getChildNodes();
<       int length = children.getLength();
< 
<       for (int i = 0; i < length; i++) {
<          if (children.item(i).getNodeType() == Node.TEXT_NODE) {
<             return children.item(i);
<          }
<       }
< 
<       return null;
---
>       return XMLUtils.selectNodeText(this._constructionElement.getFirstChild(), this.getBaseNamespace(),
>                          type,0);
352c303
<     * @return
---
>     * @inheritDoc
361c312
<     * @return
---
>     * @inheritDoc
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/TransformationException.java xml-security-1_2_0/src/org/apache/xml/security/transforms/TransformationException.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights 
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer. 
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:  
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written 
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European 
<  * Commission in the <WebSig> project in the ISIS Programme. 
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
84c42
<     * @param msgID
---
>     * @param _msgID
86,87c44,45
<    public TransformationException(String msgID) {
<       super(msgID);
---
>    public TransformationException(String _msgID) {
>       super(_msgID);
93c51
<     * @param msgID
---
>     * @param _msgID
96,97c54,55
<    public TransformationException(String msgID, Object exArgs[]) {
<       super(msgID, exArgs);
---
>    public TransformationException(String _msgID, Object exArgs[]) {
>       super(_msgID, exArgs);
103,104c61,62
<     * @param msgID
<     * @param originalException
---
>     * @param _msgID
>     * @param _originalException
106,107c64,65
<    public TransformationException(String msgID, Exception originalException) {
<       super(msgID, originalException);
---
>    public TransformationException(String _msgID, Exception _originalException) {
>       super(_msgID, _originalException);
113c71
<     * @param msgID
---
>     * @param _msgID
115c73
<     * @param originalException
---
>     * @param _originalException
117,119c75,77
<    public TransformationException(String msgID, Object exArgs[],
<                                   Exception originalException) {
<       super(msgID, exArgs, originalException);
---
>    public TransformationException(String _msgID, Object exArgs[],
>                                   Exception _originalException) {
>       super(_msgID, exArgs, _originalException);
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/Transform.java xml-security-1_2_0/src/org/apache/xml/security/transforms/Transform.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,65d20
< import java.util.Iterator;
< import java.util.HashMap;
< import java.io.InputStream;
66a22,25
> import java.io.OutputStream;
> import java.util.HashMap;
> import java.util.Iterator;
> 
68,70c27,31
< import org.w3c.dom.*;
< import org.xml.sax.SAXException;
< import org.apache.xml.security.c14n.*;
---
> 
> import org.apache.xml.security.c14n.CanonicalizationException;
> import org.apache.xml.security.c14n.InvalidCanonicalizerException;
> import org.apache.xml.security.exceptions.AlgorithmAlreadyRegisteredException;
> import org.apache.xml.security.exceptions.XMLSecurityException;
72,74c33,39
< import org.apache.xml.security.signature.XMLSignatureException;
< import org.apache.xml.security.exceptions.*;
< import org.apache.xml.security.utils.*;
---
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.HelperNodeList;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.NodeList;
> import org.xml.sax.SAXException;
89d53
<  * @see c14.Canonicalizer
94,96c58,60
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(Transform.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(Transform.class.getName());
111c75,77
<     * @param algorithmURI URI representation of <code>transfrom algorithm</code> will be specified as parameter of {@link #getInstance}, when generate. </br>
---
>     * @param algorithmURI URI representation of 
>     * <code>Transform algorithm</code> will be specified as parameter of 
>     * {@link #getInstance(Document, String)}, when generate. </br>
126,127c92,93
< 
<          cat.debug("Create URI \"" + algorithmURI + "\" class \""
---
>          if (log.isDebugEnabled()) {
>          	log.debug("Create URI \"" + algorithmURI + "\" class \""
129c95,96
<          cat.debug("The NodeList is " + contextNodes);
---
>          	log.debug("The NodeList is " + contextNodes);
>          }
223,224c190,191
<     * @param doc the proxy {@link documenet}
<     * @return <code>{@link Transfrom}</code> object
---
>     * @param doc the proxy {@link Document}
>     * @return <code>{@link Transform}</code> object
237,238c204,205
<     * @param doc the proxy {@link documenet}
<     * @return <code>{@link Transfrom}</code> object
---
>     * @param doc the proxy {@link Document}
>     * @return <code>{@link Transform}</code> object
259,260c226,227
<     * @param doc the proxy {@link documenet}
<     * @return <code>{@link Transfrom}</code> object
---
>     * @param doc the proxy {@link Document}
>     * @return <code>{@link Transform}</code> object
282c249
<     * Registers implementing class of the transfrom algorithm with algorithmURI
---
>     * Registers implementing class of the Transform algorithm with algorithmURI
284c251,252
<     * @param algorithmURI algorithmURI URI representation of <code>transfrom algorithm</code> will be specified as parameter of {@link #getInstance}, when generate. </br>
---
>     * @param algorithmURI algorithmURI URI representation of <code>Transform algorithm</code>
>     *  will be specified as parameter of {@link #getInstance(Document, String)}, when generate. </br>
318d285
<     *
319a287
>     *
347a316,349
>    
>    /**
>     * Transforms the input, and generats {@link XMLSignatureInput} as output.
>     * @param input input {@link XMLSignatureInput} which can supplied Octect Stream and NodeSet as Input of Transformation
>     * @param os where to output the result of the last transformation
>     *
>     * @return the {@link XMLSignatureInput} class as the result of transformation
>     * @throws CanonicalizationException
>     * @throws IOException
>     * @throws InvalidCanonicalizerException
>     * @throws TransformationException
>     */
>    public XMLSignatureInput performTransform(XMLSignatureInput input, OutputStream os)
>    throws IOException, CanonicalizationException,
>           InvalidCanonicalizerException, TransformationException {
> 
>    	    XMLSignatureInput result = null;
> 
>    	    try {
>    	    	result = transformSpi.enginePerformTransform(input,os);
>    	    } catch (ParserConfigurationException ex) {
>    	    	Object exArgs[] = { this.getURI(), "ParserConfigurationException" };
> 
>    	    	throw new CanonicalizationException(
>    	    			"signature.Transform.ErrorDuringTransform", exArgs, ex);
>    	    } catch (SAXException ex) {
>    	    	Object exArgs[] = { this.getURI(), "SAXException" };
> 
>    	    	throw new CanonicalizationException(
>    	    			"signature.Transform.ErrorDuringTransform", exArgs, ex);
>    	    }
> 
>    	    return result;
>    }
353c355
<     * @return
---
>     * @return The name of the class implementing the URI.
371a374,375
>    
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/TransformParam.java xml-security-1_2_0/src/org/apache/xml/security/transforms/TransformParam.java
0a1,17
> /*
>  * Copyright 1999-2004 The Apache Software Foundation.
>  *
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
>  *
>  */
> 
5c22
<  * @author $Author: dohy $
---
>  * @author $Author: blautenb $
6a24
> 
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/Transforms.java xml-security-1_2_0/src/org/apache/xml/security/transforms/Transforms.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,72c21,27
< import java.io.*;
< import java.lang.IllegalArgumentException;
< import java.util.Collection;
< import java.util.Enumeration;
< import java.util.Vector;
< import org.apache.xpath.XPathAPI;
< import javax.xml.transform.TransformerException;
< import org.w3c.dom.*;
< import org.apache.xml.security.c14n.*;
< import org.apache.xml.security.exceptions.*;
---
> import java.io.IOException;
> import java.io.OutputStream;
> 
> import org.apache.xml.security.c14n.CanonicalizationException;
> import org.apache.xml.security.c14n.Canonicalizer;
> import org.apache.xml.security.c14n.InvalidCanonicalizerException;
> import org.apache.xml.security.exceptions.XMLSecurityException;
75,78c30,36
< import org.apache.xml.security.transforms.*;
< import org.apache.xml.security.utils.*;
< import javax.xml.parsers.ParserConfigurationException;
< import org.xml.sax.SAXException;
---
> import org.apache.xml.security.utils.Constants;
> import org.apache.xml.security.utils.SignatureElementProxy;
> import org.apache.xml.security.utils.XMLUtils;
> import org.w3c.dom.DOMException;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.NodeList;
82c40
<  * Holder of the {@link org.apache.xml.security.transforms.Transform} steps to * Holder of the {@link org.apache.xml.security.transforms.Transform} steps to be performed on the data.
---
>  * Holder of the {@link org.apache.xml.security.transforms.Transform} steps to be performed on the data.
86c44
<  * @author: Christian Geuer-Pollmann
---
>  * @author Christian Geuer-Pollmann
88c46
<  * @see signature.Reference
---
>  * @see org.apache.xml.security.signature.Reference
92,94c50,52
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(Transforms.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(Transforms.class.getName());
115a74
>    /** Transform - XPath Filter */
116a76
>    /** Transform - XPath Filter  CHGP private*/
119c79
< 
---
>    Element []transforms;
172c132,133
<          cat.debug("Transforms.addTransform(" + transformURI + ")");
---
>          if (log.isDebugEnabled())
>          	log.debug("Transforms.addTransform(" + transformURI + ")");
194c155,156
<          cat.debug("Transforms.addTransform(" + transformURI + ")");
---
>          if (log.isDebugEnabled())
>         	log.debug("Transforms.addTransform(" + transformURI + ")");
232,233c194,195
< 
<       cat.debug("Transforms.addTransform(" + transform.getURI() + ")");
---
>       if (log.isDebugEnabled())
>       	log.debug("Transforms.addTransform(" + transform.getURI() + ")");
249a212,224
>    	     return performTransforms(xmlSignatureInput,null);
>    }
>    
>    /**
>     * Applies all included <code>Transform</code>s to xmlSignatureInput and returns the result of these transformations.
>     *
>     * @param xmlSignatureInput the input for the <code>Transform</code>s
>     * @param os where to output the last transformation.
>     * @return the result of the <code>Transforms</code>
>     * @throws TransformationException
>     */
>     public XMLSignatureInput performTransforms(
>             XMLSignatureInput xmlSignatureInput,OutputStream os) throws TransformationException {
252c227,229
<          for (int i = 0; i < this.getLength(); i++) {
---
>         int transformLength=this.getLength();
>         int last=transformLength-1;
>          for (int i = 0; i < transformLength; i++) {
254,257c231,238
< 
<             cat.debug("Preform the (" + i + ")th " + t.getURI() + " transform");
< 
<             xmlSignatureInput = t.performTransform(xmlSignatureInput);
---
>             if (log.isDebugEnabled()) {
>             	log.debug("Preform the (" + i + ")th " + t.getURI() + " transform");
>             }
>             if (i==last) {
>             	xmlSignatureInput = t.performTransform(xmlSignatureInput, os);
>             } else {
>             	xmlSignatureInput = t.performTransform(xmlSignatureInput);
>             }
286d266
<     * @throws TransformationException
288,301c268,281
<    public int getLength() throws TransformationException {
< 
<       try {
<          Element nscontext = XMLUtils.createDSctx(this._doc, "ds",
<                                                   Constants.SignatureSpecNS);
<          NodeList transformElems =
<             XPathAPI.selectNodeList(this._constructionElement,
<                                     "./ds:Transform", nscontext);
< 
<          return transformElems.getLength();
<       } catch (TransformerException ex) {
<          throw new TransformationException("empty", ex);
<       }
<    }
---
>    public int getLength()
>    {
> 		/*Element nscontext = XMLUtils.createDSctx(this._doc, "ds",
> 	                                              Constants.SignatureSpecNS);
> 	     NodeList transformElems =
> 	        XPathAPI.selectNodeList(this._constructionElement,
> 	                                "./ds:Transform", nscontext);
> 	     return transformElems.getLength();*/
>        if (transforms==null) {
>         transforms=XMLUtils.selectDsNodes(this._constructionElement.getFirstChild(),
>            "Transform");
>        }
>        return transforms.length;       
>   }
312,332c292,301
< 
<       try {
<          Element nscontext = XMLUtils.createDSctx(this._doc, "ds",
<                                                   Constants.SignatureSpecNS);
<          Element transformElem =
<             (Element) XPathAPI.selectSingleNode(this._constructionElement,
<                                                 "./ds:"
<                                                 + Constants._TAG_TRANSFORM
<                                                 + "[" + (i + 1) + "]",
<                                                 nscontext);
< 
<          if (transformElem == null) {
<             return null;
<          } else {
<             return new Transform(transformElem, this._baseURI);
<          }
<       } catch (TransformerException ex) {
<          throw new TransformationException("empty", ex);
<       } catch (XMLSecurityException ex) {
<          throw new TransformationException("empty", ex);
<       }
---
>    	
> 	   	try {
> 	   		if (transforms==null) {
> 	   			transforms=XMLUtils.selectDsNodes(this._constructionElement.getFirstChild(),
> 	   			"Transform");
> 	   		}
> 	   		return new Transform(transforms[i], this._baseURI);
> 	   	} catch (XMLSecurityException ex) {
> 	   		throw new TransformationException("empty", ex);
> 	   	}
334a304
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/transforms/TransformSpi.java xml-security-1_2_0/src/org/apache/xml/security/transforms/TransformSpi.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64a23,24
> import java.io.OutputStream;
> 
66,69c26
< import org.w3c.dom.*;
< import org.xml.sax.SAXException;
< import org.apache.xml.security.signature.XMLSignatureInput;
< import org.apache.xml.security.utils.Constants;
---
> 
72c29,30
< import org.apache.xml.security.utils.*;
---
> import org.apache.xml.security.signature.XMLSignatureInput;
> import org.xml.sax.SAXException;
77c35
<  * have to be overridden are the {@link #enginePerformTransform} method.
---
>  * have to be overridden are the {@link #enginePerformTransform(XMLSignatureInput)} method.
83,85c41,43
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(TransformSpi.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(TransformSpi.class.getName());
122a81,101
>     * @param os where to output this transformation.
>     * @return {@link XMLSignatureInput} as the result of transformation
>     * @throws CanonicalizationException
>     * @throws IOException
>     * @throws InvalidCanonicalizerException
>     * @throws ParserConfigurationException
>     * @throws SAXException
>     * @throws TransformationException
>     */
>    protected XMLSignatureInput enginePerformTransform(
>       XMLSignatureInput input, OutputStream os)
>          throws IOException,
>                 CanonicalizationException, InvalidCanonicalizerException,
>                 TransformationException, ParserConfigurationException,
>                 SAXException {
>    	    return enginePerformTransform(input);
>    }
>    /**
>     * The mega method which MUST be implemented by the Transformation Algorithm.
>     *
>     * @param input {@link XMLSignatureInput} as the input of transformation
127d105
<     * @throws NotYetImplementedException
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/Base64.java xml-security-1_2_0/src/org/apache/xml/security/utils/Base64.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
67,71c25
< import java.util.StringTokenizer;
< import java.math.BigInteger;
< import org.w3c.dom.*;
< import java.io.FileNotFoundException;
< import java.io.IOException;
---
> import java.io.OutputStream;
73c27,28
< import org.w3c.dom.traversal.NodeIterator;
---
> import java.math.BigInteger;
> 
76,85c31
< import javax.xml.parsers.ParserConfigurationException;
< import javax.xml.transform.TransformerException;
< import org.xml.sax.SAXException;
< import org.xml.sax.InputSource;
< import org.apache.xpath.XPath;
< import org.apache.xpath.XPathAPI;
< import org.apache.xpath.NodeSet;
< import org.apache.xpath.objects.XObject;
< import org.apache.xml.utils.PrefixResolverDefault;
< import org.apache.xml.security.utils.Constants;
---
> 
86a33,37
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.Node;
> import org.w3c.dom.Text;
> import org.xml.sax.InputSource;
91c42,43
<  * Optimized code. (raw version taken from oreilly.jonathan.util)
---
>  * Optimized code. (raw version taken from oreilly.jonathan.util,
>  * and currently org.apache.xerces.ds.util.Base64)
92a45
>  * @author Raul Benito(Of the xerces copy, and little adaptations).
100,165c53,98
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(Base64.class.getName());
< 
<    /** Field LINE_SEPARATOR */
<    public static final String LINE_SEPARATOR = "\n";
< 
<    /** Field BASE64DEFAULTLENGTH */
<    public static final int BASE64DEFAULTLENGTH = 76;
< 
<    /** Field _base64length */
<    static int _base64length = Base64.BASE64DEFAULTLENGTH;
< 
<    private Base64() {
<      // we don't allow instantiation
<    }
< 
<    /**
<     * Method setBase64WrapLength
<     *
<     * @param length
<     */
<    public static void setBase64WrapLength(int length) {
<       Base64._base64length = length;
<    }
< 
<    /**
<     * Method getBase64WrapLength
<     *
<     * @return
<     */
<    public static int getBase64WrapLength() {
<       return Base64._base64length;
<    }
< 
<    /**
<     * Returns a byte-array representation of a <code>{@link BigInteger}<code>.
<     * No sign-bit is outputed.
<     *
<     * <p><b>N.B.:</B> <code>{@link BigInteger}<code>'s toByteArray
<     * retunrs eventually longer arrays because of the leading sign-bit.
<     *
<     * @param big <code>BigInteger<code> to be converted
<     * @param bitlen <code>int<code> the desired length in bits of the representation
<     * @return a byte array with <code>bitlen</code> bits of <code>big</code>
<     */
<    static byte[] getBytes(BigInteger big, int bitlen) {
< 
<       //round bitlen
<       bitlen = ((bitlen + 7) >> 3) << 3;
< 
<       if (bitlen < big.bitLength()) {
<          throw new IllegalArgumentException(I18n
<             .translate("utils.Base64.IllegalBitlength"));
<       }
< 
<       byte[] bigBytes = big.toByteArray();
< 
<       if (((big.bitLength() % 8) != 0)
<               && (((big.bitLength() / 8) + 1) == (bitlen / 8))) {
<          return bigBytes;
<       } else {
< 
<          // some copying needed
<          int startSrc = 0;    // no need to skip anything
<          int bigLen = bigBytes.length;    //valid length of the string
---
>     /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log =
>             org.apache.commons.logging.LogFactory.getLog(Base64.class.getName());
> 
> 
>     /** Field BASE64DEFAULTLENGTH */
>     public static final int BASE64DEFAULTLENGTH = 76;
> 
>     /** Field _base64length */
>     static int _base64length = Base64.BASE64DEFAULTLENGTH;
> 
>     private Base64() {
>         // we don't allow instantiation
>     }
> 
>     /**
>      * Returns a byte-array representation of a <code>{@link BigInteger}<code>.
>      * No sign-bit is outputed.
>      *
>      * <b>N.B.:</B> <code>{@link BigInteger}<code>'s toByteArray
>      * retunrs eventually longer arrays because of the leading sign-bit.
>      *
>      * @param big <code>BigInteger<code> to be converted
>      * @param bitlen <code>int<code> the desired length in bits of the representation
>      * @return a byte array with <code>bitlen</code> bits of <code>big</code>
>      */
>     static byte[] getBytes(BigInteger big, int bitlen) {
> 
>         //round bitlen
>         bitlen = ((bitlen + 7) >> 3) << 3;
> 
>         if (bitlen < big.bitLength()) {
>             throw new IllegalArgumentException(I18n
>                     .translate("utils.Base64.IllegalBitlength"));
>         }
> 
>         byte[] bigBytes = big.toByteArray();
> 
>         if (((big.bitLength() % 8) != 0)
>                 && (((big.bitLength() / 8) + 1) == (bitlen / 8))) {
>             return bigBytes;
>         }
> 
>         // some copying needed
>         int startSrc = 0;    // no need to skip anything
>         int bigLen = bigBytes.length;    //valid length of the string
167c100
<          if ((big.bitLength() % 8) == 0) {    // correct values
---
>         if ((big.bitLength() % 8) == 0) {    // correct values
171c104,107
<          }
---
>         }
> 
>         int startDst = bitlen / 8 - bigLen;    //pad with leading nulls
>         byte[] resizedBytes = new byte[bitlen / 8];
173,174c109
<          int startDst = bitlen / 8 - bigLen;    //pad with leading nulls
<          byte[] resizedBytes = new byte[bitlen / 8];
---
>         System.arraycopy(bigBytes, startSrc, resizedBytes, startDst, bigLen);
176c111
<          System.arraycopy(bigBytes, startSrc, resizedBytes, startDst, bigLen);
---
>         return resizedBytes;
178,222c113,155
<          return resizedBytes;
<       }
<    }
< 
<    /**
<     * Encode in Base64 the given <code>{@link BigInteger}<code>.
<     *
<     * @param big
<     * @return String with Base64 encoding
<     */
<    public static String encode(BigInteger big) {
<       return encode(getBytes(big, big.bitLength()));
<    }
< 
<    /**
<     * Returns a byte-array representation of a <code>{@link BigInteger}<code>.
<     * No sign-bit is outputed.
<     *
<     * <p><b>N.B.:</B> <code>{@link BigInteger}<code>'s toByteArray
<     * retunrs eventually longer arrays because of the leading sign-bit.
<     *
<     * @param big <code>BigInteger<code> to be converted
<     * @param bitlen <code>int<code> the desired length in bits of the representation
<     * @return a byte array with <code>bitlen</code> bits of <code>big</code>
<     */
<    public static byte[] encode(BigInteger big, int bitlen) {
< 
<       //round bitlen
<       bitlen = ((bitlen + 7) >> 3) << 3;
< 
<       if (bitlen < big.bitLength()) {
<          throw new IllegalArgumentException(I18n
<             .translate("utils.Base64.IllegalBitlength"));
<       }
< 
<       byte[] bigBytes = big.toByteArray();
< 
<       if (((big.bitLength() % 8) != 0)
<               && (((big.bitLength() / 8) + 1) == (bitlen / 8))) {
<          return bigBytes;
<       } else {
< 
<          // some copying needed
<          int startSrc = 0;    // no need to skip anything
<          int bigLen = bigBytes.length;    //valid length of the string
---
>     }
> 
>     /**
>      * Encode in Base64 the given <code>{@link BigInteger}<code>.
>      *
>      * @param big
>      * @return String with Base64 encoding
>      */
>     public static String encode(BigInteger big) {
>         return encode(getBytes(big, big.bitLength()));
>     }
> 
>     /**
>      * Returns a byte-array representation of a <code>{@link BigInteger}<code>.
>      * No sign-bit is outputed.
>      *
>      * <b>N.B.:</B> <code>{@link BigInteger}<code>'s toByteArray
>      * retunrs eventually longer arrays because of the leading sign-bit.
>      *
>      * @param big <code>BigInteger<code> to be converted
>      * @param bitlen <code>int<code> the desired length in bits of the representation
>      * @return a byte array with <code>bitlen</code> bits of <code>big</code>
>      */
>     public static byte[] encode(BigInteger big, int bitlen) {
> 
>         //round bitlen
>         bitlen = ((bitlen + 7) >> 3) << 3;
> 
>         if (bitlen < big.bitLength()) {
>             throw new IllegalArgumentException(I18n
>                     .translate("utils.Base64.IllegalBitlength"));
>         }
> 
>         byte[] bigBytes = big.toByteArray();
> 
>         if (((big.bitLength() % 8) != 0)
>                 && (((big.bitLength() / 8) + 1) == (bitlen / 8))) {
>             return bigBytes;
>         }
> 
>         // some copying needed
>         int startSrc = 0;    // no need to skip anything
>         int bigLen = bigBytes.length;    //valid length of the string
224c157
<          if ((big.bitLength() % 8) == 0) {    // correct values
---
>         if ((big.bitLength() % 8) == 0) {    // correct values
228c161,168
<          }
---
>         }
> 
>         int startDst = bitlen / 8 - bigLen;    //pad with leading nulls
>         byte[] resizedBytes = new byte[bitlen / 8];
> 
>         System.arraycopy(bigBytes, startSrc, resizedBytes, startDst, bigLen);
> 
>         return resizedBytes;
230,231c170,236
<          int startDst = bitlen / 8 - bigLen;    //pad with leading nulls
<          byte[] resizedBytes = new byte[bitlen / 8];
---
>     }
> 
>     /**
>      * Method decodeBigIntegerFromElement
>      *
>      * @param element
>      * @return the biginter obtained from the node
>      * @throws Base64DecodingException
>      */
>     public static BigInteger decodeBigIntegerFromElement(Element element) throws Base64DecodingException
>     {
>         return new BigInteger(1, Base64.decode(element));
>     }
> 
>     /**
>      * Method decodeBigIntegerFromText
>      *
>      * @param text
>      * @return the biginter obtained from the text node
>      * @throws Base64DecodingException
>      */
>     public static BigInteger decodeBigIntegerFromText(Text text) throws Base64DecodingException
>     {
>         return new BigInteger(1, Base64.decode(text.getData()));
>     }
> 
>     /**
>      * This method takes an (empty) Element and a BigInteger and adds the
>      * base64 encoded BigInteger to the Element.
>      *
>      * @param element
>      * @param biginteger
>      */
>     public static void fillElementWithBigInteger(Element element,
>             BigInteger biginteger) {
> 
>         String encodedInt = encode(biginteger);
> 
>         if (encodedInt.length() > 76) {
>             encodedInt = "\n" + encodedInt + "\n";
>         }
> 
>         Document doc = element.getOwnerDocument();
>         Text text = doc.createTextNode(encodedInt);
> 
>         element.appendChild(text);
>     }
> 
>     /**
>      * Method decode
>      *
>      * Takes the <CODE>Text</CODE> children of the Element and interprets
>      * them as input for the <CODE>Base64.decode()</CODE> function.
>      *
>      * @param element
>      * @return the byte obtained of the decoding the element
>      * $todo$ not tested yet
>      * @throws Base64DecodingException
>      */
>     public static byte[] decode(Element element) throws Base64DecodingException {
> 
>         Node sibling = element.getFirstChild();
>         StringBuffer sb = new StringBuffer();
> 
>         while (sibling!=null) {
>             if (sibling.getNodeType() == Node.TEXT_NODE) {
>                 Text t = (Text) sibling;
233c238,472
<          System.arraycopy(bigBytes, startSrc, resizedBytes, startDst, bigLen);
---
>                 sb.append(t.getData());
>             }
>             sibling=sibling.getNextSibling();
>         }
> 
>         return decode(sb.toString());
>     }
> 
>     /**
>      * Method encodeToElement
>      *
>      * @param doc
>      * @param localName
>      * @param bytes
>      * @return an Element with the base64 encoded in the text.
>      *
>      */
>     public static Element encodeToElement(Document doc, String localName,
>             byte[] bytes) {
> 
>         Element el = XMLUtils.createElementInSignatureSpace(doc, localName);
>         Text text = doc.createTextNode(encode(bytes));
> 
>         el.appendChild(text);
> 
>         return el;
>     }
> 
>     /**
>      * Method decode
>      *
>      *
>      * @param base64
>      * @return the UTF bytes of the base64
>      * @throws Base64DecodingException
>      *
>      */
>     public static byte[] decode(byte[] base64) throws Base64DecodingException  {
>         return decodeInternal(base64);
>     }
> 
> 
> 
>     /**
>      * Encode a byte array and fold lines at the standard 76th character.
>      *
>      * @param binaryData <code>byte[]<code> to be base64 encoded
>      * @return the <code>String<code> with encoded data
>      */
>     public static String encode(byte[] binaryData) {
>         return encode(binaryData,BASE64DEFAULTLENGTH);
>     }
> 
>     /**
>      * Base64 decode the lines from the reader and return an InputStream
>      * with the bytes.
>      *
>      *
>      * @param reader
>      * @return InputStream with the decoded bytes
>      * @exception IOException passes what the reader throws
>      * @throws IOException
>      * @throws Base64DecodingException
>      */
>     public static byte[] decode(BufferedReader reader)
>             throws IOException, Base64DecodingException {
> 
>         ByteArrayOutputStream baos = new ByteArrayOutputStream();
>         String line;
> 
>         while (null != (line = reader.readLine())) {
>             byte[] bytes = decode(line);
> 
>             baos.write(bytes);
>         }
> 
>         return baos.toByteArray();
>     }
> 
>     /**
>      * Method main
>      *
>      *
>      * @param args
>      *
>      * @throws Exception
>      */
>     public static void main(String[] args) throws Exception {
> 
>         DocumentBuilderFactory docBuilderFactory =
>                 DocumentBuilderFactory.newInstance();
>         DocumentBuilder docBuilder = docBuilderFactory.newDocumentBuilder();
>         String testString1 =
>                 "<container><base64 value=\"Should be 'Hallo'\">SGFsbG8=</base64></container>";
>         InputSource inputSource = new InputSource(new StringReader(testString1));
>         Document doc = docBuilder.parse(inputSource);
>         Element base64Elem =
>                 (Element) doc.getDocumentElement().getChildNodes().item(0);
> 
>         System.out.println(new String(decode(base64Elem)));
>     }
>     static private final int  BASELENGTH         = 255;
>     static private final int  LOOKUPLENGTH       = 64;
>     static private final int  TWENTYFOURBITGROUP = 24;
>     static private final int  EIGHTBIT           = 8;
>     static private final int  SIXTEENBIT         = 16;
>     static private final int  FOURBYTE           = 4;
>     static private final int  SIGN               = -128;
>     static private final char PAD                = '=';
>     static private final boolean fDebug          = false;
>     static final private byte [] base64Alphabet        = new byte[BASELENGTH];
>     static final private char [] lookUpBase64Alphabet  = new char[LOOKUPLENGTH];
> 
>     static {
> 
>         for (int i = 0; i<BASELENGTH; i++) {
>             base64Alphabet[i] = -1;
>         }
>         for (int i = 'Z'; i >= 'A'; i--) {
>             base64Alphabet[i] = (byte) (i-'A');
>         }
>         for (int i = 'z'; i>= 'a'; i--) {
>             base64Alphabet[i] = (byte) ( i-'a' + 26);
>         }
> 
>         for (int i = '9'; i >= '0'; i--) {
>             base64Alphabet[i] = (byte) (i-'0' + 52);
>         }
> 
>         base64Alphabet['+']  = 62;
>         base64Alphabet['/']  = 63;
> 
>         for (int i = 0; i<=25; i++) {
>             lookUpBase64Alphabet[i] = (char)('A'+i);
>         }
> 
>         for (int i = 26,  j = 0; i<=51; i++, j++) {
>             lookUpBase64Alphabet[i] = (char)('a'+ j);
>         }
> 
>         for (int i = 52,  j = 0; i<=61; i++, j++) {
>             lookUpBase64Alphabet[i] = (char)('0' + j);
>         }
>         lookUpBase64Alphabet[62] = '+';
>         lookUpBase64Alphabet[63] = '/';
> 
>     }
> 
>     protected static final boolean isWhiteSpace(byte octect) {
>         return (octect == 0x20 || octect == 0xd || octect == 0xa || octect == 0x9);
>     }
> 
>     protected static final boolean isPad(byte octect) {
>         return (octect == PAD);
>     }
> 
>     protected static final boolean isData(byte octect) {
>         return (base64Alphabet[octect] != -1);
>     }
> 
>     /**
>      * Encodes hex octects into Base64
>      *
>      * @param binaryData Array containing binaryData
>      * @return Encoded Base64 array
>      */
>     /**
>      * Encode a byte array in Base64 format and return an optionally
>      * wrapped line.
>      *
>      * @param binaryData <code>byte[]</code> data to be encoded
>      * @param length <code>int<code> length of wrapped lines; No wrapping if less than 4.
>      * @return a <code>String</code> with encoded data
>      */
>     public static String encode(byte[] binaryData,int length) {
> 
>         if (length<4) {
>             length=Integer.MAX_VALUE;
>         }
> 
>         if (binaryData == null) {
>             return null;
>         }
> 
>         int      lengthDataBits    = binaryData.length*EIGHTBIT;
>         if (lengthDataBits == 0) {
>             return "";
>         }
> 
>         int      fewerThan24bits   = lengthDataBits%TWENTYFOURBITGROUP;
>         int      numberTriplets    = lengthDataBits/TWENTYFOURBITGROUP;
>         int      numberQuartet     = fewerThan24bits != 0 ? numberTriplets+1 : numberTriplets;
>         int      quartesPerLine    = length/4;
>         int      numberLines       = (numberQuartet-1)/quartesPerLine;
>         char     encodedData[]     = null;
> 
>         encodedData = new char[numberQuartet*4+numberLines];
> 
>         byte k=0, l=0, b1=0,b2=0,b3=0;
> 
>         int encodedIndex = 0;
>         int dataIndex   = 0;
>         int i           = 0;
>         if (fDebug) {
>             System.out.println("number of triplets = " + numberTriplets );
>         }
> 
>         for (int line = 0; line < numberLines; line++) {
>             for (int quartet = 0; quartet < 19; quartet++) {
>                 b1 = binaryData[dataIndex++];
>                 b2 = binaryData[dataIndex++];
>                 b3 = binaryData[dataIndex++];
> 
>                 if (fDebug) {
>                     System.out.println( "b1= " + b1 +", b2= " + b2 + ", b3= " + b3 );
>                 }
> 
>                 l  = (byte)(b2 & 0x0f);
>                 k  = (byte)(b1 & 0x03);
> 
>                 byte val1 = ((b1 & SIGN)==0)?(byte)(b1>>2):(byte)((b1)>>2^0xc0);
> 
>             byte val2 = ((b2 & SIGN)==0)?(byte)(b2>>4):(byte)((b2)>>4^0xf0);
>         byte val3 = ((b3 & SIGN)==0)?(byte)(b3>>6):(byte)((b3)>>6^0xfc);
> 
>         if (fDebug) {
>             System.out.println( "val2 = " + val2 );
>             System.out.println( "k4   = " + (k<<4));
>             System.out.println( "vak  = " + (val2 | (k<<4)));
>         }
> 
>         encodedData[encodedIndex++] = lookUpBase64Alphabet[ val1 ];
>         encodedData[encodedIndex++] = lookUpBase64Alphabet[ val2 | ( k<<4 )];
>         encodedData[encodedIndex++] = lookUpBase64Alphabet[ (l <<2 ) | val3 ];
>         encodedData[encodedIndex++] = lookUpBase64Alphabet[ b3 & 0x3f ];
235,676c474,482
<          return resizedBytes;
<       }
<    }
< 
<    /**
<     * Method decodeBigIntegerFromElement
<     *
<     * @param element
<     * @return
<     * @throws Base64DecodingException
<     */
<    public static BigInteger decodeBigIntegerFromElement(Element element)
<            throws Base64DecodingException {
<       return new BigInteger(1, Base64.decode(element));
<    }
< 
<    /**
<     * Method decodeBigIntegerFromText
<     *
<     * @param text
<     * @return
<     * @throws Base64DecodingException
<     */
<    public static BigInteger decodeBigIntegerFromText(Text text)
<            throws Base64DecodingException {
<       return new BigInteger(1, Base64.decode(text.getData()));
<    }
< 
<    /**
<     * This method takes an (empty) Element and a BigInteger and adds the
<     * base64 encoded BigInteger to the Element.
<     *
<     * @param element
<     * @param biginteger
<     */
<    public static void fillElementWithBigInteger(Element element,
<            BigInteger biginteger) {
< 
<       String encodedInt = encode(biginteger);
< 
<       if (encodedInt.length() > 76) {
<          encodedInt = "\n" + encodedInt + "\n";
<       }
< 
<       Document doc = element.getOwnerDocument();
<       Text text = doc.createTextNode(encodedInt);
< 
<       element.appendChild(text);
<    }
< 
<    /**
<     * Method decode
<     *
<     * Takes the <CODE>Text</CODE> children of the Element and interprets
<     * them as input for the <CODE>Base64.decode()</CODE> function.
<     *
<     * @param element
<     * @return
<     * @todo not tested yet
<     * @throws Base64DecodingException
<     */
<    public static byte[] decode(Element element) throws Base64DecodingException {
< 
<       NodeList nl = element.getChildNodes();
<       StringBuffer sb = new StringBuffer();
< 
<       for (int i = 0; i < nl.getLength(); i++) {
<          if (nl.item(i).getNodeType() == Node.TEXT_NODE) {
<             Text t = (Text) nl.item(i);
< 
<             sb.append(t.getData());
<          }
<       }
< 
<       return decode(sb.toString());
<    }
< 
<    /**
<     * Method encodeToElement
<     *
<     * @param doc
<     * @param localName
<     * @param bytes
<     * @return
<     */
<    public static Element encodeToElement(Document doc, String localName,
<                                          byte[] bytes) {
< 
<       Element el = XMLUtils.createElementInSignatureSpace(doc, localName);
<       Text text = doc.createTextNode(encode(bytes));
< 
<       el.appendChild(text);
< 
<       return el;
<    }
< 
<    /**
<     * Method decode
<     *
<     *
<     * @param base64
<     *
<     * @return
<     * @throws Base64DecodingException
<     */
<    public static byte[] decode(byte[] base64) throws Base64DecodingException {
< 
<       try {
<          return decode(new String(base64, "UTF-8"));
<       } catch (java.io.UnsupportedEncodingException ex) {
< 
<          // should never be reached because Encoding is valid and fixed
<          return new byte[0];
<       }
<    }
< 
<    /**
<     * <p>Decode a Base64-encoded string to a byte array</p>
<     *
<     * @param base64 <code>String</code> encoded string (single line only !!)
<     * @return Decoded data in a byte array
<     * @throws Base64DecodingException
<     */
<    public static byte[] decode(String base64) throws Base64DecodingException {
< 
<       try {
<          if (base64.length() < 30) {
<             cat.debug("I was asked to decode \"" + base64 + "\"");
<          } else {
<             cat.debug("I was asked to decode \"" + base64.substring(0, 20)
<                       + "...\"");
<          }
< 
<          //strip whitespace from anywhere in the string.  Not the most memory
<          //efficient solution but elegant anyway :-)
<          StringTokenizer tok = new StringTokenizer(base64, " \n\r\t", false);
<          StringBuffer buf = new StringBuffer(base64.length());
< 
<          while (tok.hasMoreElements()) {
<             buf.append(tok.nextToken());
<          }
< 
<          base64 = buf.toString();
< 
<          int pad = 0;
< 
<          for (int i = base64.length() - 1;
<                  (i > 0) && (base64.charAt(i) == '='); i--) {
<             pad++;
<          }
< 
<          int length = base64.length() / 4 * 3 - pad;
<          byte[] raw = new byte[length];
< 
<          for (int i = 0, rawIndex = 0; i < base64.length();
<                  i += 4, rawIndex += 3) {
<             int block = (getValue(base64.charAt(i)) << 18)
<                         + (getValue(base64.charAt(i + 1)) << 12)
<                         + (getValue(base64.charAt(i + 2)) << 6)
<                         + (getValue(base64.charAt(i + 3)));
< 
<             for (int j = 2; j >= 0; j--) {
<                if (rawIndex + j < raw.length) {
<                   raw[rawIndex + j] = (byte) (block & 0xff);
<                }
< 
<                block >>= 8;
<             }
<          }
< 
<          return raw;
<       } catch (IndexOutOfBoundsException ex) {
<          throw new Base64DecodingException("utils.Base64.IllegalBitlength", ex);
<       }
<    }
< 
<    /**
<     * <p>Encode a byte array in Base64 format and return an optionally
<     * wrapped line</p>
<     *
<     * @param raw <code>byte[]</code> data to be encoded
<     * @param wrap <code>int<code> length of wrapped lines; No wrapping if less than 4.
<     * @return a <code>String</code> with encoded data
<     */
<    public static String encode(byte[] raw, int wrap) {
< 
<       //calculate length of encoded string
<       int encLen = ((raw.length + 2) / 3) * 4;
< 
<       //adjust for newlines
<       if (wrap > 3) {
<          wrap -= wrap % 4;
<          encLen += 2 * (encLen / wrap);
<       } else {    //disable wrapping
<          wrap = Integer.MAX_VALUE;
<       }
< 
<       StringBuffer encoded = new StringBuffer(encLen);
<       int len3 = (raw.length / 3) * 3;
<       int outLen = 0;    //length of output line
< 
<       for (int i = 0; i < len3; i += 3, outLen += 4) {
<          if (outLen + 4 > wrap) {
<             encoded.append(LINE_SEPARATOR);
< 
<             outLen = 0;
<          }
< 
<          encoded.append(encodeFullBlock(raw, i));
<       }
< 
<       if (outLen >= wrap) {    //this will produce an extra newline if needed !? Sun had it this way...
<          encoded.append(LINE_SEPARATOR);
<       }
< 
<       if (len3 < raw.length) {
<          encoded.append(encodeBlock(raw, len3));
<       }
< 
<       return encoded.toString();
<    }
< 
<    /**
<     * Encode a byte array and fold lines at the standard 76th character.
<     *
<     * @param raw <code>byte[]<code> to be base64 encoded
<     * @return the <code>String<code> with encoded data
<     */
<    public static String encode(byte[] raw) {
<       return encode(raw, Base64.getBase64WrapLength());
<    }
< 
<    /**
<     * Base64 decode the lines from the reader and return an InputStream
<     * with the bytes.
<     *
<     *
<     * @param reader
<     * @return InputStream with the decoded bytes
<     * @Exception IOException passes what the reader throws
<     * @throws Base64DecodingException
<     * @throws IOException
<     */
<    public static byte[] decode(BufferedReader reader)
<            throws IOException, Base64DecodingException {
< 
<       ByteArrayOutputStream baos = new ByteArrayOutputStream();
<       String line;
< 
<       while (null != (line = reader.readLine())) {
<          byte[] bytes = decode(line);
< 
<          baos.write(bytes);
<       }
< 
<       return baos.toByteArray();
<    }
< 
<    /**
<     * Method encodeBlock
<     *
<     * @param raw
<     * @param offset
<     * @return
<     */
<    protected static char[] encodeBlock(byte[] raw, int offset) {
< 
<       int block = 0;
<       int slack = raw.length - offset - 1;
<       int end = (slack >= 2)
<                 ? 2
<                 : slack;
< 
<       for (int i = 0; i < 3; i++) {
<          byte b = (offset + i < raw.length)
<                   ? raw[offset + i]
<                   : 0;
<          int neuter = (b < 0)
<                       ? b + 256
<                       : b;
< 
<          block <<= 8;
<          block += neuter;
<       }
< 
<       char[] base64 = new char[4];
< 
<       for (int i = 3; i >= 0; i--) {
<          int sixBit = block & 0x3f;
< 
<          base64[i] = getChar(sixBit);
<          block >>= 6;
<       }
< 
<       if (slack < 1) {
<          base64[2] = '=';
<       }
< 
<       if (slack < 2) {
<          base64[3] = '=';
<       }
< 
<       return base64;
<    }
< 
<    /**
<     * Method encodeFullBlock
<     *
<     * @param raw
<     * @param offset
<     * @return
<     */
<    protected static char[] encodeFullBlock(byte[] raw, int offset) {
< 
<       int block = 0;
< 
<       for (int i = 0; i < 3; i++) {
< 
<          //byte b = raw[offset + i];
<          //int neuter = (b < 0) ? b + 256 : b;
<          block <<= 8;
<          block += (0xff & raw[offset + i]);
<       }
< 
<       block = ((raw[offset] & 0xff) << 16) + ((raw[offset + 1] & 0xff) << 8)
<               + (raw[offset + 2] & 0xff);
< 
<       char[] base64 = new char[4];
< 
<       for (int i = 3; i >= 0; i--) {
<          int sixBit = block & 0x3f;
< 
<          base64[i] = getChar(sixBit);
<          block >>= 6;
<       }
< 
<       return base64;
<    }
< 
<    /**
<     * Method getChar
<     *
<     * @param sixBit
<     * @return
<     */
<    protected static char getChar(int sixBit) {
< 
<       if ((sixBit >= 0) && (sixBit < 26)) {
<          return (char) ('A' + sixBit);
<       }
< 
<       if ((sixBit >= 26) && (sixBit < 52)) {
<          return (char) ('a' + (sixBit - 26));
<       }
< 
<       if ((sixBit >= 52) && (sixBit < 62)) {
<          return (char) ('0' + (sixBit - 52));
<       }
< 
<       if (sixBit == 62) {
<          return '+';
<       }
< 
<       if (sixBit == 63) {
<          return '/';
<       }
< 
<       return '?';
<    }
< 
<    /**
<     * Method getValue
<     *
<     * @param c
<     * @return
<     */
<    protected static int getValue(char c) {
< 
<       if ((c >= 'A') && (c <= 'Z')) {
<          return c - 'A';
<       }
< 
<       if ((c >= 'a') && (c <= 'z')) {
<          return c - 'a' + 26;
<       }
< 
<       if ((c >= '0') && (c <= '9')) {
<          return c - '0' + 52;
<       }
< 
<       if (c == '+') {
<          return 62;
<       }
< 
<       if (c == '/') {
<          return 63;
<       }
< 
<       if (c == '=') {
<          return 0;
<       }
< 
<       return -1;
<    }
< 
<    //        boolean bInWSpace = false;//?
<    //        for(int i=0, j=0, len=base64.length();  i < len; i++) {
<    //            if( bInWSpace ) {
<    //                if( Character.isWhitespace(base64.charAt(i)) ) {
<    //                    skipLen++;
<    //                } else {
<    //                    //copy here & reset
<    //                }
<    //            } else {
<    //                if( Character.isWhitespace(base64.charAt(i)) ) {
<    //                    bInWSpace = true;
<    //                    skipLen++;
<    //                } else {
<    //                    //copy here & reset
<    //                }
<    //            }
<    //        }
< 
<    /**
<     * Method main
<     *
<     *
<     * @param args
<     *
<     * @throws Exception
<     */
<    public static void main(String[] args) throws Exception {
< 
<       DocumentBuilderFactory docBuilderFactory =
<          DocumentBuilderFactory.newInstance();
<       DocumentBuilder docBuilder = docBuilderFactory.newDocumentBuilder();
<       String testString1 =
<          "<container><base64 value=\"Should be 'Hallo'\">SGFsbG8=</base64></container>";
<       InputSource inputSource = new InputSource(new StringReader(testString1));
<       Document doc = docBuilder.parse(inputSource);
<       Element base64Elem =
<          (Element) doc.getDocumentElement().getChildNodes().item(0);
---
>         i++;
>             }
>             encodedData[encodedIndex++] = 0xa;
>         }
> 
>         for (; i<numberTriplets; i++) {
>             b1 = binaryData[dataIndex++];
>             b2 = binaryData[dataIndex++];
>             b3 = binaryData[dataIndex++];
678,679c484,853
<       System.out.println(new String(decode(base64Elem)));
<    }
---
>             if (fDebug) {
>                 System.out.println( "b1= " + b1 +", b2= " + b2 + ", b3= " + b3 );
>             }
> 
>             l  = (byte)(b2 & 0x0f);
>             k  = (byte)(b1 & 0x03);
> 
>             byte val1 = ((b1 & SIGN)==0)?(byte)(b1>>2):(byte)((b1)>>2^0xc0);
> 
>         byte val2 = ((b2 & SIGN)==0)?(byte)(b2>>4):(byte)((b2)>>4^0xf0);
>         byte val3 = ((b3 & SIGN)==0)?(byte)(b3>>6):(byte)((b3)>>6^0xfc);
> 
>             if (fDebug) {
>                 System.out.println( "val2 = " + val2 );
>                 System.out.println( "k4   = " + (k<<4));
>                 System.out.println( "vak  = " + (val2 | (k<<4)));
>             }
> 
>             encodedData[encodedIndex++] = lookUpBase64Alphabet[ val1 ];
>             encodedData[encodedIndex++] = lookUpBase64Alphabet[ val2 | ( k<<4 )];
>             encodedData[encodedIndex++] = lookUpBase64Alphabet[ (l <<2 ) | val3 ];
>             encodedData[encodedIndex++] = lookUpBase64Alphabet[ b3 & 0x3f ];
>         }
> 
>         // form integral number of 6-bit groups
>         if (fewerThan24bits == EIGHTBIT) {
>             b1 = binaryData[dataIndex];
>             k = (byte) ( b1 &0x03 );
>             if (fDebug) {
>                 System.out.println("b1=" + b1);
>                 System.out.println("b1<<2 = " + (b1>>2) );
>             }
>             byte val1 = ((b1 & SIGN)==0)?(byte)(b1>>2):(byte)((b1)>>2^0xc0);
>             encodedData[encodedIndex++] = lookUpBase64Alphabet[ val1 ];
>             encodedData[encodedIndex++] = lookUpBase64Alphabet[ k<<4 ];
>             encodedData[encodedIndex++] = PAD;
>             encodedData[encodedIndex++] = PAD;
>         } else if (fewerThan24bits == SIXTEENBIT) {
>             b1 = binaryData[dataIndex];
>             b2 = binaryData[dataIndex +1 ];
>             l = ( byte ) ( b2 &0x0f );
>             k = ( byte ) ( b1 &0x03 );
> 
>             byte val1 = ((b1 & SIGN)==0)?(byte)(b1>>2):(byte)((b1)>>2^0xc0);
>             byte val2 = ((b2 & SIGN)==0)?(byte)(b2>>4):(byte)((b2)>>4^0xf0);
> 
>             encodedData[encodedIndex++] = lookUpBase64Alphabet[ val1 ];
>             encodedData[encodedIndex++] = lookUpBase64Alphabet[ val2 | ( k<<4 )];
>             encodedData[encodedIndex++] = lookUpBase64Alphabet[ l<<2 ];
>             encodedData[encodedIndex++] = PAD;
>         }
> 
>         //encodedData[encodedIndex] = 0xa;
> 
>         return new String(encodedData);
>     }
> 
>     /**
>      * Decodes Base64 data into octects
>      *
>      * @param encoded Byte array containing Base64 data
>      * @return Array containind decoded data.
>      * @throws Base64DecodingException
>      */
>     public final static byte[] decode(String encoded) throws Base64DecodingException {
> 
>         if (encoded == null) {
>             return null;
>         }
> 
>         return decodeInternal(encoded.getBytes());
>     }
>     protected final static byte[] decodeInternal(byte[] base64Data) throws Base64DecodingException {
>         // remove white spaces
>         int len = removeWhiteSpace(base64Data);
> 
>         if (len%FOURBYTE != 0) {
>             throw new Base64DecodingException("It should be dived by four");
>             //should be divisible by four
>         }
> 
>         int      numberQuadruple    = (len/FOURBYTE );
> 
>         if (numberQuadruple == 0) {
>             return new byte[0];
>         }
> 
>         byte     decodedData[]      = null;
>         byte     b1=0,b2=0,b3=0, b4=0;
>         byte     d1=0,d2=0,d3=0,d4=0;
> 
>         int i = 0;
>         int encodedIndex = 0;
>         int dataIndex    = 0;
> 
>         //decodedData      = new byte[ (numberQuadruple)*3];
>         dataIndex=(numberQuadruple-1)*4;
>         encodedIndex=(numberQuadruple-1)*3;
>         //first last bits.
>         if (!isData( (d1 = base64Data[dataIndex++]) ) ||
>                 !isData( (d2 = base64Data[dataIndex++]) )) {
>             throw new Base64DecodingException("decoding.general");//if found "no data" just return null
>         }
> 
>         b1 = base64Alphabet[d1];
>         b2 = base64Alphabet[d2];
> 
>         d3 = base64Data[dataIndex++];
>         d4 = base64Data[dataIndex++];
>         if (!isData( (d3 ) ) ||
>                 !isData( (d4 ) )) {//Check if they are PAD characters
>             if (isPad( d3 ) && isPad( d4)) {               //Two PAD e.g. 3c[Pad][Pad]
>                 if ((b2 & 0xf) != 0) {
>                     throw new Base64DecodingException("decoding.general");
>                 }
>                 decodedData = new byte[ encodedIndex + 1 ];
>                 decodedData[encodedIndex]   = (byte)(  b1 <<2 | b2>>4 ) ;
>             } else if (!isPad( d3) && isPad(d4)) {               //One PAD  e.g. 3cQ[Pad]
>                 b3 = base64Alphabet[ d3 ];
>                 if ((b3 & 0x3 ) != 0) {
>                     throw new Base64DecodingException("decoding.general");
>                 }
>                 decodedData = new byte[ encodedIndex + 2 ];
>                 decodedData[encodedIndex++] = (byte)(  b1 <<2 | b2>>4 );
>                 decodedData[encodedIndex]   = (byte)(((b2 & 0xf)<<4 ) |( (b3>>2) & 0xf) );
>             } else {
>                 throw new Base64DecodingException("decoding.general");//an error  like "3c[Pad]r", "3cdX", "3cXd", "3cXX" where X is non data
>             }
>         } else {
>             //No PAD e.g 3cQl
>             decodedData = new byte[encodedIndex+3];
>             b3 = base64Alphabet[ d3 ];
>             b4 = base64Alphabet[ d4 ];
>             decodedData[encodedIndex++] = (byte)(  b1 <<2 | b2>>4 ) ;
>             decodedData[encodedIndex++] = (byte)(((b2 & 0xf)<<4 ) |( (b3>>2) & 0xf) );
>             decodedData[encodedIndex++] = (byte)( b3<<6 | b4 );
>         }
>         encodedIndex=0;
>         dataIndex=0;
>         //the begin
>         for (; i<numberQuadruple-1; i++) {
> 
>             if (!isData( (d1 = base64Data[dataIndex++]) )||
>                     !isData( (d2 = base64Data[dataIndex++]) )||
>                     !isData( (d3 = base64Data[dataIndex++]) )||
>                     !isData( (d4 = base64Data[dataIndex++]) ))
>             {
>                 throw new Base64DecodingException("decoding.general");//if found "no data" just return null
>             }
> 
>             b1 = base64Alphabet[d1];
>             b2 = base64Alphabet[d2];
>             b3 = base64Alphabet[d3];
>             b4 = base64Alphabet[d4];
> 
>             decodedData[encodedIndex++] = (byte)(  b1 <<2 | b2>>4 ) ;
>             decodedData[encodedIndex++] = (byte)(((b2 & 0xf)<<4 ) |( (b3>>2) & 0xf) );
>             decodedData[encodedIndex++] = (byte)( b3<<6 | b4 );
>         }
>         return decodedData;
>     }
> 
>     /**
>      * Decodes Base64 data into  outputstream
>      *
>      * @param base64Data Byte array containing Base64 data
>      * @param os the outputstream
>      * @throws IOException
>      * @throws Base64DecodingException
>      */
>     public final static void decode(byte[] base64Data,
>             OutputStream os) throws Base64DecodingException, IOException {
>         // remove white spaces
>         int len = removeWhiteSpace(base64Data);
> 
>         if (len%FOURBYTE != 0) {
>             throw new Base64DecodingException("It should be dived by four");
>             //should be divisible by four
>         }
> 
>         int      numberQuadruple    = (len/FOURBYTE );
> 
>         if (numberQuadruple == 0) {
>             return;
>         }
> 
>         //byte     decodedData[]      = null;
>         byte     b1=0,b2=0,b3=0, b4=0;
>         byte     d1=0,d2=0,d3=0,d4=0;
> 
>         int i = 0;
> 
>         int dataIndex    = 0;
> 
>         //the begin
>         for (; i<numberQuadruple-1; i++) {
> 
>             if (!isData( (d1 = base64Data[dataIndex++]) )||
>                     !isData( (d2 = base64Data[dataIndex++]) )||
>                     !isData( (d3 = base64Data[dataIndex++]) )||
>                     !isData( (d4 = base64Data[dataIndex++]) ))
>             {
>                 throw new Base64DecodingException("decoding.general");//if found "no data" just return null
>             }
> 
>             b1 = base64Alphabet[d1];
>             b2 = base64Alphabet[d2];
>             b3 = base64Alphabet[d3];
>             b4 = base64Alphabet[d4];
> 
>             os.write((byte)(  b1 <<2 | b2>>4 ) );
>             os.write((byte)(((b2 & 0xf)<<4 ) |( (b3>>2) & 0xf) ));
>             os.write( (byte)( b3<<6 | b4 ));
>         }
>         //  first last bits.
>         if (!isData( (d1 = base64Data[dataIndex++]) ) ||
>                 !isData( (d2 = base64Data[dataIndex++]) )) {
>             throw new Base64DecodingException("decoding.general");//if found "no data" just return null
>         }
> 
>         b1 = base64Alphabet[d1];
>         b2 = base64Alphabet[d2];
> 
>         d3 = base64Data[dataIndex++];
>         d4 = base64Data[dataIndex++];
>         if (!isData( (d3 ) ) ||
>                 !isData( (d4 ) )) {//Check if they are PAD characters
>             if (isPad( d3 ) && isPad( d4)) {               //Two PAD e.g. 3c[Pad][Pad]
>                 if ((b2 & 0xf) != 0) {
>                     throw new Base64DecodingException("decoding.general");
>                 }
>                 os.write( (byte)(  b1 <<2 | b2>>4 ) );
>             } else if (!isPad( d3) && isPad(d4)) {               //One PAD  e.g. 3cQ[Pad]
>                 b3 = base64Alphabet[ d3 ];
>                 if ((b3 & 0x3 ) != 0) {
>                     throw new Base64DecodingException("decoding.general");
>                 }
>                 os.write( (byte)(  b1 <<2 | b2>>4 ));
>                 os.write( (byte)(((b2 & 0xf)<<4 ) |( (b3>>2) & 0xf) ));
>             } else {
>                 throw new Base64DecodingException("decoding.general");//an error  like "3c[Pad]r", "3cdX", "3cXd", "3cXX" where X is non data
>             }
>         } else {
>             //No PAD e.g 3cQl
>             b3 = base64Alphabet[ d3 ];
>             b4 = base64Alphabet[ d4 ];
>             os.write((byte)(  b1 <<2 | b2>>4 ) );
>             os.write( (byte)(((b2 & 0xf)<<4 ) |( (b3>>2) & 0xf) ));
>             os.write((byte)( b3<<6 | b4 ));
>         }
>         return ;
>     }
> 
>     /**
>      * Decodes Base64 data into  outputstream
>      *
>      * @param is containing Base64 data
>      * @param os the outputstream
>      * @throws IOException
>      * @throws Base64DecodingException
>      */
>     public final static void decode(InputStream is,
>             OutputStream os) throws Base64DecodingException, IOException {
>         // remove white spaces
> 
> 
> 
>         //byte     decodedData[]      = null;
>         byte     b1=0,b2=0,b3=0, b4=0;
> 
>         int index=0;
>         byte []data=new byte[4];
>         int read;
>         //the begin
>         while ((read=is.read())>0) {
>             byte readed=(byte)read;
>             if (isWhiteSpace(readed)) {
>                 continue;
>             }
>             if (isPad(readed)) {
>                 data[index++]=readed;
>                 if (index==3) {
>                     data[index++]=(byte)is.read();
>                 }
>                 break;
>             }
>             if (!isData(readed)) {
>                 throw new Base64DecodingException("decoding.general");//if found "no data" just return null
>             }
> 
>             data[index++]=readed;
> 
>             if (index!=4) {
>                 continue;
>             }
>             index=0;
>             b1 = base64Alphabet[data[0]];
>             b2 = base64Alphabet[data[1]];
>             b3 = base64Alphabet[data[2]];
>             b4 = base64Alphabet[data[3]];
> 
>             os.write((byte)(  b1 <<2 | b2>>4 ) );
>             os.write((byte)(((b2 & 0xf)<<4 ) |( (b3>>2) & 0xf) ));
>             os.write( (byte)( b3<<6 | b4 ));
>         }
> 
> 
>         byte     d1=data[0],d2=data[1],d3=data[2], d4=data[3];
>         b1 = base64Alphabet[d1];
>         b2 = base64Alphabet[d2];
>         if (!isData( (d3 ) ) ||
>                 !isData( (d4 ) )) {//Check if they are PAD characters
>             if (isPad( d3 ) && isPad( d4)) {               //Two PAD e.g. 3c[Pad][Pad]
>                 if ((b2 & 0xf) != 0) {
>                     throw new Base64DecodingException("decoding.general");
>                 }
>                 os.write( (byte)(  b1 <<2 | b2>>4 ) );
>             } else if (!isPad( d3) && isPad(d4)) {               //One PAD  e.g. 3cQ[Pad]
>                 b3 = base64Alphabet[ d3 ];
>                 if ((b3 & 0x3 ) != 0) {
>                     throw new Base64DecodingException("decoding.general");
>                 }
>                 os.write( (byte)(  b1 <<2 | b2>>4 ));
>                 os.write( (byte)(((b2 & 0xf)<<4 ) |( (b3>>2) & 0xf) ));
>             } else {
>                 throw new Base64DecodingException("decoding.general");//an error  like "3c[Pad]r", "3cdX", "3cXd", "3cXX" where X is non data
>             }
>         } else {
>             //No PAD e.g 3cQl
>             b3 = base64Alphabet[ d3 ];
>             b4 = base64Alphabet[ d4 ];
>             os.write((byte)(  b1 <<2 | b2>>4 ) );
>             os.write( (byte)(((b2 & 0xf)<<4 ) |( (b3>>2) & 0xf) ));
>             os.write((byte)( b3<<6 | b4 ));
>         }
> 
>         return ;
>     }
>     /**
>      * remove WhiteSpace from MIME containing encoded Base64 data.
>      * 
>      * @param data  the byte array of base64 data (with WS)
>      * @return      the new length
>      */
>     protected static int removeWhiteSpace(byte[] data) {
>         if (data == null) {
>             return 0;
>         }
> 
>         // count characters that's not whitespace
>         int newSize = 0;
>         int len = data.length;
>         for (int i = 0; i < len; i++) {
>             byte dataS=data[i];
>             if (!isWhiteSpace(dataS)) {
>                 data[newSize++] = dataS;
>             }
>         }
>         return newSize;
>     }
> 
>     public static void setBase64WrapLength(int i) {
>         // TODO Auto-generated method stub
> 
>     }
> 
>     public static int getBase64WrapLength() {
>         // TODO Auto-generated method stub
>         return 0;
>     }
Only in xml-security-1_2_0/src/org/apache/xml/security/utils: CachedXPathAPIHolder.java
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/CachedXPathFuncHereAPI.java xml-security-1_2_0/src/org/apache/xml/security/utils/CachedXPathFuncHereAPI.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64c22
< import org.apache.xml.dtm.DTM;
---
> 
66,68d23
< import org.apache.xml.dtm.ref.DTMManagerDefault;
< import org.apache.xml.dtm.ref.DTMNodeIterator;
< import org.apache.xml.dtm.ref.DTMNodeList;
73,74d27
< import org.apache.xpath.compiler.XPathParser;
< import org.apache.xpath.objects.XObject;
77c30,31
< import org.w3c.dom.*;
---
> import org.apache.xpath.objects.XObject;
> import org.w3c.dom.Attr;
80a35,36
> import org.w3c.dom.ProcessingInstruction;
> import org.w3c.dom.Text;
83d38
< 
86c41
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
97a53,58
>    
>    XPathContext _context = null;
>    
>    String xpathStr=null;
>    
>    XPath xpath=null;
101d61
<     *
102a63
>     *
120a82
>       this._context=existingXPathContext;
128c90
<    public CachedXPathFuncHereAPI(CachedXPathAPI previouslyUsed) {
---
>    public CachedXPathFuncHereAPI(CachedXPathAPI previouslyUsed) {    
129a92
>       this._context=previouslyUsed.getXPathContext();
195a159
>     * @deprecated
202c166
<       XObject list = eval(contextNode, xpathnode, namespaceNode);
---
>       XObject list = eval(contextNode, xpathnode, getStrFromNode(xpathnode), namespaceNode);
216a181
>     * @deprecated
220c185
<       return selectNodeList(contextNode, xpathnode, contextNode);
---
>       return selectNodeList(contextNode, xpathnode, getStrFromNode(xpathnode), contextNode);
228a194
>     * @param str
235c201
<            Node contextNode, Node xpathnode, Node namespaceNode)
---
>            Node contextNode, Node xpathnode, String str, Node namespaceNode)
239c205
<       XObject list = eval(contextNode, xpathnode, namespaceNode);
---
>       XObject list = eval(contextNode, xpathnode, str, namespaceNode);
258a225
>     * @deprecated
262c229
<       return eval(contextNode, xpathnode, contextNode);
---
>       return eval(contextNode, xpathnode, getStrFromNode(xpathnode),contextNode);
273a241
>     * @param str
285c253
<    public XObject eval(Node contextNode, Node xpathnode, Node namespaceNode)
---
>    public XObject eval(Node contextNode, Node xpathnode, String str, Node namespaceNode)
287c255,257
< 
---
>       //  Create the XPath object.
>       //String str = CachedXPathFuncHereAPI.getStrFromNode(xpathnode);
>       
309,311c279,286
<       // Create the XPath object.
<       String str = CachedXPathFuncHereAPI.getStrFromNode(xpathnode);
<       XPath xpath = new XPath(str, null, prefixResolver, XPath.SELECT, null);
---
>       if (str!=xpathStr) {
>         if (str.indexOf("here()")>0) {
>             _context.reset();
>             _dtmManager=_context.getDTMManager();
>         }
>       	xpath = new XPath(str, null, prefixResolver, XPath.SELECT, null);
>         xpathStr=str;
>       }
328a304
>     * @param str
342c318
<            Node contextNode, Node xpathnode, PrefixResolver prefixResolver)
---
>            Node contextNode, Node xpathnode, String str, PrefixResolver prefixResolver)
351,352c327,346
<       String str = CachedXPathFuncHereAPI.getStrFromNode(xpathnode);
<       XPath xpath = new XPath(str, null, prefixResolver, XPath.SELECT, null);
---
>       //String str = CachedXPathFuncHereAPI.getStrFromNode(xpathnode);
>     if (str!=xpathStr) {
>     	if (str.indexOf("here()")>0) {
>     		_context.reset();
>     		_dtmManager=_context.getDTMManager();
>     	}
>         try {
>         	xpath = new XPath(str, null, prefixResolver, XPath.SELECT, null);
>         } catch (TransformerException ex) {
>             //Try to see if it is a problem with the classloader.
>             Throwable th= ex.getCause();            
>             if (th instanceof ClassNotFoundException) {
>                  if (th.getMessage().indexOf("FuncHere")>0) {
>                  	throw new RuntimeException(I18n.translate("endorsed.jdk1.4.0")/*,*/+ex);
>                  }
>               }
>               throw ex;
>         }
>         xpathStr=str;
>     }
371c365
<    private static String getStrFromNode(Node xpathnode) {
---
>    public static String getStrFromNode(Node xpathnode) {
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/Constants.java xml-security-1_2_0/src/org/apache/xml/security/utils/Constants.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,68d20
< import java.util.HashMap;
< import java.util.Locale;
< import java.util.Properties;
< import java.io.IOException;
< import java.io.File;
< import java.io.FileInputStream;
70d21
< import org.apache.xml.security.signature.XMLSignature;
80c31
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
84,86c35,37
<    /** Log4j logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(Constants.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>    static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(Constants.class.getName());
110a62
>    /** The URL for more algorithm **/
112c64
< 
---
>    /** The URI for XML spec*/
113a66
>    /** The URI for XMLNS spec*/
115a69
>    /** Tag of Attr Algorithm**/
116a71
>    /** Tag of Attr URI**/
117a73
>    /** Tag of Attr Type**/
118a75
>    /** Tag of Attr Id**/
119a77
>    /** Tag of Attr MimeType**/
120a79
>    /** Tag of Attr Encoding**/
121a81
>    /** Tag of Attr Target**/
133a94
>    /** Tag of Element CanonicalizationMethod **/
134a96
>    /** Tag of Element DigestMethod **/
135a98
>    /** Tag of Element DigestValue **/
136a100
>    /** Tag of Element Manifest **/
137a102
>    /** Tag of Element Methods **/
138a104
>    /** Tag of Element Object **/
139a106
>    /** Tag of Element Reference **/
140a108
>    /** Tag of Element Signature **/
141a110
>    /** Tag of Element SignatureMethod **/
142a112
>    /** Tag of Element HMACOutputLength **/
143a114
>    /** Tag of Element SignatureProperties **/
144a116
>    /** Tag of Element SignatureProperty **/
145a118
>    /** Tag of Element SignatureValue **/
146a120
>    /** Tag of Element SignedInfo **/
147a122
>    /** Tag of Element Transform **/
148a124
>    /** Tag of Element Transforms **/
149a126
>    /** Tag of Element XPath **/
151c128
< 
---
>    /** Tag of Element KeyInfo **/
153c130
< 
---
>    /** Tag of Element KeyName **/
154a132
>    /** Tag of Element KeyValue **/
155a134
>    /** Tag of Element RetrievalMethod **/
156a136
>    /** Tag of Element X509Data **/
157a138
>    /** Tag of Element PGPData **/
158a140
>    /** Tag of Element SPKIData **/
159a142
>    /** Tag of Element MgmtData **/
161c144
< 
---
>    /** Tag of Element RSAKeyValue **/
162a146
>    /** Tag of Element Exponent **/
163a148
>    /** Tag of Element Modulus **/
165c150
< 
---
>    /** Tag of Element DSAKeyValue **/
166a152
>    /** Tag of Element P **/
167a154
>    /** Tag of Element Q **/
168a156
>    /** Tag of Element G **/
169a158
>    /** Tag of Element Y **/
170a160
>    /** Tag of Element J **/
171a162
>    /** Tag of Element Seed **/
172a164
>    /** Tag of Element PgenCounter **/
174c166
< 
---
>    /** Tag of Element rawX509Certificate **/
175a168
>    /** Tag of Element X509IssuerSerial **/
176a170
>    /** Tag of Element X509SKI **/
177a172
>    /** Tag of Element X509SubjectName **/
178a174
>    /** Tag of Element X509Certificate **/
179a176
>    /** Tag of Element X509CRL **/
180a178
>    /** Tag of Element X509IssuerName **/
181a180
>    /** Tag of Element X509SerialNumber **/
182a182
>    /** Tag of Element PGPKeyID **/
183a184
>    /** Tag of Element PGPKeyPacket **/
184a186
>    /** Tag of Element SPKISexp **/
187c189
<    // Digest - Required SHA1
---
>    /** Digest - Required SHA1 */
209a212
>     * @throws XMLSecurityException
211c214
<     * @todo Add consistency checking for valid prefix
---
>     * $todo$ Add consistency checking for valid prefix
Only in xml-security-1_2_0/src/org/apache/xml/security/utils: DigesterOutputStream.java
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/ElementProxy.java xml-security-1_2_0/src/org/apache/xml/security/utils/ElementProxy.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,70d20
< import java.io.*;
< import java.util.*;
< import org.w3c.dom.*;
< import org.apache.xml.security.c14n.*;
< import org.apache.xml.security.exceptions.*;
< import org.apache.xml.security.c14n.CanonicalizationException;
< import org.apache.xml.security.signature.XMLSignatureException;
< import org.apache.xml.security.utils.*;
72,73c22,31
< import javax.xml.transform.TransformerException;
< import org.apache.xpath.XPathAPI;
---
> import java.util.HashMap;
> 
> import org.apache.xml.security.exceptions.Base64DecodingException;
> import org.apache.xml.security.exceptions.XMLSecurityException;
> import org.w3c.dom.Attr;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.Node;
> import org.w3c.dom.NodeList;
> import org.w3c.dom.Text;
80c38
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
84,86c42,44
<    /** Field cat */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(ElementProxy.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(ElementProxy.class.getName());
87a46
>     /** The element has been created by the code **/
88a48
>    /** The element has been readed from a DOM tree by the code **/
89a50
>    /** The element isn't known if it is readen or created **/
91a53
>    /** The element is going to be signed **/
92a55
>    /** The element is going to be verified **/
94a58
>    /** The element is going to be encrypted **/
95a60
>    /** The element is going to be decrypted **/
152c117
<               this.getBaseNamespace(), this.getBaseLocalName());
---
>               this.getBaseNamespace(), this.getBaseLocalName());      
165c130
<     * @return
---
>     * @return The element created.
169c134
< 
---
>        //Element nscontext = XMLUtils.createDSctx(doc, "x", namespace);
205,207c170,176
< 
<       cat.debug("setElement(" + element.getTagName() + ", \"" + BaseURI + "\"");
< 
---
>       if (log.isDebugEnabled()) {
>       }
>       
>       if (log.isDebugEnabled()) {
>       	log.debug("setElement(" + element.getTagName() + ", \"" + BaseURI + "\"");
>       }
>         
229,230c198,202
< 
<       cat.debug("setElement(\"" + element.getTagName() + "\", \"" + BaseURI + "\")");
---
>       
>       if (log.isDebugEnabled()) {
>       	log.debug("setElement(\"" + element.getTagName() + "\", \"" + BaseURI
>                 + "\")");
>       }
237c209
<       this.guaranteeThatElementInCorrectSpace(this.getBaseLocalName());
---
>       this.guaranteeThatElementInCorrectSpace();
268c240
<     * @return
---
>     * @return the Document where this element is contained.
277c249
<     * @return
---
>     * @return the base uri of the namespace of this element
286d257
<     * @param localname
289c260
<    public void guaranteeThatElementInCorrectSpace(String localname)
---
>    public void guaranteeThatElementInCorrectSpace()
292,300c263,271
<       if ((localname == null) || (localname.equals(""))
<               || (this._constructionElement == null)
<               || (this._constructionElement.getNamespaceURI() == null)
<               || (!this._constructionElement.getLocalName().equals(localname))
<               || (!this._constructionElement.getNamespaceURI()
<                  .equals(this.getBaseNamespace()))) {
<          Object exArgs[] = { localname,
<                              this._constructionElement.getLocalName() };
< 
---
>       String localnameSHOULDBE = this.getBaseLocalName();
>       String namespaceSHOULDBE = this.getBaseNamespace();
>       
>       String localnameIS = this._constructionElement.getLocalName();
>       String namespaceIS = this._constructionElement.getNamespaceURI();
>       if ( !localnameSHOULDBE.equals(localnameIS) ||
>         !namespaceSHOULDBE.equals(namespaceSHOULDBE)) {      
>          Object exArgs[] = { namespaceIS +":"+ localnameIS, 
>            namespaceSHOULDBE +":"+ localnameSHOULDBE};
331a303
> 
388,389c360,361
<     * @return
<     * @throws XMLSecurityException
---
>     * @return The biginter contained in the given element
>  * @throws Base64DecodingException
392c364,368
<            String localname, String namespace) throws XMLSecurityException {
---
>            String localname, String namespace) throws Base64DecodingException {
>    	    
>    		return Base64.decodeBigIntegerFromText(
>    				XMLUtils.selectNodeText(this._constructionElement.getFirstChild(),
>    						namespace,localname,0));
394,403d369
<       try {
<          Element nscontext = XMLUtils.createDSctx(this._doc, "x", namespace);
<          Text t = (Text) XPathAPI.selectSingleNode(this._constructionElement,
<                                                    "./x:" + localname
<                                                    + "/text()", nscontext);
< 
<          return Base64.decodeBigIntegerFromText(t);
<       } catch (TransformerException ex) {
<          throw new XMLSecurityException("empty", ex);
<       }
411c377
<     * @return
---
>     * @return the bytes
416,418c382
< 
<       try {
<          Element nscontext = XMLUtils.createDSctx(this._doc, "x", namespace);
---
>                
420,422c384,389
<             (Element) XPathAPI.selectSingleNode(this._constructionElement,
<                                                 "./x:" + localname, nscontext);
< 
---
>              XMLUtils.selectNode(
>                  this._constructionElement.getFirstChild(),
>                  namespace,
>                  localname,
>                  0);
>             
424,426d390
<       } catch (TransformerException ex) {
<          throw new XMLSecurityException("empty", ex);
<       }
434,435c398
<     * @return
<     * @throws XMLSecurityException
---
>     * @return the Text of the textNode
437,438c400,407
<    public String getTextFromChildElement(String localname, String namespace)
<            throws XMLSecurityException {
---
>    public String getTextFromChildElement(String localname, String namespace) {
>               
>          Text t =
>              (Text) XMLUtils.selectNode(
>                         this._constructionElement.getFirstChild(),
>                         namespace,
>                         localname,
>                         0).getFirstChild();
440,449c409
<       try {
<          Element nscontext = XMLUtils.createDSctx(this._doc, "x", namespace);
<          Text t = (Text) XPathAPI.selectSingleNode(this._constructionElement,
<                                                    "./x:" + localname
<                                                    + "/text()", nscontext);
< 
<          return t.getData();
<       } catch (TransformerException ex) {
<          throw new XMLSecurityException("empty", ex);
<       }
---
>          return t.getData();      
455c415
<     * @return
---
>     * @return The base64 bytes from the first text child of this element
459,462c419,421
< 
<       try {
<          Text t = (Text) XPathAPI.selectSingleNode(this._constructionElement,
<                                                    "./text()");
---
>       
>          Text t = (Text)this._constructionElement.getFirstChild();
>                                                    
465,467d423
<       } catch (TransformerException ex) {
<          throw new XMLSecurityException("empty", ex);
<       }
473c429
<     * @return
---
>     * @return the Text obtained concatening all the the text nodes of this element
479,516c435
<    /**
<     * This method returns the index&apos;th child with the given namespace
<     * and localname.
<     *
<     * @param index
<     * @param namespace
<     * @param localname
<     * @return null if the Element does not contain the requested child
<     */
<    public Element getChildElementLocalName(int index, String namespace,
<                                               String localname) {
< 
<       NodeList childNodes = this._constructionElement.getChildNodes();
<       int maxLength = childNodes.getLength();
< 
<       int result = -1;
<       for (int i=0; i<maxLength; i++) {
<          Node n = childNodes.item(i);
<          if (n.getNodeType() == Node.ELEMENT_NODE) {
<             String ns = n.getNamespaceURI();
<             String name = n.getLocalName();
< 
<             if (namespace != null && ns != null && namespace.equals(ns) ||
<                 namespace == null && ns == null) {
<                if (localname.equals(name)) {
<                   result++;
< 
<                   if (result == index) {
<                      return (Element) n;
<                   }
<                }
<             }
<          }
<       }
< 
<       // throw new IndexOutOfBoundsException("Try to get " + index + "/" + maxLength + " {" + namespace + "}" + localname + " from " + this._constructionElement.getTagName());
<       return null;
<    }
---
>   
523c442
<     * @return
---
>     * @return the number of elements {namespace}:localname under this element
526,546c445,456
<       NodeList childNodes = this._constructionElement.getChildNodes();
<       int maxLength = childNodes.getLength();
< 
<       int result = 0;
<       for (int i=0; i<maxLength; i++) {
<          Node n = childNodes.item(i);
<          if (n.getNodeType() == Node.ELEMENT_NODE) {
<             String ns = n.getNamespaceURI();
<             String name = n.getLocalName();
< 
<             if (namespace != null && ns != null && namespace.equals(ns) ||
<                 namespace == null && ns == null) {
<                if (localname.equals(name)) {
<                   result++;
<                }
<             }
<          }
<       }
< 
<       return result;
<    }
---
>    	    int number=0;
>    	    Node sibling=this._constructionElement.getFirstChild();
>    	    while (sibling!=null) {        
>    	    	if (localname.equals(sibling.getLocalName())
>    	    			&&  
> 					namespace.equals(sibling.getNamespaceURI())) {            
>    	    		number++;
>    	    	}
>    	    	sibling=sibling.getNextSibling();
>    	    }
>    	    return number;
>      }
566,567c476,477
<       if (prefix == null || prefix.length() == 0) {
<          ns = "xmlns";
---
>       if ((prefix == null) || (prefix.length() == 0)) {
>        throw new XMLSecurityException("defaultNamespaceCannotBeSetHere");
569c479
<          ns = "xmlns";
---
>         throw new XMLSecurityException("defaultNamespaceCannotBeSetHere");
571c481
<          ns = "xmlns:" + prefix.substring("xmlns:".length());
---
>          ns = prefix;//"xmlns:" + prefix.substring("xmlns:".length());
576,578c486
<       if (ns.equals("xmlns")) {
<          throw new XMLSecurityException("defaultNamespaceCannotBeSetHere");
<       }
---
>       
580c488
<       Attr a = this._constructionElement.getAttributeNode(ns);
---
>       Attr a = this._constructionElement.getAttributeNodeNS(Constants.NamespaceSpecNS, ns);
582,586c490,499
<       if ((a != null) && (!a.getNodeValue().equals(uri))) {
<          Object exArgs[] = { ns, this._constructionElement.getAttributeNS(null, ns) };
< 
<          throw new XMLSecurityException(
<             "namespacePrefixAlreadyUsedByOtherURI", exArgs);
---
>       if (a != null) { 
>        if (!a.getNodeValue().equals(uri)) {
>          Object exArgs[] = { ns,
>                              this._constructionElement.getAttributeNS(null,
>                                                                       ns) };
> 
>          throw new XMLSecurityException("namespacePrefixAlreadyUsedByOtherURI",
>                                         exArgs);
>        }
>        return;
604a518,523
>     
>    	if (ElementProxy._prefixMappings.containsValue(prefix)) {
>         
>    		Object storedNamespace=ElementProxy._prefixMappings.get(namespace);
>          if (!storedNamespace.equals(prefix)) {
>          	Object exArgs[] = { prefix, namespace, storedNamespace };
606,616c525
<       Iterator keys = ElementProxy._prefixMappings.keySet().iterator();
< 
<       while (keys.hasNext()) {
<          String storedNamespace = (String) keys.next();
<          String storedPrefix =
<             (String) ElementProxy._prefixMappings.get(storedNamespace);
< 
<          if (storedPrefix.equals(prefix) &&!storedNamespace.equals(namespace)) {
<             Object exArgs[] = { prefix, namespace, storedNamespace };
< 
<             throw new XMLSecurityException("prefix.AlreadyAssigned", exArgs);
---
>          	throw new XMLSecurityException("prefix.AlreadyAssigned", exArgs);
618,619c527
<       }
< 
---
>     }
627c535
<     * @return
---
>     * @return the default prefix bind to this element.
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/EncryptionConstants.java xml-security-1_2_0/src/org/apache/xml/security/utils/EncryptionConstants.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
68c26
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
72a31
>     /** Tag of Attr Algorithm **/
73a33
>    /** Tag of Attr Id**/
74a35
>    /** Tag of Attr Target **/
75a37
>    /** Tag of Attr Type **/
76a39
>    /** Tag of Attr URI **/
79a43
>    /** Tag of Attr encoding **/
81c45
<    public static final String _ATT_NONCE                  = "Nonce";
---
>    /** Tag of Attr recipient **/
82a47,48
>    /** Tag of Attr mimetype **/
>    public static final String _ATT_MIMETYPE               = "MimeType";
83a50
>    /** Tag of Element CarriedKeyName **/
84a52
>    /** Tag of Element CipherData **/
85a54
>    /** Tag of Element CipherReference **/
86a56
>    /** Tag of Element CipherValue **/
87a58
>    /** Tag of Element DataReference **/
88a60
>    /** Tag of Element EncryptedData **/
89a62
>    /** Tag of Element EncryptedKey **/
90a64
>    /** Tag of Element EncryptionMethod **/
91a66
>    /** Tag of Element EncryptionProperties **/
92a68
>    /** Tag of Element EncryptionProperty **/
93a70
>    /** Tag of Element KeyReference **/
94a72
>    /** Tag of Element KeySize **/
95a74
>    /** Tag of Element OAEPparams **/
96a76
>    /** Tag of Element ReferenceList **/
97a78
>    /** Tag of Element Transforms **/
98a80,87
>    /** Tag of Element AgreementMethod **/
>    public static final String _TAG_AGREEMENTMETHOD        = "AgreementMethod";
>    /** Tag of Element KA-Nonce **/
>    public static final String _TAG_KA_NONCE               = "KA-Nonce";
>    /** Tag of Element OriginatorKeyInfo **/
>    public static final String _TAG_ORIGINATORKEYINFO      = "OriginatorKeyInfo";
>    /** Tag of Element RecipientKeyInfo **/
>    public static final String _TAG_RECIPIENTKEYINFO       = "RecipientKeyInfo";
105a95
>    /** URI for content*/
106a97
>    /** URI for element*/
107a99
>    /** URI for mediatype*/
110c102
<    // Block Encryption - REQUIRED TRIPLEDES
---
>    /** Block Encryption - REQUIRED TRIPLEDES */
112c104
<    // Block Encryption - REQUIRED AES-128
---
>    /** Block Encryption - REQUIRED AES-128 */
114c106
<    // Block Encryption - REQUIRED AES-256
---
>    /** Block Encryption - REQUIRED AES-256 */
116c108
<    // Block Encryption - OPTIONAL AES-192
---
>    /** Block Encryption - OPTIONAL AES-192 */
119c111
<    // Key Transport - REQUIRED RSA-v1.5
---
>    /** Key Transport - REQUIRED RSA-v1.5*/
121c113
<    // Key Transport - REQUIRED RSA-OAEP
---
>    /** Key Transport - REQUIRED RSA-OAEP */
124,125c116,117
<    // Key Agreement - OPTIONAL Diffie-Hellman
<    public static final String ALGO_ID_KEYAGREEMENT_SH = EncryptionConstants.EncryptionSpecNS + "dh";
---
>    /** Key Agreement - OPTIONAL Diffie-Hellman */
>    public static final String ALGO_ID_KEYAGREEMENT_DH = EncryptionConstants.EncryptionSpecNS + "dh";
127c119
<    // Symmetric Key Wrap - REQUIRED TRIPLEDES KeyWrap
---
>    /** Symmetric Key Wrap - REQUIRED TRIPLEDES KeyWrap */
129c121
<    // Symmetric Key Wrap - REQUIRED AES-128 KeyWrap
---
>    /** Symmetric Key Wrap - REQUIRED AES-128 KeyWrap */
131c123
<    // Symmetric Key Wrap - REQUIRED AES-256 KeyWrap
---
>    /** Symmetric Key Wrap - REQUIRED AES-256 KeyWrap */
133c125
<    // Symmetric Key Wrap - OPTIONAL AES-192 KeyWrap
---
>    /** Symmetric Key Wrap - OPTIONAL AES-192 KeyWrap */
147c139
<    // Message Authentication - RECOMMENDED XML Digital Signature
---
>    /** Message Authentication - RECOMMENDED XML Digital Signature */
150c142
<    // Canonicalization - OPTIONAL Canonical XML with Comments
---
>    /** Canonicalization - OPTIONAL Canonical XML with Comments */
152c144
<    // Canonicalization - OPTIONAL Canonical XML (omits comments)
---
>    /** Canonicalization - OPTIONAL Canonical XML (omits comments) */
155c147
<    // Encoding - REQUIRED base64
---
>    /** Encoding - REQUIRED base64 */
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/EncryptionElementProxy.java xml-security-1_2_0/src/org/apache/xml/security/utils/EncryptionElementProxy.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,64c21,23
< import org.apache.xml.security.exceptions.*;
< import org.w3c.dom.*;
---
> import org.apache.xml.security.exceptions.XMLSecurityException;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
71c30
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
96,100c55
<    /**
<     * Method getBaseNamespace
<     *
<     * @return
<     */
---
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/HelperNodeList.java xml-security-1_2_0/src/org/apache/xml/security/utils/HelperNodeList.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64d21
< import org.w3c.dom.*;
66c23,26
< import org.apache.xml.security.utils.XMLUtils;
---
> 
> import org.w3c.dom.Document;
> import org.w3c.dom.Node;
> import org.w3c.dom.NodeList;
77,79c37,39
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(HelperNodeList.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>     org.apache.commons.logging.LogFactory.getLog(HelperNodeList.class.getName());
85a46,48
>    /**
>     * 
>     */
89a53,56
>    
>    /**
>     * @param allNodesMustHaveSameParent
>     */
98c65
<     * @return
---
>     * @return 
102c69
<       // cat.debug("item(" + index + ") of " + this.getLength() + " nodes");
---
>       // log.debug("item(" + index + ") of " + this.getLength() + " nodes");
110c77
<     * @return
---
>     *  @return 
119a87
>     * @throws IllegalArgumentException
129a98,100
>    /**
>     * @return
>     */
133,134d103
<       } else {
<          return XMLUtils.getOwnerDocument(this.item(0));
135a105
>       return XMLUtils.getOwnerDocument(this.item(0));
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/HexDump.java xml-security-1_2_0/src/org/apache/xml/security/utils/HexDump.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
58a17
> 
60a20
> import java.io.ByteArrayOutputStream;
62d21
< import java.io.*;
65d23
< 
71,886c29,819
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(HexDump.class.getName());
< 
<    private HexDump() {
<      // we don't allow instantiation
<    }
< 
<    /**
<     * Method prettyPrintHex
<     *
<     *
<     * @param baToConvert
<     * @return hexdump string
<     */
<    public static String prettyPrintHex(byte[] baToConvert) {
< 
<       HexDumpEncoder hde = new HexDumpEncoder();
< 
<       return hde.encodeBuffer(baToConvert);
<    }
< 
<    /**
<     * Method prettyPrintHex
<     *
<     *
<     * @param sToConvert
<     * @return hexdump string
<     */
<    public static String prettyPrintHex(String sToConvert) {
<       return prettyPrintHex(sToConvert.getBytes());
<    }
< 
<    /** Field DEBUG */
<    private static boolean DEBUG = false;
< 
<    /** Field HEX_DIGITS */
<    private final static char[] HEX_DIGITS = { '0', '1', '2', '3', '4', '5', '6',
<                                               '7', '8', '9', 'A', 'B', 'C', 'D',
<                                               'E', 'F' };
< 
<    /** Field BIT_DIGIT */
<    private static char[] BIT_DIGIT = { '0', '1' };
< 
<    /** Field COMPARE_BITS */
<    private final static byte[] COMPARE_BITS = { (byte) 0x80, (byte) 0x40,
<                                                 (byte) 0x20, (byte) 0x10,
<                                                 (byte) 0x08, (byte) 0x04,
<                                                 (byte) 0x02, (byte) 0x01 };
< 
<    /** Field BYTE_SEPARATOR */
<    private static char BYTE_SEPARATOR = ' ';
< 
<    /** Field WITH_BYTE_SEPARATOR */
<    private static boolean WITH_BYTE_SEPARATOR = true;
< 
<    /**
<     *  Sets the Debug attribute of the Convert object
<     *
<     * @param  dbg  The new Debug value
<     */
<    public static void setDebug(boolean dbg) {
<       DEBUG = dbg;
<    }
< 
<    /**
<     *  Sets the WithByteSeparator attribute of the Convert class
<     *
<     * @param  bs  The new WithByteSeparator value
<     */
<    public static void setWithByteSeparator(boolean bs) {
<       WITH_BYTE_SEPARATOR = bs;
<    }
< 
<    /**
<     *  Sets the ByteSeparator attribute of the Convert class
<     *
<     * @param  bs  The new ByteSeparator value
<     */
<    public static void setByteSeparator(char bs) {
<       BYTE_SEPARATOR = bs;
<    }
< 
<    /**
<     *  Sets the BitDigits attribute of the Convert class
<     *
<     * @param  bd             The new BitDigits value
<     * @exception  Exception  Description of Exception
<     */
<    public static void setBitDigits(char[] bd) throws Exception {
< 
<       if (bd.length != 2) {
<          throw new Exception("wrong number of characters!");
<       }
< 
<       BIT_DIGIT = bd;
<    }
< 
<    /**
<     * Method setBitDigits
<     *
<     * @param zeroBit
<     * @param oneBit
<     */
<    public static void setBitDigits(char zeroBit, char oneBit) {
<       BIT_DIGIT[0] = zeroBit;
<       BIT_DIGIT[1] = oneBit;
<    }
< 
<    /*
<     * Converts a byte array to hex string
<     */
< 
<    /**
<     *  Description of the Method
<     *
<     * @param  block  Description of Parameter
<     * @return        Description of the Returned Value
<     */
<    public static String byteArrayToBinaryString(byte[] block) {
< 
<       StringBuffer strBuf = new StringBuffer();
<       int iLen = block.length;
< 
<       //---- for all bytes of array
<       for (int i = 0; i < iLen; i++) {
<          byte2bin(block[i], strBuf);
< 
<          //---- if bit i is set   ----//
<          if ((i < iLen - 1) & WITH_BYTE_SEPARATOR) {
<             strBuf.append(BYTE_SEPARATOR);
<          }
<       }
< 
<       return strBuf.toString();
<    }
< 
<    /**
<     * Method toBinaryString
<     *
<     * @param ba
<     * @return
<     */
<    public static String toBinaryString(byte[] ba) {
<       return byteArrayToBinaryString(ba);
<    }
< 
<    /**
<     * Method toBinaryString
<     *
<     * @param b
<     * @return
<     */
<    public static String toBinaryString(byte b) {
< 
<       byte[] ba = new byte[1];
< 
<       ba[0] = b;
< 
<       return byteArrayToBinaryString(ba);
<    }
< 
<    /**
<     * Method toBinaryString
<     *
<     * @param s
<     * @return
<     */
<    public static String toBinaryString(short s) {
<       return toBinaryString(toByteArray(s));
<    }
< 
<    /**
<     * Method toBinaryString
<     *
<     * @param i
<     * @return
<     */
<    public static String toBinaryString(int i) {
<       return toBinaryString(toByteArray(i));
<    }
< 
<    /**
<     * Method toBinaryString
<     *
<     * @param l
<     * @return
<     */
<    public static String toBinaryString(long l) {
<       return toBinaryString(toByteArray(l));
<    }
< 
<    /**
<     * Method toByteArray
<     *
<     * @param s
<     * @return
<     */
<    public static final byte[] toByteArray(short s) {
< 
<       byte[] baTemp = new byte[2];
< 
<       baTemp[1] = (byte) (s);
<       baTemp[0] = (byte) (s >> 8);
< 
<       return baTemp;
<    }
< 
<    /**
<     * Method toByteArray
<     *
<     * @param i
<     * @return
<     */
<    public static final byte[] toByteArray(int i) {
< 
<       byte[] baTemp = new byte[4];
< 
<       baTemp[3] = (byte) i;
<       baTemp[2] = (byte) (i >> 8);
<       baTemp[1] = (byte) (i >> 16);
<       baTemp[0] = (byte) (i >> 24);
< 
<       return baTemp;
<    }
< 
<    /**
<     * Method toByteArray
<     *
<     * @param l
<     * @return
<     */
<    public static final byte[] toByteArray(long l) {
< 
<       byte[] baTemp = new byte[8];
< 
<       baTemp[7] = (byte) l;
<       baTemp[6] = (byte) (l >> 8);
<       baTemp[5] = (byte) (l >> 16);
<       baTemp[4] = (byte) (l >> 24);
<       baTemp[3] = (byte) (l >> 32);
<       baTemp[2] = (byte) (l >> 40);
<       baTemp[1] = (byte) (l >> 48);
<       baTemp[0] = (byte) (l >> 56);
< 
<       return baTemp;
<    }
< 
<    /**
<     *  Description of the Method
<     *
<     * @param  block  Description of Parameter
<     * @return        Description of the Returned Value
<     */
<    public static String byteArrayToHexString(byte[] block) {
< 
<       long lTime = System.currentTimeMillis();
<       StringBuffer buf = new StringBuffer();
<       int len = block.length;
< 
<       for (int i = 0; i < len; i++) {
<          byte2hex(block[i], buf);
< 
<          if ((i < len - 1) & WITH_BYTE_SEPARATOR) {
<             buf.append(BYTE_SEPARATOR);
<          }
<       }
< 
<       return buf.toString();
<    }
< 
<    /**
<     *  Description of the Method
<     *
<     * @param  in  string to be converted
<     * @return     String in readable hex encoding
<     */
<    public static String stringToHexString(String in) {
< 
<       byte[] ba = in.getBytes();
< 
<       return toHexString(ba);
<    }
< 
<    /**
<     *  Description of the Method
<     *
<     * @param  block   Description of Parameter
<     * @param  offset  Description of Parameter
<     * @param  length  Description of Parameter
<     * @return         Description of the Returned Value
<     */
<    public static String byteArrayToHexString(byte[] block, int offset,
<                                              int length) {
< 
<       long lTime = System.currentTimeMillis();
<       StringBuffer buf = new StringBuffer();
<       int len = block.length;
< 
<       length = length + offset;
< 
<       if ((len < length)) {
<          length = len;
<       }
< 
<       for (int i = 0 + offset; i < length; i++) {
<          byte2hex(block[i], buf);
< 
<          if (i < length - 1) {
<             buf.append(":");
<          }
<       }
< 
<       return buf.toString();
<    }
< 
<    /**
<     *  Returns a string of hexadecimal digits from a byte array. Each byte is
<     *  converted to 2 hex symbols.
<     *
<     * @param  ba  Description of Parameter
<     * @return     Description of the Returned Value
<     */
<    public static String toHexString(byte[] ba) {
<       return toHexString(ba, 0, ba.length);
<    }
< 
<    /**
<     * Method toHexString
<     *
<     * @param b
<     * @return
<     */
<    public static String toHexString(byte b) {
< 
<       byte[] ba = new byte[1];
< 
<       ba[0] = b;
< 
<       return toHexString(ba, 0, ba.length);
<    }
< 
<    /**
<     *  Description of the Method
<     *
<     * @param s
<     * @return               Description of the Returned Value
<     */
<    public static String toHexString(short s) {
<       return toHexString(toByteArray(s));
<    }
< 
<    /**
<     * Method toHexString
<     *
<     * @param i
<     * @return
<     */
<    public static String toHexString(int i) {
<       return toHexString(toByteArray(i));
<    }
< 
<    /**
<     * Method toHexString
<     *
<     * @param l
<     * @return
<     */
<    public static String toHexString(long l) {
<       return toHexString(toByteArray(l));
<    }
< 
<    /**
<     * Method toString
<     *
<     * @param ba
<     * @return
<     */
<    public static String toString(byte[] ba) {
<       return new String(ba).toString();
<    }
< 
<    /**
<     * Method toString
<     *
<     * @param b
<     * @return
<     */
<    public static String toString(byte b) {
< 
<       byte[] ba = new byte[1];
< 
<       ba[0] = b;
< 
<       return new String(ba).toString();
<    }
< 
<    /**
<     *  converts String to Hex String. Example: niko ->6E696B6F
<     *
<     * @param  ba      Description of Parameter
<     * @param  offset  Description of Parameter
<     * @param  length  Description of Parameter
<     * @return         Description of the Returned Value
<     */
<    public static String toHexString(byte[] ba, int offset, int length) {
< 
<       long lTime = System.currentTimeMillis();
<       char[] buf;
< 
<       if (WITH_BYTE_SEPARATOR) {
<          buf = new char[length * 3];
<       } else {
<          buf = new char[length * 2];
<       }
< 
<       for (int i = offset, j = 0, k; i < offset + length; ) {
<          k = ba[i++];
<          buf[j++] = HEX_DIGITS[(k >>> 4) & 0x0F];
<          buf[j++] = HEX_DIGITS[k & 0x0F];
< 
<          if (WITH_BYTE_SEPARATOR) {
<             buf[j++] = BYTE_SEPARATOR;
<          }
<       }
< 
<       return new String(buf);
<    }
< 
<    /**
<     * Converts readable hex-String to byteArray
<     *
<     * @param strA
<     * @return
<     */
<    public static byte[] hexStringToByteArray(String strA) {
<       ByteArrayOutputStream result = new ByteArrayOutputStream();
< 
<       // alle Hex-Zeichen konvertieren, den Rest Ignorieren
<       // jedes Zeichen stellt einen 4-Bit Wert dar
<       byte sum = (byte) 0x00;
<       boolean nextCharIsUpper = true;
< 
<       for (int i = 0; i < strA.length(); i++) {
<          char c = strA.charAt(i);
< 
<          switch (Character.toUpperCase(c)) {
< 
<          case '0' :
<             if (nextCharIsUpper) {
<                sum = (byte) 0x00;
<                nextCharIsUpper = false;
<             } else {
<                sum |= (byte) 0x00;
<                result.write(sum);
<                nextCharIsUpper = true;
<             }
<             break;
< 
<          case '1' :
<             if (nextCharIsUpper) {
<                sum = (byte) 0x10;
<                nextCharIsUpper = false;
<             } else {
<                sum |= (byte) 0x01;
<                result.write(sum);
<                nextCharIsUpper = true;
<             }
<             break;
< 
<          case '2' :
<             if (nextCharIsUpper) {
<                sum = (byte) 0x20;
<                nextCharIsUpper = false;
<             } else {
<                sum |= (byte) 0x02;
<                result.write(sum);
<                nextCharIsUpper = true;
<             }
<             break;
< 
<          case '3' :
<             if (nextCharIsUpper) {
<                sum = (byte) 0x30;
<                nextCharIsUpper = false;
<             } else {
<                sum |= (byte) 0x03;
<                result.write(sum);
<                nextCharIsUpper = true;
<             }
<             break;
< 
<          case '4' :
<             if (nextCharIsUpper) {
<                sum = (byte) 0x40;
<                nextCharIsUpper = false;
<             } else {
<                sum |= (byte) 0x04;
<                result.write(sum);
<                nextCharIsUpper = true;
<             }
<             break;
< 
<          case '5' :
<             if (nextCharIsUpper) {
<                sum = (byte) 0x50;
<                nextCharIsUpper = false;
<             } else {
<                sum |= (byte) 0x05;
<                result.write(sum);
<                nextCharIsUpper = true;
<             }
<             break;
< 
<          case '6' :
<             if (nextCharIsUpper) {
<                sum = (byte) 0x60;
<                nextCharIsUpper = false;
<             } else {
<                sum |= (byte) 0x06;
<                result.write(sum);
<                nextCharIsUpper = true;
<             }
<             break;
< 
<          case '7' :
<             if (nextCharIsUpper) {
<                sum = (byte) 0x70;
<                nextCharIsUpper = false;
<             } else {
<                sum |= (byte) 0x07;
<                result.write(sum);
<                nextCharIsUpper = true;
<             }
<             break;
< 
<          case '8' :
<             if (nextCharIsUpper) {
<                sum = (byte) 0x80;
<                nextCharIsUpper = false;
<             } else {
<                sum |= (byte) 0x08;
<                result.write(sum);
<                nextCharIsUpper = true;
<             }
<             break;
< 
<          case '9' :
<             if (nextCharIsUpper) {
<                sum = (byte) 0x90;
<                nextCharIsUpper = false;
<             } else {
<                sum |= (byte) 0x09;
<                result.write(sum);
<                nextCharIsUpper = true;
<             }
<             break;
< 
<          case 'A' :
<             if (nextCharIsUpper) {
<                sum = (byte) 0xA0;
<                nextCharIsUpper = false;
<             } else {
<                sum |= (byte) 0x0A;
<                result.write(sum);
<                nextCharIsUpper = true;
<             }
<             break;
< 
<          case 'B' :
<             if (nextCharIsUpper) {
<                sum = (byte) 0xB0;
<                nextCharIsUpper = false;
<             } else {
<                sum |= (byte) 0x0B;
<                result.write(sum);
<                nextCharIsUpper = true;
<             }
<             break;
< 
<          case 'C' :
<             if (nextCharIsUpper) {
<                sum = (byte) 0xC0;
<                nextCharIsUpper = false;
<             } else {
<                sum |= (byte) 0x0C;
<                result.write(sum);
<                nextCharIsUpper = true;
<             }
<             break;
< 
<          case 'D' :
<             if (nextCharIsUpper) {
<                sum = (byte) 0xD0;
<                nextCharIsUpper = false;
<             } else {
<                sum |= (byte) 0x0D;
<                result.write(sum);
<                nextCharIsUpper = true;
<             }
<             break;
< 
<          case 'E' :
<             if (nextCharIsUpper) {
<                sum = (byte) 0xE0;
<                nextCharIsUpper = false;
<             } else {
<                sum |= (byte) 0x0E;
<                result.write(sum);
<                nextCharIsUpper = true;
<             }
<             break;
< 
<          case 'F' :
<             if (nextCharIsUpper) {
<                sum = (byte) 0xF0;
<                nextCharIsUpper = false;
<             } else {
<                sum |= (byte) 0x0F;
<                result.write(sum);
<                nextCharIsUpper = true;
<             }
<             break;
<          }
<       }
< 
<       if (!nextCharIsUpper) {
<          throw new RuntimeException("The String did not contain an equal number of hex digits");
<       }
< 
<       return result.toByteArray();
<    }
< 
<    /*
<     * Converts a byte to hex digit and writes to the supplied buffer
<     */
< 
<    /**
<     *  Description of the Method
<     *
<     * @param  b    Description of Parameter
<     * @param  buf  Description of Parameter
<     */
<    private static void byte2hex(byte b, StringBuffer buf) {
< 
<       char[] hexChars = { '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A',
<                           'B', 'C', 'D', 'E', 'F' };
<       int high = ((b & 0xf0) >> 4);
<       int low = (b & 0x0f);
< 
<       buf.append(hexChars[high]);
<       buf.append(hexChars[low]);
<    }
< 
<    /**
<     *  Description of the Method
<     *
<     * @param  b    Description of Parameter
<     * @param  buf  Description of Parameter
<     */
<    private static void byte2bin(byte b, StringBuffer buf) {
< 
<       // test every 8 bit
<       for (int i = 0; i < 8; i++) {
< 
<          //---test if bit is set
<          if ((b & COMPARE_BITS[i]) != 0) {
<             buf.append(BIT_DIGIT[1]);
<          } else {
<             buf.append(BIT_DIGIT[0]);
<          }
<       }
<    }
< 
<    /**
<     *  Returns a string of 8 hexadecimal digits (most significant digit first)
<     *  corresponding to the integer <i>n</i> , which is treated as unsigned.
<     *
<     * @param  n  Description of Parameter
<     * @return    Description of the Returned Value
<     */
<    private static String intToHexString(int n) {
< 
<       char[] buf = new char[8];
< 
<       for (int i = 7; i >= 0; i--) {
<          buf[i] = HEX_DIGITS[n & 0x0F];
<          n >>>= 4;
<       }
< 
<       return new String(buf);
<    }
< 
<    /**
<     *  test and demo for the Convert class
<     *
<     * @param  args  none needed
<     */
<    public static void main(String args[]) {
< 
<       System.out.println("-test and demo of the converter ");
< 
<       // enable debug outputs
<       setDebug(false);
< 
<       String str = new String("Niko");
<       byte[] ba = str.getBytes();
< 
<       System.out.println("to convert: " + str);
<       System.out.println("converted1: " + byteArrayToHexString(ba));
<       System.out.println("converted1: "
<                          + byteArrayToHexString(ba, 0, ba.length));
<       System.out.println("converted3: " + stringToHexString(str));
<       System.out.println("----Convert integer to hexString...");
< 
<       int i = -2;
< 
<       System.out.println("to convert: " + i + " -> " + intToHexString(i));
<       System.out.println("----Convert byte[] to binary String...");
< 
<       byte[] baToConvert = { (byte) 0xff, (byte) 0x00, (byte) 0x33, (byte) 0x11,
<                              (byte) 0xff, (byte) 0x5f, (byte) 0x5f, (byte) 0x4f,
<                              (byte) 0x1f, (byte) 0xff };
< 
<       System.out.println("to convert: " + toHexString(baToConvert) + " -> "
<                          + byteArrayToBinaryString(baToConvert));
< 
<       //---- modify line separator
<       setByteSeparator('-');
<       System.out.println("to convert: " + toHexString(baToConvert) + " -> "
<                          + byteArrayToBinaryString(baToConvert));
< 
<       //---- modify line separator
<       setByteSeparator('*');
<       setWithByteSeparator(true);
<       System.out.println("to convert: " + toHexString(baToConvert) + " -> "
<                          + byteArrayToBinaryString(baToConvert));
< 
<       //---- modify bit digits
<       char[] bd = { 'a', 'b' };
< 
<       try {
<          setBitDigits(bd);
<       } catch (Exception ex) {
<          ex.printStackTrace();
<       }
< 
<       System.out.println("to convert: " + toHexString(baToConvert) + " -> "
<                          + byteArrayToBinaryString(baToConvert));
< 
<       //------------------------------------------------//
<       setBitDigits('0', '1');
<       System.out.println("---- Convert.toByteArray(int) ");
< 
<       for (int iToConvert = -10; iToConvert < 10; iToConvert++) {
<          System.out.println("to convert = " + iToConvert + " = "
<                             + HexDump.toBinaryString(iToConvert));
< 
<          byte[] baConvInt = new byte[4];
< 
<          baConvInt = HexDump.toByteArray(iToConvert);
< 
<          System.out.println("convertet byteArray = "
<                             + HexDump.toBinaryString(baConvInt));
<       }
< 
<       System.out.println("---- toHexString(int) ");
< 
<       i = -1;
< 
<       System.out.println(i + " = 0x" + toHexString(i) + " = "
<                          + toBinaryString(i));
< 
<       i++;
< 
<       System.out.println(i + " = 0x" + toHexString(i) + " = "
<                          + toBinaryString(i));
< 
<       //------------------------------------------------//
<       System.out.println("---- toHexString(long) ");
< 
<       long l = 100;
< 
<       System.out.println(l + " = 0x" + toHexString(l) + " = "
<                          + toBinaryString(l));
< 
<       java.util.Random rnd = new java.util.Random();
< 
<       l = rnd.nextLong();
< 
<       System.out.println(l + " = 0x" + toHexString(l) + " = "
<                          + toBinaryString(l));
< 
<       //------------------------------------------------//
<       System.out.println("---- toHexString(short) ");
< 
<       short s = 100;
< 
<       System.out.println(s + " = 0x" + toHexString(s) + " = "
<                          + toBinaryString(s));
< 
<       rnd = new java.util.Random();
<       s = (short) rnd.nextInt();
< 
<       System.out.println(s + " = 0x" + toHexString(s) + " = "
<                          + toBinaryString(s));
< 
<       //---------------------------------------------------------------------------//
<       // convert dezimal-String to binary
<       System.out.println("---- read file in Hex-Format ");
< 
<       String strToConvert = "12345654321";
< 
<       System.out.println(strToConvert + " = "
<                          + stringToHexString(strToConvert));
<       System.out.println("Das ist die Hex-Darstellung des obigen Strings");
---
>     /**
>      * Method prettyPrintHex
>      *
>      *
>      * @param baToConvert
>      * @return hexdump string
>      */
>     public static String prettyPrintHex(byte[] baToConvert) {
> 
>         HexDumpEncoder hde = new HexDumpEncoder();
> 
>         return hde.encodeBuffer(baToConvert);
>     }
> 
>     /**
>      * Method prettyPrintHex
>      *
>      *
>      * @param sToConvert
>      * @return hexdump string
>      */
>     public static String prettyPrintHex(String sToConvert) {
>         return prettyPrintHex(sToConvert.getBytes());
>     }
> 
>     /** Field HEX_DIGITS */
>     private final static char[] HEX_DIGITS = { '0', '1', '2', '3', '4', '5', '6',
>         '7', '8', '9', 'A', 'B', 'C', 'D',
>         'E', 'F' };
> 
>     /** Field BIT_DIGIT */
>     private static char[] BIT_DIGIT = { '0', '1' };
> 
>     /** Field COMPARE_BITS */
>     private final static byte[] COMPARE_BITS = { (byte) 0x80, (byte) 0x40,
>         (byte) 0x20, (byte) 0x10,
>         (byte) 0x08, (byte) 0x04,
>         (byte) 0x02, (byte) 0x01 };
> 
>     /** Field BYTE_SEPARATOR */
>     private static char BYTE_SEPARATOR = ' ';
> 
>     /** Field WITH_BYTE_SEPARATOR */
>     private static boolean WITH_BYTE_SEPARATOR = true;
> 
> 
>     /**
>      *  Sets the WithByteSeparator attribute of the Convert class
>      *
>      * @param  bs  The new WithByteSeparator value
>      */
>     public static void setWithByteSeparator(boolean bs) {
>         WITH_BYTE_SEPARATOR = bs;
>     }
> 
>     /**
>      *  Sets the ByteSeparator attribute of the Convert class
>      *
>      * @param  bs  The new ByteSeparator value
>      */
>     public static void setByteSeparator(char bs) {
>         BYTE_SEPARATOR = bs;
>     }
> 
>     /**
>      *  Sets the BitDigits attribute of the Convert class
>      *
>      * @param  bd             The new BitDigits value
>      * @exception  Exception  Description of Exception
>      */
>     public static void setBitDigits(char[] bd) throws Exception {
> 
>         if (bd.length != 2) {
>             throw new Exception("wrong number of characters!");
>         }
> 
>         BIT_DIGIT = bd;
>     }
> 
>     /**
>      * Method setBitDigits
>      *
>      * @param zeroBit
>      * @param oneBit
>      */
>     public static void setBitDigits(char zeroBit, char oneBit) {
>         BIT_DIGIT[0] = zeroBit;
>         BIT_DIGIT[1] = oneBit;
>     }
> 
>     /*
>      * Converts a byte array to hex string
>      */
> 
>     /**
>      *  Description of the Method
>      *
>      * @param  block  Description of Parameter
>      * @return        Description of the Returned Value
>      */
>     public static String byteArrayToBinaryString(byte[] block) {
> 
>         StringBuffer strBuf = new StringBuffer();
>         int iLen = block.length;
> 
>         //---- for all bytes of array
>         for (int i = 0; i < iLen; i++) {
>             byte2bin(block[i], strBuf);
> 
>             //---- if bit i is set   ----//
>             if ((i < iLen - 1) & WITH_BYTE_SEPARATOR) {
>                 strBuf.append(BYTE_SEPARATOR);
>             }
>         }
> 
>         return strBuf.toString();
>     }
> 
>     /**
>      * Method toBinaryString
>      *
>      * @param ba
>      * @return
>      */
>     public static String toBinaryString(byte[] ba) {
>         return byteArrayToBinaryString(ba);
>     }
> 
>     /**
>      * Method toBinaryString
>      *
>      * @param b
>      * @return
>      */
>     public static String toBinaryString(byte b) {
> 
>         byte[] ba = new byte[1];
> 
>         ba[0] = b;
> 
>         return byteArrayToBinaryString(ba);
>     }
> 
>     /**
>      * Method toBinaryString
>      *
>      * @param s
>      * @return
>      */
>     public static String toBinaryString(short s) {
>         return toBinaryString(toByteArray(s));
>     }
> 
>     /**
>      * Method toBinaryString
>      *
>      * @param i
>      * @return
>      */
>     public static String toBinaryString(int i) {
>         return toBinaryString(toByteArray(i));
>     }
> 
>     /**
>      * Method toBinaryString
>      *
>      * @param l
>      * @return
>      */
>     public static String toBinaryString(long l) {
>         return toBinaryString(toByteArray(l));
>     }
> 
>     /**
>      * Method toByteArray
>      *
>      * @param s
>      * @return
>      */
>     public static final byte[] toByteArray(short s) {
> 
>         byte[] baTemp = new byte[2];
> 
>         baTemp[1] = (byte) (s);
>         baTemp[0] = (byte) (s >> 8);
> 
>         return baTemp;
>     }
> 
>     /**
>      * Method toByteArray
>      *
>      * @param i
>      * @return
>      */
>     public static final byte[] toByteArray(int i) {
> 
>         byte[] baTemp = new byte[4];
> 
>         baTemp[3] = (byte) i;
>         baTemp[2] = (byte) (i >> 8);
>         baTemp[1] = (byte) (i >> 16);
>         baTemp[0] = (byte) (i >> 24);
> 
>         return baTemp;
>     }
> 
>     /**
>      * Method toByteArray
>      *
>      * @param l
>      * @return
>      */
>     public static final byte[] toByteArray(long l) {
> 
>         byte[] baTemp = new byte[8];
> 
>         baTemp[7] = (byte) l;
>         baTemp[6] = (byte) (l >> 8);
>         baTemp[5] = (byte) (l >> 16);
>         baTemp[4] = (byte) (l >> 24);
>         baTemp[3] = (byte) (l >> 32);
>         baTemp[2] = (byte) (l >> 40);
>         baTemp[1] = (byte) (l >> 48);
>         baTemp[0] = (byte) (l >> 56);
> 
>         return baTemp;
>     }
> 
>     /**
>      *  Description of the Method
>      *
>      * @param  block  Description of Parameter
>      * @return        Description of the Returned Value
>      */
>     public static String byteArrayToHexString(byte[] block) {
> 
>         StringBuffer buf = new StringBuffer();
>         int len = block.length;
> 
>         for (int i = 0; i < len; i++) {
>             byte2hex(block[i], buf);
> 
>             if ((i < len - 1) & WITH_BYTE_SEPARATOR) {
>                 buf.append(BYTE_SEPARATOR);
>             }
>         }
> 
>         return buf.toString();
>     }
> 
>     /**
>      *  Description of the Method
>      *
>      * @param  in  string to be converted
>      * @return     String in readable hex encoding
>      */
>     public static String stringToHexString(String in) {
> 
>         byte[] ba = in.getBytes();
> 
>         return toHexString(ba);
>     }
> 
>     /**
>      *  Description of the Method
>      *
>      * @param  block   Description of Parameter
>      * @param  offset  Description of Parameter
>      * @param  length  Description of Parameter
>      * @return         Description of the Returned Value
>      */
>     public static String byteArrayToHexString(byte[] block, int offset,
>             int length) {
> 
>         StringBuffer buf = new StringBuffer();
>         int len = block.length;
> 
>         length = length + offset;
> 
>         if ((len < length)) {
>             length = len;
>         }
> 
>         for (int i = 0 + offset; i < length; i++) {
>             byte2hex(block[i], buf);
> 
>             if (i < length - 1) {
>                 buf.append(":");
>             }
>         }
> 
>         return buf.toString();
>     }
> 
>     /**
>      *  Returns a string of hexadecimal digits from a byte array. Each byte is
>      *  converted to 2 hex symbols.
>      *
>      * @param  ba  Description of Parameter
>      * @return     Description of the Returned Value
>      */
>     public static String toHexString(byte[] ba) {
>         return toHexString(ba, 0, ba.length);
>     }
> 
>     /**
>      * Method toHexString
>      *
>      * @param b
>      * @return
>      */
>     public static String toHexString(byte b) {
> 
>         byte[] ba = new byte[1];
> 
>         ba[0] = b;
> 
>         return toHexString(ba, 0, ba.length);
>     }
> 
>     /**
>      *  Description of the Method
>      *
>      * @param s
>      * @return               Description of the Returned Value
>      */
>     public static String toHexString(short s) {
>         return toHexString(toByteArray(s));
>     }
> 
>     /**
>      * Method toHexString
>      *
>      * @param i
>      * @return
>      */
>     public static String toHexString(int i) {
>         return toHexString(toByteArray(i));
>     }
> 
>     /**
>      * Method toHexString
>      *
>      * @param l
>      * @return
>      */
>     public static String toHexString(long l) {
>         return toHexString(toByteArray(l));
>     }
> 
>     /**
>      * Method toString
>      *
>      * @param ba
>      * @return
>      */
>     public static String toString(byte[] ba) {
>         return new String(ba).toString();
>     }
> 
>     /**
>      * Method toString
>      *
>      * @param b
>      * @return
>      */
>     public static String toString(byte b) {
> 
>         byte[] ba = new byte[1];
> 
>         ba[0] = b;
> 
>         return new String(ba).toString();
>     }
> 
>     /**
>      *  converts String to Hex String. Example: niko ->6E696B6F
>      *
>      * @param  ba      Description of Parameter
>      * @param  offset  Description of Parameter
>      * @param  length  Description of Parameter
>      * @return         Description of the Returned Value
>      */
>     public static String toHexString(byte[] ba, int offset, int length) {
> 
>         char[] buf;
> 
>         if (WITH_BYTE_SEPARATOR) {
>             buf = new char[length * 3];
>         } else {
>             buf = new char[length * 2];
>         }
> 
>         for (int i = offset, j = 0, k; i < offset + length; ) {
>             k = ba[i++];
>             buf[j++] = HEX_DIGITS[(k >>> 4) & 0x0F];
>             buf[j++] = HEX_DIGITS[k & 0x0F];
> 
>             if (WITH_BYTE_SEPARATOR) {
>                 buf[j++] = BYTE_SEPARATOR;
>             }
>         }
> 
>         return new String(buf);
>     }
> 
>     /**
>      * Converts readable hex-String to byteArray
>      *
>      * @param strA
>      * @return
>      */
>     public static byte[] hexStringToByteArray(String strA) {
>         ByteArrayOutputStream result = new ByteArrayOutputStream();
> 
>         // alle Hex-Zeichen konvertieren, den Rest Ignorieren
>         // jedes Zeichen stellt einen 4-Bit Wert dar
>         byte sum = (byte) 0x00;
>         boolean nextCharIsUpper = true;
> 
>         for (int i = 0; i < strA.length(); i++) {
>             char c = strA.charAt(i);
> 
>             switch (Character.toUpperCase(c)) {
> 
>             case '0' :
>                 if (nextCharIsUpper) {
>                     sum = (byte) 0x00;
>                     nextCharIsUpper = false;
>                 } else {
>                     sum |= (byte) 0x00;
>                     result.write(sum);
>                     nextCharIsUpper = true;
>                 }
>                 break;
> 
>             case '1' :
>                 if (nextCharIsUpper) {
>                     sum = (byte) 0x10;
>                     nextCharIsUpper = false;
>                 } else {
>                     sum |= (byte) 0x01;
>                     result.write(sum);
>                     nextCharIsUpper = true;
>                 }
>                 break;
> 
>             case '2' :
>                 if (nextCharIsUpper) {
>                     sum = (byte) 0x20;
>                     nextCharIsUpper = false;
>                 } else {
>                     sum |= (byte) 0x02;
>                     result.write(sum);
>                     nextCharIsUpper = true;
>                 }
>                 break;
> 
>             case '3' :
>                 if (nextCharIsUpper) {
>                     sum = (byte) 0x30;
>                     nextCharIsUpper = false;
>                 } else {
>                     sum |= (byte) 0x03;
>                     result.write(sum);
>                     nextCharIsUpper = true;
>                 }
>                 break;
> 
>             case '4' :
>                 if (nextCharIsUpper) {
>                     sum = (byte) 0x40;
>                     nextCharIsUpper = false;
>                 } else {
>                     sum |= (byte) 0x04;
>                     result.write(sum);
>                     nextCharIsUpper = true;
>                 }
>                 break;
> 
>             case '5' :
>                 if (nextCharIsUpper) {
>                     sum = (byte) 0x50;
>                     nextCharIsUpper = false;
>                 } else {
>                     sum |= (byte) 0x05;
>                     result.write(sum);
>                     nextCharIsUpper = true;
>                 }
>                 break;
> 
>             case '6' :
>                 if (nextCharIsUpper) {
>                     sum = (byte) 0x60;
>                     nextCharIsUpper = false;
>                 } else {
>                     sum |= (byte) 0x06;
>                     result.write(sum);
>                     nextCharIsUpper = true;
>                 }
>                 break;
> 
>             case '7' :
>                 if (nextCharIsUpper) {
>                     sum = (byte) 0x70;
>                     nextCharIsUpper = false;
>                 } else {
>                     sum |= (byte) 0x07;
>                     result.write(sum);
>                     nextCharIsUpper = true;
>                 }
>                 break;
> 
>             case '8' :
>                 if (nextCharIsUpper) {
>                     sum = (byte) 0x80;
>                     nextCharIsUpper = false;
>                 } else {
>                     sum |= (byte) 0x08;
>                     result.write(sum);
>                     nextCharIsUpper = true;
>                 }
>                 break;
> 
>             case '9' :
>                 if (nextCharIsUpper) {
>                     sum = (byte) 0x90;
>                     nextCharIsUpper = false;
>                 } else {
>                     sum |= (byte) 0x09;
>                     result.write(sum);
>                     nextCharIsUpper = true;
>                 }
>                 break;
> 
>             case 'A' :
>                 if (nextCharIsUpper) {
>                     sum = (byte) 0xA0;
>                     nextCharIsUpper = false;
>                 } else {
>                     sum |= (byte) 0x0A;
>                     result.write(sum);
>                     nextCharIsUpper = true;
>                 }
>                 break;
> 
>             case 'B' :
>                 if (nextCharIsUpper) {
>                     sum = (byte) 0xB0;
>                     nextCharIsUpper = false;
>                 } else {
>                     sum |= (byte) 0x0B;
>                     result.write(sum);
>                     nextCharIsUpper = true;
>                 }
>                 break;
> 
>             case 'C' :
>                 if (nextCharIsUpper) {
>                     sum = (byte) 0xC0;
>                     nextCharIsUpper = false;
>                 } else {
>                     sum |= (byte) 0x0C;
>                     result.write(sum);
>                     nextCharIsUpper = true;
>                 }
>                 break;
> 
>             case 'D' :
>                 if (nextCharIsUpper) {
>                     sum = (byte) 0xD0;
>                     nextCharIsUpper = false;
>                 } else {
>                     sum |= (byte) 0x0D;
>                     result.write(sum);
>                     nextCharIsUpper = true;
>                 }
>                 break;
> 
>             case 'E' :
>                 if (nextCharIsUpper) {
>                     sum = (byte) 0xE0;
>                     nextCharIsUpper = false;
>                 } else {
>                     sum |= (byte) 0x0E;
>                     result.write(sum);
>                     nextCharIsUpper = true;
>                 }
>                 break;
> 
>             case 'F' :
>                 if (nextCharIsUpper) {
>                     sum = (byte) 0xF0;
>                     nextCharIsUpper = false;
>                 } else {
>                     sum |= (byte) 0x0F;
>                     result.write(sum);
>                     nextCharIsUpper = true;
>                 }
>                 break;
>             }
>         }
> 
>         if (!nextCharIsUpper) {
>             throw new RuntimeException("The String did not contain an equal number of hex digits");
>         }
> 
>         return result.toByteArray();
>     }
> 
>     /*
>      * Converts a byte to hex digit and writes to the supplied buffer
>      */
> 
>     /**
>      *  Description of the Method
>      *
>      * @param  b    Description of Parameter
>      * @param  buf  Description of Parameter
>      */
>     private static void byte2hex(byte b, StringBuffer buf) {
> 
>         char[] hexChars = { '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A',
>                 'B', 'C', 'D', 'E', 'F' };
>         int high = ((b & 0xf0) >> 4);
>         int low = (b & 0x0f);
> 
>         buf.append(hexChars[high]);
>         buf.append(hexChars[low]);
>     }
> 
>     /**
>      *  Description of the Method
>      *
>      * @param  b    Description of Parameter
>      * @param  buf  Description of Parameter
>      */
>     private static void byte2bin(byte b, StringBuffer buf) {
> 
>         // test every 8 bit
>         for (int i = 0; i < 8; i++) {
> 
>             //---test if bit is set
>             if ((b & COMPARE_BITS[i]) != 0) {
>                 buf.append(BIT_DIGIT[1]);
>             } else {
>                 buf.append(BIT_DIGIT[0]);
>             }
>         }
>     }
> 
>     /**
>      *  Returns a string of 8 hexadecimal digits (most significant digit first)
>      *  corresponding to the integer <i>n</i> , which is treated as unsigned.
>      *
>      * @param  n  Description of Parameter
>      * @return    Description of the Returned Value
>      */
>     private static String intToHexString(int n) {
> 
>         char[] buf = new char[8];
> 
>         for (int i = 7; i >= 0; i--) {
>             buf[i] = HEX_DIGITS[n & 0x0F];
>             n >>>= 4;
>         }
> 
>         return new String(buf);
>     }
> 
>     /**
>      *  test and demo for the Convert class
>      *
>      * @param  args  none needed
>      */
>     public static void main(String args[]) {
> 
>         System.out.println("-test and demo of the converter ");
> 
>         String str = new String("Niko");
>         byte[] ba = str.getBytes();
> 
>         System.out.println("to convert: " + str);
>         System.out.println("converted1: " + byteArrayToHexString(ba));
>         System.out.println("converted1: "
>                 + byteArrayToHexString(ba, 0, ba.length));
>         System.out.println("converted3: " + stringToHexString(str));
>         System.out.println("----Convert integer to hexString...");
> 
>         int i = -2;
> 
>         System.out.println("to convert: " + i + " -> " + intToHexString(i));
>         System.out.println("----Convert byte[] to binary String...");
> 
>         byte[] baToConvert = { (byte) 0xff, (byte) 0x00, (byte) 0x33, (byte) 0x11,
>                 (byte) 0xff, (byte) 0x5f, (byte) 0x5f, (byte) 0x4f,
>                 (byte) 0x1f, (byte) 0xff };
> 
>         System.out.println("to convert: " + toHexString(baToConvert) + " -> "
>                 + byteArrayToBinaryString(baToConvert));
> 
>         //---- modify line separator
>         setByteSeparator('-');
>         System.out.println("to convert: " + toHexString(baToConvert) + " -> "
>                 + byteArrayToBinaryString(baToConvert));
> 
>         //---- modify line separator
>         setByteSeparator('*');
>         setWithByteSeparator(true);
>         System.out.println("to convert: " + toHexString(baToConvert) + " -> "
>                 + byteArrayToBinaryString(baToConvert));
> 
>         //---- modify bit digits
>         char[] bd = { 'a', 'b' };
> 
>         try {
>             setBitDigits(bd);
>         } catch (Exception ex) {
>             ex.printStackTrace();
>         }
> 
>         System.out.println("to convert: " + toHexString(baToConvert) + " -> "
>                 + byteArrayToBinaryString(baToConvert));
> 
>         //------------------------------------------------//
>         setBitDigits('0', '1');
>         System.out.println("---- Convert.toByteArray(int) ");
> 
>         for (int iToConvert = -10; iToConvert < 10; iToConvert++) {
>             System.out.println("to convert = " + iToConvert + " = "
>                     + HexDump.toBinaryString(iToConvert));
> 
>             byte[] baConvInt = new byte[4];
> 
>             baConvInt = HexDump.toByteArray(iToConvert);
> 
>             System.out.println("convertet byteArray = "
>                     + HexDump.toBinaryString(baConvInt));
>         }
> 
>         System.out.println("---- toHexString(int) ");
> 
>         i = -1;
> 
>         System.out.println(i + " = 0x" + toHexString(i) + " = "
>                 + toBinaryString(i));
> 
>         i++;
> 
>         System.out.println(i + " = 0x" + toHexString(i) + " = "
>                 + toBinaryString(i));
> 
>         //------------------------------------------------//
>         System.out.println("---- toHexString(long) ");
> 
>         long l = 100;
> 
>         System.out.println(l + " = 0x" + toHexString(l) + " = "
>                 + toBinaryString(l));
> 
>         java.util.Random rnd = new java.util.Random();
> 
>         l = rnd.nextLong();
> 
>         System.out.println(l + " = 0x" + toHexString(l) + " = "
>                 + toBinaryString(l));
> 
>         //------------------------------------------------//
>         System.out.println("---- toHexString(short) ");
> 
>         short s = 100;
> 
>         System.out.println(s + " = 0x" + toHexString(s) + " = "
>                 + toBinaryString(s));
> 
>         rnd = new java.util.Random();
>         s = (short) rnd.nextInt();
> 
>         System.out.println(s + " = 0x" + toHexString(s) + " = "
>                 + toBinaryString(s));
> 
>         //---------------------------------------------------------------------------//
>         // convert dezimal-String to binary
>         System.out.println("---- read file in Hex-Format ");
> 
>         String strToConvert = "12345654321";
> 
>         System.out.println(strToConvert + " = "
>                 + stringToHexString(strToConvert));
>         System.out.println("Das ist die Hex-Darstellung des obigen Strings");
888c821,822
<       byte[] baConverted = new byte[strToConvert.length()];
---
>         System.out.println("ba = " + toHexString(ba));
>     }
890c824,825
<       baConverted = hexStringToByteArray(strToConvert);
---
>     public static void setDebug(boolean b) {
>         // TODO Auto-generated method stub
892,893c827
<       System.out.println("ba = " + toHexString(ba));
<    }
---
>     }
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/I18n.java xml-security-1_2_0/src/org/apache/xml/security/utils/I18n.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63c21
< import java.util.Properties;
---
> import java.text.MessageFormat;
66d23
< import java.text.MessageFormat;
144a102
>     *
157,159c115,116
<          } else {
<             return I18n.NOT_INITIALIZED_MSG;
<          }
---
>          } 
>          return I18n.NOT_INITIALIZED_MSG;
187,189c144,145
<          } else {
<             return I18n.NOT_INITIALIZED_MSG;
<          }
---
>          } 
>           return I18n.NOT_INITIALIZED_MSG;
212,214c168,169
<          } else {
<             return I18n.NOT_INITIALIZED_MSG;
<          }
---
>          } 
>          return I18n.NOT_INITIALIZED_MSG;
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/IdResolver.java xml-security-1_2_0/src/org/apache/xml/security/utils/IdResolver.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,64d20
< import org.w3c.dom.*;
< import org.apache.xerces.dom.DocumentImpl;
66,68c22,29
< import org.apache.xpath.XPathAPI;
< import org.apache.xml.security.utils.*;
< import org.apache.xml.security.Init;
---
> 
> import org.apache.xpath.CachedXPathAPI;
> import org.w3c.dom.Attr;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> 
> import java.util.WeakHashMap;
> import java.lang.ref.WeakReference;
83,84c44
<  * @author $Author: dohy $
<  * @see org.apache.xml.security.utils.resolver.implementations.ResolverFragment
---
>  * @author $Author: raul $
89,91c49,51
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(IdResolver.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log =
>         org.apache.commons.logging.LogFactory.getLog(IdResolver.class.getName());
92a53,54
>    static WeakHashMap docMap = new WeakHashMap();
>     
109d70
< 
111,113c72,77
< 
<       ((org.apache.xerces.dom.DocumentImpl) doc).putIdentifier(idValue,
<               element);
---
>       WeakHashMap elementMap = (WeakHashMap) docMap.get(doc);
>       if(elementMap == null) {
>           elementMap = new WeakHashMap();
>           docMap.put(doc, elementMap);
>       }
>       elementMap.put(idValue, new WeakReference(element));
131c95
<     * @return
---
>     * @return the element obtained by the Id, or null if it is not found.
140,141c104,105
<          cat.debug(
<             "I could find an Element using the simple getElementById method: "
---
>          log.debug(
>             "I could find an Element using the simple getElementByIdType method: "
147c111,123
<       result = IdResolver.getElementByIdInDSNamespace(doc, id);
---
>        result = IdResolver.getElementByIdUsingDOM(doc, id);
> 
>        if (result != null) {
>           log.debug(
>              "I could find an Element using the simple getElementByIdUsingDOM method: "
>             + result.getTagName());
> 
>          return result;
>       }
>        // this must be done so that Xalan can catch ALL namespaces
>        //XMLUtils.circumventBug2650(doc);
>        CachedXPathAPI cx=new CachedXPathAPIHolder().getCachedXPathAPI();//cxHolder.getCachedXPathAPI();
>       result = IdResolver.getElementByIdInDSNamespace(doc, id,cx);
150,151c126,127
<          cat.debug(
<             "I could find an Element using the advanced ds:Namespace searcher method: "
---
>          log.debug(
>             "Found an Element using an insecure Id/ID/id search method: "
160c136
<       result = IdResolver.getElementByIdInXENCNamespace(doc, id);
---
>       result = IdResolver.getElementByIdInXENCNamespace(doc, id,cx);
163c139
<          cat.debug(
---
>          log.debug(
173c149
<       result = IdResolver.getElementByIdInSOAPSignatureNamespace(doc, id);
---
>       result = IdResolver.getElementByIdInSOAPSignatureNamespace(doc, id,cx);
176c152
<          cat.debug(
---
>          log.debug(
186c162
<       result = IdResolver.getElementByIdInXKMSNamespace(doc, id);
---
>       result = IdResolver.getElementByIdInXKMSNamespace(doc, id,cx);
189c165
<          cat.debug("I could find an Element using the XKMS searcher method: "
---
>          log.debug("I could find an Element using the XKMS searcher method: "
198c174
<       result = IdResolver.getElementByIdUnsafeMatchByIdName(doc, id);
---
>       result = IdResolver.getElementByIdUnsafeMatchByIdName(doc, id,cx);
201,202c177,178
<          cat.warn(
<             "I could find an Element using the totally stupid and insecure Id/ID/id searcher method: "
---
>          log.warn(
>             "Found an Element using an insecure Id/ID/id search method: "
211a188,201
> 
>     /**
>      * Method getElementByIdUsingDOM
>      *
>      * @param doc
>      * @param id
>      * @return the element obtained by the Id, or null if it is not found.
>      */
>     private static Element getElementByIdUsingDOM(Document doc, String id) {
>         if (log.isDebugEnabled())
>         	log.debug("getElementByIdUsingDOM() Search for ID " + id);
>         return doc.getElementById(id);
>     }
> 
217c207
<     * @return
---
>     * @return the element obtained by the Id, or null if it is not found.
220,223c210,220
< 
<       cat.debug("getElementByIdType() Search for ID " + id);
< 
<       return doc.getElementById(id);
---
>    	  if (log.isDebugEnabled())
>    	  	log.debug("getElementByIdType() Search for ID " + id);
>        WeakHashMap elementMap = (WeakHashMap) docMap.get(doc);
>        if (elementMap != null) {
>            WeakReference weakReference = (WeakReference) elementMap.get(id);
>            if (weakReference != null)
>            {
>                 return (Element) weakReference.get();   
>            }
>        }
>        return null;
231c228,229
<     * @return
---
>     * @param cx
>     * @return the element obtained by the Id, or null if it is not found.
233,235c231,234
<    private static Element getElementByIdInDSNamespace(Document doc, String id) {
< 
<       cat.debug("getElementByIdInDSNamespace() Search for ID " + id);
---
>    private static Element getElementByIdInDSNamespace(Document doc, String id
>             ,CachedXPathAPI cx) {
>    	  if (log.isDebugEnabled())
>    	  	log.debug("getElementByIdInDSNamespace() Search for ID " + id);
240c239
<          Element element = (Element) XPathAPI.selectSingleNode(doc,
---
>          Element element = (Element) cx.selectSingleNode(doc,
249c248
<          cat.debug("Found ds:Elements: " + dsElements.getLength());
---
>          log.debug("Found ds:Elements: " + dsElements.getLength());
263c262
<          cat.fatal("empty", ex);
---
>          log.fatal("empty", ex);
274c273,274
<     * @return
---
>     * @param cx
>     * @return the element obtained by the Id, or null if it is not found.
277,279c277,279
<            String id) {
< 
<       cat.debug("getElementByIdInXENCNamespace() Search for ID " + id);
---
>            String id, CachedXPathAPI cx) {
>       if (log.isDebugEnabled())
>       	log.debug("getElementByIdInXENCNamespace() Search for ID " + id);
286c286
<          Element element = (Element) XPathAPI.selectSingleNode(doc,
---
>          Element element = (Element) cx.selectSingleNode(doc,
291c291
<          cat.fatal("empty", ex);
---
>          log.fatal("empty", ex);
302c302,303
<     * @return
---
>     * @param cx
>     * @return the element obtained by the Id, or null if it is not found.
305,307c306,308
<            String id) {
< 
<       cat.debug("getElementByIdInSOAPSignatureNamespace() Search for ID " + id);
---
>            String id, CachedXPathAPI cx) {
>    	  if (log.isDebugEnabled())
>    	  	log.debug("getElementByIdInSOAPSignatureNamespace() Search for ID " + id);
313c314
<          Element element = (Element) XPathAPI.selectSingleNode(doc,
---
>          Element element = (Element) cx.selectSingleNode(doc,
318c319
<          cat.fatal("empty", ex);
---
>          log.fatal("empty", ex);
329,330c330,332
<     * @return
<     * @see http://www.w3c.org/2001/XKMS/Drafts/XKMS-20020410
---
>     * @param cx
>     * @return the element obtained by the Id, or null if it is not found.
>     * @see <a href="http://www.w3c.org/2001/XKMS/Drafts/XKMS-20020410">XKMS</a>
333c335
<            String id) {
---
>            String id, CachedXPathAPI cx) {
343c345,346
<       cat.debug("getElementByIdInXKMSNamespace() Search for ID " + id);
---
>    	  if (log.isDebugEnabled())
>    	  	log.debug("getElementByIdInXKMSNamespace() Search for ID " + id);
354c357
<             Element element = (Element) XPathAPI.selectSingleNode(doc,
---
>             Element element = (Element) cx.selectSingleNode(doc,
365c368
<          cat.fatal("empty", ex);
---
>          log.fatal("empty", ex);
376c379,380
<     * @return
---
>     * @param cx
>     * @return the element obtained by the Id, or null if it is not found.
379,381c383,385
<            String id) {
< 
<       cat.debug("getElementByIdUnsafeMatchByIdName() Search for ID " + id);
---
>            String id, CachedXPathAPI cx) {
>    	  if (log.isDebugEnabled())
>    	  	log.debug("getElementByIdUnsafeMatchByIdName() Search for ID " + id);
384c388
<          Element element_Id = (Element) XPathAPI.selectSingleNode(doc,
---
>          Element element_Id = (Element) cx.selectSingleNode(doc,
391c395
<          Element element_ID = (Element) XPathAPI.selectSingleNode(doc,
---
>          Element element_ID = (Element) cx.selectSingleNode(doc,
398c402
<          Element element_id = (Element) XPathAPI.selectSingleNode(doc,
---
>          Element element_id = (Element) cx.selectSingleNode(doc,
405c409
<          cat.fatal("empty", ex);
---
>          log.fatal("empty", ex);
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/IgnoreAllErrorHandler.java xml-security-1_2_0/src/org/apache/xml/security/utils/IgnoreAllErrorHandler.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
62d19
< 
76,112c33,78
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category
<          .getInstance(IgnoreAllErrorHandler.class.getName());
< 
<    /** Field throwExceptions */
<    static final boolean warnOnExceptions = true;
< 
<    /** Field throwExceptions           */
<    static final boolean throwExceptions = false;
< 
<    //J-
<     public void warning (SAXParseException ex) throws SAXException {
<        if (IgnoreAllErrorHandler.warnOnExceptions) {
<           cat.warn("", ex);
<        }
<        if (IgnoreAllErrorHandler.throwExceptions) {
<           throw ex;
<        }
<     }
<     public void error (SAXParseException ex) throws SAXException {
<        if (IgnoreAllErrorHandler.warnOnExceptions) {
<           cat.error("", ex);
<        }
<        if (IgnoreAllErrorHandler.throwExceptions) {
<           throw ex;
<        }
<     }
<     public void fatalError (SAXParseException ex) throws SAXException {
<        if (IgnoreAllErrorHandler.warnOnExceptions) {
<           cat.warn("", ex);
<        }
<        if (IgnoreAllErrorHandler.throwExceptions) {
<           throw ex;
<        }
<     }
<     //J+
---
> 	/** {@link org.apache.commons.logging} logging facility */
> 	static org.apache.commons.logging.Log log =
> 		org.apache.commons.logging.LogFactory.getLog(
> 			IgnoreAllErrorHandler.class.getName());
> 
> 	/** Field throwExceptions */
> 	static final boolean warnOnExceptions =	System.getProperty(
> 		"org.apache.xml.security.test.warn.on.exceptions", "false").equals("true");
> 
> 	/** Field throwExceptions           */
> 	static final boolean throwExceptions = System.getProperty(
> 		"org.apache.xml.security.test.throw.exceptions", "false").equals("true");
> 
> 	
> 	/** @inheritDoc */
> 	public void warning(SAXParseException ex) throws SAXException {
> 		if (IgnoreAllErrorHandler.warnOnExceptions) {
> 			log.warn("", ex);
> 		}
> 		if (IgnoreAllErrorHandler.throwExceptions) {
> 			throw ex;
> 		}
> 	}
> 
> 
> 	/** @inheritDoc */
> 	public void error(SAXParseException ex) throws SAXException {
> 		if (IgnoreAllErrorHandler.warnOnExceptions) {
> 			log.error("", ex);
> 		}
> 		if (IgnoreAllErrorHandler.throwExceptions) {
> 			throw ex;
> 		}
> 	}
> 
> 
> 
> 	/** @inheritDoc */
> 	public void fatalError(SAXParseException ex) throws SAXException {
> 		if (IgnoreAllErrorHandler.warnOnExceptions) {
> 			log.warn("", ex);
> 		}
> 		if (IgnoreAllErrorHandler.throwExceptions) {
> 			throw ex;
> 		}
> 	}
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/JavaUtils.java xml-security-1_2_0/src/org/apache/xml/security/utils/JavaUtils.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63c21,27
< import java.io.*;
---
> import java.io.ByteArrayOutputStream;
> import java.io.File;
> import java.io.FileInputStream;
> import java.io.FileNotFoundException;
> import java.io.FileOutputStream;
> import java.io.IOException;
> import java.io.InputStream;
74,76c38,40
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(JavaUtils.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(JavaUtils.class.getName());
222a187
>     *
264c229
<             cat.debug("writeBytesToFilename got null byte[] pointed");
---
>             log.debug("writeBytesToFilename got null byte[] pointed");
274a240
>     *
303c269
<       cat.debug("<METHOD name=runGC()>");
---
>       log.debug("<METHOD name=runGC()>");
318,319c284,286
<       cat.debug("* Garbage collection took " + time + " seconds.");
<       cat.debug("* Memory before gc()... free:" + lFreeMemBefore + "= "
---
>       if (log.isDebugEnabled()) {
>       	log.debug("* Garbage collection took " + time + " seconds.");
>       	log.debug("* Memory before gc()... free:" + lFreeMemBefore + "= "
324c291
<       cat.debug("* Memory after: gc()... free:" + lFreeMemAfter + "= "
---
>       	log.debug("* Memory after: gc()... free:" + lFreeMemAfter + "= "
329c296,297
<       cat.debug("</METHOD>");
---
>       	log.debug("</METHOD>");
>       }
Only in xml-security-orig-v1/src/org/apache/xml/security/utils: NullAppender.java
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/package.html xml-security-1_2_0/src/org/apache/xml/security/utils/package.html
2c2
< general utility classes  
---
> general utility classes.
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/PRNG.java xml-security-1_2_0/src/org/apache/xml/security/utils/PRNG.java
0a1,16
> /*
>  * Copyright 1999-2004 The Apache Software Foundation.
>  *
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
>  *
>  */
8c24
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
9a26
> 
22a40,42
>   /**
>    * @param secureRandom
>    */
28a49,51
>   /**
>    *  @return
>    */
36a60,62
>   /**
>    *  @return
>    */
40a67,70
>   /**
>    * @param length
>    *  @return
>    */
46a77,79
>   /**
>    *  @param bytes
>    */
50a84,86
>   /**
>    *  @return
>    */
54a91,93
>   /**
>    *  @return
>    */
58a98,101
>   /**
>    * @param i
>    *  @return
>    */
62a106,108
>   /**
>    *  @return
>    */
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/resolver/implementations/package.html xml-security-1_2_0/src/org/apache/xml/security/utils/resolver/implementations/package.html
5c5
< implememtations of different ResourceResolver classes used to resolve ds:Reference URIs
---
> implememtations of different ResourceResolver classes used to resolve ds:Reference URIs.
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/resolver/implementations/ResolverAnonymous.java xml-security-1_2_0/src/org/apache/xml/security/utils/resolver/implementations/ResolverAnonymous.java
0a1,17
> /*
>  * Copyright 1999-2004 The Apache Software Foundation.
>  *
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
>  *
>  */
> 
3,7c20,24
< import java.net.*;
< import java.io.*;
< import org.w3c.dom.*;
< import org.apache.xml.utils.URI;
< import org.apache.xml.security.utils.resolver.ResourceResolverException;
---
> import java.io.FileInputStream;
> import java.io.FileNotFoundException;
> import java.io.IOException;
> import java.io.InputStream;
> 
10c27
< import org.apache.xml.security.utils.Base64;
---
> import org.w3c.dom.Attr;
14c31
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
15a33
> 
17,19c35,38
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(ResolverAnonymous.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(
>                         ResolverAnonymous.class.getName());
22a42,46
>    /**
>     * @param filename
>      * @throws FileNotFoundException
>      * @throws IOException
>      */
27c51,54
<    public ResolverAnonymous(InputStream is) throws IOException {
---
>    /**
>     * @param is
>      */
>    public ResolverAnonymous(InputStream is) {
30a58
>    /** @inheritDoc */
40a69
>     *
49,53c78
<    /**
<     * Method engineGetPropertyKeys
<     *
<     * @return
<     */
---
>    /** @inheritDoc */
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/resolver/implementations/ResolverDirectHTTP.java xml-security-1_2_0/src/org/apache/xml/security/utils/resolver/implementations/ResolverDirectHTTP.java
0a1
> 
2,25c3
<  * The Apache Software License, Version 1.1
<  *
<  *
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
---
>  * Copyright  1999-2004 The Apache Software Foundation.
27,30c5,15
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
---
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
32,57d16
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,67c22,28
< import java.net.*;
< import java.io.*;
< import org.w3c.dom.*;
< import org.apache.xml.utils.URI;
< import org.apache.xml.security.utils.resolver.ResourceResolverException;
---
> import java.io.ByteArrayOutputStream;
> import java.io.IOException;
> import java.io.InputStream;
> import java.net.MalformedURLException;
> import java.net.URL;
> import java.net.URLConnection;
> 
69d29
< import org.apache.xml.security.utils.resolver.ResourceResolverSpi;
70a31,34
> import org.apache.xml.security.utils.resolver.ResourceResolverException;
> import org.apache.xml.security.utils.resolver.ResourceResolverSpi;
> import org.apache.xml.utils.URI;
> import org.w3c.dom.Attr;
90c54
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
94c58
<  * @todo the proxy behaviour seems not to work; if a on-existing proxy is set, it works ?!?
---
>  * $todo$ the proxy behaviour seems not to work; if a on-existing proxy is set, it works ?!?
98,100c62,65
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(ResolverDirectHTTP.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(
>                             ResolverDirectHTTP.class.getName());
103,104c68
<    static final String properties[] = { "http.proxy.host",
<                                         "http.proxy.port",
---
>    static final String properties[] = { "http.proxy.host", "http.proxy.port",
133c97
<     * @return
---
>     *
135c99,100
<     * @todo calculate the correct URI from the attribute and the BaseURI
---
>     * @return 
>     * $todo$ calculate the correct URI from the attribute and the BaseURI
165c130,131
<             cat.debug("Use of HTTP proxy enabled: " + proxyHost + ":"
---
>             if (log.isDebugEnabled())
>             	log.debug("Use of HTTP proxy enabled: " + proxyHost + ":"
172,173c138,139
<          // make network request
<          URI uriNew = new URI(new URI(BaseURI), uri.getNodeValue());
---
>          // calculate new URI
>          URI uriNew = getNewURI(uri.getNodeValue(), BaseURI);
203a170
> 
235d201
<          String contentLength = urlConnection.getHeaderField("Content-Length");
237d202
<          BufferedInputStream bufIn = new BufferedInputStream(inputStream);
249c214
<          cat.debug("Fetched " + summarized + " bytes from URI "
---
>          log.debug("Fetched " + summarized + " bytes from URI "
280c245
<     * @return
---
>     *  @return 
284a250,251
>          log.debug("quick fail, uri == null");
> 
290a258,259
>          log.debug("quick fail for empty URIs and local ones");
> 
293a263,264
>       URI uriNew = null;
> 
295c266,269
<          URI uriNew = new URI(new URI(BaseURI), uri.getNodeValue());
---
>          uriNew = getNewURI(uri.getNodeValue(), BaseURI);
>       } catch (URI.MalformedURIException ex) {
>          log.debug("", ex);
>       }
297,298c271,273
<          if (uriNew.getScheme().equals("http")) {
<             cat.debug("I state that I can resolve " + uriNew.toString());
---
>       if ((uriNew != null) && uriNew.getScheme().equals("http")) {
>          if (log.isDebugEnabled())
>         	log.debug("I state that I can resolve " + uriNew.toString());
300,301c275,276
<             return true;
<          }
---
>          return true;
>       }
303,304c278,279
<          cat.debug("I state that I can't resolve " + uriNew.toString());
<       } catch (URI.MalformedURIException ex) {}
---
>       if (log.isDebugEnabled())
>       	log.debug("I state that I can't resolve " + uriNew.toString());
312c287
<     * @return
---
>     * @return 
315a291,299
>    }
> 
>    private URI getNewURI(String uri, String BaseURI)
>            throws URI.MalformedURIException {
> 
>       if ((BaseURI == null) || "".equals(BaseURI)) {
>          return new URI(uri);
>       }
>       return new URI(new URI(BaseURI), uri);
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/resolver/implementations/ResolverFragment.java xml-security-1_2_0/src/org/apache/xml/security/utils/resolver/implementations/ResolverFragment.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,69d20
< import java.net.*;
< import java.io.*;
< import java.util.*;
< import org.w3c.dom.*;
< import org.apache.xml.utils.URI;
< import org.apache.xpath.CachedXPathAPI;
< import org.apache.xml.security.c14n.*;
71,72c22,28
< import org.apache.xml.security.utils.*;
< import org.apache.xml.security.utils.resolver.*;
---
> import org.apache.xml.security.utils.CachedXPathAPIHolder;
> import org.apache.xml.security.utils.IdResolver;
> import org.apache.xml.security.utils.resolver.ResourceResolverSpi;
> import org.apache.xml.utils.URI;
> import org.w3c.dom.Attr;
> import org.w3c.dom.Document;
> import org.w3c.dom.Node;
78c34
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
85,87c41,44
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(ResolverFragment.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(
>                             ResolverFragment.class.getName());
94c51
<     *
---
>     * @inheritDoc
97,98c54
<     * @return
<     * @throws ResourceResolverException
---
>     *
101c57
<            throws ResourceResolverException {
---
>    {
104,108c60
<       NodeList resultNodes = null;
<       Document doc = uri.getOwnerDocument();
< 
<       // this must be done so that Xalan can catch ALL namespaces
<       XMLUtils.circumventBug2650(doc);
---
>       Document doc = uri.getOwnerElement().getOwnerDocument();
110d61
<       CachedXPathAPI cXPathAPI = new CachedXPathAPI();
111a63
>       Node selectedElem = null;
119,127c71,72
<          // cat.debug("ResolverFragment with empty URI (means complete document)");
<          try {
<             resultNodes =
<                cXPathAPI.selectNodeList(doc,
<                                         Canonicalizer.XPATH_C14N_OMIT_COMMENTS);
<          } catch (javax.xml.transform.TransformerException ex) {
<             throw new ResourceResolverException("generic.EmptyMessage", ex,
<                                                 uri, BaseURI);
<          }
---
>          log.debug("ResolverFragment with empty URI (means complete document)");
> 	 selectedElem = doc;
141,156c86,88
<          Element selectedElem = IdResolver.getElementById(doc, id);
< 
<          // cat.debug("Try to catch an Element with ID " + id + " and Element was " + selectedElem);
<          if (selectedElem == null) {
<             resultNodes = new HelperNodeList();
<          } else {
<             try {
<                resultNodes =
<                   cXPathAPI
<                      .selectNodeList(selectedElem, Canonicalizer
<                         .XPATH_C14N_OMIT_COMMENTS_SINGLE_NODE);
<             } catch (javax.xml.transform.TransformerException ex) {
<                throw new ResourceResolverException("generic.EmptyMessage", ex,
<                                                    uri, BaseURI);
<             }
<          }
---
>          selectedElem = IdResolver.getElementById(doc, id);
>          if (log.isDebugEnabled())
>          	log.debug("Try to catch an Element with ID " + id + " and Element was " + selectedElem);
159,160c91,93
<       Set resultSet = XMLUtils.convertNodelistToSet(resultNodes);
<       XMLSignatureInput result = new XMLSignatureInput(resultSet, cXPathAPI);
---
>       //Set resultSet = dereferenceSameDocumentURI(selectedElem);
>       XMLSignatureInput result = new XMLSignatureInput(selectedElem,new CachedXPathAPIHolder());
>       result.setExcludeComments(true);
162c95
<       // cat.debug("We return a nodeset with " + resultNodes.getLength() + " nodes");
---
>       //log.debug("We return a nodeset with " + resultSet.size() + " nodes");
178c111
<     *
---
>     * @inheritDoc
181c114
<     * @return
---
>     *
185a119
>          log.debug("Quick fail for null uri");
193a128,129
>          if (log.isDebugEnabled())
>          	log.debug("State I can resolve reference: \"" + uriNodeValue + "\"");
196c132,133
< 
---
>       if (log.isDebugEnabled())
>       	log.debug("Do not seem to be able to resolve reference: \"" + uriNodeValue + "\"");
200,270d136
<    /**
<     * Method isSameDocumentReference
<     *
<     * @param uri
<     * @param BaseURI
<     * @return
<     * @throws URI.MalformedURIException
<     */
<    private static boolean isSameDocumentReference(Attr uri, String BaseURI)
<            throws URI.MalformedURIException {
< 
<       String uriNodeValue = uri.getNodeValue();
< 
<       if (uriNodeValue.equals("") || uriNodeValue.startsWith("#")) {
<          return true;
<       } else {
<          return false;
<       }
<    }
< 
<    /**
<     * Method selectIdentifiedPortions
<     *
<     * @param uri
<     * @param BaseURI
<     * @param input
<     * @return
<     * @throws ResourceResolverException
<     * private static XMLSignatureInput selectIdentifiedPortions(
<     *       Attr uri, String BaseURI, XMLSignatureInput input)
<     *          throws ResourceResolverException {
<     *
<     *  try {
<     *     cat.debug("Got " + input.getBytes().length
<     *               + " bytes from source and  URI oif " + input.getSourceURI());
<     *  } catch (Exception ex) {
<     *     throw new ResourceResolverException("generic.EmptyMessage", ex, uri,
<     *                                         BaseURI);
<     *  }
<     *
<     *  try {
<     *     URI fragmentURI = new URI(new URI(BaseURI), uri.getNodeValue());
<     *     String fragment = fragmentURI.getFragment();
<     *     javax.xml.parsers.DocumentBuilderFactory dbf =
<     *        javax.xml.parsers.DocumentBuilderFactory.newInstance();
<     *
<     *     dbf.setNamespaceAware(true);
<     *     dbf.setValidating(true);
<     *
<     *     javax.xml.parsers.DocumentBuilder db = dbf.newDocumentBuilder();
<     *     Document doc =
<     *        db.parse(new java.io.ByteArrayInputStream(input.getBytes()));
<     *
<     *     cat.debug("Owner Document " + doc.getDocumentElement().getTagName());
<     *     cat.debug("try to select fragment " + fragment);
<     *
<     *     // Element selectedElem = doc.getElementById(fragment);
<     *     Element selectedElem = IdResolver.getElementById(doc, fragment);
<     *
<     *     if (selectedElem != null) {
<     *        cat.debug("Selection hat geklappt!!!: "
<     *                  + selectedElem.getTagName());
<     *     }
<     *
<     *     return input;
<     *  } catch (Exception ex) {
<     *     throw new ResourceResolverException("generic.EmptyMessage", ex, uri,
<     *                                         BaseURI);
<     *  }
<     * }
<     */
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/resolver/implementations/ResolverLocalFilesystem.java xml-security-1_2_0/src/org/apache/xml/security/utils/resolver/implementations/ResolverLocalFilesystem.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,67c21,22
< import java.io.*;
< import java.net.URL;
< import org.w3c.dom.*;
< import org.apache.xml.utils.URI;
< import org.apache.xml.security.utils.resolver.ResourceResolverException;
---
> import java.io.FileInputStream;
> 
68a24
> import org.apache.xml.security.utils.resolver.ResourceResolverException;
69a26,27
> import org.apache.xml.utils.URI;
> import org.w3c.dom.Attr;
75c33
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
79,82c37,40
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category
<          .getInstance(ResolverLocalFilesystem.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(
>                     ResolverLocalFilesystem.class.getName());
96,97c54,55
<       try {
<          URI uriNew = new URI(new URI(BaseURI), uri.getNodeValue());
---
>      try {
>         URI uriNew = new URI(new URI(BaseURI), uri.getNodeValue());
99,100c57,58
<          // if the URI contains a fragment, ignore it
<          URI uriNewNoFrag = new URI(uriNew);
---
>         // if the URI contains a fragment, ignore it
>         URI uriNewNoFrag = new URI(uriNew);
102c60
<          uriNewNoFrag.setFragment(null);
---
>         uriNewNoFrag.setFragment(null);
104,115c62,73
<          String fileName =
<             ResolverLocalFilesystem
<                .translateUriToFilename(uriNewNoFrag.toString());
<          FileInputStream inputStream = new FileInputStream(fileName);
<          XMLSignatureInput result = new XMLSignatureInput(inputStream);
< 
<          result.setSourceURI(uriNew.toString());
< 
<          return result;
<       } catch (Exception e) {
<          throw new ResourceResolverException("generic.EmptyMessage", e, uri,
<                                              BaseURI);
---
>         String fileName =
>            ResolverLocalFilesystem
>               .translateUriToFilename(uriNewNoFrag.toString());
>         FileInputStream inputStream = new FileInputStream(fileName);
>         XMLSignatureInput result = new XMLSignatureInput(inputStream);
> 
>         result.setSourceURI(uriNew.toString());
> 
>         return result;
>      } catch (Exception e) {
>         throw new ResourceResolverException("generic.EmptyMessage", e, uri,
>                                             BaseURI);
129c87,105
<       subStr.replace('/', java.io.File.separatorChar);
---
>       if (subStr.indexOf("%20") > -1)
>       {
>         int offset = 0;
>         int index = 0;
>         StringBuffer temp = new StringBuffer(subStr.length());
>         do
>         {
>           index = subStr.indexOf("%20",offset);
>           if (index == -1) temp.append(subStr.substring(offset));
>           else
>           {
>             temp.append(subStr.substring(offset,index));
>             temp.append(' ');
>             offset = index+3;
>           }
>         }
>         while(index != -1);
>         subStr = temp.toString();
>       }
134,136d109
<       } else {
<       	 // we're running some UNIX, so we have to prepend a slash
<          return "/" + subStr;
137a111,112
>       // we're running some UNIX, so we have to prepend a slash
>       return "/" + subStr;
161,162c136,137
< 
<          cat.debug("I was asked whether I can resolve " + uriNew.toString());
---
>          if (log.isDebugEnabled())
>          	log.debug("I was asked whether I can resolve " + uriNew.toString());
165c140,141
<             cat.debug("I state that I can resolve " + uriNew.toString());
---
>             if (log.isDebugEnabled())
>             	log.debug("I state that I can resolve " + uriNew.toString());
171c147
<       cat.debug("But I can't");
---
>       log.debug("But I can't");
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/resolver/implementations/ResolverXPointer.java xml-security-1_2_0/src/org/apache/xml/security/utils/resolver/implementations/ResolverXPointer.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,69d20
< import java.net.*;
< import java.io.*;
< import java.util.*;
< import org.w3c.dom.*;
< import org.apache.xml.utils.URI;
< import org.apache.xpath.CachedXPathAPI;
< import org.apache.xml.security.c14n.*;
71,72c22,29
< import org.apache.xml.security.utils.*;
< import org.apache.xml.security.utils.resolver.*;
---
> import org.apache.xml.security.utils.CachedXPathAPIHolder;
> import org.apache.xml.security.utils.IdResolver;
> import org.apache.xml.security.utils.resolver.ResourceResolverException;
> import org.apache.xml.security.utils.resolver.ResourceResolverSpi;
> import org.apache.xml.utils.URI;
> import org.w3c.dom.Attr;
> import org.w3c.dom.Document;
> import org.w3c.dom.Node;
88c45
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
92,94c49,52
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(ResolverXPointer.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(
>                             ResolverXPointer.class.getName());
97,105c55
<     * Method engineResolve
<     *
<     * Wird das gleiche Dokument referenziert?
<     * Wird ein anderes Dokument referenziert?
<     *
<     * @param uri
<     * @param BaseURI
<     * @return
<     * @throws ResourceResolverException
---
>     * @inheritDoc
110,112c60,61
<       String uriNodeValue = uri.getNodeValue();
<       NodeList resultNodes = null;
<       Document doc = uri.getOwnerDocument();
---
>       Node resultNode = null;
>       Document doc = uri.getOwnerElement().getOwnerDocument();
115c64
<       XMLUtils.circumventBug2650(doc);
---
>       //XMLUtils.circumventBug2650(doc);
117c66
<       CachedXPathAPI cXPathAPI = new CachedXPathAPI();
---
>       //CachedXPathAPI cXPathAPI = new CachedXPathAPI();
119,126c68,74
<       try {
<          if (isXPointerSlash(uri, BaseURI)) {
<             resultNodes =
<                cXPathAPI.selectNodeList(doc,
<                                         Canonicalizer.XPATH_C14N_WITH_COMMENTS);
<          } else if (isXPointerId(uri, BaseURI)) {
<             String id = getXPointerId(uri, BaseURI);
<             Element selectedElem = IdResolver.getElementById(doc, id);
---
>       
>          if (isXPointerSlash(uri)) {
>             resultNode = doc;
>                
>          } else if (isXPointerId(uri)) {
>             String id = getXPointerId(uri);
>             resultNode =IdResolver.getElementById(doc, id);
128c76
<             // cat.debug("Use #xpointer(id('" + id + "')) on element " + selectedElem);
---
>             // log.debug("Use #xpointer(id('" + id + "')) on element " + selectedElem);
130c78
<             if (selectedElem == null) {
---
>             if (resultNode == null) {
136c84
< 
---
>             /*
140c88
<                      .XPATH_C14N_WITH_COMMENTS_SINGLE_NODE);
---
>                      .XPATH_C14N_WITH_COMMENTS_SINGLE_NODE);*/
142,145c90
<       } catch (javax.xml.transform.TransformerException ex) {
<          throw new ResourceResolverException("generic.EmptyMessage", ex, uri,
<                                              BaseURI);
<       }
---
>       
147,148c92,93
<       Set resultSet = XMLUtils.convertNodelistToSet(resultNodes);
<       XMLSignatureInput result = new XMLSignatureInput(resultSet, cXPathAPI);
---
>       //Set resultSet = XMLUtils.convertNodelistToSet(resultNode); 
>       XMLSignatureInput result = new XMLSignatureInput(resultNode,new CachedXPathAPIHolder());
164,168c109
<     * Method engineCanResolve
<     *
<     * @param uri
<     * @param BaseURI
<     * @return
---
>     * @inheritDoc
176,178c117
<       String uriNodeValue = uri.getNodeValue();
< 
<       if (isXPointerSlash(uri, BaseURI) || isXPointerId(uri, BaseURI)) {
---
>       if (isXPointerSlash(uri) || isXPointerId(uri)) {
186,201d124
<     * Method isSameDocumentReference
<     *
<     * @param uri
<     * @param BaseURI
<     * @return
<     */
<    private static boolean isSameDocumentReference(Attr uri, String BaseURI) {
< 
<       if (uri.getNodeValue().startsWith("#")) {
<          return true;
<       } else {
<          return false;
<       }
<    }
< 
<    /**
205,206c128
<     * @param BaseURI
<     * @return
---
>     * @return true if begins with xpointer
208c130
<    private static boolean isXPointerSlash(Attr uri, String BaseURI) {
---
>    private static boolean isXPointerSlash(Attr uri) {
221,222c143,144
<     * @param BaseURI
<     * @return
---
>     * @return it it has an xpointer id
>     *
224c146
<    private static boolean isXPointerId(Attr uri, String BaseURI) {
---
>    private static boolean isXPointerId(Attr uri) {
234c156
<          // cat.debug("idPlusDelim=" + idPlusDelim);
---
>          // log.debug("idPlusDelim=" + idPlusDelim);
240c162,163
<             cat.debug("Id="
---
>             if (log.isDebugEnabled())
>             	log.debug("Id="
254d176
<     * @param BaseURI
257c179
<    private static String getXPointerId(Attr uri, String BaseURI) {
---
>    private static String getXPointerId(Attr uri) {
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/resolver/package.html xml-security-1_2_0/src/org/apache/xml/security/utils/resolver/package.html
5c5
< the ResourceResolver classes used to resolve ds:Reference URIs
---
> the ResourceResolver classes used to resolve ds:Reference URIs.
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/resolver/ResourceResolverException.java xml-security-1_2_0/src/org/apache/xml/security/utils/resolver/ResourceResolverException.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights 
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer. 
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:  
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written 
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European 
<  * Commission in the <WebSig> project in the ISIS Programme. 
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64,65d21
< import org.apache.xml.utils.URI;
< import org.w3c.dom.Attr;
66a23
> import org.w3c.dom.Attr;
73c30
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
80c37
<     * @param msgID
---
>     * @param _msgID
84c41
<    public ResourceResolverException(String msgID, Attr uri, String BaseURI) {
---
>    public ResourceResolverException(String _msgID, Attr uri, String BaseURI) {
86c43
<       super(msgID);
---
>       super(_msgID);
95c52
<     * @param msgID
---
>     * @param _msgID
100c57
<    public ResourceResolverException(String msgID, Object exArgs[], Attr uri,
---
>    public ResourceResolverException(String _msgID, Object exArgs[], Attr uri,
103c60
<       super(msgID, exArgs);
---
>       super(_msgID, exArgs);
112,113c69,70
<     * @param msgID
<     * @param originalException
---
>     * @param _msgID
>     * @param _originalException
117c74
<    public ResourceResolverException(String msgID, Exception originalException,
---
>    public ResourceResolverException(String _msgID, Exception _originalException,
120c77
<       super(msgID, originalException);
---
>       super(_msgID, _originalException);
129c86
<     * @param msgID
---
>     * @param _msgID
131c88
<     * @param originalException
---
>     * @param _originalException
135,136c92,93
<    public ResourceResolverException(String msgID, Object exArgs[],
<                                     Exception originalException, Attr uri,
---
>    public ResourceResolverException(String _msgID, Object exArgs[],
>                                     Exception _originalException, Attr uri,
139c96
<       super(msgID, exArgs, originalException);
---
>       super(_msgID, exArgs, _originalException);
146a104,107
>    /**
>     * 
>     * @param uri
>     */
149a111,115
>    
>    /**
>     * 
>     * @return
>     */
154a121,125
>    
>    /**
>     * 
>     * @param BaseURI
>     */
157a129,133
>    
>    /**
>     * 
>     * @return
>     */
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/resolver/ResourceResolver.java xml-security-1_2_0/src/org/apache/xml/security/utils/resolver/ResourceResolver.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64,66c22,24
< import java.util.*;
< import org.w3c.dom.*;
< import org.apache.xml.utils.URI;
---
> import java.util.Map;
> import java.util.Vector;
> 
67a26
> import org.w3c.dom.Attr;
75c34
<  * for {@link jaxax.xml.transform.stream.StreamSource#setSystemId(String)}.
---
>  * for {@link javax.xml.transform.stream.StreamSource#getSystemId}.
78,82c37,41
<  * <LI> Verschiedene Implementierungen knnen sich als Resolver registrieren.
<  * <LI> Standardmig werden erste Implementierungen auf dem XML config file registrirt.
<  * <LI> Der Benutzer kann bei Bedarf Implementierungen voranstellen oder anfgen.
<  * <LI> Implementierungen knnen mittels Features customized werden 
<  *      (z.B. um Proxy-Passworter bergeben zu knnen).
---
>  * <LI> Verschiedene Implementierungen k??nnen sich als Resolver registrieren.
>  * <LI> Standardm????ig werden erste Implementierungen auf dem XML config file registrirt.
>  * <LI> Der Benutzer kann bei Bedarf Implementierungen voranstellen oder anf??gen.
>  * <LI> Implementierungen k??nnen mittels Features customized werden ??
>  *      (z.B. um Proxy-Passworter ??bergeben zu k??nnen).
84,85c43,44
<  *      bergeben und muss antworten, ob sie auflsen kann.
<  * <LI> Die erste Implementierung, die die Aufgabe erfllt, fhrt die Auflsung durch.
---
>  *      ??bergeben und muss antworten, ob sie aufl??sen kann.
>  * <LI> Die erste Implementierung, die die Aufgabe erf??llt, f??hrt die Aufl??sung durch.
88c47
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
92,94c51,53
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(ResourceResolver.class.getName());
---
>    /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(ResourceResolver.class.getName());
137a97
>     *
159c119,120
<          cat.debug("check resolvability by class " + currentClass);
---
>          if (log.isDebugEnabled())
>          	log.debug("check resolvability by class " + currentClass);
180a142
>     *
186,188c148,151
< 
<       cat.debug("I was asked to create a ResourceResolver and got " + individualResolvers.size());
<       cat.debug(" extra resolvers to my existing " + ResourceResolver._resolverVector.size() + " system-wide resolvers");
---
>       if (log.isDebugEnabled()) {
>       	log.debug("I was asked to create a ResourceResolver and got " + individualResolvers.size());
>       	log.debug(" extra resolvers to my existing " + ResourceResolver._resolverVector.size() + " system-wide resolvers");
>       }
198,199c161,162
< 
<                cat.debug("check resolvability by class " + currentClass);
---
>                if (log.isDebugEnabled())
>                	log.debug("check resolvability by class " + currentClass);
223,224c186,187
< 
<          cat.debug("check resolvability by class " + currentClass);
---
>          if (log.isDebugEnabled())
>          	log.debug("check resolvability by class " + currentClass);
273a237
>     *
289a254
>     *
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/resolver/ResourceResolverSpi.java xml-security-1_2_0/src/org/apache/xml/security/utils/resolver/ResourceResolverSpi.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,67c21,22
< import java.util.*;
< import java.net.URL;
< import java.net.MalformedURLException;
< import org.w3c.dom.*;
< import org.apache.xml.utils.URI;
---
> import java.util.Map;
> 
68a24,25
> import org.apache.xml.utils.URI;
> import org.w3c.dom.Attr;
74c31
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
78,179c35,71
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category
<          .getInstance(ResourceResolverSpi.class.getName());
< 
<    /** Field _properties */
<    protected java.util.Map _properties = new java.util.HashMap(10);
< 
<    /**
<     * This is the workhorse method used to resolve resources.
<     *
<     * @param uri
<     * @param BaseURI
<     * @return
<     * @throws ResourceResolverException
<     */
<    public abstract XMLSignatureInput engineResolve(Attr uri, String BaseURI)
<       throws ResourceResolverException;
< 
<    /**
<     * Method engineSetProperty
<     *
<     * @param key
<     * @param value
<     */
<    public void engineSetProperty(String key, String value) {
< 
<       java.util.Iterator i = this._properties.keySet().iterator();
< 
<       while (i.hasNext()) {
<          String c = (String) i.next();
< 
<          if (c.equals(key)) {
<             key = c;
< 
<             break;
<          }
<       }
< 
<       this._properties.put(key, value);
<    }
< 
<    /**
<     * Method engineGetProperty
<     *
<     * @param key
<     * @return
<     */
<    public String engineGetProperty(String key) {
< 
<       java.util.Iterator i = this._properties.keySet().iterator();
< 
<       while (i.hasNext()) {
<          String c = (String) i.next();
< 
<          if (c.equals(key)) {
<             key = c;
< 
<             break;
<          }
<       }
< 
<       return (String) this._properties.get(key);
<    }
< 
<    public void engineAddProperies(Map properties) {
<       this._properties.putAll(properties);
<    }
< 
<    /**
<     * This method helps the {@link ResourceResolver} to decide whether a
<     * {@link ResourceResolverSpi} is able to perform the requested action.
<     *
<     * @param uri
<     * @param BaseURI
<     * @return
<     */
<    public abstract boolean engineCanResolve(Attr uri, String BaseURI);
< 
<    /**
<     * Method engineGetPropertyKeys
<     *
<     * @return
<     */
<    public String[] engineGetPropertyKeys() {
<       return new String[0];
<    }
< 
<    /**
<     * Method understandsProperty
<     *
<     * @param propertyToTest
<     * @return
<     */
<    public boolean understandsProperty(String propertyToTest) {
< 
<       String[] understood = this.engineGetPropertyKeys();
< 
<       if (understood != null) {
<          for (int i = 0; i < understood.length; i++) {
<             if (understood[i].equals(propertyToTest)) {
<                return true;
---
>     /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log =
>             org.apache.commons.logging.LogFactory.getLog(
>                     ResourceResolverSpi.class.getName());
> 
>     /** Field _properties */
>     protected java.util.Map _properties = new java.util.HashMap(10);
> 
>     /**
>      * This is the workhorse method used to resolve resources.
>      *
>      * @param uri
>      * @param BaseURI
>      * @return
>      *
>      * @throws ResourceResolverException
>      */
>     public abstract XMLSignatureInput engineResolve(Attr uri, String BaseURI)
>             throws ResourceResolverException;
> 
>     /**
>      * Method engineSetProperty
>      *
>      * @param key
>      * @param value
>      */
>     public void engineSetProperty(String key, String value) {
> 
>         java.util.Iterator i = this._properties.keySet().iterator();
> 
>         while (i.hasNext()) {
>             String c = (String) i.next();
> 
>             if (c.equals(key)) {
>                 key = c;
> 
>                 break;
181,182c73
<          }
<       }
---
>         }
184,185c75,76
<       return false;
<    }
---
>         this._properties.put(key, value);
>     }
187,215c78,84
<    /**
<     * Expands a system id and returns the system id as a URL, if
<     * it can be expanded. A return value of null means that the
<     * identifier is already expanded. An exception thrown
<     * indicates a failure to expand the id.
<     *
<     * @param systemId The systemId to be expanded.
<     * @param currentSystemId
<     *
<     * @return Returns the URL object representing the expanded system
<     *         identifier. A null value indicates that the given
<     *         system identifier is already expanded.
<     *
<     * @throws Exception
<     * @see org.apache.xerces.validators.schema.TraverseSchema
<     */
<    public static String expandSystemId(String systemId, String currentSystemId)
<            throws Exception {
< 
<       String id = systemId;
< 
<       // check for bad parameters id
<       if ((id == null) || (id.length() == 0)) {
<          return systemId;
<       }
< 
<       // if id already expanded, return
<       try {
<          URI url = new URI(id);
---
>     /**
>      * Method engineGetProperty
>      *
>      * @param key
>      * @return
>      */
>     public String engineGetProperty(String key) {
217,220c86,99
<          if (url != null) {
<             return systemId;
<          }
<       } catch (Exception e) {
---
>         java.util.Iterator i = this._properties.keySet().iterator();
> 
>         while (i.hasNext()) {
>             String c = (String) i.next();
> 
>             if (c.equals(key)) {
>                 key = c;
> 
>                 break;
>             }
>         }
> 
>         return (String) this._properties.get(key);
>     }
222,223c101,172
<          // continue on...
<       }
---
>     /**
>      * 
>      * @param properties
>      */
>     public void engineAddProperies(Map properties) {
>         this._properties.putAll(properties);
>     }
> 
>     /**
>      * This method helps the {@link ResourceResolver} to decide whether a
>      * {@link ResourceResolverSpi} is able to perform the requested action.
>      *
>      * @param uri
>      * @param BaseURI
>      * @return
>      */
>     public abstract boolean engineCanResolve(Attr uri, String BaseURI);
> 
>     /**
>      * Method engineGetPropertyKeys
>      *
>      * @return
>      */
>     public String[] engineGetPropertyKeys() {
>         return new String[0];
>     }
> 
>     /**
>      * Method understandsProperty
>      *
>      * @param propertyToTest
>      * @return
>      */
>     public boolean understandsProperty(String propertyToTest) {
> 
>         String[] understood = this.engineGetPropertyKeys();
> 
>         if (understood != null) {
>             for (int i = 0; i < understood.length; i++) {
>                 if (understood[i].equals(propertyToTest)) {
>                     return true;
>                 }
>             }
>         }
> 
>         return false;
>     }
> 
>     /**
>      * Expands a system id and returns the system id as a URL, if
>      * it can be expanded. A return value of null means that the
>      * identifier is already expanded. An exception thrown
>      * indicates a failure to expand the id.
>      *
>      * @param systemId The systemId to be expanded.
>      * @param currentSystemId
>      *
>      * @return Returns the URL object representing the expanded system
>      *         identifier. A null value indicates that the given
>      *         system identifier is already expanded.
>      *
>      * @throws Exception
>      */
>     public static String expandSystemId(String systemId, String currentSystemId)
>             throws Exception {
> 
>         String id = systemId;
> 
>         // check for bad parameters id
>         if ((id == null) || (id.length() == 0)) {
>             return systemId;
>         }
225,226c174,176
<       // normalize id
<       id = ResourceResolverSpi.fixURI(id);
---
>         // if id already expanded, return
>         try {
>             URI url = new URI(id);
228,239c178,179
<       // normalize base
<       URI base = null;
<       URI url = null;
< 
<       try {
<          if (currentSystemId == null) {
<             String dir;
< 
<             try {
<                dir = ResourceResolverSpi.fixURI(System.getProperty("user.dir"));
<             } catch (SecurityException se) {
<                dir = "";
---
>             if (url != null) {
>                 return systemId;
240a181,195
>         } catch (Exception e) {
> 
>             // continue on...
>         }
> 
>         // normalize id
>         id = ResourceResolverSpi.fixURI(id);
> 
>         // normalize base
>         URI base = null;
>         URI url = null;
> 
>         try {
>             if (currentSystemId == null) {
>                 String dir;
242,243c197,215
<             if (!dir.endsWith("/")) {
<                dir = dir + "/";
---
>                 try {
>                     dir = ResourceResolverSpi.fixURI(System.getProperty("user.dir"));
>                 } catch (SecurityException se) {
>                     dir = "";
>                 }
> 
>                 if (!dir.endsWith("/")) {
>                     dir = dir + "/";
>                 }
> 
>                 final String protocol = "file";
>                 final String host = "";
> 
>                 base = new URI(protocol, host, dir, null, null);
>             } else {
> 
>                 // should we fix currentSystemId?
>                 currentSystemId = ResourceResolverSpi.fixURI(currentSystemId);
>                 base = new URI(currentSystemId);
246,247c218,223
<             final String protocol = "file";
<             final String host = "";
---
>             // expand id
>             url = new URI(base, id);
>         } catch (Exception e) {
> 
>             // let it go through
>         }
249,250c225,239
<             base = new URI(protocol, host, dir, null, null);
<          } else {
---
>         if (url == null) {
>             return systemId;
>         }
> 
>         return url.toString();
>     }
> 
>     /**
>      * Fixes a platform dependent filename to standard URI form.
>      *
>      * @param str The string to fix.
>      *
>      * @return Returns the fixed URI string.
>      */
>     public static String fixURI(String str) {
252,341c241,242
<             // should we fix currentSystemId?
<             currentSystemId = ResourceResolverSpi.fixURI(currentSystemId);
<             base = new URI(currentSystemId);
<          }
< 
<          // expand id
<          url = new URI(base, id);
<       } catch (Exception e) {
< 
<          // let it go through
<       }
< 
<       if (url == null) {
<          return systemId;
<       }
< 
<       return url.toString();
<    }
< 
<    /**
<     * Method makeFilesystemToURI
<     *
<     * @param str
<     * @return
<     */
<    public static String makeFilesystemToURI(String str) {
< 
<       final String filePrefix = "file:/";
< 
<       return "";
<    }
< 
<    /**
<     * Method isDosFilename
<     *
<     * @param str
<     * @return
<     */
<    private static boolean isDosFilename(String str) {
< 
<       if (str.length() >= 4) {
< 
<          // str =~ /^\W:\/([^/])/ # to speak perl ;-))
<          //J-
<          char ch0 = Character.toUpperCase(str.charAt(0));
<          boolean isDriveLetter     = (('A' <= ch0) && (ch0 <= 'Z'));
<          boolean isColon           = str.charAt(1) == ':';
<          boolean isSlashAfterColon = str.charAt(2) == '/';
<          boolean isOnlyOneSlash    = str.charAt(3) != '/';
<          boolean isDosFilename = (isDriveLetter && isColon &&
<                                   isSlashAfterColon && isOnlyOneSlash);
<          //J+
<          return isDosFilename;
<       }
< 
<       return false;
<    }
< 
<    /**
<     * Fixes a platform dependent filename to standard URI form.
<     *
<     * @param str The string to fix.
<     *
<     * @return Returns the fixed URI string.
<     * @see org.apache.xerces.validators.schema.TraverseSchema
<     */
<    public static String fixURI(String str) {
< 
<       // handle platform dependent strings
<       str = str.replace(java.io.File.separatorChar, '/');
< 
<       if (str.length() >= 4) {
< 
<          // str =~ /^\W:\/([^/])/ # to speak perl ;-))
<          char ch0 = Character.toUpperCase(str.charAt(0));
<          char ch1 = str.charAt(1);
<          char ch2 = str.charAt(2);
<          char ch3 = str.charAt(3);
<          boolean isDosFilename = ((('A' <= ch0) && (ch0 <= 'Z'))
<                                   && (ch1 == ':') && (ch2 == '/')
<                                   && (ch3 != '/'));
< 
<          if (isDosFilename) {
<             cat.debug("Found DOS filename: " + str);
<          }
<       }
< 
<       // Windows fix
<       if (str.length() >= 2) {
<          char ch1 = str.charAt(1);
---
>         // handle platform dependent strings
>         str = str.replace(java.io.File.separatorChar, '/');
343c244,246
<          if (ch1 == ':') {
---
>         if (str.length() >= 4) {
> 
>             // str =~ /^\W:\/([^/])/ # to speak perl ;-))
344a248,260
>             char ch1 = str.charAt(1);
>             char ch2 = str.charAt(2);
>             char ch3 = str.charAt(3);
>             boolean isDosFilename = ((('A' <= ch0) && (ch0 <= 'Z'))
>                     && (ch1 == ':') && (ch2 == '/')
>                     && (ch3 != '/'));
> 
>             if (isDosFilename) {
>                 if (log.isDebugEnabled()) {
>                     log.debug("Found DOS filename: " + str);
>                 }
>             }
>         }
346,347c262,271
<             if (('A' <= ch0) && (ch0 <= 'Z')) {
<                str = "/" + str;
---
>         // Windows fix
>         if (str.length() >= 2) {
>             char ch1 = str.charAt(1);
> 
>             if (ch1 == ':') {
>                 char ch0 = Character.toUpperCase(str.charAt(0));
> 
>                 if (('A' <= ch0) && (ch0 <= 'Z')) {
>                     str = "/" + str;
>                 }
349,350c273
<          }
<       }
---
>         }
352,354c275,282
<       // done
<       return str;
<    }
---
>         // done
>         return str;
>     }
> 
>     public static String makeFilesystemToURI(String string) {
>         // TODO Auto-generated method stub
>         return null;
>     }
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/RFC2253Parser.java xml-security-1_2_0/src/org/apache/xml/security/utils/RFC2253Parser.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,64c21,22
< import java.io.*;
< import java.util.*;
---
> import java.io.IOException;
> import java.io.StringReader;
69c27
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
73,76c31,34
<    /** Field cat */
< 
<    /*   static org.apache.log4j.Category cat =
<          org.apache.log4j.Category.getInstance(RFC2253Parser.class.getName());
---
>     
>    /** {@link org.apache.commons.logging} logging facility */
>    /* static org.apache.commons.logging.Log log = 
>         org.apache.commons.logging.LogFactory.getLog(RFC2253Parser.class.getName());
77a36
>     
84a44
>     *
90c50
<       // transfrom from RFC1779 to RFC2253
---
>       // Transform from RFC1779 to RFC2253
100c60
<     * @return
---
>     * @return 
106c66
<       // transfrom from RFC1779 to RFC2253
---
>       // Transform from RFC1779 to RFC2253
116c76
<     * @return
---
>     * @return 
156c116
<     * @return
---
>     * @return 
186c146
<     * @return
---
>     * @return 
195,197c155,157
<       } else {
<          String attrType = normalizeAT(str.substring(0, i));
<          String attrValue = normalizeV(str.substring(i + 1));
---
>       } 
>       String attrType = normalizeAT(str.substring(0, i));
>       String attrValue = normalizeV(str.substring(i + 1));
199,200c159,160
<          return attrType + "=" + attrValue;
<       }
---
>       return attrType + "=" + attrValue;
>       
207c167
<     * @return
---
>     * @return 
224c184
<     * @return
---
>     * @return 
270c230
<     * @return
---
>     * @return 
287c247
<     * @return
---
>     * @return 
304c264
<     * @return
---
>     * @return 
347c307
<     * @return
---
>     * @return 
372c332
<     * @return
---
>     * @return 
410,411c370
<     * @return
<     * @throws IOException
---
>     * @return 
413c372
<    static String changeWStoRFC(String string) throws IOException {
---
>    static String changeWStoRFC(String string) {
434c393
<     * @return
---
>     * @return 
445c404
<     * @return
---
>     * @return 
457c416
<     * @return
---
>     * @return 
488c447
<     * @return
---
>     * @return 
509c468
<     * @return
---
>     * @return 
580c539
<    static int i = 0;
---
>    static int counter = 0;
589c548
<       System.out.println("start " + i++ + ": " + st);
---
>       System.out.println("start " + counter++ + ": " + st);
601c560
<       System.out.println("start " + i++ + ": " + st);
---
>       System.out.println("start " + counter++ + ": " + st);
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/SignatureElementProxy.java xml-security-1_2_0/src/org/apache/xml/security/utils/SignatureElementProxy.java
2c2
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
3a4,14
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
5,57d15
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
64,65c22,23
< import org.apache.xml.security.utils.*;
< import org.w3c.dom.*;
---
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
71,72c29,30
<  * @author $Author: dohy $
<  * @version $Revision: 1.1.1.1 $
---
>  * @author $Author: raul $
>  * @version $Revision: 1.7 $
82a41,42
>       //this._constructionElement.setAttributeNS(Constants.NamespaceSpecNS,"xmlns:ds",
>         //          Constants.SignatureSpecNS);
94a55
> 
97,101c58
<    /**
<     * Method getBaseNamespace
<     *
<     * @return
<     */
---
>    /** @inheritDoc */
Only in xml-security-1_2_0/src/org/apache/xml/security/utils: SignerOutputStream.java
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/Version.java xml-security-1_2_0/src/org/apache/xml/security/utils/Version.java
0a1,16
> /*
>  * Copyright 1999-2004 The Apache Software Foundation.
>  *
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
>  *
>  */
5c21
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
6a23
> 
15a33,36
>    /**
>     * version
>     * @return
>     */
22a44
>      * @param argv
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/X509CertificateValidator.java xml-security-1_2_0/src/org/apache/xml/security/utils/X509CertificateValidator.java
1,85c1,45
< /*
<  * The Apache Software License, Version 1.1
<  *
<  *
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights 
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer. 
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:  
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written 
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European 
<  * Commission in the <WebSig> project in the ISIS Programme. 
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
<  */
< package org.apache.xml.security.utils;
< 
< 
< 
< import java.security.cert.*;
< 
< 
< /**
<  * First approach how the validity of certificates can be assured. This would
<  * be the way to integrate things like CRL checks etc.
<  *
<  * @author $Author: dohy $
<  */
< public class X509CertificateValidator {
< 
<    /**
<     * Method validate
<     *
<     * @param cert
<     * @throws CertificateExpiredException
<     * @throws CertificateNotYetValidException
<     */
<    public static void validate(X509Certificate cert)
<            throws CertificateNotYetValidException, CertificateExpiredException {
<       cert.checkValidity();
<    }
< }
---
> /*
>  * Copyright  1999-2004 The Apache Software Foundation.
>  *
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
>  *
>  */
> package org.apache.xml.security.utils;
> 
> 
> 
> import java.security.cert.CertificateExpiredException;
> import java.security.cert.CertificateNotYetValidException;
> import java.security.cert.X509Certificate;
> 
> 
> /**
>  * First approach how the validity of certificates can be assured. This would
>  * be the way to integrate things like CRL checks etc.
>  *
>  * @author $Author: blautenb $
>  */
> public class X509CertificateValidator {
> 
>    /**
>     * Method validate
>     *
>     * @param cert
>     * @throws CertificateExpiredException
>     * @throws CertificateNotYetValidException
>     */
>    public static void validate(X509Certificate cert)
>            throws CertificateNotYetValidException, CertificateExpiredException {
>       cert.checkValidity();
>    }
> }
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/XMLUtils.java xml-security-1_2_0/src/org/apache/xml/security/utils/XMLUtils.java
0a1
> 
2,30c3
<  * The Apache Software License, Version 1.1
<  *
<  *
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
---
>  * Copyright  1999-2004 The Apache Software Foundation.
32,34c5,15
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
---
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
36,57d16
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
63,84c22,23
< import java.io.*;
< import java.util.*;
< import java.math.BigInteger;
< import javax.xml.parsers.DocumentBuilder;
< import javax.xml.parsers.DocumentBuilderFactory;
< import javax.xml.parsers.ParserConfigurationException;
< import javax.xml.transform.Transformer;
< import javax.xml.transform.TransformerConfigurationException;
< import javax.xml.transform.TransformerException;
< import javax.xml.transform.TransformerFactory;
< import javax.xml.transform.dom.DOMSource;
< import javax.xml.transform.stream.StreamResult;
< import org.apache.xpath.objects.XObject;
< import org.w3c.dom.*;
< import org.apache.xml.security.c14n.*;
< import org.apache.xml.security.exceptions.*;
< import org.apache.xml.security.signature.XMLSignatureException;
< import org.apache.xml.security.utils.Base64;
< import org.apache.xml.security.utils.Constants;
< import org.apache.xml.security.utils.HelperNodeList;
< import org.apache.xpath.XPathAPI;
< import javax.xml.transform.TransformerException;
---
> import java.io.IOException;
> import java.io.OutputStream;
86a26,40
> import java.util.HashSet;
> import java.util.Iterator;
> import java.util.Set;
> 
> import org.apache.xml.security.c14n.CanonicalizationException;
> import org.apache.xml.security.c14n.Canonicalizer;
> import org.apache.xml.security.c14n.InvalidCanonicalizerException;
> import org.w3c.dom.Attr;
> import org.w3c.dom.Document;
> import org.w3c.dom.Element;
> import org.w3c.dom.NamedNodeMap;
> import org.w3c.dom.Node;
> import org.w3c.dom.NodeList;
> import org.w3c.dom.Text;
> 
96,490c50,480
<    /** {@link org.apache.log4j} logging facility */
<    static org.apache.log4j.Category cat =
<       org.apache.log4j.Category.getInstance(XMLUtils.class.getName());
< 
<    /**
<     * Constructor XMLUtils
<     *
<     */
<    private XMLUtils() {
< 
<       // we don't allow instantiation
<    }
< 
<    /**
<     * Method getXalanVersion
<     *
<     * @return
<     */
<    public static String getXalanVersion() {
< 
<       String version = XMLUtils.getXalan1Version();
< 
<       if (version != null) {
<          return version;
<       }
< 
<       version = XMLUtils.getXalan20Version();
< 
<       if (version != null) {
<          return version;
<       }
< 
<       version = XMLUtils.getXalan2Version();
< 
<       if (version != null) {
<          return version;
<       }
< 
<       return "Apache Xalan not installed";
< 
<       // return "Apache " + org.apache.xalan.processor.XSLProcessorVersion.S_VERSION;
<       // return "Apache " + org.apache.xalan.Version.getVersion();
<    }
< 
<    /**
<     * Method getXercesVersion
<     *
<     * @return
<     */
<    public static String getXercesVersion() {
< 
<       String version = XMLUtils.getXerces1Version();
< 
<       if (version != null) {
<          return version;
<       }
< 
<       version = XMLUtils.getXerces2Version();
< 
<       if (version != null) {
<          return version;
<       }
< 
<       return "Apache Xerces not installed";
< 
<       // return "Apache " + org.apache.xerces.impl.Version.fVersion;
<       // return "Apache " + org.apache.xerces.framework.Version.fVersion;
<    }
< 
<    /**
<     * Method getXalan1Version
<     *
<     * @return
<     */
<    private static String getXalan1Version() {
< 
<       try {
<          final String XALAN1_VERSION_CLASS =
<             "org.apache.xalan.xslt.XSLProcessorVersion";
<          Class clazz = classForName(XALAN1_VERSION_CLASS);
< 
<          // Found Xalan-J 1.x, grab it's version fields
<          StringBuffer buf = new StringBuffer();
<          Field f = clazz.getField("PRODUCT");
< 
<          buf.append(f.get(null));
<          buf.append(';');
< 
<          f = clazz.getField("LANGUAGE");
< 
<          buf.append(f.get(null));
<          buf.append(';');
< 
<          f = clazz.getField("S_VERSION");
< 
<          buf.append(f.get(null));
<          buf.append(';');
< 
<          return buf.toString();
<       } catch (Exception e1) {
<          return null;
<       }
<    }
< 
<    /**
<     * Method getXalan20Version
<     *
<     * @return
<     */
<    private static String getXalan20Version() {
< 
<       try {
< 
<          // NOTE: This is the new Xalan 2.2+ version class
<          final String XALAN2_2_VERSION_CLASS = "org.apache.xalan.Version";
<          final String XALAN2_2_VERSION_METHOD = "getVersion";
<          final Class noArgs[] = new Class[0];
<          Class clazz = classForName(XALAN2_2_VERSION_CLASS);
<          Method method = clazz.getMethod(XALAN2_2_VERSION_METHOD, noArgs);
<          Object returnValue = method.invoke(null, new Object[0]);
< 
<          return (String) returnValue;
<       } catch (Exception e2) {
<          return null;
<       }
<    }
< 
<    /**
<     * Method getXalan2Version
<     *
<     * @return
<     */
<    private static String getXalan2Version() {
< 
<       try {
< 
<          // NOTE: This is the old Xalan 2.0, 2.1, 2.2 version class,
<          //    is being replaced by class below
<          final String XALAN2_VERSION_CLASS =
<             "org.apache.xalan.processor.XSLProcessorVersion";
<          Class clazz = classForName(XALAN2_VERSION_CLASS);
< 
<          // Found Xalan-J 2.x, grab it's version fields
<          StringBuffer buf = new StringBuffer();
<          Field f = clazz.getField("S_VERSION");
< 
<          buf.append(f.get(null));
< 
<          return buf.toString();
<       } catch (Exception e2) {
<          return null;
<       }
<    }
< 
<    /**
<     * Method getXerces1Version
<     *
<     * @return
<     */
<    private static String getXerces1Version() {
< 
<       try {
<          final String XERCES1_VERSION_CLASS =
<             "org.apache.xerces.framework.Version";
<          Class clazz = classForName(XERCES1_VERSION_CLASS);
< 
<          // Found Xerces-J 1.x, grab it's version fields
<          Field f = clazz.getField("fVersion");
<          String parserVersion = (String) f.get(null);
< 
<          return parserVersion;
<       } catch (Exception e) {
<          return null;
<       }
<    }
< 
<    /**
<     * Method getXerces2Version
<     *
<     * @return
<     */
<    private static String getXerces2Version() {
< 
<       try {
<          final String XERCES2_VERSION_CLASS = "org.apache.xerces.impl.Version";
<          Class clazz = classForName(XERCES2_VERSION_CLASS);
< 
<          // Found Xerces-J 2.x, grab it's version fields
<          Field f = clazz.getField("fVersion");
<          String parserVersion = (String) f.get(null);
< 
<          return parserVersion;
<       } catch (Exception e) {
<          return null;
<       }
<    }
< 
<    /**
<     * Worker method to load a class.
<     * Factor out loading classes for future use and JDK differences.
<     * Copied from javax.xml.*.FactoryFinder
<     * @param className name of class to load from
<     * an appropriate classLoader
<     * @return the class asked for
<     * @throws ClassNotFoundException
<     */
<    protected static Class classForName(String className)
<            throws ClassNotFoundException {
< 
<       ClassLoader classLoader = findClassLoader();
< 
<       if (classLoader == null) {
<          return Class.forName(className);
<       } else {
<          return classLoader.loadClass(className);
<       }
<    }
< 
<    /**
<     * Worker method to figure out which ClassLoader to use.
<     * For JDK 1.2 and later use the context ClassLoader.
<     * Copied from javax.xml.*.FactoryFinder
<     * @return the appropriate ClassLoader
<     * @throws ClassNotFoundException
<     */
<    protected static ClassLoader findClassLoader()
<            throws ClassNotFoundException {
< 
<       ClassLoader classLoader = null;
<       Method m = null;
< 
<       try {
<          m = Thread.class.getMethod("getContextClassLoader", null);
<       } catch (NoSuchMethodException e) {
< 
<          // Assume that we are running JDK 1.1, use the current ClassLoader
<          return XMLUtils.class.getClassLoader();
<       }
< 
<       try {
<          return (ClassLoader) m.invoke(Thread.currentThread(), null);
<       } catch (Exception e) {
<          throw new RuntimeException(e.toString());
<       }
<    }
< 
<    /**
<     * Method spitOutVersions
<     *
<     * @param cat
<     */
<    public static void spitOutVersions(org.apache.log4j.Category cat) {
<       cat.debug(XMLUtils.getXercesVersion());
<       cat.debug(XMLUtils.getXalanVersion());
<    }
< 
<    /** Field nodeTypeString */
<    private static String[] nodeTypeString = new String[]{ "", "ELEMENT",
<                                                           "ATTRIBUTE",
<                                                           "TEXT_NODE",
<                                                           "CDATA_SECTION",
<                                                           "ENTITY_REFERENCE",
<                                                           "ENTITY",
<                                                           "PROCESSING_INSTRUCTION",
<                                                           "COMMENT", "DOCUMENT",
<                                                           "DOCUMENT_TYPE",
<                                                           "DOCUMENT_FRAGMENT",
<                                                           "NOTATION" };
< 
<    /**
<     * Transforms <code>org.w3c.dom.Node.XXX_NODE</code> NodeType values into
<     * Strings.
<     *
<     * @param nodeType as taken from the {@link org.w3c.dom.Node#getNodeType} function
<     * @return the String value.
<     * @see org.w3c.dom.Node#getNodeType
<     */
<    public static String getNodeTypeString(short nodeType) {
< 
<       if ((nodeType > 0) && (nodeType < 13)) {
<          return nodeTypeString[nodeType];
<       } else {
<          return "";
<       }
<    }
< 
<    /**
<     * Method getNodeTypeString
<     *
<     * @param n
<     * @return
<     */
<    public static String getNodeTypeString(Node n) {
<       return getNodeTypeString(n.getNodeType());
<    }
< 
<    /**
<     * Returns all ancestor elements of a given node up to the document element
<     *
<     * @param ctxNode
<     * @return
<     */
<    public static Vector getAncestorElements(Node ctxNode) {
< 
<       if (ctxNode.getNodeType() != Node.ELEMENT_NODE) {
<          return null;
<       }
< 
<       Vector ancestorVector = new Vector();
<       Node parent = ctxNode;
< 
<       while ((parent = parent.getParentNode()) != null
<              && (parent.getNodeType() == Node.ELEMENT_NODE)) {
<          ancestorVector.add(parent);
<       }
< 
<       ancestorVector.trimToSize();
< 
<       return ancestorVector;
<    }
< 
<    /**
<     * Returns all ancestor elements of a given node up to the given root element
<     *
<     * @param ctxNode
<     * @param rootElement
<     * @return
<     */
<    public static Vector getAncestorElements(Node ctxNode, Node rootElement) {
< 
<       Vector ancestorVector = new Vector();
< 
<       if (ctxNode.getNodeType() != Node.ELEMENT_NODE) {
<          return ancestorVector;
<       }
< 
<       Node parent = ctxNode;
<       Node parentOfRoot = rootElement.getParentNode();
< 
<       while ((parent = parent.getParentNode()) != null
<              && (parent.getNodeType() == Node.ELEMENT_NODE)
<              && (parent != parentOfRoot)) {
<          ancestorVector.add(parent);
<       }
< 
<       ancestorVector.trimToSize();
< 
<       return ancestorVector;
<    }
< 
<    /**
<     * Method getDirectChildrenElements
<     *
<     * @param parentElement
<     * @return
<     */
<    public static NodeList getDirectChildrenElements(Element parentElement) {
< 
<       NodeList allNodes = parentElement.getChildNodes();
<       HelperNodeList selectedNodes = new HelperNodeList();
< 
<       for (int i = 0; i < allNodes.getLength(); i++) {
<          Node currentNode = allNodes.item(i);
< 
<          if ((currentNode.getNodeType() == Node.ELEMENT_NODE)) {
<             selectedNodes.appendChild(currentNode);
<          }
<       }
< 
<       return selectedNodes;
<    }
< 
<    /**
<     * Method getDirectChild
<     *
<     * @param parentElement
<     * @param childLocalName
<     * @param childNamespaceURI
<     * @return
<     */
<    public static Element getDirectChild(Element parentElement,
<                                         String childLocalName,
<                                         String childNamespaceURI) {
< 
<       NodeList nl = parentElement.getChildNodes();
<       Vector results = new Vector();
< 
<       for (int i = 0; i < nl.getLength(); i++) {
<          Node n = nl.item(i);
< 
<          if (n.getNodeType() == Node.ELEMENT_NODE) {
<             if (((Element) n).getLocalName().equals(childLocalName)
<                     && ((Element) n).getNamespaceURI()
<                        .equals(childNamespaceURI)) {
<                results.add(n);
---
>     /** {@link org.apache.commons.logging} logging facility */
>     static org.apache.commons.logging.Log log =
>             org.apache.commons.logging.LogFactory.getLog(XMLUtils.class.getName());
> 
>     /**
>      * Constructor XMLUtils
>      *
>      */
>     private XMLUtils() {
> 
>         // we don't allow instantiation
>     }
> 
> 
>     /**
>      * @param rootNode
>      * @param result
>      * @param exclude
>      * @param com wheather comments or not
>      */
>     public static void getSet(Node rootNode,Set result,Node exclude ,boolean com) {
>         if ((exclude!=null) && isDescendantOrSelf(exclude,rootNode)){
>             return;
>         }
>         getSetRec(rootNode,result,exclude,com);
>     }
>     static final void getSetRec(final Node rootNode,final Set result,
>             final Node exclude ,final boolean com) {
>         //Set result = new HashSet();
>         if (rootNode==exclude) {
>             return;
>         }
>         switch (rootNode.getNodeType()) {
>         case Node.ELEMENT_NODE:
>             result.add(rootNode);
>             Element el=(Element)rootNode;
>             if (el.hasAttributes()) {
>                 NamedNodeMap nl = ((Element)rootNode).getAttributes();
>                 for (int i=0;i<nl.getLength();i++) {
>                     result.add(nl.item(i));
>                 }
>             }
>             //no return keep working
>         case Node.DOCUMENT_NODE:
>             for (Node r=rootNode.getFirstChild();r!=null;r=r.getNextSibling()){
>                 if (r.getNodeType()==Node.TEXT_NODE) {
>                     result.add(r);
>                     while ((r!=null) && (r.getNodeType()==Node.TEXT_NODE)) {
>                         r=r.getNextSibling();
>                     }
>                     if (r==null) {
>                         return;
>                     }
>                 }
>                 getSetRec(r,result,exclude,com);
>             }
>             return;
>         case Node.COMMENT_NODE:
>             if (com) {
>                 result.add(rootNode);
>             }
>             return;
>         case Node.DOCUMENT_TYPE_NODE:
>             return;
>         default:
>             result.add(rootNode);
>         }
>         return;
>     }
>     /**
>      * Method getXalanVersion
>      *
>      * @return
>      */
>     public static String getXalanVersion() {
> 
>         String version = XMLUtils.getXalan1Version();
> 
>         if (version != null) {
>             return version;
>         }
> 
>         version = XMLUtils.getXalan20Version();
> 
>         if (version != null) {
>             return version;
>         }
> 
>         version = XMLUtils.getXalan2Version();
> 
>         if (version != null) {
>             return version;
>         }
> 
>         return "Apache Xalan not installed";
> 
>         // return "Apache " + org.apache.xalan.processor.XSLProcessorVersion.S_VERSION;
>         // return "Apache " + org.apache.xalan.Version.getVersion();
>     }
> 
>     /**
>      * Method getXercesVersion
>      *
>      * @return
>      */
>     public static String getXercesVersion() {
> 
>         String version = XMLUtils.getXerces1Version();
> 
>         if (version != null) {
>             return version;
>         }
> 
>         version = XMLUtils.getXerces2Version();
> 
>         if (version != null) {
>             return version;
>         }
> 
>         return "Apache Xerces not installed";
> 
>         // return "Apache " + org.apache.xerces.impl.Version.fVersion;
>         // return "Apache " + org.apache.xerces.framework.Version.fVersion;
>     }
> 
>     /**
>      * Method getXalan1Version
>      *
>      * @return
>      */
>     private static String getXalan1Version() {
> 
>         try {
>             final String XALAN1_VERSION_CLASS =
>                     "org.apache.xalan.xslt.XSLProcessorVersion";
>             Class clazz = classForName(XALAN1_VERSION_CLASS);
> 
>             // Found Xalan-J 1.x, grab it's version fields
>             StringBuffer buf = new StringBuffer();
>             Field f = clazz.getField("PRODUCT");
> 
>             buf.append(f.get(null));
>             buf.append(';');
> 
>             f = clazz.getField("LANGUAGE");
> 
>             buf.append(f.get(null));
>             buf.append(';');
> 
>             f = clazz.getField("S_VERSION");
> 
>             buf.append(f.get(null));
>             buf.append(';');
> 
>             return buf.toString();
>         } catch (Exception e1) {
>             return null;
>         }
>     }
> 
>     /**
>      * Method getXalan20Version
>      *
>      * @return
>      */
>     private static String getXalan20Version() {
> 
>         try {
> 
>             // NOTE: This is the new Xalan 2.2+ version class
>             final String XALAN2_2_VERSION_CLASS = "org.apache.xalan.Version";
>             final String XALAN2_2_VERSION_METHOD = "getVersion";
>             final Class noArgs[] = new Class[0];
>             Class clazz = classForName(XALAN2_2_VERSION_CLASS);
>             Method method = clazz.getMethod(XALAN2_2_VERSION_METHOD, noArgs);
>             Object returnValue = method.invoke(null, new Object[0]);
> 
>             return (String) returnValue;
>         } catch (Exception e2) {
>             return null;
>         }
>     }
> 
>     /**
>      * Method getXalan2Version
>      *
>      * @return
>      */
>     private static String getXalan2Version() {
> 
>         try {
> 
>             // NOTE: This is the old Xalan 2.0, 2.1, 2.2 version class,
>             //    is being replaced by class below
>             final String XALAN2_VERSION_CLASS =
>                     "org.apache.xalan.processor.XSLProcessorVersion";
>             Class clazz = classForName(XALAN2_VERSION_CLASS);
> 
>             // Found Xalan-J 2.x, grab it's version fields
>             StringBuffer buf = new StringBuffer();
>             Field f = clazz.getField("S_VERSION");
> 
>             buf.append(f.get(null));
> 
>             return buf.toString();
>         } catch (Exception e2) {
>             return null;
>         }
>     }
> 
>     /**
>      * Method getXerces1Version
>      *
>      * @return
>      */
>     private static String getXerces1Version() {
> 
>         try {
>             final String XERCES1_VERSION_CLASS =
>                     "org.apache.xerces.framework.Version";
>             Class clazz = classForName(XERCES1_VERSION_CLASS);
> 
>             // Found Xerces-J 1.x, grab it's version fields
>             Field f = clazz.getField("fVersion");
>             String parserVersion = (String) f.get(null);
> 
>             return parserVersion;
>         } catch (Exception e) {
>             return null;
>         }
>     }
> 
>     /**
>      * Method getXerces2Version
>      *
>      * @return
>      */
>     private static String getXerces2Version() {
> 
>         try {
>             final String XERCES2_VERSION_CLASS = "org.apache.xerces.impl.Version";
>             Class clazz = classForName(XERCES2_VERSION_CLASS);
> 
>             // Found Xerces-J 2.x, grab it's version fields
>             Field f = clazz.getField("fVersion");
>             String parserVersion = (String) f.get(null);
> 
>             return parserVersion;
>         } catch (Exception e) {
>             return null;
>         }
>     }
> 
>     /**
>      * Worker method to load a class.
>      * Factor out loading classes for future use and JDK differences.
>      * Copied from javax.xml.*.FactoryFinder
>      * @param className name of class to load from
>      * an appropriate classLoader
>      * @return the class asked for
>      * @throws ClassNotFoundException
>      */
>     public static Class classForName(String className)
>             throws ClassNotFoundException {
> 
>         ClassLoader classLoader = findClassLoader();
> 
>         if (classLoader == null) {
>             return Class.forName(className);
>         }
>         return classLoader.loadClass(className);
>     }
> 
>     /**
>      * Worker method to figure out which ClassLoader to use.
>      * For JDK 1.2 and later use the context ClassLoader.
>      * Copied from javax.xml.*.FactoryFinder
>      * @return the appropriate ClassLoader
>      */
>     protected static ClassLoader findClassLoader() {
> 
>         Method m = null;
> 
>         try {
>             m = Thread.class.getMethod("getContextClassLoader", new Class[]{});
>         } catch (NoSuchMethodException e) {
> 
>             // Assume that we are running JDK 1.1, use the current ClassLoader
>             return XMLUtils.class.getClassLoader();
>         }
> 
>         try {
>             return (ClassLoader) m.invoke(Thread.currentThread(), new Object[]{});
>         } catch (Exception e) {
>             throw new RuntimeException(e.toString());
>         }
>     }
> 
> 
>     /**
>      * Method spitOutVersions
>      *
>      * @param log
>      */
>     public static void spitOutVersions(org.apache.commons.logging.Log log) {
>         if (log.isDebugEnabled()) {
>             log.debug(XMLUtils.getXercesVersion());
>             log.debug(XMLUtils.getXalanVersion());
>         }
>     }
> 
>     /** Field nodeTypeString */
>     private static String[] nodeTypeString = new String[]{ "", "ELEMENT",
>         "ATTRIBUTE",
>         "TEXT_NODE",
>         "CDATA_SECTION",
>         "ENTITY_REFERENCE",
>         "ENTITY",
>         "PROCESSING_INSTRUCTION",
>         "COMMENT", "DOCUMENT",
>         "DOCUMENT_TYPE",
>         "DOCUMENT_FRAGMENT",
>     "NOTATION" };
> 
>     /**
>      * Transforms <code>org.w3c.dom.Node.XXX_NODE</code> NodeType values into
>      * Strings.
>      *
>      * @param nodeType as taken from the {@link org.w3c.dom.Node#getNodeType} function
>      * @return the String value.
>      * @see org.w3c.dom.Node#getNodeType
>      */
>     public static String getNodeTypeString(short nodeType) {
> 
>         if ((nodeType > 0) && (nodeType < 13)) {
>             return nodeTypeString[nodeType];
>         }
>         return "";
>     }
> 
> 
>     /**
>      * Outputs a DOM tree to an {@link OutputStream}.
>      *
>      * @param contextNode root node of the DOM tree
>      * @param os the {@link OutputStream}
>      */
>     public static void outputDOM(Node contextNode, OutputStream os) {
>         XMLUtils.outputDOM(contextNode, os, false);
>     }
> 
>     /**
>      * Outputs a DOM tree to an {@link OutputStream}. <I>If an Exception is
>      * thrown during execution, it's StackTrace is output to System.out, but the
>      * Exception is not re-thrown.</I>
>      *
>      * @param contextNode root node of the DOM tree
>      * @param os the {@link OutputStream}
>      * @param addPreamble
>      */
>     public static void outputDOM(Node contextNode, OutputStream os,
>             boolean addPreamble) {
> 
>         try {
>             if (addPreamble) {
>                 os.write("<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n".getBytes());
>             }
> 
>             os.write(
>                     Canonicalizer.getInstance(
>                             Canonicalizer.ALGO_ID_C14N_WITH_COMMENTS).canonicalizeSubtree(
>                                     contextNode));
>         } catch (IOException ex) {}
>         catch (InvalidCanonicalizerException ex) {
>             ex.printStackTrace();
>         } catch (CanonicalizationException ex) {
>             ex.printStackTrace();
>         }
>     }
> 
>     /**
>      * Serializes the <CODE>contextNode</CODE> into the OutputStream, <I>but
>      * supresses all Exceptions</I>.
>      * <BR />
>      * NOTE: <I>This should only be used for debugging purposes,
>      * NOT in a production environment; this method ignores all exceptions,
>      * so you won't notice if something goes wrong. If you're asking what is to
>      * be used in a production environment, simply use the code inside the
>      * <code>try{}</code> statement, but handle the Exceptions appropriately.</I>
>      *
>      * @param contextNode
>      * @param os
>      */
>     public static void outputDOMc14nWithComments(Node contextNode,
>             OutputStream os) {
> 
>         try {
>             os.write(
>                     Canonicalizer.getInstance(
>                             Canonicalizer.ALGO_ID_C14N_WITH_COMMENTS).canonicalizeSubtree(
>                                     contextNode));
>         } catch (IOException ex) {
> 
>             // throw new RuntimeException(ex.getMessage());
>         } catch (InvalidCanonicalizerException ex) {
> 
>             // throw new RuntimeException(ex.getMessage());
>         } catch (CanonicalizationException ex) {
> 
>             // throw new RuntimeException(ex.getMessage());
>         }
>     }
> 
> 
>     /**
>      * Method getFullTextChildrenFromElement
>      *
>      * @param element
>      * @return
>      */
>     public static String getFullTextChildrenFromElement(Element element) {
> 
>         StringBuffer sb = new StringBuffer();
>         NodeList children = element.getChildNodes();
>         int iMax = children.getLength();
> 
>         for (int i = 0; i < iMax; i++) {
>             Node curr = children.item(i);
> 
>             if (curr.getNodeType() == Node.TEXT_NODE) {
>                 sb.append(((Text) curr).getData());
492,493c482,486
<          }
<       }
---
>         }
> 
>         return sb.toString();
>     }
> 
495,990c488,585
<       if (results.size() != 1) {
<          return null;
<       }
< 
<       return (Element) results.elementAt(0);
<    }
< 
<    /**
<     * Outputs a DOM tree to a file.
<     *
<     * @param contextNode root node of the DOM tree
<     * @param filename the file name
<     * @throws java.io.FileNotFoundException
<     */
<    public static void outputDOM(Node contextNode, String filename)
<            throws java.io.FileNotFoundException {
< 
<       OutputStream os = new FileOutputStream(filename);
< 
<       XMLUtils.outputDOM(contextNode, os);
<    }
< 
<    /**
<     * Outputs a DOM tree to an {@link OutputStream}.
<     *
<     * @param contextNode root node of the DOM tree
<     * @param os the {@link OutputStream}
<     */
<    public static void outputDOM(Node contextNode, OutputStream os) {
<       XMLUtils.outputDOM(contextNode, os, false);
<    }
< 
<    /**
<     * Outputs a DOM tree to an {@link OutputStream}. <I>If an Exception is
<     * thrown during execution, it's StackTrace is output to System.out, but the
<     * Exception is not re-thrown.</I>
<     *
<     * @param contextNode root node of the DOM tree
<     * @param os the {@link OutputStream}
<     * @param addPreamble
<     */
<    public static void outputDOM(Node contextNode, OutputStream os,
<                                 boolean addPreamble) {
< 
<       try {
<          if (addPreamble) {
<             os.write("<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n".getBytes());
<          }
< 
<          os.write(Canonicalizer
<             .getInstance(Canonicalizer.ALGO_ID_C14N_WITH_COMMENTS)
<                .canonicalizeSubtree(contextNode));
<       } catch (IOException ex) {}
<       catch (InvalidCanonicalizerException ex) {
<          ex.printStackTrace();
<       } catch (CanonicalizationException ex) {
<          ex.printStackTrace();
<       }
<    }
< 
<    /**
<     * Serializes the <CODE>contextNode</CODE> into the OutputStream, <I>but
<     * supresses all Exceptions</I>.
<     * <BR />
<     * NOTE: <I>This should only be used for debugging purposes,
<     * NOT in a production environment; this method ignores all exceptions,
<     * so you won't notice if something goes wrong. If you're asking what is to
<     * be used in a production environment, simply use the code inside the
<     * <code>try{}</code> statement, but handle the Exceptions appropriately.</I>
<     *
<     * @param contextNode
<     * @param os
<     */
<    public static void outputDOMc14nWithComments(Node contextNode,
<            OutputStream os) {
< 
<       try {
<          os.write(Canonicalizer
<             .getInstance(Canonicalizer.ALGO_ID_C14N_WITH_COMMENTS)
<                .canonicalizeSubtree(contextNode));
<       } catch (IOException ex) {
< 
<          // throw new RuntimeException(ex.getMessage());
<       } catch (InvalidCanonicalizerException ex) {
< 
<          // throw new RuntimeException(ex.getMessage());
<       } catch (CanonicalizationException ex) {
< 
<          // throw new RuntimeException(ex.getMessage());
<       }
<    }
< 
<    /**
<     * Converts a single {@link Node} into a {@link NodeList} which contains only that {@link Node}
<     *
<     * @param node the Node
<     * @return the NodeList
<     */
<    public static NodeList elementToNodeList(Node node) {
< 
<       HelperNodeList nl = new HelperNodeList();
< 
<       nl.appendChild(node);
< 
<       return (NodeList) nl;
<    }
< 
<    /**
<     * Creates Attributes {@link org.w3c.dom.Attr} in the given namespace
<     * (if possible). If the namespace is empty, only the QName is used.
<     *
<     * @param doc the generator (factory) Document
<     * @param QName the QName of the Attr
<     * @param Value the String value of the Attr
<     * @param NamespaceURI the namespace for the Attr
<     * @return the Attr
<     */
<    public static Attr createAttr(Document doc, String QName, String Value,
<                                  String NamespaceURI) {
< 
<       Attr attr = doc.createAttributeNS(NamespaceURI, QName);
< 
<       attr.setNodeValue(Value);
< 
<       return attr;
<    }
< 
<    /**
<     * Sets the Attribute QName with Value in Element elem.
<     *
<     * @param elem the Element which has to contain the Attribute
<     * @param QName the QName of the Attribute
<     * @param Value the value of the Attribute
<     */
<    public static void setAttr(Element elem, String QName, String Value) {
< 
<       Document doc = elem.getOwnerDocument();
<       Attr attr = doc.createAttributeNS(Constants.SignatureSpecNS, QName);
< 
<       attr.setNodeValue(Value);
<       elem.setAttributeNode(attr);
<    }
< 
<    /**
<     * Creates an Element from a BigInteger. The BigInteger is base64-encoded
<     * and put into the Element with a given name.
<     *
<     * See
<     * <A HREF="http://www.w3.org/TR/2001/CR-xmldsig-core-20010419/#sec-CryptoBinary">Section
<     * 4.0.1 The ds:CryptoBinary Simple Type</A>:
<     *
<     * This specification defines the ds:CryptoBinary simple type for
<     * representing arbitrary-length integers (e.g. "bignums") in XML as
<     * octet strings. The integer value is first converted to a "big
<     * endian" bitstring. The bitstring is then padded with leading zero
<     * bits so that the total number of bits == 0 mod 8 (so that there are
<     * an integral number of octets). If the bitstring contains entire
<     * leading octets that are zero, these are removed (so the high-order
<     * octet is always non-zero). This octet string is then base64 [MIME]
<     * encoded. (The conversion from integer to octet string is equivalent
<     * to IEEE 1363's I2OSP [1363] with minimal length).
<     *
<     *
<     * @param doc the factory Document
<     * @param elementName the name of the Element
<     * @param bigInteger the BigInteger wo be inserted
<     * @return the Element
<     * @throws XMLSignatureException if bigInteger is not positive
<     */
<    public static Element createElementFromBigint(
<            Document doc, String elementName, BigInteger bigInteger)
<               throws XMLSignatureException {
< 
<       Element element = doc.createElementNS(Constants.SignatureSpecNS,
<                                             Constants.getSignatureSpecNSprefix()
<                                             + ":" + elementName);
< 
<       /* bigInteger must be positive */
<       if (bigInteger.signum() != 1) {
<          throw new XMLSignatureException("signature.Util.BignumNonPositive");
<       }
< 
<       byte byteRepresentation[] = bigInteger.toByteArray();
< 
<       while (byteRepresentation[0] == 0) {
<          byte oldByteRepresentation[] = byteRepresentation;
< 
<          byteRepresentation = new byte[oldByteRepresentation.length - 1];
< 
<          System.arraycopy(oldByteRepresentation, 1, byteRepresentation, 0,
<                           oldByteRepresentation.length - 1);
<       }
< 
<       Text text =
<          doc.createTextNode(org.apache.xml.security.utils.Base64
<             .encode(byteRepresentation));
< 
<       element.appendChild(text);
< 
<       return element;
<    }
< 
<    /**
<     * Method getFullTextChildrenFromElement
<     *
<     * @param element
<     * @return
<     */
<    public static String getFullTextChildrenFromElement(Element element) {
< 
<       StringBuffer sb = new StringBuffer();
<       NodeList children = element.getChildNodes();
<       int iMax = children.getLength();
< 
<       for (int i = 0; i < iMax; i++) {
<          Node curr = children.item(i);
< 
<          if (curr.getNodeType() == Node.TEXT_NODE) {
<             sb.append(((Text) curr).getData());
<          }
<       }
< 
<       return sb.toString();
<    }
< 
<    /**
<     * Fetches a base64-encoded BigInteger from an Element.
<     *
<     * @param element the Element
<     * @return the BigInteger
<     * @throws XMLSignatureException if Element has not exactly one Text child
<     */
<    public static BigInteger getBigintFromElement(Element element)
<            throws XMLSignatureException {
< 
<       try {
<          if (element.getChildNodes().getLength() != 1) {
<             throw new XMLSignatureException("signature.Util.TooManyChilds");
<          }
< 
<          Node child = element.getFirstChild();
< 
<          if ((child == null) || (child.getNodeType() != Node.TEXT_NODE)) {
<             throw new XMLSignatureException("signature.Util.NonTextNode");
<          }
< 
<          Text text = (Text) child;
<          String textData = text.getData();
<          byte magnitude[] =
<             org.apache.xml.security.utils.Base64.decode(textData);
<          int signum = 1;
<          BigInteger bigInteger = new BigInteger(signum, magnitude);
< 
<          return bigInteger;
<       } catch (Base64DecodingException ex) {
<          throw new XMLSignatureException("empty", ex);
<       }
<    }
< 
<    /**
<     * Fetches base64-encoded byte[] data from an Element.
<     *
<     * @param element
<     * @return the byte[] data
<     * @throws XMLSignatureException if Element has not exactly one Text child
<     */
<    public static byte[] getBytesFromElement(Element element)
<            throws XMLSignatureException {
< 
<       try {
<          if (element.getChildNodes().getLength() != 1) {
<             throw new XMLSignatureException("signature.Util.TooManyChilds");
<          }
< 
<          Node child = element.getFirstChild();
< 
<          if ((child == null) || (child.getNodeType() != Node.TEXT_NODE)) {
<             throw new XMLSignatureException("signature.Util.NonTextNode");
<          }
< 
<          Text text = (Text) child;
<          String textData = text.getData();
<          byte bytes[] = org.apache.xml.security.utils.Base64.decode(textData);
< 
<          return bytes;
<       } catch (Base64DecodingException ex) {
<          throw new XMLSignatureException("empty", ex);
<       }
<    }
< 
<    /**
<     * Creates an Element in the XML Signature specification namespace.
<     *
<     * @param doc the factory Document
<     * @param elementName the local name of the Element
<     * @return the Element
<     */
<    public static Element createElementInSignatureSpace(Document doc,
<            String elementName) {
< 
<       if (doc == null) {
<          throw new RuntimeException("Document is null");
<       }
< 
<       String ds = Constants.getSignatureSpecNSprefix();
< 
<       if ((ds == null) || (ds.length() == 0)) {
<          Element element = doc.createElementNS(Constants.SignatureSpecNS,
<                                                elementName);
< 
<          element.setAttributeNS(Constants.NamespaceSpecNS, "xmlns",
<                                 Constants.SignatureSpecNS);
< 
<          return element;
<       } else {
<          Element element = doc.createElementNS(Constants.SignatureSpecNS,
<                                                ds + ":" + elementName);
< 
<          element.setAttributeNS(Constants.NamespaceSpecNS, "xmlns:" + ds,
<                                 Constants.SignatureSpecNS);
< 
<          return element;
<       }
<    }
< 
<    /**
<     * Creates an Element in the XML Encryption specification namespace.
<     *
<     * @param doc the factory Document
<     * @param elementName the local name of the Element
<     * @return the Element
<     */
<    public static Element createElementInEncryptionSpace(Document doc,
<            String elementName) {
< 
<       if (doc == null) {
<          throw new RuntimeException("Document is null");
<       }
< 
<       String xenc = EncryptionConstants.getEncryptionSpecNSprefix();
< 
<       if ((xenc == null) || (xenc.length() == 0)) {
<          Element element =
<             doc.createElementNS(EncryptionConstants.EncryptionSpecNS,
<                                 elementName);
< 
<          element.setAttributeNS(Constants.NamespaceSpecNS, "xmlns",
<                                 Constants.SignatureSpecNS);
< 
<          return element;
<       } else {
<          Element element =
<             doc.createElementNS(EncryptionConstants.EncryptionSpecNS,
<                                 xenc + ":" + elementName);
< 
<          element.setAttributeNS(Constants.NamespaceSpecNS, "xmlns:" + xenc,
<                                 EncryptionConstants.EncryptionSpecNS);
< 
<          return element;
<       }
<    }
< 
<    /**
<     * Returns true if the element is in XML Signature namespace and the local
<     * name equals the supplied one.
<     *
<     * @param element
<     * @param localName
<     * @return true if the element is in XML Signature namespace and the local name equals the supplied one
<     */
<    public static boolean elementIsInSignatureSpace(Element element,
<            String localName) {
< 
<       if (element == null) {
<          return false;
<       }
< 
<       if (element.getNamespaceURI() == null) {
<          return false;
<       }
< 
<       if (!element.getNamespaceURI().equals(Constants.SignatureSpecNS)) {
<          return false;
<       }
< 
<       if (!element.getLocalName().equals(localName)) {
<          return false;
<       }
< 
<       return true;
<    }
< 
<    /**
<     * Returns true if the element is in XML Encryption namespace and the local
<     * name equals the supplied one.
<     *
<     * @param element
<     * @param localName
<     * @return true if the element is in XML Encryption namespace and the local name equals the supplied one
<     */
<    public static boolean elementIsInEncryptionSpace(Element element,
<            String localName) {
< 
<       if (element == null) {
<          return false;
<       }
< 
<       if (element.getNamespaceURI() == null) {
<          return false;
<       }
< 
<       if (!element.getNamespaceURI()
<               .equals(EncryptionConstants.EncryptionSpecNS)) {
<          return false;
<       }
< 
<       if (!element.getLocalName().equals(localName)) {
<          return false;
<       }
< 
<       return true;
<    }
< 
<    /**
<     * Verifies that the given Element is in the XML Signature namespace
<     * {@link org.apache.xml.security.utils.Constants#SignatureSpecNS} and that the
<     * local name of the Element matches the supplied on.
<     *
<     * @param element Element to be checked
<     * @param localName
<     * @throws XMLSignatureException if element is not in Signature namespace or if the local name does not match
<     * @see org.apache.xml.security.utils.Constants#SignatureSpecNS
<     */
<    public static void guaranteeThatElementInSignatureSpace(
<            Element element, String localName) throws XMLSignatureException {
< 
<       /*
<       cat.debug("guaranteeThatElementInSignatureSpace(" + element + ", "
<                 + localName + ")");
<       */
<       if (element == null) {
<          Object exArgs[] = { localName, null };
< 
<          throw new XMLSignatureException("xml.WrongElement", exArgs);
<       }
< 
<       if ((localName == null) || localName.equals("")
<               ||!elementIsInSignatureSpace(element, localName)) {
<          Object exArgs[] = { localName, element.getLocalName() };
< 
<          throw new XMLSignatureException("xml.WrongElement", exArgs);
<       }
<    }
< 
<    /**
<     * Verifies that the given Element is in the XML Encryption namespace
<     * {@link org.apache.xml.security.utils.Constants#EncryptionSpecNS} and that the
<     * local name of the Element matches the supplied on.
<     *
<     * @param element Element to be checked
<     * @param localName
<     * @throws XMLSecurityException if element is not in Encryption namespace or if the local name does not match
<     * @see org.apache.xml.security.utils.Constants#EncryptionSpecNS
<     */
<    public static void guaranteeThatElementInEncryptionSpace(
<            Element element, String localName) throws XMLSecurityException {
< 
<       if (element == null) {
<          Object exArgs[] = { localName, null };
< 
<          throw new XMLSecurityException("xml.WrongElement", exArgs);
<       }
< 
<       if ((localName == null) || localName.equals("")
<               ||!elementIsInEncryptionSpace(element, localName)) {
<          Object exArgs[] = { localName, element.getLocalName() };
< 
<          throw new XMLSecurityException("xml.WrongElement", exArgs);
<       }
<    }
< 
<    /**
<     * This method returns the owner document of a particular node.
<     * This method is necessary because it <I>always</I> returns a
<     * {@link Document}. {@link Node#getOwnerDocument} returns <CODE>null</CODE>
<     * if the {@link Node} is a {@link Document}.
<     *
<     * @param node
<     * @return the owner document of the node
<     */
<    public static Document getOwnerDocument(Node node) {
< 
<       if (node.getNodeType() == Node.DOCUMENT_NODE) {
<          return (Document) node;
<       } else {
<          try {
---
>     /**
>      * Creates an Element in the XML Signature specification namespace.
>      *
>      * @param doc the factory Document
>      * @param elementName the local name of the Element
>      * @return the Element
>      */
>     public static Element createElementInSignatureSpace(Document doc,
>             String elementName) {
> 
>         if (doc == null) {
>             throw new RuntimeException("Document is null");
>         }
> 
>         String ds = Constants.getSignatureSpecNSprefix();
> 
>         if ((ds == null) || (ds.length() == 0)) {
>             Element element = doc.createElementNS(Constants.SignatureSpecNS,
>                     elementName);
> 
>             element.setAttributeNS(Constants.NamespaceSpecNS, "xmlns",
>                     Constants.SignatureSpecNS);
> 
>             return element;
>         }
>         Element element = doc.createElementNS(Constants.SignatureSpecNS,
>                 ds + ":" + elementName);
> 
>         element.setAttributeNS(Constants.NamespaceSpecNS, "xmlns:" + ds,
>                 Constants.SignatureSpecNS);
> 
>         return element;
> 
>     }
> 
> 
>     /**
>      * Returns true if the element is in XML Signature namespace and the local
>      * name equals the supplied one.
>      *
>      * @param element
>      * @param localName
>      * @return true if the element is in XML Signature namespace and the local name equals the supplied one
>      */
>     public static boolean elementIsInSignatureSpace(Element element,
>             String localName) {
> 
>         if ((element == null) ||
>                 !Constants.SignatureSpecNS.equals(element.getNamespaceURI()) ){
>             return false;
>         }
> 
>         if (!element.getLocalName().equals(localName)) {
>             return false;
>         }
> 
>         return true;
>     }
> 
>     /**
>      * Returns true if the element is in XML Encryption namespace and the local
>      * name equals the supplied one.
>      *
>      * @param element
>      * @param localName
>      * @return true if the element is in XML Encryption namespace and the local name equals the supplied one
>      */
>     public static boolean elementIsInEncryptionSpace(Element element,
>             String localName) {
> 
>         if ((element == null) ||
>                 !EncryptionConstants.EncryptionSpecNS.equals(element.getNamespaceURI())
>                 ){
>             return false;
>         }
> 
>         if (!element.getLocalName().equals(localName)) {
>             return false;
>         }
> 
>         return true;
>     }
> 
>     /**
>      * This method returns the owner document of a particular node.
>      * This method is necessary because it <I>always</I> returns a
>      * {@link Document}. {@link Node#getOwnerDocument} returns <CODE>null</CODE>
>      * if the {@link Node} is a {@link Document}.
>      *
>      * @param node
>      * @return the owner document of the node
>      */
>     public static Document getOwnerDocument(Node node) {
> 
>         if (node.getNodeType() == Node.DOCUMENT_NODE) {
>             return (Document) node;
>         }
>         try {
992c587
<          } catch (NullPointerException npe) {
---
>         } catch (NullPointerException npe) {
994,1041c589,619
<                                            + " Original message was \""
<                                            + npe.getMessage() + "\"");
<          }
<       }
<    }
< 
<    /** Field randomNS */
<    private static String randomNS = null;
< 
<    /**
<     * Prefix for random namespaces.
<     *
<     * @see #getRandomNamespace
<     */
<    public static final String randomNSprefix =
<       "http://www.xmlsecurity.org/NS#randomval";
< 
<    /**
<     * This method creates a random String like
<     * <CODE>http://www.xmlsecurity.org/NS#randomval8dcc/C2qwxFukXjJhS7W1xvHHq4Z</CODE>
<     * that will be used for registering the <CODE>here()</CODE> function in a
<     * specific namespace. The random string is the Base64 encoded version of a
<     * 168 bit {@link java.security.SecureRandom} value.
<     * <BR/>
<     * This random namespace prefix prevents attackers from inserting malicious
<     * here() functions in our namespace. The method caches the valued for
<     * subsequent calls during the application run.
<     *
<     * @return the random namespace prefix String.
<     */
<    public static String getRandomNamespacePrefix() {
< 
<       if (XMLUtils.randomNS == null) {
<          byte[] randomData = new byte[21];
<          java.security.SecureRandom sr = new java.security.SecureRandom();
< 
<          sr.nextBytes(randomData);
< 
<          String prefix =
<             "xmlsecurityOrgPref"
<             + org.apache.xml.security.utils.Base64.encode(randomData);
< 
<          XMLUtils.randomNS = "";
< 
<          for (int i = 0; i < prefix.length(); i++) {
<             if ((prefix.charAt(i) != '+') && (prefix.charAt(i) != '/')
<                     && (prefix.charAt(i) != '=')) {
<                XMLUtils.randomNS += prefix.charAt(i);
---
>                     + " Original message was \""
>                     + npe.getMessage() + "\"");
>         }
> 
>     }
> 
>     /**
>      * This method returns the first non-null owner document of the Node's in this Set.
>      * This method is necessary because it <I>always</I> returns a
>      * {@link Document}. {@link Node#getOwnerDocument} returns <CODE>null</CODE>
>      * if the {@link Node} is a {@link Document}.
>      *
>      * @param xpathNodeSet
>      * @return the owner document
>      */
>     public static Document getOwnerDocument(Set xpathNodeSet) {
>         NullPointerException npe = null;
>         Iterator iterator = xpathNodeSet.iterator();
>         while(iterator.hasNext()) {
>             Node node = (Node) iterator.next();
>             int nodeType =node.getNodeType();
>             if (nodeType == Node.DOCUMENT_NODE) {
>                 return (Document) node;
>             }
>             try {
>                 if (nodeType==Node.ATTRIBUTE_NODE) {
>                     return ((Attr)node).getOwnerElement().getOwnerDocument();
>                 }
>                 return node.getOwnerDocument();
>             } catch (NullPointerException e) {
>                 npe = e;
1043,1044d620
<          }
<       }
1046,1047c622,753
<       return XMLUtils.randomNS;
<    }
---
>         }
>         throw new NullPointerException(I18n.translate("endorsed.jdk1.4.0")
>                 + " Original message was \""
>                 + (npe == null ? "" : npe.getMessage()) + "\"");
>     }
> 
> 
> 
>     /**
>      * Method createDSctx
>      *
>      * @param doc
>      * @param prefix
>      * @param namespace
>      * @return
>      */
>     public static Element createDSctx(Document doc, String prefix,
>             String namespace) {
> 
>         if ((prefix == null) || (prefix.trim().length() == 0)) {
>             throw new IllegalArgumentException("You must supply a prefix");
>         }
> 
>         Element ctx = doc.createElementNS(null, "namespaceContext");
> 
>         ctx.setAttributeNS(Constants.NamespaceSpecNS, "xmlns:" + prefix.trim(),
>                 namespace);
> 
>         return ctx;
>     }
> 
> 
> 
>     /**
>      * Method addReturnToElement
>      *
>      * @param e
>      */
>     public static void addReturnToElement(Element e) {
> 
>         Document doc = e.getOwnerDocument();
> 
>         e.appendChild(doc.createTextNode("\n"));
>     }
> 
>     /**
>      * Method convertNodelistToSet
>      *
>      * @param xpathNodeSet
>      * @return
>      */
>     public static Set convertNodelistToSet(NodeList xpathNodeSet) {
> 
>         if (xpathNodeSet == null) {
>             return new HashSet();
>         }
> 
>         int length = xpathNodeSet.getLength();
>         Set set = new HashSet(length);
> 
>         for (int i = 0; i < length; i++) {
>             set.add(xpathNodeSet.item(i));
>         }
> 
>         return set;
>     }
> 
> 
>     /**
>      * This method spreads all namespace attributes in a DOM document to their
>      * children. This is needed because the XML Signature XPath transform
>      * must evaluate the XPath against all nodes in the input, even against
>      * XPath namespace nodes. Through a bug in XalanJ2, the namespace nodes are
>      * not fully visible in the Xalan XPath model, so we have to do this by
>      * hand in DOM spaces so that the nodes become visible in XPath space.
>      *
>      * @param doc
>      * @see <A HREF="http://nagoya.apache.org/bugzilla/show_bug.cgi?id=2650">Namespace axis resolution is not XPath compliant </A>
>      */
>     public static void circumventBug2650(Document doc) {
> 
>         Element documentElement = doc.getDocumentElement();
> 
>         // if the document element has no xmlns definition, we add xmlns=""
>         Attr xmlnsAttr =
>                 documentElement.getAttributeNodeNS(Constants.NamespaceSpecNS, "xmlns");
> 
>         if (xmlnsAttr == null) {
>             documentElement.setAttributeNS(Constants.NamespaceSpecNS, "xmlns", "");
>         }
> 
>         XMLUtils.circumventBug2650recurse(doc);
>     }
> 
>     /**
>      * This is the work horse for {@link #circumventBug2650}.
>      *
>      * @param node
>      * @see <A HREF="http://nagoya.apache.org/bugzilla/show_bug.cgi?id=2650">Namespace axis resolution is not XPath compliant </A>
>      */
>     private static void circumventBug2650recurse(Node node) {
> 
>         if (node.getNodeType() == Node.ELEMENT_NODE) {
>             Element element = (Element) node;
>             if (element.hasChildNodes() && element.hasAttributes()) {
>                 NamedNodeMap attributes = element.getAttributes();
>                 int attributesLength = attributes.getLength();
> 
>                 for (Node child = element.getFirstChild(); child!=null;
>                         child=child.getNextSibling()) {
> 
>                     if (child.getNodeType() == Node.ELEMENT_NODE) {
>                         Element childElement = (Element) child;
> 
>                         for (int i = 0; i < attributesLength; i++) {
>                             Attr currentAttr = (Attr) attributes.item(i);
>                             if (Constants.NamespaceSpecNS.equals(
>                                     currentAttr.getNamespaceURI())) {
> 
>                                 if (!childElement.hasAttributeNS(
>                                         Constants.NamespaceSpecNS,
>                                         currentAttr.getLocalName())) {
>                                     childElement.setAttributeNS(Constants.NamespaceSpecNS,
>                                             currentAttr.getName(),
>                                             currentAttr.getNodeValue());
>                                 }
>                             }
>                         }
>                     }
>                 }
>             }
>         }
1049,1096c755,765
<    /**
<     * Method createDSctx
<     *
<     * @param doc
<     * @param prefix
<     * @param namespace
<     * @return
<     */
<    public static Element createDSctx(Document doc, String prefix,
<                                      String namespace) {
< 
<       Element ctx = doc.createElementNS(null, "namespaceContext");
< 
<       ctx.setAttributeNS(Constants.NamespaceSpecNS, "xmlns:" + prefix.trim(),
<                          namespace);
< 
<       return ctx;
<    }
< 
<    /**
<     * Method createDSctx
<     *
<     * @param doc
<     * @param prefix
<     * @return
<     */
<    public static Element createDSctx(Document doc, String prefix) {
<       return XMLUtils.createDSctx(doc, prefix, Constants.SignatureSpecNS);
<    }
< 
<    /**
<     * Method indentSignature
<     *
<     * @param element
<     * @param indentString
<     * @param initialDepth
<     */
<    public static void indentSignature(Element element, String indentString,
<                                       int initialDepth) {
< 
<       try {
<          NodeList returns = XPathAPI.selectNodeList(element, ".//text()");
< 
<          for (int i = 0; i < returns.getLength(); i++) {
<             Text returnText = (Text) returns.item(i);
<             Element parent = (Element) returnText.getParentNode();
<             Document doc = returnText.getOwnerDocument();
<             int j = 0;
---
>         for (Node child = node.getFirstChild(); child != null;
>                 child = child.getNextSibling()) {
>             switch (child.getNodeType()) {
> 
>             case Node.ELEMENT_NODE :
>             case Node.ENTITY_REFERENCE_NODE :
>             case Node.DOCUMENT_NODE :
>                 circumventBug2650recurse(child);
>             }
>         }
>     }
1098,1099c767,944
<             while (parent != element) {
<                j++;
---
>     /**
>      * @param sibling
>      * @param nodeName
>      * @param number
>      * @return
>      */
>     public static Element selectDsNode(Node sibling, String nodeName, int number) {
>         while (sibling!=null) {
>             if (nodeName.equals(sibling.getLocalName())
>                     && Constants.SignatureSpecNS.equals(sibling.getNamespaceURI())) {
>                 if (number==0){
>                     return (Element)sibling;
>                 }
>                 number--;
>             }
>             sibling=sibling.getNextSibling();
>         }
>         return null;
>     }
> 
>     /**
>      * @param sibling
>      * @param nodeName
>      * @param number
>      * @return
>      */
> 
>     public static Element selectXencNode(Node sibling, String nodeName, int number) {
>         while (sibling!=null) {
>             if (nodeName.equals(sibling.getLocalName())
>                     && EncryptionConstants.EncryptionSpecNS.equals(sibling.getNamespaceURI())) {
>                 if (number==0){
>                     return (Element)sibling;
>                 }
>                 number--;
>             }
>             sibling=sibling.getNextSibling();
>         }
>         return null;
>     }
> 
> 
>     /**
>      * @param sibling
>      * @param nodeName
>      * @param number
>      * @return
>      */
>     public static Text selectDsNodeText(Node sibling, String nodeName, int number) {
>         Node n=selectDsNode(sibling,nodeName,number);
>         if (n==null) {
>             return null;
>         }
>         n=n.getFirstChild();
>         while (n!=null && n.getNodeType()!=Node.TEXT_NODE) {
>             n=n.getNextSibling();
>         }
>         return (Text)n;
>     }
> 
>     /**
>      * @param sibling
>      * @param uri
>      * @param nodeName
>      * @param number
>      * @return
>      */
>     public static Text selectNodeText(Node sibling, String uri, String nodeName, int number) {
>         Node n=selectNode(sibling,uri,nodeName,number);
>         if (n==null) {
>             return null;
>         }
>         n=n.getFirstChild();
>         while (n!=null && n.getNodeType()!=Node.TEXT_NODE) {
>             n=n.getNextSibling();
>         }
>         return (Text)n;
>     }
> 
>     /**
>      * @param sibling
>      * @param uri
>      * @param nodeName
>      * @param number
>      * @return
>      */
>     public static Element selectNode(Node sibling, String uri,String nodeName, int number) {
>         while (sibling!=null) {
>             if (nodeName.equals(sibling.getLocalName())
>                     && uri.equals(sibling.getNamespaceURI())) {
>                 if (number==0){
>                     return (Element)sibling;
>                 }
>                 number--;
>             }
>             sibling=sibling.getNextSibling();
>         }
>         return null;
>     }
> 
>     /**
>      * @param sibling
>      * @param nodeName
>      * @return
>      */
>     public static Element[] selectDsNodes(Node sibling,String nodeName) {
>         return selectNodes(sibling,Constants.SignatureSpecNS,nodeName);
>     }
> 
>     /**
>      * @param sibling
>      * @param uri
>      * @param nodeName
>      * @return
>      */
>     public static Element[] selectNodes(Node sibling,String uri,String nodeName) {
>         int size=20;
>         Element[] a= new Element[size];
>         int curr=0;
>         //List list=new ArrayList();
>         while (sibling!=null) {
>             if (nodeName.equals(sibling.getLocalName())
>                     && uri.equals(sibling.getNamespaceURI())) {
>                 a[curr++]=(Element)sibling;
>                 if (size<=curr) {
>                     int cursize= size<<2;
>                     Element []cp=new Element[cursize];
>                     System.arraycopy(a,0,cp,0,size);
>                     a=cp;
>                     size=cursize;
>                 }
>             }
>             sibling=sibling.getNextSibling();
>         }
>         Element []af=new Element[curr];
>         System.arraycopy(a,0,af,0,curr);
>         return af;
>     }
> 
>     /**
>      * @param signatureElement
>      * @param inputSet
>      * @return
>      */
>     public static Set excludeNodeFromSet(Node signatureElement, Set inputSet) {
>         Set resultSet = new HashSet();
>         Iterator iterator = inputSet.iterator();
> 
>         while (iterator.hasNext()) {
>             Node inputNode = (Node) iterator.next();
> 
>             if (!XMLUtils
>                     .isDescendantOrSelf(signatureElement, inputNode)) {
>                 resultSet.add(inputNode);
>             }
>         }
>         return resultSet;
>     }
> 
>     /**
>      * Returns true if the descendantOrSelf is on the descendant-or-self axis
>      * of the context node.
>      *
>      * @param ctx
>      * @param descendantOrSelf
>      * @return
>      */
>     static boolean isDescendantOrSelf(Node ctx, Node descendantOrSelf) {
> 
>         if (ctx == descendantOrSelf) {
>             return true;
>         }
> 
>         Node parent = descendantOrSelf;
> 
>         while (true) {
>             if (parent == null) {
>                 return false;
1102c947,949
<             String newReturn = "";
---
>             if (parent == ctx) {
>                 return true;
>             }
1104,1105c951,954
<             for (int k = 0; k < j; k++) {
<                newReturn += indentString;
---
>             if (parent.getNodeType() == Node.ATTRIBUTE_NODE) {
>                 parent = ((Attr) parent).getOwnerElement();
>             } else {
>                 parent = parent.getParentNode();
1106a956,957
>         }
>     }
1108d958
<             Text newReturnText = doc.createTextNode(newReturn);
1110,1244c960,964
<             parent.replaceChild(newReturnText, returnText);
<          }
<       } catch (TransformerException ex) {}
<    }
< 
<    /**
<     * Method addReturnToElement
<     *
<     * @param elementProxy
<     */
<    public static void addReturnToElement(ElementProxy elementProxy) {
< 
<       Document doc = elementProxy._doc;
< 
<       elementProxy.getElement().appendChild(doc.createTextNode("\n"));
<    }
< 
<    /**
<     * Method addReturnToElement
<     *
<     * @param e
<     */
<    public static void addReturnToElement(Element e) {
< 
<       Document doc = e.getOwnerDocument();
< 
<       e.appendChild(doc.createTextNode("\n"));
<    }
< 
<    /**
<     * Method addReturnToNode
<     *
<     * @param n
<     */
<    public static void addReturnToNode(Node n) {
< 
<       Document doc = n.getOwnerDocument();
< 
<       n.appendChild(doc.createTextNode("\n"));
<    }
< 
<    /**
<     * Method convertNodelistToSet
<     *
<     * @param xpathNodeSet
<     * @return
<     */
<    public static Set convertNodelistToSet(NodeList xpathNodeSet) {
< 
<       if (xpathNodeSet == null) {
<          return new HashSet();
<       }
< 
<       int length = xpathNodeSet.getLength();
<       Set set = new HashSet(length);
< 
<       for (int i = 0; i < length; i++) {
<          set.add(xpathNodeSet.item(i));
<       }
< 
<       return set;
<    }
< 
<    /**
<     * Method convertSetToNodelist
<     *
<     * @param set
<     * @return
<     */
<    public static NodeList convertSetToNodelist(Set set) {
< 
<       HelperNodeList result = new HelperNodeList();
<       Iterator it = set.iterator();
< 
<       while (it.hasNext()) {
<          result.appendChild((Node) it.next());
<       }
< 
<       return result;
<    }
< 
<    /**
<     * This method spreads all namespace attributes in a DOM document to their
<     * children. This is needed because the XML Signature XPath transform
<     * must evaluate the XPath against all nodes in the input, even against
<     * XPath namespace nodes. Through a bug in XalanJ2, the namespace nodes are
<     * not fully visible in the Xalan XPath model, so we have to do this by
<     * hand in DOM spaces so that the nodes become visible in XPath space.
<     *
<     * @param doc
<     * @see <A HREF="http://nagoya.apache.org/bugzilla/show_bug.cgi?id=2650">Namespace axis resolution is not XPath compliant </A>
<     */
<    public static void circumventBug2650(Document doc) {
<       XMLUtils.circumventBug2650recurse(doc);
<    }
< 
<    /**
<     * This is the work horse for {@link #circumventBug2650}.
<     *
<     * @param node
<     * @see <A HREF="http://nagoya.apache.org/bugzilla/show_bug.cgi?id=2650">Namespace axis resolution is not XPath compliant </A>
<     */
<    private static void circumventBug2650recurse(Node node) {
< 
<       if (node.getNodeType() == Node.ELEMENT_NODE) {
<          Element element = (Element) node;
<          NamedNodeMap attributes = element.getAttributes();
<          int attributesLength = attributes.getLength();
<          NodeList children = element.getChildNodes();
<          int childrenLength = children.getLength();
< 
<          for (int j = 0; j < childrenLength; j++) {
<             Node child = children.item(j);
< 
<             if (child.getNodeType() == Node.ELEMENT_NODE) {
<                Element childElement = (Element) child;
< 
<                for (int i = 0; i < attributesLength; i++) {
<                   Attr currentAttr = (Attr) attributes.item(i);
<                   String name = currentAttr.getNodeName();
< 
<                   if (name.startsWith("xmlns")) {
<                      String value = currentAttr.getNodeValue();
<                      boolean mustBeDefinedInChild =
<                         !childElement.hasAttribute(name);
< 
<                      if (mustBeDefinedInChild) {
<                         childElement.setAttributeNS(Constants.NamespaceSpecNS,
<                                                     name, value);
<                      }
<                   }
<                }
<             }
<          }
<       }
---
>     public static String getRandomNamespacePrefix() {
>         // TODO Auto-generated method stub
>         return null;
>     }
> 
1246,1304c966,969
<       for (Node child = node.getFirstChild(); child != null;
<               child = child.getNextSibling()) {
<          switch (child.getNodeType()) {
< 
<          case Node.ELEMENT_NODE :
<          case Node.ENTITY_REFERENCE_NODE :
<          case Node.DOCUMENT_NODE :
<             circumventBug2650recurse(child);
<          }
<       }
<    }
< 
<    /**
<     * Method getXPath
<     *
<     * @param n
<     * @param result
<     * @return
<     */
<    private static String getXPath(Node n, String result) {
< 
<       if (n == null) {
<          return result;
<       }
< 
<       switch (n.getNodeType()) {
< 
<       case Node.ATTRIBUTE_NODE :
<          return getXPath(((Attr) n).getOwnerElement(),
<                          "/@" + ((Attr) n).getNodeName() + "=\""
<                          + ((Attr) n).getNodeValue() + "\"");
< 
<       case Node.ELEMENT_NODE :
<          return getXPath(n.getParentNode(),
<                          "/" + ((Element) n).getTagName() + result);
< 
<       case Node.TEXT_NODE :
<          return getXPath(n.getParentNode(), "/#text");
< 
<       case Node.DOCUMENT_NODE :
<          if (result.length() > 0) {
<             return result;
<          } else {
<             return "/";
<          }
<       }
< 
<       return result;
<    }
< 
<    /**
<     * Simple tool to return the position of a particular node in an XPath like String.
<     *
<     * @param n
<     * @return
<     */
<    public static String getXPath(Node n) {
<       return getXPath(n, "");
<    }
---
>     public static NodeList convertSetToNodelist(Set var1) {
>         // TODO Auto-generated method stub
>         return null;
>     }
diff -r xml-security-orig-v1/src/org/apache/xml/security/utils/XPathFuncHereAPI.java xml-security-1_2_0/src/org/apache/xml/security/utils/XPathFuncHereAPI.java
3c3
<  * The Apache Software License, Version 1.1
---
>  * Copyright  1999-2004 The Apache Software Foundation.
4a5,15
>  *  Licensed under the Apache License, Version 2.0 (the "License");
>  *  you may not use this file except in compliance with the License.
>  *  You may obtain a copy of the License at
>  *
>  *      http://www.apache.org/licenses/LICENSE-2.0
>  *
>  *  Unless required by applicable law or agreed to in writing, software
>  *  distributed under the License is distributed on an "AS IS" BASIS,
>  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
>  *  See the License for the specific language governing permissions and
>  *  limitations under the License.
6,58d16
<  * Copyright (c) 1999 The Apache Software Foundation.  All rights
<  * reserved.
<  *
<  * Redistribution and use in source and binary forms, with or without
<  * modification, are permitted provided that the following conditions
<  * are met:
<  *
<  * 1. Redistributions of source code must retain the above copyright
<  *    notice, this list of conditions and the following disclaimer.
<  *
<  * 2. Redistributions in binary form must reproduce the above copyright
<  *    notice, this list of conditions and the following disclaimer in
<  *    the documentation and/or other materials provided with the
<  *    distribution.
<  *
<  * 3. The end-user documentation included with the redistribution,
<  *    if any, must include the following acknowledgment:
<  *       "This product includes software developed by the
<  *        Apache Software Foundation (http://www.apache.org/)."
<  *    Alternately, this acknowledgment may appear in the software itself,
<  *    if and wherever such third-party acknowledgments normally appear.
<  *
<  * 4. The names "<WebSig>" and "Apache Software Foundation" must
<  *    not be used to endorse or promote products derived from this
<  *    software without prior written permission. For written
<  *    permission, please contact apache@apache.org.
<  *
<  * 5. Products derived from this software may not be called "Apache",
<  *    nor may "Apache" appear in their name, without prior written
<  *    permission of the Apache Software Foundation.
<  *
<  * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
<  * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
<  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
<  * DISCLAIMED.  IN NO EVENT SHALL THE APACHE SOFTWARE FOUNDATION OR
<  * ITS CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
<  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
<  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
<  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
<  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
<  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT
<  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
<  * SUCH DAMAGE.
<  * ====================================================================
<  *
<  * This software consists of voluntary contributions made by many
<  * individuals on behalf of the Apache Software Foundation and was
<  * originally based on software copyright (c) 2001, Institute for
<  * Data Communications Systems, <http://www.nue.et-inf.uni-siegen.de/>.
<  * The development of this software was partly funded by the European
<  * Commission in the <WebSig> project in the ISIS Programme.
<  * For more information on the Apache Software Foundation, please see
<  * <http://www.apache.org/>.
65,73c23,24
< import org.w3c.dom.Node;
< import org.w3c.dom.Document;
< import org.w3c.dom.traversal.NodeIterator;
< import org.w3c.dom.NodeList;
< import org.apache.xpath.XPathContext;
< import org.apache.xpath.XPath;
< import org.apache.xpath.compiler.XPathParser;
< import org.apache.xpath.XPathContext;
< import org.apache.xml.utils.PrefixResolverDefault;
---
> 
> import org.apache.xml.security.transforms.implementations.FuncHereContext;
74a26,27
> import org.apache.xml.utils.PrefixResolverDefault;
> import org.apache.xpath.XPath;
76,81c29,37
< import org.apache.xml.dtm.DTM;
< import org.apache.xml.dtm.ref.DTMNodeIterator;
< import org.apache.xml.dtm.ref.DTMNodeList;
< import org.apache.xml.dtm.ref.DTMManagerDefault;
< import org.w3c.dom.*;
< import org.apache.xml.security.transforms.implementations.FuncHereContext;
---
> import org.w3c.dom.Attr;
> import org.w3c.dom.Document;
> import org.w3c.dom.Node;
> import org.w3c.dom.NodeList;
> import org.w3c.dom.ProcessingInstruction;
> import org.w3c.dom.Text;
> import org.w3c.dom.traversal.NodeIterator;
> 
> 
85c41
<  * This class does the same as {@link XPathAPI} except that the XPath strings
---
>  * This class does the same as {@link org.apache.xpath.XPathAPI} except that the XPath strings
96c52
<  * @author $Author: dohy $
---
>  * @author $Author: raul $
